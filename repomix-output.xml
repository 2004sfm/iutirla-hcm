This file is a merged representation of a subset of the codebase, containing specifically included files and files not matching ignore patterns, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Only files matching these patterns are included: backend/**/*, frontend2/**/*, **/models.py
- Files matching these patterns are excluded: frontend/**, **/*.md, **/*.png, **/*.jpg, **/*.jpeg, **/*.gif, **/*.svg, **/*.ico, **/*.lock, **/package-lock.json, **/pnpm-lock.yaml, **/yarn.lock, **/__pycache__/**, **/*.pyc, **/.env, **/.venv, **/node_modules/**, **/.git/**, **/.idea/**, **/.vscode/**, **/fixtures/*.json, **/fixtures/*.json, **/*.sqlite3, backend/debug_*.py, backend/expand_*.py, backend/reproduce_*.py, backend/verify_*.py
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
backend/
  accounts/
    migrations/
      __init__.py
      0001_initial.py
    __init__.py
    admin.py
    apps.py
    models.py
    serializers.py
    tests.py
    urls.py
    views.py
  ats/
    migrations/
      __init__.py
      0001_initial.py
      0002_remove_jobposting_department_and_more.py
      0003_add_phone_area_code_fields.py
      0004_remove_candidate_experience_details_and_more.py
      0005_candidate_avatar.py
      0006_candidatelog.py
      0007_historicalcandidate_historicaljobposting.py
      0008_alter_candidate_phone_area_code_and_more.py
    __init__.py
    admin.py
    apps.py
    models.py
    serializers.py
    services.py
    signals.py
    tests.py
    urls.py
    utils.py
    views_options.py
    views.py
  config/
    __init__.py
    asgi.py
    settings.py
    urls.py
    wsgi.py
  core/
    management/
      commands/
        generate_test_employees.py
    migrations/
      __init__.py
      0001_initial.py
      0002_alter_personbankaccount_account_number.py
      0003_historicalperson.py
      0004_remove_phone_prefix.py
      0005_phonecarriercode_alter_phoneareacode_unique_together_and_more.py
      0006_delete_phoneareacode_and_more.py
      0007_refine_validations.py
      0008_remove_salutation.py
      0009_make_gender_birthdate_required.py
      0010_alter_historicalperson_birthdate.py
      0011_alter_historicalperson_birthdate_and_more.py
      0012_historicalperson_cv_file_person_cv_file.py
    __init__.py
    admin.py
    apps.py
    db_utils.py
    filters.py
    models.py
    pagination.py
    serializers.py
    tests.py
    urls.py
    views.py
  employment/
    migrations/
      __init__.py
      0001_initial.py
      0002_historicalemployment.py
      0003_add_choice_fields.py
      0004_migrate_data_to_choices.py
      0005_alter_employmentstatuslog_status_and_more.py
      0006_historicalemploymentdepartmentrole_and_more.py
      0007_historicalpersondepartmentrole_persondepartmentrole.py
    __init__.py
    admin.py
    apps.py
    models.py
    serializers.py
    tests.py
    urls.py
    views.py
  organization/
    management/
      commands/
        __init__.py
        load_org_data.py
      __init__.py
    migrations/
      __init__.py
      0001_initial.py
      0002_historicaldepartment_historicalposition.py
      0003_remove_jobtitle_description.py
      0004_remove_historicalposition_name_remove_position_name.py
      0005_alter_position_unique_together.py
      0006_remove_historicalposition_manager_position_and_more.py
      0007_alter_department_name_alter_department_parent_and_more.py
      0008_historicalposition_objective_position_objective_and_more.py
      0009_historicalposition_is_manager_position_is_manager.py
    __init__.py
    admin.py
    apps.py
    models.py
    serializers.py
    tests.py
    urls.py
    views.py
  performance/
    migrations/
      __init__.py
      0001_initial.py
      0002_alter_performancereview_options.py
      0003_competency_category.py
    __init__.py
    admin.py
    apps.py
    models.py
    serializers.py
    tests.py
    urls.py
    views.py
  recruitment/
    migrations/
      __init__.py
    __init__.py
    admin.py
    apps.py
    models.py
    tests.py
    views.py
  talent/
    migrations/
      __init__.py
      0001_initial.py
      0002_remove_personlanguage_reading_proficiency_and_more.py
      0003_personlanguage_reading_proficiency.py
      0004_fieldofstudy_education_level_alter_fieldofstudy_name_and_more.py
    __init__.py
    admin.py
    apps.py
    models.py
    serializers.py
    tests.py
    urls.py
    views.py
  training/
    migrations/
      __init__.py
      0001_initial.py
      0002_alter_courseparticipant_status.py
      0003_course_cover_image.py
      0004_alter_courseparticipant_status.py
      0005_alter_courseparticipant_status.py
      0006_courseparticipant_academic_status_and_more.py
      0007_auto_20251126_1037.py
      0008_remove_courseparticipant_status.py
      0009_course_is_public_department.py
      0010_alter_courseparticipant_academic_status_and_more.py
      0011_course_instructor.py
      0012_migrate_instructors_data.py
      0013_remove_courseparticipant_role.py
      0014_courseparticipant_created_at.py
      0015_course_requires_approval_to_complete_and_more.py
      0016_courselesson_file_courselesson_url_and_more.py
      0017_remove_courselesson_file_remove_courselesson_url_and_more.py
    __init__.py
    admin.py
    apps.py
    models.py
    permissions.py
    serializers.py
    services.py
    tests.py
    urls.py
    views.py
  .gitignore
  .python-version
  cleanup_positions.py
  cleanup_resources.py
  create_ats_test_data.py
  create_education_data.py
  generate_complete_org_fixtures.py
  generate_org_fixtures.py
  manage.py
  migrate_manager_data.py
  populate_education_data.py
  pyproject.toml
  test_api.py
frontend2/
  app/
    (iutirla)/
      portal/
        jobs/
          [id]/
            apply/
              page.tsx
            page.tsx
          page.tsx
        page.tsx
      layout.tsx
    (main)/
      admin/
        ats/
          candidates/
            [id]/
              page.tsx
            page.tsx
          jobs/
            [id]/
              edit/
                page.tsx
              page.tsx
            new/
              page.tsx
            page.tsx
        config/
          general/
            [slug]/
              loading.tsx
              page.tsx
            loading.tsx
            page.tsx
          talent/
            [slug]/
              page.tsx
            page.tsx
        dashboard/
          loading.tsx
          page.tsx
        organization/
          [slug]/
            page.tsx
          positions/
            [id]/
              page.tsx
          page.tsx
        performance/
          competencies/
            page.tsx
          periods/
            page.tsx
          reviews/
            [id]/
              edit/
                page.tsx
              page.tsx
            page.tsx
          page.tsx
        personnel/
          employees/
            [id]/
              page.tsx
            new/
              page.tsx
            page.tsx
          people/
            [id]/
              page.tsx
            new/
              page.tsx
            page.tsx
        training/
          [id]/
            edit/
              page.tsx
            page.tsx
          new/
            page.tsx
          page.tsx
      departments/
        [id]/
          evaluations/
            page.tsx
          page.tsx
        page.tsx
      employee/
        job-data/
          page.tsx
        personal-data/
          page.tsx
        talent-profile/
          page.tsx
      org-chart/
        page.tsx
      performance/
        [id]/
          page.tsx
        page.tsx
      training/
        [id]/
          lessons/
            [lessonId]/
              page.tsx
          page.tsx
        page.tsx
      layout.tsx
      page.tsx
    (test)/
      datepicker/
        page.tsx
      generales/
        page.tsx
      generales-two/
        page.tsx
      guide/
        page.tsx
      kanban/
        page.tsx
      test/
        page.tsx
    login/
      page.tsx
    globals.css
    layout.tsx
  components/
    ats/
      JobCandidatesGrid.tsx
      JobKanbanBoard.tsx
      KanbanComponents.tsx
    catalogs/
      catalog-card.tsx
      catalog-crud.tsx
      data-table.tsx
    courses/
      course-card.tsx
      course-header.tsx
      course-module-accordion.tsx
      course-personnel.tsx
      course-requests.tsx
    departments/
      department-card.tsx
      department-org-chart.tsx
      organization-org-chart.tsx
      pending-evaluations.tsx
    iutirla/
      ApplicationForm.tsx
      JobCard.tsx
      PublicFooter.tsx
      PublicNavbar.tsx
    layout/
      dashboard-layout.tsx
      dynamic-breadcrumbs.tsx
      header.tsx
      sidebar.tsx
    performance/
      competency-rating.tsx
      performance-evaluation-form.tsx
      performance-radar-chart.tsx
    personnel/
      EmploymentForm.tsx
      PersonForm.tsx
    skeletons/
      dashboard-skeleton.tsx
      general-catalog-skeleton.tsx
      specific-catalog-skeleton.tsx
      table-skeleton.tsx
    ui/
      accordion.tsx
      action-menu.tsx
      alert-dialog.tsx
      alert.tsx
      avatar.tsx
      badge.tsx
      breadcrumb.tsx
      button.tsx
      calendar.tsx
      card.tsx
      carousel.tsx
      chart.tsx
      combobox.tsx
      command.tsx
      date-picker.tsx
      dialog.tsx
      dropdown-menu.tsx
      field.tsx
      file-upload.tsx
      form.tsx
      input.tsx
      item.tsx
      kbd.tsx
      label.tsx
      popover.tsx
      progress.tsx
      select.tsx
      separator.tsx
      sheet.tsx
      skeleton.tsx
      sonner.tsx
      switch.tsx
      table.tsx
      tabs.tsx
      textarea.tsx
    auth-loading.tsx
    command-menu.tsx
    iutirla-logo.tsx
    login-form.tsx
    notifications-sheet.tsx
    protected-route.tsx
    providers.tsx
    task-sheet.tsx
    user-menu.tsx
  context/
    auth-context.tsx
    breadcrumb-context.tsx
  lib/
    api-client.ts
    command-menu-data.ts
    fonts.ts
    utils.ts
  public/
    images/
      course-placeholder.webp
      department-placeholder.webp
      iutirla-porlamar.webp
      iutirla-porlamar2.webp
      logoiutirla.webp
    email-logoiutirla.webp
  types/
    ats.ts
    course.ts
    performance.ts
  .gitignore
  components.json
  eslint.config.mjs
  next.config.ts
  package.json
  pnpm-workspace.yaml
  postcss.config.mjs
  tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="frontend2/app/(main)/admin/training/[id]/edit/page.tsx">
"use client";

import { use, useState, useEffect } from "react";
import { useRouter } from "next/navigation";
import { z } from "zod";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { ArrowLeft, Loader2, BookOpen } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import {
    Form,
    FormControl,
    FormField,
    FormItem,
    FormLabel,
    FormMessage,
} from "@/components/ui/form";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import { DatePicker } from "@/components/ui/date-picker";
import { Combobox } from "@/components/ui/combobox";
import { FileUpload } from "@/components/ui/file-upload";
import { format, parseISO } from "date-fns";
import apiClient from "@/lib/api-client";
import { toast } from "sonner";
import useSWR from "swr";
import { Course } from "@/types/course";
import { Skeleton } from "@/components/ui/skeleton";

const fetcher = (url: string) => apiClient.get(url).then((res) => res.data);

import { Switch } from "@/components/ui/switch";

const courseFormSchema = z.object({
    name: z.string().min(1, "El nombre es requerido"),
    description: z.string().optional(),
    cover_image: z.any().optional(),
    status: z.enum(["BOR", "PRO", "EJE", "FIN", "CAN"]),
    modality: z.enum(["PRE", "VIR", "ASY", "MIX"]),
    start_date: z.string().min(1, "La fecha de inicio es requerida"),
    end_date: z.string().min(1, "La fecha de fin es requerida"),
    duration_hours: z.number().min(1, "La duración debe ser mayor a 0"),
    max_participants: z.number().min(1, "El cupo máximo debe ser mayor a 0"),
    is_public: z.boolean(),
    department: z.number().nullable().optional(),
}).refine((data) => {
    if (data.start_date && data.end_date) {
        return new Date(data.end_date) > new Date(data.start_date);
    }
    return true;
}, {
    message: "La fecha de fin debe ser posterior a la fecha de inicio",
    path: ["end_date"],
}).refine((data) => {
    if (!data.is_public && !data.department) {
        return false;
    }
    return true;
}, {
    message: "Si el curso es privado, debe seleccionar un departamento",
    path: ["department"],
});

type CourseFormValues = z.infer<typeof courseFormSchema>;

export default function EditCoursePage({ params }: { params: Promise<{ id: string }> }) {
    const { id } = use(params);
    const router = useRouter();
    const [isSubmitting, setIsSubmitting] = useState(false);

    const { data: course, error, isLoading } = useSWR<Course>(
        `/api/training/courses/${id}/`,
        fetcher
    );

    // Fetch departments for the combobox
    const { data: departments } = useSWR("/api/organization/departments/", (url) =>
        apiClient.get(url).then(res => res.data.results || res.data)
    );

    const departmentOptions = departments?.map((d: any) => ({
        value: d.id,
        label: d.name
    })) || [];

    const form = useForm<CourseFormValues>({
        resolver: zodResolver(courseFormSchema),
        defaultValues: {
            name: "",
            description: "",
            status: "BOR",
            modality: "PRE",
            start_date: "",
            end_date: "",
            duration_hours: 0,
            max_participants: 30,
            is_public: true,
        },
    });

    const isPublic = form.watch("is_public");

    // Pre-fill form when course data loads
    useEffect(() => {
        if (course) {
            form.reset({
                name: course.name,
                description: course.description || "",
                status: course.status,
                modality: course.modality,
                start_date: course.start_date,
                end_date: course.end_date,
                duration_hours: course.duration_hours,
                max_participants: course.max_participants,
                is_public: course.is_public,
                department: course.department ?? undefined, // Convert null to undefined
            });
        }
    }, [course, form]);

    const onSubmit = async (values: CourseFormValues) => {
        console.log("Form submitted with values:", values);
        setIsSubmitting(true);
        try {
            const formData = new FormData();
            formData.append("name", values.name);
            if (values.description) formData.append("description", values.description);
            if (values.cover_image) formData.append("cover_image", values.cover_image);
            formData.append("status", values.status);
            formData.append("modality", values.modality);
            formData.append("start_date", values.start_date);
            formData.append("end_date", values.end_date);
            formData.append("duration_hours", values.duration_hours.toString());
            formData.append("max_participants", values.max_participants.toString());

            // Privacy fields
            formData.append("is_public", values.is_public.toString());
            if (!values.is_public && values.department) {
                formData.append("department", values.department.toString());
            }

            console.log("Sending PATCH request to:", `/api/training/courses/${id}/`);
            await apiClient.patch(`/api/training/courses/${id}/`, formData, {
                headers: {
                    "Content-Type": "multipart/form-data",
                },
            });
            toast.success("Curso actualizado exitosamente");
            router.push(`/admin/training/${id}`);
        } catch (error: any) {
            console.error("Error updating course:", error);
            if (error.response?.data) {
                const errors = error.response.data;
                Object.keys(errors).forEach((key) => {
                    if (key in values) {
                        form.setError(key as any, {
                            message: Array.isArray(errors[key]) ? errors[key][0] : errors[key],
                        });
                    }
                });
            }
            toast.error("Error al actualizar el curso");
        } finally {
            setIsSubmitting(false);
        }
    };

    if (isLoading) {
        return (
            <div className="flex flex-col h-full space-y-6 p-8">
                <Skeleton className="h-20 w-full" />
                <Skeleton className="h-96 w-full" />
            </div>
        );
    }

    if (error || !course) {
        return (
            <div className="flex flex-col items-center justify-center h-full p-8 text-center">
                <h2 className="text-2xl font-bold text-destructive mb-2">Error</h2>
                <p className="text-muted-foreground mb-4">No se pudo cargar el curso.</p>
                <Button onClick={() => router.back()}>Volver</Button>
            </div>
        );
    }

    return (
        <div className="flex flex-col h-full space-y-6 p-8">
            {/* Header */}
            <div className="flex items-center justify-between border-b pb-6">
                <div>
                    <div className="flex items-center gap-3 mb-2">
                        <BookOpen className="h-8 w-8 text-primary" />
                        <h1 className="text-2xl font-bold tracking-tight">Editar Curso</h1>
                    </div>
                    <p className="text-muted-foreground">
                        Actualiza la información del curso
                    </p>
                </div>
                <Button variant="outline" onClick={() => router.back()}>
                    <ArrowLeft className="mr-2 h-4 w-4" />
                    Volver
                </Button>
            </div>

            {/* Form */}
            <Card>
                <CardHeader>
                    <CardTitle>Información del Curso</CardTitle>
                </CardHeader>
                <CardContent>
                    <Form {...form}>
                        <form
                            onSubmit={form.handleSubmit(
                                onSubmit,
                                (errors) => {
                                    console.log("Form validation errors:", errors);
                                }
                            )}
                            className="space-y-6"
                        >
                            {/* Nombre */}
                            <FormField
                                control={form.control}
                                name="name"
                                render={({ field }) => (
                                    <FormItem>
                                        <FormLabel>Nombre del Curso *</FormLabel>
                                        <FormControl>
                                            <Input placeholder="Ej: Introducción a Python" {...field} />
                                        </FormControl>
                                        <FormMessage />
                                    </FormItem>
                                )}
                            />

                            {/* Descripción */}
                            <FormField
                                control={form.control}
                                name="description"
                                render={({ field }) => (
                                    <FormItem>
                                        <FormLabel>Descripción</FormLabel>
                                        <FormControl>
                                            <Textarea
                                                placeholder="Describe los objetivos y contenido del curso"
                                                rows={4}
                                                {...field}
                                            />
                                        </FormControl>
                                        <FormMessage />
                                    </FormItem>
                                )}
                            />

                            {/* Estado y Modalidad */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <FormField
                                    control={form.control}
                                    name="status"
                                    render={({ field }) => (
                                        <FormItem>
                                            <FormLabel>Estado *</FormLabel>
                                            <FormControl>
                                                <Combobox
                                                    options={[
                                                        { value: "BOR", label: "Borrador" },
                                                        { value: "PRO", label: "Programado" },
                                                        { value: "EJE", label: "En Ejecución" },
                                                        { value: "FIN", label: "Finalizado" },
                                                        { value: "CAN", label: "Cancelado" },
                                                    ]}
                                                    value={field.value}
                                                    onSelect={field.onChange}
                                                    placeholder="Seleccione el estado"
                                                    emptyText="No se encontraron resultados"
                                                />
                                            </FormControl>
                                            <FormMessage />
                                        </FormItem>
                                    )}
                                />

                                <FormField
                                    control={form.control}
                                    name="modality"
                                    render={({ field }) => (
                                        <FormItem>
                                            <FormLabel>Modalidad *</FormLabel>
                                            <FormControl>
                                                <Combobox
                                                    options={[
                                                        { value: "PRE", label: "Presencial" },
                                                        { value: "VIR", label: "Virtual (En Vivo / Zoom)" },
                                                        { value: "ASY", label: "Virtual (Autoaprendizaje)" },
                                                        { value: "MIX", label: "Híbrido / Mixto" },
                                                    ]}
                                                    value={field.value}
                                                    onSelect={field.onChange}
                                                    placeholder="Seleccione la modalidad"
                                                    emptyText="No se encontraron resultados"
                                                />
                                            </FormControl>
                                            <FormMessage />
                                        </FormItem>
                                    )}
                                />
                            </div>

                            {/* Fechas */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <FormField
                                    control={form.control}
                                    name="start_date"
                                    render={({ field }) => (
                                        <FormItem>
                                            <FormLabel>Fecha de Inicio *</FormLabel>
                                            <FormControl>
                                                <DatePicker
                                                    value={field.value ? parseISO(field.value) : undefined}
                                                    onChange={(date) => {
                                                        field.onChange(date ? format(date, "yyyy-MM-dd") : "");
                                                    }}
                                                    placeholder="Seleccione la fecha"
                                                />
                                            </FormControl>
                                            <FormMessage />
                                        </FormItem>
                                    )}
                                />

                                <FormField
                                    control={form.control}
                                    name="end_date"
                                    render={({ field }) => (
                                        <FormItem>
                                            <FormLabel>Fecha de Fin *</FormLabel>
                                            <FormControl>
                                                <DatePicker
                                                    value={field.value ? parseISO(field.value) : undefined}
                                                    onChange={(date) => {
                                                        field.onChange(date ? format(date, "yyyy-MM-dd") : "");
                                                    }}
                                                    placeholder="Seleccione la fecha"
                                                />
                                            </FormControl>
                                            <FormMessage />
                                        </FormItem>
                                    )}
                                />
                            </div>

                            {/* Duration and Max Participants */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <FormField
                                    control={form.control}
                                    name="duration_hours"
                                    render={({ field }) => (
                                        <FormItem>
                                            <FormLabel>Duración (horas) *</FormLabel>
                                            <FormControl>
                                                <Input
                                                    type="number"
                                                    placeholder="40"
                                                    {...field}
                                                    onChange={e => {
                                                        const value = e.target.value === "" ? 0 : parseFloat(e.target.value);
                                                        field.onChange(value);
                                                    }}
                                                />
                                            </FormControl>
                                            <FormMessage />
                                        </FormItem>
                                    )}
                                />

                                <FormField
                                    control={form.control}
                                    name="max_participants"
                                    render={({ field }) => (
                                        <FormItem>
                                            <FormLabel>Cupo Máximo *</FormLabel>
                                            <FormControl>
                                                <Input
                                                    type="number"
                                                    placeholder="30"
                                                    {...field}
                                                    onChange={e => {
                                                        const value = e.target.value === "" ? 0 : parseFloat(e.target.value);
                                                        field.onChange(value);
                                                    }}
                                                />
                                            </FormControl>
                                            <FormMessage />
                                        </FormItem>
                                    )}
                                />
                            </div>

                            {/* Privacy Settings */}
                            <div className="space-y-4 border p-4 rounded-lg bg-muted/20">
                                <h3 className="font-medium text-sm">Configuración de Privacidad</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                                    <FormField
                                        control={form.control}
                                        name="is_public"
                                        render={({ field }) => (
                                            <FormItem className="flex flex-row items-center justify-between rounded-lg border p-3 shadow-sm bg-background">
                                                <div className="space-y-0.5">
                                                    <FormLabel>Curso Público</FormLabel>
                                                    <div className="text-[0.8rem] text-muted-foreground">
                                                        Visible para todos los empleados
                                                    </div>
                                                </div>
                                                <FormControl>
                                                    <Switch
                                                        checked={field.value}
                                                        onCheckedChange={field.onChange}
                                                    />
                                                </FormControl>
                                            </FormItem>
                                        )}
                                    />

                                    {!isPublic && (
                                        <FormField
                                            control={form.control}
                                            name="department"
                                            render={({ field }) => (
                                                <FormItem>
                                                    <FormLabel>Departamento *</FormLabel>
                                                    <FormControl>
                                                        <Combobox
                                                            options={departmentOptions}
                                                            value={field.value ?? undefined}
                                                            onSelect={(val) => field.onChange(val === "" ? null : val)}
                                                            placeholder="Seleccione departamento"
                                                            emptyText="No se encontraron departamentos"
                                                        />
                                                    </FormControl>
                                                    <FormMessage />
                                                </FormItem>
                                            )}
                                        />
                                    )}
                                </div>
                            </div>

                            {/* Cover Image */}
                            <FormField
                                control={form.control}
                                name="cover_image"
                                render={({ field: { value, onChange, ...field } }) => (
                                    <FormItem>
                                        <FormLabel>Imagen de Portada</FormLabel>
                                        <FormControl>
                                            <FileUpload
                                                onFileSelect={onChange}
                                                currentFile={value}
                                                initialPreviewUrl={course.cover_image}
                                                accept="image/*"
                                            />
                                        </FormControl>
                                        <FormMessage />
                                    </FormItem>
                                )}
                            />

                            {/* Submit Buttons */}
                            <div className="flex justify-end gap-4 pt-4">
                                <Button
                                    type="button"
                                    variant="outline"
                                    onClick={() => router.back()}
                                    disabled={isSubmitting}
                                >
                                    Cancelar
                                </Button>
                                <Button type="submit" disabled={isSubmitting}>
                                    {isSubmitting && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                                    Guardar Cambios
                                </Button>
                            </div>
                        </form>
                    </Form>
                </CardContent>
            </Card>
        </div>
    );
}
</file>

<file path="frontend2/app/(main)/admin/training/[id]/page.tsx">
"use client";

import { use, useEffect } from "react";
import { useRouter, usePathname, useSearchParams } from "next/navigation";
import useSWR from "swr";
import { ArrowLeft, BookOpen, FileText, Users, Edit } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Skeleton } from "@/components/ui/skeleton";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { CatalogCRUD, CatalogField } from "@/components/catalogs/catalog-crud";
import { ColumnDef } from "@tanstack/react-table";
import {
    Course,
    CourseSession,
    CourseResource,
    ParticipantListItem,
    courseStatusDisplay,
    courseModalityDisplay,
    enrollmentStatusDisplay
} from "@/types/course";
import apiClient from "@/lib/api-client";
import { useBreadcrumb } from "@/context/breadcrumb-context";
import CoursePersonnel from "@/components/courses/course-personnel";
import CourseRequests from "@/components/courses/course-requests";

const fetcher = (url: string) => apiClient.get(url).then((res) => res.data);

export default function AdminCourseDetailPage({ params }: { params: Promise<{ id: string }> }) {
    const { id } = use(params);
    const router = useRouter();
    const pathname = usePathname();
    const searchParams = useSearchParams();
    const { setLabel } = useBreadcrumb();

    const { data: course, error, isLoading } = useSWR<Course>(
        `/api/training/courses/${id}/`,
        fetcher
    );

    const defaultTab = searchParams.get("tab") || "general";

    useEffect(() => {
        if (course) {
            const normalizedPath = pathname.endsWith('/') ? pathname.slice(0, -1) : pathname;
            setLabel(normalizedPath, course.name);
        }
    }, [course, pathname, setLabel]);

    if (isLoading) {
        return <CourseDetailSkeleton />;
    }

    if (error || !course) {
        return (
            <div className="flex flex-col items-center justify-center h-full p-8 text-center">
                <h2 className="text-2xl font-bold text-destructive mb-2">Error</h2>
                <p className="text-muted-foreground mb-4">No se pudo cargar la información del curso.</p>
                <Button onClick={() => router.back()}>Volver</Button>
            </div>
        );
    }

    // Configuration for Sessions (Syllabus)
    const sessionsFields: CatalogField[] = [
        { name: "topic", label: "Tema / Título", type: "text", required: true },
        { name: "date", label: "Fecha", type: "date", required: true },
        { name: "start_time", label: "Hora Inicio (HH:MM)", type: "text", required: true },
        { name: "end_time", label: "Hora Fin (HH:MM)", type: "text", required: true },
        { name: "course", label: "Curso", type: "hidden", defaultValue: parseInt(id) },
    ];

    const sessionsColumns: ColumnDef<CourseSession>[] = [
        { accessorKey: "topic", header: "Tema" },
        {
            accessorKey: "date",
            header: "Fecha",
            cell: ({ row }) => new Date(row.getValue("date")).toLocaleDateString('es-ES')
        },
        {
            accessorKey: "start_time",
            header: "Hora Inicio",
            cell: ({ row }) => (row.getValue("start_time") as string).substring(0, 5)
        },
        {
            accessorKey: "end_time",
            header: "Hora Fin",
            cell: ({ row }) => (row.getValue("end_time") as string).substring(0, 5)
        },
    ];

    // Configuration for Students
    const studentsColumns: ColumnDef<ParticipantListItem>[] = [
        { accessorKey: "person_name", header: "Estudiante" },
        {
            accessorKey: "enrollment_status",
            header: "Estado Inscripción",
            cell: ({ row }) => (
                <Badge variant="outline">
                    {enrollmentStatusDisplay[row.original.enrollment_status]}
                </Badge>
            )
        },
        {
            accessorKey: "academic_status_name",
            header: "Estado Académico"
        },
        {
            accessorKey: "grade",
            header: "Nota",
            cell: ({ row }) => row.original.grade ? `${row.original.grade}/20` : "N/A"
        },
    ];

    return (
        <div className="flex flex-col h-full space-y-6 p-8">
            {/* Header */}
            <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 border-b pb-6">
                <div>
                    <div className="flex items-center gap-3 mb-2">
                        <h1 className="text-2xl font-bold tracking-tight">{course.name}</h1>
                        <Badge variant="outline">
                            {courseStatusDisplay[course.status]}
                        </Badge>
                    </div>
                    <div className="flex flex-wrap items-center gap-2 text-muted-foreground text-sm">
                        <span>{courseModalityDisplay[course.modality]}</span>
                        <span>•</span>
                        <span>{course.duration_hours}h</span>
                        <span>•</span>
                        <span>{course.enrolled_count}/{course.max_participants} inscritos</span>
                    </div>
                </div>
                <div className="flex gap-2">
                    <Button variant="outline" onClick={() => router.push(`/admin/training/${id}/edit`)}>
                        <Edit className="mr-2 size-4" />
                        Editar Curso
                    </Button>
                    <Button variant="outline" onClick={() => router.back()}>
                        <ArrowLeft className="mr-2 size-4" />
                        Volver
                    </Button>
                </div>
            </div>

            <Tabs defaultValue={defaultTab} className="flex-1 flex flex-col">
                <TabsList className="w-full flex flex-col sm:grid sm:grid-cols-2 lg:grid-cols-4 h-auto p-1 bg-muted/50 gap-1">
                    <TabsTrigger
                        value="general"
                        className="data-[state=active]:bg-primary data-[state=active]:text-primary-foreground py-3 transition-all duration-300 w-full"
                    >
                        <BookOpen className="mr-1 size-4" />
                        <p className="truncate">Información General</p>
                    </TabsTrigger>
                    <TabsTrigger
                        value="syllabus"
                        className="data-[state=active]:bg-primary data-[state=active]:text-primary-foreground py-3 transition-all duration-300 w-full"
                    >
                        <FileText className="mr-1 size-4" />
                        <p className="truncate">Programa / Sesiones</p>
                    </TabsTrigger>
                    <TabsTrigger
                        value="people"
                        className="data-[state=active]:bg-primary data-[state=active]:text-primary-foreground py-3 transition-all duration-300 w-full"
                    >
                        <Users className="mr-1 size-4" />
                        <p className="truncate">Personas</p>
                    </TabsTrigger>
                    <TabsTrigger
                        value="requests"
                        className="data-[state=active]:bg-primary data-[state=active]:text-primary-foreground py-3 transition-all duration-300 w-full"
                    >
                        <Users className="mr-1 size-4" />
                        <p className="truncate">Solicitudes</p>
                    </TabsTrigger>
                </TabsList>

                <div className="flex-1 mt-6">
                    <TabsContent value="general" className="m-0 h-full">
                        <div className="grid gap-6">
                            <Card>
                                <CardHeader>
                                    <CardTitle>Descripción</CardTitle>
                                </CardHeader>
                                <CardContent>
                                    <p className="text-sm leading-relaxed text-muted-foreground whitespace-pre-wrap">
                                        {course.description || "No hay descripción disponible."}
                                    </p>
                                </CardContent>
                            </Card>

                            <Card>
                                <CardHeader>
                                    <CardTitle>Detalles del Curso</CardTitle>
                                </CardHeader>
                                <CardContent className="grid md:grid-cols-2 gap-4">
                                    <div>
                                        <p className="text-sm font-medium text-muted-foreground mb-1">Fecha de Inicio</p>
                                        <p className="text-sm">{new Date(course.start_date).toLocaleDateString('es-ES', {
                                            day: '2-digit',
                                            month: 'long',
                                            year: 'numeric'
                                        })}</p>
                                    </div>
                                    <div>
                                        <p className="text-sm font-medium text-muted-foreground mb-1">Fecha de Fin</p>
                                        <p className="text-sm">{new Date(course.end_date).toLocaleDateString('es-ES', {
                                            day: '2-digit',
                                            month: 'long',
                                            year: 'numeric'
                                        })}</p>
                                    </div>
                                    <div>
                                        <p className="text-sm font-medium text-muted-foreground mb-1">Duración</p>
                                        <p className="text-sm">{course.duration_hours} horas</p>
                                    </div>
                                    <div>
                                        <p className="text-sm font-medium text-muted-foreground mb-1">Cupo Máximo</p>
                                        <p className="text-sm">{course.max_participants} estudiantes</p>
                                    </div>
                                </CardContent>
                            </Card>

                            {course.instructor_name && (
                                <Card>
                                    <CardHeader>
                                        <CardTitle>Instructor Asignado</CardTitle>
                                    </CardHeader>
                                    <CardContent>
                                        <Badge variant="secondary">
                                            {course.instructor_name}
                                        </Badge>
                                    </CardContent>
                                </Card>
                            )}
                        </div>
                    </TabsContent>

                    <TabsContent value="syllabus" className="m-0 h-full">
                        <CatalogCRUD
                            title=""
                            apiUrl={`/api/training/sessions/?course=${id}`}
                            fields={sessionsFields}
                            columns={sessionsColumns}
                            searchKey="topic"
                        />
                    </TabsContent>

                    <TabsContent value="people" className="m-0 h-full">
                        <CoursePersonnel courseId={id} />
                    </TabsContent>

                    <TabsContent value="requests" className="m-0 h-full">
                        <CourseRequests courseId={id} />
                    </TabsContent>
                </div>
            </Tabs>
        </div>
    );
}

function CourseDetailSkeleton() {
    return (
        <div className="space-y-6 p-6">
            <div className="flex items-center gap-4">
                <Skeleton className="h-10 w-10 rounded-md" />
                <div className="space-y-2">
                    <Skeleton className="h-8 w-64" />
                    <Skeleton className="h-4 w-48" />
                </div>
            </div>
            <div className="grid gap-6 md:grid-cols-3">
                <Skeleton className="h-[300px] w-full" />
                <Skeleton className="h-[300px] w-full" />
                <Skeleton className="h-[300px] w-full" />
            </div>
        </div>
    );
}
</file>

<file path="frontend2/app/(main)/admin/training/new/page.tsx">
"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";
import { z } from "zod";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { ArrowLeft, Loader2, BookOpen } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import {
    Form,
    FormControl,
    FormField,
    FormItem,
    FormLabel,
    FormMessage,
} from "@/components/ui/form";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import {
    Select,
    SelectContent,
    SelectItem,
    SelectTrigger,
    SelectValue,
} from "@/components/ui/select";
import { DatePicker } from "@/components/ui/date-picker";
import { Combobox } from "@/components/ui/combobox";
import { FileUpload } from "@/components/ui/file-upload";
import { format, parseISO } from "date-fns";
import apiClient from "@/lib/api-client";
import { toast } from "sonner";
import { Switch } from "@/components/ui/switch";
import useSWR from "swr";

const courseFormSchema = z.object({
    name: z.string().min(1, "El nombre es requerido"),
    description: z.string().optional(),
    cover_image: z.any().optional(),
    status: z.enum(["BOR", "PRO", "EJE", "FIN", "CAN"]),
    modality: z.enum(["PRE", "VIR", "ASY", "MIX"]),
    start_date: z.string().min(1, "La fecha de inicio es requerida"),
    end_date: z.string().min(1, "La fecha de fin es requerida"),
    duration_hours: z.number().min(1, "La duración debe ser mayor a 0"),
    max_participants: z.number().min(1, "El cupo máximo debe ser mayor a 0"),
    is_public: z.boolean(),
    department: z.number().optional(),
}).refine((data) => {
    if (data.start_date && data.end_date) {
        return new Date(data.end_date) > new Date(data.start_date);
    }
    return true;
}, {
    message: "La fecha de fin debe ser posterior a la fecha de inicio",
    path: ["end_date"],
}).refine((data) => {
    if (!data.is_public && !data.department) {
        return false;
    }
    return true;
}, {
    message: "Si el curso es privado, debe seleccionar un departamento",
    path: ["department"],
});

type CourseFormValues = z.infer<typeof courseFormSchema>;

export default function NewCoursePage() {
    const router = useRouter();
    const [isSubmitting, setIsSubmitting] = useState(false);

    // Fetch departments for the combobox
    const { data: departments } = useSWR("/api/organization/departments/", (url) =>
        apiClient.get(url).then(res => res.data.results || res.data)
    );

    const departmentOptions = departments?.map((d: any) => ({
        value: d.id,
        label: d.name
    })) || [];

    const form = useForm<CourseFormValues>({
        resolver: zodResolver(courseFormSchema),
        defaultValues: {
            name: "",
            description: "",
            status: "BOR",
            modality: "PRE",
            start_date: "",
            end_date: "",
            duration_hours: 0,
            max_participants: 30,
            is_public: true,
        },
    });

    const isPublic = form.watch("is_public");

    const onSubmit = async (values: CourseFormValues) => {
        setIsSubmitting(true);
        try {
            const formData = new FormData();
            formData.append("name", values.name);
            if (values.description) formData.append("description", values.description);
            if (values.cover_image) formData.append("cover_image", values.cover_image);
            formData.append("status", values.status);
            formData.append("modality", values.modality);
            formData.append("start_date", values.start_date);
            formData.append("end_date", values.end_date);
            formData.append("duration_hours", values.duration_hours.toString());
            formData.append("max_participants", values.max_participants.toString());

            // Privacy fields
            formData.append("is_public", values.is_public.toString());
            if (!values.is_public && values.department) {
                formData.append("department", values.department.toString());
            }

            const response = await apiClient.post("/api/training/courses/", formData, {
                headers: {
                    "Content-Type": "multipart/form-data",
                },
            });
            toast.success("Curso creado exitosamente");
            router.push(`/admin/courses/${response.data.id}`);
        } catch (error: any) {
            console.error("Error creating course:", error);
            if (error.response?.data) {
                const errors = error.response.data;
                Object.keys(errors).forEach((key) => {
                    if (key in values) {
                        form.setError(key as any, {
                            message: Array.isArray(errors[key]) ? errors[key][0] : errors[key],
                        });
                    }
                });
            }
            toast.error("Error al crear el curso");
        } finally {
            setIsSubmitting(false);
        }
    };

    return (
        <div className="flex flex-col h-full space-y-6 p-8">
            {/* Header */}
            <div className="flex items-center justify-between border-b pb-6">
                <div>
                    <div className="flex items-center gap-3 mb-2">
                        <BookOpen className="h-8 w-8 text-primary" />
                        <h1 className="text-2xl font-bold tracking-tight">Crear Nuevo Curso</h1>
                    </div>
                    <p className="text-muted-foreground">
                        Complete la información para registrar un nuevo curso
                    </p>
                </div>
                <Button variant="outline" onClick={() => router.back()}>
                    <ArrowLeft className="mr-2 h-4 w-4" />
                    Volver
                </Button>
            </div>

            {/* Form */}
            <Card>
                <CardHeader>
                    <CardTitle>Información del Curso</CardTitle>
                </CardHeader>
                <CardContent>
                    <Form {...form}>
                        <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
                            {/* Nombre */}
                            <FormField
                                control={form.control}
                                name="name"
                                render={({ field }) => (
                                    <FormItem>
                                        <FormLabel>Nombre del Curso *</FormLabel>
                                        <FormControl>
                                            <Input placeholder="Ej: Introducción a Python" {...field} />
                                        </FormControl>
                                        <FormMessage />
                                    </FormItem>
                                )}
                            />

                            {/* Descripción */}
                            <FormField
                                control={form.control}
                                name="description"
                                render={({ field }) => (
                                    <FormItem>
                                        <FormLabel>Descripción</FormLabel>
                                        <FormControl>
                                            <Textarea
                                                placeholder="Describe los objetivos y contenido del curso"
                                                rows={4}
                                                {...field}
                                            />
                                        </FormControl>
                                        <FormMessage />
                                    </FormItem>
                                )}
                            />

                            {/* Estado y Modalidad */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <FormField
                                    control={form.control}
                                    name="status"
                                    render={({ field }) => (
                                        <FormItem>
                                            <FormLabel>Estado *</FormLabel>
                                            <FormControl>
                                                <Combobox
                                                    options={[
                                                        { value: "BOR", label: "Borrador" },
                                                        { value: "PRO", label: "Programado" },
                                                        { value: "EJE", label: "En Ejecución" },
                                                        { value: "FIN", label: "Finalizado" },
                                                        { value: "CAN", label: "Cancelado" },
                                                    ]}
                                                    value={field.value}
                                                    onSelect={field.onChange}
                                                    placeholder="Seleccione el estado"
                                                    emptyText="No se encontraron resultados"
                                                />
                                            </FormControl>
                                            <FormMessage />
                                        </FormItem>
                                    )}
                                />

                                <FormField
                                    control={form.control}
                                    name="modality"
                                    render={({ field }) => (
                                        <FormItem>
                                            <FormLabel>Modalidad *</FormLabel>
                                            <FormControl>
                                                <Combobox
                                                    options={[
                                                        { value: "PRE", label: "Presencial" },
                                                        { value: "VIR", label: "Virtual (En Vivo / Zoom)" },
                                                        { value: "ASY", label: "Virtual (Autoaprendizaje)" },
                                                        { value: "MIX", label: "Híbrido / Mixto" },
                                                    ]}
                                                    value={field.value}
                                                    onSelect={field.onChange}
                                                    placeholder="Seleccione la modalidad"
                                                    emptyText="No se encontraron resultados"
                                                />
                                            </FormControl>
                                            <FormMessage />
                                        </FormItem>
                                    )}
                                />
                            </div>

                            {/* Fechas */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <FormField
                                    control={form.control}
                                    name="start_date"
                                    render={({ field }) => (
                                        <FormItem>
                                            <FormLabel>Fecha de Inicio *</FormLabel>
                                            <FormControl>
                                                <DatePicker
                                                    value={field.value ? parseISO(field.value) : undefined}
                                                    onChange={(date) => {
                                                        field.onChange(date ? format(date, "yyyy-MM-dd") : "");
                                                    }}
                                                    placeholder="Seleccione la fecha"
                                                />
                                            </FormControl>
                                            <FormMessage />
                                        </FormItem>
                                    )}
                                />

                                <FormField
                                    control={form.control}
                                    name="end_date"
                                    render={({ field }) => (
                                        <FormItem>
                                            <FormLabel>Fecha de Fin *</FormLabel>
                                            <FormControl>
                                                <DatePicker
                                                    value={field.value ? parseISO(field.value) : undefined}
                                                    onChange={(date) => {
                                                        field.onChange(date ? format(date, "yyyy-MM-dd") : "");
                                                    }}
                                                    placeholder="Seleccione la fecha"
                                                />
                                            </FormControl>
                                            <FormMessage />
                                        </FormItem>
                                    )}
                                />
                            </div>

                            {/* Duration and Max Participants */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <FormField
                                    control={form.control}
                                    name="duration_hours"
                                    render={({ field }) => (
                                        <FormItem>
                                            <FormLabel>Duración (horas) *</FormLabel>
                                            <FormControl>
                                                <Input
                                                    type="number"
                                                    placeholder="40"
                                                    {...field}
                                                    onChange={e => {
                                                        const value = e.target.value === "" ? 0 : parseFloat(e.target.value);
                                                        field.onChange(value);
                                                    }}
                                                />
                                            </FormControl>
                                            <FormMessage />
                                        </FormItem>
                                    )}
                                />

                                <FormField
                                    control={form.control}
                                    name="max_participants"
                                    render={({ field }) => (
                                        <FormItem>
                                            <FormLabel>Cupo Máximo *</FormLabel>
                                            <FormControl>
                                                <Input
                                                    type="number"
                                                    placeholder="30"
                                                    {...field}
                                                    onChange={e => {
                                                        const value = e.target.value === "" ? 0 : parseFloat(e.target.value);
                                                        field.onChange(value);
                                                    }}
                                                />
                                            </FormControl>
                                            <FormMessage />
                                        </FormItem>
                                    )}
                                />
                            </div>

                            {/* Privacy Settings */}
                            <div className="space-y-4 border p-4 rounded-lg bg-muted/20">
                                <h3 className="font-medium text-sm">Configuración de Privacidad</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                                    <FormField
                                        control={form.control}
                                        name="is_public"
                                        render={({ field }) => (
                                            <FormItem className="flex flex-row items-center justify-between rounded-lg border p-3 shadow-sm bg-background">
                                                <div className="space-y-0.5">
                                                    <FormLabel>Curso Público</FormLabel>
                                                    <div className="text-[0.8rem] text-muted-foreground">
                                                        Visible para todos los empleados
                                                    </div>
                                                </div>
                                                <FormControl>
                                                    <Switch
                                                        checked={field.value}
                                                        onCheckedChange={field.onChange}
                                                    />
                                                </FormControl>
                                            </FormItem>
                                        )}
                                    />

                                    {!isPublic && (
                                        <FormField
                                            control={form.control}
                                            name="department"
                                            render={({ field }) => (
                                                <FormItem>
                                                    <FormLabel>Departamento *</FormLabel>
                                                    <FormControl>
                                                        <Combobox
                                                            options={departmentOptions}
                                                            value={field.value}
                                                            onSelect={(val) => field.onChange(val === "" ? undefined : val)}
                                                            placeholder="Seleccione departamento"
                                                            emptyText="No se encontraron departamentos"
                                                        />
                                                    </FormControl>
                                                    <FormMessage />
                                                </FormItem>
                                            )}
                                        />
                                    )}
                                </div>
                            </div>

                            {/* Cover Image */}
                            <FormField
                                control={form.control}
                                name="cover_image"
                                render={({ field: { value, onChange, ...field } }) => (
                                    <FormItem>
                                        <FormLabel>Imagen de Portada</FormLabel>
                                        <FormControl>
                                            <FileUpload
                                                onFileSelect={onChange}
                                                currentFile={value}
                                                accept="image/*"
                                            />
                                        </FormControl>
                                        <FormMessage />
                                    </FormItem>
                                )}
                            />

                            {/* Submit Buttons */}
                            <div className="flex justify-end gap-4 pt-4">
                                <Button
                                    type="button"
                                    variant="outline"
                                    onClick={() => router.back()}
                                    disabled={isSubmitting}
                                >
                                    Cancelar
                                </Button>
                                <Button type="submit" disabled={isSubmitting}>
                                    {isSubmitting && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                                    Crear Curso
                                </Button>
                            </div>
                        </form>
                    </Form>
                </CardContent>
            </Card>
        </div>
    );
}
</file>

<file path="frontend2/app/(main)/admin/training/page.tsx">
"use client";

import { CatalogCRUD, CatalogField } from "@/components/catalogs/catalog-crud";
import { ColumnDef } from "@tanstack/react-table";
import { DropdownMenuItem } from "@/components/ui/dropdown-menu";
import { Plus, BookOpen, Eye } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import Link from "next/link";
import { Course, courseStatusDisplay, courseModalityDisplay } from "@/types/course";

export default function AdminCoursesPage() {
    const fields: CatalogField[] = [
        { name: "name", label: "Nombre del Curso", type: "text", required: true },
        { name: "description", label: "Descripción", type: "textarea", required: false },
        {
            name: "status",
            label: "Estado",
            type: "select",
            required: true,
            options: [
                { value: "BOR", label: "Borrador" },
                { value: "PRO", label: "Programado" },
                { value: "EJE", label: "En Ejecución" },
                { value: "FIN", label: "Finalizado" },
                { value: "CAN", label: "Cancelado" },
            ]
        },
        {
            name: "modality",
            label: "Modalidad",
            type: "select",
            required: true,
            options: [
                { value: "PRE", label: "Presencial" },
                { value: "VIR", label: "Virtual (En Vivo / Zoom)" },
                { value: "ASY", label: "Virtual (Autoaprendizaje)" },
                { value: "MIX", label: "Híbrido / Mixto" },
            ]
        },
        { name: "start_date", label: "Fecha de Inicio", type: "date", required: true },
        { name: "end_date", label: "Fecha de Fin", type: "date", required: true },
        { name: "duration_hours", label: "Duración (horas)", type: "number", required: true },
        { name: "max_participants", label: "Cupo Máximo", type: "number", required: true },
    ];

    const columns: ColumnDef<Course>[] = [
        {
            accessorKey: "name",
            header: "Nombre del Curso",
            cell: ({ row }) => (
                <div className="font-medium">
                    {row.original.name}
                </div>
            ),
        },
        {
            accessorKey: "status",
            header: "Estado",
            cell: ({ row }) => (
                <Badge variant="outline">
                    {courseStatusDisplay[row.original.status]}
                </Badge>
            ),
        },
        {
            accessorKey: "modality",
            header: "Modalidad",
            cell: ({ row }) => (
                <span className="text-sm text-muted-foreground">
                    {courseModalityDisplay[row.original.modality]}
                </span>
            ),
        },
        {
            accessorKey: "start_date",
            header: "Fecha Inicio",
            cell: ({ row }) => (
                <span className="text-sm">
                    {new Date(row.original.start_date).toLocaleDateString('es-ES')}
                </span>
            ),
        },
        {
            accessorKey: "end_date",
            header: "Fecha Fin",
            cell: ({ row }) => (
                <span className="text-sm">
                    {new Date(row.original.end_date).toLocaleDateString('es-ES')}
                </span>
            ),
        },
        {
            accessorKey: "enrolled_count",
            header: "Inscritos",
            cell: ({ row }) => (
                <div className="flex items-center gap-2">
                    <span className="text-sm font-medium">
                        {row.original.enrolled_count} / {row.original.max_participants}
                    </span>
                    {row.original.is_full && (
                        <Badge variant="destructive" className="text-xs">
                            Lleno
                        </Badge>
                    )}
                </div>
            ),
        },
    ];

    return (
        <div className="h-full flex-1 flex-col space-y-8 p-8 md:flex">
            <CatalogCRUD
                title="Gestión de Capacitación"
                icon={BookOpen}
                apiUrl="/api/training/courses/"
                fields={fields}
                columns={columns}
                searchKey="name"
                disableCreate={true}
                disableEdit={true}
                customToolbarActions={
                    <Button asChild variant="outline">
                        <Link href="/admin/training/new">
                            <Plus className="h-4 w-4" />
                            Nuevo Curso
                        </Link>
                    </Button>
                }
                extraActions={(item) => (
                    <>
                        <DropdownMenuItem asChild>
                            <Link href={`/admin/training/${item.id}`} className="cursor-pointer w-full flex items-center">
                                <Eye className="mr-2 h-4 w-4" />
                                Ver Detalle
                            </Link>
                        </DropdownMenuItem>
                    </>
                )}
            />
        </div>
    );
}
</file>

<file path="frontend2/app/(main)/employee/job-data/page.tsx">
"use client";

import { useState } from "react";
import useSWR from "swr";
import apiClient from "@/lib/api-client";
import {
    Briefcase,
    Calendar,
    User,
    Target,
    ListChecks,
    Building2,
    Loader2
} from "lucide-react";
import {
    Card,
    CardContent,
    CardHeader,
    CardTitle,
    CardDescription
} from "@/components/ui/card";
import {
    Select,
    SelectContent,
    SelectItem,
    SelectTrigger,
    SelectValue,
} from "@/components/ui/select";
import { Badge } from "@/components/ui/badge";

// Interfaces based on backend response
interface SupervisorInfo {
    id: number | null;
    name: string;
    position: string;
}

interface EmploymentData {
    id: number;
    person_full_name: string;
    person_document: string;
    position_full_name: string;
    department_name: string;
    hire_date: string;
    current_status_display: string;
    supervisor_info: SupervisorInfo | null;
    position_objective: string | null;
    position_functions: string[];
}

const fetcher = (url: string) => apiClient.get(url).then((res) => res.data);

export default function JobDataPage() {
    const { data: employments, error, isLoading } = useSWR<EmploymentData[]>(
        "/api/employment/employments/my_position_data/",
        fetcher
    );

    const [selectedEmploymentId, setSelectedEmploymentId] = useState<string | undefined>(undefined);

    // Determines the currently selected employment
    const selectedEmployment = employments?.find(
        (emp) => emp.id.toString() === selectedEmploymentId
    ) || employments?.[0];

    // Update selected ID when data loads if not already set
    if (employments && employments.length > 0 && !selectedEmploymentId) {
        setSelectedEmploymentId(employments[0].id.toString());
    }

    if (isLoading) {
        return (
            <div className="flex h-full items-center justify-center">
                <Loader2 className="animate-spin h-8 w-8 text-primary" />
            </div>
        );
    }

    if (error) {
        return (
            <div className="flex flex-col h-full items-center justify-center space-y-4">
                <p className="text-muted-foreground">Error cargando datos del puesto.</p>
            </div>
        );
    }

    if (!employments || employments.length === 0) {
        return (
            <div className="flex flex-col h-full items-center justify-center space-y-4">
                <Briefcase className="h-12 w-12 text-muted-foreground/50" />
                <h3 className="text-lg font-semibold">Sin Puesto Asignado</h3>
                <p className="text-muted-foreground text-center max-w-sm">
                    No se encontraron contratos activos asociados a tu perfil.
                </p>
            </div>
        );
    }

    return (
        <div className="flex flex-col h-full space-y-6 max-w-5xl mx-auto p-6">
            {/* Header */}
            <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between border-b pb-6 gap-4">
                <div>
                    <h1 className="text-2xl font-bold tracking-tight">Datos del Puesto</h1>
                    <p className="text-muted-foreground mt-1">
                        Información detallada de tu cargo y funciones
                    </p>
                </div>

                {/* Position Selector (only if multiple) */}
                {employments.length > 1 && (
                    <div className="w-full sm:w-auto">
                        <Select
                            value={selectedEmploymentId}
                            onValueChange={setSelectedEmploymentId}
                        >
                            <SelectTrigger className="w-full sm:w-[280px]">
                                <SelectValue placeholder="Selecciona un puesto" />
                            </SelectTrigger>
                            <SelectContent>
                                {employments.map((emp) => (
                                    <SelectItem key={emp.id} value={emp.id.toString()}>
                                        {emp.position_full_name}
                                    </SelectItem>
                                ))}
                            </SelectContent>
                        </Select>
                    </div>
                )}
            </div>

            {selectedEmployment && (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">

                    {/* 1. General Info Card */}
                    <Card className="col-span-1 md:col-span-2">
                        <CardHeader>
                            <CardTitle className="flex items-center gap-2">
                                <Briefcase className="h-5 w-5 text-primary" />
                                Información General
                            </CardTitle>
                        </CardHeader>
                        <CardContent className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div className="space-y-1">
                                <span className="text-sm text-muted-foreground">Cargo</span>
                                <p className="font-semibold text-lg">{selectedEmployment.position_full_name}</p>
                            </div>

                            <div className="space-y-1">
                                <span className="text-sm text-muted-foreground">Departamento</span>
                                <div className="flex items-center gap-2">
                                    <Building2 className="h-4 w-4 text-muted-foreground" />
                                    <p className="font-medium">{selectedEmployment.department_name}</p>
                                </div>
                            </div>

                            <div className="space-y-1">
                                <span className="text-sm text-muted-foreground">Fecha de Ingreso</span>
                                <div className="flex items-center gap-2">
                                    <Calendar className="h-4 w-4 text-muted-foreground" />
                                    <p className="font-medium">{selectedEmployment.hire_date}</p>
                                </div>
                            </div>

                            <div className="space-y-1">
                                <span className="text-sm text-muted-foreground">Estatus</span>
                                <div>
                                    <Badge variant={selectedEmployment.current_status_display === 'Activo' ? 'default' : 'secondary'}>
                                        {selectedEmployment.current_status_display}
                                    </Badge>
                                </div>
                            </div>
                        </CardContent>
                    </Card>

                    {/* 2. Supervisor Info */}
                    <Card>
                        <CardHeader>
                            <CardTitle className="flex items-center gap-2">
                                <User className="h-5 w-5 text-primary" />
                                Reporta a (Jefe Inmediato)
                            </CardTitle>
                        </CardHeader>
                        <CardContent>
                            {selectedEmployment.supervisor_info ? (
                                <div className="flex flex-col space-y-3">
                                    {selectedEmployment.supervisor_info.name === "VACANTE" ? (
                                        <div className="p-3 bg-muted/50 rounded-md border border-dashed">
                                            <p className="font-medium text-muted-foreground">Posición Vacante</p>
                                            <p className="text-sm text-muted-foreground">{selectedEmployment.supervisor_info.position}</p>
                                        </div>
                                    ) : (
                                        <>
                                            <div className="space-y-1">
                                                <span className="text-sm text-muted-foreground">Nombre</span>
                                                <p className="font-medium">{selectedEmployment.supervisor_info.name}</p>
                                            </div>
                                            <div className="space-y-1">
                                                <span className="text-sm text-muted-foreground">Cargo</span>
                                                <p className="font-medium">{selectedEmployment.supervisor_info.position}</p>
                                            </div>
                                        </>
                                    )}
                                </div>
                            ) : (
                                <p className="text-sm text-muted-foreground italic">No se ha asignado un supervisor.</p>
                            )}
                        </CardContent>
                    </Card>

                    {/* 3. Objective */}
                    <Card>
                        <CardHeader>
                            <CardTitle className="flex items-center gap-2">
                                <Target className="h-5 w-5 text-primary" />
                                Objetivo del Cargo
                            </CardTitle>
                        </CardHeader>
                        <CardContent>
                            {selectedEmployment.position_objective ? (
                                <p className="text-sm leading-relaxed text-muted-foreground">
                                    {selectedEmployment.position_objective}
                                </p>
                            ) : (
                                <p className="text-sm text-muted-foreground italic">No definido.</p>
                            )}
                        </CardContent>
                    </Card>

                    {/* 4. Functions (Full Width) */}
                    <Card className="col-span-1 md:col-span-2">
                        <CardHeader>
                            <CardTitle className="flex items-center gap-2">
                                <ListChecks className="h-5 w-5 text-primary" />
                                Funciones y Responsabilidades
                            </CardTitle>
                            <CardDescription>
                                Actividades principales asignadas a este puesto
                            </CardDescription>
                        </CardHeader>
                        <CardContent>
                            {selectedEmployment.position_functions && selectedEmployment.position_functions.length > 0 ? (
                                <ul className="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-3 pl-5 list-disc">
                                    {selectedEmployment.position_functions.map((func, index) => (
                                        <li key={index} className="text-sm text-muted-foreground pl-1">
                                            <span className="text-foreground/90">{func}</span>
                                        </li>
                                    ))}
                                </ul>
                            ) : (
                                <div className="flex flex-col items-center justify-center p-6 text-center text-muted-foreground bg-muted/20 rounded-lg">
                                    <ListChecks className="h-8 w-8 mb-2 opacity-50" />
                                    <p>No hay funciones registradas para este cargo.</p>
                                </div>
                            )}
                        </CardContent>
                    </Card>

                </div>
            )}
        </div>
    );
}
</file>

<file path="frontend2/app/(main)/employee/personal-data/page.tsx">
"use client";

import { useState, useEffect } from 'react';
import { useAuth } from "@/context/auth-context";
import apiClient from '@/lib/api-client';
import { Button } from "@/components/ui/button";
import {
    Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle
} from "@/components/ui/card";
import {
    Mail, Pencil, Phone, Loader2, MapPin,
    CreditCard, User, FileText, HeartHandshake, Star, Users
} from "lucide-react";
import Link from "next/link";

// Tipos de datos
interface PersonData {
    id: number;
    first_name: string;
    second_name: string | null;
    paternal_surname: string;
    maternal_surname: string | null;
    gender_name?: string;
    birthdate: string | null;
    country_of_birth_name?: string;
    addresses: any[];
    phones: any[];
    emails: any[];
    national_ids: any[];
    emergency_contacts: any[];
    bank_accounts: any[];
    dependents: any[];
    photo?: string;
}

export default function PersonalDataPage() {
    const { user } = useAuth();
    const [person, setPerson] = useState<PersonData | null>(null);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        const fetchData = async () => {
            // In frontend2 auth-context, 'user' structure might be different. 
            // Assuming user.person is the object or ID.
            // Based on training/page.tsx: user?.person?.id
            const personId = user?.person?.id;

            if (personId) {
                try {
                    setLoading(true);
                    const { data } = await apiClient.get(`/api/core/persons/${personId}/`);
                    setPerson(data);
                } catch (error) {
                    console.error("Error cargando datos", error);
                } finally {
                    setLoading(false);
                }
            } else {
                setLoading(false);
            }
        };

        if (user) fetchData();
    }, [user]);

    const val = (text: any) => text || <span className="text-muted-foreground italic text-xs">No registrado</span>;

    if (loading) return <div className="flex h-full items-center justify-center"><Loader2 className="animate-spin h-8 w-8 text-primary" /></div>;
    if (!person) return <div className="p-8 text-center text-muted-foreground">No se encontró información asociada.</div>;

    return (
        <div className="flex flex-col h-full space-y-6">
            {/* Header */}
            <div className="flex items-center justify-between border-b pb-6">
                <div>
                    <h1 className="text-2xl font-bold tracking-tight">Datos Personales</h1>
                    <p className="text-muted-foreground mt-1">
                        Gestiona tu información personal y de contacto
                    </p>
                </div>
            </div>

            <div className="grid grid-cols-1 gap-6 pb-8">

                {/* 1. INFORMACIÓN PERSONAL */}
                <Card>
                    <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                        <CardTitle className="text-lg font-semibold">Información Personal</CardTitle>
                        <Button variant="ghost" size="icon" className="rounded-full">
                            <Pencil className="size-4 text-primary" />
                        </Button>
                    </CardHeader>
                    <CardContent className="grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3 pt-4">
                        <div className="flex flex-col">
                            <span className="text-sm text-muted-foreground">Primer nombre:</span>
                            <span className="text-sm font-medium">{person.first_name}</span>
                        </div>
                        <div className="flex flex-col">
                            <span className="text-sm text-muted-foreground">Segundo nombre:</span>
                            <span className="text-sm font-medium">{val(person.second_name)}</span>
                        </div>
                        <div className="flex flex-col">
                            <span className="text-sm text-muted-foreground">Apellido paterno:</span>
                            <span className="text-sm font-medium">{person.paternal_surname}</span>
                        </div>
                        <div className="flex flex-col">
                            <span className="text-sm text-muted-foreground">Apellido materno:</span>
                            <span className="text-sm font-medium">{val(person.maternal_surname)}</span>
                        </div>
                        <div className="flex flex-col">
                            <span className="text-sm text-muted-foreground">Género:</span>
                            <span className="text-sm font-medium">{val(person.gender_name)}</span>
                        </div>
                    </CardContent>
                </Card>

                {/* 2. INFORMACIÓN BIOGRÁFICA */}
                <Card>
                    <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                        <CardTitle className="text-lg font-semibold">Información Biográfica</CardTitle>
                        <Button variant="ghost" size="icon" className="rounded-full">
                            <Pencil className="size-4 text-primary" />
                        </Button>
                    </CardHeader>
                    <CardContent className="grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3 pt-4">
                        <div className="flex flex-col">
                            <span className="text-sm text-muted-foreground">Fecha de nacimiento:</span>
                            <span className="text-sm font-medium">
                                {person.birthdate ? new Date(person.birthdate).toLocaleDateString() : val(null)}
                            </span>
                        </div>
                        <div className="flex flex-col">
                            <span className="text-sm text-muted-foreground">País de nacimiento:</span>
                            <span className="text-sm font-medium">{val(person.country_of_birth_name)}</span>
                        </div>
                    </CardContent>
                </Card>

                {/* 3. DIRECCIONES */}
                <Card>
                    <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                        <CardTitle className="text-lg font-semibold">Direcciones</CardTitle>
                        <Button variant="ghost" size="icon" className="rounded-full">
                            <Pencil className="size-4 text-primary" />
                        </Button>
                    </CardHeader>
                    <CardContent className="pt-4">
                        {person.addresses?.length > 0 ? (
                            <div className="flex flex-col gap-6">
                                {person.addresses.map((addr: any, idx: number) => (
                                    <div key={idx} className="grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3 border-b last:border-0 pb-4 last:pb-0">
                                        <div className="flex flex-col">
                                            <span className="text-sm text-muted-foreground">Tipo de dirección:</span>
                                            <span className="text-sm font-medium">{val(addr.address_type_name)}</span>
                                        </div>
                                        <div className="flex flex-col">
                                            <span className="text-sm text-muted-foreground">País:</span>
                                            <span className="text-sm font-medium">{val(addr.country_name)}</span>
                                        </div>
                                        <div className="flex flex-col">
                                            <span className="text-sm text-muted-foreground">Estado:</span>
                                            <span className="text-sm font-medium">{val(addr.state_name)}</span>
                                        </div>
                                        <div className="flex flex-col">
                                            <span className="text-sm text-muted-foreground">Calle:</span>
                                            <span className="text-sm font-medium">{addr.street_name_and_number}</span>
                                        </div>
                                        <div className="flex flex-col">
                                            <span className="text-sm text-muted-foreground">Ciudad:</span>
                                            <span className="text-sm font-medium">{val(addr.city)}</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <span className="text-sm italic text-muted-foreground">No hay direcciones registradas.</span>
                        )}
                    </CardContent>
                </Card>

                {/* 4. CONTACTO */}
                <Card>
                    <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                        <CardTitle className="text-lg font-semibold">Información de Contacto</CardTitle>
                        <Button variant="ghost" size="icon" className="rounded-full">
                            <Pencil className="size-4 text-primary" />
                        </Button>
                    </CardHeader>
                    <CardContent className="pt-4">
                        <div className="flex flex-col gap-4">
                            {/* Teléfonos */}
                            {person.phones?.map((phone: any, idx: number) => (
                                <div key={`ph-${idx}`} className="flex gap-4">
                                    <div className="relative size-10 flex items-center justify-center bg-primary/10 rounded-lg">
                                        <Phone className="size-5 text-primary" />
                                        {phone.is_primary && (
                                            <div className="absolute -right-1.5 -bottom-1.5 size-4 rounded-full bg-background flex items-center justify-center border shadow-sm">
                                                <Star className="size-3 text-yellow-500 fill-yellow-500" />
                                            </div>
                                        )}
                                    </div>
                                    <div className="flex flex-col">
                                        <span className="text-sm text-muted-foreground">{val(phone.phone_type_name)}</span>
                                        <span className="text-sm font-medium">{phone.full_number}</span>
                                    </div>
                                </div>
                            ))}

                            {/* Correos */}
                            {person.emails?.map((email: any, idx: number) => (
                                <div key={`em-${idx}`} className="flex gap-4">
                                    <div className="relative size-10 flex items-center justify-center bg-primary/10 rounded-lg">
                                        <Mail className="size-5 text-primary" />
                                        {email.is_primary && (
                                            <div className="absolute -right-1.5 -bottom-1.5 size-4 rounded-full bg-background flex items-center justify-center border shadow-sm">
                                                <Star className="size-3 text-yellow-500 fill-yellow-500" />
                                            </div>
                                        )}
                                    </div>
                                    <div className="flex flex-col">
                                        <span className="text-sm text-muted-foreground">{val(email.email_type_name)}</span>
                                        <span className="text-sm font-medium">{email.email_address}</span>
                                    </div>
                                </div>
                            ))}

                            {(!person.phones?.length && !person.emails?.length) && <span className="text-sm italic text-muted-foreground">Sin datos de contacto.</span>}
                        </div>
                    </CardContent>
                </Card>

                {/* 5. DOCUMENTOS */}
                <Card>
                    <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                        <CardTitle className="text-lg font-semibold">Documentos de Identidad</CardTitle>
                        <Button variant="ghost" size="icon" className="rounded-full">
                            <Pencil className="size-4 text-primary" />
                        </Button>
                    </CardHeader>
                    <CardContent className="pt-4">
                        <div className="flex flex-col gap-4">
                            {person.national_ids?.map((doc: any, idx: number) => (
                                <div key={idx} className="grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3 border-b last:border-0 pb-4 last:pb-0">
                                    <div className="flex flex-col">
                                        <span className="text-sm text-muted-foreground">Tipo de Documento:</span>
                                        <span className="text-sm font-medium">{val(doc.document_type_name)}</span>
                                    </div>
                                    <div className="flex flex-col">
                                        <span className="text-sm text-muted-foreground">No. de Documento:</span>
                                        <span className="text-sm font-medium">{doc.prefix}-{doc.number}</span>
                                    </div>
                                    <div className="flex flex-col">
                                        <span className="text-sm text-muted-foreground">Principal:</span>
                                        <span className="text-sm font-medium">{doc.is_primary ? "Si" : "No"}</span>
                                    </div>
                                </div>
                            ))}
                            {!person.national_ids?.length && <span className="text-sm italic text-muted-foreground">No registrado.</span>}
                        </div>
                    </CardContent>
                </Card>

                {/* 6. CONTACTO EMERGENCIA */}
                <Card>
                    <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                        <CardTitle className="text-lg font-semibold">Contacto de Emergencia</CardTitle>
                        <Button variant="ghost" size="icon" className="rounded-full">
                            <Pencil className="size-4 text-primary" />
                        </Button>
                    </CardHeader>
                    <CardContent className="pt-4">
                        {person.emergency_contacts?.length > 0 ? (
                            <div className="flex flex-col gap-6">
                                {person.emergency_contacts.map((ec: any, idx: number) => (
                                    <div key={idx} className="flex flex-col gap-2 border-b last:border-0 pb-4 last:pb-0">
                                        <div className="grid grid-cols-1 gap-4 md:grid-cols-3">
                                            <div className="flex flex-col">
                                                <span className="text-sm text-muted-foreground">Nombre Completo:</span>
                                                <span className="text-sm font-medium hover:text-primary transition-colors cursor-default">{ec.first_name} {ec.paternal_surname}</span>
                                            </div>
                                            <div className="flex flex-col">
                                                <span className="text-sm text-muted-foreground">Relación:</span>
                                                <span className="text-sm font-medium">{val(ec.relationship_name)}</span>
                                            </div>
                                            <div className="flex flex-col">
                                                <span className="text-sm text-muted-foreground">Principal:</span>
                                                <span className="text-sm font-medium">{ec.is_primary ? "Si" : "No"}</span>
                                            </div>
                                        </div>
                                        <div className="flex flex-col">
                                            <span className="text-sm text-muted-foreground">Teléfono:</span>
                                            <span className="text-sm font-medium">
                                                {ec.phone_country_code} {ec.phone_carrier_code} {ec.phone_number}
                                            </span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <span className="text-sm italic text-muted-foreground">No registrado.</span>
                        )}
                    </CardContent>
                </Card>

                {/* 7. DEPENDIENTES */}
                <Card>
                    <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                        <CardTitle className="text-lg font-semibold">Dependientes</CardTitle>
                        <Button variant="ghost" size="icon" className="rounded-full">
                            <Pencil className="size-4 text-primary" />
                        </Button>
                    </CardHeader>
                    <CardContent className="pt-4">
                        {person.dependents?.length > 0 ? (
                            <div className="flex flex-col gap-6">
                                {person.dependents.map((dep: any, idx: number) => (
                                    <div key={idx} className="flex flex-col gap-2 border-b last:border-0 pb-4 last:pb-0">
                                        <div className="grid grid-cols-1 gap-4 md:grid-cols-3">
                                            <div className="flex flex-col">
                                                <span className="text-sm text-muted-foreground">Nombre Completo:</span>
                                                <span className="text-sm font-medium">{dep.first_name} {dep.paternal_surname}</span>
                                            </div>
                                            <div className="flex flex-col">
                                                <span className="text-sm text-muted-foreground">Relación:</span>
                                                <span className="text-sm font-medium">{val(dep.relationship_name)}</span>
                                            </div>
                                            <div className="flex flex-col">
                                                <span className="text-sm text-muted-foreground">Género:</span>
                                                <span className="text-sm font-medium">{val(dep.gender_name)}</span>
                                            </div>
                                        </div>
                                        <div className="flex flex-col">
                                            <span className="text-sm text-muted-foreground">Fecha de nacimiento:</span>
                                            <span className="text-sm font-medium">
                                                {dep.birthdate ? new Date(dep.birthdate).toLocaleDateString() : val(null)}
                                            </span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <span className="text-sm italic text-muted-foreground">No registrados.</span>
                        )}
                    </CardContent>
                </Card>

                {/* 8. INFORMACIÓN DE PAGO */}
                <Card>
                    <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                        <CardTitle className="text-lg font-semibold">Información de Pago</CardTitle>
                        <Button variant="ghost" size="icon" className="rounded-full">
                            <Pencil className="size-4 text-primary" />
                        </Button>
                    </CardHeader>
                    <CardContent className="pt-4">
                        {person.bank_accounts?.length > 0 ? (
                            <div className="flex flex-col gap-6">
                                {person.bank_accounts.map((bank: any, idx: number) => (
                                    <div key={idx} className="flex gap-4 items-start">
                                        {/* 1. ÍCONO */}
                                        <div className="relative size-10 shrink-0 flex items-center justify-center bg-primary/10 rounded-lg">
                                            <CreditCard className="size-5 text-primary" />
                                            {bank.is_primary && (
                                                <div className="absolute -right-1.5 -bottom-1.5 size-4 rounded-full bg-background flex items-center justify-center border shadow-sm">
                                                    <Star className="size-3 text-yellow-500 fill-yellow-500" />
                                                </div>
                                            )}
                                        </div>

                                        {/* 2. TEXTOS */}
                                        <div className="w-full grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3">
                                            <div className="flex flex-col justify-center">
                                                <span className="text-sm text-muted-foreground">Banco:</span>
                                                <span className="text-sm font-medium">{val(bank.bank_name)}</span>
                                            </div>
                                            <div className="flex flex-col justify-center">
                                                <span className="text-sm text-muted-foreground">Tipo:</span>
                                                <span className="text-sm font-medium">{val(bank.bank_account_type_name)}</span>
                                            </div>
                                            <div className="flex flex-col justify-center col-span-2 md:col-span-1">
                                                <span className="text-sm text-muted-foreground">Número de cuenta:</span>
                                                <span className="text-sm font-medium">{bank.account_number}</span>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <span className="text-sm italic text-muted-foreground">No hay cuentas bancarias registradas.</span>
                        )}
                    </CardContent>
                </Card>

            </div>
        </div>
    );
}
</file>

<file path="frontend2/app/(main)/employee/talent-profile/page.tsx">
"use client";

import { useState, useEffect } from 'react';
import { useAuth } from "@/context/auth-context";
import apiClient from '@/lib/api-client';
import { Button } from "@/components/ui/button";
import {
    Card, CardContent, CardHeader, CardTitle
} from "@/components/ui/card";
import {
    Loader2, GraduationCap, FileText, Globe, Pencil
} from "lucide-react";

// Data types
interface Education {
    id: number;
    level_name: string;
    field_of_study_name: string;
    school_name: string;
    start_date: string;
    end_date?: string | null;
    is_current: boolean;
}

interface Certification {
    id: number;
    name: string;
    institution: string;
    effective_date: string;
    expiration_date?: string | null;
    credential_id?: string | null;
    url?: string | null;
}

interface Language {
    id: number;
    language_name: string;
    speaking_proficiency_name: string;
    reading_proficiency_name: string;
    writing_proficiency_name: string;
}

interface PersonData {
    id: number;
    full_name: string;
    educations?: Education[];
    certifications?: Certification[];
    languages?: Language[];
}

export default function TalentProfilePage() {
    const { user } = useAuth();
    const [person, setPerson] = useState<PersonData | null>(null);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        const fetchData = async () => {
            const personId = user?.person?.id;

            if (personId) {
                try {
                    setLoading(true);
                    const { data } = await apiClient.get(`/api/core/persons/${personId}/`);
                    setPerson(data);
                } catch (error) {
                    console.error("Error cargando datos de talento", error);
                } finally {
                    setLoading(false);
                }
            } else {
                setLoading(false);
            }
        };

        if (user) fetchData();
    }, [user]);

    const val = (text: any) => text || <span className="text-muted-foreground italic text-xs">No registrado</span>;

    if (loading) return <div className="flex h-full items-center justify-center"><Loader2 className="animate-spin h-8 w-8 text-primary" /></div>;
    if (!person) return <div className="p-8 text-center text-muted-foreground">No se encontró información asociada.</div>;

    return (
        <div className="flex flex-col h-full space-y-6">
            {/* Header */}
            <div className="flex items-center justify-between border-b pb-6">
                <div>
                    <h1 className="text-2xl font-bold tracking-tight">Perfil de Talento</h1>
                    <p className="text-muted-foreground mt-1">
                        Visualiza tu formación académica, certificaciones y habilidades
                    </p>
                </div>
            </div>

            <div className="grid grid-cols-1 gap-6 pb-8">

                {/* 1. FORMACIÓN ACADÉMICA */}
                <Card>
                    <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                        <CardTitle className="text-lg font-semibold flex items-center gap-2">
                            <GraduationCap className="h-5 w-5 text-primary" />
                            Formación Académica
                        </CardTitle>
                        <Button variant="ghost" size="icon" className="rounded-full">
                            <Pencil className="size-4 text-primary" />
                        </Button>
                    </CardHeader>
                    <CardContent className="pt-4">
                        {person.educations && person.educations.length > 0 ? (
                            <div className="flex flex-col gap-6">
                                {person.educations.map((edu) => (
                                    <div key={edu.id} className="grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3 border-b last:border-0 pb-4 last:pb-0">
                                        <div className="flex flex-col">
                                            <span className="text-sm text-muted-foreground">Nivel:</span>
                                            <span className="text-sm font-medium">{val(edu.level_name)}</span>
                                        </div>
                                        <div className="flex flex-col">
                                            <span className="text-sm text-muted-foreground">Campo de Estudio:</span>
                                            <span className="text-sm font-medium">{val(edu.field_of_study_name)}</span>
                                        </div>
                                        <div className="flex flex-col">
                                            <span className="text-sm text-muted-foreground">Institución:</span>
                                            <span className="text-sm font-medium">{edu.school_name}</span>
                                        </div>
                                        <div className="flex flex-col">
                                            <span className="text-sm text-muted-foreground">Fecha Inicio:</span>
                                            <span className="text-sm font-medium">{edu.start_date}</span>
                                        </div>
                                        <div className="flex flex-col">
                                            <span className="text-sm text-muted-foreground">Fecha Fin:</span>
                                            <span className="text-sm font-medium">
                                                {edu.is_current ? "Cursando actualmente" : (edu.end_date || val(null))}
                                            </span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <span className="text-sm italic text-muted-foreground">No hay registros de formación académica.</span>
                        )}
                    </CardContent>
                </Card>

                {/* 2. CERTIFICACIONES Y CURSOS */}
                <Card>
                    <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                        <CardTitle className="text-lg font-semibold flex items-center gap-2">
                            <FileText className="h-5 w-5 text-primary" />
                            Certificaciones y Cursos
                        </CardTitle>
                        <Button variant="ghost" size="icon" className="rounded-full">
                            <Pencil className="size-4 text-primary" />
                        </Button>
                    </CardHeader>
                    <CardContent className="pt-4">
                        {person.certifications && person.certifications.length > 0 ? (
                            <div className="flex flex-col gap-6">
                                {person.certifications.map((cert) => (
                                    <div key={cert.id} className="grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3 border-b last:border-0 pb-4 last:pb-0">
                                        <div className="flex flex-col">
                                            <span className="text-sm text-muted-foreground">Nombre:</span>
                                            <span className="text-sm font-medium">{cert.name}</span>
                                        </div>
                                        <div className="flex flex-col">
                                            <span className="text-sm text-muted-foreground">Institución:</span>
                                            <span className="text-sm font-medium">{cert.institution}</span>
                                        </div>
                                        <div className="flex flex-col">
                                            <span className="text-sm text-muted-foreground">Fecha Emisión:</span>
                                            <span className="text-sm font-medium">{cert.effective_date}</span>
                                        </div>
                                        {cert.expiration_date && (
                                            <div className="flex flex-col">
                                                <span className="text-sm text-muted-foreground">Fecha Expiración:</span>
                                                <span className="text-sm font-medium">{cert.expiration_date}</span>
                                            </div>
                                        )}
                                        {cert.credential_id && (
                                            <div className="flex flex-col">
                                                <span className="text-sm text-muted-foreground">ID Credencial:</span>
                                                <span className="text-sm font-medium">{cert.credential_id}</span>
                                            </div>
                                        )}
                                        {cert.url && (
                                            <div className="flex flex-col">
                                                <span className="text-sm text-muted-foreground">URL:</span>
                                                <a href={cert.url} target="_blank" rel="noopener noreferrer" className="text-sm font-medium text-primary hover:underline truncate">
                                                    {cert.url}
                                                </a>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <span className="text-sm italic text-muted-foreground">No hay certificaciones registradas.</span>
                        )}
                    </CardContent>
                </Card>

                {/* 3. IDIOMAS */}
                <Card>
                    <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                        <CardTitle className="text-lg font-semibold flex items-center gap-2">
                            <Globe className="h-5 w-5 text-primary" />
                            Idiomas
                        </CardTitle>
                        <Button variant="ghost" size="icon" className="rounded-full">
                            <Pencil className="size-4 text-primary" />
                        </Button>
                    </CardHeader>
                    <CardContent className="pt-4">
                        {person.languages && person.languages.length > 0 ? (
                            <div className="flex flex-col gap-6">
                                {person.languages.map((lang) => (
                                    <div key={lang.id} className="grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-4 border-b last:border-0 pb-4 last:pb-0">
                                        <div className="flex flex-col">
                                            <span className="text-sm text-muted-foreground">Idioma:</span>
                                            <span className="text-sm font-medium">{lang.language_name}</span>
                                        </div>
                                        <div className="flex flex-col">
                                            <span className="text-sm text-muted-foreground">Habla:</span>
                                            <span className="text-sm font-medium">{lang.speaking_proficiency_name}</span>
                                        </div>
                                        <div className="flex flex-col">
                                            <span className="text-sm text-muted-foreground">Lectura:</span>
                                            <span className="text-sm font-medium">{lang.reading_proficiency_name}</span>
                                        </div>
                                        <div className="flex flex-col">
                                            <span className="text-sm text-muted-foreground">Escritura:</span>
                                            <span className="text-sm font-medium">{lang.writing_proficiency_name}</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <span className="text-sm italic text-muted-foreground">No hay idiomas registrados.</span>
                        )}
                    </CardContent>
                </Card>

            </div>
        </div>
    );
}
</file>

<file path="frontend2/app/(main)/org-chart/page.tsx">
"use client";

import useSWR from "swr";
import { Loader2, Building2 } from "lucide-react";
import apiClient from "@/lib/api-client";
import { OrganizationOrgChart, DepartmentNodeData } from "@/components/departments/organization-org-chart";

const fetcher = (url: string) => apiClient.get(url).then((res) => res.data);

export default function OrgChartPage() {
    const { data: departments, error, isLoading } = useSWR<DepartmentNodeData[]>(
        "/api/organization/departments/institutional_chart/",
        fetcher
    );

    if (isLoading) {
        return (
            <div className="flex h-full items-center justify-center">
                <Loader2 className="animate-spin h-8 w-8 text-primary" />
            </div>
        );
    }

    if (error) {
        return (
            <div className="p-8 text-center text-muted-foreground">
                Error al cargar el organigrama. Por favor, intente nuevamente.
            </div>
        );
    }

    return (
        <div className="flex flex-col h-full space-y-6">
            {/* Header */}
            <div className="flex items-center justify-between border-b pb-6">
                <div>
                    <h1 className="text-2xl font-bold tracking-tight">Organigrama Institucional</h1>
                    <p className="text-muted-foreground mt-1">
                        Visualiza la estructura jerárquica de todos los departamentos
                    </p>
                </div>
            </div>

            <div className="flex-1 bg-slate-50/50 rounded-lg border p-4 min-h-[500px]">
                {departments && departments.length > 0 ? (
                    <OrganizationOrgChart departments={departments} />
                ) : (
                    <div className="flex h-full items-center justify-center text-muted-foreground">
                        No hay departamentos registrados.
                    </div>
                )}
            </div>
        </div>
    );
}
</file>

<file path="frontend2/app/(main)/training/[id]/lessons/[lessonId]/page.tsx">
"use client";

import { use, useState } from "react";
import { useRouter } from "next/navigation";
import useSWR, { mutate } from "swr";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Skeleton } from "@/components/ui/skeleton";
import {
    ArrowLeft,
    FileText,
    ExternalLink,
    Download,
    CheckCircle,
    Circle,
    Edit,
    Trash2,
    Plus
} from "lucide-react";
import {
    Dialog,
    DialogContent,
    DialogDescription,
    DialogFooter,
    DialogHeader,
    DialogTitle,
    DialogTrigger,
} from "@/components/ui/dialog";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import {
    Select,
    SelectContent,
    SelectItem,
    SelectTrigger,
    SelectValue,
} from "@/components/ui/select";
import { FileUpload } from "@/components/ui/file-upload";
import {
    DropdownMenu,
    DropdownMenuContent,
    DropdownMenuItem,
    DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import apiClient from "@/lib/api-client";
import { useAuth } from "@/context/auth-context";
import { toast } from "sonner";
import { CourseLesson, CourseResource, LessonProgress } from "@/types/course";

const fetcher = (url: string) => apiClient.get(url).then((res) => res.data);

export default function LessonDetailPage({ params }: { params: Promise<{ id: string; lessonId: string }> }) {
    const { id, lessonId } = use(params);
    const router = useRouter();
    const { user } = useAuth();

    // Fetch Lesson Data
    const { data: lesson, error, isLoading } = useSWR<CourseLesson>(
        `/api/training/lessons/${lessonId}/`,
        fetcher
    );

    // Fetch User Progress for this lesson
    const { data: progress } = useSWR<LessonProgress[]>(
        user?.person ? `/api/training/lesson-progress/?lesson=${lessonId}` : null,
        fetcher
    );

    // 🔧 FIX: Check if user is the SPECIFIC instructor for this course
    const isInstructor = user?.person?.id === lesson?.course_instructor_id || user?.is_staff;
    const isCompleted = progress && progress.length > 0 && progress[0].completed;

    // State for Resource Upload
    const [isResourceDialogOpen, setIsResourceDialogOpen] = useState(false);
    const [resourceName, setResourceName] = useState("");
    const [resourceType, setResourceType] = useState<"FIL" | "URL">("FIL");
    const [resourceFile, setResourceFile] = useState<File | null>(null);
    const [resourceUrl, setResourceUrl] = useState("");
    const [isUploading, setIsUploading] = useState(false);

    // State for Lesson Edit
    const [isEditDialogOpen, setIsEditDialogOpen] = useState(false);
    const [editTitle, setEditTitle] = useState("");
    const [editContent, setEditContent] = useState("");
    const [isSaving, setIsSaving] = useState(false);

    const handleMarkComplete = async () => {
        try {
            await apiClient.post("/api/training/lesson-progress/mark_complete/", {
                lesson_id: lessonId
            });
            toast.success("Lección completada");
            mutate(`/api/training/lesson-progress/?lesson=${lessonId}`);
            mutate(`/api/training/courses/${id}/my_enrollment/`); // Update course progress
        } catch (error) {
            console.error("Error marking complete:", error);
            toast.error("Error al marcar como completada");
        }
    };

    const handleUnmarkComplete = async () => {
        if (!progress || progress.length === 0) return;
        try {
            await apiClient.delete(`/api/training/lesson-progress/${progress[0].id}/`);
            toast.success("Lección desmarcada");
            mutate(`/api/training/lesson-progress/?lesson=${lessonId}`);
            mutate(`/api/training/courses/${id}/my_enrollment/`);
        } catch (error) {
            console.error("Error unmarking:", error);
            toast.error("Error al desmarcar la lección");
        }
    };

    // 🆕 NEW: Delete Lesson Handler
    const handleDeleteLesson = async () => {
        if (!confirm("¿Estás seguro de eliminar esta lección?")) return;
        try {
            await apiClient.delete(`/api/training/lessons/${lessonId}/`);
            toast.success("Lección eliminada");
            router.push(`/training`);
        } catch (error) {
            console.error("Error deleting lesson:", error);
            toast.error("Error al eliminar la lección");
        }
    };

    const handleUploadResource = async () => {
        if (!resourceName) {
            toast.error("El nombre es obligatorio");
            return;
        }
        if (resourceType === "FIL" && !resourceFile) {
            toast.error("Debes seleccionar un archivo");
            return;
        }
        if (resourceType === "URL" && !resourceUrl) {
            toast.error("Debes ingresar una URL");
            return;
        }

        setIsUploading(true);
        try {
            const formData = new FormData();
            formData.append("course", id); // Required by model, though linked to lesson
            formData.append("lesson", lessonId);
            formData.append("name", resourceName);
            formData.append("resource_type", resourceType);

            if (resourceType === "FIL" && resourceFile) {
                formData.append("file", resourceFile);
            } else if (resourceType === "URL") {
                formData.append("url", resourceUrl);
            }

            await apiClient.post("/api/training/resources/", formData, {
                headers: { "Content-Type": "multipart/form-data" },
            });

            toast.success("Recurso añadido exitosamente");
            setIsResourceDialogOpen(false);
            setResourceName("");
            setResourceFile(null);
            setResourceUrl("");
            mutate(`/api/training/lessons/${lessonId}/`); // Refresh lesson data
        } catch (error) {
            console.error("Error uploading resource:", error);
            toast.error("Error al subir el recurso");
        } finally {
            setIsUploading(false);
        }
    };

    const handleDeleteResource = async (resourceId: number) => {
        if (!confirm("¿Estás seguro de eliminar este recurso?")) return;
        try {
            await apiClient.delete(`/api/training/resources/${resourceId}/`);
            toast.success("Recurso eliminado");
            mutate(`/api/training/lessons/${lessonId}/`);
        } catch (error) {
            console.error("Error deleting resource:", error);
            toast.error("Error al eliminar el recurso");
        }
    };

    const handleUpdateLesson = async () => {
        setIsSaving(true);
        try {
            await apiClient.patch(`/api/training/lessons/${lessonId}/`, {
                title: editTitle,
                content: editContent
            });
            toast.success("Lección actualizada");
            setIsEditDialogOpen(false);
            mutate(`/api/training/lessons/${lessonId}/`);
        } catch (error) {
            console.error("Error updating lesson:", error);
            toast.error("Error al actualizar la lección");
        } finally {
            setIsSaving(false);
        }
    };

    if (isLoading) return <div className="p-8"><Skeleton className="h-8 w-1/3 mb-4" /><Skeleton className="h-64 w-full" /></div>;
    if (error || !lesson) return <div className="p-8 text-destructive">Error al cargar la lección</div>;

    return (
        <div className="container mx-auto py-6 max-w-4xl">
            {/* Header */}
            <div className="flex items-center justify-between mb-6">
                <Button variant="ghost" onClick={() => router.push(`/courses/${id}`)}>
                    <ArrowLeft className="mr-2 h-4 w-4" />
                    Volver al Curso
                </Button>

                <div className="flex items-center gap-2">
                    {isInstructor && (
                        <>
                            <Dialog open={isEditDialogOpen} onOpenChange={setIsEditDialogOpen}>
                                <DialogTrigger asChild>
                                    <Button variant="outline" onClick={() => {
                                        setEditTitle(lesson.title);
                                        setEditContent(lesson.content || "");
                                    }}>
                                        <Edit className="mr-2 h-4 w-4" />
                                        Editar
                                    </Button>
                                </DialogTrigger>
                                <DialogContent className="max-w-2xl">
                                    <DialogHeader>
                                        <DialogTitle>Editar Lección</DialogTitle>
                                    </DialogHeader>
                                    <div className="grid gap-4 py-4">
                                        <div className="grid gap-2">
                                            <Label>Título</Label>
                                            <Input value={editTitle} onChange={(e) => setEditTitle(e.target.value)} />
                                        </div>
                                        <div className="grid gap-2">
                                            <Label>Contenido</Label>
                                            <Textarea
                                                value={editContent || ""}
                                                onChange={(e) => setEditContent(e.target.value)}
                                                rows={10}
                                            />
                                        </div>
                                    </div>
                                    <DialogFooter>
                                        <Button variant="outline" onClick={() => setIsEditDialogOpen(false)}>Cancelar</Button>
                                        <Button onClick={handleUpdateLesson} disabled={isSaving}>Guardar Cambios</Button>
                                    </DialogFooter>
                                </DialogContent>
                            </Dialog>

                            <Button variant="destructive" onClick={handleDeleteLesson}>
                                <Trash2 className="mr-2 h-4 w-4" />
                                Eliminar
                            </Button>
                        </>
                    )}

                    {!isInstructor && (
                        isCompleted ? (
                            <Button variant="outline" className="text-green-600 border-green-200 bg-green-50" onClick={handleUnmarkComplete}>
                                <CheckCircle className="mr-2 h-4 w-4" />
                                Completada
                            </Button>
                        ) : (
                            <Button onClick={handleMarkComplete}>
                                <Circle className="mr-2 h-4 w-4" />
                                Marcar como Completada
                            </Button>
                        )
                    )}
                </div>
            </div>

            {/* Lesson Content */}
            <Card className="mb-8">
                <CardHeader>
                    <div className="flex items-center justify-between">
                        <div>
                            <p className="text-sm text-muted-foreground mb-1">{lesson.module_name}</p>
                            <CardTitle className="text-2xl">{lesson.title}</CardTitle>
                        </div>
                        <Badge variant="secondary">{lesson.duration_minutes} min</Badge>
                    </div>
                </CardHeader>
                <CardContent>
                    <div className="prose dark:prose-invert max-w-none">
                        <p className="whitespace-pre-wrap">{lesson.content || "Sin contenido de texto."}</p>
                    </div>
                </CardContent>
            </Card>

            {/* Resources Section */}
            <div className="mb-8">
                <div className="flex items-center justify-between mb-4">
                    <h2 className="text-xl font-semibold flex items-center">
                        <FileText className="mr-2 h-5 w-5" />
                        Recursos y Materiales
                    </h2>
                    {isInstructor && (
                        <Dialog open={isResourceDialogOpen} onOpenChange={setIsResourceDialogOpen}>
                            <DialogTrigger asChild>
                                <Button size="sm">
                                    <Plus className="mr-2 h-4 w-4" />
                                    Añadir Recurso
                                </Button>
                            </DialogTrigger>
                            <DialogContent>
                                <DialogHeader>
                                    <DialogTitle>Añadir Recurso a la Lección</DialogTitle>
                                </DialogHeader>
                                <div className="grid gap-4 py-4">
                                    <div className="grid gap-2">
                                        <Label>Nombre</Label>
                                        <Input
                                            value={resourceName}
                                            onChange={(e) => setResourceName(e.target.value)}
                                            placeholder="Ej: Diapositivas de la clase"
                                        />
                                    </div>
                                    <div className="grid gap-2">
                                        <Label>Tipo</Label>
                                        <Select value={resourceType} onValueChange={(val: "FIL" | "URL") => setResourceType(val)}>
                                            <SelectTrigger><SelectValue /></SelectTrigger>
                                            <SelectContent>
                                                <SelectItem value="FIL">Archivo</SelectItem>
                                                <SelectItem value="URL">Enlace / Video</SelectItem>
                                            </SelectContent>
                                        </Select>
                                    </div>
                                    {resourceType === "FIL" ? (
                                        <div className="grid gap-2">
                                            <Label>Archivo</Label>
                                            <FileUpload
                                                onFileSelect={setResourceFile}
                                                accept="*/*"
                                                currentFile={resourceFile}
                                            />
                                        </div>
                                    ) : (
                                        <div className="grid gap-2">
                                            <Label>URL</Label>
                                            <Input
                                                value={resourceUrl}
                                                onChange={(e) => setResourceUrl(e.target.value)}
                                                placeholder="https://..."
                                            />
                                        </div>
                                    )}
                                </div>
                                <DialogFooter>
                                    <Button variant="outline" onClick={() => setIsResourceDialogOpen(false)}>Cancelar</Button>
                                    <Button onClick={handleUploadResource} disabled={isUploading}>Subir</Button>
                                </DialogFooter>
                            </DialogContent>
                        </Dialog>
                    )}
                </div>

                {lesson.resources && lesson.resources.length > 0 ? (
                    <div className="grid gap-4 md:grid-cols-2">
                        {lesson.resources.map((resource) => (
                            <Card key={resource.id} className="hover:shadow-md transition-shadow">
                                <CardContent className="p-4 flex items-center justify-between">
                                    <div className="flex items-center space-x-3 overflow-hidden">
                                        <div className="bg-primary/10 p-2 rounded-lg shrink-0">
                                            {resource.resource_type === 'FIL' ? (
                                                <FileText className="h-5 w-5 text-primary" />
                                            ) : (
                                                <ExternalLink className="h-5 w-5 text-primary" />
                                            )}
                                        </div>
                                        <div className="truncate">
                                            <p className="font-medium truncate">{resource.name}</p>
                                            <p className="text-xs text-muted-foreground">
                                                {resource.resource_type === 'FIL' ? 'Archivo Adjunto' : 'Enlace Externo'}
                                            </p>
                                        </div>
                                    </div>
                                    <div className="flex items-center space-x-2 shrink-0">
                                        {resource.resource_type === 'FIL' && resource.file_url ? (
                                            <Button size="icon" variant="ghost" asChild>
                                                <a href={resource.file_url} download target="_blank" rel="noopener noreferrer">
                                                    <Download className="h-4 w-4" />
                                                </a>
                                            </Button>
                                        ) : resource.resource_type === 'URL' && resource.url ? (
                                            <Button size="icon" variant="ghost" asChild>
                                                <a href={resource.url} target="_blank" rel="noopener noreferrer">
                                                    <ExternalLink className="h-4 w-4" />
                                                </a>
                                            </Button>
                                        ) : null}

                                        {isInstructor && (
                                            <Button
                                                size="icon"
                                                variant="ghost"
                                                className="text-destructive hover:text-destructive/90"
                                                onClick={() => handleDeleteResource(resource.id)}
                                            >
                                                <Trash2 className="h-4 w-4" />
                                            </Button>
                                        )}
                                    </div>
                                </CardContent>
                            </Card>
                        ))}
                    </div>
                ) : (
                    <div className="text-center py-8 border-2 border-dashed rounded-lg text-muted-foreground">
                        No hay recursos adicionales para esta lección.
                    </div>
                )}
            </div>
        </div>
    );
}
</file>

<file path="frontend2/app/(main)/training/[id]/page.tsx">
"use client";

import { use, useState } from "react";
import { useRouter } from "next/navigation";
import Link from "next/link";
import useSWR, { mutate } from "swr";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Skeleton } from "@/components/ui/skeleton";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import {
    Select,
    SelectContent,
    SelectItem,
    SelectTrigger,
    SelectValue,
} from "@/components/ui/select";
import {
    Dialog,
    DialogContent,
    DialogDescription,
    DialogFooter,
    DialogHeader,
    DialogTitle,
    DialogTrigger,
} from "@/components/ui/dialog";
import {
    DropdownMenu,
    DropdownMenuContent,
    DropdownMenuItem,
    DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import {
    BookOpen,
    FileText,
    Lock,
    Calendar,
    Clock,
    ExternalLink,
    Download,
    ArrowLeft,
    Plus,
    MoreVertical,
    Trash2,
    Link as LinkIcon,
    Users,  // 🆕 NEW
    CheckCircle,  // 🆕 NEW
    XCircle,  // 🆕 NEW
} from "lucide-react";
import { CourseHeader } from "@/components/courses/course-header";
import { FileUpload } from "@/components/ui/file-upload";
import {
    Table,
    TableBody,
    TableCell,
    TableHead,
    TableHeader,
    TableRow,
} from "@/components/ui/table";  // 🆕 NEW
import {
    Course,
    CourseSession,
    CourseResource,
    EnrollmentStatus,
    UserEnrollment,
    ParticipantListItem,
    LessonProgress,  // 🆕 NEW
} from "@/types/course";
import apiClient from "@/lib/api-client";
import { useAuth } from "@/context/auth-context";
import { toast } from "sonner";
import { CourseModuleAccordion } from "@/components/courses/course-module-accordion";  // 🆕 NEW

const fetcher = (url: string) => apiClient.get(url).then((res) => res.data);

export default function CourseDetailPage({ params }: { params: Promise<{ id: string }> }) {
    const { id } = use(params);
    const router = useRouter();
    const { user } = useAuth();



    // 🆕 NEW: Grading state (People tab)
    const [isGradingDialogOpen, setIsGradingDialogOpen] = useState(false);
    const [selectedParticipant, setSelectedParticipant] = useState<ParticipantListItem | null>(null);
    const [finalGrade, setFinalGrade] = useState("");
    const [isGrading, setIsGrading] = useState(false);

    // 🆕 NEW: Content Creation State
    const [isCreateModuleOpen, setIsCreateModuleOpen] = useState(false);
    const [isCreateLessonOpen, setIsCreateLessonOpen] = useState(false);
    const [newModuleName, setNewModuleName] = useState("");
    const [newLessonTitle, setNewLessonTitle] = useState("");
    const [newLessonContent, setNewLessonContent] = useState("");
    const [newLessonDuration, setNewLessonDuration] = useState("");
    const [selectedModuleId, setSelectedModuleId] = useState<number | null>(null);
    const [isCreatingContent, setIsCreatingContent] = useState(false);

    // Fetch course details
    const { data: course, error, isLoading } = useSWR<Course>(
        `/api/training/courses/${id}/`,
        fetcher
    );

    // Fetch user enrollment status
    const { data: userEnrollment } = useSWR<UserEnrollment>(
        user?.person ? `/api/training/courses/${id}/my_enrollment/` : null,
        fetcher,
        {
            shouldRetryOnError: false,
            onError: () => {
                // 404 means no enrollment, which is expected
            },
        }
    );

    // 🆕 NEW: Fetch lesson progress (only if enrolled)
    const { data: lessonProgress, mutate: mutateProgress } = useSWR<LessonProgress[]>(
        userEnrollment?.enrollment_status === EnrollmentStatus.ENROLLED
            ? `/api/training/lesson-progress/?enrollment=${userEnrollment.id}`
            : null,
        fetcher
    );



    // 🆕 NEW: People tab handlers
    const handleApproveEnrollment = async (participantId: number) => {
        try {
            await apiClient.post(`/api/training/courses/${id}/approve_enrollment/`, {
                participant_id: participantId,
            });
            toast.success("Solicitud aprobada exitosamente");
            mutate(`/api/training/courses/${id}/`);
        } catch (error: any) {
            console.error("Error approving enrollment:", error);
            toast.error(error.response?.data?.error || "Error al aprobar la solicitud");
        }
    };

    const handleRejectEnrollment = async (participantId: number) => {
        if (!confirm("¿Estás seguro de rechazar esta solicitud?")) {
            return;
        }

        try {
            await apiClient.post(`/api/training/courses/${id}/reject_enrollment/`, {
                participant_id: participantId,
            });
            toast.success("Solicitud rechazada");
            mutate(`/api/training/courses/${id}/`);
        } catch (error: any) {
            console.error("Error rejecting enrollment:", error);
            toast.error(error.response?.data?.error || "Error al rechazar la solicitud");
        }
    };

    const handleAssignGrade = async () => {
        if (!selectedParticipant) return;

        const gradeNum = parseFloat(finalGrade);
        if (isNaN(gradeNum) || gradeNum < 0 || gradeNum > 20) {
            toast.error("La nota debe ser un número entre 0 y 20");
            return;
        }

        setIsGrading(true);
        try {
            await apiClient.post(`/api/training/participants/${selectedParticipant.id}/assign_grade/`, {
                final_grade: gradeNum,
            });
            toast.success("Nota asignada exitosamente");
            setIsGradingDialogOpen(false);
            setSelectedParticipant(null);
            setFinalGrade("");
            mutate(`/api/training/courses/${id}/`);
        } catch (error: any) {
            console.error("Error assigning grade:", error);
            toast.error(error.response?.data?.error || "Error al asignar la nota");
        } finally {
            setIsGrading(false);
        }
    };

    // 🆕 NEW: Content Creation Handlers
    const handleCreateModule = async () => {
        if (!newModuleName.trim()) {
            toast.error("El nombre del módulo es obligatorio");
            return;
        }

        setIsCreatingContent(true);
        try {
            await apiClient.post(`/api/training/modules/`, {
                course: id,
                name: newModuleName,
                order: (course?.modules?.length || 0) + 1
            });
            toast.success("Módulo creado exitosamente");
            setIsCreateModuleOpen(false);
            setNewModuleName("");
            mutate(`/api/training/courses/${id}/`);
        } catch (error: any) {
            console.error("Error creating module:", error);
            toast.error("Error al crear el módulo");
        } finally {
            setIsCreatingContent(false);
        }
    };

    const handleCreateLesson = async () => {
        if (!selectedModuleId || !newLessonTitle) return;
        setIsCreatingContent(true);
        try {
            const formData = new FormData();
            formData.append('module', selectedModuleId.toString());
            formData.append('title', newLessonTitle);
            formData.append('duration_minutes', newLessonDuration || "0");
            formData.append('order', "99"); // Backend handles order

            if (newLessonContent) formData.append('content', newLessonContent);

            await apiClient.post("/api/training/lessons/", formData, {
                headers: {
                    'Content-Type': 'multipart/form-data',
                },
            });
            toast.success("Lección creada exitosamente");
            setIsCreateLessonOpen(false);
            setNewLessonTitle("");
            setNewLessonContent("");
            setNewLessonDuration("");
            mutate(`/api/training/courses/${id}/`);
        } catch (error: any) {
            console.error("Error creating lesson:", error);
            toast.error("Error al crear la lección");
        } finally {
            setIsCreatingContent(false);
        }
    };

    // 🆕 NEW: Module Edit/Delete Handlers
    const handleUpdateModule = async (moduleId: number, newName: string) => {
        try {
            await apiClient.patch(`/api/training/modules/${moduleId}/`, {
                name: newName
            });
            toast.success("Módulo actualizado");
            mutate(`/api/training/courses/${id}/`);
        } catch (error) {
            console.error("Error updating module:", error);
            toast.error("Error al actualizar el módulo");
        }
    };

    const handleDeleteModule = async (moduleId: number) => {
        if (!confirm("¿Estás seguro de eliminar este módulo y todas sus lecciones?")) return;
        try {
            await apiClient.delete(`/api/training/modules/${moduleId}/`);
            toast.success("Módulo eliminado");
            mutate(`/api/training/courses/${id}/`);
        } catch (error) {
            console.error("Error deleting module:", error);
            toast.error("Error al eliminar el módulo");
        }
    };

    if (isLoading) {
        return <CourseDetailSkeleton />;
    }

    if (error || !course) {
        return (
            <div className="flex flex-col items-center justify-center h-full p-8 text-center">
                <h2 className="text-2xl font-bold text-destructive mb-2">Error</h2>
                <p className="text-muted-foreground mb-4">No se pudo cargar la información del curso.</p>
                <Button onClick={() => router.back()}>
                    <ArrowLeft className="mr-2 h-4 w-4" />
                    Volver
                </Button>
            </div>
        );
    }

    // Determinar si el usuario está inscrito (enrolled) o es instructor
    const isEnrolled = userEnrollment?.enrollment_status === EnrollmentStatus.ENROLLED;
    const isInstructor = user?.person?.id === course.instructor_id || user?.is_staff;
    const hasAccess = isEnrolled || isInstructor;

    return (
        <div className="flex flex-col space-y-6 p-8">
            {/* Back Button */}
            <Button variant="ghost" onClick={() => router.back()} className="w-fit">
                <ArrowLeft className="mr-2 h-4 w-4" />
                Volver a Cursos
            </Button>

            {/* Course Header */}
            <CourseHeader course={course} />

            {/* Tabs: Overview, Resources & Modules */}
            <Tabs defaultValue="overview" className="flex-1 flex flex-col">
                <TabsList className="w-full md:w-auto bg-muted/50 p-1">
                    <TabsTrigger
                        value="overview"
                        className="data-[state=active]:bg-primary data-[state=active]:text-primary-foreground py-3 px-6 transition-all duration-300"
                    >
                        <FileText className="mr-2 h-4 w-4" />
                        Información General
                    </TabsTrigger>

                    <TabsTrigger
                        value="modules"
                        className="data-[state=active]:bg-primary data-[state=active]:text-primary-foreground py-3 px-6 transition-all duration-300"
                    >
                        <BookOpen className="mr-2 h-4 w-4" />
                        Módulos y Sesiones
                        {!hasAccess && <Lock className="ml-2 h-4 w-4" />}
                    </TabsTrigger>
                    {isInstructor && (
                        <TabsTrigger
                            value="people"
                            className="data-[state=active]:bg-primary data-[state=active]:text-primary-foreground py-3 px-6 transition-all duration-300"
                        >
                            <Users className="mr-2 h-4 w-4" />
                            Personas
                        </TabsTrigger>
                    )}
                </TabsList>

                <div className="flex-1 mt-6">
                    {/* People Tab (Instructors Only) */}
                    {isInstructor && (
                        <TabsContent value="people" className="m-0 space-y-6">
                            {/* Pending Requests */}
                            {course.students?.some(s => s.enrollment_status === EnrollmentStatus.REQUESTED) && (
                                <Card>
                                    <CardHeader>
                                        <CardTitle className="text-lg font-semibold flex items-center">
                                            <Clock className="mr-2 h-5 w-5 text-orange-500" />
                                            Solicitudes Pendientes
                                        </CardTitle>
                                    </CardHeader>
                                    <CardContent>
                                        <Table>
                                            <TableHeader>
                                                <TableRow>
                                                    <TableHead>Nombre</TableHead>
                                                    <TableHead>Documento</TableHead>
                                                    <TableHead>Fecha Solicitud</TableHead>
                                                    <TableHead className="text-right">Acciones</TableHead>
                                                </TableRow>
                                            </TableHeader>
                                            <TableBody>
                                                {course.students
                                                    ?.filter(s => s.enrollment_status === EnrollmentStatus.REQUESTED)
                                                    .map((student) => (
                                                        <TableRow key={student.id}>
                                                            <TableCell className="font-medium">{student.person_name}</TableCell>
                                                            <TableCell>{student.person_id_document || "N/A"}</TableCell>
                                                            <TableCell>
                                                                {new Date().toLocaleDateString()} {/* TODO: Add created_at to API */}
                                                            </TableCell>
                                                            <TableCell className="text-right space-x-2">
                                                                <Button
                                                                    size="sm"
                                                                    variant="outline"
                                                                    className="text-green-600 border-green-200 hover:bg-green-50"
                                                                    onClick={() => handleApproveEnrollment(student.id)}
                                                                >
                                                                    <CheckCircle className="h-4 w-4 mr-1" />
                                                                    Aprobar
                                                                </Button>
                                                                <Button
                                                                    size="sm"
                                                                    variant="outline"
                                                                    className="text-red-600 border-red-200 hover:bg-red-50"
                                                                    onClick={() => handleRejectEnrollment(student.id)}
                                                                >
                                                                    <XCircle className="h-4 w-4 mr-1" />
                                                                    Rechazar
                                                                </Button>
                                                            </TableCell>
                                                        </TableRow>
                                                    ))}
                                            </TableBody>
                                        </Table>
                                    </CardContent>
                                </Card>
                            )}

                            {/* Enrolled Students */}
                            <Card>
                                <CardHeader>
                                    <CardTitle className="text-lg font-semibold flex items-center">
                                        <Users className="mr-2 h-5 w-5 text-blue-500" />
                                        Estudiantes Inscritos
                                    </CardTitle>
                                </CardHeader>
                                <CardContent>
                                    <Table>
                                        <TableHeader>
                                            <TableRow>
                                                <TableHead>Nombre</TableHead>
                                                <TableHead>Documento</TableHead>
                                                <TableHead>Estado Académico</TableHead>
                                                <TableHead>Nota Final</TableHead>
                                                <TableHead className="text-right">Acciones</TableHead>
                                            </TableRow>
                                        </TableHeader>
                                        <TableBody>
                                            {course.students
                                                ?.filter(s => s.enrollment_status === EnrollmentStatus.ENROLLED)
                                                .map((student) => (
                                                    <TableRow key={student.id}>
                                                        <TableCell className="font-medium">{student.person_name}</TableCell>
                                                        <TableCell>{student.person_id_document || "N/A"}</TableCell>
                                                        <TableCell>
                                                            <Badge variant={
                                                                student.academic_status === 'APR' || student.academic_status === 'COM' ? "default" :
                                                                    student.academic_status === 'REP' ? "destructive" : "secondary"
                                                            }>
                                                                {student.academic_status_name}
                                                            </Badge>
                                                        </TableCell>
                                                        <TableCell>
                                                            {student.grade !== undefined && student.grade !== null ? (
                                                                <span className="font-bold">{student.grade}</span>
                                                            ) : (
                                                                <span className="text-muted-foreground italic">Sin nota</span>
                                                            )}
                                                        </TableCell>
                                                        <TableCell className="text-right">
                                                            {course.requires_approval_to_complete && (
                                                                <Button
                                                                    size="sm"
                                                                    variant="outline"
                                                                    onClick={() => {
                                                                        setSelectedParticipant(student);
                                                                        setFinalGrade(student.grade?.toString() || "");
                                                                        setIsGradingDialogOpen(true);
                                                                    }}
                                                                >
                                                                    Evaluar
                                                                </Button>
                                                            )}
                                                        </TableCell>
                                                    </TableRow>
                                                ))}
                                            {(!course.students || course.students.filter(s => s.enrollment_status === EnrollmentStatus.ENROLLED).length === 0) && (
                                                <TableRow>
                                                    <TableCell colSpan={5} className="text-center py-8 text-muted-foreground">
                                                        No hay estudiantes inscritos en este curso.
                                                    </TableCell>
                                                </TableRow>
                                            )}
                                        </TableBody>
                                    </Table>
                                </CardContent>
                            </Card>

                        </TabsContent>
                    )}
                    {/* Overview Tab */}
                    <TabsContent value="overview" className="m-0">
                        <div className="grid gap-6">
                            {/* Description */}
                            <Card>
                                <CardHeader>
                                    <CardTitle>Descripción del Curso</CardTitle>
                                </CardHeader>
                                <CardContent>
                                    <p className="text-muted-foreground leading-relaxed">
                                        {course.description || "No hay descripción disponible."}
                                    </p>
                                </CardContent>
                            </Card>
                        </div>
                    </TabsContent>



                    {/* Modules Tab */}
                    <TabsContent value="modules" className="m-0">
                        <Card>
                            <CardHeader>
                                <CardTitle className="text-lg font-semibold flex items-center justify-between">
                                    <div className="flex items-center">
                                        <BookOpen className="mr-2 h-5 w-5 text-primary" />
                                        Contenido del Curso
                                    </div>
                                    {/* Progress Bar */}
                                    {isEnrolled && lessonProgress && (
                                        <div className="flex items-center text-sm font-normal text-muted-foreground">
                                            <span className="mr-2">Tu Progreso:</span>
                                            <Badge variant="outline">
                                                {Math.round((lessonProgress.filter(p => p.completed).length / (course.modules?.reduce((acc, m) => acc + (m.lessons?.length || 0), 0) || 1)) * 100)}%
                                            </Badge>
                                        </div>
                                    )}
                                </CardTitle>
                                {/* 🆕 NEW: Instructor Actions */}
                                {isInstructor && (
                                    <div className="flex gap-2 mt-4">
                                        <Dialog open={isCreateModuleOpen} onOpenChange={setIsCreateModuleOpen}>
                                            <DialogTrigger asChild>
                                                <Button size="sm">
                                                    <Plus className="mr-2 h-4 w-4" />
                                                    Nuevo Módulo
                                                </Button>
                                            </DialogTrigger>
                                            <DialogContent>
                                                <DialogHeader>
                                                    <DialogTitle>Crear Nuevo Módulo</DialogTitle>
                                                    <DialogDescription>Agrupa tus lecciones en módulos.</DialogDescription>
                                                </DialogHeader>
                                                <div className="grid gap-4 py-4">
                                                    <div className="grid gap-2">
                                                        <Label>Nombre del Módulo</Label>
                                                        <Input
                                                            value={newModuleName}
                                                            onChange={(e) => setNewModuleName(e.target.value)}
                                                            placeholder="Ej: Módulo 1: Introducción"
                                                        />
                                                    </div>
                                                </div>
                                                <DialogFooter>
                                                    <Button variant="outline" onClick={() => setIsCreateModuleOpen(false)}>Cancelar</Button>
                                                    <Button onClick={handleCreateModule} disabled={isCreatingContent}>Crear Módulo</Button>
                                                </DialogFooter>
                                            </DialogContent>
                                        </Dialog>

                                        <Dialog open={isCreateLessonOpen} onOpenChange={setIsCreateLessonOpen}>
                                            <DialogTrigger asChild>
                                                <Button size="sm" variant="outline">
                                                    <Plus className="mr-2 h-4 w-4" />
                                                    Nueva Lección
                                                </Button>
                                            </DialogTrigger>
                                            <DialogContent>
                                                <DialogHeader>
                                                    <DialogTitle>Crear Nueva Lección</DialogTitle>
                                                </DialogHeader>
                                                <div className="grid gap-4 py-4">
                                                    <div className="grid gap-2">
                                                        <Label>Módulo</Label>
                                                        <Select
                                                            onValueChange={(val) => setSelectedModuleId(parseInt(val))}
                                                        >
                                                            <SelectTrigger>
                                                                <SelectValue placeholder="Selecciona un módulo" />
                                                            </SelectTrigger>
                                                            <SelectContent>
                                                                {course.modules?.map((m) => (
                                                                    <SelectItem key={m.id} value={m.id.toString()}>
                                                                        {m.name}
                                                                    </SelectItem>
                                                                ))}
                                                            </SelectContent>
                                                        </Select>
                                                    </div>
                                                    <div className="grid gap-2">
                                                        <Label>Título de la Lección</Label>
                                                        <Input
                                                            value={newLessonTitle}
                                                            onChange={(e) => setNewLessonTitle(e.target.value)}
                                                            placeholder="Ej: Historia de la Seguridad"
                                                        />
                                                    </div>
                                                    <div className="grid gap-2">
                                                        <Label>Duración (minutos)</Label>
                                                        <Input
                                                            type="number"
                                                            value={newLessonDuration}
                                                            onChange={(e) => setNewLessonDuration(e.target.value)}
                                                            placeholder="Ej: 45"
                                                        />
                                                    </div>
                                                    <div className="grid gap-2">
                                                        <Label>Contenido (Texto)</Label>
                                                        <Input
                                                            value={newLessonContent}
                                                            onChange={(e) => setNewLessonContent(e.target.value)}
                                                            placeholder="Texto o descripción breve"
                                                        />
                                                    </div>
                                                </div>
                                                <DialogFooter>
                                                    <Button variant="outline" onClick={() => setIsCreateLessonOpen(false)}>Cancelar</Button>
                                                    <Button onClick={handleCreateLesson} disabled={isCreatingContent}>Crear Lección</Button>
                                                </DialogFooter>
                                            </DialogContent>
                                        </Dialog>
                                    </div>
                                )}
                            </CardHeader>
                            <CardContent>
                                {hasAccess ? (
                                    <div className="space-y-8">
                                        {/* 🆕 NEW: Hierarchical Content */}
                                        <CourseModuleAccordion
                                            modules={course.modules || []}
                                            progress={lessonProgress}
                                            onLessonComplete={() => {
                                                mutateProgress();
                                                mutate(`/api/training/courses/${id}/my_enrollment/`); // Update overall status
                                            }}
                                            isInstructor={isInstructor}
                                            onUpdateModule={handleUpdateModule}
                                            onDeleteModule={handleDeleteModule}
                                        />

                                        {/* Legacy Sessions (Attendance) */}
                                        {course.sessions && course.sessions.length > 0 && (
                                            <div className="mt-8 pt-8 border-t">
                                                <h3 className="text-lg font-semibold mb-4 flex items-center">
                                                    <Calendar className="mr-2 h-5 w-5 text-muted-foreground" />
                                                    Sesiones Programadas (Asistencia)
                                                </h3>
                                                <div className="space-y-4">
                                                    {course.sessions.map((session) => (
                                                        <div
                                                            key={session.id}
                                                            className="flex items-center justify-between p-4 rounded-lg border bg-card hover:bg-accent/50 transition-colors"
                                                        >
                                                            <div className="flex items-center space-x-4">
                                                                <div className="bg-primary/10 p-2 rounded-full">
                                                                    <Calendar className="h-5 w-5 text-primary" />
                                                                </div>
                                                                <div>
                                                                    <h4 className="font-medium">{session.topic}</h4>
                                                                    <div className="flex items-center text-sm text-muted-foreground mt-1 space-x-4">
                                                                        <span className="flex items-center">
                                                                            <Calendar className="h-3 w-3 mr-1" />
                                                                            {new Date(session.date).toLocaleDateString()}
                                                                        </span>
                                                                        <span className="flex items-center">
                                                                            <Clock className="h-3 w-3 mr-1" />
                                                                            {session.start_time.slice(0, 5)} - {session.end_time.slice(0, 5)}
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                ) : (
                                    <div className="flex flex-col items-center justify-center py-12 text-center space-y-4">
                                        <div className="bg-muted p-4 rounded-full">
                                            <Lock className="h-8 w-8 text-muted-foreground" />
                                        </div>
                                        <div>
                                            <h3 className="text-lg font-semibold">Contenido Bloqueado</h3>
                                            <p className="text-muted-foreground max-w-sm mx-auto mt-2">
                                                Debes estar inscrito en este curso para acceder a los módulos y lecciones.
                                            </p>
                                        </div>
                                    </div>
                                )}
                            </CardContent>
                        </Card>
                    </TabsContent>
                </div>
            </Tabs>
        </div>
    );
}

function SessionCard({ session, index }: { session: CourseSession; index: number }) {
    return (
        <Card className="hover:shadow-md transition-shadow">
            <CardHeader>
                <div className="flex items-center justify-between">
                    <div className="flex items-center gap-3">
                        <div className="flex items-center justify-center w-10 h-10 rounded-full bg-primary/10 text-primary font-semibold">
                            {index + 1}
                        </div>
                        <div>
                            <CardTitle className="text-lg">{session.topic}</CardTitle>
                            <div className="flex items-center gap-4 mt-1 text-sm text-muted-foreground">
                                <div className="flex items-center gap-1">
                                    <Calendar className="h-4 w-4" />
                                    {new Date(session.date).toLocaleDateString('es-ES', {
                                        weekday: 'long',
                                        day: '2-digit',
                                        month: 'long',
                                        year: 'numeric'
                                    })}
                                </div>
                                <div className="flex items-center gap-1">
                                    <Clock className="h-4 w-4" />
                                    {session.start_time.substring(0, 5)} - {session.end_time.substring(0, 5)}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </CardHeader>
        </Card>
    );
}

function CourseDetailSkeleton() {
    return (
        <div className="space-y-6 p-8">
            <Skeleton className="h-10 w-32" />
            <Skeleton className="h-64 w-full rounded-lg" />
            <div className="space-y-4">
                <Skeleton className="h-12 w-full" />
                <Skeleton className="h-64 w-full" />
            </div>
        </div>
    );
}
</file>

<file path="frontend2/app/(main)/training/page.tsx">
"use client";

import { useState } from "react";
import useSWR, { mutate } from "swr";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { BookOpen, Grid3x3, Loader2, Search } from "lucide-react";
import { CourseCard } from "@/components/courses/course-card";
import { Course, EnrollmentStatus } from "@/types/course";
import apiClient from "@/lib/api-client";
import { useAuth } from "@/context/auth-context";
import { Input } from "@/components/ui/input";

const fetcher = (url: string) => apiClient.get(url).then((res) => res.data.results || res.data);

interface CourseWithEnrollment extends Course {
    user_enrollment_status?: EnrollmentStatus;
}

export default function CoursesPage() {
    const { user } = useAuth();
    const [activeTab, setActiveTab] = useState<"my-courses" | "available">("my-courses");
    const [myCoursesSearch, setMyCoursesSearch] = useState("");
    const [availableCoursesSearch, setAvailableCoursesSearch] = useState("");

    // Fetch all available courses
    const { data: allCourses, error, isLoading } = useSWR<Course[]>(
        "/api/training/courses/",
        fetcher
    );

    // Fetch user's enrollments
    const { data: userEnrollments } = useSWR<any[]>(
        user?.person ? `/api/training/participants/?person=${user.person.id}` : null,
        fetcher
    );

    // Crear un mapa de course_id -> enrollment_status
    const enrollmentMap = new Map<number, EnrollmentStatus>();
    userEnrollments?.forEach((enrollment) => {
        if (enrollment.course) {
            enrollmentMap.set(Number(enrollment.course), enrollment.enrollment_status);
        }
    });

    // Separar cursos en "Mis Cursos" y "Disponibles"
    let myCourses: CourseWithEnrollment[] = [];
    let availableCourses: Course[] = [];

    allCourses?.forEach((course) => {
        const enrollmentStatus = enrollmentMap.get(course.id);
        const isInstructor = user?.person?.id === course.instructor_id;

        // Curso va a "Mis Cursos" si:
        // 1. El usuario está inscrito (tiene enrollment_status)
        // 2. El usuario es el instructor
        if (enrollmentStatus || isInstructor) {
            myCourses.push({ ...course, user_enrollment_status: enrollmentStatus });
        } else {
            availableCourses.push(course);
        }
    });

    // Filter courses based on search
    if (myCoursesSearch) {
        myCourses = myCourses.filter(course =>
            course.name.toLowerCase().includes(myCoursesSearch.toLowerCase()) ||
            course.description?.toLowerCase().includes(myCoursesSearch.toLowerCase())
        );
    }

    if (availableCoursesSearch) {
        availableCourses = availableCourses.filter(course =>
            course.name.toLowerCase().includes(availableCoursesSearch.toLowerCase()) ||
            course.description?.toLowerCase().includes(availableCoursesSearch.toLowerCase())
        );
    }

    if (isLoading) {
        return (
            <div className="flex items-center justify-center h-full">
                <Loader2 className="h-8 w-8 animate-spin text-primary" />
            </div>
        );
    }

    if (error) {
        return (
            <div className="flex flex-col items-center justify-center h-full p-8 text-center">
                <h2 className="text-2xl font-bold text-destructive mb-2">Error</h2>
                <p className="text-muted-foreground">No se pudieron cargar los cursos.</p>
            </div>
        );
    }

    return (
        <div className="flex flex-col h-full space-y-6">
            {/* Header */}
            <div className="flex items-center justify-between border-b pb-6">
                <div>
                    <h1 className="text-2xl font-bold tracking-tight">Capacitación</h1>
                    <p className="text-muted-foreground mt-1">
                        Explora y gestiona tu formación profesional
                    </p>
                </div>
            </div>

            <Tabs value={activeTab} onValueChange={(v) => setActiveTab(v as any)} className="flex-1 flex flex-col">
                <TabsList className="w-full flex flex-col md:grid md:grid-cols-2 h-auto p-1 bg-muted/50 gap-1">
                    <TabsTrigger
                        value="my-courses"
                        className="data-[state=active]:bg-primary data-[state=active]:text-primary-foreground py-3 transition-all duration-300 w-full"
                    >
                        <BookOpen className="mr-1 size-4" />
                        <p className="truncate">
                            Mis Cursos
                        </p>
                    </TabsTrigger>
                    <TabsTrigger
                        value="available"
                        className="data-[state=active]:bg-primary data-[state=active]:text-primary-foreground py-3 transition-all duration-300 w-full"
                    >
                        <Grid3x3 className="mr-1 size-4" />
                        <p className="truncate">
                            Cursos Disponibles
                        </p>
                    </TabsTrigger>
                </TabsList>

                <div className="flex-1 mt-6">
                    {/* My Courses Tab */}
                    <TabsContent value="my-courses" className="m-0 space-y-4">
                        <div className="relative">
                            <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
                            <Input
                                placeholder="Buscar en mis cursos..."
                                className="pl-9"
                                value={myCoursesSearch}
                                onChange={(e) => setMyCoursesSearch(e.target.value)}
                            />
                        </div>

                        {myCourses.length === 0 ? (
                            <div className="flex flex-col items-center justify-center p-12 text-center">
                                <BookOpen className="h-16 w-16 text-muted-foreground mb-4" />
                                <h3 className="text-lg font-semibold mb-2">
                                    {myCoursesSearch ? "No se encontraron cursos" : "No tienes cursos inscritos"}
                                </h3>
                                <p className="text-muted-foreground">
                                    {myCoursesSearch ? "Intenta con otros términos de búsqueda" : "Explora los cursos disponibles y solicita tu inscripción"}
                                </p>
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {myCourses.map((course) => (
                                    <CourseCard
                                        key={course.id}
                                        course={course}
                                        enrollmentStatus={course.user_enrollment_status}
                                        isInstructor={user?.person?.id === course.instructor_id}
                                        href={`/training/${course.id}`}
                                    />
                                ))}
                            </div>
                        )}
                    </TabsContent>

                    {/* Available Courses Tab */}
                    <TabsContent value="available" className="m-0 space-y-4">
                        <div className="relative">
                            <Search className="absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground" />
                            <Input
                                placeholder="Buscar cursos disponibles..."
                                className="pl-9"
                                value={availableCoursesSearch}
                                onChange={(e) => setAvailableCoursesSearch(e.target.value)}
                            />
                        </div>

                        {availableCourses.length === 0 ? (
                            <div className="flex flex-col items-center justify-center p-12 text-center">
                                <Grid3x3 className="h-16 w-16 text-muted-foreground mb-4" />
                                <h3 className="text-lg font-semibold mb-2">
                                    {availableCoursesSearch ? "No se encontraron cursos" : "No hay cursos disponibles"}
                                </h3>
                                <p className="text-muted-foreground">
                                    {availableCoursesSearch ? "Intenta con otros términos de búsqueda" : "Todos los cursos activos ya están en tu lista"}
                                </p>
                            </div>
                        ) : (
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {availableCourses.map((course) => (
                                    <CourseCard
                                        key={course.id}
                                        course={course}
                                        href={`/training/${course.id}`}
                                        showEnrollButton={true}
                                        onEnrollmentSuccess={() => {
                                            mutate("/api/training/courses/");
                                            if (user?.person) {
                                                mutate(`/api/training/participants/?person=${user.person.id}`);
                                            }
                                        }}
                                    />
                                ))}
                            </div>
                        )}
                    </TabsContent>
                </div>
            </Tabs>
        </div>
    );
}
</file>

<file path="frontend2/components/departments/organization-org-chart.tsx">
"use client";

import { useMemo, useState, useEffect } from "react";
import ReactFlow, {
    Background,
    Controls,
    Edge,
    Node,
    Position as FlowPosition,
    useNodesState,
    useEdgesState,
    Handle,
    Panel,
    useReactFlow,
    ReactFlowProvider,
} from "reactflow";
import "reactflow/dist/style.css";
import dagre from "dagre";
import { Building2, ChevronDown, Download, FileImage, FileText, User } from "lucide-react";
import { Button } from "@/components/ui/button";
import {
    DropdownMenu,
    DropdownMenuContent,
    DropdownMenuItem,
    DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { Label } from "@/components/ui/label";
import { Switch } from "@/components/ui/switch";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";

// --- TYPES ---
interface ManagerInfo {
    id: number;
    name: string;
    photo: string | null;
}

export interface DepartmentNodeData {
    id: number;
    name: string;
    parent_name?: string;
    parent?: { id: number; name: string } | null;
    manager_position?: string | null;
    manager_info?: ManagerInfo | null;
    isRoot?: boolean;
    showManagerPosition?: boolean;
    showManager?: boolean;
}

interface OrgChartProps {
    departments: DepartmentNodeData[];
}

// --- CUSTOM NODE ---
const DepartmentNode = ({ data }: { data: DepartmentNodeData }) => {
    const showManagerPosition = data.showManagerPosition || false;
    const showManager = data.showManager || false;

    return (
        <div className="w-[270px] relative">
            <Handle
                type="target"
                position={FlowPosition.Top}
                className="bg-transparent! w-px! h-px! min-w-0! min-h-0! border-0! top-0! -translate-y-1/2!"
            />

            <div className="flex flex-col rounded-lg overflow-hidden bg-white shadow-sm border border-slate-400 hover:border-slate-500 transition-all duration-200">
                {/* Header: Department Name */}
                <div className={`flex items-center justify-center px-2 h-[42px] text-center bg-slate-50 ${showManagerPosition ? 'border-b border-slate-300' : ''}`}>
                    <span className="text-[13px] leading-tight line-clamp-2 font-semibold text-slate-800" title={data.name}>
                        {data.name}
                    </span>
                </div>

                {/* Body: Manager Position and/or Manager Info */}
                {showManagerPosition && (
                    <>
                        {/* Manager Position Title */}
                        <div className={`h-[58px] flex items-center justify-center px-3 bg-white ${showManager && data.manager_info ? 'border-b border-slate-300' : ''}`}>
                            {data.manager_position ? (
                                <span className="text-[12px] text-slate-700 font-medium text-center line-clamp-2" title={data.manager_position}>
                                    {data.manager_position}
                                </span>
                            ) : (
                                <span className="text-[12px] text-slate-400 italic">Sin gerente asignado</span>
                            )}
                        </div>

                        {/* Manager Info (if showManager is true and manager exists) */}
                        {showManager && data.manager_info && (
                            <div className="h-[58px] flex items-center pl-[16px] pr-3 bg-white">
                                {/* Avatar */}
                                <div className="shrink-0 mr-[12px]">
                                    <Avatar className="h-[36px] w-[36px] border border-slate-300">
                                        <AvatarImage src={data.manager_info.photo || undefined} alt={data.manager_info.name} className="object-cover" />
                                        <AvatarFallback className="text-[10px] font-medium bg-slate-100 text-slate-600">
                                            {data.manager_info.name?.charAt(0).toUpperCase()}
                                        </AvatarFallback>
                                    </Avatar>
                                </div>
                                {/* Name */}
                                <div className="flex-1 min-w-0 flex flex-col justify-center">
                                    <span className="text-[12px] truncate font-medium leading-tight text-slate-700" title={data.manager_info.name}>
                                        {data.manager_info.name}
                                    </span>
                                </div>
                            </div>
                        )}

                        {/* Empty state if showManager is true but no manager */}
                        {showManager && !data.manager_info && data.manager_position && (
                            <div className="h-[58px] flex items-center justify-center px-3 bg-white">
                                <User className="h-4 w-4 text-slate-400 mr-2" />
                                <span className="text-[12px] text-slate-400 italic">Vacante</span>
                            </div>
                        )}
                    </>
                )}
            </div>

            <Handle
                type="source"
                position={FlowPosition.Bottom}
                className="bg-transparent! w-px! h-px! min-w-0! min-h-0! border-0! bottom-0! translate-y-1/2!"
            />
        </div>
    );
};

const nodeTypes = {
    department: DepartmentNode,
};

// --- LAYOUT HELPER ---
const getLayoutedElements = (nodes: Node[], edges: Edge[]) => {
    const dagreGraph = new dagre.graphlib.Graph();
    dagreGraph.setDefaultEdgeLabel(() => ({}));
    dagreGraph.setGraph({ rankdir: "TB", ranksep: 80, nodesep: 50 });

    const nodeWidth = 270;

    nodes.forEach((node) => {
        // Calculate dynamic height
        const data = node.data as DepartmentNodeData;
        let nodeHeight = 42; // Header

        if (data.showManagerPosition) {
            nodeHeight += 58; // Manager position row

            if (data.showManager) {
                if (data.manager_info || data.manager_position) {
                    nodeHeight += 58; // Manager info or vacancy row
                }
            }
        }

        node.height = nodeHeight;
        dagreGraph.setNode(node.id, { width: nodeWidth, height: nodeHeight });
    });

    edges.forEach((edge) => {
        dagreGraph.setEdge(edge.source, edge.target);
    });

    dagre.layout(dagreGraph);

    nodes.forEach((node) => {
        const nodeWithPosition = dagreGraph.node(node.id);
        const nodeHeight = node.height || 42;
        node.position = {
            x: nodeWithPosition.x - nodeWidth / 2,
            y: nodeWithPosition.y - nodeHeight / 2,
        };
    });

    return { nodes, edges };
};

// --- MAIN COMPONENT ---
export function OrganizationOrgChart({ departments }: OrgChartProps) {
    return (
        <div className="h-[600px] w-full border rounded-md bg-white overflow-hidden relative group">
            <ReactFlowProvider>
                <OrgChartContent departments={departments} />
            </ReactFlowProvider>
        </div>
    );
}

function OrgChartContent({ departments }: OrgChartProps) {
    const { fitView } = useReactFlow();
    const [showManagerPosition, setShowManagerPosition] = useState(false);
    const [showManager, setShowManager] = useState(false);

    // Initial Data Calculation
    const { initialNodes, initialEdges } = useMemo(() => {
        const nodes: Node[] = [];
        const edges: Edge[] = [];

        // Build map for quick access
        const deptMap = new Map(departments.map(d => [d.id, d]));

        departments.forEach((dept) => {
            const nodeId = `dept-${dept.id}`;
            const isRoot = !dept.parent;

            nodes.push({
                id: nodeId,
                type: "department",
                data: { ...dept, isRoot, showManagerPosition, showManager },
                position: { x: 0, y: 0 },
            });

            if (dept.parent) {
                const parentId = `dept-${dept.parent.id}`;
                // Only add edge if parent exists in the list
                if (deptMap.has(dept.parent.id)) {
                    edges.push({
                        id: `e-${parentId}-${nodeId}`,
                        source: parentId,
                        target: nodeId,
                        type: 'smoothstep',
                        style: { stroke: '#94a3b8', strokeWidth: 1.5 },
                    });
                }
            }
        });

        return { initialNodes: nodes, initialEdges: edges };
    }, [departments, showManagerPosition, showManager]);

    const [nodes, setNodes, onNodesChange] = useNodesState([]);
    const [edges, setEdges, onEdgesChange] = useEdgesState([]);

    useEffect(() => {
        // Update toggle states in all nodes
        const updatedNodes = initialNodes.map(node => ({
            ...node,
            data: { ...node.data, showManagerPosition, showManager }
        }));

        const { nodes: layoutedNodes, edges: layoutedEdges } = getLayoutedElements(
            updatedNodes,
            initialEdges
        );

        setNodes([...layoutedNodes]);
        setEdges([...layoutedEdges]);

        setTimeout(() => {
            fitView({ padding: 0.2, duration: 800 });
        }, 50);

    }, [initialNodes, initialEdges, showManagerPosition, showManager, setNodes, setEdges, fitView]);

    return (
        <ReactFlow
            nodes={nodes}
            edges={edges}
            onNodesChange={onNodesChange}
            onEdgesChange={onEdgesChange}
            nodeTypes={nodeTypes}
            fitView
            attributionPosition="bottom-right"
            minZoom={0.1}
        >
            <Controls showInteractive={false} />
            <Background color="#ffffff" gap={20} />
            <Panel position="top-right" className="flex items-center gap-2">
                {/* Toggle 1: Show Manager Position */}
                <div className="bg-white/90 backdrop-blur shadow-sm border rounded-md px-3 py-1.5 flex items-center gap-2">
                    <Label htmlFor="toggle-manager-position" className="text-xs font-medium text-slate-600 cursor-pointer">
                        Mostrar Posición Jefe
                    </Label>
                    <Switch
                        id="toggle-manager-position"
                        checked={showManagerPosition}
                        onCheckedChange={setShowManagerPosition}
                        className="scale-75"
                    />
                </div>

                {/* Toggle 2: Show Manager (only visible when position is shown) */}
                {showManagerPosition && (
                    <div className="bg-white/90 backdrop-blur shadow-sm border rounded-md px-3 py-1.5 flex items-center gap-2">
                        <Label htmlFor="toggle-manager" className="text-xs font-medium text-slate-600 cursor-pointer">
                            Mostrar Gerente
                        </Label>
                        <Switch
                            id="toggle-manager"
                            checked={showManager}
                            onCheckedChange={setShowManager}
                            className="scale-75"
                        />
                    </div>
                )}

                <DownloadButton showManagerPosition={showManagerPosition} showManager={showManager} />
            </Panel>
        </ReactFlow>
    );
}

// --- HELPER: GENERATE CLEAN SVG FROM REACT FLOW DATA ---
const generateInstitutionalOrgChartSVG = async (nodes: Node[], edges: Edge[], showManagerPosition: boolean, showManager: boolean) => {
    if (nodes.length === 0) return '';

    // 1. Calculate bounding box
    let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
    nodes.forEach(node => {
        if (node.position.x < minX) minX = node.position.x;
        if (node.position.y < minY) minY = node.position.y;
        if (node.position.x + (node.width || 270) > maxX) maxX = node.position.x + (node.width || 270);
        if (node.position.y + (node.height || 42) > maxY) maxY = node.position.y + (node.height || 42);
    });

    if (!isFinite(minX) || !isFinite(maxX) || !isFinite(minY) || !isFinite(maxY)) {
        return '';
    }

    // Add padding
    const padding = 50;
    minX -= padding; minY -= padding;
    maxX += padding; maxY += padding;
    const viewWidth = maxX - minX;
    const viewHeight = maxY - minY;

    // 2. Helper to escape XML special chars
    const esc = (s: string) => s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');

    // 3. Build SVG
    let svgContent = `<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="${minX} ${minY} ${viewWidth} ${viewHeight}" width="${viewWidth}" height="${viewHeight}">
    <style>
        .font-sans { font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .text-dept { font-size: 13px; font-weight: 600; fill: #1e293b; dominant-baseline: middle; text-anchor: middle; }
        .text-position { font-size: 12px; font-weight: 500; fill: #334155; dominant-baseline: middle; text-anchor: middle; }
        .text-name { font-size: 12px; font-weight: 500; fill: #334155; dominant-baseline: middle; text-anchor: start; }
        .text-vacancy { font-size: 12px; fill: #94a3b8; font-style: italic; dominant-baseline: middle; text-anchor: middle; }
        .card-border { fill: #ffffff; stroke: #94a3b8; stroke-width: 1.5px; }
        .card-header { fill: #f8fafc; }
        .edge-path { stroke: #94a3b8; stroke-width: 1.5px; fill: none; }
    </style>
    <rect x="${minX}" y="${minY}" width="${viewWidth}" height="${viewHeight}" fill="#ffffff" />
    <g>`;

    // Draw Edges
    edges.forEach(edge => {
        const sourceNode = nodes.find(n => n.id === edge.source);
        const targetNode = nodes.find(n => n.id === edge.target);
        if (!sourceNode || !targetNode) return;

        const srcHeight = sourceNode.height || 42;
        const sx = sourceNode.position.x + (sourceNode.width || 270) / 2;
        const sy = sourceNode.position.y + srcHeight;
        const tx = targetNode.position.x + (targetNode.width || 270) / 2;
        const ty = targetNode.position.y;

        const midY = sy + (ty - sy) / 2;
        const pathData = `M ${sx} ${sy} L ${sx} ${midY} L ${tx} ${midY} L ${tx} ${ty}`;
        svgContent += `<path d="${pathData}" class="edge-path" />`;
    });

    // Draw Nodes
    for (const node of nodes) {
        const data = node.data as DepartmentNodeData;
        const x = node.position.x;
        const y = node.position.y;
        const w = node.width || 270;
        const h = node.height || 42;
        const rx = 8;
        const headerHeight = 42;

        // Border on top
        svgContent += `<rect x="${x}" y="${y}" width="${w}" height="${h}" rx="${rx}" ry="${rx}" fill="none" class="card-border" stroke="#94a3b8" stroke-width="1.5" />`;

        // Horizontal Separator 1 (Between Header and Next Row) - Only if there is content below
        if (showManagerPosition) {
            svgContent += `<line x1="${x}" y1="${y + headerHeight}" x2="${x + w}" y2="${y + headerHeight}" stroke="#cbd5e1" stroke-width="1" />`;
        }

        // Department Name - Text Wrapping Logic mimicking line-clamp-2
        const distinctWords = data.name.split(' ');
        let lines: string[] = [];
        let currentLine = distinctWords[0];

        // Approx character limit per line for 270px width (approx 240px usable) and 13px font
        // ~35-40 chars is a safe bet for sans-serif 13px
        const maxCharsPerLine = 35;

        for (let i = 1; i < distinctWords.length; i++) {
            if ((currentLine + " " + distinctWords[i]).length < maxCharsPerLine) {
                currentLine += " " + distinctWords[i];
            } else {
                lines.push(currentLine);
                currentLine = distinctWords[i];
            }
        }
        lines.push(currentLine);

        // Limit to 2 lines
        if (lines.length > 2) {
            lines = lines.slice(0, 2);
            lines[1] += '...'; // Add ellipsis if cut off
        }

        const lineHeight = 16;
        const totalTextHeight = lines.length * lineHeight;
        // Start Y to center the block vertically in the 42px header
        let startY = y + (headerHeight - totalTextHeight) / 2 + (lineHeight / 2) + 2; // +2 visual adjustment

        lines.forEach((line, index) => {
            svgContent += `<text x="${x + w / 2}" y="${startY + index * lineHeight}" class="text-dept font-sans">${esc(line)}</text>`;
        });

        // Manager Position (if shown)
        if (showManagerPosition && data.manager_position) {
            const posY = y + headerHeight + 29; // Center of 58px row
            svgContent += `<text x="${x + w / 2}" y="${posY}" class="text-position font-sans">${esc(data.manager_position)}</text>`;

            const secondRowY = y + headerHeight + 58;

            // Manager Info (if shown)
            if (showManager && data.manager_info) {
                // Horizontal Separator 2 (Between Position and Info)
                svgContent += `<line x1="${x}" y1="${secondRowY}" x2="${x + w}" y2="${secondRowY}" stroke="#cbd5e1" stroke-width="1" />`;

                const managerY = secondRowY + 29; // Center of second 58px row

                // Avatar (Circle + Initials)
                const avatarRadius = 18;
                const avatarX = x + 34; // Left margin + center of avatar area
                const avatarCenterY = managerY;

                // Avatar Circle
                svgContent += `<circle cx="${avatarX}" cy="${avatarCenterY}" r="${avatarRadius}" fill="#f1f5f9" stroke="#e2e8f0" stroke-width="1" />`;

                // Avatar Initials
                const initials = data.manager_info.name ? data.manager_info.name.charAt(0).toUpperCase() : '?';
                svgContent += `<text x="${avatarX}" y="${avatarCenterY}" font-size="14" font-weight="600" fill="#475569" dominant-baseline="middle" text-anchor="middle" font-family="ui-sans-serif, system-ui">${initials}</text>`;

                // Name text (adjusted x position)
                svgContent += `<text x="${x + 64}" y="${managerY}" class="text-name font-sans">${esc(data.manager_info.name)}</text>`;

            } else if (showManager && !data.manager_info && data.manager_position) {
                // Horizontal Separator 2
                svgContent += `<line x1="${x}" y1="${secondRowY}" x2="${x + w}" y2="${secondRowY}" stroke="#cbd5e1" stroke-width="1" />`;

                // Vacancy Avatar placeholder
                const managerY = secondRowY + 29;
                const avatarRadius = 18;
                const avatarX = x + 34;

                svgContent += `<circle cx="${avatarX}" cy="${managerY}" r="${avatarRadius}" fill="#f1f5f9" stroke="#e2e8f0" stroke-width="1" />`;
                // Simple User Icon Path mimic
                svgContent += `<path d="M${avatarX} ${managerY - 2} a4 4 0 1 0 0 -8 a4 4 0 1 0 0 8 z M${avatarX - 6} ${managerY + 8} v-1 a5 5 0 0 1 10 0 v1" fill="none" stroke="#94a3b8" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />`;

                const vacancyY = secondRowY + 29;
                svgContent += `<text x="${x + 64}" y="${vacancyY}" class="text-vacancy font-sans" style="text-anchor: start;">Vacante</text>`;
            }
        }
    }

    svgContent += `</g></svg>`;
    return svgContent;
};

// --- DOWNLOAD BUTTON COMPONENT ---
function DownloadButton({ showManagerPosition, showManager }: { showManagerPosition: boolean, showManager: boolean }) {
    const { fitView, getNodes, getEdges } = useReactFlow();

    const downloadImage = async (format: 'png' | 'svg' | 'pdf') => {
        if (format === 'png') {
            // PNG: High-quality screenshot
            fitView({ padding: 0.2, duration: 0 });
            await new Promise(resolve => setTimeout(resolve, 100));

            const { toPng } = await import('html-to-image');
            const container = document.querySelector('.react-flow') as HTMLElement;
            if (!container) return;

            const dataUrl = await toPng(container, {
                backgroundColor: '#ffffff',
                fontEmbedCSS: '',
                pixelRatio: 4,
                filter: (node) => {
                    const element = node as HTMLElement;
                    if (element.classList) {
                        return !['react-flow__controls', 'react-flow__panel', 'react-flow__attribution'].some(c => element.classList.contains(c));
                    }
                    return true;
                }
            });

            const a = document.createElement('a');
            a.setAttribute('download', 'organigrama-institucional.png');
            a.setAttribute('href', dataUrl);
            a.click();
        } else {
            // SVG/PDF: Generate clean SVG and send to backend
            try {
                const nodes = getNodes();
                const edges = getEdges();
                const svgContent = await generateInstitutionalOrgChartSVG(nodes, edges, showManagerPosition, showManager);
                if (!svgContent) {
                    alert("El gráfico está vacío o cargando.");
                    return;
                }

                const apiClient = (await import('@/lib/api-client')).default;
                const response = await apiClient.post(
                    `/api/organization/departments/export-institutional-chart/`,
                    { format, svg_content: svgContent },
                    { responseType: 'blob' }
                );

                const blob = response.data as Blob;
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `organigrama-institucional.${format}`;
                a.click();
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Export error:', error);
                alert('Error al exportar el organigrama');
            }
        }
    };

    return (
        <DropdownMenu>
            <DropdownMenuTrigger asChild>
                <Button variant="outline" size="sm" className="bg-background/80 backdrop-blur-sm shadow-sm">
                    <Download className="mr-2 size-4" />
                    Descargar
                    <ChevronDown className="ml-2 size-3 opacity-50" />
                </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="end">
                <DropdownMenuItem onClick={() => downloadImage('png')}>
                    <FileImage className="mr-2 size-4" />
                    Imagen (PNG)
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => downloadImage('svg')}>
                    <FileImage className="mr-2 size-4" />
                    Vector (SVG)
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => downloadImage('pdf')}>
                    <FileText className="mr-2 size-4" />
                    Documento (PDF)
                </DropdownMenuItem>
            </DropdownMenuContent>
        </DropdownMenu>
    );
}
</file>

<file path="backend/accounts/admin.py">
from django.contrib import admin
from django.contrib.auth.admin import UserAdmin
from .models import User

class CustomUserAdmin(UserAdmin):
    model = User
    list_display = (
        'username',
        'person',
        'is_staff',
        'is_active'
        )
    search_fields = (
        'username', 
        'person__first_name', 
        'person__paternal_surname'
        )
    list_filter = (
        'is_staff',
        'is_active',
        'is_superuser'
        )
    fieldsets = (
        (
            None, 
            {
                'fields': (
                'username',
                'password'
                )
            }
        ),
        (
            'Personal info', 
            {
                'fields': (
                'person',
                )
            }
        ),
        (
            'Permissions', 
            {
                'fields': (
                    'is_active',
                    'is_staff', 
                    'is_superuser', 
                    'groups', 
                    'user_permissions'
                )
            }
            ),
        (
            'Important dates', 
            {
                'fields': (
                    'last_login', 
                    'created_at'
                )
            }
        ),
    )
    readonly_fields = (
        'last_login', 
        'created_at', 
        'updated_at'
        )

admin.site.register(User, CustomUserAdmin)
</file>

<file path="backend/accounts/apps.py">
from django.apps import AppConfig


class AccountsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'accounts'
</file>

<file path="backend/accounts/models.py">
from django.db import models
from django.contrib.auth.models import (
    AbstractBaseUser, BaseUserManager, PermissionsMixin
)
from core.models import Person

class UserManager(BaseUserManager):
    def create_user(self, username, password=None, **extra_fields):
        if not username:
            raise ValueError('El campo Username es obligatorio')
        
        # Normalización básica
        username = username.strip().lower()
        user = self.model(username=username, **extra_fields)
        user.set_password(password)
        user.save(using=self._db)
        return user

    def create_superuser(self, username, password=None, **extra_fields):
        extra_fields.setdefault('is_staff', True)
        extra_fields.setdefault('is_superuser', True)
        extra_fields.setdefault('is_active', True)

        if extra_fields.get('is_staff') is not True:
            raise ValueError('Superuser must have is_staff=True.')
        if extra_fields.get('is_superuser') is not True:
            raise ValueError('Superuser must have is_superuser=True.')
        extra_fields.setdefault('person', None) 
        
        return self.create_user(username, password, **extra_fields)

class User(AbstractBaseUser, PermissionsMixin):
    person = models.OneToOneField(
        Person, 
        on_delete=models.SET_NULL, 
        null=True, 
        blank=True,
        related_name='user_account' # Permite acceder desde Person: person.user_account
    )
    username = models.CharField(
        max_length=100, 
        unique=True,
        error_messages={
            'unique': "Este nombre de usuario ya está registrado.",
            'blank': "El nombre de usuario es obligatorio."
        }
    )
    is_active = models.BooleanField(default=True)
    is_staff = models.BooleanField(default=False)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    objects = UserManager()
    
    USERNAME_FIELD = 'username'
    REQUIRED_FIELDS = []

    def __str__(self):
        return self.username
</file>

<file path="backend/accounts/tests.py">
from django.test import TestCase

# Create your tests here.
</file>

<file path="backend/accounts/urls.py">
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .views import UserViewSet

router = DefaultRouter()
router.register(r'users', UserViewSet, basename='user')

urlpatterns = [
    path('', include(router.urls)),
]
</file>

<file path="backend/ats/migrations/0001_initial.py">
# Generated by Django 5.2.8 on 2025-11-26 23:39

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('organization', '0001_initial'),
    ]

    operations = [
        migrations.CreateModel(
            name='Candidate',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('first_name', models.CharField(max_length=100, verbose_name='Nombre')),
                ('last_name', models.CharField(max_length=100, verbose_name='Apellido')),
                ('email', models.EmailField(max_length=254, verbose_name='Correo Electrónico')),
                ('phone', models.CharField(max_length=20, verbose_name='Teléfono')),
                ('national_id', models.CharField(help_text='Documento de identidad', max_length=20, verbose_name='Cédula/ID Nacional')),
                ('cv_file', models.FileField(help_text='Archivo PDF del currículum', upload_to='candidates/cv/', verbose_name='Currículum (PDF)')),
                ('education_details', models.TextField(blank=True, help_text='Información educativa (JSON o texto)', null=True, verbose_name='Detalles de Educación')),
                ('experience_details', models.TextField(blank=True, help_text='Historial laboral (JSON o texto)', null=True, verbose_name='Detalles de Experiencia')),
                ('portfolio_url', models.URLField(blank=True, help_text='Enlace a portafolio o LinkedIn', null=True, verbose_name='URL de Portafolio')),
                ('stage', models.CharField(choices=[('NEW', 'Nuevo'), ('REV', 'En Revisión'), ('INT', 'Entrevista/Pruebas'), ('OFF', 'Oferta Enviada'), ('HIRED', 'Contratado'), ('REJ', 'Rechazado'), ('POOL', 'Banco de Elegibles')], default='NEW', max_length=5, verbose_name='Etapa')),
                ('notes', models.TextField(blank=True, help_text='Comentarios del reclutador sobre el candidato', null=True, verbose_name='Notas Internas')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
            ],
            options={
                'verbose_name': 'Candidato',
                'verbose_name_plural': 'Candidatos',
                'ordering': ['-created_at'],
            },
        ),
        migrations.CreateModel(
            name='CandidateEducation',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('school_name', models.CharField(max_length=255, verbose_name='Institución')),
                ('level_name', models.CharField(help_text='Ej: Ingeniería, Licenciatura, Maestría', max_length=100, verbose_name='Nivel Educativo')),
                ('field_name', models.CharField(help_text='Ej: Informática, Administración', max_length=100, verbose_name='Área de Estudio')),
                ('start_date', models.DateField(verbose_name='Fecha de Inicio')),
                ('end_date', models.DateField(blank=True, help_text='Dejar vacío si está en curso', null=True, verbose_name='Fecha de Finalización')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('candidate', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='education', to='ats.candidate', verbose_name='Candidato')),
            ],
            options={
                'verbose_name': 'Educación de Candidato',
                'verbose_name_plural': 'Educación de Candidatos',
                'ordering': ['-start_date'],
            },
        ),
        migrations.CreateModel(
            name='CandidateExperience',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('company_name', models.CharField(max_length=255, verbose_name='Empresa')),
                ('position_title', models.CharField(max_length=200, verbose_name='Cargo')),
                ('start_date', models.DateField(verbose_name='Fecha de Inicio')),
                ('end_date', models.DateField(blank=True, help_text='Dejar vacío si es actual', null=True, verbose_name='Fecha de Finalización')),
                ('description', models.TextField(blank=True, help_text='Responsabilidades y logros', null=True, verbose_name='Descripción')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('candidate', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='experience', to='ats.candidate', verbose_name='Candidato')),
            ],
            options={
                'verbose_name': 'Experiencia de Candidato',
                'verbose_name_plural': 'Experiencias de Candidatos',
                'ordering': ['-start_date'],
            },
        ),
        migrations.CreateModel(
            name='JobPosting',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('title', models.CharField(help_text='Ej: Desarrollador Frontend Senior', max_length=200, verbose_name='Título de la Vacante')),
                ('description', models.TextField(help_text='Descripción completa de la vacante', verbose_name='Descripción')),
                ('salary_range', models.CharField(blank=True, help_text='Ej: $800 - $1200 USD', max_length=100, null=True, verbose_name='Rango Salarial')),
                ('location', models.CharField(blank=True, help_text='Ej: Caracas, Venezuela / Remoto', max_length=200, null=True, verbose_name='Ubicación')),
                ('ask_education', models.BooleanField(default=False, help_text='¿El formulario debe pedir información educativa?', verbose_name='Solicitar Educación')),
                ('ask_experience', models.BooleanField(default=False, help_text='¿El formulario debe pedir experiencia laboral?', verbose_name='Solicitar Experiencia')),
                ('ask_portfolio', models.BooleanField(default=False, help_text='¿El formulario debe pedir URL de portafolio?', verbose_name='Solicitar Portafolio')),
                ('status', models.CharField(choices=[('DRAFT', 'Borrador'), ('PUBLISHED', 'Publicada'), ('CLOSED', 'Cerrada'), ('FROZEN', 'Congelada')], default='DRAFT', max_length=10, verbose_name='Estado')),
                ('published_date', models.DateField(blank=True, null=True, verbose_name='Fecha de Publicación')),
                ('closing_date', models.DateField(blank=True, null=True, verbose_name='Fecha de Cierre')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('department', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='organization.department', verbose_name='Departamento')),
                ('position', models.ForeignKey(help_text='Posición organizacional a la que corresponde', null=True, on_delete=django.db.models.deletion.SET_NULL, to='organization.position', verbose_name='Posición')),
            ],
            options={
                'verbose_name': 'Vacante',
                'verbose_name_plural': 'Vacantes',
                'ordering': ['-created_at'],
            },
        ),
        migrations.AddField(
            model_name='candidate',
            name='job_posting',
            field=models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='candidates', to='ats.jobposting', verbose_name='Vacante'),
        ),
        migrations.AlterUniqueTogether(
            name='candidate',
            unique_together={('job_posting', 'email')},
        ),
    ]
</file>

<file path="backend/ats/migrations/0002_remove_jobposting_department_and_more.py">
# Generated by Django 5.2.8 on 2025-11-27 03:05

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ('ats', '0001_initial'),
    ]

    operations = [
        migrations.RemoveField(
            model_name='jobposting',
            name='department',
        ),
        migrations.RemoveField(
            model_name='jobposting',
            name='salary_range',
        ),
    ]
</file>

<file path="backend/ats/migrations/0003_add_phone_area_code_fields.py">
# Generated by Django 5.2.8 on 2025-11-27 14:09

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('ats', '0002_remove_jobposting_department_and_more'),
        ('core', '0002_alter_personbankaccount_account_number'),
    ]

    operations = [
        migrations.AddField(
            model_name='candidate',
            name='phone_area_code',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.phoneareacode', verbose_name='Código de Área'),
        ),
        migrations.AddField(
            model_name='candidate',
            name='phone_subscriber',
            field=models.CharField(blank=True, max_length=10, null=True, verbose_name='Número de Suscriptor'),
        ),
        migrations.AlterField(
            model_name='candidate',
            name='phone',
            field=models.CharField(blank=True, max_length=20, null=True, verbose_name='Teléfono (Completo)'),
        ),
    ]
</file>

<file path="backend/ats/migrations/0004_remove_candidate_experience_details_and_more.py">
# Generated by Django 5.2.8 on 2025-11-27 15:16

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ('ats', '0003_add_phone_area_code_fields'),
    ]

    operations = [
        migrations.RemoveField(
            model_name='candidate',
            name='experience_details',
        ),
        migrations.RemoveField(
            model_name='candidate',
            name='portfolio_url',
        ),
        migrations.RemoveField(
            model_name='jobposting',
            name='ask_experience',
        ),
        migrations.RemoveField(
            model_name='jobposting',
            name='ask_portfolio',
        ),
        migrations.DeleteModel(
            name='CandidateExperience',
        ),
    ]
</file>

<file path="backend/ats/migrations/0005_candidate_avatar.py">
# Generated by Django 5.2.8 on 2025-11-27 16:43

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('ats', '0004_remove_candidate_experience_details_and_more'),
    ]

    operations = [
        migrations.AddField(
            model_name='candidate',
            name='avatar',
            field=models.ImageField(blank=True, null=True, upload_to='candidates/avatars/', verbose_name='Foto de Perfil'),
        ),
    ]
</file>

<file path="backend/ats/migrations/0006_candidatelog.py">
# Generated by Django 5.2.8 on 2025-11-27 17:16

import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('ats', '0005_candidate_avatar'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='CandidateLog',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('action', models.CharField(max_length=50, verbose_name='Acción')),
                ('details', models.TextField(blank=True, null=True, verbose_name='Detalles')),
                ('timestamp', models.DateTimeField(auto_now_add=True)),
                ('candidate', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='logs', to='ats.candidate', verbose_name='Candidato')),
                ('user', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL, verbose_name='Usuario')),
            ],
            options={
                'verbose_name': 'Registro de Actividad',
                'verbose_name_plural': 'Registros de Actividad',
                'ordering': ['-timestamp'],
            },
        ),
    ]
</file>

<file path="backend/ats/migrations/0007_historicalcandidate_historicaljobposting.py">
# Generated by Django 5.2.8 on 2025-11-27 20:56

import django.db.models.deletion
import simple_history.models
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('ats', '0006_candidatelog'),
        ('core', '0003_historicalperson'),
        ('organization', '0002_historicaldepartment_historicalposition'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='HistoricalCandidate',
            fields=[
                ('id', models.BigIntegerField(auto_created=True, blank=True, db_index=True, verbose_name='ID')),
                ('first_name', models.CharField(max_length=100, verbose_name='Nombre')),
                ('last_name', models.CharField(max_length=100, verbose_name='Apellido')),
                ('email', models.EmailField(max_length=254, verbose_name='Correo Electrónico')),
                ('phone_subscriber', models.CharField(blank=True, max_length=10, null=True, verbose_name='Número de Suscriptor')),
                ('phone', models.CharField(blank=True, max_length=20, null=True, verbose_name='Teléfono (Completo)')),
                ('national_id', models.CharField(help_text='Documento de identidad', max_length=20, verbose_name='Cédula/ID Nacional')),
                ('avatar', models.TextField(blank=True, max_length=100, null=True, verbose_name='Foto de Perfil')),
                ('cv_file', models.TextField(help_text='Archivo PDF del currículum', max_length=100, verbose_name='Currículum (PDF)')),
                ('education_details', models.TextField(blank=True, help_text='Información educativa (JSON o texto)', null=True, verbose_name='Detalles de Educación')),
                ('stage', models.CharField(choices=[('NEW', 'Nuevo'), ('REV', 'En Revisión'), ('INT', 'Entrevista/Pruebas'), ('OFF', 'Oferta Enviada'), ('HIRED', 'Contratado'), ('REJ', 'Rechazado'), ('POOL', 'Banco de Elegibles')], default='NEW', max_length=5, verbose_name='Etapa')),
                ('notes', models.TextField(blank=True, help_text='Comentarios del reclutador sobre el candidato', null=True, verbose_name='Notas Internas')),
                ('created_at', models.DateTimeField(blank=True, editable=False)),
                ('updated_at', models.DateTimeField(blank=True, editable=False)),
                ('history_id', models.AutoField(primary_key=True, serialize=False)),
                ('history_date', models.DateTimeField(db_index=True)),
                ('history_change_reason', models.CharField(max_length=100, null=True)),
                ('history_type', models.CharField(choices=[('+', 'Created'), ('~', 'Changed'), ('-', 'Deleted')], max_length=1)),
                ('history_user', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('job_posting', models.ForeignKey(blank=True, db_constraint=False, null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='ats.jobposting', verbose_name='Vacante')),
                ('phone_area_code', models.ForeignKey(blank=True, db_constraint=False, null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='core.phoneareacode', verbose_name='Código de Área')),
            ],
            options={
                'verbose_name': 'historical Candidato',
                'verbose_name_plural': 'historical Candidatos',
                'ordering': ('-history_date', '-history_id'),
                'get_latest_by': ('history_date', 'history_id'),
            },
            bases=(simple_history.models.HistoricalChanges, models.Model),
        ),
        migrations.CreateModel(
            name='HistoricalJobPosting',
            fields=[
                ('id', models.BigIntegerField(auto_created=True, blank=True, db_index=True, verbose_name='ID')),
                ('title', models.CharField(help_text='Ej: Desarrollador Frontend Senior', max_length=200, verbose_name='Título de la Vacante')),
                ('description', models.TextField(help_text='Descripción completa de la vacante', verbose_name='Descripción')),
                ('location', models.CharField(blank=True, help_text='Ej: Caracas, Venezuela / Remoto', max_length=200, null=True, verbose_name='Ubicación')),
                ('ask_education', models.BooleanField(default=False, help_text='¿El formulario debe pedir información educativa?', verbose_name='Solicitar Educación')),
                ('status', models.CharField(choices=[('DRAFT', 'Borrador'), ('PUBLISHED', 'Publicada'), ('CLOSED', 'Cerrada'), ('FROZEN', 'Congelada')], default='DRAFT', max_length=10, verbose_name='Estado')),
                ('published_date', models.DateField(blank=True, null=True, verbose_name='Fecha de Publicación')),
                ('closing_date', models.DateField(blank=True, null=True, verbose_name='Fecha de Cierre')),
                ('created_at', models.DateTimeField(blank=True, editable=False)),
                ('updated_at', models.DateTimeField(blank=True, editable=False)),
                ('history_id', models.AutoField(primary_key=True, serialize=False)),
                ('history_date', models.DateTimeField(db_index=True)),
                ('history_change_reason', models.CharField(max_length=100, null=True)),
                ('history_type', models.CharField(choices=[('+', 'Created'), ('~', 'Changed'), ('-', 'Deleted')], max_length=1)),
                ('history_user', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('position', models.ForeignKey(blank=True, db_constraint=False, help_text='Posición organizacional a la que corresponde', null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='organization.position', verbose_name='Posición')),
            ],
            options={
                'verbose_name': 'historical Vacante',
                'verbose_name_plural': 'historical Vacantes',
                'ordering': ('-history_date', '-history_id'),
                'get_latest_by': ('history_date', 'history_id'),
            },
            bases=(simple_history.models.HistoricalChanges, models.Model),
        ),
    ]
</file>

<file path="backend/ats/migrations/0008_alter_candidate_phone_area_code_and_more.py">
# Generated by Django 5.2.8 on 2025-11-29 20:48

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('ats', '0007_historicalcandidate_historicaljobposting'),
        ('core', '0005_phonecarriercode_alter_phoneareacode_unique_together_and_more'),
    ]

    operations = [
        migrations.AlterField(
            model_name='candidate',
            name='phone_area_code',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.phonecarriercode', verbose_name='Código de Área'),
        ),
        migrations.AlterField(
            model_name='historicalcandidate',
            name='phone_area_code',
            field=models.ForeignKey(blank=True, db_constraint=False, null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='core.phonecarriercode', verbose_name='Código de Área'),
        ),
    ]
</file>

<file path="backend/ats/admin.py">
from django.contrib import admin
from .models import JobPosting, Candidate, CandidateEducation


@admin.register(JobPosting)
class JobPostingAdmin(admin.ModelAdmin):
    list_display = ['title', 'position', 'status', 'published_date', 'closing_date', 'created_at']
    list_filter = ['status', 'ask_education']
    search_fields = ['title', 'description']
    date_hierarchy = 'created_at'
    
    fieldsets = (
        ('Información Básica', {
            'fields': ('title', 'description', 'position')
        }),
        ('Detalles de la Oferta', {
            'fields': ('location',)
        }),
        ('Configuración del Formulario', {
            'fields': ('ask_education',),
            'description': 'Define qué campos serán requeridos en el formulario público'
        }),
        ('Estado y Fechas', {
            'fields': ('status', 'published_date', 'closing_date')
        }),
    )


class CandidateEducationInline(admin.TabularInline):
    model = CandidateEducation
    extra = 0





@admin.register(Candidate)
class CandidateAdmin(admin.ModelAdmin):
    list_display = ['full_name', 'email', 'job_posting', 'stage', 'created_at']
    list_filter = ['stage', 'job_posting', 'created_at']
    search_fields = ['first_name', 'last_name', 'email', 'national_id']
    date_hierarchy = 'created_at'
    inlines = [CandidateEducationInline]
    
    fieldsets = (
        ('Vacante', {
            'fields': ('job_posting',)
        }),
        ('Información Personal', {
            'fields': ('first_name', 'last_name', 'email', 'phone', 'national_id')
        }),
        ('Documentación', {
            'fields': ('cv_file',)
        }),
        ('Información Adicional', {
            'fields': ('education_details',),
            'classes': ('collapse',)
        }),
        ('Pipeline', {
            'fields': ('stage', 'notes')
        }),
    )
    
    def full_name(self, obj):
        return f"{obj.first_name} {obj.last_name}"
    full_name.short_description = 'Nombre Completo'
</file>

<file path="backend/ats/apps.py">
from django.apps import AppConfig


class AtsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'ats'

    def ready(self):
        import ats.signals
</file>

<file path="backend/ats/models.py">
from django.db import models
from django.core.exceptions import ValidationError
from django.utils import timezone
from django.conf import settings
from simple_history.models import HistoricalRecords
from organization.models import Position, Department

# Mensajes de error estándar
UNIQUE_ERR_MSG = {'unique': "Ya existe un registro con este nombre."}


class JobPosting(models.Model):
    """Vacante publicable con configuración dinámica de formulario"""
    
    STATUS_CHOICES = [
        ('DRAFT', 'Borrador'),
        ('PUBLISHED', 'Publicada'),
        ('CLOSED', 'Cerrada'),
        ('FROZEN', 'Congelada'),
    ]
    
    # Información básica
    title = models.CharField(
        max_length=200,
        verbose_name="Título de la Vacante",
        help_text="Ej: Desarrollador Frontend Senior"
    )
    description = models.TextField(
        verbose_name="Descripción",
        help_text="Descripción completa de la vacante"
    )
    
    # Relaciones
    position = models.ForeignKey(
        Position,
        on_delete=models.SET_NULL,
        null=True,
        verbose_name="Posición",
        help_text="Posición organizacional a la que corresponde"
    )
    
    # Detalles de la oferta
    location = models.CharField(
        max_length=200,
        blank=True,
        null=True,
        verbose_name="Ubicación",
        help_text="Ej: Caracas, Venezuela / Remoto"
    )
    
    # Configuración dinámica del formulario público
    ask_education = models.BooleanField(
        default=False,
        verbose_name="Solicitar Educación",
        help_text="¿El formulario debe pedir información educativa?"
    )

    
    # Estado y fechas
    status = models.CharField(
        max_length=10,
        choices=STATUS_CHOICES,
        default='DRAFT',
        verbose_name="Estado"
    )
    published_date = models.DateField(
        null=True,
        blank=True,
        verbose_name="Fecha de Publicación"
    )
    closing_date = models.DateField(
        null=True,
        blank=True,
        verbose_name="Fecha de Cierre"
    )
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    # Historial de cambios
    history = HistoricalRecords()
    
    class Meta:
        verbose_name = "Vacante"
        verbose_name_plural = "Vacantes"
        ordering = ['-created_at']
    
    def __str__(self):
        return f"{self.title} ({self.get_status_display()})"
    
    def clean(self):
        """Validaciones personalizadas"""
        if self.status == 'PUBLISHED' and not self.published_date:
            self.published_date = timezone.now().date()
        
        if self.closing_date and self.published_date:
            if self.closing_date < self.published_date:
                raise ValidationError("La fecha de cierre no puede ser anterior a la de publicación")
    
    def save(self, *args, **kwargs):
        self.clean()
        super().save(*args, **kwargs)


class Candidate(models.Model):
    """Candidato temporal (no es empleado aún)"""
    
    STAGE_CHOICES = [
        ('NEW', 'Nuevo'),
        ('REV', 'En Revisión'),
        ('INT', 'Entrevista/Pruebas'),
        ('OFF', 'Oferta Enviada'),
        ('HIRED', 'Contratado'),
        ('REJ', 'Rechazado'),
        ('POOL', 'Banco de Elegibles'),
    ]
    
    # Relación con la vacante
    job_posting = models.ForeignKey(
        JobPosting,
        on_delete=models.CASCADE,
        related_name='candidates',
        verbose_name="Vacante"
    )
    
    # Datos personales básicos
    first_name = models.CharField(
        max_length=100,
        verbose_name="Nombre"
    )
    last_name = models.CharField(
        max_length=100,
        verbose_name="Apellido"
    )
    email = models.EmailField(
        verbose_name="Correo Electrónico"
    )
    
    # Teléfono - Nuevo formato (separado)
    phone_area_code = models.ForeignKey(
        'core.PhoneCarrierCode',
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        verbose_name="Código de Área"
    )
    phone_subscriber = models.CharField(
        max_length=10,
        blank=True,
        null=True,
        verbose_name="Número de Suscriptor"
    )
    
    # Teléfono - Formato antiguo (para retrocompatibilidad)
    phone = models.CharField(
        max_length=20,
        blank=True,
        null=True,
        verbose_name="Teléfono (Completo)"
    )
    
    national_id = models.CharField(
        max_length=20,
        verbose_name="Cédula/ID Nacional",
        help_text="Documento de identidad"
    )
    
    avatar = models.ImageField(
        upload_to='candidates/avatars/',
        null=True,
        blank=True,
        verbose_name="Foto de Perfil"
    )
    
    # CV obligatorio
    cv_file = models.FileField(
        upload_to='candidates/cv/',
        verbose_name="Currículum (PDF)",
        help_text="Archivo PDF del currículum"
    )
    
    # Campos dinámicos opcionales (según configuración de JobPosting)
    education_details = models.TextField(
        blank=True,
        null=True,
        verbose_name="Detalles de Educación",
        help_text="Información educativa (JSON o texto)"
    )
    
    # Pipeline (máquina de estados)
    stage = models.CharField(
        max_length=5,
        choices=STAGE_CHOICES,
        default='NEW',
        verbose_name="Etapa"
    )
    
    # Notas del reclutador
    notes = models.TextField(
        blank=True,
        null=True,
        verbose_name="Notas Internas",
        help_text="Comentarios del reclutador sobre el candidato"
    )
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    # Historial de cambios
    history = HistoricalRecords()
    
    class Meta:
        verbose_name = "Candidato"
        verbose_name_plural = "Candidatos"
        ordering = ['-created_at']
        # Evitar duplicados: misma persona aplicando a la misma vacante
        unique_together = [('job_posting', 'email')]
    
    def __str__(self):
        return f"{self.first_name} {self.last_name} - {self.job_posting.title}"

    def save(self, *args, **kwargs):
        # Auto-populate legacy phone field
        if self.phone_area_code and self.phone_subscriber:
            self.phone = f"{self.phone_area_code.code}-{self.phone_subscriber}"
        super().save(*args, **kwargs)


class CandidateEducation(models.Model):
    """Educación del candidato (se migrará a PersonEducation al contratar)"""
    
    candidate = models.ForeignKey(
        Candidate,
        on_delete=models.CASCADE,
        related_name='education',
        verbose_name="Candidato"
    )
    
    school_name = models.CharField(
        max_length=255,
        verbose_name="Institución"
    )
    level_name = models.CharField(
        max_length=100,
        verbose_name="Nivel Educativo",
        help_text="Ej: Ingeniería, Licenciatura, Maestría"
    )
    field_name = models.CharField(
        max_length=100,
        verbose_name="Área de Estudio",
        help_text="Ej: Informática, Administración"
    )
    start_date = models.DateField(
        verbose_name="Fecha de Inicio"
    )
    end_date = models.DateField(
        null=True,
        blank=True,
        verbose_name="Fecha de Finalización",
        help_text="Dejar vacío si está en curso"
    )
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        verbose_name = "Educación de Candidato"
        verbose_name_plural = "Educación de Candidatos"
        ordering = ['-start_date']
    
    def __str__(self):
        return f"{self.school_name} - {self.level_name}"


class CandidateLog(models.Model):
    """Registro de auditoría para cambios en candidatos"""
    
    candidate = models.ForeignKey(
        Candidate,
        on_delete=models.CASCADE,
        related_name='logs',
        verbose_name="Candidato"
    )
    user = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        verbose_name="Usuario"
    )
    action = models.CharField(
        max_length=50,
        verbose_name="Acción"
    )
    details = models.TextField(
        blank=True,
        null=True,
        verbose_name="Detalles"
    )
    timestamp = models.DateTimeField(auto_now_add=True)
    
    class Meta:
        verbose_name = "Registro de Actividad"
        verbose_name_plural = "Registros de Actividad"
        ordering = ['-timestamp']
    
    def __str__(self):
        return f"{self.candidate} - {self.action} - {self.timestamp}"
</file>

<file path="backend/ats/signals.py">
from django.db.models.signals import post_save
from django.dispatch import receiver
from organization.models import Position
from .models import JobPosting

@receiver(post_save, sender=Position)
def close_job_posting_if_filled(sender, instance, **kwargs):
    """
    Cierra automáticamente las vacantes publicadas si la posición se llena.
    """
    if instance.vacancies <= 0:
        # Buscar vacantes PUBLICADAS asociadas a esta posición
        active_postings = JobPosting.objects.filter(
            position=instance,
            status='PUBLISHED'
        )
        
        if active_postings.exists():
            # Cerrarlas
            active_postings.update(status='CLOSED')
            print(f"INFO: Se cerraron {active_postings.count()} publicaciones para la posición '{instance}' por falta de cupos.")
</file>

<file path="backend/ats/tests.py">
from django.test import TestCase

# Create your tests here.
</file>

<file path="backend/ats/urls.py">
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .views import (
    PublicJobPostingViewSet,
    PublicCandidateApplicationViewSet,
    JobPostingViewSet,
    CandidateViewSet
)
from .views_options import EducationOptionsViewSet, PhoneCarrierCodeOptionsViewSet

# Router para endpoints administrativos (renombrado de admin_router a router)
router = DefaultRouter()
router.register(r'jobs', JobPostingViewSet, basename='admin-jobs')
router.register(r'candidates', CandidateViewSet, basename='admin-candidates')

# Router para endpoints públicos
public_router = DefaultRouter()
public_router.register(r'jobs', PublicJobPostingViewSet, basename='public-jobs')
public_router.register(r'apply', PublicCandidateApplicationViewSet, basename='public-apply')
public_router.register(r'education-options', EducationOptionsViewSet, basename='public-education-options')
public_router.register(r'phone-codes', PhoneCarrierCodeOptionsViewSet, basename='public-phone-codes')

urlpatterns = [
    # Rutas públicas (sin autenticación)
    path('public/', include(public_router.urls)),

    # Rutas administrativas (con autenticación)
    path('', include(router.urls)),
]
</file>

<file path="backend/ats/views_options.py">
from rest_framework import viewsets
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.permissions import AllowAny

class EducationOptionsViewSet(viewsets.ViewSet):
    """
    ViewSet público para opciones de educación utilizadas en el formulario dinámico.
    """
    permission_classes = [AllowAny]
    
    def list(self, request):
        from talent.models import EducationLevel, FieldOfStudy
        
        levels = EducationLevel.objects.all().values('id', 'name')
        fields = FieldOfStudy.objects.all().values('id', 'name')
        
        return Response({
            'levels': list(levels),
            'fields': list(fields)
        })


class PhoneCarrierCodeOptionsViewSet(viewsets.ViewSet):
    """
    Opciones para códigos de operadora
    """
    permission_classes = [AllowAny]
    
    def list(self, request):
        from core.models import PhoneCarrierCode
        
        # Obtener todos los códigos ordenados
        carrier_codes = PhoneCarrierCode.objects.select_related('carrier').all().order_by('code')
        
        # Formatear para el frontend
        codes_list = []
        for code in carrier_codes:
            carrier_name = code.carrier.name if code.carrier else code.type
            codes_list.append({
                'id': code.id,
                'code': code.code,
                'carrier': carrier_name,
                'display': f"{code.code} ({carrier_name})"
            })
        
        return Response(codes_list)
</file>

<file path="backend/ats/views.py">
from rest_framework import viewsets, status
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.permissions import AllowAny, IsAuthenticated
from django.utils import timezone
from django.db.models import Q
from .models import JobPosting, Candidate, CandidateLog
from .serializers import (
    JobPostingListSerializer,
    JobPostingDetailSerializer,
    JobPostingAdminSerializer,
    CandidateCreateSerializer,
    CandidateListSerializer,
    CandidateDetailSerializer,
    CandidateStageUpdateSerializer,
    HireCandidateSerializer,
    CandidateLogSerializer
)
from .services import hire_candidate, move_finalists_to_pool
from .utils import send_status_change_email


# --- ViewSets Públicos (Sin Autenticación) ---

class PublicJobPostingViewSet(viewsets.ReadOnlyModelViewSet):
    """
    ViewSet público para listar vacantes activas.
    Solo muestra vacantes publicadas y no cerradas.
    """
    permission_classes = [AllowAny]
    serializer_class = JobPostingListSerializer
    
    def get_queryset(self):
        """Filtrar solo vacantes publicadas y activas"""
        today = timezone.now().date()
        return JobPosting.objects.filter(
            status='PUBLISHED',
            published_date__lte=today
        ).filter(
            Q(closing_date__gte=today) | Q(closing_date__isnull=True)
        )
    
    def retrieve(self, request, *args, **kwargs):
        """Devolver detalle completo de una vacante"""
        instance = self.get_object()
        serializer = JobPostingDetailSerializer(instance)
        return Response(serializer.data)


class PublicCandidateApplicationViewSet(viewsets.GenericViewSet):
    """
    ViewSet público para postulaciones.
    Solo permite crear (POST) candidatos.
    """
    permission_classes = [AllowAny]
    serializer_class = CandidateCreateSerializer
    
    def create(self, request, *args, **kwargs):
        """Crear una postulación (candidato)"""
        serializer = self.get_serializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        
        # Validar que la vacante esté publicada
        job_posting = serializer.validated_data.get('job_posting')
        if job_posting.status != 'PUBLISHED':
            return Response(
                {'error': 'Esta vacante no está disponible para postulaciones.'},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        candidate = serializer.save()
        
        return Response(
            {
                'message': '¡Postulación enviada exitosamente!',
                'candidate_id': candidate.id
            },
            status=status.HTTP_201_CREATED
        )


# --- ViewSets Administrativos (Con Autenticación) ---

class JobPostingViewSet(viewsets.ModelViewSet):
    """
    ViewSet administrativo para gestionar vacantes.
    CRUD completo de vacantes.
    """
    permission_classes = [IsAuthenticated]
    queryset = JobPosting.objects.all()
    
    def get_serializer_class(self):
        if self.action == 'list':
            return JobPostingListSerializer
        elif self.action == 'retrieve':
            return JobPostingDetailSerializer
        return JobPostingAdminSerializer
    
    @action(detail=True, methods=['post'])
    def publish(self, request, pk=None):
        """Publicar una vacante"""
        job_posting = self.get_object()
        
        # Preparar datos con el nuevo estado
        data = {
            'status': 'PUBLISHED',
            'position': job_posting.position.id if job_posting.position else None,
            'title': job_posting.title,
            'description': job_posting.description,
        }
        
        if not job_posting.published_date:
            data['published_date'] = timezone.now().date()
        
        # Validar usando el serializador (esto ejecutará validate())
        serializer = JobPostingAdminSerializer(job_posting, data=data, partial=True)
        serializer.is_valid(raise_exception=True)
        serializer.save()
        
        return Response(serializer.data)
    
    @action(detail=True, methods=['post'])
    def close(self, request, pk=None):
        """Cerrar una vacante"""
        job_posting = self.get_object()
        job_posting.status = 'CLOSED'
        
        # Si no tiene fecha de cierre, registrar la fecha actual
        if not job_posting.closing_date:
            job_posting.closing_date = timezone.now().date()
        
        job_posting.save()
        
        serializer = self.get_serializer(job_posting)
        return Response(serializer.data)


class CandidateViewSet(viewsets.ModelViewSet):
    """
    ViewSet administrativo para gestionar candidatos.
    Incluye acciones especiales para contratar y cambiar etapa.
    """
    permission_classes = [IsAuthenticated]
    permission_classes = [IsAuthenticated]
    queryset = Candidate.objects.select_related('job_posting').prefetch_related('education')
    
    def log_action(self, candidate, action, details=None):
        """Registrar una acción en el historial"""
        user = self.request.user if self.request and hasattr(self.request, 'user') and self.request.user.is_authenticated else None
        CandidateLog.objects.create(
            candidate=candidate,
            user=user,
            action=action,
            details=details
        )

    def perform_update(self, serializer):
        super().perform_update(serializer)
        self.log_action(serializer.instance, 'UPDATE', "Actualización de datos del candidato")

    def get_serializer_class(self):
        if self.action == 'list':
            return CandidateListSerializer
        return CandidateDetailSerializer
    
    def get_queryset(self):
        """Filtrar por parámetros de query"""
        queryset = super().get_queryset()
        
        # Filtrar por vacante
        job_posting_id = self.request.query_params.get('job_posting')
        if job_posting_id:
            queryset = queryset.filter(job_posting_id=job_posting_id)
        
        # Filtrar por etapa
        stage = self.request.query_params.get('stage')
        if stage:
            queryset = queryset.filter(stage=stage)
        
        return queryset
    
    @action(detail=True, methods=['post'], url_path='change-stage')
    def change_stage(self, request, pk=None):
        """Cambiar la etapa de un candidato"""
        candidate = self.get_object()
        serializer = CandidateStageUpdateSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        
        new_stage = serializer.validated_data['stage']
        notes = serializer.validated_data.get('notes', '')
        
        # Actualizar
        candidate.stage = new_stage
        if notes:
            candidate.notes = (candidate.notes or '') + f"\n[{new_stage}] {notes}"
        candidate.save()
        


        
        # Verificar que el cambio se guardó correctamente
        candidate.refresh_from_db()
        if candidate.stage == new_stage:
            # Enviar notificación por correo
            send_status_change_email(candidate, new_stage)
        
        # Registrar en historial
        self.log_action(candidate, 'STAGE_CHANGE', f"Cambio a etapa {new_stage}. Notas: {notes}")
        
        return Response(
            CandidateDetailSerializer(candidate, context={'request': request}).data
        )
    
    @action(detail=True, methods=['post'])
    def hire(self, request, pk=None):
        """
        Contratar un candidato.
        Ejecuta la transacción completa de contratación.
        """
        candidate = self.get_object()
        
        # Validar que el candidato esté en una etapa válida para contratar
        if candidate.stage not in ['OFF', 'INT']:
            return Response(
                {'error': 'El candidato debe estar en etapa de Oferta o Entrevista para ser contratado.'},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        serializer = HireCandidateSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        
        try:
            result = hire_candidate(candidate, serializer.validated_data)
            
            # Enviar notificación por correo (HIR = Hired)
            # Verificar primero
            candidate.refresh_from_db()
            if candidate.stage == 'HIRED':
                send_status_change_email(candidate, 'HIRED')
            
            # Registrar en historial
            self.log_action(candidate, 'HIRED', "Candidato contratado exitosamente")
            
            response_data = {
                'message': 'Candidato contratado exitosamente',
                'person_id': result['person'].id,
                'employment_id': result['employment'].id,
                'remaining_vacancies': result['remaining_vacancies'],
                'other_finalists': []
            }
            
            # Si hay otros finalistas, incluir información
            if result['other_finalists']:
                response_data['other_finalists'] = [
                    {
                        'id': c.id,
                        'name': f"{c.first_name} {c.last_name}",
                        'stage': c.get_stage_display()
                    }
                    for c in result['other_finalists']
                ]
                response_data['message'] += f". Hay {len(result['other_finalists'])} finalista(s) adicional(es)."
            
            return Response(response_data, status=status.HTTP_200_OK)
            
        except Exception as e:
            return Response(
                {'error': str(e)},
                status=status.HTTP_400_BAD_REQUEST
            )
    
    @action(detail=False, methods=['post'])
    def move_to_pool(self, request):
        """Mover candidatos al banco de elegibles"""
        candidate_ids = request.data.get('candidate_ids', [])
        
        if not candidate_ids:
            return Response(
                {'error': 'Debe proporcionar una lista de candidate_ids'},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        updated_count = move_finalists_to_pool(candidate_ids)
        
        return Response({
            'message': f'{updated_count} candidato(s) movido(s) al Banco de Elegibles',
            'updated_count': updated_count
        })

    @action(detail=True, methods=['get'])
    def logs(self, request, pk=None):
        """Obtener historial de cambios del candidato"""
        candidate = self.get_object()
        logs = candidate.logs.all()
        serializer = CandidateLogSerializer(logs, many=True)
        return Response(serializer.data)
</file>

<file path="backend/config/asgi.py">
"""
ASGI config for config project.

It exposes the ASGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/5.2/howto/deployment/asgi/
"""

import os

from django.core.asgi import get_asgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')

application = get_asgi_application()
</file>

<file path="backend/config/wsgi.py">
"""
WSGI config for config project.

It exposes the WSGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/5.2/howto/deployment/wsgi/
"""

import os

from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')

application = get_wsgi_application()
</file>

<file path="backend/core/management/commands/generate_test_employees.py">
import random
from datetime import date, timedelta
from django.core.management.base import BaseCommand
from django.contrib.auth import get_user_model
from django.utils import timezone
from core.models import (
    Person, Gender, MaritalStatus, Country, AddressType, NationalId, 
    PhoneType, PhoneCarrier, EmailType, Address, State
)
from employment.models import (
    Employment, Position, RoleChoices, EmploymentTypeChoices, 
    EmploymentStatusChoices
)
from organization.models import Department, JobTitle

User = get_user_model()

class Command(BaseCommand):
    help = 'Generates 10 fictitious employees with accounts and data'

    def handle(self, *args, **kwargs):
        self.stdout.write('Generating test data...')

        # --- DATA POOLS ---
        first_names = ['Juan', 'Maria', 'Pedro', 'Ana', 'Luis', 'Carmen', 'Jose', 'Laura', 'Miguel', 'Elena', 'Carlos', 'Sofia']
        last_names = ['Garcia', 'Rodriguez', 'Martinez', 'Hernandez', 'Lopez', 'Gonzalez', 'Perez', 'Sanchez', 'Ramirez', 'Torres']
        streets = ['Av. Bolivar', 'Calle Principal', 'Av. Miranda', 'Calle Sucre', 'Av. Libertador']
        cities = ['Caracas', 'Valencia', 'Maracaibo', 'Barquisimeto', 'Maracay']

        # --- GET OR CREATE CATALOGS ---
        gender_m, _ = Gender.objects.get_or_create(name='Masculino')
        gender_f, _ = Gender.objects.get_or_create(name='Femenino')
        single, _ = MaritalStatus.objects.get_or_create(name='Soltero(a)')
        country_ve, _ = Country.objects.get_or_create(name='Venezuela', defaults={'iso_2': 'VE'})
        addr_type, _ = AddressType.objects.get_or_create(name='Residencial')
        
        # --- ENSURE POSITIONS EXIST ---
        positions = list(Position.objects.all())
        if not positions:
            self.stdout.write('No positions found. Creating dummy positions...')
            dept, _ = Department.objects.get_or_create(name='Recursos Humanos', defaults={'code': 'RRHH'})
            job, _ = JobTitle.objects.get_or_create(name='Analista', defaults={'level': 'L1'})
            pos = Position.objects.create(
                department=dept,
                job_title=job,
                is_managerial=False,
                vacancies=20
            )
            positions.append(pos)

        # --- GENERATE 10 PEOPLE ---
        for i in range(10):
            first_name = random.choice(first_names)
            last_name = random.choice(last_names)
            gender = gender_m if first_name in ['Juan', 'Pedro', 'Luis', 'Jose', 'Miguel', 'Carlos'] else gender_f
            
            # 1. Create Person
            person = Person.objects.create(
                first_name=first_name,
                paternal_surname=last_name,
                gender=gender,
                marital_status=single,
                birthdate=date(1980 + random.randint(0, 20), random.randint(1, 12), random.randint(1, 28)),
                country_of_birth=country_ve
            )

            # 2. National ID
            cedula = random.randint(10000000, 30000000)
            NationalId.objects.create(
                person=person,
                document_type='V',
                number=str(cedula),
                is_primary=True
            )

            # 3. User Account
            username = f"{first_name[0].lower()}{last_name.lower()}{random.randint(10, 99)}"
            # Ensure unique username
            while User.objects.filter(username=username).exists():
                username = f"{first_name[0].lower()}{last_name.lower()}{random.randint(100, 999)}"
            
            user = User.objects.create_user(username=username, password='password123')
            person.user_account = user
            person.save()

            # 4. Address
            state_dc, _ = State.objects.get_or_create(name='Distrito Capital', country=country_ve)
            from core.models import Address
            
            Address.objects.create(
                person=person,
                address_type=addr_type,
                country=country_ve,
                state=state_dc,
                city=random.choice(cities),
                street_name_and_number=f"{random.choice(streets)} #{random.randint(1, 100)}",
                postal_code=f"10{random.randint(10, 99)}"
            )
            
            # 5. Employment
            pos = random.choice(positions)
            Employment.objects.create(
                person=person,
                position=pos,
                role=RoleChoices.EMPLOYEE,
                employment_type=EmploymentTypeChoices.PERMANENT,
                current_status=EmploymentStatusChoices.ACTIVE,
                hire_date=date(2023, 1, 1)
            )

            self.stdout.write(f'Created: {person} ({username}) - {pos}')

        self.stdout.write(self.style.SUCCESS('Successfully generated 10 test employees'))
</file>

<file path="backend/core/migrations/0002_alter_personbankaccount_account_number.py">
# Generated by Django 5.2.8 on 2025-11-26 12:26

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('core', '0001_initial'),
    ]

    operations = [
        migrations.AlterField(
            model_name='personbankaccount',
            name='account_number',
            field=models.CharField(error_messages={'unique': 'Este número de cuenta ya está registrado.'}, max_length=20, unique=True),
        ),
    ]
</file>

<file path="backend/core/migrations/0003_historicalperson.py">
# Generated by Django 5.2.8 on 2025-11-27 20:56

import django.db.models.deletion
import simple_history.models
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('core', '0002_alter_personbankaccount_account_number'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='HistoricalPerson',
            fields=[
                ('id', models.BigIntegerField(auto_created=True, blank=True, db_index=True, verbose_name='ID')),
                ('first_name', models.CharField(max_length=100)),
                ('second_name', models.CharField(blank=True, max_length=100, null=True)),
                ('paternal_surname', models.CharField(max_length=100)),
                ('maternal_surname', models.CharField(blank=True, max_length=100, null=True)),
                ('birthdate', models.DateField(blank=True, null=True)),
                ('photo', models.TextField(blank=True, max_length=100, null=True)),
                ('created_at', models.DateTimeField(blank=True, editable=False)),
                ('updated_at', models.DateTimeField(blank=True, editable=False)),
                ('history_id', models.AutoField(primary_key=True, serialize=False)),
                ('history_date', models.DateTimeField(db_index=True)),
                ('history_change_reason', models.CharField(max_length=100, null=True)),
                ('history_type', models.CharField(choices=[('+', 'Created'), ('~', 'Changed'), ('-', 'Deleted')], max_length=1)),
                ('country_of_birth', models.ForeignKey(blank=True, db_constraint=False, null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='core.country')),
                ('gender', models.ForeignKey(blank=True, db_constraint=False, null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='core.gender')),
                ('history_user', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('marital_status', models.ForeignKey(blank=True, db_constraint=False, null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='core.maritalstatus')),
                ('salutation', models.ForeignKey(blank=True, db_constraint=False, null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='core.salutation')),
            ],
            options={
                'verbose_name': 'historical person',
                'verbose_name_plural': 'historical persons',
                'ordering': ('-history_date', '-history_id'),
                'get_latest_by': ('history_date', 'history_id'),
            },
            bases=(simple_history.models.HistoricalChanges, models.Model),
        ),
    ]
</file>

<file path="backend/core/migrations/0004_remove_phone_prefix.py">
# Generated by Django 5.2.8 on 2025-11-27 21:31

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ('core', '0003_historicalperson'),
    ]

    operations = [
        migrations.RemoveField(
            model_name='country',
            name='phone_prefix',
        ),
    ]
</file>

<file path="backend/core/migrations/0005_phonecarriercode_alter_phoneareacode_unique_together_and_more.py">
# Generated by Django 5.2.8 on 2025-11-29 20:48

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('core', '0004_remove_phone_prefix'),
    ]

    operations = [
        migrations.CreateModel(
            name='PhoneCarrierCode',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('code', models.CharField(max_length=5)),
            ],
        ),
        migrations.AlterUniqueTogether(
            name='phoneareacode',
            unique_together=None,
        ),
        # IMPORTANT: Remove constraint BEFORE removing fields it references
        migrations.RemoveConstraint(
            model_name='personphone',
            name='phone_unique',
        ),
        migrations.RemoveField(
            model_name='phoneareacode',
            name='carrier',
        ),
        migrations.RemoveField(
            model_name='phoneareacode',
            name='country',
        ),
        migrations.RemoveField(
            model_name='personphone',
            name='area_code',
        ),
        migrations.RemoveField(
            model_name='emergencycontact',
            name='phone_area_code',
        ),
        migrations.AddField(
            model_name='phonecarriercode',
            name='carrier',
            field=models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='core.phonecarrier'),
        ),
        migrations.AddField(
            model_name='emergencycontact',
            name='phone_carrier_code',
            field=models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.phonecarriercode'),
        ),
        migrations.AddField(
            model_name='personphone',
            name='carrier_code',
            field=models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.phonecarriercode'),
        ),
        migrations.AddConstraint(
            model_name='personphone',
            constraint=models.UniqueConstraint(fields=('carrier_code', 'subscriber_number'), name='phone_unique', violation_error_message='Este número de teléfono ya se encuentra registrado.'),
        ),
    ]
</file>

<file path="backend/core/migrations/0006_delete_phoneareacode_and_more.py">
# Generated by Django 5.2.8 on 2025-11-29 20:48

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ('ats', '0008_alter_candidate_phone_area_code_and_more'),
        ('core', '0005_phonecarriercode_alter_phoneareacode_unique_together_and_more'),
    ]

    operations = [
        migrations.DeleteModel(
            name='PhoneAreaCode',
        ),
        migrations.AlterUniqueTogether(
            name='phonecarriercode',
            unique_together={('carrier', 'code')},
        ),
    ]
</file>

<file path="backend/core/migrations/0007_refine_validations.py">
# Generated by Django 5.2.8 on 2025-11-30 13:20

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('core', '0006_delete_phoneareacode_and_more'),
    ]

    operations = [
        migrations.AlterField(
            model_name='phonecarriercode',
            name='code',
            field=models.CharField(max_length=4),
        ),
    ]
</file>

<file path="backend/core/migrations/0008_remove_salutation.py">
# Generated migration to remove Salutation model and salutation field from Person

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ('core', '0007_refine_validations'),
    ]

    operations = [
        migrations.RemoveField(
            model_name='person',
            name='salutation',
        ),
        migrations.RemoveField(
            model_name='historicalperson',
            name='salutation',
        ),
        migrations.DeleteModel(
            name='Salutation',
        ),
    ]
</file>

<file path="backend/core/migrations/0009_make_gender_birthdate_required.py">
# Generated migration to make gender and birthdate required fields

from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    dependencies = [
        ('core', '0008_remove_salutation'),
    ]

    operations = [
        # First, set default values for existing NULL records
        # This is a data migration step that should be done before altering the field
        migrations.RunSQL(
            # For gender: set to first available gender if NULL
            sql="""
                UPDATE core_person 
                SET gender_id = (SELECT id FROM core_gender LIMIT 1)
                WHERE gender_id IS NULL;
            """,
            reverse_sql=migrations.RunSQL.noop,
        ),
        migrations.RunSQL(
            # For birthdate: set to a default date (e.g., 1900-01-01) if NULL
            sql="""
                UPDATE core_person 
                SET birthdate = '1900-01-01'
                WHERE birthdate IS NULL;
            """,
            reverse_sql=migrations.RunSQL.noop,
        ),
        # Now alter the fields to be non-nullable
        migrations.AlterField(
            model_name='person',
            name='gender',
            field=models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, to='core.gender'),
        ),
        migrations.AlterField(
            model_name='person',
            name='birthdate',
            field=models.DateField(),
        ),
    ]
</file>

<file path="backend/core/migrations/0010_alter_historicalperson_birthdate.py">
# Generated by Django 5.2.8 on 2025-12-01 20:57

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('core', '0009_make_gender_birthdate_required'),
    ]

    operations = [
        migrations.AlterField(
            model_name='historicalperson',
            name='birthdate',
            field=models.DateField(),
        ),
    ]
</file>

<file path="backend/core/migrations/0011_alter_historicalperson_birthdate_and_more.py">
# Generated by Django 5.2.8 on 2025-12-03 13:07

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('core', '0010_alter_historicalperson_birthdate'),
    ]

    operations = [
        migrations.AlterField(
            model_name='historicalperson',
            name='birthdate',
            field=models.DateField(blank=True, null=True),
        ),
        migrations.AlterField(
            model_name='person',
            name='birthdate',
            field=models.DateField(blank=True, null=True),
        ),
        migrations.AlterField(
            model_name='person',
            name='gender',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.PROTECT, to='core.gender'),
        ),
    ]
</file>

<file path="backend/core/migrations/0012_historicalperson_cv_file_person_cv_file.py">
# Generated by Django 5.2.8 on 2025-12-07 04:58

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('core', '0011_alter_historicalperson_birthdate_and_more'),
    ]

    operations = [
        migrations.AddField(
            model_name='historicalperson',
            name='cv_file',
            field=models.TextField(blank=True, help_text='Curriculum Vitae (PDF, DOCX)', max_length=100, null=True),
        ),
        migrations.AddField(
            model_name='person',
            name='cv_file',
            field=models.FileField(blank=True, help_text='Curriculum Vitae (PDF, DOCX)', null=True, upload_to='cv/person/'),
        ),
    ]
</file>

<file path="backend/core/db_utils.py">
import unicodedata

def remove_accents(input_str):
    if input_str is None:
        return None
    if not isinstance(input_str, str):
        return str(input_str)
    
    # Normalize unicode characters to NFD (Decomposition)
    nfkd_form = unicodedata.normalize('NFD', input_str)
    
    # Filter out non-spacing mark characters (combining diacritics)
    return "".join([c for c in nfkd_form if not unicodedata.combining(c)])
</file>

<file path="backend/core/pagination.py">
from rest_framework.pagination import PageNumberPagination

class CustomPagination(PageNumberPagination):
    # page_size = 5
    page_size_query_param = 'page_size'
    max_page_size = 100
</file>

<file path="backend/core/tests.py">
from django.test import TestCase

# Create your tests here.
</file>

<file path="backend/employment/migrations/0002_historicalemployment.py">
# Generated by Django 5.2.8 on 2025-11-27 20:56

import django.db.models.deletion
import simple_history.models
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('core', '0003_historicalperson'),
        ('employment', '0001_initial'),
        ('organization', '0002_historicaldepartment_historicalposition'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='HistoricalEmployment',
            fields=[
                ('id', models.BigIntegerField(auto_created=True, blank=True, db_index=True, verbose_name='ID')),
                ('exit_reason', models.CharField(blank=True, choices=[('REN', 'Renuncia Voluntaria'), ('DES', 'Despido / Cese'), ('FIN', 'Fin de Contrato (Tiempo Cumplido)'), ('JUB', 'Jubilación'), ('FAL', 'Fallecimiento'), ('OTR', 'Otro Motivo')], max_length=3, null=True, verbose_name='Motivo de Salida')),
                ('exit_notes', models.TextField(blank=True, help_text='Detalle o carta de renuncia.', null=True, verbose_name='Observaciones')),
                ('hire_date', models.DateField(verbose_name='Fecha de Contratación')),
                ('end_date', models.DateField(blank=True, help_text="Fecha de fin de contrato (para 'Tiempo Determinado' o 'Prueba')", null=True)),
                ('created_at', models.DateTimeField(blank=True, editable=False)),
                ('updated_at', models.DateTimeField(blank=True, editable=False)),
                ('history_id', models.AutoField(primary_key=True, serialize=False)),
                ('history_date', models.DateTimeField(db_index=True)),
                ('history_change_reason', models.CharField(max_length=100, null=True)),
                ('history_type', models.CharField(choices=[('+', 'Created'), ('~', 'Changed'), ('-', 'Deleted')], max_length=1)),
                ('current_status', models.ForeignKey(blank=True, db_constraint=False, null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='employment.employmentstatus', verbose_name='Estatus Actual')),
                ('employment_type', models.ForeignKey(blank=True, db_constraint=False, null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='employment.employmenttype', verbose_name='Tipo de Contrato')),
                ('history_user', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('person', models.ForeignKey(blank=True, db_constraint=False, null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='core.person', verbose_name='Colaborador')),
                ('position', models.ForeignKey(blank=True, db_constraint=False, null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='organization.position', verbose_name='Cargo / Posición')),
                ('role', models.ForeignKey(blank=True, db_constraint=False, null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='employment.role', verbose_name='Rol Funcional')),
            ],
            options={
                'verbose_name': 'historical Expediente Laboral',
                'verbose_name_plural': 'historical Expediente Laborals',
                'ordering': ('-history_date', '-history_id'),
                'get_latest_by': ('history_date', 'history_id'),
            },
            bases=(simple_history.models.HistoricalChanges, models.Model),
        ),
    ]
</file>

<file path="backend/employment/migrations/0003_add_choice_fields.py">
# Generated by Django 5.2.8 on 2025-11-30 21:36

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('employment', '0002_historicalemployment'),
    ]

    operations = [
        migrations.AddField(
            model_name='employment',
            name='current_status_new',
            field=models.CharField(choices=[('ACT', 'Activo'), ('SUS', 'Suspendido'), ('PER', 'De Permiso'), ('REP', 'Reposo'), ('FIN', 'Finalizado'), ('REN', 'Renuncia'), ('DES', 'Despido'), ('ANU', 'Anulado')], max_length=3, null=True, verbose_name='Estatus Actual'),
        ),
        migrations.AddField(
            model_name='employment',
            name='employment_type_new',
            field=models.CharField(choices=[('FIJ', 'Fijo'), ('TMP', 'Temporal'), ('PAS', 'Pasantía')], max_length=3, null=True, verbose_name='Tipo de Contrato'),
        ),
        migrations.AddField(
            model_name='employment',
            name='role_new',
            field=models.CharField(choices=[('EMP', 'Empleado'), ('MGR', 'Manager')], max_length=3, null=True, verbose_name='Rol Funcional'),
        ),
        migrations.AddField(
            model_name='historicalemployment',
            name='current_status_new',
            field=models.CharField(choices=[('ACT', 'Activo'), ('SUS', 'Suspendido'), ('PER', 'De Permiso'), ('REP', 'Reposo'), ('FIN', 'Finalizado'), ('REN', 'Renuncia'), ('DES', 'Despido'), ('ANU', 'Anulado')], max_length=3, null=True, verbose_name='Estatus Actual'),
        ),
        migrations.AddField(
            model_name='historicalemployment',
            name='employment_type_new',
            field=models.CharField(choices=[('FIJ', 'Fijo'), ('TMP', 'Temporal'), ('PAS', 'Pasantía')], max_length=3, null=True, verbose_name='Tipo de Contrato'),
        ),
        migrations.AddField(
            model_name='historicalemployment',
            name='role_new',
            field=models.CharField(choices=[('EMP', 'Empleado'), ('MGR', 'Manager')], max_length=3, null=True, verbose_name='Rol Funcional'),
        ),
        migrations.AlterField(
            model_name='employment',
            name='current_status',
            field=models.ForeignKey(null=True, on_delete=django.db.models.deletion.PROTECT, related_name='active_employments', to='employment.employmentstatus', verbose_name='Estatus Actual (Old)'),
        ),
        migrations.AlterField(
            model_name='employment',
            name='employment_type',
            field=models.ForeignKey(null=True, on_delete=django.db.models.deletion.PROTECT, related_name='employments', to='employment.employmenttype', verbose_name='Tipo de Contrato (Old)'),
        ),
        migrations.AlterField(
            model_name='employment',
            name='role',
            field=models.ForeignKey(null=True, on_delete=django.db.models.deletion.PROTECT, related_name='employments', to='employment.role', verbose_name='Rol Funcional (Old)'),
        ),
        migrations.AlterField(
            model_name='historicalemployment',
            name='current_status',
            field=models.ForeignKey(blank=True, db_constraint=False, null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='employment.employmentstatus', verbose_name='Estatus Actual (Old)'),
        ),
        migrations.AlterField(
            model_name='historicalemployment',
            name='employment_type',
            field=models.ForeignKey(blank=True, db_constraint=False, null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='employment.employmenttype', verbose_name='Tipo de Contrato (Old)'),
        ),
        migrations.AlterField(
            model_name='historicalemployment',
            name='role',
            field=models.ForeignKey(blank=True, db_constraint=False, null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='employment.role', verbose_name='Rol Funcional (Old)'),
        ),
    ]
</file>

<file path="backend/employment/migrations/0004_migrate_data_to_choices.py">
# Generated by Django 5.2.8 on 2025-11-30 21:36

from django.db import migrations


def migrate_to_choices(apps, schema_editor):
    """
    Copia los datos de los ForeignKey a los nuevos campos CharField con choices.
    Mapea los nombres de los catálogos a los códigos de choices.
    """
    Employment = apps.get_model('employment', 'Employment')
    
    # Mapeos de nombre a código de choice
    role_map = {
        'Empleado': 'EMP',
        'Manager': 'MGR',
    }
    
    type_map = {
        'Fijo': 'FIJ',
        'Temporal': 'TMP',
        'Pasantía': 'PAS',
    }
    
    status_map = {
        'Activo': 'ACT',
        'Suspendido': 'SUS',
        'De Permiso': 'PER',
        'Reposo': 'REP',
        'Finalizado': 'FIN',
        'Renuncia': 'REN',
        'Despido': 'DES',
        'Anulado': 'ANU',
    }
    
    for employment in Employment.objects.all():
        # Migrar role
        if employment.role:
            employment.role_new = role_map.get(employment.role.name, 'EMP')
        
        # Migrar employment_type
        if employment.employment_type:
            employment.employment_type_new = type_map.get(employment.employment_type.name, 'FIJ')
        
        # Migrar current_status
        if employment.current_status:
            employment.current_status_new = status_map.get(employment.current_status.name, 'ACT')
        
        employment.save()


def reverse_migrate(apps, schema_editor):
    """
    Rollback: Copiar de vuelta los valores de choice a los FK.
    Esto solo funciona si los catálogos aún existen.
    """
    Employment = apps.get_model('employment', 'Employment')
    Role = apps.get_model('employment', 'Role')
    EmploymentType = apps.get_model('employment', 'EmploymentType')
    EmploymentStatus = apps.get_model('employment', 'EmploymentStatus')
    
    # Mapeos inversos de código a nombre
    role_reverse = {
        'EMP': 'Empleado',
        'MGR': 'Manager',
    }
    
    type_reverse = {
        'FIJ': 'Fijo',
        'TMP': 'Temporal',
        'PAS': 'Pasantía',
    }
    
    status_reverse = {
        'ACT': 'Activo',
        'SUS': 'Suspendido',
        'PER': 'De Permiso',
        'REP': 'Reposo',
        'FIN': 'Finalizado',
        'REN': 'Renuncia',
        'DES': 'Despido',
        'ANU': 'Anulado',
    }
    
    for employment in Employment.objects.all():
        # Restaurar role
        if employment.role_new:
            role_name = role_reverse.get(employment.role_new)
            if role_name:
                employment.role = Role.objects.filter(name=role_name).first()
        
        # Restaurar employment_type
        if employment.employment_type_new:
            type_name = type_reverse.get(employment.employment_type_new)
            if type_name:
                employment.employment_type = EmploymentType.objects.filter(name=type_name).first()
        
        # Restaurar current_status
        if employment.current_status_new:
            status_name = status_reverse.get(employment.current_status_new)
            if status_name:
                employment.current_status = EmploymentStatus.objects.filter(name=status_name).first()
        
        employment.save()


class Migration(migrations.Migration):

    dependencies = [
        ('employment', '0003_add_choice_fields'),
    ]

    operations = [
        migrations.RunPython(migrate_to_choices, reverse_migrate),
    ]
</file>

<file path="backend/employment/migrations/0005_alter_employmentstatuslog_status_and_more.py">
# Generated by Django 5.2.8 on 2025-11-30 23:16

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('employment', '0004_migrate_data_to_choices'),
    ]

    operations = [
        migrations.AlterField(
            model_name='employmentstatuslog',
            name='status',
            field=models.CharField(choices=[('ACT', 'Activo'), ('SUS', 'Suspendido'), ('PER', 'De Permiso'), ('REP', 'Reposo'), ('FIN', 'Finalizado'), ('REN', 'Renuncia'), ('DES', 'Despido'), ('ANU', 'Anulado')], max_length=3, verbose_name='Estatus'),
        ),
        migrations.AlterField(
            model_name='historicalemployment',
            name='current_status',
            field=models.CharField(choices=[('ACT', 'Activo'), ('SUS', 'Suspendido'), ('PER', 'De Permiso'), ('REP', 'Reposo'), ('FIN', 'Finalizado'), ('REN', 'Renuncia'), ('DES', 'Despido'), ('ANU', 'Anulado')], default='ACT', max_length=3, verbose_name='Estatus Actual'),
        ),
        migrations.AlterField(
            model_name='employment',
            name='current_status',
            field=models.CharField(choices=[('ACT', 'Activo'), ('SUS', 'Suspendido'), ('PER', 'De Permiso'), ('REP', 'Reposo'), ('FIN', 'Finalizado'), ('REN', 'Renuncia'), ('DES', 'Despido'), ('ANU', 'Anulado')], default='ACT', max_length=3, verbose_name='Estatus Actual'),
        ),
        migrations.AlterField(
            model_name='historicalemployment',
            name='employment_type',
            field=models.CharField(choices=[('FIJ', 'Fijo'), ('TMP', 'Temporal'), ('PAS', 'Pasantía')], default='FIJ', max_length=3, verbose_name='Tipo de Contrato'),
        ),
        migrations.AlterField(
            model_name='employment',
            name='employment_type',
            field=models.CharField(choices=[('FIJ', 'Fijo'), ('TMP', 'Temporal'), ('PAS', 'Pasantía')], default='FIJ', max_length=3, verbose_name='Tipo de Contrato'),
        ),
        migrations.AlterField(
            model_name='historicalemployment',
            name='role',
            field=models.CharField(choices=[('EMP', 'Empleado'), ('MGR', 'Manager')], default='EMP', max_length=3, verbose_name='Rol Funcional'),
        ),
        migrations.AlterField(
            model_name='employment',
            name='role',
            field=models.CharField(choices=[('EMP', 'Empleado'), ('MGR', 'Manager')], default='EMP', max_length=3, verbose_name='Rol Funcional'),
        ),
        migrations.RemoveField(
            model_name='employment',
            name='current_status_new',
        ),
        migrations.RemoveField(
            model_name='employment',
            name='employment_type_new',
        ),
        migrations.RemoveField(
            model_name='employment',
            name='role_new',
        ),
        migrations.RemoveField(
            model_name='historicalemployment',
            name='current_status_new',
        ),
        migrations.RemoveField(
            model_name='historicalemployment',
            name='employment_type_new',
        ),
        migrations.RemoveField(
            model_name='historicalemployment',
            name='role_new',
        ),
        migrations.DeleteModel(
            name='EmploymentStatus',
        ),
        migrations.DeleteModel(
            name='EmploymentType',
        ),
        migrations.DeleteModel(
            name='Role',
        ),
    ]
</file>

<file path="backend/employment/migrations/0006_historicalemploymentdepartmentrole_and_more.py">
# Generated by Django 5.2.8 on 2025-12-01 00:22

import django.db.models.deletion
import django.utils.timezone
import simple_history.models
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('employment', '0005_alter_employmentstatuslog_status_and_more'),
        ('organization', '0008_historicalposition_objective_position_objective_and_more'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='HistoricalEmploymentDepartmentRole',
            fields=[
                ('id', models.BigIntegerField(auto_created=True, blank=True, db_index=True, verbose_name='ID')),
                ('hierarchical_role', models.CharField(choices=[('MGR', 'Gerente'), ('EMP', 'Empleado')], default='EMP', help_text='Rol dentro del departamento (Gerente o Empleado)', max_length=3, verbose_name='Rol Jerárquico')),
                ('start_date', models.DateField(default=django.utils.timezone.now, help_text='Inicio del rol jerárquico en este departamento', verbose_name='Fecha de Inicio')),
                ('end_date', models.DateField(blank=True, help_text='Fin del rol jerárquico (NULL si es actual)', null=True, verbose_name='Fecha de Fin')),
                ('notes', models.TextField(blank=True, help_text='Observaciones sobre la asignación del rol', null=True, verbose_name='Notas')),
                ('created_at', models.DateTimeField(blank=True, editable=False)),
                ('updated_at', models.DateTimeField(blank=True, editable=False)),
                ('history_id', models.AutoField(primary_key=True, serialize=False)),
                ('history_date', models.DateTimeField(db_index=True)),
                ('history_change_reason', models.CharField(max_length=100, null=True)),
                ('history_type', models.CharField(choices=[('+', 'Created'), ('~', 'Changed'), ('-', 'Deleted')], max_length=1)),
                ('department', models.ForeignKey(blank=True, db_constraint=False, help_text='Departamento en el que ejerce este rol', null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='organization.department', verbose_name='Departamento')),
                ('employment', models.ForeignKey(blank=True, db_constraint=False, help_text='Contrato al que pertenece este rol jerárquico', null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='employment.employment', verbose_name='Contrato')),
                ('history_user', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'historical Rol Jerárquico en Departamento',
                'verbose_name_plural': 'historical Roles Jerárquicos en Departamentos',
                'ordering': ('-history_date', '-history_id'),
                'get_latest_by': ('history_date', 'history_id'),
            },
            bases=(simple_history.models.HistoricalChanges, models.Model),
        ),
        migrations.CreateModel(
            name='EmploymentDepartmentRole',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('hierarchical_role', models.CharField(choices=[('MGR', 'Gerente'), ('EMP', 'Empleado')], default='EMP', help_text='Rol dentro del departamento (Gerente o Empleado)', max_length=3, verbose_name='Rol Jerárquico')),
                ('start_date', models.DateField(default=django.utils.timezone.now, help_text='Inicio del rol jerárquico en este departamento', verbose_name='Fecha de Inicio')),
                ('end_date', models.DateField(blank=True, help_text='Fin del rol jerárquico (NULL si es actual)', null=True, verbose_name='Fecha de Fin')),
                ('notes', models.TextField(blank=True, help_text='Observaciones sobre la asignación del rol', null=True, verbose_name='Notas')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('department', models.ForeignKey(help_text='Departamento en el que ejerce este rol', on_delete=django.db.models.deletion.CASCADE, related_name='employment_roles', to='organization.department', verbose_name='Departamento')),
                ('employment', models.ForeignKey(help_text='Contrato al que pertenece este rol jerárquico', on_delete=django.db.models.deletion.CASCADE, related_name='department_roles', to='employment.employment', verbose_name='Contrato')),
            ],
            options={
                'verbose_name': 'Rol Jerárquico en Departamento',
                'verbose_name_plural': 'Roles Jerárquicos en Departamentos',
                'ordering': ['-start_date'],
                'unique_together': {('employment', 'department', 'start_date')},
            },
        ),
    ]
</file>

<file path="backend/employment/migrations/0007_historicalpersondepartmentrole_persondepartmentrole.py">
# Generated by Django 5.2.8 on 2025-12-01 00:47

import django.db.models.deletion
import django.utils.timezone
import simple_history.models
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('core', '0007_refine_validations'),
        ('employment', '0006_historicalemploymentdepartmentrole_and_more'),
        ('organization', '0008_historicalposition_objective_position_objective_and_more'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='HistoricalPersonDepartmentRole',
            fields=[
                ('id', models.BigIntegerField(auto_created=True, blank=True, db_index=True, verbose_name='ID')),
                ('hierarchical_role', models.CharField(choices=[('MGR', 'Gerente'), ('EMP', 'Empleado')], default='EMP', help_text='Rol dentro del departamento (Gerente o Empleado)', max_length=3, verbose_name='Rol Jerárquico')),
                ('start_date', models.DateField(default=django.utils.timezone.now, help_text='Inicio del rol jerárquico en este departamento', verbose_name='Fecha de Inicio')),
                ('end_date', models.DateField(blank=True, help_text='Fin del rol jerárquico (NULL si es actual)', null=True, verbose_name='Fecha de Fin')),
                ('notes', models.TextField(blank=True, help_text='Observaciones sobre la asignación del rol', null=True, verbose_name='Notas')),
                ('created_at', models.DateTimeField(blank=True, editable=False)),
                ('updated_at', models.DateTimeField(blank=True, editable=False)),
                ('history_id', models.AutoField(primary_key=True, serialize=False)),
                ('history_date', models.DateTimeField(db_index=True)),
                ('history_change_reason', models.CharField(max_length=100, null=True)),
                ('history_type', models.CharField(choices=[('+', 'Created'), ('~', 'Changed'), ('-', 'Deleted')], max_length=1)),
                ('department', models.ForeignKey(blank=True, db_constraint=False, help_text='Departamento en el que ejerce este rol', null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='organization.department', verbose_name='Departamento')),
                ('history_user', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('person', models.ForeignKey(blank=True, db_constraint=False, help_text='Persona que ejerce este rol jerárquico', null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='core.person', verbose_name='Persona')),
            ],
            options={
                'verbose_name': 'historical Rol Jerárquico por Persona',
                'verbose_name_plural': 'historical Roles Jerárquicos por Persona',
                'ordering': ('-history_date', '-history_id'),
                'get_latest_by': ('history_date', 'history_id'),
            },
            bases=(simple_history.models.HistoricalChanges, models.Model),
        ),
        migrations.CreateModel(
            name='PersonDepartmentRole',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('hierarchical_role', models.CharField(choices=[('MGR', 'Gerente'), ('EMP', 'Empleado')], default='EMP', help_text='Rol dentro del departamento (Gerente o Empleado)', max_length=3, verbose_name='Rol Jerárquico')),
                ('start_date', models.DateField(default=django.utils.timezone.now, help_text='Inicio del rol jerárquico en este departamento', verbose_name='Fecha de Inicio')),
                ('end_date', models.DateField(blank=True, help_text='Fin del rol jerárquico (NULL si es actual)', null=True, verbose_name='Fecha de Fin')),
                ('notes', models.TextField(blank=True, help_text='Observaciones sobre la asignación del rol', null=True, verbose_name='Notas')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('department', models.ForeignKey(help_text='Departamento en el que ejerce este rol', on_delete=django.db.models.deletion.CASCADE, related_name='person_roles', to='organization.department', verbose_name='Departamento')),
                ('person', models.ForeignKey(help_text='Persona que ejerce este rol jerárquico', on_delete=django.db.models.deletion.CASCADE, related_name='department_roles', to='core.person', verbose_name='Persona')),
            ],
            options={
                'verbose_name': 'Rol Jerárquico por Persona',
                'verbose_name_plural': 'Roles Jerárquicos por Persona',
                'ordering': ['-start_date'],
                'unique_together': {('person', 'department', 'start_date')},
            },
        ),
    ]
</file>

<file path="backend/employment/apps.py">
from django.apps import AppConfig


class EmploymentConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'employment'
</file>

<file path="backend/employment/tests.py">
from django.test import TestCase

# Create your tests here.
</file>

<file path="backend/organization/migrations/0002_historicaldepartment_historicalposition.py">
# Generated by Django 5.2.8 on 2025-11-27 20:56

import django.db.models.deletion
import simple_history.models
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('organization', '0001_initial'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='HistoricalDepartment',
            fields=[
                ('id', models.BigIntegerField(auto_created=True, blank=True, db_index=True, verbose_name='ID')),
                ('name', models.CharField(db_index=True, error_messages={'unique': 'Ya existe un registro con este nombre.'}, max_length=100)),
                ('created_at', models.DateTimeField(blank=True, editable=False)),
                ('updated_at', models.DateTimeField(blank=True, editable=False)),
                ('history_id', models.AutoField(primary_key=True, serialize=False)),
                ('history_date', models.DateTimeField(db_index=True)),
                ('history_change_reason', models.CharField(max_length=100, null=True)),
                ('history_type', models.CharField(choices=[('+', 'Created'), ('~', 'Changed'), ('-', 'Deleted')], max_length=1)),
                ('history_user', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('parent', models.ForeignKey(blank=True, db_constraint=False, help_text='Departamento superior al que reporta este departamento.', null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='organization.department')),
            ],
            options={
                'verbose_name': 'historical department',
                'verbose_name_plural': 'historical departments',
                'ordering': ('-history_date', '-history_id'),
                'get_latest_by': ('history_date', 'history_id'),
            },
            bases=(simple_history.models.HistoricalChanges, models.Model),
        ),
        migrations.CreateModel(
            name='HistoricalPosition',
            fields=[
                ('id', models.BigIntegerField(auto_created=True, blank=True, db_index=True, verbose_name='ID')),
                ('vacancies', models.PositiveIntegerField(default=1, help_text='Número de vacantes disponibles')),
                ('name', models.CharField(blank=True, help_text="Nombre descriptivo opcional, ej: 'Gerente de Finanzas (VE)'", max_length=100, null=True)),
                ('created_at', models.DateTimeField(blank=True, editable=False)),
                ('updated_at', models.DateTimeField(blank=True, editable=False)),
                ('history_id', models.AutoField(primary_key=True, serialize=False)),
                ('history_date', models.DateTimeField(db_index=True)),
                ('history_change_reason', models.CharField(max_length=100, null=True)),
                ('history_type', models.CharField(choices=[('+', 'Created'), ('~', 'Changed'), ('-', 'Deleted')], max_length=1)),
                ('department', models.ForeignKey(blank=True, db_constraint=False, null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='organization.department')),
                ('history_user', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('job_title', models.ForeignKey(blank=True, db_constraint=False, null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='organization.jobtitle')),
                ('manager_position', models.ForeignKey(blank=True, db_constraint=False, help_text='Posición a la que reporta directamente (Jefe Inmediato).', null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='organization.position')),
            ],
            options={
                'verbose_name': 'historical position',
                'verbose_name_plural': 'historical positions',
                'ordering': ('-history_date', '-history_id'),
                'get_latest_by': ('history_date', 'history_id'),
            },
            bases=(simple_history.models.HistoricalChanges, models.Model),
        ),
    ]
</file>

<file path="backend/organization/migrations/0003_remove_jobtitle_description.py">
# Generated by Django 5.2.8 on 2025-11-27 22:23

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ('organization', '0002_historicaldepartment_historicalposition'),
    ]

    operations = [
        migrations.RemoveField(
            model_name='jobtitle',
            name='description',
        ),
    ]
</file>

<file path="backend/organization/migrations/0004_remove_historicalposition_name_remove_position_name.py">
# Generated by Django 5.2.8 on 2025-11-27 22:56

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ('organization', '0003_remove_jobtitle_description'),
    ]

    operations = [
        migrations.RemoveField(
            model_name='historicalposition',
            name='name',
        ),
        migrations.RemoveField(
            model_name='position',
            name='name',
        ),
    ]
</file>

<file path="backend/organization/migrations/0005_alter_position_unique_together.py">
# Generated by Django 5.2.8 on 2025-11-27 23:03

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ('organization', '0004_remove_historicalposition_name_remove_position_name'),
    ]

    operations = [
        migrations.AlterUniqueTogether(
            name='position',
            unique_together={('department', 'job_title')},
        ),
    ]
</file>

<file path="backend/organization/migrations/0006_remove_historicalposition_manager_position_and_more.py">
# Generated by Django 5.2.8 on 2025-11-28 00:51

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('organization', '0005_alter_position_unique_together'),
    ]

    operations = [
        migrations.RemoveField(
            model_name='historicalposition',
            name='manager_position',
        ),
        migrations.RemoveField(
            model_name='position',
            name='manager_position',
        ),
        migrations.AddField(
            model_name='position',
            name='manager_positions',
            field=models.ManyToManyField(blank=True, help_text='Posiciones a las que reporta directamente (Jefes Inmediatos).', related_name='direct_reports', to='organization.position'),
        ),
    ]
</file>

<file path="backend/organization/migrations/0007_alter_department_name_alter_department_parent_and_more.py">
# Generated by Django 5.2.8 on 2025-11-28 01:19

import django.db.models.deletion
import simple_history.models
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('organization', '0006_remove_historicalposition_manager_position_and_more'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.AlterField(
            model_name='department',
            name='name',
            field=models.CharField(max_length=100, unique=True),
        ),
        migrations.AlterField(
            model_name='department',
            name='parent',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='subdepartments', to='organization.department'),
        ),
        migrations.AlterField(
            model_name='historicaldepartment',
            name='name',
            field=models.CharField(db_index=True, max_length=100),
        ),
        migrations.AlterField(
            model_name='historicaldepartment',
            name='parent',
            field=models.ForeignKey(blank=True, db_constraint=False, null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='organization.department'),
        ),
        migrations.AlterField(
            model_name='jobtitle',
            name='name',
            field=models.CharField(max_length=100, unique=True),
        ),
        migrations.CreateModel(
            name='HistoricalJobTitle',
            fields=[
                ('id', models.BigIntegerField(auto_created=True, blank=True, db_index=True, verbose_name='ID')),
                ('name', models.CharField(db_index=True, max_length=100)),
                ('created_at', models.DateTimeField(blank=True, editable=False)),
                ('updated_at', models.DateTimeField(blank=True, editable=False)),
                ('history_id', models.AutoField(primary_key=True, serialize=False)),
                ('history_date', models.DateTimeField(db_index=True)),
                ('history_change_reason', models.CharField(max_length=100, null=True)),
                ('history_type', models.CharField(choices=[('+', 'Created'), ('~', 'Changed'), ('-', 'Deleted')], max_length=1)),
                ('history_user', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'historical job title',
                'verbose_name_plural': 'historical job titles',
                'ordering': ('-history_date', '-history_id'),
                'get_latest_by': ('history_date', 'history_id'),
            },
            bases=(simple_history.models.HistoricalChanges, models.Model),
        ),
        migrations.CreateModel(
            name='PositionFunction',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('description', models.TextField(help_text='Descripción de la función o responsabilidad')),
                ('order', models.PositiveIntegerField(default=0, help_text='Orden de visualización (menor primero)')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('position', models.ForeignKey(help_text='Posición a la que pertenece esta función', on_delete=django.db.models.deletion.CASCADE, related_name='functions', to='organization.position')),
            ],
            options={
                'verbose_name': 'Función de Cargo',
                'verbose_name_plural': 'Funciones de Cargos',
                'ordering': ['order', 'id'],
            },
        ),
    ]
</file>

<file path="backend/organization/migrations/0008_historicalposition_objective_position_objective_and_more.py">
# Generated by Django 5.2.8 on 2025-11-30 23:30

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('organization', '0007_alter_department_name_alter_department_parent_and_more'),
    ]

    operations = [
        migrations.AddField(
            model_name='historicalposition',
            name='objective',
            field=models.TextField(blank=True, help_text='Objetivo general del cargo', null=True, verbose_name='Objetivo'),
        ),
        migrations.AddField(
            model_name='position',
            name='objective',
            field=models.TextField(blank=True, help_text='Objetivo general del cargo', null=True, verbose_name='Objetivo'),
        ),
        migrations.DeleteModel(
            name='PositionObjective',
        ),
    ]
</file>

<file path="backend/organization/migrations/0009_historicalposition_is_manager_position_is_manager.py">
# Generated by Django 5.2.8 on 2025-12-01 18:04

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('organization', '0008_historicalposition_objective_position_objective_and_more'),
    ]

    operations = [
        migrations.AddField(
            model_name='historicalposition',
            name='is_manager',
            field=models.BooleanField(default=False, help_text='Indica si esta posición tiene responsabilidades gerenciales.', verbose_name='Es Gerencial'),
        ),
        migrations.AddField(
            model_name='position',
            name='is_manager',
            field=models.BooleanField(default=False, help_text='Indica si esta posición tiene responsabilidades gerenciales.', verbose_name='Es Gerencial'),
        ),
    ]
</file>

<file path="backend/organization/apps.py">
from django.apps import AppConfig


class OrganizationConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'organization'
</file>

<file path="backend/organization/tests.py">
from django.test import TestCase

# Create your tests here.
</file>

<file path="backend/performance/migrations/0001_initial.py">
# Generated by Django 5.2.8 on 2025-11-25 06:08

import django.core.validators
import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('core', '0001_initial'),
        ('employment', '0001_initial'),
        ('organization', '0001_initial'),
    ]

    operations = [
        migrations.CreateModel(
            name='EvaluationPeriod',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=100, unique=True)),
                ('start_date', models.DateField(verbose_name='Inicio')),
                ('end_date', models.DateField(verbose_name='Cierre')),
                ('is_active', models.BooleanField(default=True, verbose_name='Activo')),
            ],
            options={
                'verbose_name': 'Periodo de Evaluación',
                'ordering': ['-start_date'],
            },
        ),
        migrations.CreateModel(
            name='Competency',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=100)),
                ('description', models.TextField(blank=True, null=True)),
                ('is_global', models.BooleanField(default=True, help_text='Si se marca, aplica a todos los empleados.', verbose_name='¿Es Global?')),
                ('job_titles', models.ManyToManyField(blank=True, related_name='specific_competencies', to='organization.jobtitle', verbose_name='Aplica a Cargos Específicos')),
            ],
            options={
                'verbose_name': 'Competencia / Criterio',
                'verbose_name_plural': 'Competencias',
            },
        ),
        migrations.CreateModel(
            name='PerformanceReview',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('final_score', models.DecimalField(blank=True, decimal_places=2, max_digits=4, null=True, verbose_name='Promedio Final')),
                ('status', models.CharField(choices=[('BOR', 'Borrador'), ('ENV', 'Enviada / Finalizada'), ('ACE', 'Aceptada por Empleado')], default='BOR', max_length=3)),
                ('feedback_manager', models.TextField(blank=True, verbose_name='Comentarios del Jefe')),
                ('feedback_employee', models.TextField(blank=True, verbose_name='Comentarios del Empleado')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('employment', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='reviews', to='employment.employment')),
                ('evaluator', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='reviews_given', to='core.person')),
                ('period', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, to='performance.evaluationperiod')),
            ],
            options={
                'verbose_name': 'Evaluación de Desempeño',
                'unique_together': {('period', 'employment')},
            },
        ),
        migrations.CreateModel(
            name='ReviewDetail',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('score', models.PositiveIntegerField(default=0, validators=[django.core.validators.MinValueValidator(0), django.core.validators.MaxValueValidator(5)], verbose_name='Puntaje (1-5)')),
                ('comment', models.TextField(blank=True, null=True, verbose_name='Observación')),
                ('competency', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, to='performance.competency')),
                ('review', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='details', to='performance.performancereview')),
            ],
            options={
                'unique_together': {('review', 'competency')},
            },
        ),
    ]
</file>

<file path="backend/performance/migrations/0002_alter_performancereview_options.py">
# Generated by Django 5.2.8 on 2025-11-25 06:12

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ('performance', '0001_initial'),
    ]

    operations = [
        migrations.AlterModelOptions(
            name='performancereview',
            options={'verbose_name': 'Evaluación de Desempeño', 'verbose_name_plural': 'Evaluaciones de Desempeño'},
        ),
    ]
</file>

<file path="backend/performance/migrations/0003_competency_category.py">
# Generated by Django 5.2.8 on 2025-12-03 07:24

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('performance', '0002_alter_performancereview_options'),
    ]

    operations = [
        migrations.AddField(
            model_name='competency',
            name='category',
            field=models.CharField(blank=True, choices=[('CAL', 'Calidad'), ('COM', 'Compromiso'), ('CMU', 'Comunicación'), ('ORG', 'Organización'), ('DIS', 'Disciplina'), ('PRO', 'Proactividad')], db_index=True, help_text='Categoría de evaluación según la matriz de desempeño global', max_length=3, null=True, verbose_name='Categoría'),
        ),
    ]
</file>

<file path="backend/performance/apps.py">
from django.apps import AppConfig


class PerformanceConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'performance'
</file>

<file path="backend/performance/tests.py">
from django.test import TestCase

# Create your tests here.
</file>

<file path="backend/performance/urls.py">
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from . import views

router = DefaultRouter()
router.register(r'periods', views.EvaluationPeriodViewSet, basename='period')
router.register(r'competencies', views.CompetencyViewSet, basename='competency')
router.register(r'reviews', views.PerformanceReviewViewSet, basename='review')
router.register(r'details', views.ReviewDetailViewSet, basename='review-detail')

urlpatterns = [
    path('', include(router.urls)),
]
</file>

<file path="backend/recruitment/admin.py">
from django.contrib import admin

# Register your models here.
</file>

<file path="backend/recruitment/apps.py">
from django.apps import AppConfig


class RecruitmentConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'recruitment'
</file>

<file path="backend/recruitment/models.py">
from django.db import models

# Create your models here.
</file>

<file path="backend/recruitment/tests.py">
from django.test import TestCase

# Create your tests here.
</file>

<file path="backend/recruitment/views.py">
from django.shortcuts import render

# Create your views here.
</file>

<file path="backend/talent/migrations/0002_remove_personlanguage_reading_proficiency_and_more.py">
# Generated by Django 5.2.8 on 2025-12-01 20:57

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('core', '0010_alter_historicalperson_birthdate'),
        ('talent', '0001_initial'),
    ]

    operations = [
        migrations.RemoveField(
            model_name='personlanguage',
            name='reading_proficiency',
        ),
        migrations.AddConstraint(
            model_name='personlanguage',
            constraint=models.UniqueConstraint(fields=('person', 'language'), name='unique_person_language', violation_error_message='Esta persona ya tiene registrado este idioma.'),
        ),
    ]
</file>

<file path="backend/talent/migrations/0003_personlanguage_reading_proficiency.py">
# Generated by Django 5.2.8 on 2025-12-01 21:01

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('talent', '0002_remove_personlanguage_reading_proficiency_and_more'),
    ]

    operations = [
        migrations.AddField(
            model_name='personlanguage',
            name='reading_proficiency',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='reading', to='talent.languageproficiency'),
        ),
    ]
</file>

<file path="backend/talent/migrations/0004_fieldofstudy_education_level_alter_fieldofstudy_name_and_more.py">
# Generated by Django 5.2.8 on 2025-12-07 05:55

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('talent', '0003_personlanguage_reading_proficiency'),
    ]

    operations = [
        migrations.AddField(
            model_name='fieldofstudy',
            name='education_level',
            field=models.ForeignKey(blank=True, help_text='Nivel educativo al que pertenece este campo de estudio', null=True, on_delete=django.db.models.deletion.CASCADE, related_name='fields_of_study', to='talent.educationlevel'),
        ),
        migrations.AlterField(
            model_name='fieldofstudy',
            name='name',
            field=models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, help_text='Ej: Software, Recursos Humanos, Diseño Gráfico', max_length=100),
        ),
        migrations.AlterUniqueTogether(
            name='fieldofstudy',
            unique_together={('education_level', 'name')},
        ),
    ]
</file>

<file path="backend/talent/apps.py">
from django.apps import AppConfig


class TalentConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'talent'
</file>

<file path="backend/talent/tests.py">
from django.test import TestCase

# Create your tests here.
</file>

<file path="backend/training/migrations/0001_initial.py">
# Generated by Django 5.2.8 on 2025-11-24 13:12

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('core', '0001_initial'),
    ]

    operations = [
        migrations.CreateModel(
            name='Course',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=200, verbose_name='Nombre del Curso')),
                ('description', models.TextField(blank=True, null=True)),
                ('start_date', models.DateField(verbose_name='Fecha Inicio')),
                ('end_date', models.DateField(verbose_name='Fecha Fin')),
                ('modality', models.CharField(choices=[('PRE', 'Presencial'), ('VIR', 'Virtual (En Vivo / Zoom)'), ('ASY', 'Virtual (Autoaprendizaje)'), ('MIX', 'Híbrido / Mixto')], default='PRE', max_length=3)),
                ('max_participants', models.PositiveIntegerField(default=20, help_text='Límite de estudiantes permitidos.', verbose_name='Cupo Máximo')),
                ('duration_hours', models.PositiveIntegerField(default=0)),
                ('status', models.CharField(choices=[('BOR', 'Borrador'), ('PRO', 'Programado'), ('EJE', 'En Ejecución'), ('FIN', 'Finalizado'), ('CAN', 'Cancelado')], default='BOR', max_length=3)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
            ],
        ),
        migrations.CreateModel(
            name='CourseParticipant',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('role', models.CharField(choices=[('INS', 'Instructor'), ('EST', 'Estudiante')], default='EST', max_length=3)),
                ('status', models.CharField(choices=[('PEN', 'Pendiente'), ('APR', 'Aprobado'), ('REP', 'Reprobado'), ('RET', 'Retirado')], default='PEN', max_length=3)),
                ('grade', models.DecimalField(blank=True, decimal_places=2, max_digits=5, null=True)),
                ('course', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='participants', to='training.course')),
                ('person', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='training_courses', to='core.person')),
            ],
            options={
                'unique_together': {('course', 'person')},
            },
        ),
        migrations.CreateModel(
            name='CourseResource',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=200, verbose_name='Título del Recurso')),
                ('resource_type', models.CharField(choices=[('FIL', 'Archivo (PDF/Doc/Img)'), ('URL', 'Enlace Externo / Video')], default='FIL', max_length=3)),
                ('file', models.FileField(blank=True, null=True, upload_to='training/resources/')),
                ('url', models.URLField(blank=True, help_text='Youtube, Drive, Zoom, etc.', null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('course', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='resources', to='training.course')),
            ],
        ),
        migrations.CreateModel(
            name='CourseSession',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('topic', models.CharField(max_length=200, verbose_name='Tema / Título de la Sesión')),
                ('date', models.DateField(verbose_name='Fecha de la sesión')),
                ('start_time', models.TimeField(verbose_name='Hora Inicio')),
                ('end_time', models.TimeField(verbose_name='Hora Fin')),
                ('course', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='sessions', to='training.course')),
            ],
            options={
                'ordering': ['date', 'start_time'],
            },
        ),
        migrations.CreateModel(
            name='AttendanceRecord',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('status', models.CharField(choices=[('PRE', 'Presente'), ('AUS', 'Ausente'), ('TAR', 'Tardanza'), ('JUS', 'Justificado')], default='AUS', max_length=3)),
                ('notes', models.CharField(blank=True, max_length=255, null=True)),
                ('participant', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='attendance_history', to='training.courseparticipant')),
                ('session', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='attendance_records', to='training.coursesession')),
            ],
            options={
                'unique_together': {('session', 'participant')},
            },
        ),
    ]
</file>

<file path="backend/training/migrations/0002_alter_courseparticipant_status.py">
# Generated by Django 5.2.8 on 2025-11-24 19:28

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('training', '0001_initial'),
    ]

    operations = [
        migrations.AlterField(
            model_name='courseparticipant',
            name='status',
            field=models.CharField(choices=[('PEN', 'Pendiente'), ('APR', 'Aprobado'), ('REP', 'Reprobado'), ('INS', 'Inscrito'), ('RET', 'Retirado')], default='PEN', max_length=3),
        ),
    ]
</file>

<file path="backend/training/migrations/0003_course_cover_image.py">
# Generated by Django 5.2.8 on 2025-11-24 20:24

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('training', '0002_alter_courseparticipant_status'),
    ]

    operations = [
        migrations.AddField(
            model_name='course',
            name='cover_image',
            field=models.ImageField(blank=True, null=True, upload_to='courses/covers/', verbose_name='Imagen de Portada'),
        ),
    ]
</file>

<file path="backend/training/migrations/0004_alter_courseparticipant_status.py">
# Generated by Django 5.2.8 on 2025-11-25 00:07

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('training', '0003_course_cover_image'),
    ]

    operations = [
        migrations.AlterField(
            model_name='courseparticipant',
            name='status',
            field=models.CharField(choices=[('SOL', 'Solicitud Enviada'), ('PEN', 'Pendiente'), ('APR', 'Aprobado'), ('REP', 'Reprobado'), ('INS', 'Inscrito'), ('RET', 'Retirado')], default='PEN', max_length=3),
        ),
    ]
</file>

<file path="backend/training/migrations/0005_alter_courseparticipant_status.py">
# Generated by Django 5.2.8 on 2025-11-25 01:01

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('training', '0004_alter_courseparticipant_status'),
    ]

    operations = [
        migrations.AlterField(
            model_name='courseparticipant',
            name='status',
            field=models.CharField(choices=[('SOL', 'Solicitud Enviada'), ('PEN', 'Pendiente'), ('APR', 'Aprobado'), ('REP', 'Reprobado'), ('INS', 'Inscrito'), ('RET', 'Retirado'), ('REJ', 'Solicitud Rechazada')], default='PEN', max_length=3),
        ),
    ]
</file>

<file path="backend/training/migrations/0006_courseparticipant_academic_status_and_more.py">
# Generated by Django 5.2.8 on 2025-11-26 14:37

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('training', '0005_alter_courseparticipant_status'),
    ]

    operations = [
        migrations.AddField(
            model_name='courseparticipant',
            name='academic_status',
            field=models.CharField(choices=[('NEV', 'No Evaluado / N/A'), ('PEN', 'En Curso / Pendiente'), ('APR', 'Aprobado'), ('REP', 'Reprobado')], default='NEV', max_length=3, verbose_name='Estado Académico'),
        ),
        migrations.AddField(
            model_name='courseparticipant',
            name='enrollment_status',
            field=models.CharField(choices=[('REQ', 'Solicitud Enviada'), ('ENR', 'Inscrito / Matriculado'), ('REJ', 'Solicitud Rechazada'), ('DRP', 'Retirado')], default='REQ', max_length=3, verbose_name='Estado de Inscripción'),
        ),
        migrations.AlterField(
            model_name='courseparticipant',
            name='status',
            field=models.CharField(choices=[('SOL', 'Solicitud Enviada'), ('PEN', 'Pendiente'), ('APR', 'Aprobado'), ('REP', 'Reprobado'), ('INS', 'Inscrito'), ('RET', 'Retirado'), ('REJ', 'Solicitud Rechazada')], default='PEN', max_length=3, null=True),
        ),
    ]
</file>

<file path="backend/training/migrations/0007_auto_20251126_1037.py">
from django.db import migrations

def migrate_status(apps, schema_editor):
    CourseParticipant = apps.get_model('training', 'CourseParticipant')
    for participant in CourseParticipant.objects.all():
        old_status = participant.status
        
        # Mapeo: 'SOL' -> ('REQ', 'NEV')
        if old_status == 'SOL':
            participant.enrollment_status = 'REQ'
            participant.academic_status = 'NEV'
        # Mapeo: 'INS' -> ('ENR', 'PEN')
        elif old_status == 'INS':
            participant.enrollment_status = 'ENR'
            participant.academic_status = 'PEN'
        # Mapeo: 'PEN' -> ('ENR', 'PEN')
        elif old_status == 'PEN':
            participant.enrollment_status = 'ENR'
            participant.academic_status = 'PEN'
        # Mapeo: 'APR' -> ('ENR', 'APR')
        elif old_status == 'APR':
            participant.enrollment_status = 'ENR'
            participant.academic_status = 'APR'
        # Mapeo: 'REP' -> ('ENR', 'REP')
        elif old_status == 'REP':
            participant.enrollment_status = 'ENR'
            participant.academic_status = 'REP'
        # Mapeo: 'REJ' -> ('REJ', 'NEV')
        elif old_status == 'REJ':
            participant.enrollment_status = 'REJ'
            participant.academic_status = 'NEV'
        # Mapeo: 'RET' -> ('DRP', 'NEV')
        elif old_status == 'RET':
            participant.enrollment_status = 'DRP'
            participant.academic_status = 'NEV'
            
        participant.save()

class Migration(migrations.Migration):

    dependencies = [
        ('training', '0006_courseparticipant_academic_status_and_more'),
    ]

    operations = [
        migrations.RunPython(migrate_status),
    ]
</file>

<file path="backend/training/migrations/0008_remove_courseparticipant_status.py">
# Generated by Django 5.2.8 on 2025-11-26 14:42

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ('training', '0007_auto_20251126_1037'),
    ]

    operations = [
        migrations.RemoveField(
            model_name='courseparticipant',
            name='status',
        ),
    ]
</file>

<file path="backend/training/migrations/0009_course_is_public_department.py">
# Generated manually

from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    dependencies = [
        ('core', '0001_initial'),
        ('organization', '0001_initial'),
        ('training', '0008_remove_courseparticipant_status'),
    ]

    operations = [
        migrations.AddField(
            model_name='course',
            name='is_public',
            field=models.BooleanField(default=True, help_text='Si es público, todos pueden ver el curso. Si es privado, solo el departamento asignado.', verbose_name='Curso Público'),
        ),
        migrations.AddField(
            model_name='course',
            name='department',
            field=models.ForeignKey(blank=True, help_text='Departamento al que pertenece este curso (solo si es privado)', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='courses', to='organization.department', verbose_name='Departamento'),
        ),
    ]
</file>

<file path="backend/training/migrations/0010_alter_courseparticipant_academic_status_and_more.py">
# Generated by Django 5.2.8 on 2025-12-02 09:23

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('training', '0009_course_is_public_department'),
    ]

    operations = [
        migrations.AlterField(
            model_name='courseparticipant',
            name='academic_status',
            field=models.CharField(choices=[('PEN', 'En Curso'), ('APR', 'Aprobado'), ('REP', 'Reprobado')], default='PEN', max_length=3, verbose_name='Estado Académico'),
        ),
        migrations.AlterField(
            model_name='courseparticipant',
            name='enrollment_status',
            field=models.CharField(choices=[('REQ', 'Solicitud Enviada'), ('ENR', 'Inscrito'), ('REJ', 'Solicitud Rechazada')], default='REQ', max_length=3, verbose_name='Estado de Inscripción'),
        ),
    ]
</file>

<file path="backend/training/migrations/0011_course_instructor.py">
# Generated manually - refactor instructor model

from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    dependencies = [
        ('core', '0010_alter_historicalperson_birthdate'),
        ('training', '0010_alter_courseparticipant_academic_status_and_more'),
    ]

    operations = [
        # Add instructor field to Course
        migrations.AddField(
            model_name='course',
            name='instructor',
            field=models.ForeignKey(
                blank=True, 
                null=True, 
                on_delete=django.db.models.deletion.SET_NULL,
                related_name='courses_taught', 
                to='core.person',
                verbose_name='Instructor'
            ),
        ),
    ]
</file>

<file path="backend/training/migrations/0012_migrate_instructors_data.py">
# Generated manually - migrate instructor data

from django.db import migrations


def migrate_instructors_to_course(apps, schema_editor):
    """
    Migra instructores de CourseParticipant a Course.instructor
    """
    Course = apps.get_model('training', 'Course')
    CourseParticipant = apps.get_model('training', 'CourseParticipant')
    
    # Encuentra todos los participantes con role='INS'
    instructor_participants = CourseParticipant.objects.filter(role='INS')
    
    migrated_count = 0
    skipped_count = 0
    
    for participant in instructor_participants:
        course = participant.course
        
        if course.instructor is None:
            # Asignar instructor al curso
            course.instructor = participant.person
            course.save()
            migrated_count += 1
            print(f"✅ Migrado instructor {participant.person} a curso '{course.name}'")
        else:
            # Ya existe un instructor, registrar warning
            print(f"⚠️  Curso '{course.name}' ya tiene instructor {course.instructor}, " 
                  f"omitiendo {participant.person}")
            skipped_count += 1
    
    # Eliminar todos los participantes con role='INS'
    deleted_count, _ = CourseParticipant.objects.filter(role='INS').delete()
    
    print(f"\n📊 Resumen:")
    print(f"   - Instructores migrados: {migrated_count}")
    print(f"   - Duplicados omitidos: {skipped_count}")
    print(f"   - Registros eliminados: {deleted_count}")


def reverse_migration(apps, schema_editor):
    """
    Revierte la migración: mueve instructores de vuelta a CourseParticipant
    """
    Course = apps.get_model('training', 'Course')
    CourseParticipant = apps.get_model('training', 'CourseParticipant')
    
    courses_with_instructor = Course.objects.exclude(instructor__isnull=True)
    
    for course in courses_with_instructor:
        # Recrear participante instructor
        CourseParticipant.objects.create(
            course=course,
            person=course.instructor,
            role='INS',
            enrollment_status='ENR'
        )
        print(f"↩️  Revertido instructor {course.instructor} en curso '{course.name}'")


class Migration(migrations.Migration):

    dependencies = [
        ('training', '0011_course_instructor'),
    ]

    operations = [
        migrations.RunPython(
            migrate_instructors_to_course,
            reverse_migration
        ),
    ]
</file>

<file path="backend/training/migrations/0013_remove_courseparticipant_role.py">
# Generated manually - remove role field

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ('training', '0012_migrate_instructors_data'),
    ]

    operations = [
        migrations.RemoveField(
            model_name='courseparticipant',
            name='role',
        ),
    ]
</file>

<file path="backend/training/migrations/0014_courseparticipant_created_at.py">
from django.db import migrations, models
import django.utils.timezone

class Migration(migrations.Migration):

    dependencies = [
        ('training', '0013_remove_courseparticipant_role'),
    ]

    operations = [
        migrations.AddField(
            model_name='courseparticipant',
            name='created_at',
            field=models.DateTimeField(auto_now_add=True, default=django.utils.timezone.now, verbose_name='Fecha de Solicitud'),
            preserve_default=False,
        ),
    ]
</file>

<file path="backend/training/migrations/0015_course_requires_approval_to_complete_and_more.py">
# Generated by Django 5.2.8 on 2025-12-02 22:36

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('training', '0014_courseparticipant_created_at'),
    ]

    operations = [
        migrations.AddField(
            model_name='course',
            name='requires_approval_to_complete',
            field=models.BooleanField(default=False, help_text='Si es True, el instructor debe asignar nota manualmente. Si es False, se completa automáticamente al terminar todas las lecciones.', verbose_name='Requiere Aprobación Manual'),
        ),
        migrations.AlterField(
            model_name='courseparticipant',
            name='academic_status',
            field=models.CharField(choices=[('PEN', 'En Curso'), ('COM', 'Completado'), ('APR', 'Aprobado'), ('REP', 'Reprobado')], default='PEN', max_length=3, verbose_name='Estado Académico'),
        ),
        migrations.CreateModel(
            name='CourseModule',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=200, verbose_name='Nombre del Módulo')),
                ('description', models.TextField(blank=True, null=True, verbose_name='Descripción')),
                ('order', models.PositiveIntegerField(default=0, verbose_name='Orden')),
                ('course', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='modules', to='training.course')),
            ],
            options={
                'verbose_name': 'Módulo del Curso',
                'verbose_name_plural': 'Módulos del Curso',
                'ordering': ['order'],
                'unique_together': {('course', 'order')},
            },
        ),
        migrations.CreateModel(
            name='CourseLesson',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('title', models.CharField(max_length=200, verbose_name='Título de la Lección')),
                ('content', models.TextField(help_text='Contenido en formato de texto enriquecido', verbose_name='Contenido')),
                ('order', models.PositiveIntegerField(default=0, verbose_name='Orden')),
                ('duration_minutes', models.PositiveIntegerField(default=0, verbose_name='Duración (minutos)')),
                ('module', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='lessons', to='training.coursemodule')),
            ],
            options={
                'verbose_name': 'Lección',
                'verbose_name_plural': 'Lecciones',
                'ordering': ['order'],
                'unique_together': {('module', 'order')},
            },
        ),
        migrations.CreateModel(
            name='LessonProgress',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('completed', models.BooleanField(default=False, verbose_name='Completada')),
                ('completed_at', models.DateTimeField(blank=True, null=True, verbose_name='Fecha de Completitud')),
                ('enrollment', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='lesson_progress', to='training.courseparticipant')),
                ('lesson', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='progress_records', to='training.courselesson')),
            ],
            options={
                'verbose_name': 'Progreso de Lección',
                'verbose_name_plural': 'Progreso de Lecciones',
                'unique_together': {('enrollment', 'lesson')},
            },
        ),
    ]
</file>

<file path="backend/training/migrations/0016_courselesson_file_courselesson_url_and_more.py">
# Generated by Django 5.2.8 on 2025-12-02 23:32

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('training', '0015_course_requires_approval_to_complete_and_more'),
    ]

    operations = [
        migrations.AddField(
            model_name='courselesson',
            name='file',
            field=models.FileField(blank=True, null=True, upload_to='training/lessons/', verbose_name='Archivo Adjunto'),
        ),
        migrations.AddField(
            model_name='courselesson',
            name='url',
            field=models.URLField(blank=True, help_text='Video de Youtube, Zoom, etc.', null=True, verbose_name='Enlace Externo'),
        ),
        migrations.AlterField(
            model_name='courselesson',
            name='content',
            field=models.TextField(blank=True, help_text='Contenido en formato de texto enriquecido', null=True, verbose_name='Contenido'),
        ),
    ]
</file>

<file path="backend/training/migrations/0017_remove_courselesson_file_remove_courselesson_url_and_more.py">
# Generated by Django 5.2.8 on 2025-12-03 00:06

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('training', '0016_courselesson_file_courselesson_url_and_more'),
    ]

    operations = [
        migrations.RemoveField(
            model_name='courselesson',
            name='file',
        ),
        migrations.RemoveField(
            model_name='courselesson',
            name='url',
        ),
        migrations.AddField(
            model_name='courseresource',
            name='lesson',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, related_name='resources', to='training.courselesson'),
        ),
    ]
</file>

<file path="backend/training/apps.py">
from django.apps import AppConfig


class TrainingConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'training'
</file>

<file path="backend/training/services.py">
"""
Business logic services for the Training module.
Contains reusable business logic separated from views and serializers.
"""

from django.utils import timezone
from django.db.models import Count, Q
from .models import Course, CourseParticipant, CourseModule, CourseLesson, LessonProgress


def calculate_course_progress(enrollment_id):
    """
    Calcula el porcentaje de progreso de un estudiante en un curso.
    
    Args:
        enrollment_id: ID del CourseParticipant (enrollment)
    
    Returns:
        dict: {
            'total_lessons': int,
            'completed_lessons': int,
            'progress_percentage': float,
            'is_complete': bool
        }
    """
    try:
        enrollment = CourseParticipant.objects.get(id=enrollment_id)
    except CourseParticipant.DoesNotExist:
        return {
            'total_lessons': 0,
            'completed_lessons': 0,
            'progress_percentage': 0.0,
            'is_complete': False,
            'error': 'Enrollment not found'
        }
    
    course = enrollment.course
    
    # Contar lecciones totales en el curso
    total_lessons = CourseLesson.objects.filter(
        module__course=course
    ).count()
    
    if total_lessons == 0:
        return {
            'total_lessons': 0,
            'completed_lessons': 0,
            'progress_percentage': 0.0,
            'is_complete': False
        }
    
    # Contar lecciones completadas por el estudiante
    completed_lessons = LessonProgress.objects.filter(
        enrollment=enrollment,
        completed=True
    ).count()
    
    progress_percentage = (completed_lessons / total_lessons) * 100
    is_complete = progress_percentage == 100
    
    return {
        'total_lessons': total_lessons,
        'completed_lessons': completed_lessons,
        'progress_percentage': round(progress_percentage, 2),
        'is_complete': is_complete
    }


def check_course_completion(enrollment_id):
    """
    Verifica si un estudiante ha completado el curso y actualiza su estado según las reglas:
    
    - Si completa 100% de lecciones + requires_approval_to_complete=False:
      → Auto-completa (academic_status = COMPLETED)
    
    - Si completa 100% de lecciones + requires_approval_to_complete=True:
      → NO auto-completa; el instructor debe asignar nota manualmente
    
    Args:
        enrollment_id: ID del CourseParticipant (enrollment)
    
    Returns:
        dict: {
            'status': str ('auto_completed', 'pending_grading', 'in_progress'),
            'message': str,
            'progress': dict (from calculate_course_progress)
        }
    """
    try:
        enrollment = CourseParticipant.objects.get(id=enrollment_id)
    except CourseParticipant.DoesNotExist:
        return {
            'status': 'error',
            'message': 'Enrollment not found',
            'progress': None
        }
    
    course = enrollment.course
    progress = calculate_course_progress(enrollment_id)
    
    # Si no hay lecciones, no podemos completar
    if progress['total_lessons'] == 0:
        return {
            'status': 'no_content',
            'message': 'El curso no tiene lecciones aún',
            'progress': progress
        }
    
    # Si NO ha completado el 100%, seguimos en progreso
    if not progress['is_complete']:
        return {
            'status': 'in_progress',
            'message': f"Progreso: {progress['progress_percentage']}%",
            'progress': progress
        }
    
    # Si YA completó el 100%:
    # Escenario A: Auto-completar (no requiere aprobación manual)
    if not course.requires_approval_to_complete:
        # Solo auto-completar si aún no está completado
        if enrollment.academic_status != CourseParticipant.AcademicStatus.COMPLETED:
            enrollment.academic_status = CourseParticipant.AcademicStatus.COMPLETED
            enrollment.save()
            
            return {
                'status': 'auto_completed',
                'message': 'Curso completado automáticamente al finalizar todas las lecciones',
                'progress': progress
            }
        else:
            return {
                'status': 'already_completed',
                'message': 'El curso ya estaba completado',
                'progress': progress
            }
    
    # Escenario B: Requiere calificación manual del instructor
    return {
        'status': 'pending_grading',
        'message': 'Has completado todas las lecciones. Pendiente de evaluación por el instructor.',
        'progress': progress
    }


def mark_lesson_as_complete(enrollment_id, lesson_id):
    """
    Marca una lección como completada para un estudiante y verifica si se completó el curso.
    
    Args:
        enrollment_id: ID del CourseParticipant (enrollment)
        lesson_id: ID del CourseLesson
    
    Returns:
        dict: {
            'lesson_progress': LessonProgress object,
            'completion_check': dict (from check_course_completion)
        }
    """
    try:
        enrollment = CourseParticipant.objects.get(id=enrollment_id)
        lesson = CourseLesson.objects.get(id=lesson_id)
    except (CourseParticipant.DoesNotExist, CourseLesson.DoesNotExist) as e:
        return {
            'error': str(e),
            'lesson_progress': None,
            'completion_check': None
        }
    
    # Crear o actualizar el progreso de la lección
    lesson_progress, created = LessonProgress.objects.get_or_create(
        enrollment=enrollment,
        lesson=lesson,
        defaults={'completed': True, 'completed_at': timezone.now()}
    )
    
    if not created and not lesson_progress.completed:
        # Si ya existía pero no estaba completada, la marcamos como completada
        lesson_progress.completed = True
        lesson_progress.completed_at = timezone.now()
        lesson_progress.save()
    
    # Verificar si el curso se completó
    completion_check = check_course_completion(enrollment_id)
    
    return {
        'lesson_progress': lesson_progress,
        'completion_check': completion_check
    }
</file>

<file path="backend/training/tests.py">
from django.test import TestCase

# Create your tests here.
</file>

<file path="backend/.python-version">
3.13
</file>

<file path="backend/cleanup_positions.py">
import os
import django
from django.db.models import Count

os.environ.setdefault("DJANGO_SETTINGS_MODULE", "config.settings")
django.setup()

from organization.models import Position
from employment.models import Employment

def clean_duplicates():
    print("Searching for duplicate positions...")
    duplicates = Position.objects.values('department', 'job_title').annotate(
        count=Count('id')
    ).filter(count__gt=1)

    for dup in duplicates:
        dept_id = dup['department']
        job_id = dup['job_title']
        
        positions = Position.objects.filter(department_id=dept_id, job_title_id=job_id).order_by('created_at')
        
        # Keep the first one, delete the rest
        primary = positions.first()
        others = positions[1:]
        
        print(f"Found {len(others) + 1} duplicates for Dept {dept_id} / Job {job_id}. Keeping ID {primary.id}.")
        
        for pos in others:
            print(f"  - Merging Position {pos.id} into {primary.id}...")
            
            # Reassign Employments
            Employment.objects.filter(position=pos).update(position=primary)
            
            # Reassign Direct Reports (Manager Position)
            Position.objects.filter(manager_position=pos).update(manager_position=primary)
            
            # Delete the duplicate
            pos.delete()
            print(f"  - Position {pos.id} deleted.")

    print("Cleanup complete.")

if __name__ == "__main__":
    clean_duplicates()
</file>

<file path="backend/cleanup_resources.py">
import os
import django

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')
django.setup()

from training.models import CourseResource

def cleanup():
    print("Cleaning up resources without lessons...")
    count = CourseResource.objects.filter(lesson__isnull=True).count()
    print(f"Found {count} resources without lessons.")
    if count > 0:
        CourseResource.objects.filter(lesson__isnull=True).delete()
        print("Deleted resources without lessons.")
    else:
        print("No resources to delete.")

if __name__ == "__main__":
    cleanup()
</file>

<file path="backend/create_ats_test_data.py">
"""
Script para crear datos de prueba del módulo ATS
"""
import os
import django
from datetime import date, timedelta

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')
django.setup()

from organization.models import Department, JobTitle, Position
from ats.models import JobPosting

# Limpiar datos anteriores de ATS
print("Limpiando datos anteriores...")
JobPosting.objects.all().delete()

# Crear departamentos si no existen
print("Creando departamentos...")
it_dept, _ = Department.objects.get_or_create(name="Tecnología e Informática")
rrhh_dept, _ = Department.objects.get_or_create(name="Recursos Humanos")
admin_dept, _ = Department.objects.get_or_create(name="Administración")

# Crear job titles
print("Creando job titles...")
dev_title, _ = JobTitle.objects.get_or_create(
    name="Desarrollador Full Stack",
    defaults={'description': 'Desarrollador de software con experiencia en frontend y backend'}
)
hr_title, _ = JobTitle.objects.get_or_create(
    name="Analista de RRHH",
    defaults={'description': 'Analista de recursos humanos'}
)
admin_title, _ = JobTitle.objects.get_or_create(
    name="Asistente Administrativo",
    defaults={'description': 'Asistente en tareas administrativas'}
)

# Crear posiciones
print("Creando posiciones...")
dev_position, _ = Position.objects.get_or_create(
    department=it_dept,
    job_title=dev_title,
    defaults={'vacancies': 2}
)
hr_position, _ = Position.objects.get_or_create(
    department=rrhh_dept,
    job_title=hr_title,
    defaults={'vacancies': 1}
)
admin_position, _ = Position.objects.get_or_create(
    department=admin_dept,
    job_title=admin_title,
    defaults={'vacancies': 1}
)

# Crear vacantes publicadas
print("Creando vacantes...")

# Vacante 1: Desarrollador (pide educación, experiencia y portafolio)
job1 = JobPosting.objects.create(
    title="Desarrollador Full Stack Senior",
    description="""Buscamos un desarrollador full stack con sólida experiencia en tecnologías modernas.

Responsabilidades:
- Diseñar y desarrollar aplicaciones web escalables
- Colaborar con el equipo en la arquitectura de soluciones
- Mantener y optimizar sistemas existentes
- Participar en code reviews y mentoría

Ofrecemos:
- Ambiente de trabajo dinámico e innovador
- Oportunidades de crecimiento profesional
- Capacitación continua en nuevas tecnologías
- Beneficios competitivos""",
    position=dev_position,
    department=it_dept,
    salary_range="$1,200 - $2,000 USD",
    location="Caracas / Remoto",
    ask_education=True,
    ask_experience=True,
    ask_portfolio=True,
    status='PUBLISHED',
    published_date=date.today(),
    closing_date=date.today() + timedelta(days=30)
)

# Vacante 2: Analista RRHH (pide educación, NO experiencia, NO portafolio)
job2 = JobPosting.objects.create(
    title="Analista de Recursos Humanos Junior",
    description="""Estamos en búsqueda de un Analista de RRHH para unirse a nuestro equipo.

Responsabilidades:
- Apoyar en procesos de reclutamiento y selección
- Gestionar expedientes de personal
- Coordinar capacitaciones y desarrollo
- Participar en evaluaciones de desempeño

Requisitos:
- Título universitario en RRHH, Psicología o afines
- Excelentes habilidades de comunicación
- Capacidad de trabajo en equipo
- Manejo de MS Office

Ofrecemos:
- Oportunidad de aprender y crecer
- Ambiente laboral positivo
- Beneficios de ley y adicionales""",
    position=hr_position,
    department=rrhh_dept,
    salary_range="$800 - $1,000 USD",
    location="Caracas",
    ask_education=True,
    ask_experience=False,
    ask_portfolio=False,
    status='PUBLISHED',
    published_date=date.today(),
    closing_date=date.today() + timedelta(days=45)
)

# Vacante 3: Asistente Administrativo (NO pide educación, NO experiencia, NO portafolio)
job3 = JobPosting.objects.create(
    title="Asistente Administrativo",
    description="""Necesitamos un Asistente Administrativo organizado y proactivo.

Responsabilidades:
- Gestión de documentos y archivo
- Atención telefónica y recepción
- Apoyo en tareas administrativas generales
- Coordinación de reuniones y eventos

Requisitos:
- Bachiller o estudiante universitario
- Experiencia deseable pero no excluyente
- Manejo de herramientas ofimáticas
- Excelente actitud de servicio

Ofrecemos:
- Estabilidad laboral
- Horario flexible
- Ambiente de trabajo agradable""",
    position=admin_position,
    department=admin_dept,
    salary_range="$500 - $700 USD",
    location="Caracas",
    ask_education=False,
    ask_experience=False,
    ask_portfolio=False,
    status='PUBLISHED',
    published_date=date.today(),
    closing_date=date.today() + timedelta(days=60)
)

# Agregar objetivos y requisitos a las posiciones
print("Agregando objetivos y requisitos...")

# Objetivos para Desarrollador
dev_position.objectives.get_or_create(description="Desarrollar software de alta calidad que cumpla con los estándares de la industria")
dev_position.objectives.get_or_create(description="Innovar en la implementación de nuevas tecnologías")
dev_position.objectives.get_or_create(description="Colaborar efectivamente con equipos multidisciplinarios")

dev_position.requirements.get_or_create(description="Experiencia mínima de 3 años en desarrollo web")
dev_position.requirements.get_or_create(description="Dominio de JavaScript/TypeScript y frameworks modernos (React, Next.js)")
dev_position.requirements.get_or_create(description="Experiencia con Python/Django o Node.js")
dev_position.requirements.get_or_create(description="Conocimientos de bases de datos SQL y NoSQL")
dev_position.requirements.get_or_create(description="Inglés técnico nivel intermedio")

# Objetivos para Analista RRHH
hr_position.objectives.get_or_create(description="Atraer y retener el mejor talento para la organización")
hr_position.objectives.get_or_create(description="Mantener la satisfacción y desarrollo del personal")

hr_position.requirements.get_or_create(description="Título universitario en carreras afines")
hr_position.requirements.get_or_create(description="Habilidades de comunicación efectiva")
hr_position.requirements.get_or_create(description="Capacidad de análisis y organización")

# Objetivos para Asistente
admin_position.objectives.get_or_create(description="Garantizar el funcionamiento eficiente de las operaciones administrativas")
admin_position.requirements.get_or_create(description="Bachiller completo")
admin_position.requirements.get_or_create(description="Manejo básico de computadoras")

print("\n✅ Datos de prueba creados exitosamente!")
print(f"\nVacantes creadas:")
print(f"1. {job1.title} - {job1.department.name}")
print(f"   Pide: Educación✓ Experiencia✓ Portafolio✓")
print(f"2. {job2.title} - {job2.department.name}")
print(f"   Pide: Educación✓ Experiencia✗ Portafolio✗")
print(f"3. {job3.title} - {job3.department.name}")
print(f"   Pide: Educación✗ Experiencia✗ Portafolio✗")
print(f"\n👉 Accede a http://localhost:3000/ para ver el portal público")
</file>

<file path="backend/create_education_data.py">
"""
Script para crear datos de prueba de Educación (Niveles y Áreas)
"""
import os
import django

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')
django.setup()

from talent.models import EducationLevel, FieldOfStudy

print("Creando niveles educativos...")
levels = [
    "Bachillerato",
    "Técnico Superior Universitario",
    "Licenciatura",
    "Ingeniería",
    "Maestría",
    "Doctorado"
]

for name in levels:
    EducationLevel.objects.get_or_create(name=name)
    print(f"- {name}")

print("\nCreando áreas de estudio...")
fields = [
    "Informática y Sistemas",
    "Recursos Humanos",
    "Administración de Empresas",
    "Contaduría Pública",
    "Educación",
    "Diseño Gráfico",
    "Psicología Industrial"
]

for name in fields:
    FieldOfStudy.objects.get_or_create(name=name)
    print(f"- {name}")

print("\n✅ Datos de educación creados exitosamente!")
</file>

<file path="backend/generate_complete_org_fixtures.py">
#!/usr/bin/env python3
"""
SCRIPT COMPLETO para generar initial_data.json con TODOS los datos del manual
"""
import json

data = []

# ===== DEPARTMENTS =====
departments_data = [
    (1, "Dirección", None),
    (2, "Subdirección Académica", 1),
    (3, "Coordinación de Control de Estudios y Evaluación", 2),
    (4, "Coordinación Administrativa", 1),
    (5, "Coordinación de Pasant

ías", 2),
    (6, "Coordinación de Informática", 2),
    (7, "Coordinación de Preescolar", 2),
    (8, "Coordinación de Investigación, Extensión y Postgrado", 2),
    (9, "Biblioteca", 2),
]

for pk, name, parent in departments_data:
    data.append({"model": "organization.department", "pk": pk, "fields": {"name": name, "parent": parent}})

# ===== JOB TITLES =====
jobtitles_data = [
    (1, "Director"), (2, "Subdirector"), (3, "Coordinador"), (4, "Jefe"),
    (5, "Asesor"), (6, "Secretaria"), (7, "Recepcionista"), (8, "Asistente"),
    (9, "Personal de Mantenimiento"), (10, "Personal de Limpieza"), (11, "Auxiliar"),
]

for pk, name in jobt

itles_data:
    data.append({"model": "organization.jobtitle", "pk": pk, "fields": {"name": name}})

# ===== POSITIONS =====
# Shortened objectives for brevity
positions_data = [
    (1, 1, 1, 1, "Planificar, organizar, dirigir y controlar todas las actividades que se realizan en la Extensión desde el punto de vista administrativo y académico. A través del liderazgo, la supervisión y delegación de funciones, se responsabiliza por la buena marcha de la Institución dentro del marco de la misión, visión, valores, políticas, objetivos y planes establecidos por la Dirección Nacional, asegurándose de que éstos sean ejecutados."),
    (2, 1, 5, 1, "Gestionar la imagen institucional y la comunicación externa del Instituto, estableciendo vínculos efectivos con los medios de comunicación y organismos públicos o privados para promover la oferta académica y las actividades de la extensión."),
    (3, 1, 6, 1, "Brindar apoyo administrativo y secretarial de alto nivel a la Dirección, gestionando la agenda, la correspondencia y la atención al público, garantizando la confidencialidad y fluidez de la información en el despacho del Director."),
    (4, 1, 7, 1, "Atender a los visitantes que acuden a la Extensión a solicitar información y operar la central telefónica para recibir y efectuar las llamadas que le sean solicitadas."),
   (5, 2, 2, 1, "Prestar ayuda, apoyo y respaldo a la Jefatura de la Extensión, con el objeto de aportar su contribución, supervisando conjuntamente con el Jefe de la Extensión el desarrollo de las actividades que en las áreas académico-administrativo, deben realizarse para así mantener un mejor desenvolvimiento de la ejecución de todas las actividades de la Institución."),
    (6, 2, 8, 1, "Asistir a la Subdirección Académica en la gestión operativa y administrativa de los procesos docentes, manteniendo actualizados los registros del personal, horarios y programación académica para garantizar el flujo eficiente de la información."),
    (7, 3, 3, 1, "Planificar, organizar, coordinar y controlar las actividades de la Coordinación de Control de Estudios y Evaluación, desarrollando el programa de seguimiento de los estudiantes y profesores, para el registro de la documentación que deba procesarse a fin de garantizar el fiel cumplimiento de los objetivos de esta área."),
    (8, 3, 8, 1, "Ejecutar los procesos operativos de inscripción, registro y control de notas, así como brindar soporte técnico en la emisión de documentos académicos, asegurando la integridad de los datos de los estudiantes."),
    (9, 3, 6, 1, "Atender directamente las solicitudes de los estudiantes y docentes en taquilla, organizando los expedientes y archivos físicos de notas, garantizando un servicio eficiente y ordenado en el departamento."),
    (10, 4, 3, 1, "Planificar, coordinar, supervisar y evaluar las actividades administrativas de la Extensión, conducir y verificar los procedimientos administrativos vigentes así como los Registros Contables que se realizan en esta unidad, administrar las nóminas académicas y administrativas y ejecutar los pagos correspondientes a proveedores, para así lograr el buen funcionamiento administrativo de la Institución."),
    (11, 4, 8, 1, "Apoyar en la ejecución de los procesos administrativos contables, gestionando pagos de servicios, suministros y atención a requerimientos logísticos de los departamentos, asegurando el soporte necesario para la operatividad de la extensión."),
    (12, 4, 9, 2, "Garantizar la operatividad de la infraestructura física y el mobiliario de la Institución, realizando reparaciones menores y mantenimiento preventivo a las instalaciones y equipos para asegurar un ambiente funcional."),
    (13, 4, 10, 3, "Mantener en óptimas condiciones de higiene y aseo todas las áreas de la Institución, asegurando un ambiente limpio y agradable para el desarrollo de las actividades académicas y administrativas."),
    (14, 5, 3, 1, "Planificar, coordinar, supervisar, evaluar y controlar la ejecución de los programas de Pasantías y Trabajo Especial de Grado, a través del cumplimiento de los procedimientos vigentes que permitan realizar su seguimiento y evaluación."),
    (15, 5, 8, 1, "Apoyar en la gestión administrativa y logística de la Coordinación, sirviendo de enlace entre los estudiantes, tutores y la coordinación, facilitando el procesamiento de documentos y la atención a los requerimientos del proceso de pasantías."),
    (16, 6, 3, 1, "Bajo supervisión de la Jefatura de la Extensión administra en detalle las funciones relativas al área de la Coordinación de Informática, vigilando el cumplimiento de los programas establecidos y asignados a su gestión. Presta apoyo y atención al profesorado de esta área y es responsable del buen funcionamiento del Laboratorio de Informática."),
    (17, 6, 8, 1, "Coordinar y dirigir las actividades académicas de los estudiantes dentro del Laboratorio, prestando apoyo a los docentes y a la coordinación de las Carreras correspondientes, así como velar por el mantenimiento preventivo de los equipos."),
    (18, 7, 3, 1, "Bajo supervisión de la Jefatura de la Extensión, coordina y dirige las actividades y programas establecidos para el área de Educación Preescolar, orientando su cumplimiento por parte del personal docente y organizando con el alumno lo relativo a las prácticas de la especialidad."),
    (19, 7, 8, 1, "Asistir administrativamente a la Coordinación de Preescolar, apoyando en la organización de archivos, atención al público y gestión de los procesos de prácticas profesion

ales, asegurando la continuidad operativa en ausencia del Coordinador."),
    (20, 8, 3, 1, "Promover, planificar y coordinar el desarrollo de la investigación científica, las actividades de extensión cultural y deportiva, y los estudios de postgrado, vinculando a la institución con su entorno y fomentando la formación continua de la comunidad Iutirlista."),
    (21, 9, 4, 1, "Administrar, coordinar y supervisar los servicios bibliotecarios de la Institución, garantizando la organización, actualización y conservación del acervo bibliográfico, así como la prestación de un servicio eficiente a la comunidad universitaria."),
    (22, 9, 8, 1, "Atender a los estudiantes, personal docente y administrativo, para suministrarles la bibliografía que soliciten en la realización de investigaciones que favorezcan el proceso de enseñanza-aprendizaje, apoyando en la catalogación y control del material."),
    (23, 9, 11, 2, "Apoyar en las labores operativas de la biblioteca, encargándose del préstamo, devolución, ordenamiento de textos y atención primaria al usuario, contribuyendo al mantenimiento del orden y la conservación del material."),
]

for pk, dept, jt, vac, obj in positions_data:
    data.append({"model": "organization.position", "pk": pk, "fields": {"department": dept, "job_title": jt, "vacancies": vac, "objective": obj}})

print(f"Generated {len(data)} base entries (depts+jobs+positions)")

# Export to JSON
with open('organization/fixtures/initial_data.json', 'w', encoding='utf-8') as f:
    json.dump(data, f, ensure_ascii=False, indent=2)

print(f"Saved to organization/fixtures/initial_data.json ({len(data)} entries)")
print("NOTE: Requirements and Functions need to be added manually or via expanded script")
</file>

<file path="backend/generate_org_fixtures.py">
#!/usr/bin/env python3
"""
Script para generar initial_data.json completo con requirements y functions
"""
import json

# Base data
data = []

# Departments
departments_data = [
    (1, "Dirección", None),
    (2, "Subdirección Académica", 1),
    (3, "Coordinación de Control de Estudios y Evaluación", 2),
    (4, "Coordinación Administrativa", 1),
    (5, "Coordinación de Pasantías", 2),
    (6, "Coordinación de Informática", 2),
    (7, "Coordinación de Preescolar", 2),
    (8, "Coordinación de Investigación, Extensión y Postgrado", 2),
    (9, "Biblioteca", 2),
]

for pk, name, parent in departments_data:
    data.append({
        "model": "organization.department",
        "pk": pk,
        "fields": {"name": name, "parent": parent}
    })

# JobTitles
jobtitles_data = [
    (1, "Director"), (2, "Subdirector"), (3, "Coordinador"), (4, "Jefe"),
    (5, "Asesor"), (6, "Secretaria"), (7, "Recepcionista"), (8, "Asistente"),
    (9, "Personal de Mantenimiento"), (10, "Personal de Limpieza"), (11, "Auxiliar"),
]

for pk, name in jobtitles_data:
    data.append({
        "model": "organization.jobtitle",
        "pk": pk,
        "fields": {"name": name}
    })

# Positions with objectives
positions_data = [
    # (pk, dept, jobtitle, vacancies, objective)
    (1, 1, 1, 1, "Planificar, organizar, dirigir y controlar todas las actividades que se realizan en la Extensión desde el punto de vista administrativo y académico."),
    (2, 1, 5, 1, "Gestionar la imagen institucional y la comunicación externa del Instituto."),
    (3, 1, 6, 1, "Brindar apoyo administrativo y secretarial de alto nivel a la Dirección."),
    (4, 1, 7, 1, "Atender a los visitantes que acuden a la Extensión a solicitar información."),
    (5, 2, 2, 1, "Prestar ayuda, apoyo y respaldo a la Jefatura de la Extensión."),
    (6, 2, 8, 1, "Asistir a la Subdirección Académica en la gestión operativa."),
    (7, 3, 3, 1, "Planificar, organizar, coordinar y controlar las actividades de Control de Estudios."),
    (8, 3, 8, 1, "Ejecutar los procesos operativos de inscripción y registro."),
    (9, 3, 6, 1, "Atender solicitudes de estudiantes y docentes en taquilla."),
    (10, 4, 3, 1, "Planificar, coordinar y supervisar las actividades administrativas."),
    (11, 4, 8, 1, "Apoyar en la ejecución de procesos administrativos contables."),
    (12, 4, 9, 2, "Garantizar la operatividad de la infraestructura física."),
    (13, 4, 10, 3, "Mantener en óptimas condiciones de higiene todas las áreas."),
    (14, 5, 3, 1, "Planificar y coordinar la ejecución del programa de Pasantías."),
    (15, 5, 8, 1, "Apoyar en la gestión administrativa de la Coordinación de Pasantías."),
    (16, 6, 3, 1, "Administrar las funciones del área de Coordinación de Informática."),
    (17, 6, 8, 1, "Coordinar las actividades académicas en el Laboratorio de Informática."),
    (18, 7, 3, 1, "Coordinar las actividades del área de Educación Preescolar."),
    (19, 7, 8, 1, "Asistir administrativamente a la Coordinación de Preescolar."),
    (20, 8, 3, 1, "Promover el desarrollo de la investigación científica y extensión."),
    (21, 9, 4, 1, "Administrar y supervisar los servicios bibliotecarios."),
    (22, 9, 8, 1, "Atender a estudiantes y personal para suministrar bibliografía."),
    (23, 9, 11, 2, "Apoyar en las labores operativas de la biblioteca."),
]

for pk, dept, jt, vac, obj in positions_data:
    data.append({
        "model": "organization.position",
        "pk": pk,
        "fields": {
            "department": dept,
            "job_title": jt,
            "vacancies": vac,
            "objective": obj
        }
    })

# Requirements y Functions
req_pk = 1
func_pk = 1

# Director (Position 1)
director_reqs = [
    "Profesional Universitario.",
    "Cinco años de experiencia en cargos similares.",
    "Ser miembro activo del personal ordinario de un Instituto venezolano.",
]
for req in director_reqs:
    data.append({
        "model": "organization.positionrequirement",
        "pk": req_pk,
        "fields": {"position": 1, "description": req}
    })
    req_pk += 1

director_funcs = [
    "Planificar, Dirigir, Coordinar y Supervisar las actividades académicas y administrativas.",
    "Formular recomendaciones ante la Directiva Nacional.",
    "Programar las necesidades de Recursos Humanos, Físicos y Materiales.",
    "Cumplir y hacer cumplir todo lo concerniente al funcionamiento óptimo de la sede.",
    "Convocar y Presidir al Consejo Directivo de la extensión.",
    "Presentar ante la Dirección Nacional un informe semestral.",
    "Imponer las sanciones correspondientes al personal.",
    "Velar por el cumplimiento de las disposiciones de la Dirección Nacional.",
    "Velar por el orden y la disciplina dentro del Instituto.",
    "Estudiar y Recomendar medidas para mejorar el funcionamiento integral.",
    "Controlar las actividades de docencia y administrativas.",
    "Dirigir la reunión de profesores al inicio de cada periodo académico.",
    "Cualquier otra actividad asignada por la Dirección.",
]
for i, func in enumerate(director_funcs, 1):
    data.append({
        "model": "organization.positionfunction",
        "pk": func_pk,
        "fields": {"position": 1, "description": func, "order": i}
    })
    func_pk += 1

# Asesor de Prensa (Position 2)
asesor_reqs = [
    "Licenciado en Comunicación Social, Periodismo o Relaciones Públicas.",
    "Mínimo dos (2) años de experiencia en manejo de medios.",
    "Excelente redacción y oratoria.",
]
for req in asesor_reqs:
    data.append({
        "model": "organization.positionrequirement",
        "pk": req_pk,
        "fields": {"position": 2, "description": req}
    })
    req_pk += 1

asesor_funcs = [
    "Asesorar sobre las relaciones Institucionales que debe mantener el Iutirla.",
    "Mantener relaciones con Gremios, Instituciones u Organismos.",
    "Efectuar campañas publicitarias tendientes a captar nuevos estudiantes.",
    "Planificar y Coordinar ruedas de Prensa, Radio y T.V.",
    "Apoyar, Promocionar y Participar activamente en los eventos organizados.",
    "Redactar las notas de prensa que requiere la Institución.",
    "Cualquier otra actividad asignada por el Director.",
]
for i, func in enumerate(asesor_funcs, 1):
    data.append({
        "model": "organization.positionfunction",
        "pk": func_pk,
        "fields": {"position": 2, "description": func, "order": i}
    })
    func_pk += 1

# Continuar con el resto de posiciones...
# Por brevedad, agrego algunas más representativas

# Secretaria de Dirección (Position 3)
sec_dir_reqs = [
    "T.S.U. en Secretariado, Administración o carrera afín.",
    "Mínimo tres (3) años de experiencia en cargos de asistencia a la dirección.",
    "Manejo avanzado de herramientas ofimáticas.",
]
for req in sec_dir_reqs:
    data.append({
        "model": "organization.positionrequirement",
        "pk": req_pk,
        "fields": {"position": 3, "description": req}
    })
    req_pk += 1

sec_dir_funcs = [
    "Asistir junto con el Director a todas las reuniones.",
    "Redactar y elaborar todas las correspondencias de la Dirección.",
    "Atender de manera rápida y eficiente a las personas en general.",
    "Revisar todas las correspondencias recibidas.",
    "Velar por el perfecto orden y mantenimiento de los bienes muebles.",
    "Distribuir a los Departamentos las comunicaciones.",
    "Tipear los informes semestrales.",
    "Atender las llamadas telefónicas.",
    "Llevar la agenda del Director.",
    "Auxiliar a cualquier Departamento que lo necesite.",
    "Cualquier otra asignada por el director.",
]
for i, func in enumerate(sec_dir_funcs, 1):
    data.append({
        "model": "organization.positionfunction",
        "pk": func_pk,
        "fields": {"position": 3, "description": func, "order": i}
    })
    func_pk += 1

# Output JSON
output_path = 'organization/fixtures/initial_data.json'
with open(output_path, 'w', encoding='utf-8') as f:
    json.dump(data, f, ensure_ascii=False, indent=2)

print(f"Generated {len(data)} total entries")
print(f"File saved to: {output_path}")
print(f"- Departments: 9")
print(f"- JobTitles: 11")
print(f"- Positions: 23")
print(f"- Requirements: {req_pk - 1}")
print(f"- Functions: {func_pk - 1}")
</file>

<file path="backend/manage.py">
#!/usr/bin/env python
"""Django's command-line utility for administrative tasks."""
import os
import sys


def main():
    """Run administrative tasks."""
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')
    try:
        from django.core.management import execute_from_command_line
    except ImportError as exc:
        raise ImportError(
            "Couldn't import Django. Are you sure it's installed and "
            "available on your PYTHONPATH environment variable? Did you "
            "forget to activate a virtual environment?"
        ) from exc
    execute_from_command_line(sys.argv)


if __name__ == '__main__':
    main()
</file>

<file path="backend/migrate_manager_data.py">
"""
Data migration to preserve manager_position data before schema change.
This script moves existing single manager to the new many-to-many relationship.
"""
import os
import django

os.environ.setdefault("DJANGO_SETTINGS_MODULE", "config.settings")
django.setup()

from organization.models import Position

def migrate_manager_data():
    """Migrate old manager_position data to new manager_positions M2M field"""
    print("Starting migration of manager_position data...")
    
    # First, let's check if the old field still exists by querying raw
    from django.db import connection
    with connection.cursor() as cursor:
        cursor.execute("PRAGMA table_info(organization_position)")
        columns = [row[1] for row in cursor.fetchall()]
        
        if 'manager_position_id' not in columns:
            print("manager_position_id field not found - migration may have already run")
            return
    
    # Query positions with old manager_position field
    with connection.cursor() as cursor:
        cursor.execute("""
            SELECT id, manager_position_id 
            FROM organization_position 
            WHERE manager_position_id IS NOT NULL
        """)
        positions_with_managers = cursor.fetchall()
    
    print(f"Found {len(positions_with_managers)} positions with managers")
    
    # For each position, add the manager to the new M2M field
    migrated = 0
    for pos_id, manager_id in positions_with_managers:
        try:
            position = Position.objects.get(id=pos_id)
            manager = Position.objects.get(id=manager_id)
            position.manager_positions.add(manager)
            migrated += 1
            print(f"  Migrated: Position {pos_id} → Manager {manager_id}")
        except Position.DoesNotExist:
            print(f"  Skipped: Position or manager not found (pos={pos_id}, manager={manager_id})")
        except Exception as e:
            print(f"  Error migrating position {pos_id}: {e}")
    
    print(f"\nMigration complete: {migrated}/{len(positions_with_managers)} positions migrated")

if __name__ == "__main__":
    migrate_manager_data()
</file>

<file path="backend/populate_education_data.py">
#!/usr/bin/env python
"""
Script para poblar niveles educativos y campos de estudio con relaciones apropiadas.
"""
import os
import django

# Setup Django
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')
django.setup()

from talent.models import EducationLevel, FieldOfStudy

def populate_education_data():
    """Poblar datos de educación con relaciones jerárquicas."""
    
    print("=== Limpiando datos existentes ===")
    FieldOfStudy.objects.all().delete()
    print(f"✓ Eliminados todos los campos de estudio")
    
    # Datos organizados: nivel -> lista de campos de estudio
    education_data = {
        "Bachillerato": [
            "Ciencias",
            "Humanidades",
            "Artes",
            "Comercio",
        ],
        "Técnico Superior": [
            "Informática",
            "Administración",
            "Contaduría",
            "Diseño Gráfico",
            "Mercadeo",
            "Recursos Humanos",
            "Electrónica",
            "Mecánica",
            "Enfermería",
        ],
        "Licenciatura": [
            "Administración de Empresas",
            "Contaduría Pública",
            "Educación",
            "Psicología",
            "Comunicación Social",
            "Relaciones Industriales",
            "Economía",
            "Mercadeo",
        ],
        "Ingeniería": [
            "Ingeniería de Sistemas",
            "Ingeniería Industrial",
            "Ingeniería Civil",
            "Ingeniería Eléctrica",
            "Ingeniería Mecánica",
            "Ingeniería Electrónica",
            "Ingeniería Química",
            "Ingeniería de Telecomunicaciones",
        ],
        "Maestría": [
            "Gerencia Empresarial",
            "Finanzas",
            "Recursos Humanos",
            "Tecnología Educativa",
            "Administración Pública",
            "Gerencia de Proyectos",
            "Mercadeo y Ventas",
            "Ingeniería de Software",
            "Ciencia de Datos",
        ],
        "Doctorado": [
            "Ciencias Administrativas",
            "Ciencias de la Educación",
            "Ciencias Sociales",
            "Ingeniería",
            "Ciencias Económicas",
        ],
        "Diplomado": [
            "Gerencia de Proyectos",
            "Recursos Humanos",
            "Finanzas Corporativas",
            "Marketing Digital",
            "Gestión de la Calidad",
            "Seguridad Industrial",
        ],
    }
    
    print("\n=== Creando campos de estudio por nivel ===")
    total_created = 0
    
    for level_name, fields in education_data.items():
        try:
            level = EducationLevel.objects.get(name=level_name)
            print(f"\n📚 {level_name}:")
            
            for field_name in fields:
                field, created = FieldOfStudy.objects.get_or_create(
                    education_level=level,
                    name=field_name
                )
                if created:
                    print(f"  ✓ {field_name}")
                    total_created += 1
                else:
                    print(f"  - {field_name} (ya existe)")
                    
        except EducationLevel.DoesNotExist:
            print(f"⚠️  Nivel '{level_name}' no encontrado, omitiendo...")
    
    print(f"\n=== Resumen ===")
    print(f"✓ Total campos de estudio creados: {total_created}")
    print(f"✓ Total niveles educativos: {EducationLevel.objects.count()}")
    print(f"✓ Total campos de estudio: {FieldOfStudy.objects.count()}")
    
    # Mostrar resumen por nivel
    print("\n=== Distribución por nivel ===")
    for level in EducationLevel.objects.all():
        count = level.fields_of_study.count()
        print(f"  {level.name}: {count} campos")

if __name__ == '__main__':
    populate_education_data()
</file>

<file path="backend/test_api.py">
import requests

# CONFIGURACIÓN
BASE_URL = "http://127.0.0.1:8000/api"
LOGIN_URL = f"{BASE_URL}/auth/login/" 
TARGET_URL = f"{BASE_URL}/core/national-ids/"

# CREDENCIALES
USERNAME = "admin" 
PASSWORD = "123" # <--- ¡TU PASSWORD!

# ID de la persona a la que vamos a "torturar" con las pruebas
PERSON_ID = 1 

def test_duplicate_id():
    session = requests.Session()
    print(f"🔵 1. Login con {USERNAME}...")
    
    # --- LOGIN ---
    login_resp = session.post(LOGIN_URL, json={"username": USERNAME, "password": PASSWORD})
    if login_resp.status_code != 200:
        print(f"❌ Error Login: {login_resp.text}")
        return

    token = login_resp.json().get('access') or login_resp.json().get('key')
    headers = {"Authorization": f"Bearer {token}"}
    print("✅ Login exitoso.\n")

    # --- LIMPIEZA PREVIA (Borrar cédulas viejas de esta persona) ---
    print("🧹 Limpiando datos anteriores...")
    existing = requests.get(f"{TARGET_URL}?person={PERSON_ID}", headers=headers).json()
    results = existing.get('results', existing) if isinstance(existing, dict) else existing
    
    for item in results:
        requests.delete(f"{TARGET_URL}{item['id']}/", headers=headers)
    print("✨ Persona limpia (0 documentos).\n")

    # --- INTENTO 1: PRIMERA CÉDULA (Debe funcionar) ---
    print("🔵 2. Creando Cédula #1 (V-111111)...")
    data1 = {
        "person": PERSON_ID,
        "category": "CEDULA",
        "document_type": "V",
        "number": "111111",
        "is_primary": "true"
    }
    # Usamos 'data' para simular multipart/form-data (como el frontend)
    resp1 = requests.post(TARGET_URL, data=data1, headers=headers)
    
    if resp1.status_code == 201:
        print("✅ Éxito: Primera cédula creada.")
    else:
        print(f"❌ Error inesperado en la primera: {resp1.text}")
        return

    # --- INTENTO 2: SEGUNDA CÉDULA (Debe fallar) ---
    print("\n🔵 3. Intentando crear Cédula #2 (V-222222) para la MISMA persona...")
    print("   (Debe fallar porque una persona no puede tener dos documentos categoría 'CEDULA')")
    
    data2 = {
        "person": PERSON_ID,
        "category": "CEDULA", # Misma categoría
        "document_type": "V",
        "number": "222222",   # Diferente número, pero eso no importa
        "is_primary": "false"
    }
    
    resp2 = requests.post(TARGET_URL, data=data2, headers=headers)

    print(f"Status Code: {resp2.status_code}")
    print(f"Respuesta: {resp2.text}")

    # --- VERIFICACIÓN ---
    if resp2.status_code == 400:
        # Buscamos el mensaje de error global (non_field_errors)
        if "ya tiene un documento de esta categoría" in resp2.text:
            print("\n🏆 ¡PRUEBA SUPERADA! El sistema bloqueó la segunda cédula correctamente.")
        else:
            print("\n⚠️ Alerta: Dio error 400 pero con un mensaje diferente al esperado.")
    else:
        print(f"\n❌ FALLÓ. El sistema permitió crearla (Code {resp2.status_code}). ¡Revisa unique_together!")

if __name__ == "__main__":
    test_duplicate_id()
</file>

<file path="frontend2/app/(iutirla)/portal/jobs/[id]/apply/page.tsx">
"use client";

import { useState, useEffect } from "react";
import { useParams, useRouter } from "next/navigation";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Alert, AlertDescription, AlertTitle } from "@/components/ui/alert";
import {
    Select,
    SelectContent,
    SelectItem,
    SelectTrigger,
    SelectValue,
} from "@/components/ui/select";
import { ArrowLeft, Upload, Loader2, Send, AlertCircle } from "lucide-react";
import Link from "next/link";
import { toast } from "sonner";

interface JobPosting {
    id: number;
    title: string;
    position_title: string | null;
    department_name: string | null;
}

export default function ApplyJobPage() {
    const params = useParams();
    const router = useRouter();
    const id = params?.id as string;

    const [job, setJob] = useState<JobPosting | null>(null);
    const [loading, setLoading] = useState(true);
    const [submitting, setSubmitting] = useState(false);
    const [phoneCodes, setPhoneCodes] = useState<any[]>([]);

    const [formData, setFormData] = useState({
        first_name: "",
        last_name: "",
        email: "",
        national_id_type: "V",
        national_id: "",
        phone_area_code: "",
        phone_subscriber: "",
        cover_letter: "",
    });

    const [errors, setErrors] = useState<Record<string, string>>({});
    const [cvFile, setCvFile] = useState<File | null>(null);
    const [isDragging, setIsDragging] = useState(false);

    const documentTypes = [
        { value: "V", label: "V - Venezolano" },
        { value: "E", label: "E - Extranjero" },
        { value: "J", label: "J - Jurídico" },
        { value: "G", label: "G - Gubernamental" },
        { value: "P", label: "P - Pasaporte" },
    ];

    useEffect(() => {
        if (!id) return;

        // Cargar job
        fetch(`http://localhost:8000/api/ats/public/jobs/${id}/`)
            .then((res) => {
                if (!res.ok) throw new Error("Vacante no encontrada");
                return res.json();
            })
            .then((data) => {
                setJob(data);
                setLoading(false);
            })
            .catch((err) => {
                console.error(err);
                toast.error("Error al cargar la vacante");
                setLoading(false);
            });

        // Cargar códigos de teléfono
        fetch("http://localhost:8000/api/ats/public/phone-codes/")
            .then((res) => res.json())
            .then((data) => setPhoneCodes(data))
            .catch((err) => console.error("Error loading phone codes:", err));
    }, [id]);

    const validateForm = () => {
        const newErrors: Record<string, string> = {};

        // Validar nombre
        if (!formData.first_name.trim()) {
            newErrors.first_name = "El nombre es obligatorio";
        } else if (formData.first_name.trim().length < 2) {
            newErrors.first_name = "El nombre debe tener al menos 2 caracteres";
        } else if (/\d/.test(formData.first_name)) {
            newErrors.first_name = "El nombre no puede contener números";
        }

        // Validar apellido
        if (!formData.last_name.trim()) {
            newErrors.last_name = "El apellido es obligatorio";
        } else if (formData.last_name.trim().length < 2) {
            newErrors.last_name = "El apellido debe tener al menos 2 caracteres";
        } else if (/\d/.test(formData.last_name)) {
            newErrors.last_name = "El apellido no puede contener números";
        }

        // Validar email
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!formData.email.trim()) {
            newErrors.email = "El email es obligatorio";
        } else if (!emailRegex.test(formData.email)) {
            newErrors.email = "Email inválido";
        }

        // Validar cédula
        if (!formData.national_id.trim()) {
            newErrors.national_id = "La cédula es obligatoria";
        } else if (formData.national_id.trim().length < 5) {
            newErrors.national_id = "La cédula es inválida";
        } else if (!/^[0-9]+$/.test(formData.national_id.trim())) {
            newErrors.national_id = "La cédula solo debe contener números";
        }

        // Validar teléfono
        if (!formData.phone_area_code) {
            newErrors.phone_area_code = "Selecciona el código de área";
        }
        if (!formData.phone_subscriber.trim()) {
            newErrors.phone_subscriber = "El número de teléfono es obligatorio";
        } else if (formData.phone_subscriber.trim().length < 7) {
            newErrors.phone_subscriber = "El número debe tener al menos 7 dígitos";
        } else if (!/^[0-9]+$/.test(formData.phone_subscriber.trim())) {
            newErrors.phone_subscriber = "El teléfono solo debe contener números";
        }

        // Validar CV
        if (!cvFile) {
            newErrors.cv = "El CV es obligatorio";
        }

        setErrors(newErrors);
        return Object.keys(newErrors).length === 0;
    };

    const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        if (e.target.files && e.target.files[0]) {
            const file = e.target.files[0];
            if (file.type === "application/pdf") {
                if (file.size <= 5 * 1024 * 1024) {
                    setCvFile(file);
                    setErrors({ ...errors, cv: "" });
                } else {
                    toast.error("El archivo es muy grande. Máximo 5 MB.");
                }
            } else {
                toast.error("Solo se permiten archivos PDF");
            }
        }
    };

    const handleDragOver = (e: React.DragEvent) => {
        e.preventDefault();
        setIsDragging(true);
    };

    const handleDragLeave = (e: React.DragEvent) => {
        e.preventDefault();
        setIsDragging(false);
    };

    const handleDrop = (e: React.DragEvent) => {
        e.preventDefault();
        setIsDragging(false);

        if (e.dataTransfer.files && e.dataTransfer.files[0]) {
            const file = e.dataTransfer.files[0];
            if (file.type === "application/pdf") {
                if (file.size <= 5 * 1024 * 1024) {
                    setCvFile(file);
                    setErrors({ ...errors, cv: "" });
                } else {
                    toast.error("El archivo es muy grande. Máximo 5 MB.");
                }
            } else {
                toast.error("Solo se permiten archivos PDF");
            }
        }
    };

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();

        if (!validateForm()) {
            toast.error("Por favor corrige los errores del formulario");
            return;
        }

        setSubmitting(true);
        const toastId = toast.loading("Enviando postulación...");

        try {
            const formDataToSend = new FormData();
            formDataToSend.append("job_posting", id);
            formDataToSend.append("first_name", formData.first_name.trim());
            formDataToSend.append("last_name", formData.last_name.trim());
            formDataToSend.append("email", formData.email.trim());
            formDataToSend.append("phone_area_code", formData.phone_area_code);
            formDataToSend.append("phone_subscriber", formData.phone_subscriber.trim());
            formDataToSend.append("national_id", `${formData.national_id_type}-${formData.national_id.trim()}`);
            formDataToSend.append("cv_file", cvFile!);

            if (formData.cover_letter.trim()) {
                formDataToSend.append("cover_letter", formData.cover_letter.trim());
            }

            const res = await fetch("http://localhost:8000/api/ats/public/apply/", {
                method: "POST",
                body: formDataToSend,
            });

            if (!res.ok) {
                const errorData = await res.json();

                // Parse backend errors
                const errors: string[] = [];
                for (const [field, messages] of Object.entries(errorData)) {
                    if (Array.isArray(messages)) {
                        errors.push(...messages);
                    } else if (typeof messages === "string") {
                        errors.push(messages);
                    }
                }

                if (errors.length > 0) {
                    errors.forEach(err => toast.error(err));
                    toast.dismiss(toastId);
                    return;
                }

                throw new Error(JSON.stringify(errorData));
            }

            toast.success("¡Postulación enviada exitosamente!", { id: toastId });
            router.push("/portal/jobs");
        } catch (error: any) {
            console.error(error);
            toast.error("Error al enviar la postulación. Por favor intenta de nuevo.", { id: toastId });
        } finally {
            setSubmitting(false);
        }
    };

    if (loading) {
        return (
            <div className="container mx-auto px-4 py-16 text-center">
                <Loader2 className="h-12 w-12 animate-spin text-brand-primary mx-auto" />
                <p className="mt-4 text-muted-foreground">Cargando...</p>
            </div>
        );
    }

    if (!job) {
        return (
            <div className="container mx-auto px-4 py-16 text-center">
                <h1 className="text-2xl font-bold text-red-600 mb-4">Vacante no encontrada</h1>
                <Link href="/portal/jobs">
                    <Button>
                        <ArrowLeft className="w-4 h-4 mr-2" />
                        Volver a vacantes
                    </Button>
                </Link>
            </div>
        );
    }

    return (
        <div className="container mx-auto px-4 py-12 max-w-3xl">
            <Link href={`/portal/jobs/${id}`}>
                <Button variant="ghost" className="mb-6">
                    <ArrowLeft className="w-4 h-4 mr-2" />
                    Volver a la vacante
                </Button>
            </Link>

            <Card>
                <CardHeader>
                    <CardTitle className="text-3xl">Postulación para {job.title}</CardTitle>
                    <CardDescription className="text-base">
                        {job.position_title} - {job.department_name}
                    </CardDescription>
                </CardHeader>
                <CardContent>
                    <form onSubmit={handleSubmit} className="space-y-6">
                        {/* Error Summary */}
                        {Object.keys(errors).length > 0 && (
                            <Alert variant="destructive">
                                <AlertCircle className="h-4 w-4" />
                                <AlertTitle>Por favor corrige los siguientes errores</AlertTitle>
                                <AlertDescription>
                                    <ul className="mt-2 list-disc list-inside space-y-1">
                                        {Object.values(errors).map((error, index) => (
                                            <li key={index}>{error}</li>
                                        ))}
                                    </ul>
                                </AlertDescription>
                            </Alert>
                        )}

                        {/* Información Personal */}
                        <div className="space-y-4">
                            <h3 className="font-semibold text-lg text-slate-900">Información Personal</h3>

                            <div className="grid md:grid-cols-2 gap-4">
                                <div className="space-y-2">
                                    <Label htmlFor="first_name">Nombre *</Label>
                                    <Input
                                        id="first_name"
                                        value={formData.first_name}
                                        onChange={(e) => setFormData({ ...formData, first_name: e.target.value })}
                                        className={errors.first_name ? "border-red-500" : ""}
                                    />
                                    {errors.first_name && (
                                        <p className="text-sm text-red-600">{errors.first_name}</p>
                                    )}
                                </div>

                                <div className="space-y-2">
                                    <Label htmlFor="last_name">Apellido *</Label>
                                    <Input
                                        id="last_name"
                                        value={formData.last_name}
                                        onChange={(e) => setFormData({ ...formData, last_name: e.target.value })}
                                        className={errors.last_name ? "border-red-500" : ""}
                                    />
                                    {errors.last_name && (
                                        <p className="text-sm text-red-600">{errors.last_name}</p>
                                    )}
                                </div>
                            </div>

                            <div className="space-y-2">
                                <Label htmlFor="email">Correo Electrónico *</Label>
                                <Input
                                    id="email"
                                    type="email"
                                    value={formData.email}
                                    onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                                    placeholder="juan.perez@ejemplo.com"
                                    className={errors.email ? "border-red-500" : ""}
                                />
                                {errors.email && (
                                    <p className="text-sm text-red-600">{errors.email}</p>
                                )}
                            </div>

                            <div className="grid grid-cols-4 gap-2">
                                <div className="space-y-2">
                                    <Label htmlFor="national_id_type">Tipo *</Label>
                                    <Select
                                        value={formData.national_id_type}
                                        onValueChange={(value) => setFormData({ ...formData, national_id_type: value })}
                                    >
                                        <SelectTrigger>
                                            <SelectValue placeholder="Tipo" />
                                        </SelectTrigger>
                                        <SelectContent>
                                            {documentTypes.map((type) => (
                                                <SelectItem key={type.value} value={type.value}>
                                                    {type.label}
                                                </SelectItem>
                                            ))}
                                        </SelectContent>
                                    </Select>
                                </div>
                                <div className="col-span-3 space-y-2">
                                    <Label htmlFor="national_id">Número de Cédula *</Label>
                                    <Input
                                        id="national_id"
                                        value={formData.national_id}
                                        onChange={(e) => setFormData({ ...formData, national_id: e.target.value })}
                                        placeholder="12345678"
                                        className={errors.national_id ? "border-red-500" : ""}
                                    />
                                    {errors.national_id && (
                                        <p className="text-sm text-red-600">{errors.national_id}</p>
                                    )}
                                </div>
                            </div>

                            <div className="space-y-2">
                                <Label>Teléfono *</Label>
                                <div className="grid grid-cols-5 gap-2">
                                    <div className="col-span-2">
                                        <Select
                                            value={formData.phone_area_code}
                                            onValueChange={(value) => setFormData({ ...formData, phone_area_code: value })}
                                        >
                                            <SelectTrigger className={errors.phone_area_code ? "border-red-500" : ""}>
                                                <SelectValue placeholder="Código" />
                                            </SelectTrigger>
                                            <SelectContent>
                                                {phoneCodes.map((code) => (
                                                    <SelectItem key={code.id} value={code.id.toString()}>
                                                        {code.code}
                                                    </SelectItem>
                                                ))}
                                            </SelectContent>
                                        </Select>
                                        {errors.phone_area_code && (
                                            <p className="text-sm text-red-600 mt-1">{errors.phone_area_code}</p>
                                        )}
                                    </div>
                                    <div className="col-span-3">
                                        <Input
                                            id="phone_subscriber"
                                            value={formData.phone_subscriber}
                                            onChange={(e) => setFormData({ ...formData, phone_subscriber: e.target.value })}
                                            placeholder="1234567"
                                            className={errors.phone_subscriber ? "border-red-500" : ""}
                                        />
                                        {errors.phone_subscriber && (
                                            <p className="text-sm text-red-600 mt-1">{errors.phone_subscriber}</p>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* CV Upload */}
                        <div className="space-y-2">
                            <Label htmlFor="cv">Curriculum Vitae (PDF) *</Label>
                            <div
                                className={`relative border-2 border-dashed rounded-lg p-8 transition-all cursor-pointer ${isDragging
                                        ? "border-brand-primary bg-purple-50"
                                        : cvFile
                                            ? "border-green-500 bg-green-50"
                                            : errors.cv
                                                ? "border-red-500"
                                                : "border-slate-300 hover:border-brand-primary hover:bg-purple-50/50"
                                    }`}
                                onDragOver={handleDragOver}
                                onDragLeave={handleDragLeave}
                                onDrop={handleDrop}
                                onClick={() => document.getElementById("cv")?.click()}
                            >
                                <input
                                    id="cv"
                                    type="file"
                                    accept=".pdf"
                                    onChange={handleFileChange}
                                    className="hidden"
                                />

                                {cvFile ? (
                                    <div className="text-center">
                                        <div className="mb-3 flex justify-center">
                                            <div className="rounded-full bg-green-100 p-3">
                                                <Upload className="h-8 w-8 text-green-600" />
                                            </div>
                                        </div>
                                        <p className="text-lg font-semibold text-green-700 mb-1">
                                            {cvFile.name}
                                        </p>
                                        <p className="text-sm text-slate-600 mb-2">
                                            {(cvFile.size / 1024 / 1024).toFixed(2)} MB
                                        </p>
                                        <Button
                                            type="button"
                                            variant="outline"
                                            size="sm"
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                setCvFile(null);
                                            }}
                                        >
                                            Cambiar archivo
                                        </Button>
                                    </div>
                                ) : (
                                    <div className="text-center">
                                        <div className="mb-3 flex justify-center">
                                            <div className="rounded-full bg-purple-100 p-3">
                                                <Upload className="h-8 w-8 text-brand-primary" />
                                            </div>
                                        </div>
                                        <p className="text-base font-medium text-slate-700 mb-1">
                                            Arrastra tu CV aquí o haz clic para seleccionar
                                        </p>
                                        <p className="text-sm text-slate-500">
                                            Solo archivos PDF. Máximo 5 MB.
                                        </p>
                                    </div>
                                )}
                            </div>
                            {errors.cv && (
                                <p className="text-sm text-red-600">{errors.cv}</p>
                            )}
                        </div>

                        {/* Carta de Presentación */}
                        <div className="space-y-2">
                            <Label htmlFor="cover_letter">Carta de Presentación (Opcional)</Label>
                            <Textarea
                                id="cover_letter"
                                rows={6}
                                value={formData.cover_letter}
                                onChange={(e) => setFormData({ ...formData, cover_letter: e.target.value })}
                                placeholder="Cuéntanos por qué te interesa esta posición y qué puedes aportar al equipo..."
                            />
                        </div>

                        {/* Submit Button */}
                        <div className="pt-4 border-t">
                            <Button
                                type="submit"
                                disabled={submitting}
                                className="w-full bg-brand-primary hover:bg-brand-primary/90"
                                size="lg"
                            >
                                {submitting ? (
                                    <>
                                        <Loader2 className="w-5 h-5 mr-2 animate-spin" />
                                        Enviando...
                                    </>
                                ) : (
                                    <>
                                        <Send className="w-5 h-5 mr-2" />
                                        Enviar Postulación
                                    </>
                                )}
                            </Button>

                            <p className="text-xs text-center text-muted-foreground mt-4">
                                Al enviar esta postulación, aceptas compartir tu información con IUTIRLA para fines de reclutamiento.
                            </p>
                        </div>
                    </form>
                </CardContent>
            </Card>
        </div>
    );
}
</file>

<file path="frontend2/app/(iutirla)/portal/jobs/[id]/page.tsx">
"use client";

import { useEffect, useState } from "react";
import { useParams, useRouter } from "next/navigation";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Separator } from "@/components/ui/separator";
import { MapPin, Calendar, Building2, ArrowLeft, Briefcase } from "lucide-react";
import Link from "next/link";

interface PositionFunction {
    id: number;
    description: string;
    order: number;
}

interface PositionRequirement {
    id: number;
    description: string;
    order: number;
}

interface JobPosting {
    id: number;
    title: string;
    description: string;
    location: string | null;
    position_title: string | null;
    position_objective: string | null;
    department_name: string | null;
    published_date: string | null;
    closing_date: string | null;
    status: string;
    ask_education: boolean;
    position_functions: PositionFunction[];
    position_requirements: PositionRequirement[];
}

export default function JobDetailPage() {
    const params = useParams();
    const router = useRouter();
    const id = params?.id as string;

    const [job, setJob] = useState<JobPosting | null>(null);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState<string | null>(null);

    useEffect(() => {
        if (!id) return;

        fetch(`http://localhost:8000/api/ats/public/jobs/${id}/`)
            .then((res) => {
                if (!res.ok) throw new Error("Vacante no encontrada");
                return res.json();
            })
            .then((data) => {
                setJob(data);
                setLoading(false);
            })
            .catch((err) => {
                setError(err.message);
                setLoading(false);
            });
    }, [id]);

    if (loading) {
        return (
            <div className="min-h-screen bg-gradient-to-b from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-950">
                <div className="container mx-auto px-4 py-16 text-center">
                    <p className="text-xl">Cargando...</p>
                </div>
            </div>
        );
    }

    if (error || !job) {
        return (
            <div className="min-h-screen bg-gradient-to-b from-slate-50 to-slate-100 dark:from-slate-900 dark:to-slate-950">
                <div className="container mx-auto px-4 py-16 text-center">
                    <h1 className="text-3xl font-bold text-red-600 mb-4">Vacante no encontrada</h1>
                    <p className="text-muted-foreground mb-8">{error}</p>
                    <Link href="/jobs">
                        <Button>
                            <ArrowLeft className="w-4 h-4 mr-2" />
                            Volver a vacantes
                        </Button>
                    </Link>
                </div>
            </div>
        );
    }

    return (
        <div className="min-h-screen">
            {/* Header */}
            <div className="bg-brand-primary text-white py-12">
                <div className="container mx-auto px-4">
                    <Link href="/portal/jobs">
                        <Button variant="ghost" className="text-white hover:bg-white/10 mb-6">
                            <ArrowLeft className="w-4 h-4 mr-2" />
                            Volver a vacantes
                        </Button>
                    </Link>

                    <div className="flex items-start gap-4">
                        <div className="p-4 bg-white/10 rounded-lg">
                            <Briefcase className="w-12 h-12" />
                        </div>
                        <div className="flex-1">
                            <Badge className="bg-white/20 hover:bg-white/30 mb-3">
                                {job.position_title || "Posición"}
                            </Badge>
                            <h1 className="text-4xl font-bold mb-2">{job.title}</h1>

                            <div className="flex flex-wrap gap-4 text-brand-primary-foreground/90 mt-4">
                                {job.location && (
                                    <div className="flex items-center gap-2">
                                        <MapPin className="w-5 h-5" />
                                        <span>{job.location}</span>
                                    </div>
                                )}
                                {job.published_date && (
                                    <div className="flex items-center gap-2">
                                        <Calendar className="w-5 h-5" />
                                        <span>Publicado: {new Date(job.published_date).toLocaleDateString("es-ES")}</span>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {/* Content */}
            <div className="container mx-auto px-4 py-12">
                <div className="grid lg:grid-cols-3 gap-8">
                    {/* Main Content */}
                    <div className="lg:col-span-2">
                        <Card>
                            <CardHeader>
                                <CardTitle>Descripción del Puesto</CardTitle>
                            </CardHeader>
                            <CardContent>
                                <div className="prose prose-slate dark:prose-invert max-w-none">
                                    <p className="whitespace-pre-wrap text-base leading-relaxed">
                                        {job.description}
                                    </p>
                                </div>
                            </CardContent>
                        </Card>

                        {/* Objective */}
                        {job.position_objective && (
                            <Card className="mt-6">
                                <CardHeader>
                                    <CardTitle>Objetivo del Cargo</CardTitle>
                                </CardHeader>
                                <CardContent>
                                    <p className="whitespace-pre-wrap text-base leading-relaxed">
                                        {job.position_objective}
                                    </p>
                                </CardContent>
                            </Card>
                        )}

                        {/* Functions */}
                        {job.position_functions && job.position_functions.length > 0 && (
                            <Card className="mt-6">
                                <CardHeader>
                                    <CardTitle>Funciones del Cargo</CardTitle>
                                </CardHeader>
                                <CardContent>
                                    <ul className="space-y-3">
                                        {job.position_functions
                                            .sort((a, b) => a.order - b.order)
                                            .map((func) => (
                                                <li key={func.id} className="flex items-start gap-3">
                                                    <div className="w-2 h-2 rounded-full bg-brand-primary mt-2 shrink-0" />
                                                    <span className="text-base">{func.description}</span>
                                                </li>
                                            ))}
                                    </ul>
                                </CardContent>
                            </Card>
                        )}

                        {/* Requirements */}
                        {job.position_requirements && job.position_requirements.length > 0 && (
                            <Card className="mt-6">
                                <CardHeader>
                                    <CardTitle>Requisitos</CardTitle>
                                </CardHeader>
                                <CardContent>
                                    <ul className="space-y-3">
                                        {job.position_requirements
                                            .sort((a, b) => a.order - b.order)
                                            .map((req) => (
                                                <li key={req.id} className="flex items-start gap-3">
                                                    <div className="w-2 h-2 rounded-full bg-orange-500 mt-2 shrink-0" />
                                                    <span className="text-base">{req.description}</span>
                                                </li>
                                            ))}
                                    </ul>
                                </CardContent>
                            </Card>
                        )}
                    </div>

                    {/* Sidebar */}
                    <div className="space-y-6">
                        <Card>
                            <CardHeader>
                                <CardTitle>Información de la Vacante</CardTitle>
                            </CardHeader>
                            <CardContent className="space-y-4">
                                {job.closing_date && (
                                    <div>
                                        <p className="text-sm font-medium text-muted-foreground mb-1">Fecha de Cierre</p>
                                        <p className="text-base font-semibold text-orange-600 dark:text-orange-400">
                                            {new Date(job.closing_date).toLocaleDateString("es-ES", {
                                                year: "numeric",
                                                month: "long",
                                                day: "numeric",
                                            })}
                                        </p>
                                    </div>
                                )}

                                <Separator />

                                <div>
                                    <p className="text-sm font-medium text-muted-foreground mb-1">Estado</p>
                                    <Badge className="bg-green-600">Activa</Badge>
                                </div>
                            </CardContent>
                        </Card>

                        <Card>
                            <CardHeader>
                                <CardTitle>¿Listo para postularte?</CardTitle>
                                <CardDescription>
                                    Envía tu CV y únete a nuestro equipo
                                </CardDescription>
                            </CardHeader>
                            <CardContent>
                                <Link href={`/portal/jobs/${id}/apply`}>
                                    <Button className="w-full bg-brand-primary hover:bg-brand-primary/90" size="lg">
                                        Postularme Ahora
                                    </Button>
                                </Link>

                                <p className="text-xs text-muted-foreground mt-4 text-center">
                                    Al postularte, aceptas compartir tu información con IUTIRLA
                                </p>
                            </CardContent>
                        </Card>

                        <Card className="bg-muted">
                            <CardHeader>
                                <CardTitle className="text-base">¿Necesitas ayuda?</CardTitle>
                            </CardHeader>
                            <CardContent className="space-y-2 text-sm">
                                <div className="flex items-start gap-2">
                                    <Building2 className="w-4 h-4 mt-0.5 shrink-0" />
                                    <div>
                                        <p className="font-medium">IUTIRLA - Extensión Porlamar</p>
                                        <p className="text-muted-foreground">Recursos Humanos</p>
                                    </div>
                                </div>
                                <Separator />
                                <div>
                                    <p className="text-muted-foreground">
                                        Email:{" "}
                                        <a href="mailto:rrhh@iutirla.edu.ve" className="text-brand-primary hover:underline font-medium">
                                            rrhh@iutirla.edu.ve
                                        </a>
                                    </p>
                                </div>
                            </CardContent>
                        </Card>
                    </div>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="frontend2/app/(iutirla)/portal/jobs/page.tsx">
"use client";

import { useState, useEffect } from "react";
import JobCard from "@/components/iutirla/JobCard";
import { Search, Briefcase, Loader2 } from "lucide-react";

export default function JobsPage() {
    const [jobs, setJobs] = useState<any[]>([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        async function loadJobs() {
            try {
                const res = await fetch("http://localhost:8000/api/ats/public/jobs/");

                if (!res.ok) {
                    throw new Error("Failed to fetch jobs");
                }

                const data = await res.json();
                setJobs(data.results || data);
            } catch (error) {
                console.error("Error fetching jobs:", error);
                setJobs([]);
            } finally {
                setLoading(false);
            }
        }

        loadJobs();
    }, []);

    if (loading) {
        return (
            <div className="container mx-auto px-4 py-12">
                <div className="flex flex-col items-center justify-center py-20">
                    <Loader2 className="h-16 w-16 animate-spin text-brand-primary" />
                    <p className="mt-4 text-slate-600">Cargando vacantes...</p>
                </div>
            </div>
        );
    }

    return (
        <div className="container mx-auto px-4 py-12">
            {/* Header */}
            <div className="mb-12 text-center">
                <h1 className="mb-4 text-4xl font-bold text-slate-900 md:text-5xl">
                    Vacantes Disponibles
                </h1>
                <p className="mx-auto max-w-2xl text-lg text-slate-600">
                    Explora nuestras oportunidades de carrera y encuentra el puesto perfecto para ti
                </p>
            </div>

            {/* Search Bar (decorativo por ahora) */}
            <div className="mx-auto mb-12 max-w-2xl">
                <div className="relative">
                    <Search className="absolute left-4 top-1/2 h-5 w-5 -translate-y-1/2 text-slate-400" />
                    <input
                        type="text"
                        placeholder="Buscar por cargo o departamento..."
                        className="w-full rounded-full border border-slate-300 py-4 pl-12 pr-4 shadow-sm transition-all focus:border-brand-primary focus:outline-none focus:ring-2 focus:ring-brand-primary"
                    />
                </div>
            </div>

            {/* Jobs Grid */}
            {jobs.length > 0 ? (
                <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                    {jobs.map((job: any) => (
                        <JobCard
                            key={job.id}
                            id={job.id}
                            title={job.title}
                            departmentName={job.department_name}
                            location={job.location}
                            salaryRange={job.salary_range}
                            positionTitle={job.position_title}
                            publishedDate={job.published_date}
                            closingDate={job.closing_date}
                        />
                    ))}
                </div>
            ) : (
                <div className="flex flex-col items-center justify-center py-20 text-center">
                    <Briefcase className="mb-4 h-16 w-16 text-slate-300" />
                    <h2 className="mb-2 text-2xl font-semibold text-slate-700">
                        No hay vacantes disponibles en este momento
                    </h2>
                    <p className="text-slate-500">
                        Vuelve pronto para ver nuevas oportunidades
                    </p>
                </div>
            )}
        </div>
    );
}
</file>

<file path="frontend2/app/(iutirla)/portal/page.tsx">
import Link from "next/link";
import { Briefcase, Users, Heart, TrendingUp, ArrowRight } from "lucide-react";

export default function IutirlaHomePage() {
    return (
        <div className="w-full">
            {/* Hero Section */}
            <section className="relative overflow-hidden bg-gradient-to-r from-purple-900 via-purple-800 to-violet-900 py-24 text-white">
                <div className="absolute inset-0 bg-[url('/grid.svg')] opacity-10"></div>
                <div className="container relative z-10 mx-auto px-4">
                    <div className="mx-auto max-w-4xl text-center">
                        <h1 className="mb-6 text-5xl font-bold leading-tight md:text-6xl">
                            Construye tu futuro con{" "}
                            <span className="bg-gradient-to-r from-purple-300 to-violet-300 bg-clip-text text-transparent">
                                IUTIRLA
                            </span>
                        </h1>
                        <p className="mb-8 text-xl text-purple-100 md:text-2xl">
                            Únete a un equipo apasionado por la excelencia educativa y el desarrollo profesional
                        </p>
                        <div className="flex flex-col gap-4 sm:flex-row sm:justify-center">
                            <Link
                                href="/portal/jobs"
                                className="inline-flex h-12 items-center justify-center rounded-full bg-brand-primary px-8 text-base font-medium text-white shadow-lg transition-colors hover:bg-brand-primary/90 focus:outline-none focus:ring-2 focus:ring-brand-primary focus:ring-offset-2"
                            >
                                Ver Vacantes Disponibles
                            </Link>
                            <Link
                                href="#"
                                className="inline-flex h-12 items-center justify-center rounded-full border border-slate-300 bg-white px-8 text-base font-medium text-slate-700 shadow-sm transition-colors hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-brand-primary focus:ring-offset-2"
                            >
                                Conoce Nuestra Cultura
                            </Link>
                        </div>
                    </div>
                </div>
                <div className="absolute bottom-0 left-0 right-0 h-20 bg-gradient-to-t from-slate-50"></div>
            </section>

            {/* Cultura Organizacional */}
            <section className="py-20">
                <div className="container mx-auto px-4">
                    <div className="mb-16 text-center">
                        <h2 className="mb-4 text-4xl font-bold text-slate-900">
                            ¿Por qué trabajar en IUTIRLA?
                        </h2>
                        <p className="mx-auto max-w-2xl text-lg text-slate-600">
                            Somos más que una institución educativa. Somos una familia comprometida con
                            la transformación de vidas a través de la educación.
                        </p>
                    </div>

                    <div className="grid gap-8 md:grid-cols-2 lg:grid-cols-4">
                        {features.map((feature, index) => (
                            <div
                                key={index}
                                className="group rounded-2xl bg-white p-8 shadow-lg transition-all hover:-translate-y-2 hover:shadow-2xl"
                            >
                                <div className="mb-6 inline-flex rounded-full bg-purple-100 p-4 transition-all group-hover:scale-110 group-hover:bg-brand-primary">
                                    <feature.icon className="h-8 w-8 text-brand-primary transition-colors group-hover:text-white" />
                                </div>
                                <h3 className="mb-3 text-xl font-bold text-slate-900">{feature.title}</h3>
                                <p className="text-slate-600">{feature.description}</p>
                            </div>
                        ))}
                    </div>
                </div>
            </section>

            {/* Beneficios */}
            <section className="bg-gradient-to-br from-purple-50 to-violet-50 py-20">
                <div className="container mx-auto px-4">
                    <div className="mb-16 text-center">
                        <h2 className="mb-4 text-4xl font-bold text-slate-900">
                            Beneficios de ser parte del equipo
                        </h2>
                    </div>

                    <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                        {benefits.map((benefit, index) => (
                            <div
                                key={index}
                                className="rounded-xl bg-white p-6 shadow-md transition-all hover:shadow-xl"
                            >
                                <div className="mb-3 flex items-center gap-3">
                                    <div className="rounded-lg bg-green-100 p-2">
                                        <div className="h-2 w-2 rounded-full bg-green-600"></div>
                                    </div>
                                    <h3 className="font-semibold text-slate-900">{benefit.title}</h3>
                                </div>
                                <p className="text-sm text-slate-600">{benefit.description}</p>
                            </div>
                        ))}
                    </div>
                </div>
            </section>

            {/* CTA Final */}
            <section className="bg-gradient-to-r from-purple-900 to-violet-900 py-20 text-white">
                <div className="container mx-auto px-4 text-center">
                    <h2 className="mb-6 text-4xl font-bold">¿Listo para dar el siguiente paso?</h2>
                    <p className="mb-8 text-xl text-purple-100">
                        Explora nuestras vacantes y encuentra la oportunidad perfecta para ti
                    </p>
                    <Link
                        href="/jobs"
                        className="inline-flex items-center gap-2 rounded-full bg-white px-8 py-4 text-lg font-semibold text-purple-900 shadow-xl transition-all hover:scale-105"
                    >
                        Explorar Vacantes
                        <ArrowRight className="h-5 w-5" />
                    </Link>
                </div>
            </section>
        </div>
    );
}

const features = [
    {
        icon: Briefcase,
        title: "Desarrollo Profesional",
        description: "Oportunidades continuas de capacitación y crecimiento en tu carrera.",
    },
    {
        icon: Users,
        title: "Equipo Colaborativo",
        description: "Trabaja con profesionales apasionados y comprometidos con la excelencia.",
    },
    {
        icon: Heart,
        title: "Ambiente Inclusivo",
        description: "Valoramos la diversidad y creamos un espacio donde todos prosperan.",
    },
    {
        icon: TrendingUp,
        title: "Impacto Real",
        description: "Tu trabajo transforma vidas y contribuye al futuro del país.",
    },
];

const benefits = [
    {
        title: "Seguro de Salud Integral",
        description: "Cobertura médica completa para ti y tu familia.",
    },
    {
        title: "Capacitación Continua",
        description: "Acceso a cursos, talleres y programas de desarrollo profesional.",
    },
    {
        title: "Flexibilidad Laboral",
        description: "Opciones de trabajo híbrido según el cargo y necesidades.",
    },
    {
        title: "Bonos de Desempeño",
        description: "Reconocimiento monetario por excelencia y resultados.",
    },
    {
        title: "Días de Descanso",
        description: "Vacaciones pagadas y días libres por ocasiones especiales.",
    },
    {
        title: "Ambiente Moderno",
        description: "Instalaciones equipadas con tecnología de punta.",
    },
];
</file>

<file path="frontend2/app/(iutirla)/layout.tsx">
import type { Metadata } from "next";
import { Outfit } from "next/font/google";
import PublicNavbar from "@/components/iutirla/PublicNavbar";
import PublicFooter from "@/components/iutirla/PublicFooter";
import "../globals.css"

const outfit = Outfit({ subsets: ["latin"] });

export const metadata: Metadata = {
    title: "Trabaja con Nosotros | IUTIRLA",
    description: "Únete al equipo IUTIRLA. Descubre oportunidades de carrera y postúlate a nuestras vacantes disponibles.",
};

export default function IutirlaLayout({
    children,
}: {
    children: React.ReactNode;
}) {
    return (
        <div className={`${outfit.className} flex min-h-screen flex-col bg-gradient-to-br from-purple-50 via-violet-50 to-purple-100`}>
            <PublicNavbar />
            <main className="flex-1">
                {children}
            </main>
            <PublicFooter />
        </div>
    );
}
</file>

<file path="frontend2/app/(main)/admin/ats/candidates/[id]/page.tsx">
"use client";

import { useState } from "react";
import { useParams, useRouter } from "next/navigation";
import useSWR from "swr";
import Link from "next/link";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Label } from "@/components/ui/label";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import {
    Dialog,
    DialogContent,
    DialogDescription,
    DialogFooter,
    DialogHeader,
    DialogTitle,
} from "@/components/ui/dialog";
import {
    Select,
    SelectContent,
    SelectItem,
    SelectTrigger,
    SelectValue,
} from "@/components/ui/select";
import {
    ArrowLeft,
    Mail,
    Phone,
    FileText,
    Calendar,
    User,
    Briefcase,
    MapPin,
    Download,
    UserCheck,
    Loader2
} from "lucide-react";
import { Candidate } from "@/types/ats";
import apiClient from "@/lib/api-client";
import { toast } from "sonner";

const fetcher = (url: string) => apiClient.get(url).then((res) => res.data);

const stageColors = {
    NEW: "bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200",
    REV: "bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200",
    INT: "bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200",
    OFF: "bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200",
    HIRED: "bg-emerald-100 text-emerald-800 dark:bg-emerald-900 dark:text-emerald-200",
    REJ: "bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200",
    POOL: "bg-cyan-100 text-cyan-800 dark:bg-cyan-900 dark:text-cyan-200",
};

const roleOptions = [
    { value: "EMP", label: "Empleado" },
    { value: "MGR", label: "Manager" },
];

const employmentTypeOptions = [
    { value: "FIJ", label: "Fijo" },
    { value: "TMP", label: "Temporal" },
    { value: "PAS", label: "Pasantía" },
];

const employmentStatusOptions = [
    { value: "ACT", label: "Activo" },
];

export default function CandidateDetailPage() {
    const params = useParams();
    const router = useRouter();
    const id = params?.id as string;

    const [showHireDialog, setShowHireDialog] = useState(false);
    const [hiring, setHiring] = useState(false);
    const [errors, setErrors] = useState<Record<string, string>>({});
    const [hireFormData, setHireFormData] = useState({
        hire_date: new Date().toISOString().split("T")[0],
        role: "EMP",
        employment_type: "FIJ",
        employment_status: "ACT",
        end_date: "",
        notes: "",
    });

    const { data: candidate, error, isLoading, mutate } = useSWR<Candidate>(
        id ? `/api/ats/candidates/${id}/` : null,
        fetcher
    );

    const validateForm = () => {
        const newErrors: Record<string, string> = {};

        // Validar fecha de inicio
        if (!hireFormData.hire_date) {
            newErrors.hire_date = "La fecha de inicio es obligatoria";
        } else {
            const hireDate = new Date(hireFormData.hire_date);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Permitir fecha pasada pero advertir si es muy antigua
            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);

            if (hireDate < oneYearAgo) {
                newErrors.hire_date = "La fecha de inicio es muy antigua. Verifica que sea correcta";
            }
        }

        // Validar fecha de fin para contratos temporales y pasantías
        if (hireFormData.employment_type === "TMP" || hireFormData.employment_type === "PAS") {
            if (hireFormData.employment_type === "TMP" && !hireFormData.end_date) {
                newErrors.end_date = "La fecha de fin es obligatoria para contratos temporales";
            } else if (hireFormData.end_date) {
                const startDate = new Date(hireFormData.hire_date);
                const endDate = new Date(hireFormData.end_date);

                if (endDate <= startDate) {
                    newErrors.end_date = "La fecha de fin debe ser posterior a la fecha de inicio";
                }

                // Validar que no sea muy larga (más de 5 años para temporal)
                if (hireFormData.employment_type === "TMP") {
                    const diffYears = (endDate.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24 * 365);
                    if (diffYears > 5) {
                        newErrors.end_date = "Los contratos temporales no deben exceder 5 años";
                    }
                }
            }
        }

        setErrors(newErrors);
        return Object.keys(newErrors).length === 0;
    };

    const handleHire = async () => {
        // Validar formulario
        if (!validateForm()) {
            toast.error("Por favor corrige los errores del formulario");
            return;
        }

        setHiring(true);
        const toastId = toast.loading("Contratando candidato...");

        try {
            // Preparar datos - solo incluir end_date si está presente
            const dataToSend: any = {
                hire_date: hireFormData.hire_date,
                role: hireFormData.role,
                employment_type: hireFormData.employment_type,
                employment_status: hireFormData.employment_status,
                notes: hireFormData.notes,
            };

            // Solo agregar end_date si es temporal o pasantía y tiene valor
            if ((hireFormData.employment_type === "TMP" || hireFormData.employment_type === "PAS") && hireFormData.end_date) {
                dataToSend.end_date = hireFormData.end_date;
            }

            const response = await apiClient.post(`/api/ats/candidates/${id}/hire/`, dataToSend);

            toast.success("¡Candidato contratado exitosamente!", { id: toastId });
            setShowHireDialog(false);
            setErrors({});
            mutate(); // Refresh candidate data

            // Redirect to employee detail
            if (response.data.person_id) {
                setTimeout(() => {
                    router.push(`/admin/personnel/people/${response.data.person_id}`);
                }, 1500);
            }
        } catch (error: any) {
            console.error("Error hiring candidate:", error);
            const errorMsg = error.response?.data?.error || "Error al contratar candidato";
            toast.error(errorMsg, { id: toastId });
        } finally {
            setHiring(false);
        }
    };

    if (isLoading) {
        return (
            <div className="container mx-auto py-8 px-4">
                <p>Cargando candidato...</p>
            </div>
        );
    }

    if (error || !candidate) {
        return (
            <div className="container mx-auto py-8 px-4">
                <Card>
                    <CardHeader>
                        <CardTitle className="text-red-600">Error</CardTitle>
                        <CardDescription>No se pudo cargar el candidato</CardDescription>
                    </CardHeader>
                    <CardContent>
                        <Link href="/admin/ats/candidates">
                            <Button variant="outline">
                                <ArrowLeft className="w-4 h-4 mr-2" />
                                Volver a candidatos
                            </Button>
                        </Link>
                    </CardContent>
                </Card>
            </div>
        );
    }

    const canHire = candidate.stage === "OFF" || candidate.stage === "INT";

    return (
        <div className="container mx-auto py-8 px-4 max-w-5xl">
            {/* Header */}
            <div className="mb-6">
                <Link href="/admin/ats/candidates">
                    <Button variant="ghost" size="sm" className="mb-4">
                        <ArrowLeft className="w-4 h-4 mr-2" />
                        Volver a candidatos
                    </Button>
                </Link>

                <div className="flex items-start justify-between">
                    <div className="flex items-center gap-4">
                        {candidate.avatar ? (
                            <img
                                src={candidate.avatar}
                                alt={`${candidate.first_name} ${candidate.last_name}`}
                                className="h-20 w-20 rounded-full object-cover border-2 border-slate-200"
                            />
                        ) : (
                            <div className="flex h-20 w-20 items-center justify-center rounded-full bg-slate-100 text-slate-500 border-2 border-slate-200">
                                <span className="text-2xl font-bold">
                                    {candidate.first_name[0]}{candidate.last_name[0]}
                                </span>
                            </div>
                        )}
                        <div>
                            <h1 className="text-3xl font-bold text-slate-900">
                                {candidate.first_name} {candidate.last_name}
                            </h1>
                            <p className="text-muted-foreground mt-1">
                                {candidate.job_posting_title || "Candidato"}
                            </p>
                        </div>
                    </div>

                    <div className="flex items-center gap-3">
                        <Badge className={stageColors[candidate.stage]}>
                            {candidate.stage_display}
                        </Badge>

                        {canHire && candidate.stage !== "HIRED" && (
                            <Button
                                onClick={() => {
                                    setShowHireDialog(true);
                                    setErrors({});
                                }}
                                className="bg-brand-primary hover:bg-brand-primary/90"
                            >
                                <UserCheck className="w-4 h-4 mr-2" />
                                Contratar
                            </Button>
                        )}
                    </div>
                </div>
            </div>

            <div className="grid gap-6 md:grid-cols-2">
                {/* Información de Contacto */}
                <Card>
                    <CardHeader>
                        <CardTitle className="text-lg flex items-center gap-2">
                            <User className="w-5 h-5" />
                            Información de Contacto
                        </CardTitle>
                    </CardHeader>
                    <CardContent className="space-y-4">
                        <div className="flex items-center gap-3">
                            <Mail className="w-4 h-4 text-muted-foreground" />
                            <div>
                                <p className="text-sm text-muted-foreground">Email</p>
                                <p className="font-medium">{candidate.email}</p>
                            </div>
                        </div>

                        {candidate.phone && (
                            <div className="flex items-center gap-3">
                                <Phone className="w-4 h-4 text-muted-foreground" />
                                <div>
                                    <p className="text-sm text-muted-foreground">Teléfono</p>
                                    <p className="font-medium">{candidate.phone}</p>
                                </div>
                            </div>
                        )}

                        <div className="flex items-center gap-3">
                            <FileText className="w-4 h-4 text-muted-foreground" />
                            <div>
                                <p className="text-sm text-muted-foreground">Cédula</p>
                                <p className="font-medium">{candidate.national_id}</p>
                            </div>
                        </div>
                    </CardContent>
                </Card>

                {/* Información de Postulación */}
                <Card>
                    <CardHeader>
                        <CardTitle className="text-lg flex items-center gap-2">
                            <Briefcase className="w-5 h-5" />
                            Información de Postulación
                        </CardTitle>
                    </CardHeader>
                    <CardContent className="space-y-4">
                        <div className="flex items-center gap-3">
                            <MapPin className="w-4 h-4 text-muted-foreground" />
                            <div>
                                <p className="text-sm text-muted-foreground">Vacante</p>
                                <p className="font-medium">{candidate.job_posting_title}</p>
                            </div>
                        </div>

                        <div className="flex items-center gap-3">
                            <Calendar className="w-4 h-4 text-muted-foreground" />
                            <div>
                                <p className="text-sm text-muted-foreground">Fecha de Aplicación</p>
                                <p className="font-medium">
                                    {new Date(candidate.created_at).toLocaleDateString("es-ES", {
                                        day: "numeric",
                                        month: "long",
                                        year: "numeric",
                                    })}
                                </p>
                            </div>
                        </div>
                    </CardContent>
                </Card>

                {/* Curriculum Vitae */}
                {candidate.cv_file && (
                    <Card className="md:col-span-2">
                        <CardHeader>
                            <CardTitle className="text-lg flex items-center gap-2">
                                <FileText className="w-5 h-5" />
                                Curriculum Vitae
                            </CardTitle>
                        </CardHeader>
                        <CardContent>
                            <a
                                href={`http://localhost:8000${candidate.cv_file}`}
                                target="_blank"
                                rel="noopener noreferrer"
                                className="inline-block"
                            >
                                <Button>
                                    <Download className="w-4 h-4 mr-2" />
                                    Descargar CV
                                </Button>
                            </a>
                        </CardContent>
                    </Card>
                )}

                {/* Educación */}
                {candidate.education && candidate.education.length > 0 && (
                    <Card className="md:col-span-2">
                        <CardHeader>
                            <CardTitle className="text-lg">Educación</CardTitle>
                        </CardHeader>
                        <CardContent>
                            <div className="space-y-4">
                                {candidate.education.map((edu, index) => (
                                    <div key={edu.id || index} className="border-l-2 border-brand-primary pl-4">
                                        <h4 className="font-semibold">{edu.level_name} - {edu.field_name}</h4>
                                        <p className="text-sm text-muted-foreground">{edu.school_name}</p>
                                        <p className="text-xs text-muted-foreground mt-1">
                                            {new Date(edu.start_date).getFullYear()}
                                            {edu.end_date && ` - ${new Date(edu.end_date).getFullYear()}`}
                                        </p>
                                    </div>
                                ))}
                            </div>
                        </CardContent>
                    </Card>
                )}

                {/* Notas */}
                {candidate.notes && (
                    <Card className="md:col-span-2">
                        <CardHeader>
                            <CardTitle className="text-lg">Notas</CardTitle>
                        </CardHeader>
                        <CardContent>
                            <p className="text-sm whitespace-pre-wrap">{candidate.notes}</p>
                        </CardContent>
                    </Card>
                )}
            </div>

            {/* Hire Dialog */}
            <Dialog open={showHireDialog} onOpenChange={setShowHireDialog}>
                <DialogContent className="max-w-2xl">
                    <DialogHeader>
                        <DialogTitle>Contratar Candidato</DialogTitle>
                        <DialogDescription>
                            Completa los datos del contrato para {candidate.first_name} {candidate.last_name}
                        </DialogDescription>
                    </DialogHeader>

                    <div className="grid gap-4 py-4">
                        <div className="grid grid-cols-2 gap-4">
                            <div className="space-y-2">
                                <Label htmlFor="hire_date">Fecha de Inicio *</Label>
                                <Input
                                    id="hire_date"
                                    type="date"
                                    value={hireFormData.hire_date}
                                    onChange={(e) => {
                                        setHireFormData({ ...hireFormData, hire_date: e.target.value });
                                        setErrors({ ...errors, hire_date: "" });
                                    }}
                                    className={errors.hire_date ? "border-red-500" : ""}
                                />
                                {errors.hire_date && (
                                    <p className="text-sm text-red-600">{errors.hire_date}</p>
                                )}
                            </div>

                            <div className="space-y-2">
                                <Label htmlFor="role">Rol *</Label>
                                <Select
                                    value={hireFormData.role}
                                    onValueChange={(value) => setHireFormData({ ...hireFormData, role: value })}
                                >
                                    <SelectTrigger>
                                        <SelectValue />
                                    </SelectTrigger>
                                    <SelectContent>
                                        {roleOptions.map((option) => (
                                            <SelectItem key={option.value} value={option.value}>
                                                {option.label}
                                            </SelectItem>
                                        ))}
                                    </SelectContent>
                                </Select>
                            </div>
                        </div>

                        <div className="space-y-2">
                            <Label htmlFor="employment_type">Tipo de Contrato *</Label>
                            <Select
                                value={hireFormData.employment_type}
                                onValueChange={(value) => {
                                    setHireFormData({ ...hireFormData, employment_type: value, end_date: "" });
                                    setErrors({ ...errors, end_date: "" });
                                }}
                            >
                                <SelectTrigger>
                                    <SelectValue />
                                </SelectTrigger>
                                <SelectContent>
                                    {employmentTypeOptions.map((option) => (
                                        <SelectItem key={option.value} value={option.value}>
                                            {option.label}
                                        </SelectItem>
                                    ))}
                                </SelectContent>
                            </Select>
                        </div>

                        {/* Show end_date only for temporary or internship */}
                        {(hireFormData.employment_type === "TMP" || hireFormData.employment_type === "PAS") && (
                            <div className="space-y-2">
                                <Label htmlFor="end_date">
                                    Fecha de Fin {hireFormData.employment_type === "TMP" ? "*" : "(Opcional)"}
                                </Label>
                                <Input
                                    id="end_date"
                                    type="date"
                                    value={hireFormData.end_date}
                                    onChange={(e) => {
                                        setHireFormData({ ...hireFormData, end_date: e.target.value });
                                        setErrors({ ...errors, end_date: "" });
                                    }}
                                    min={hireFormData.hire_date}
                                    className={errors.end_date ? "border-red-500" : ""}
                                />
                                {errors.end_date && (
                                    <p className="text-sm text-red-600">{errors.end_date}</p>
                                )}
                                {!errors.end_date && (
                                    <p className="text-xs text-muted-foreground">
                                        {hireFormData.employment_type === "TMP"
                                            ? "Los contratos temporales requieren una fecha de finalización"
                                            : "Opcional para pasantías"}
                                    </p>
                                )}
                            </div>
                        )}

                        <div className="space-y-2">
                            <Label htmlFor="notes">Notas (Opcional)</Label>
                            <Textarea
                                id="notes"
                                rows={3}
                                placeholder="Notas adicionales sobre el contrato..."
                                value={hireFormData.notes}
                                onChange={(e) => setHireFormData({ ...hireFormData, notes: e.target.value })}
                            />
                        </div>
                    </div>

                    <DialogFooter>
                        <Button variant="outline" onClick={() => setShowHireDialog(false)} disabled={hiring}>
                            Cancelar
                        </Button>
                        <Button onClick={handleHire} disabled={hiring} className="bg-brand-primary hover:bg-brand-primary/90">
                            {hiring ? (
                                <>
                                    <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                                    Contratando...
                                </>
                            ) : (
                                <>
                                    <UserCheck className="w-4 h-4 mr-2" />
                                    Confirmar Contratación
                                </>
                            )}
                        </Button>
                    </DialogFooter>
                </DialogContent>
            </Dialog>
        </div>
    );
}
</file>

<file path="frontend2/app/(main)/admin/ats/candidates/page.tsx">
"use client";

import { CatalogCRUD, CatalogField } from "@/components/catalogs/catalog-crud";
import { ColumnDef } from "@tanstack/react-table";
import { Users, Eye, FileText } from "lucide-react";
import { Badge } from "@/components/ui/badge";
import { useRouter } from "next/navigation";
import { DropdownMenuItem } from "@/components/ui/dropdown-menu";
import { Button } from "@/components/ui/button";

interface Candidate {
    id: number;
    first_name: string;
    last_name: string;
    email: string;
    national_id: string;
    job_posting: number;
    job_posting_title: string;
    stage: string;
    stage_display: string;
    created_at: string;
    cv_file?: string;
}

const stageColors: Record<string, string> = {
    NEW: "bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200",
    REV: "bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200",
    INT: "bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200",
    OFF: "bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200",
    HIRED: "bg-emerald-100 text-emerald-800 dark:bg-emerald-900 dark:text-emerald-200",
    REJ: "bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200",
    POOL: "bg-cyan-100 text-cyan-800 dark:bg-cyan-900 dark:text-cyan-200",
};

export default function CandidatesPage() {
    const router = useRouter();

    const fields: CatalogField[] = [
        {
            name: "first_name",
            label: "Nombres",
            type: "text",
            required: true,
        },
        {
            name: "last_name",
            label: "Apellidos",
            type: "text",
            required: true,
        },
        {
            name: "national_id",
            label: "Cédula",
            type: "text",
            required: true,
        },
        {
            name: "email",
            label: "Correo Electrónico",
            type: "email",
            required: true,
        },
        {
            name: "phone",
            label: "Teléfono",
            type: "text",
            required: true,
        },
        {
            name: "job_posting",
            label: "Vacante",
            type: "select",
            required: true,
            optionsUrl: "/api/ats/jobs/",
            optionLabelKey: "title",
            optionValueKey: "id",
        },
        {
            name: "stage",
            label: "Etapa",
            type: "select",
            options: [
                { label: "Nuevo", value: "NEW" },
                { label: "En Revisión", value: "REV" },
                { label: "Entrevista/Pruebas", value: "INT" },
                { label: "Oferta Enviada", value: "OFF" },
                { label: "Contratado", value: "HIRED" },
                { label: "Rechazado", value: "REJ" },
                { label: "Banco de Elegibles", value: "POOL" },
            ],
            defaultValue: "NEW",
        },
    ];

    const columns: ColumnDef<Candidate>[] = [
        {
            accessorKey: "name",
            header: "Nombre",
            cell: ({ row }) => (
                <div className="font-medium">
                    {row.original.first_name} {row.original.last_name}
                </div>
            ),
        },
        {
            accessorKey: "national_id",
            header: "Cédula",
            cell: ({ row }) => <div>{row.getValue("national_id")}</div>,
        },
        {
            accessorKey: "job_posting_title",
            header: "Vacante",
            cell: ({ row }) => <div className="max-w-[200px] truncate" title={row.getValue("job_posting_title")}>{row.getValue("job_posting_title")}</div>,
        },
        {
            accessorKey: "stage_display",
            header: "Etapa",
            cell: ({ row }) => {
                const stage = row.original.stage;
                return (
                    <Badge className={stageColors[stage] || ""}>
                        {row.getValue("stage_display")}
                    </Badge>
                );
            },
        },
        {
            accessorKey: "created_at",
            header: "Fecha",
            cell: ({ row }) => (
                <div className="text-sm">
                    {new Date(row.getValue("created_at")).toLocaleDateString("es-ES")}
                </div>
            ),
        },
    ];

    return (
        <CatalogCRUD
            title="Gestión de Candidatos"
            icon={Users}
            apiUrl="/api/ats/candidates/"
            fields={fields}
            columns={columns}
            searchKey="search"
            singularName="Candidato"
            extraActions={(item) => (
                <>
                    <DropdownMenuItem onClick={() => router.push(`/admin/ats/candidates/${item.id}`)}>
                        <Eye className="mr-2 h-4 w-4" />
                        Ver Perfil
                    </DropdownMenuItem>
                    {item.cv_file && (
                        <DropdownMenuItem asChild>
                            <a
                                href={`http://localhost:8000${item.cv_file}`}
                                target="_blank"
                                rel="noopener noreferrer"
                                className="cursor-pointer"
                            >
                                <FileText className="mr-2 h-4 w-4" />
                                Descargar CV
                            </a>
                        </DropdownMenuItem>
                    )}
                </>
            )}
        />
    );
}
</file>

<file path="frontend2/app/(main)/admin/ats/jobs/[id]/edit/page.tsx">
"use client";

import { useState, useEffect } from "react";
import { useRouter, useParams } from "next/navigation";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Switch } from "@/components/ui/switch";
import { ArrowLeft, Loader2, Save, AlertCircle, CheckCircle2 } from "lucide-react";
import Link from "next/link";
import apiClient from "@/lib/api-client";
import { toast } from "sonner";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Combobox } from "@/components/ui/combobox";
import { DatePicker } from "@/components/ui/date-picker";

interface Department {
    id: number;
    name: string;
}

interface Position {
    id: number;
    job_title_name: string;
    name?: string;
    department_name: string;
    department: number;
    vacancies: number;
}

interface ValidationErrors {
    title?: string;
    description?: string;
    position?: string;
}

interface PositionWithVacancies extends Position {
    available_vacancies?: number;
    active_employees?: number;
}

export default function EditJobPage() {
    const router = useRouter();
    const params = useParams();
    const jobId = params.id as string;

    const [positions, setPositions] = useState<Position[]>([]);
    const [departments, setDepartments] = useState<Department[]>([]);
    const [loading, setLoading] = useState(false);
    const [loadingData, setLoadingData] = useState(true);
    const [errors, setErrors] = useState<ValidationErrors>({});

    const [formData, setFormData] = useState({
        title: "",
        department: "",
        position: "",
        description: "",
        location: "",
        published_date: undefined as Date | undefined,
        closing_date: undefined as Date | undefined,
        status: "DRAFT" as string,
        ask_education: false,
    });

    useEffect(() => {
        loadData();
    }, []);

    async function loadData() {
        try {
            const [posRes, depRes, jobRes] = await Promise.all([
                apiClient.get("/api/organization/positions/"),
                apiClient.get("/api/organization/departments/"),
                apiClient.get(`/api/ats/jobs/${jobId}/`),
            ]);
            const positionsData = posRes.data.results || posRes.data;
            const departmentsData = depRes.data.results || depRes.data;
            setPositions(positionsData);
            setDepartments(departmentsData);

            // Populate form data
            const job = jobRes.data;
            const positionId = job.position;

            // Find the position to get its department
            const foundPosition = positionsData.find((p: Position) => p.id === positionId);
            const departmentId = foundPosition?.department;

            setFormData({
                title: job.title || "",
                department: departmentId?.toString() || "",
                position: positionId?.toString() || "",
                description: job.description || "",
                location: job.location || "",
                published_date: job.published_date ? new Date(job.published_date) : undefined,
                closing_date: job.closing_date ? new Date(job.closing_date) : undefined,
                status: job.status || "DRAFT",
                ask_education: job.ask_education || false,
            });

            setLoadingData(false);
        } catch (error) {
            console.error("Error loading data:", error);
            toast.error("Error al cargar datos");
            setLoadingData(false);
        }
    }

    // Validación en tiempo real del título
    const validateTitle = (value: string) => {
        if (!value) {
            return "El título es obligatorio";
        }
        if (!/^[a-zA-ZáéíóúÁÉÍÓÚñÑ\\s]+$/.test(value)) {
            return "El título solo puede contener letras y espacios";
        }
        if (value.length < 5) {
            return "El título debe tener al menos 5 caracteres";
        }
        return "";
    };

    // Validación en tiempo real de la descripción
    const validateDescription = (value: string) => {
        if (!value) {
            return "La descripción es obligatoria";
        }
        if (value.length < 50) {
            return "La descripción debe tener al menos 50 caracteres";
        }
        if (value.length > 1000) {
            return "La descripción no puede exceder 1000 caracteres";
        }
        return "";
    };

    const handleTitleChange = (value: string) => {
        setFormData({ ...formData, title: value });
        const error = validateTitle(value);
        setErrors({ ...errors, title: error });
    };

    const handleDescriptionChange = (value: string) => {
        setFormData({ ...formData, description: value });
        const error = validateDescription(value);
        setErrors({ ...errors, description: error });
    };

    const handlePositionChange = async (value: string | number) => {
        const positionId = value.toString();
        setFormData({ ...formData, position: positionId });

        // Calculate available vacancies
        const position = positions.find(p => p.id.toString() === positionId);
        if (position) {
            try {
                const res = await apiClient.get("/api/employment/employments/", {
                    params: { position: positionId, page_size: 1000 }
                });
                const activeEmployees = res.data.results?.filter((emp: any) =>
                    emp.current_status_name && emp.current_status_name.toLowerCase().includes("activo")
                ).length || 0;

                const availableVacancies = position.vacancies - activeEmployees;

                // Update position with calculated data
                const updatedPositions = positions.map(p =>
                    p.id === position.id
                        ? { ...p, available_vacancies: availableVacancies, active_employees: activeEmployees }
                        : p
                );
                setPositions(updatedPositions as Position[]);
            } catch (error) {
                console.error("Error calculating vacancies:", error);
            }
        }
    };

    async function handleSubmit(e: React.FormEvent) {
        e.preventDefault();

        // Validar todos los campos
        const titleError = validateTitle(formData.title);
        const descError = validateDescription(formData.description);

        if (titleError || descError) {
            setErrors({
                title: titleError,
                description: descError,
            });
            toast.error("Por favor corrige los errores del formulario");
            return;
        }

        setLoading(true);
        const toastId = toast.loading("Actualizando vacante...");

        try {
            const payload: any = {
                title: formData.title,
                position: parseInt(formData.position),
                description: formData.description,
                location: formData.location,
                status: formData.status,
                ask_education: formData.ask_education,
            };
            // Note: department is NOT sent to backend, it's only for frontend filtering

            // Add dates if provided (convert to YYYY-MM-DD format)
            if (formData.published_date) {
                payload.published_date = formData.published_date.toISOString().split('T')[0];
            }
            if (formData.closing_date) {
                payload.closing_date = formData.closing_date.toISOString().split('T')[0];
            }

            const res = await apiClient.put(`/api/ats/jobs/${jobId}/`, payload);

            toast.success("Vacante actualizada exitosamente", { id: toastId });
            router.push(`/admin/ats/jobs`);
        } catch (error: any) {
            let errorMessage = "Error al actualizar la vacante";
            if (error.response?.data) {
                const data = error.response.data;
                if (typeof data === "object" && data !== null) {
                    const messages = Object.values(data).flat().map(String);
                    if (messages.length > 0) {
                        errorMessage = messages.join(" ");
                    }
                }
            }
            toast.error(errorMessage, { id: toastId });
        } finally {
            setLoading(false);
        }
    }

    const filteredPositions = positions.filter((p) => {
        if (!formData.department) return false;
        return p.department?.toString() === formData.department;
    });

    const selectedPosition = positions.find((p) => p.id.toString() === formData.position);
    const isFormValid = !errors.title && !errors.description &&
        formData.title && formData.description && formData.position;

    if (loadingData) {
        return (
            <div className="container mx-auto py-8 px-4">
                <p>Cargando...</p>
            </div>
        );
    }

    return (
        <div className="container mx-auto py-8 px-4">
            <div className="mb-6">
                <Link href="/admin/ats/jobs">
                    <Button variant="ghost">
                        <ArrowLeft className="w-4 h-4 mr-2" />
                        Volver a Vacantes
                    </Button>
                </Link>
                <h1 className="text-3xl font-bold mt-4">Editar Vacante</h1>
                <p className="text-muted-foreground">Actualizar la información de la vacante</p>
            </div>

            <form onSubmit={handleSubmit} className="max-w-3xl space-y-6">
                <Card>
                    <CardHeader>
                        <CardTitle>Información Básica</CardTitle>
                    </CardHeader>
                    <CardContent className="space-y-4">
                        <div className="space-y-2">
                            <Label htmlFor="title">Título de la Vacante *</Label>
                            <Input
                                id="title"
                                placeholder="Ej: Desarrollador Full Stack Senior"
                                value={formData.title}
                                onChange={(e) => handleTitleChange(e.target.value)}
                                className={errors.title ? "border-red-500" : ""}
                            />
                            {errors.title && (
                                <div className="flex items-center gap-2 text-sm text-red-600">
                                    <AlertCircle className="w-4 h-4" />
                                    {errors.title}
                                </div>
                            )}
                            {formData.title && !errors.title && (
                                <div className="flex items-center gap-2 text-sm text-green-600">
                                    <CheckCircle2 className="w-4 h-4" />
                                    Título válido
                                </div>
                            )}
                        </div>

                        <div className="grid gap-4 md:grid-cols-2">
                            <div className="space-y-2">
                                <Label>Departamento *</Label>
                                <Combobox
                                    options={departments.map((d) => ({
                                        value: d.id.toString(),
                                        label: d.name,
                                    }))}
                                    value={formData.department}
                                    onSelect={(value) => {
                                        setFormData({ ...formData, department: value.toString(), position: "" });
                                        setErrors({ ...errors, position: "" });
                                    }}
                                    placeholder="Selecciona un departamento"
                                    emptyText="No se encontraron departamentos"
                                />
                            </div>

                            <div className="space-y-2">
                                <Label>Posición *</Label>
                                <Combobox
                                    options={filteredPositions.map((p) => ({
                                        value: p.id.toString(),
                                        label: p.job_title_name || p.name || `Posición #${p.id}`,
                                    }))}
                                    value={formData.position}
                                    onSelect={handlePositionChange}
                                    placeholder="Selecciona una posición"
                                    emptyText={
                                        formData.department
                                            ? "No hay posiciones en este departamento"
                                            : "Selecciona un departamento primero"
                                    }
                                />
                                {errors.position && (
                                    <div className="flex items-start gap-2 text-sm text-red-600">
                                        <AlertCircle className="w-4 h-4 mt-0.5 shrink-0" />
                                        <span>{errors.position}</span>
                                    </div>
                                )}
                            </div>
                        </div>

                        {selectedPosition && !errors.position && (() => {
                            const pos = selectedPosition as PositionWithVacancies;
                            const available = pos.available_vacancies ?? 0;
                            const total = pos.vacancies;
                            const isFullyOccupied = available <= 0;

                            return (
                                <Card className={isFullyOccupied ? "border-red-200 bg-red-50" : "border-green-200 bg-green-50"}>
                                    <CardContent className="p-4">
                                        <div className="flex items-center justify-between">
                                            <div>
                                                <h4 className="font-semibold">
                                                    {selectedPosition.job_title_name || selectedPosition.name}
                                                </h4>
                                                <p className="text-sm text-muted-foreground">
                                                    {selectedPosition.department_name}
                                                </p>
                                            </div>
                                            <div className="text-right">
                                                <p className={`text-2xl font-bold ${isFullyOccupied ? 'text-red-600' : 'text-green-600'}`}>
                                                    {available}/{total}
                                                </p>
                                                <p className="text-xs text-muted-foreground">Disponibles/Total</p>
                                            </div>
                                        </div>
                                    </CardContent>
                                </Card>
                            );
                        })()}

                        <div className="space-y-2">
                            <Label htmlFor="description">Descripción *</Label>
                            <Textarea
                                id="description"
                                rows={6}
                                placeholder="Describe las responsabilidades y objetivos del puesto... (mínimo 50 caracteres)"
                                value={formData.description}
                                onChange={(e) => handleDescriptionChange(e.target.value)}
                                className={errors.description ? "border-red-500" : ""}
                            />
                            <div className="flex items-center justify-between text-xs">
                                <div>
                                    {errors.description && (
                                        <div className="flex items-center gap-2 text-red-600">
                                            <AlertCircle className="w-3 h-3" />
                                            {errors.description}
                                        </div>
                                    )}
                                    {formData.description && !errors.description && (
                                        <div className="flex items-center gap-2 text-green-600">
                                            <CheckCircle2 className="w-3 h-3" />
                                            Descripción válida
                                        </div>
                                    )}
                                </div>
                                <span className={`text-muted-foreground ${formData.description.length > 1000 ? 'text-red-600' : ''}`}>
                                    {formData.description.length}/1000 caracteres
                                </span>
                            </div>
                        </div>

                    </CardContent>
                </Card>

                <Card>
                    <CardHeader>
                        <CardTitle>Fechas y Publicación</CardTitle>
                    </CardHeader>
                    <CardContent className="space-y-4">
                        <div className="space-y-2">
                            <Label htmlFor="status">Estado de Publicación *</Label>
                            <Combobox
                                options={[
                                    { value: "DRAFT", label: "Borrador" },
                                    { value: "PUBLISHED", label: "Publicada" },
                                    { value: "FROZEN", label: "Congelada" },
                                ]}
                                value={formData.status}
                                onSelect={(value) => setFormData({ ...formData, status: value.toString() })}
                                placeholder="Selecciona el estado"
                                emptyText="No hay estados disponibles"
                            />
                        </div>

                        <div className="grid gap-4 md:grid-cols-2">
                            <div className="space-y-2">
                                <Label htmlFor="published_date">Fecha de Publicación</Label>
                                <DatePicker
                                    value={formData.published_date}
                                    onChange={(date) => setFormData({ ...formData, published_date: date })}
                                    placeholder="dd/mm/aaaa"
                                />
                            </div>

                            <div className="space-y-2">
                                <Label htmlFor="closing_date">Fecha de Cierre</Label>
                                <DatePicker
                                    value={formData.closing_date}
                                    onChange={(date) => setFormData({ ...formData, closing_date: date })}
                                    placeholder="dd/mm/aaaa"
                                />
                            </div>
                        </div>

                        <div className="flex items-center justify-between rounded-lg border p-3">
                            <div>
                                <Label htmlFor="ask_education">Solicitar Educación</Label>
                                <p className="text-sm text-muted-foreground">
                                    Requerir historial académico del candidato
                                </p>
                            </div>
                            <Switch
                                id="ask_education"
                                checked={formData.ask_education}
                                onCheckedChange={(checked) =>
                                    setFormData({ ...formData, ask_education: checked })
                                }
                            />
                        </div>
                    </CardContent>
                </Card>

                <div className="flex gap-3">
                    <Button type="submit" disabled={loading || !isFormValid}>
                        {loading ? (
                            <>
                                <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                                Guardando...
                            </>
                        ) : (
                            <>
                                <Save className="mr-2 h-4 w-4" />
                                Guardar Cambios
                            </>
                        )}
                    </Button>
                    <Button
                        type="button"
                        variant="outline"
                        onClick={() => router.push("/admin/ats/jobs")}
                    >
                        Cancelar
                    </Button>
                </div>
            </form>
        </div>
    );
}
</file>

<file path="frontend2/app/(main)/admin/ats/jobs/[id]/page.tsx">
"use client";

import useSWR from 'swr';
import { useParams } from 'next/navigation';
import Link from 'next/link';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { ArrowLeft, Briefcase, MapPin, Calendar, Building2, Users, CheckCircle, XCircle, Edit, LayoutGrid, Info } from 'lucide-react';
import { Separator } from '@/components/ui/separator';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { JobKanbanBoard } from '@/components/ats/JobKanbanBoard';
import { JobCandidatesGrid } from '@/components/ats/JobCandidatesGrid';
import apiClient from '@/lib/api-client';

const fetcher = (url: string) => apiClient.get(url).then((res) => res.data);

interface PositionFunction {
    id: number;
    description: string;
    order: number;
}

interface PositionRequirement {
    id: number;
    description: string;
    is_mandatory: boolean;
    order: number;
}

interface JobPosting {
    id: number;
    title: string;
    description: string;
    location: string | null;
    position: number;
    position_title: string | null;
    position_objective: string | null;
    department_name: string | null;
    status: string;
    published_date: string | null;
    closing_date: string | null;
    candidates_count: number;
    ask_education: boolean;
    position_functions: PositionFunction[];
    position_requirements: PositionRequirement[];
}

const statusColors = {
    DRAFT: "bg-gray-100 text-gray-800",
    PUBLISHED: "bg-green-100 text-green-800",
    CLOSED: "bg-red-100 text-red-800",
    FROZEN: "bg-blue-100 text-blue-800",
};

const statusLabels = {
    DRAFT: "Borrador",
    PUBLISHED: "Publicada",
    CLOSED: "Cerrada",
    FROZEN: "Congelada",
};

export default function JobDetailPage() {
    const params = useParams();
    const id = params?.id as string;

    const { data: job, error, isLoading } = useSWR<JobPosting>(
        id ? `/api/ats/jobs/${id}/` : null,
        fetcher
    );

    if (isLoading) {
        return (
            <div className="container mx-auto py-8 px-4">
                <p>Cargando vacante...</p>
            </div>
        );
    }

    if (error || !job) {
        return (
            <div className="container mx-auto py-8 px-4">
                <Card>
                    <CardHeader>
                        <CardTitle className="text-red-600">Error</CardTitle>
                        <CardDescription>No se pudo cargar la vacante</CardDescription>
                    </CardHeader>
                </Card>
            </div>
        );
    }

    return (
        <div className="flex flex-col h-full space-y-6">
            {/* Header Global */}
            <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 border-b pb-6">
                <div className="flex flex-col items-center sm:items-start">
                    <div className="flex items-center gap-3">
                        <h1 className="text-3xl font-bold tracking-tight">{job.title}</h1>
                        <Badge className={statusColors[job.status as keyof typeof statusColors]}>
                            {statusLabels[job.status as keyof typeof statusLabels]}
                        </Badge>
                    </div>
                    <div className="flex items-center text-muted-foreground mt-1 gap-4 text-sm">
                        <span className="flex items-center"><Briefcase className="h-3 w-3 mr-2" /> {job.position_title}</span>
                        <span className="flex items-center"><Building2 className="h-3 w-3 mr-2" /> {job.department_name || "-"}</span>
                        <span className="flex items-center"><MapPin className="h-3 w-3 mr-2" /> {job.location || "-"}</span>
                    </div>
                </div>

                <div className="flex gap-2">
                    <Link href="/admin/ats/jobs">
                        <Button variant="outline">
                            <ArrowLeft className="w-4 h-4 mr-2" />
                            Volver
                        </Button>
                    </Link>
                    <Link href={`/admin/ats/jobs/${id}/edit`}>
                        <Button>
                            <Edit className="w-4 h-4 mr-2" />
                            Editar
                        </Button>
                    </Link>
                </div>
            </div>

            <Tabs defaultValue="info" className="flex-1 flex flex-col">
                <TabsList className="w-full flex flex-col min-[24rem]:grid min-[24rem]:grid-cols-1 md:grid-cols-3 h-auto p-1 bg-muted/50 gap-1">
                    <TabsTrigger
                        value="info"
                        className="data-[state=active]:bg-primary data-[state=active]:text-primary-foreground py-3 transition-all duration-300 w-full"
                    >
                        <Info className="mr-1 size-4" />
                        Información
                    </TabsTrigger>
                    <TabsTrigger
                        value="candidates"
                        className="data-[state=active]:bg-primary data-[state=active]:text-primary-foreground py-3 transition-all duration-300 w-full"
                    >
                        <Users className="mr-1 size-4" />
                        Candidatos
                    </TabsTrigger>
                    <TabsTrigger
                        value="board"
                        className="data-[state=active]:bg-primary data-[state=active]:text-primary-foreground py-3 transition-all duration-300 w-full"
                    >
                        <LayoutGrid className="mr-1 size-4" />
                        Tablero
                    </TabsTrigger>
                </TabsList>

                <div className="flex-1 mt-6">
                    <TabsContent value="info" className="space-y-6 m-0">
                        {/* Summary Cards */}
                        <div className="grid md:grid-cols-3 gap-6">
                            <Card>
                                <CardContent className="pt-6 flex items-center gap-4">
                                    <div className="p-2 bg-primary/10 rounded-full">
                                        <Users className="w-8 h-8 text-primary" />
                                    </div>
                                    <div>
                                        <p className="text-sm font-medium text-muted-foreground">Candidatos</p>
                                        <p className="text-2xl font-bold">{job.candidates_count}</p>
                                    </div>
                                </CardContent>
                            </Card>

                            {job.published_date && (
                                <Card className="md:col-span-2">
                                    <CardContent className="pt-6 flex items-center justify-between text-sm text-muted-foreground">
                                        <div className="flex items-center gap-2">
                                            <Calendar className="w-4 h-4" />
                                            <span>Publicada: {new Date(job.published_date).toLocaleDateString("es-ES")}</span>
                                        </div>
                                        {job.closing_date && (
                                            <span>Cierre: {new Date(job.closing_date).toLocaleDateString("es-ES")}</span>
                                        )}
                                    </CardContent>
                                </Card>
                            )}
                        </div>

                        {/* Objetivo */}
                        {job.position_objective && (
                            <Card>
                                <CardHeader>
                                    <CardTitle className="text-xl">Objetivo del Cargo</CardTitle>
                                </CardHeader>
                                <CardContent>
                                    <p className="text-muted-foreground whitespace-pre-wrap">{job.position_objective}</p>
                                </CardContent>
                            </Card>
                        )}

                        {/* Descripción */}
                        <Card>
                            <CardHeader>
                                <CardTitle className="text-xl">Descripción de la Vacante</CardTitle>
                            </CardHeader>
                            <CardContent>
                                <p className="text-muted-foreground whitespace-pre-wrap">{job.description}</p>
                            </CardContent>
                        </Card>

                        {/* Funciones */}
                        {job.position_functions && job.position_functions.length > 0 && (
                            <Card>
                                <CardHeader>
                                    <CardTitle className="text-xl">Funciones del Cargo</CardTitle>
                                </CardHeader>
                                <CardContent>
                                    <ul className="space-y-3">
                                        {job.position_functions
                                            .sort((a, b) => a.order - b.order)
                                            .map((func) => (
                                                <li key={func.id} className="flex items-start gap-3">
                                                    <CheckCircle className="w-5 h-5 text-brand-primary shrink-0 mt-0.5" />
                                                    <span>{func.description}</span>
                                                </li>
                                            ))}
                                    </ul>
                                </CardContent>
                            </Card>
                        )}

                        {/* Requisitos */}
                        {job.position_requirements && job.position_requirements.length > 0 && (
                            <Card>
                                <CardHeader>
                                    <CardTitle className="text-xl">Requisitos</CardTitle>
                                </CardHeader>
                                <CardContent>
                                    <ul className="space-y-3">
                                        {job.position_requirements
                                            .sort((a, b) => a.order - b.order)
                                            .map((req) => (
                                                <li key={req.id} className="flex items-start gap-3">
                                                    {req.is_mandatory ? (
                                                        <XCircle className="w-5 h-5 text-red-500 shrink-0 mt-0.5" />
                                                    ) : (
                                                        <CheckCircle className="w-5 h-5 text-green-500 shrink-0 mt-0.5" />
                                                    )}
                                                    <div>
                                                        <span>{req.description}</span>
                                                        {req.is_mandatory && (
                                                            <Badge variant="destructive" className="ml-2">Obligatorio</Badge>
                                                        )}
                                                    </div>
                                                </li>
                                            ))}
                                    </ul>
                                </CardContent>
                            </Card>
                        )}
                    </TabsContent>

                    <TabsContent value="candidates" className="m-0">
                        <JobCandidatesGrid jobId={id} />
                    </TabsContent>

                    <TabsContent value="board" className="m-0">
                        <JobKanbanBoard jobId={id} />
                    </TabsContent>
                </div>
            </Tabs>
        </div>
    );
}
</file>

<file path="frontend2/app/(main)/admin/ats/jobs/new/page.tsx">
"use client";

import { useState, useEffect } from "react";
import { useRouter } from "next/navigation";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Switch } from "@/components/ui/switch";
import { ArrowLeft, Loader2, Save, AlertCircle, CheckCircle2 } from "lucide-react";
import Link from "next/link";
import apiClient from "@/lib/api-client";
import { toast } from "sonner";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Combobox } from "@/components/ui/combobox";
import { DatePicker } from "@/components/ui/date-picker";

interface Department {
    id: number;
    name: string;
}

interface Position {
    id: number;
    job_title_name: string;
    name?: string;
    department_name: string;
    department: number;
    vacancies: number;
}

interface ValidationErrors {
    title?: string;
    description?: string;
    position?: string;
}

interface PositionWithVacancies extends Position {
    available_vacancies?: number;
    active_employees?: number;
}

export default function NewJobPage() {
    const router = useRouter();
    const [positions, setPositions] = useState<Position[]>([]);
    const [departments, setDepartments] = useState<Department[]>([]);
    const [loading, setLoading] = useState(false);
    const [errors, setErrors] = useState<ValidationErrors>({});

    const [formData, setFormData] = useState({
        title: "",
        department: "",
        position: "",
        description: "",
        location: "Porlamar",
        published_date: undefined as Date | undefined,
        closing_date: undefined as Date | undefined,
        status: "DRAFT" as string,
        ask_education: false,
    });

    useEffect(() => {
        loadData();
    }, []);

    async function loadData() {
        try {
            const [posRes, depRes] = await Promise.all([
                apiClient.get("/api/organization/positions/"),
                apiClient.get("/api/organization/departments/"),
            ]);
            setPositions(posRes.data.results || posRes.data);
            setDepartments(depRes.data.results || depRes.data);
        } catch (error) {
            console.error("Error loading data:", error);
            toast.error("Error al cargar datos");
        }
    }

    // Validación en tiempo real del título
    const validateTitle = (value: string) => {
        if (!value) {
            return "El título es obligatorio";
        }
        if (!/^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$/.test(value)) {
            return "El título solo puede contener letras y espacios";
        }
        if (value.length < 5) {
            return "El título debe tener al menos 5 caracteres";
        }
        return "";
    };

    // Validación en tiempo real de la descripción
    const validateDescription = (value: string) => {
        if (!value) {
            return "La descripción es obligatoria";
        }
        if (value.length < 50) {
            return "La descripción debe tener al menos 50 caracteres";
        }
        if (value.length > 1000) {
            return "La descripción no puede exceder 1000 caracteres";
        }
        return "";
    };

    // Validar disponibilidad de cupos
    const validatePosition = async (positionId: string) => {
        if (!positionId) return "";

        try {
            const position = positions.find(p => p.id.toString() === positionId);
            if (!position) return "";

            // Verificar si hay cupos disponibles
            const res = await apiClient.get("/api/employment/employments/", {
                params: { position: positionId, page_size: 1000 }
            });
            const activeEmployees = res.data.results?.filter((emp: any) =>
                emp.current_status_name && emp.current_status_name.toLowerCase().includes("activo")
            ).length || 0;

            if (activeEmployees >= position.vacancies) {
                return `Esta posición está ocupada al 100% (${activeEmployees}/${position.vacancies}). No se pueden crear vacantes.`;
            }
            return "";
        } catch (error) {
            console.error("Error validating position:", error);
            return "";
        }
    };

    const handleTitleChange = (value: string) => {
        setFormData({ ...formData, title: value });
        const error = validateTitle(value);
        setErrors({ ...errors, title: error });
    };

    const handleDescriptionChange = (value: string) => {
        setFormData({ ...formData, description: value });
        const error = validateDescription(value);
        setErrors({ ...errors, description: error });
    };

    const handlePositionChange = async (value: string | number) => {
        const positionId = value.toString();
        setFormData({ ...formData, position: positionId });

        // Calculate available vacancies
        const position = positions.find(p => p.id.toString() === positionId);
        if (position) {
            try {
                const res = await apiClient.get("/api/employment/employments/", {
                    params: { position: positionId, page_size: 1000 }
                });
                const activeEmployees = res.data.results?.filter((emp: any) =>
                    emp.current_status_name && emp.current_status_name.toLowerCase().includes("activo")
                ).length || 0;

                const availableVacancies = position.vacancies - activeEmployees;

                // Update position with calculated data
                const updatedPositions = positions.map(p =>
                    p.id === position.id
                        ? { ...p, available_vacancies: availableVacancies, active_employees: activeEmployees }
                        : p
                );
                setPositions(updatedPositions as Position[]);

                if (availableVacancies <= 0) {
                    setErrors({ ...errors, position: `Esta posición está ocupada al 100% (${activeEmployees}/${position.vacancies}). No se pueden crear vacantes.` });
                } else {
                    setErrors({ ...errors, position: "" });
                }
            } catch (error) {
                console.error("Error calculating vacancies:", error);
            }
        }
    };

    async function handleSubmit(e: React.FormEvent) {
        e.preventDefault();

        // Validar todos los campos
        const titleError = validateTitle(formData.title);
        const descError = validateDescription(formData.description);

        // Check if there are any existing errors (including position errors from handlePositionChange)
        if (titleError || descError || errors.position) {
            setErrors({
                title: titleError,
                description: descError,
                position: errors.position || "",
            });
            toast.error("Por favor corrige los errores del formulario");
            return;
        }

        setLoading(true);
        const toastId = toast.loading("Creando vacante...");

        try {
            const payload: any = {
                title: formData.title,
                position: parseInt(formData.position),
                description: formData.description,
                location: formData.location,
                status: formData.status,
                ask_education: formData.ask_education,
            };
            // Note: department is NOT sent to backend, it's only for frontend filtering

            // Add dates if provided (convert to YYYY-MM-DD format)
            if (formData.published_date) {
                payload.published_date = formData.published_date.toISOString().split('T')[0];
            }
            if (formData.closing_date) {
                payload.closing_date = formData.closing_date.toISOString().split('T')[0];
            }

            const res = await apiClient.post("/api/ats/jobs/", payload);

            toast.success("Vacante creada exitosamente", { id: toastId });
            router.push(`/admin/ats/jobs`);
        } catch (error: any) {
            let errorMessage = "Error al crear la vacante";
            if (error.response?.data) {
                const data = error.response.data;
                if (typeof data === "object" && data !== null) {
                    const messages = Object.values(data).flat().map(String);
                    if (messages.length > 0) {
                        errorMessage = messages.join(" ");
                    }
                }
            }
            toast.error(errorMessage, { id: toastId });
        } finally {
            setLoading(false);
        }
    }

    const filteredPositions = positions.filter((p) => {
        if (!formData.department) return false;
        return p.department?.toString() === formData.department;
    });

    const selectedPosition = positions.find((p) => p.id.toString() === formData.position);
    const isFormValid = !errors.title && !errors.description && !errors.position &&
        formData.title && formData.description && formData.position;

    return (
        <div className="container mx-auto py-8 px-4">
            <div className="mb-6">
                <Link href="/admin/ats/jobs">
                    <Button variant="ghost">
                        <ArrowLeft className="w-4 h-4 mr-2" />
                        Volver a Vacantes
                    </Button>
                </Link>
                <h1 className="text-3xl font-bold mt-4">Nueva Vacante</h1>
                <p className="text-muted-foreground">Crear una nueva oferta de trabajo</p>
            </div>

            <form onSubmit={handleSubmit} className="max-w-3xl space-y-6">
                <Card>
                    <CardHeader>
                        <CardTitle>Información Básica</CardTitle>
                    </CardHeader>
                    <CardContent className="space-y-4">
                        <div className="space-y-2">
                            <Label htmlFor="title">Título de la Vacante *</Label>
                            <Input
                                id="title"
                                placeholder="Ej: Desarrollador Full Stack Senior"
                                value={formData.title}
                                onChange={(e) => handleTitleChange(e.target.value)}
                                className={errors.title ? "border-red-500" : ""}
                            />
                            {errors.title && (
                                <div className="flex items-center gap-2 text-sm text-red-600">
                                    <AlertCircle className="w-4 h-4" />
                                    {errors.title}
                                </div>
                            )}
                            {formData.title && !errors.title && (
                                <div className="flex items-center gap-2 text-sm text-green-600">
                                    <CheckCircle2 className="w-4 h-4" />
                                    Título válido
                                </div>
                            )}
                        </div>

                        <div className="grid gap-4 md:grid-cols-2">
                            <div className="space-y-2">
                                <Label>Departamento *</Label>
                                <Combobox
                                    options={departments.map((d) => ({
                                        value: d.id.toString(),
                                        label: d.name,
                                    }))}
                                    value={formData.department}
                                    onSelect={(value) => {
                                        setFormData({ ...formData, department: value.toString(), position: "" });
                                        setErrors({ ...errors, position: "" });
                                    }}
                                    placeholder="Selecciona un departamento"
                                    emptyText="No se encontraron departamentos"
                                />
                            </div>

                            <div className="space-y-2">
                                <Label>Posición *</Label>
                                <Combobox
                                    options={filteredPositions.map((p) => ({
                                        value: p.id.toString(),
                                        label: p.job_title_name || p.name || `Posición #${p.id}`,
                                    }))}
                                    value={formData.position}
                                    onSelect={handlePositionChange}
                                    placeholder="Selecciona una posición"
                                    emptyText={
                                        formData.department
                                            ? "No hay posiciones en este departamento"
                                            : "Selecciona un departamento primero"
                                    }
                                />
                                {errors.position && (
                                    <div className="flex items-start gap-2 text-sm text-red-600">
                                        <AlertCircle className="w-4 h-4 mt-0.5 shrink-0" />
                                        <span>{errors.position}</span>
                                    </div>
                                )}
                            </div>
                        </div>

                        {selectedPosition && !errors.position && (() => {
                            const pos = selectedPosition as PositionWithVacancies;
                            const available = pos.available_vacancies ?? 0;
                            const total = pos.vacancies;
                            const isFullyOccupied = available <= 0;

                            return (
                                <Card className={isFullyOccupied ? "border-red-200 bg-red-50" : "border-green-200 bg-green-50"}>
                                    <CardContent className="p-4">
                                        <div className="flex items-center justify-between">
                                            <div>
                                                <h4 className="font-semibold">
                                                    {selectedPosition.job_title_name || selectedPosition.name}
                                                </h4>
                                                <p className="text-sm text-muted-foreground">
                                                    {selectedPosition.department_name}
                                                </p>
                                            </div>
                                            <div className="text-right">
                                                <p className={`text-2xl font-bold ${isFullyOccupied ? 'text-red-600' : 'text-green-600'}`}>
                                                    {available}/{total}
                                                </p>
                                                <p className="text-xs text-muted-foreground">Disponibles/Total</p>
                                            </div>
                                        </div>
                                    </CardContent>
                                </Card>
                            );
                        })()}

                        <div className="space-y-2">
                            <Label htmlFor="description">Descripción *</Label>
                            <Textarea
                                id="description"
                                rows={6}
                                placeholder="Describe las responsabilidades y objetivos del puesto... (mínimo 50 caracteres)"
                                value={formData.description}
                                onChange={(e) => handleDescriptionChange(e.target.value)}
                                className={errors.description ? "border-red-500" : ""}
                            />
                            <div className="flex items-center justify-between text-xs">
                                <div>
                                    {errors.description && (
                                        <div className="flex items-center gap-2 text-red-600">
                                            <AlertCircle className="w-3 h-3" />
                                            {errors.description}
                                        </div>
                                    )}
                                    {formData.description && !errors.description && (
                                        <div className="flex items-center gap-2 text-green-600">
                                            <CheckCircle2 className="w-3 h-3" />
                                            Descripción válida
                                        </div>
                                    )}
                                </div>
                                <span className={`text-muted-foreground ${formData.description.length > 1000 ? 'text-red-600' : ''}`}>
                                    {formData.description.length}/1000 caracteres
                                </span>
                            </div>
                        </div>

                    </CardContent>
                </Card>

                <Card>
                    <CardHeader>
                        <CardTitle>Fechas y Publicación</CardTitle>
                    </CardHeader>
                    <CardContent className="space-y-4">
                        <div className="space-y-2">
                            <Label htmlFor="status">Estado de Publicación *</Label>
                            <Combobox
                                options={[
                                    { value: "DRAFT", label: "Borrador" },
                                    { value: "PUBLISHED", label: "Publicada" },
                                    { value: "FROZEN", label: "Congelada" },
                                ]}
                                value={formData.status}
                                onSelect={(value) => setFormData({ ...formData, status: value.toString() })}
                                placeholder="Selecciona el estado"
                                emptyText="No hay estados disponibles"
                            />
                        </div>

                        <div className="grid gap-4 md:grid-cols-2">
                            <div className="space-y-2">
                                <Label htmlFor="published_date">Fecha de Publicación</Label>
                                <DatePicker
                                    value={formData.published_date}
                                    onChange={(date) => setFormData({ ...formData, published_date: date })}
                                    placeholder="dd/mm/aaaa"
                                />
                            </div>

                            <div className="space-y-2">
                                <Label htmlFor="closing_date">Fecha de Cierre</Label>
                                <DatePicker
                                    value={formData.closing_date}
                                    onChange={(date) => setFormData({ ...formData, closing_date: date })}
                                    placeholder="dd/mm/aaaa"
                                />
                            </div>
                        </div>

                        <div className="flex items-center justify-between rounded-lg border p-3">
                            <div>
                                <Label htmlFor="ask_education">Solicitar Educación</Label>
                                <p className="text-sm text-muted-foreground">
                                    Requerir historial académico del candidato
                                </p>
                            </div>
                            <Switch
                                id="ask_education"
                                checked={formData.ask_education}
                                onCheckedChange={(checked) =>
                                    setFormData({ ...formData, ask_education: checked })
                                }
                            />
                        </div>
                    </CardContent>
                </Card>

                <div className="flex gap-3">
                    <Button type="submit" disabled={loading || !isFormValid}>
                        {loading ? (
                            <>
                                <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                                Guardando...
                            </>
                        ) : (
                            <>
                                <Save className="mr-2 h-4 w-4" />
                                Guardar
                            </>
                        )}
                    </Button>
                    <Button
                        type="button"
                        variant="outline"
                        onClick={() => router.push("/admin/ats/jobs")}
                    >
                        Cancelar
                    </Button>
                </div>
            </form>
        </div>
    );
}
</file>

<file path="frontend2/app/(main)/admin/ats/jobs/page.tsx">
"use client";

import { CatalogCRUD, CatalogField } from "@/components/catalogs/catalog-crud";
import { ColumnDef } from "@tanstack/react-table";
import { DropdownMenuItem } from "@/components/ui/dropdown-menu";
import { Briefcase, Eye, Users } from "lucide-react";
import { Badge } from "@/components/ui/badge";
import { useRouter } from "next/navigation";
import { Button } from "@/components/ui/button";

interface JobPosting {
    id: number;
    title: string;
    description: string;
    location: string | null;
    position: number | null;
    position_title: string | null;
    department_name: string | null;
    status: string;
    published_date: string | null;
    closing_date: string | null;
    candidates_count: number;
    created_at: string;
}

const statusColors: Record<string, string> = {
    DRAFT: "bg-gray-100 text-gray-800 dark:bg-gray-800 dark:text-gray-200",
    PUBLISHED: "bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200",
    CLOSED: "bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200",
    FROZEN: "bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200",
};

const statusLabels: Record<string, string> = {
    DRAFT: "Borrador",
    PUBLISHED: "Publicada",
    CLOSED: "Cerrada",
    FROZEN: "Congelada",
};

export default function JobsPage() {
    const router = useRouter();

    const fields: CatalogField[] = [
        {
            name: "title",
            label: "Título de la Vacante",
            type: "text",
            required: true,
        },
        {
            name: "position",
            label: "Posición Asociada",
            type: "select",
            required: true,
            optionsUrl: "/api/organization/positions/",
            optionLabelKey: "name",
            optionValueKey: "id",
        },
        {
            name: "description",
            label: "Descripción",
            type: "textarea",
            required: true,
        },
        {
            name: "location",
            label: "Ubicación",
            type: "text",
        },
        {
            name: "published_date",
            label: "Fecha de Publicación",
            type: "date",
        },
        {
            name: "closing_date",
            label: "Fecha de Cierre",
            type: "date",
        },
    ];

    const columns: ColumnDef<JobPosting>[] = [
        {
            accessorKey: "title",
            header: "Título",
            cell: ({ row }) => <div className="font-medium">{row.getValue("title")}</div>,
        },
        {
            accessorKey: "position_title",
            header: "Posición",
            cell: ({ row }) => <div>{row.getValue("position_title") || "-"}</div>,
        },
        {
            accessorKey: "department_name",
            header: "Departamento",
            cell: ({ row }) => <div>{row.getValue("department_name") || "-"}</div>,
        },
        {
            accessorKey: "status",
            header: "Estado",
            cell: ({ row }) => {
                const status = row.getValue("status") as string;
                return (
                    <Badge className={statusColors[status] || ""}>
                        {statusLabels[status] || status}
                    </Badge>
                );
            },
        },
        {
            accessorKey: "candidates_count",
            header: "Candidatos",
            cell: ({ row }) => (
                <div className="font-medium">
                    {row.original.candidates_count}
                </div>
            ),
        },
    ];

    return (
        <CatalogCRUD
            title="Gestión de Vacantes"
            icon={Briefcase}
            apiUrl="/api/ats/jobs/"
            fields={fields}
            columns={columns}
            searchKey="title"
            singularName="Vacante"
            extraActions={(item) => (
                <>
                    <DropdownMenuItem onClick={() => router.push(`/admin/ats/jobs/${item.id}`)}>
                        <Eye className="mr-2 h-4 w-4" />
                        Ver Detalle
                    </DropdownMenuItem>
                    <DropdownMenuItem onClick={() => router.push(`/admin/ats/candidates?job_posting=${item.id}`)}>
                        <Users className="mr-2 h-4 w-4" />
                        Ver Candidatos
                    </DropdownMenuItem>
                </>
            )}
        />
    );
}
</file>

<file path="frontend2/app/(main)/admin/config/general/[slug]/loading.tsx">
import { SpecificCatalogSkeleton } from "@/components/skeletons/specific-catalog-skeleton";

export default function SpecificCatalogLoading() {
    return <SpecificCatalogSkeleton />;
}
</file>

<file path="frontend2/app/(main)/admin/config/general/loading.tsx">
import { GeneralCatalogSkeleton } from "@/components/skeletons/general-catalog-skeleton";

export default function GeneralConfigLoading() {
    return <GeneralCatalogSkeleton />;
}
</file>

<file path="frontend2/app/(main)/admin/config/talent/page.tsx">
"use client";

import { CatalogCard } from "@/components/catalogs/catalog-card";
import { Input } from "@/components/ui/input";
import {
    Briefcase,
    GraduationCap,
    BookOpen,
    Languages,
    BarChart,
    Search,
} from "lucide-react";
import { useState } from "react";

const catalogs = [
    {
        title: "Funciones de Negocio",
        description: "Áreas funcionales y de negocio",
        icon: Briefcase,
        href: "/admin/config/talent/business-functions",
        gradient: "from-blue-900 via-blue-700 to-blue-500",
        iconColor: "text-blue-200/90"
    },
    {
        title: "Niveles Educativos",
        description: "Grados académicos y niveles de instrucción",
        icon: GraduationCap,
        href: "/admin/config/talent/education-levels",
        gradient: "from-emerald-900 via-emerald-700 to-emerald-500",
        iconColor: "text-emerald-200/90"
    },
    {
        title: "Campos de Estudio",
        description: "Áreas de conocimiento y especialidades",
        icon: BookOpen,
        href: "/admin/config/talent/fields-of-study",
        gradient: "from-purple-900 via-purple-700 to-purple-500",
        iconColor: "text-purple-200/90"
    },
    {
        title: "Idiomas",
        description: "Catálogo de idiomas",
        icon: Languages,
        href: "/admin/config/talent/languages",
        gradient: "from-pink-900 via-pink-700 to-pink-500",
        iconColor: "text-pink-200/90"
    },
    {
        title: "Niveles de Dominio",
        description: "Niveles de competencia lingüística (Básico, Intermedio, Avanzado)",
        icon: BarChart,
        href: "/admin/config/talent/proficiencies",
        gradient: "from-orange-900 via-orange-700 to-orange-500",
        iconColor: "text-orange-200/90"
    },
];

export default function TalentConfigPage() {
    const [searchQuery, setSearchQuery] = useState("");

    const normalizeText = (text: string) =>
        text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();

    const filteredCatalogs = catalogs.filter(catalog =>
        normalizeText(catalog.title).includes(normalizeText(searchQuery)) ||
        normalizeText(catalog.description).includes(normalizeText(searchQuery))
    );

    return (
        <div className="space-y-6">
            <div className="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                <div>
                    <h1 className="text-3xl font-bold text-foreground">Catálogos de Talento</h1>
                    <p className="text-muted-foreground">
                        Configuración de catálogos relacionados con habilidades y formación
                    </p>
                </div>
                <div className="relative w-full md:w-72">
                    <Search className="absolute left-2 top-2.5 h-4 w-4 text-muted-foreground" />
                    <Input
                        placeholder="Buscar catálogos..."
                        className="pl-8"
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                    />
                </div>
            </div>

            <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                {filteredCatalogs.map((catalog) => (
                    <CatalogCard
                        key={catalog.href}
                        {...catalog}
                    />
                ))}
            </div>
        </div>
    );
}
</file>

<file path="frontend2/app/(main)/admin/dashboard/loading.tsx">
import { DashboardSkeleton } from "@/components/skeletons/dashboard-skeleton";

export default function DashboardLoading() {
    return <DashboardSkeleton />;
}
</file>

<file path="frontend2/app/(main)/admin/organization/page.tsx">
"use client";

import { CatalogCard } from "@/components/catalogs/catalog-card";
import { Input } from "@/components/ui/input";
import {
    Building2,
    Briefcase,
    Network,
    Search,
} from "lucide-react";
import { useState } from "react";

const catalogs = [
    {
        title: "Departamentos",
        description: "Gestión de departamentos y unidades organizativas",
        icon: Building2,
        href: "/admin/organization/departments",
        gradient: "from-blue-900 via-blue-700 to-blue-500",
        iconColor: "text-blue-200/90"
    },
    {
        title: "Títulos de Cargo",
        description: "Catálogo de títulos y denominaciones de cargo",
        icon: Briefcase,
        href: "/admin/organization/job-titles",
        gradient: "from-emerald-900 via-emerald-700 to-emerald-500",
        iconColor: "text-emerald-200/90"
    },
    {
        title: "Posiciones",
        description: "Gestión de posiciones y estructura organizativa",
        icon: Network,
        href: "/admin/organization/positions",
        gradient: "from-purple-900 via-purple-700 to-purple-500",
        iconColor: "text-purple-200/90"
    },
];

export default function OrganizationConfigPage() {
    const [searchQuery, setSearchQuery] = useState("");

    const normalizeText = (text: string) =>
        text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();

    const filteredCatalogs = catalogs.filter(catalog =>
        normalizeText(catalog.title).includes(normalizeText(searchQuery)) ||
        normalizeText(catalog.description).includes(normalizeText(searchQuery))
    );

    return (
        <div className="space-y-6">
            <div className="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                <div>
                    <h1 className="text-3xl font-bold text-foreground">Organización</h1>
                    <p className="text-muted-foreground">
                        Gestión de la estructura organizativa
                    </p>
                </div>
                <div className="relative w-full md:w-72">
                    <Search className="absolute left-2 top-2.5 h-4 w-4 text-muted-foreground" />
                    <Input
                        placeholder="Buscar catálogos..."
                        className="pl-8"
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                    />
                </div>
            </div>

            <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                {filteredCatalogs.map((catalog) => (
                    <CatalogCard
                        key={catalog.href}
                        {...catalog}
                    />
                ))}
            </div>
        </div>
    );
}
</file>

<file path="frontend2/app/(main)/admin/performance/competencies/page.tsx">
"use client";

import { CatalogCRUD, CatalogField } from "@/components/catalogs/catalog-crud";
import { ColumnDef } from "@tanstack/react-table";
import { Badge } from "@/components/ui/badge";
import { ClipboardList, CheckCircle, XCircle } from "lucide-react";

interface Competency {
    id: number;
    name: string;
    description: string;
    category: string;
    is_global: boolean;
}

const CATEGORY_OPTIONS = [
    { value: "CAL", label: "Calidad" },
    { value: "COM", label: "Compromiso" },
    { value: "CMU", label: "Comunicación" },
    { value: "ORG", label: "Organización" },
    { value: "DIS", label: "Disciplina" },
    { value: "PRO", label: "Proactividad" },
];

const CATEGORY_COLORS: Record<string, string> = {
    CAL: "bg-blue-100 text-blue-800",
    COM: "bg-red-100 text-red-800",
    CMU: "bg-green-100 text-green-800",
    ORG: "bg-purple-100 text-purple-800",
    DIS: "bg-orange-100 text-orange-800",
    PRO: "bg-teal-100 text-teal-800",
};

const competenciesFields: CatalogField[] = [
    { name: "name", label: "Nombre", type: "text", required: true },
    { name: "category", label: "Categoría", type: "select", required: true, options: CATEGORY_OPTIONS },
    { name: "description", label: "Descripción", type: "textarea", required: false },
    { name: "is_global", label: "Competencia Global (aplica a todos)", type: "checkbox", defaultValue: true },
];

const competenciesColumns: ColumnDef<Competency>[] = [
    {
        accessorKey: "name",
        header: "Competencia",
        cell: ({ row }) => <span className="font-medium">{row.getValue("name")}</span>,
    },
    {
        accessorKey: "category",
        header: "Categoría",
        cell: ({ row }) => {
            const category = row.getValue("category") as string;
            const label = CATEGORY_OPTIONS.find(c => c.value === category)?.label || category;
            return (
                <Badge className={CATEGORY_COLORS[category] || "bg-gray-100 text-gray-800"}>
                    {label}
                </Badge>
            );
        },
    },
    {
        accessorKey: "description",
        header: "Descripción",
        cell: ({ row }) => (
            <span className="text-sm text-muted-foreground line-clamp-2">
                {row.getValue("description")}
            </span>
        ),
    },
    {
        accessorKey: "is_global",
        header: "Tipo",
        cell: ({ row }) => {
            const isGlobal = row.getValue("is_global");
            return (
                <Badge variant={isGlobal ? "default" : "secondary"}>
                    {isGlobal ? (
                        <>
                            <CheckCircle className="w-3 h-3 mr-1" />
                            Global
                        </>
                    ) : (
                        <>
                            <XCircle className="w-3 h-3 mr-1" />
                            Específica
                        </>
                    )}
                </Badge>
            );
        },
    },
];

export default function CompetenciesPage() {
    return (
        <CatalogCRUD
            title="Gestión de Competencias"
            apiUrl="/api/performance/competencies/"
            fields={competenciesFields}
            columns={competenciesColumns}
            searchKey="name"
            searchOptions={[
                { label: "Nombre", value: "name" },
                { label: "Descripción", value: "description" },
                { label: "Categoría", value: "category" },
            ]}
            singularName="Competencia"
            icon={ClipboardList}
        />
    );
}
</file>

<file path="frontend2/app/(main)/admin/performance/periods/page.tsx">
"use client";

import { useState } from "react";
import { CatalogCRUD, CatalogField } from "@/components/catalogs/catalog-crud";
import { ColumnDef } from "@tanstack/react-table";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Calendar, CheckCircle, XCircle, RefreshCw } from "lucide-react";
import apiClient from "@/lib/api-client";
import { toast } from "sonner";

interface EvaluationPeriod {
    id: number;
    name: string;
    start_date: string;
    end_date: string;
    is_active: boolean;
}

const periodsFields: CatalogField[] = [
    { name: "name", label: "Nombre del Período", type: "text", required: true },
    { name: "start_date", label: "Fecha Inicio", type: "date", required: true },
    { name: "end_date", label: "Fecha Cierre", type: "date", required: true },
    { name: "is_active", label: "Período Activo", type: "checkbox", defaultValue: true },
];

export default function PeriodsPage() {
    const [generatingFor, setGeneratingFor] = useState<number | null>(null);
    const [refreshKey, setRefreshKey] = useState(0);

    const handleGenerateReviews = async (periodId: number) => {
        setGeneratingFor(periodId);
        const toastId = toast.loading("Generando evaluaciones...");

        try {
            const response = await apiClient.post(
                `/api/performance/periods/${periodId}/generate_reviews/`
            );

            toast.success(response.data.message || "Evaluaciones generadas exitosamente", {
                id: toastId,
            });

            setRefreshKey((prev) => prev + 1);
        } catch (error: any) {
            console.error("Error generating reviews:", error);
            toast.error(error.response?.data?.error || "Error al generar evaluaciones", {
                id: toastId,
            });
        } finally {
            setGeneratingFor(null);
        }
    };

    const periodsColumns: ColumnDef<EvaluationPeriod>[] = [
        {
            accessorKey: "name",
            header: "Nombre del Período",
            cell: ({ row }) => <span className="font-medium">{row.getValue("name")}</span>,
        },
        {
            accessorKey: "start_date",
            header: "Fecha Inicio",
            cell: ({ row }) => new Date(row.getValue("start_date")).toLocaleDateString("es-VE"),
        },
        {
            accessorKey: "end_date",
            header: "Fecha Cierre",
            cell: ({ row }) => new Date(row.getValue("end_date")).toLocaleDateString("es-VE"),
        },
        {
            accessorKey: "is_active",
            header: "Estado",
            cell: ({ row }) => {
                const isActive = row.getValue("is_active");
                return (
                    <Badge className={isActive ? "bg-green-100 text-green-800" : "bg-gray-100 text-gray-800"}>
                        {isActive ? (
                            <>
                                <CheckCircle className="w-3 h-3 mr-1" />
                                Activo
                            </>
                        ) : (
                            <>
                                <XCircle className="w-3 h-3 mr-1" />
                                Inactivo
                            </>
                        )}
                    </Badge>
                );
            },
        },
    ];

    const extraActions = (item: EvaluationPeriod) => (
        <Button
            variant="ghost"
            size="sm"
            className="w-full justify-start"
            onClick={() => handleGenerateReviews(item.id)}
            disabled={generatingFor === item.id || !item.is_active}
        >
            <RefreshCw className={`w-4 h-4 mr-2 ${generatingFor === item.id ? "animate-spin" : ""}`} />
            {generatingFor === item.id ? "Generando..." : "Generar Evaluaciones"}
        </Button>
    );

    return (
        <CatalogCRUD
            title="Períodos de Evaluación"
            apiUrl="/api/performance/periods/"
            fields={periodsFields}
            columns={periodsColumns}
            searchKey="name"
            extraActions={extraActions}
            singularName="Período"
            icon={Calendar}
            refreshKey={refreshKey}
            disablePagination
        />
    );
}
</file>

<file path="frontend2/app/(main)/admin/performance/reviews/[id]/edit/page.tsx">
"use client";

import { useState, useEffect } from "react";
import { useParams, useRouter } from "next/navigation";
import useSWR from "swr";
import Link from "next/link";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Badge } from "@/components/ui/badge";
import { Alert, AlertDescription } from "@/components/ui/alert";
import {
    ArrowLeft,
    Save,
    Send,
    Loader2,
    CheckCircle2,
    AlertCircle
} from "lucide-react";
import { PerformanceReview, ReviewDetail, CATEGORY_LABELS, CATEGORY_COLORS } from "@/types/performance";
import { CompetencyRating } from "@/components/performance/competency-rating";
import apiClient from "@/lib/api-client";
import { toast } from "sonner";

const fetcher = (url: string) => apiClient.get(url).then((res) => res.data);

export default function EvaluationEditPage() {
    const params = useParams();
    const router = useRouter();
    const id = params?.id as string;

    const { data: review, error, isLoading, mutate } = useSWR<PerformanceReview>(
        id ? `/api/performance/reviews/${id}/` : null,
        fetcher
    );

    const [details, setDetails] = useState<ReviewDetail[]>([]);
    const [feedbackManager, setFeedbackManager] = useState("");
    const [saving, setSaving] = useState(false);

    // Initialize form data when review loads
    useEffect(() => {
        if (review?.details) {
            setDetails(review.details);
            setFeedbackManager(review.feedback_manager || "");
        }
    }, [review]);

    // Group details by category
    const detailsByCategory = details.reduce((acc, detail) => {
        const category = detail.competency_category;
        if (!acc[category]) {
            acc[category] = [];
        }
        acc[category].push(detail);
        return acc;
    }, {} as Record<string, ReviewDetail[]>);

    const categories = Object.keys(CATEGORY_LABELS);

    // Calculate progress
    const totalCompetencies = details.length;
    const ratedCompetencies = details.filter(d => d.score > 0).length;
    const progressPercentage = totalCompetencies > 0
        ? Math.round((ratedCompetencies / totalCompetencies) * 100)
        : 0;

    // Calculate average
    const calculateAverage = () => {
        if (ratedCompetencies === 0) return 0;
        const sum = details.reduce((acc, d) => acc + d.score, 0);
        return (sum / totalCompetencies).toFixed(2);
    };

    const handleDetailChange = (updatedDetail: ReviewDetail) => {
        setDetails(prev => prev.map(d =>
            d.competency === updatedDetail.competency ? updatedDetail : d
        ));
    };

    const handleSave = async (submit: boolean = false) => {
        // Validate if submitting
        if (submit && ratedCompetencies < totalCompetencies) {
            toast.error("Debes calificar todas las competencias antes de enviar");
            return;
        }

        setSaving(true);
        const toastId = toast.loading(submit ? "Enviando evaluación..." : "Guardando borrador...");

        try {
            // Update review details
            await Promise.all(
                details.map(detail =>
                    apiClient.patch(`/api/performance/review-details/${detail.id}/`, {
                        score: detail.score,
                        comment: detail.comment || ""
                    })
                )
            );

            // Update review feedback and status
            await apiClient.patch(`/api/performance/reviews/${id}/`, {
                feedback_manager: feedbackManager,
                status: submit ? "ENV" : "BOR"
            });

            toast.success(
                submit ? "¡Evaluación enviada exitosamente!" : "Borrador guardado",
                { id: toastId }
            );

            mutate(); // Refresh data

            if (submit) {
                setTimeout(() => {
                    router.push("/admin/performance/teams");
                }, 1500);
            }
        } catch (error: any) {
            console.error("Error saving review:", error);
            toast.error("Error al guardar la evaluación", { id: toastId });
        } finally {
            setSaving(false);
        }
    };

    if (isLoading) {
        return (
            <div className="container mx-auto py-8 px-4">
                <div className="flex items-center justify-center h-64">
                    <Loader2 className="w-8 h-8 animate-spin text-brand-primary" />
                </div>
            </div>
        );
    }

    if (error || !review) {
        return (
            <div className="container mx-auto py-8 px-4">
                <Alert variant="destructive">
                    <AlertCircle className="h-4 w-4" />
                    <AlertDescription>
                        No se pudo cargar la evaluación
                    </AlertDescription>
                </Alert>
                <Link href="/admin/performance/teams" className="mt-4 inline-block">
                    <Button variant="outline">
                        <ArrowLeft className="w-4 h-4 mr-2" />
                        Volver a Equipos
                    </Button>
                </Link>
            </div>
        );
    }

    const isReadOnly = review.status !== "BOR";

    return (
        <div className="container mx-auto py-8 px-4 max-w-6xl">
            {/* Header */}
            <div className="mb-6">
                <Link href="/admin/performance/teams">
                    <Button variant="ghost" size="sm" className="mb-4">
                        <ArrowLeft className="w-4 h-4 mr-2" />
                        Volver a Equipos
                    </Button>
                </Link>

                <div className="flex items-start justify-between">
                    <div>
                        <h1 className="text-3xl font-bold text-slate-900">
                            Evaluación de Desempeño
                        </h1>
                        <p className="text-muted-foreground mt-1">
                            {review.employee_name} - {review.position_name}
                        </p>
                        <p className="text-sm text-muted-foreground">
                            Período: {review.period_name}
                        </p>
                    </div>
                    <Badge className={review.status === "BOR" ? "bg-yellow-100 text-yellow-800" : "bg-green-100 text-green-800"}>
                        {review.status_display}
                    </Badge>
                </div>
            </div>

            {/* Progress and Average */}
            <div className="grid gap-4 md:grid-cols-2 mb-6">
                <Card>
                    <CardHeader className="pb-3">
                        <CardTitle className="text-sm font-medium flex items-center gap-2">
                            <CheckCircle2 className="w-4 h-4" />
                            Progreso
                        </CardTitle>
                    </CardHeader>
                    <CardContent>
                        <div className="space-y-2">
                            <div className="flex justify-between text-sm">
                                <span>{ratedCompetencies} de {totalCompetencies} competencias</span>
                                <span className="font-semibold">{progressPercentage}%</span>
                            </div>
                            <div className="w-full bg-gray-200 rounded-full h-2">
                                <div
                                    className="bg-brand-primary h-2 rounded-full transition-all"
                                    style={{ width: `${progressPercentage}%` }}
                                />
                            </div>
                        </div>
                    </CardContent>
                </Card>

                <Card>
                    <CardHeader className="pb-3">
                        <CardTitle className="text-sm font-medium">Promedio General</CardTitle>
                    </CardHeader>
                    <CardContent>
                        <div className="text-3xl font-bold text-brand-primary">
                            {calculateAverage()}
                            <span className="text-sm text-muted-foreground ml-2">/ 5.00</span>
                        </div>
                    </CardContent>
                </Card>
            </div>

            {isReadOnly && (
                <Alert className="mb-6">
                    <AlertCircle className="h-4 h-4" />
                    <AlertDescription>
                        Esta evaluación ya ha sido enviada y no puede ser modificada.
                    </AlertDescription>
                </Alert>
            )}

            {/* Evaluation Form with Tabs */}
            <Card>
                <CardContent className="pt-6">
                    <Tabs defaultValue="CAL" className="w-full">
                        <TabsList className="grid w-full grid-cols-6 mb-6">
                            {categories.map((category) => {
                                const categoryDetails = detailsByCategory[category] || [];
                                const ratedInCategory = categoryDetails.filter(d => d.score > 0).length;
                                const totalInCategory = categoryDetails.length;

                                return (
                                    <TabsTrigger
                                        key={category}
                                        value={category}
                                        className="relative"
                                    >
                                        <div className="flex flex-col items-center">
                                            <span>{CATEGORY_LABELS[category]}</span>
                                            <span className="text-xs text-muted-foreground">
                                                {ratedInCategory}/{totalInCategory}
                                            </span>
                                        </div>
                                    </TabsTrigger>
                                );
                            })}
                        </TabsList>

                        {categories.map((category) => {
                            const categoryDetails = detailsByCategory[category] || [];

                            return (
                                <TabsContent key={category} value={category} className="space-y-4">
                                    <div className="mb-4">
                                        <h3 className="text-lg font-semibold flex items-center gap-2">
                                            <div className={`w-3 h-3 rounded-full ${CATEGORY_COLORS[category]}`} />
                                            {CATEGORY_LABELS[category]}
                                        </h3>
                                        <p className="text-sm text-muted-foreground mt-1">
                                            Evalúa las siguientes {categoryDetails.length} competencias
                                        </p>
                                    </div>

                                    {categoryDetails.map((detail) => (
                                        <CompetencyRating
                                            key={detail.competency}
                                            detail={detail}
                                            onChange={handleDetailChange}
                                            disabled={isReadOnly}
                                        />
                                    ))}
                                </TabsContent>
                            );
                        })}
                    </Tabs>

                    {/* Manager Feedback */}
                    <div className="mt-8 space-y-2">
                        <Label htmlFor="feedback">Comentarios Generales del Evaluador</Label>
                        <Textarea
                            id="feedback"
                            value={feedbackManager}
                            onChange={(e) => setFeedbackManager(e.target.value)}
                            placeholder="Agrega comentarios generales sobre el desempeño del empleado..."
                            rows={4}
                            disabled={isReadOnly}
                        />
                    </div>

                    {/* Action Buttons */}
                    {!isReadOnly && (
                        <div className="flex justify-end gap-3 mt-6">
                            <Button
                                variant="outline"
                                onClick={() => handleSave(false)}
                                disabled={saving}
                            >
                                {saving ? (
                                    <>
                                        <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                                        Guardando...
                                    </>
                                ) : (
                                    <>
                                        <Save className="w-4 h-4 mr-2" />
                                        Guardar Borrador
                                    </>
                                )}
                            </Button>
                            <Button
                                onClick={() => handleSave(true)}
                                disabled={saving || ratedCompetencies < totalCompetencies}
                                className="bg-brand-primary hover:bg-brand-primary/90"
                            >
                                {saving ? (
                                    <>
                                        <Loader2 className="w-4 h-4 mr-2 animate-spin" />
                                        Enviando...
                                    </>
                                ) : (
                                    <>
                                        <Send className="w-4 h-4 mr-2" />
                                        Enviar Evaluación
                                    </>
                                )}
                            </Button>
                        </div>
                    )}
                </CardContent>
            </Card>
        </div>
    );
}
</file>

<file path="frontend2/app/(main)/admin/performance/reviews/[id]/page.tsx">
"use client";

import { use } from "react";
import useSWR from "swr";
import { useParams } from "next/navigation";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Separator } from "@/components/ui/separator";
import { PerformanceRadarChart } from "@/components/performance/performance-radar-chart";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { User, Briefcase, Calendar, BarChart3 } from "lucide-react";
import apiClient from "@/lib/api-client";

const fetcher = (url: string) => apiClient.get(url).then((res) => res.data);

interface ReviewDetail {
    id: number;
    competency_name: string;
    competency_description: string;
    competency_category: string;
    competency_category_display: string;
    score: number;
    comment: string;
}

interface PerformanceReview {
    id: number;
    employee_name: string;
    position_name: string;
    department_name: string;
    period_name: string;
    evaluator_name: string;
    status: string;
    status_display: string;
    final_score: number | null;
    feedback_manager: string;
    feedback_employee: string;
    details: ReviewDetail[];
}

export default function PerformanceReviewDetailPage() {
    const params = useParams();
    const id = params?.id as string;

    const { data: review, error, isLoading } = useSWR<PerformanceReview>(
        id ? `/api/performance/reviews/${id}/` : null,
        fetcher
    );

    if (isLoading) {
        return (
            <div className="container mx-auto py-8 px-4">
                <p>Cargando evaluación...</p>
            </div>
        );
    }

    if (error || !review) {
        return (
            <div className="container mx-auto py-8 px-4">
                <Card>
                    <CardHeader>
                        <CardTitle className="text-red-600">Error</CardTitle>
                        <CardDescription>No se pudo cargar la evaluación</CardDescription>
                    </CardHeader>
                </Card>
            </div>
        );
    }

    // Group details by category and calculate averages
    const categoryMap = new Map<string, { name: string; scores: number[]; details: ReviewDetail[] }>();

    review.details.forEach((detail) => {
        const cat = detail.competency_category || "SIN";
        const catName = detail.competency_category_display || "Sin Categoría";

        if (!categoryMap.has(cat)) {
            categoryMap.set(cat, { name: catName, scores: [], details: [] });
        }

        const catData = categoryMap.get(cat)!;
        catData.scores.push(detail.score);
        catData.details.push(detail);
    });

    // Prepare radar chart data
    const radarData = Array.from(categoryMap.entries()).map(([key, value]) => ({
        category: value.name,
        score: value.scores.reduce((a, b) => a + b, 0) / value.scores.length,
        fullMark: 5,
    }));

    return (
        <div className="container mx-auto py-8 px-4 max-w-7xl">
            {/* Header */}
            <Card className="mb-6">
                <CardHeader>
                    <div className="flex items-start justify-between">
                        <div>
                            <CardTitle className="text-3xl mb-2">Evaluación de Desempeño</CardTitle>
                            <CardDescription className="text-base">{review.period_name}</CardDescription>
                        </div>
                        <Badge className={
                            review.status === "BOR" ? "bg-yellow-500" :
                                review.status === "ENV" ? "bg-blue-500" :
                                    review.status === "ACE" ? "bg-green-500" : "bg-gray-500"
                        }>
                            {review.status_display}
                        </Badge>
                    </div>
                </CardHeader>
                <CardContent>
                    <div className="grid md:grid-cols-3 gap-6">
                        <div className="flex items-start gap-3">
                            <User className="w-5 h-5 text-muted-foreground mt-0.5" />
                            <div>
                                <p className="text-sm font-medium text-muted-foreground">Empleado</p>
                                <p className="text-lg font-semibold">{review.employee_name}</p>
                            </div>
                        </div>

                        <div className="flex items-start gap-3">
                            <Briefcase className="w-5 h-5 text-muted-foreground mt-0.5" />
                            <div>
                                <p className="text-sm font-medium text-muted-foreground">Puesto</p>
                                <p className="text-lg font-semibold">{review.position_name}</p>
                                <p className="text-sm text-muted-foreground">{review.department_name}</p>
                            </div>
                        </div>

                        <div className="flex items-start gap-3">
                            <BarChart3 className="w-5 h-5 text-muted-foreground mt-0.5" />
                            <div>
                                <p className="text-sm font-medium text-muted-foreground">Evaluador</p>
                                <p className="text-lg font-semibold">{review.evaluator_name}</p>
                            </div>
                        </div>
                    </div>

                    {review.final_score !== null && (
                        <>
                            <Separator className="my-6" />
                            <div className="text-center">
                                <p className="text-sm font-medium text-muted-foreground mb-2">Puntaje Final</p>
                                <p className="text-5xl font-bold text-brand-primary">{review.final_score.toFixed(2)}</p>
                                <p className="text-sm text-muted-foreground mt-1">sobre 5.0</p>
                            </div>
                        </>
                    )}
                </CardContent>
            </Card>

            {/* Radar Chart */}
            {radarData.length > 0 && (
                <div className="mb-6">
                    <PerformanceRadarChart
                        data={radarData}
                        title="Desempeño por Categoría"
                        description="Promedio de puntajes en cada dimensión de evaluación"
                    />
                </div>
            )}

            {/* Details by Category */}
            <Card className="mb-6">
                <CardHeader>
                    <CardTitle>Detalles de la Evaluación</CardTitle>
                    <CardDescription>Competencias evaluadas agrupadas por categoría</CardDescription>
                </CardHeader>
                <CardContent>
                    {Array.from(categoryMap.entries()).map(([key, value]) => (
                        <div key={key} className="mb-8 last:mb-0">
                            <div className="flex items-center gap-2 mb-4">
                                <h3 className="text-xl font-bold">{value.name}</h3>
                                <Badge variant="secondary">
                                    Promedio: {(value.scores.reduce((a, b) => a + b, 0) / value.scores.length).toFixed(2)}
                                </Badge>
                            </div>

                            <Table>
                                <TableHeader>
                                    <TableRow>
                                        <TableHead>Competencia</TableHead>
                                        <TableHead>Descripción</TableHead>
                                        <TableHead className="text-center">Puntaje</TableHead>
                                        <TableHead>Comentarios</TableHead>
                                    </TableRow>
                                </TableHeader>
                                <TableBody>
                                    {value.details.map((detail) => (
                                        <TableRow key={detail.id}>
                                            <TableCell className="font-medium">{detail.competency_name}</TableCell>
                                            <TableCell className="text-sm text-muted-foreground max-w-md">
                                                {detail.competency_description}
                                            </TableCell>
                                            <TableCell className="text-center">
                                                <Badge variant={detail.score >= 4 ? "default" : detail.score >= 3 ? "secondary" : "destructive"}>
                                                    {detail.score}
                                                </Badge>
                                            </TableCell>
                                            <TableCell className="text-sm">{detail.comment || "-"}</TableCell>
                                        </TableRow>
                                    ))}
                                </TableBody>
                            </Table>

                            <Separator className="mt-6" />
                        </div>
                    ))}
                </CardContent>
            </Card>

            {/* Feedback Section */}
            {(review.feedback_manager || review.feedback_employee) && (
                <div className="grid md:grid-cols-2 gap-6">
                    {review.feedback_manager && (
                        <Card>
                            <CardHeader>
                                <CardTitle className="text-lg">Comentarios del Evaluador</CardTitle>
                            </CardHeader>
                            <CardContent>
                                <p className="text-sm whitespace-pre-wrap">{review.feedback_manager}</p>
                            </CardContent>
                        </Card>
                    )}

                    {review.feedback_employee && (
                        <Card>
                            <CardHeader>
                                <CardTitle className="text-lg">Comentarios del Empleado</CardTitle>
                            </CardHeader>
                            <CardContent>
                                <p className="text-sm whitespace-pre-wrap">{review.feedback_employee}</p>
                            </CardContent>
                        </Card>
                    )}
                </div>
            )}
        </div>
    );
}
</file>

<file path="frontend2/app/(main)/admin/performance/reviews/page.tsx">
"use client";

import { useState } from "react";
import useSWR from "swr";
import Link from "next/link";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
import { ExternalLink, FileText, Eye } from "lucide-react";
import apiClient from "@/lib/api-client";

const fetcher = (url: string) => apiClient.get(url).then((res) => res.data.results || res.data);

interface PerformanceReview {
    id: number;
    employee_name: string;
    position_name: string;
    department_name: string;
    period_name: string;
    status: string;
    status_display: string;
    final_score: number | null;
    evaluator_name: string;
}

const statusColor = (status: string) => {
    switch (status) {
        case "BOR": return "bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200";
        case "ENV": return "bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200";
        case "ACE": return "bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200";
        default: return "bg-gray-100 text-gray-800";
    }
};

export default function PerformanceReviewsPage() {
    const { data: reviews, error, isLoading } = useSWR<PerformanceReview[]>(
        "/api/performance/reviews/",
        fetcher
    );

    if (isLoading) {
        return (
            <div className="container mx-auto py-8 px-4">
                <p>Cargando evaluaciones...</p>
            </div>
        );
    }

    if (error) {
        return (
            <div className="container mx-auto py-8 px-4">
                <Card>
                    <CardHeader>
                        <CardTitle className="text-red-600">Error</CardTitle>
                        <CardDescription>No se pudieron cargar las evaluaciones</CardDescription>
                    </CardHeader>
                </Card>
            </div>
        );
    }

    return (
        <div className="container mx-auto py-8 px-4">
            <div className="mb-6">
                <h1 className="text-3xl font-bold">Evaluaciones de Desempeño</h1>
                <p className="text-muted-foreground mt-1">
                    Gestiona las evaluaciones de desempeño de los empleados
                </p>
            </div>

            <Card>
                <CardHeader>
                    <CardTitle className="flex items-center gap-2">
                        <FileText className="w-5 h-5" />
                        Listado de Evaluaciones
                    </CardTitle>
                    <CardDescription>
                        {reviews?.length || 0} evaluación(es) registrada(s)
                    </CardDescription>
                </CardHeader>
                <CardContent>
                    {!reviews || reviews.length === 0 ? (
                        <div className="text-center py-12 text-muted-foreground">
                            <p>No hay evaluaciones registradas</p>
                        </div>
                    ) : (
                        <Table>
                            <TableHeader>
                                <TableRow>
                                    <TableHead>Empleado</TableHead>
                                    <TableHead>Puesto</TableHead>
                                    <TableHead>Departamento</TableHead>
                                    <TableHead>Periodo</TableHead>
                                    <TableHead>Evaluador</TableHead>
                                    <TableHead>Estado</TableHead>
                                    <TableHead>Puntaje</TableHead>
                                    <TableHead className="text-right">Acciones</TableHead>
                                </TableRow>
                            </TableHeader>
                            <TableBody>
                                {reviews.map((review) => (
                                    <TableRow key={review.id}>
                                        <TableCell className="font-medium">{review.employee_name}</TableCell>
                                        <TableCell>{review.position_name}</TableCell>
                                        <TableCell>{review.department_name}</TableCell>
                                        <TableCell>{review.period_name}</TableCell>
                                        <TableCell>{review.evaluator_name}</TableCell>
                                        <TableCell>
                                            <Badge className={statusColor(review.status)}>
                                                {review.status_display}
                                            </Badge>
                                        </TableCell>
                                        <TableCell>
                                            {review.final_score ? (
                                                <span className="font-semibold">{review.final_score.toFixed(2)}</span>
                                            ) : (
                                                <span className="text-muted-foreground">-</span>
                                            )}
                                        </TableCell>
                                        <TableCell className="text-right">
                                            <Link href={`/admin/performance/reviews/${review.id}`}>
                                                <Button variant="ghost" size="sm">
                                                    <Eye className="w-4 h-4 mr-2" />
                                                    Ver Detalles
                                                </Button>
                                            </Link>
                                        </TableCell>
                                    </TableRow>
                                ))}
                            </TableBody>
                        </Table>
                    )}
                </CardContent>
            </Card>
        </div>
    );
}
</file>

<file path="frontend2/app/(main)/admin/performance/page.tsx">
"use client";

import { useState } from "react";
import useSWR from "swr";
import Link from "next/link";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { ArrowLeft, Calendar, Briefcase, MapPin, Building2 } from "lucide-react";
import apiClient from "@/lib/api-client";

const fetcher = (url: string) => apiClient.get(url).then((res) => res.data);

interface JobPosting {
    id: number;
    title: string;
    description: string;
    location: string | null;
    position_title: string | null;
    department_name: string | null;
    status: string;
    published_date: string | null;
    closing_date: string | null;
    candidates_count: number;
}

export default function PerformanceModulePage() {
    return (
        <div className="container mx-auto py-8 px-4">
            <h1 className="text-3xl font-bold mb-6">Evaluación de Desempeño</h1>

            <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                <Link href="/admin/performance/periods">
                    <Card className="hover:shadow-lg transition-shadow cursor-pointer">
                        <CardHeader>
                            <CardTitle>Periodos</CardTitle>
                        </CardHeader>
                        <CardContent>
                            <p className="text-muted-foreground">
                                Gestiona los periodos de evaluación
                            </p>
                        </CardContent>
                    </Card>
                </Link>

                <Link href="/admin/performance/reviews">
                    <Card className="hover:shadow-lg transition-shadow cursor-pointer">
                        <CardHeader>
                            <CardTitle>Evaluaciones</CardTitle>
                        </CardHeader>
                        <CardContent>
                            <p className="text-muted-foreground">
                                Ver y gestionar evaluaciones de desempeño
                            </p>
                        </CardContent>
                    </Card>
                </Link>
            </div>
        </div>
    );
}
</file>

<file path="frontend2/app/(main)/admin/personnel/employees/new/page.tsx">
"use client";

import { EmploymentForm } from "@/components/personnel/EmploymentForm";
import { Button } from "@/components/ui/button";
import { ArrowLeft } from "lucide-react";
import { useRouter } from "next/navigation";

export default function NewEmployeePage() {
    const router = useRouter();

    return (
        <div className="flex flex-col h-full space-y-6 p-8">
            <div className="flex items-center justify-between border-b pb-6">
                <div>
                    <h1 className="text-2xl font-bold tracking-tight">Nuevo Empleado</h1>
                    <p className="text-muted-foreground">Registra un nuevo empleado en el sistema</p>
                </div>
                <Button variant="outline" onClick={() => router.back()}>
                    <ArrowLeft className="mr-2 h-4 w-4" />
                    Volver
                </Button>
            </div>

            <EmploymentForm />
        </div>
    );
}
</file>

<file path="frontend2/app/(main)/admin/personnel/people/new/page.tsx">
"use client";

import { ArrowLeft } from "lucide-react";
import Link from "next/link";
import { Button } from "@/components/ui/button";
import { PersonForm } from "@/components/personnel/PersonForm";

export default function NewPersonPage() {
    return (
        <div className="flex flex-col h-full space-y-6 p-8">
            <div className="flex items-center justify-between border-b pb-6">
                <h1 className="text-2xl font-bold tracking-tight">Nueva Persona</h1>
                <Button variant="outline" asChild>
                    <Link href="/admin/personnel/people">
                        <ArrowLeft className="mr-2 h-4 w-4" />
                        Volver
                    </Link>
                </Button>
            </div>

            <PersonForm />
        </div>
    );
}
</file>

<file path="frontend2/app/(main)/departments/[id]/evaluations/page.tsx">
"use client";

import { use } from "react";
import { useRouter } from "next/navigation";
import useSWR from "swr";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Avatar, AvatarFallback } from "@/components/ui/avatar";
import { Badge } from "@/components/ui/badge";
import { ArrowLeft, ArrowRight, ClipboardCheck, AlertCircle } from "lucide-react";
import apiClient from "@/lib/api-client";
import { Skeleton } from "@/components/ui/skeleton";

interface Review {
    id: number;
    period_name: string;
    status: string;
    status_display: string;
    final_score: number | null;
    evaluator_name: string;
    employee_name: string; // Added employee name
    position_name: string;
}

interface PaginatedResponse<T> {
    count: number;
    next: string | null;
    previous: string | null;
    results: T[];
}

const fetcher = (url: string) => apiClient.get(url).then((res) => res.data);

export default function DepartmentEvaluationsPage({ params }: { params: Promise<{ id: string }> }) {
    const { id } = use(params);
    const router = useRouter();

    // Fetch reviews for this department
    const { data: response, isLoading, error } = useSWR<PaginatedResponse<Review>>(
        `/api/performance/reviews/?department=${id}`,
        fetcher
    );

    const reviews = response?.results || [];

    if (isLoading) {
        return (
            <div className="container mx-auto py-8 px-4 space-y-6">
                <Button variant="ghost" className="mb-4">
                    <ArrowLeft className="w-4 h-4 mr-2" />
                    Volver
                </Button>
                <Skeleton className="h-12 w-64 mb-6" />
                <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                    {[1, 2, 3].map((i) => (
                        <Skeleton key={i} className="h-48 w-full rounded-xl" />
                    ))}
                </div>
            </div>
        );
    }

    if (error) {
        return (
            <div className="container mx-auto py-8 px-4">
                <Button variant="ghost" onClick={() => router.back()} className="mb-4">
                    <ArrowLeft className="w-4 h-4 mr-2" />
                    Volver
                </Button>
                <Card className="border-red-200 bg-red-50">
                    <CardHeader>
                        <CardTitle className="text-red-700 flex items-center gap-2">
                            <AlertCircle className="h-5 w-5" />
                            Error
                        </CardTitle>
                        <CardDescription className="text-red-600/80">
                            No se pudieron cargar las evaluaciones. Verifica tus permisos.
                        </CardDescription>
                    </CardHeader>
                </Card>
            </div>
        );
    }

    return (
        <div className="container mx-auto py-8 px-4">
            <Button variant="outline" onClick={() => router.back()} className="mb-6">
                <ArrowLeft className="w-4 h-4 mr-2" />
                Volver al Departamento
            </Button>

            <div className="mb-8">
                <h1 className="text-3xl font-bold flex items-center gap-3 text-slate-800">
                    <ClipboardCheck className="w-8 h-8 text-brand-primary" />
                    Historial de Evaluaciones
                </h1>
                <p className="text-muted-foreground mt-2 text-lg">
                    Todas las evaluaciones registradas en este departamento.
                </p>
            </div>

            {reviews.length === 0 ? (
                <Card className="border-dashed">
                    <CardContent className="flex flex-col items-center justify-center py-16 text-center">
                        <div className="bg-slate-50 p-4 rounded-full mb-4">
                            <ClipboardCheck className="w-10 h-10 text-slate-300" />
                        </div>
                        <h3 className="text-xl font-medium text-slate-900">Sin historial</h3>
                        <p className="text-muted-foreground mt-2 max-w-sm">
                            No hay evaluaciones registradas para este departamento.
                        </p>
                    </CardContent>
                </Card>
            ) : (
                <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                    {reviews.map((review) => {
                        const isDraft = review.status === 'BOR';
                        const isSubmitted = review.status === 'ENV';

                        const statusColor = isDraft ? "bg-yellow-500"
                            : isSubmitted ? "bg-blue-500"
                                : "bg-green-600";

                        return (
                            <Card key={review.id} className="hover:shadow-lg transition-all duration-200 border-slate-200 group">
                                <CardHeader className="pb-3 space-y-3">
                                    <div className="flex justify-between items-start">
                                        <Badge className={`px-2.5 py-0.5 text-xs font-semibold ${statusColor} text-white border-none`}>
                                            {review.status_display}
                                        </Badge>
                                        {review.final_score && (
                                            <span className="text-2xl font-bold text-slate-800">
                                                {Number(review.final_score).toFixed(1)}
                                                <span className="text-xs text-muted-foreground font-normal ml-0.5">/5</span>
                                            </span>
                                        )}
                                    </div>

                                    <div>
                                        <CardTitle className="text-xl text-slate-900 group-hover:text-brand-primary transition-colors">
                                            {review.period_name}
                                        </CardTitle>
                                        <CardDescription className="text-slate-500 mt-1 font-medium">
                                            {review.position_name}
                                        </CardDescription>
                                    </div>
                                </CardHeader>

                                <CardContent className="space-y-6">
                                    {/* Employee Info (Evaluado) */}
                                    <div className="flex items-center gap-3 bg-slate-50 p-3 rounded-lg border border-slate-100">
                                        <Avatar className="h-10 w-10 border-2 border-white shadow-sm">
                                            <AvatarFallback className="bg-indigo-100 text-indigo-700 font-bold text-xs">
                                                {review.employee_name?.split(' ').map(n => n[0]).join('').slice(0, 2) || "E"}
                                            </AvatarFallback>
                                        </Avatar>
                                        <div className="min-w-0">
                                            <p className="text-xs text-muted-foreground font-semibold uppercase tracking-wider">Evaluado</p>
                                            <p className="text-sm font-medium text-slate-700 truncate" title={review.employee_name}>
                                                {review.employee_name}
                                            </p>
                                        </div>
                                    </div>

                                    {/* Evaluator Info */}
                                    <div className="flex items-center gap-3 p-3 pt-0">
                                        <Avatar className="h-8 w-8 border border-slate-100">
                                            <AvatarFallback className="bg-slate-100 text-slate-600 text-xs">
                                                {review.evaluator_name?.split(' ').map(n => n[0]).join('').slice(0, 2) || "S"}
                                            </AvatarFallback>
                                        </Avatar>
                                        <div className="min-w-0">
                                            <p className="text-[10px] text-muted-foreground uppercase">Evaluador</p>
                                            <p className="text-sm text-slate-600 truncate">
                                                {review.evaluator_name}
                                            </p>
                                        </div>
                                    </div>

                                    <Button
                                        className="w-full bg-white text-slate-700 border border-slate-200 hover:bg-slate-50 hover:text-brand-primary hover:border-brand-primary/30 transition-all shadow-sm"
                                        onClick={() => router.push(`/performance/${review.id}`)}
                                    >
                                        Ver Detalles
                                        <ArrowRight className="ml-2 h-4 w-4" />
                                    </Button>
                                </CardContent>
                            </Card>
                        );
                    })}
                </div>
            )}
        </div>
    );
}
</file>

<file path="frontend2/app/(main)/departments/[id]/page.tsx">
"use client";

import { use } from "react";
import { useRouter } from "next/navigation";
import useSWR from "swr";
import { Badge } from "@/components/ui/badge";
import {
    Table,
    TableBody,
    TableCell,
    TableHead,
    TableHeader,
    TableRow,
} from "@/components/ui/table";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Building2, ChevronLeft, Star, User } from "lucide-react";
import { Button } from "@/components/ui/button";
import { useAuth } from "@/context/auth-context";
import apiClient from "@/lib/api-client";
import { TableSkeleton } from "@/components/skeletons/table-skeleton";
import { DepartmentOrgChart } from "@/components/departments/department-org-chart";
import { PendingEvaluations } from "@/components/departments/pending-evaluations";

const fetcher = (url: string) => apiClient.get(url).then((res) => res.data);

interface Occupant {
    id: number;
    name: string;
    email: string | null;
    photo: string | null;
    hire_date: string;
    is_current_user: boolean;
}

interface Position {
    id: number;
    name: string;
    is_manager: boolean;
    vacancies: number;
    occupants: Occupant[];
    manager_positions: { id: number; name: string }[];
}

interface DepartmentDetail {
    id: number;
    name: string;
    manager: {
        name: string;
        position: string;
    } | null;
    positions: Position[];
}

export default function DepartmentDetailPage({ params }: { params: Promise<{ id: string }> }) {
    const { id } = use(params);
    const router = useRouter();
    const { data: department, error, isLoading } = useSWR<DepartmentDetail>(
        `/api/organization/departments/${id}/detail/`,
        fetcher
    );

    const { user } = useAuth();

    // Permission Check
    const isSuperUser = user?.is_staff;
    const isDepartmentManager = department?.positions.some(pos =>
        pos.is_manager && pos.occupants.some(occ => occ.is_current_user)
    );
    const canViewHistory = isSuperUser || isDepartmentManager;

    if (isLoading) {
        return (
            <div className="space-y-6">
                <TableSkeleton columnCount={4} />
            </div>
        );
    }

    if (error) {
        return (
            <div className="text-center py-12">
                <p className="text-destructive">Error al cargar el departamento</p>
                <Button variant="outline" onClick={() => router.back()} className="mt-4">
                    Volver
                </Button>
            </div>
        );
    }

    if (!department) {
        return null;
    }

    // Flatten positions for the table
    const tableRows: {
        position: Position;
        occupant: Occupant | null;
        isVacancy: boolean;
    }[] = [];

    department.positions.forEach((pos) => {
        if (pos.occupants.length > 0) {
            pos.occupants.forEach((occ) => {
                tableRows.push({ position: pos, occupant: occ, isVacancy: false });
            });
        } else {
            // Show at least one row for vacancy if no occupants
            tableRows.push({ position: pos, occupant: null, isVacancy: true });
        }
    });

    return (
        <div className="space-y-6">
            {/* Header */}
            <div className="border-b pb-6 flex items-center justify-between">
                <h1 className="text-2xl font-bold tracking-tight flex items-center gap-2">
                    <Building2 className="size-6" />
                    {department.name}
                </h1>
                {canViewHistory && (
                    <Button
                        variant="outline"
                        onClick={() => router.push(`/departments/${department.id}/evaluations`)}
                    >
                        Evaluaciones de Desempeño
                    </Button>
                )}
            </div>

            {/* Pending Evaluations Section */}
            <PendingEvaluations departmentId={department.id} />

            {/* Positions Table */}
            <div className="rounded-md border overflow-hidden bg-background">
                <Table>
                    <TableHeader>
                        <TableRow className="bg-muted/50 hover:bg-muted/50">
                            <TableHead className="font-semibold">Posición</TableHead>
                            <TableHead className="font-semibold">Colaborador</TableHead>
                            <TableHead className="font-semibold">Rol</TableHead>
                            <TableHead className="font-semibold">Fecha Ingreso</TableHead>
                            <TableHead className="font-semibold">Reporta a</TableHead>
                        </TableRow>
                    </TableHeader>
                    <TableBody>
                        {tableRows.length === 0 ? (
                            <TableRow>
                                <TableCell colSpan={5} className="text-center text-muted-foreground py-8">
                                    No hay posiciones registradas
                                </TableCell>
                            </TableRow>
                        ) : (
                            tableRows.map((row, idx) => (
                                <TableRow key={`${row.position.id}-${idx}`}>
                                    <TableCell>
                                        <span className="font-medium">{row.position.name}</span>
                                    </TableCell>
                                    <TableCell>
                                        {row.isVacancy ? (
                                            <span className="text-muted-foreground italic text-sm">
                                                Vacante
                                            </span>
                                        ) : (
                                            <div className="flex items-center gap-3">
                                                <Avatar className="h-8 w-8">
                                                    <AvatarImage src={row.occupant?.photo || undefined} alt={row.occupant?.name} />
                                                    <AvatarFallback>
                                                        {row.occupant?.name.charAt(0).toUpperCase()}
                                                    </AvatarFallback>
                                                </Avatar>
                                                <div className="flex flex-col">
                                                    <span className={`text-sm font-medium ${row.occupant?.is_current_user ? "text-primary" : ""}`}>
                                                        {row.occupant?.name}
                                                        {row.occupant?.is_current_user && " (Tú)"}
                                                    </span>
                                                    {row.occupant?.email && (
                                                        <span className="text-xs text-muted-foreground">
                                                            {row.occupant.email}
                                                        </span>
                                                    )}
                                                </div>
                                            </div>
                                        )}
                                    </TableCell>
                                    <TableCell>
                                        {row.isVacancy ? (
                                            <span className="text-muted-foreground">-</span>
                                        ) : row.position.is_manager ? (
                                            <Badge className="bg-[var(--brand-tertiary)] hover:bg-[var(--brand-tertiary)]/90 text-white gap-1">
                                                <Star className="size-3 fill-current" />
                                                Gerencial
                                            </Badge>
                                        ) : (
                                            <Badge variant="secondary">
                                                Operativo
                                            </Badge>
                                        )}
                                    </TableCell>
                                    <TableCell>
                                        {row.occupant?.hire_date ? (
                                            <span className="text-sm text-muted-foreground">
                                                {new Date(row.occupant.hire_date).toLocaleDateString()}
                                            </span>
                                        ) : (
                                            <span className="text-muted-foreground">-</span>
                                        )}
                                    </TableCell>
                                    <TableCell>
                                        {row.position.manager_positions.length === 0 ? (
                                            <span className="text-muted-foreground text-sm">-</span>
                                        ) : (
                                            <div className="flex flex-col gap-1">
                                                {row.position.manager_positions.map((manager, i) => (
                                                    <span key={i} className="text-sm text-muted-foreground">
                                                        {manager.name}
                                                    </span>
                                                ))}
                                            </div>
                                        )}
                                    </TableCell>
                                </TableRow>
                            ))
                        )}
                    </TableBody>
                </Table>
            </div>

            {/* Org Chart */}
            <div className="space-y-2">
                <h2 className="text-lg font-semibold tracking-tight">Organigrama</h2>
                <DepartmentOrgChart positions={department.positions} departmentId={department.id} />
            </div>
        </div>
    );
}
</file>

<file path="frontend2/app/(main)/departments/page.tsx">
"use client";

import useSWR from "swr";
import { Building2, Loader2 } from "lucide-react";
import { DepartmentCard } from "@/components/departments/department-card";
import apiClient from "@/lib/api-client";

const fetcher = (url: string) => apiClient.get(url).then((res) => res.data);

interface Department {
    id: number;
    name: string;
    manager: {
        name: string;
        position: string;
    } | null;
    user_position: string;
}

export default function DepartmentsPage() {
    const { data: departments, error, isLoading } = useSWR<Department[]>(
        "/api/organization/departments/my_departments/",
        fetcher
    );

    if (isLoading) {
        return (
            <div className="flex items-center justify-center h-full">
                <Loader2 className="h-8 w-8 animate-spin text-primary" />
            </div>
        );
    }

    if (error) {
        return (
            <div className="text-center py-12">
                <p className="text-destructive">Error al cargar los departamentos</p>
            </div>
        );
    }

    if (!departments || departments.length === 0) {
        return (
            <div className="flex flex-col h-full space-y-6">
                <div className="flex items-center justify-between border-b pb-6">
                    <div>
                        <h1 className="text-2xl font-bold tracking-tight">Departamentos</h1>
                        <p className="text-muted-foreground mt-1">
                            Explora los departamentos donde trabajas
                        </p>
                    </div>
                </div>
                <div className="flex flex-col items-center justify-center p-12 text-center border rounded-lg">
                    <Building2 className="h-16 w-16 text-muted-foreground mb-4" />
                    <h3 className="text-lg font-semibold mb-2">No tienes departamentos asignados</h3>
                    <p className="text-muted-foreground">
                        Contacta a recursos humanos para más información
                    </p>
                </div>
            </div>
        );
    }

    return (
        <div className="flex flex-col h-full space-y-6">
            {/* Header */}
            <div className="flex items-center justify-between border-b pb-6">
                <div>
                    <h1 className="text-2xl font-bold tracking-tight">Departamentos</h1>
                    <p className="text-muted-foreground mt-1">
                        Explora los departamentos donde trabajas
                    </p>
                </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {departments.map((dept) => (
                    <DepartmentCard
                        key={dept.id}
                        department={dept}
                        href={`/departments/${dept.id}`}
                    />
                ))}
            </div>
        </div>
    );
}
</file>

<file path="frontend2/app/(main)/performance/[id]/page.tsx">
"use client";

import { use } from "react";
import { PerformanceEvaluationForm } from "@/components/performance/performance-evaluation-form";

export default function PerformanceEvaluationPage({ params }: { params: Promise<{ id: string }> }) {
    const { id } = use(params);
    const reviewId = parseInt(id);

    return (
        <div className="">
            <PerformanceEvaluationForm reviewId={reviewId} />
        </div>
    );
}
</file>

<file path="frontend2/app/(main)/performance/page.tsx">
"use client";

import useSWR from "swr";
import { useRouter } from "next/navigation";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Avatar, AvatarFallback } from "@/components/ui/avatar";
import { Badge } from "@/components/ui/badge";
import { Calendar, ArrowRight, ClipboardCheck, AlertCircle } from "lucide-react";
import apiClient from "@/lib/api-client";
import { Skeleton } from "@/components/ui/skeleton";

interface Review {
    id: number;
    period_name: string;
    status: string;
    status_display: string;
    final_score: number | null;
    evaluator_name: string;
    position_name: string;
}

interface PaginatedResponse<T> {
    count: number;
    next: string | null;
    previous: string | null;
    results: T[];
}

const fetcher = (url: string) => apiClient.get(url).then((res) => res.data);

export default function PerformancePage() {
    const router = useRouter();

    // Fetch reviews where scope=received (I am the employee)
    const { data: response, isLoading, error } = useSWR<PaginatedResponse<Review>>(
        "/api/performance/reviews/?scope=received",
        fetcher
    );

    const reviews = response?.results || [];

    if (isLoading) {
        return (
            <div className="container mx-auto py-8 px-4 space-y-6">
                <Skeleton className="h-12 w-64 mb-6" />
                <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                    {[1, 2, 3].map((i) => (
                        <Skeleton key={i} className="h-48 w-full rounded-xl" />
                    ))}
                </div>
            </div>
        );
    }

    if (error) {
        return (
            <div className="container mx-auto py-8 px-4">
                <Card className="border-red-200 bg-red-50">
                    <CardHeader>
                        <CardTitle className="text-red-700 flex items-center gap-2">
                            <AlertCircle className="h-5 w-5" />
                            Error
                        </CardTitle>
                        <CardDescription className="text-red-600/80">
                            No se pudieron cargar tus evaluaciones. Por favor intenta más tarde.
                        </CardDescription>
                    </CardHeader>
                </Card>
            </div>
        );
    }

    return (
        <div className="flex flex-col h-full space-y-6">
            <div className="flex items-center justify-between border-b pb-6">
                <div>
                    <h1 className="text-2xl font-bold tracking-tight">Mi Desempeño</h1>
                    <p className="text-muted-foreground mt-1">
                        Consulta el historial de tus evaluaciones y retroalimentación recibida
                    </p>
                </div>
            </div>

            {reviews.length === 0 ? (
                <Card className="border-dashed">
                    <CardContent className="flex flex-col items-center justify-center py-16 text-center">
                        <div className="bg-slate-50 p-4 rounded-full mb-4">
                            <ClipboardCheck className="w-10 h-10 text-slate-300" />
                        </div>
                        <h3 className="text-xl font-medium text-slate-900">Sin evaluaciones registradas</h3>
                        <p className="text-muted-foreground mt-2 max-w-sm">
                            Aún no tienes evaluaciones de desempeño asignadas para este periodo.
                        </p>
                    </CardContent>
                </Card>
            ) : (
                <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                    {reviews.map((review) => {
                        const isDraft = review.status === 'BOR';
                        const isSubmitted = review.status === 'ENV';
                        const isAccepted = review.status === 'ACE';

                        const statusColor = isDraft ? "bg-yellow-500 hover:bg-yellow-600"
                            : isSubmitted ? "bg-blue-500 hover:bg-blue-600"
                                : "bg-green-600 hover:bg-green-700";

                        return (
                            <Card key={review.id} className="hover:shadow-lg transition-all duration-200 border-slate-200 group">
                                <CardHeader className="pb-3 space-y-3">
                                    <div className="flex justify-between items-start">
                                        <Badge className={`px-2.5 py-0.5 text-xs font-semibold ${statusColor} text-white border-none`}>
                                            {review.status_display}
                                        </Badge>
                                        {review.final_score && (
                                            <span className="text-2xl font-bold text-slate-800">
                                                {Number(review.final_score).toFixed(1)}
                                                <span className="text-xs text-muted-foreground font-normal ml-0.5">/5</span>
                                            </span>
                                        )}
                                    </div>

                                    <div>
                                        <CardTitle className="text-xl text-slate-900 group-hover:text-brand-primary transition-colors">
                                            {review.period_name}
                                        </CardTitle>
                                        <CardDescription className="text-slate-500 mt-1 font-medium">
                                            {review.position_name}
                                        </CardDescription>
                                    </div>
                                </CardHeader>

                                <CardContent className="space-y-6">
                                    <div className="flex items-center gap-3 bg-slate-50 p-3 rounded-lg border border-slate-100">
                                        <Avatar className="h-10 w-10 border-2 border-white shadow-sm">
                                            <AvatarFallback className="bg-white text-slate-600 font-bold text-xs">
                                                {review.evaluator_name.split(' ').map(n => n[0]).join('').slice(0, 2)}
                                            </AvatarFallback>
                                        </Avatar>
                                        <div className="min-w-0">
                                            <p className="text-xs text-muted-foreground font-semibold uppercase tracking-wider">Evaluador</p>
                                            <p className="text-sm font-medium text-slate-700 truncate" title={review.evaluator_name}>
                                                {review.evaluator_name}
                                            </p>
                                        </div>
                                    </div>

                                    <Button
                                        className="w-full bg-white text-slate-700 border border-slate-200 hover:bg-slate-50 hover:text-brand-primary hover:border-brand-primary/30 transition-all shadow-sm"
                                        onClick={() => router.push(`/performance/${review.id}`)}
                                    >
                                        Ver Detalles
                                        <ArrowRight className="ml-2 h-4 w-4" />
                                    </Button>
                                </CardContent>
                            </Card>
                        );
                    })}
                </div>
            )}
        </div>
    );
}
</file>

<file path="frontend2/app/(test)/datepicker/page.tsx">
import { DatePicker } from "@/components/ui/date-picker"

export default function DatePickerPage() {
    return (
        <div className="flex h-screen w-full items-center justify-center">
            <div className="space-y-4">
                <h1 className="text-2xl font-bold">Date Picker</h1>
                <DatePicker />
                <input type="date" />
            </div>
        </div>
    )
}
</file>

<file path="frontend2/app/(test)/generales/page.tsx">
"use client";

import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import {
    Globe2,
    Map,
    Users,
    HeartHandshake,
    MapPin,
    Phone,
    Cpu,
    Mail,
    Landmark,
    Wallet,
    Share2,
    Search,
    Hash,
} from "lucide-react";
import Link from "next/link";
import { useState } from "react";

const catalogs = [
    {
        title: "Países",
        description: "Gestión de países para direcciones y nacionalidades",
        icon: Globe2,
        href: "/admin/config/general/countries",
        color: "text-blue-500",
        bg: "bg-blue-500/10"
    },
    {
        title: "Estados",
        description: "Gestión de estados y provincias por país",
        icon: Map,
        href: "/admin/config/general/states",
        color: "text-emerald-500",
        bg: "bg-emerald-500/10"
    },
    {
        title: "Géneros",
        description: "Catálogo de géneros e identidades",
        icon: Users,
        href: "/admin/config/general/genders",
        color: "text-purple-500",
        bg: "bg-purple-500/10"
    },
    {
        title: "Estado Civil",
        description: "Tipos de estado civil",
        icon: HeartHandshake,
        href: "/admin/config/general/marital-statuses",
        color: "text-pink-500",
        bg: "bg-pink-500/10"
    },
    {
        title: "Tipos de Dirección",
        description: "Clasificación de direcciones (Casa, Trabajo, etc.)",
        icon: MapPin,
        href: "/admin/config/general/address-types",
        color: "text-orange-500",
        bg: "bg-orange-500/10"
    },
    {
        title: "Tipos de Teléfono",
        description: "Clasificación de teléfonos (Móvil, Fijo, etc.)",
        icon: Phone,
        href: "/admin/config/general/phone-types",
        color: "text-cyan-500",
        bg: "bg-cyan-500/10"
    },
    {
        title: "Operadoras",
        description: "Operadoras de telefonía móvil y fija",
        icon: Cpu,
        href: "/admin/config/general/phone-carriers",
        color: "text-indigo-500",
        bg: "bg-indigo-500/10"
    },
    {
        title: "Tipos de Email",
        description: "Clasificación de correos (Personal, Corporativo)",
        icon: Mail,
        href: "/admin/config/general/email-types",
        color: "text-red-500",
        bg: "bg-red-500/10"
    },
    {
        title: "Bancos",
        description: "Instituciones bancarias y financieras",
        icon: Landmark,
        href: "/admin/config/general/banks",
        color: "text-green-500",
        bg: "bg-green-500/10"
    },
    {
        title: "Tipos de Cuenta",
        description: "Tipos de cuenta bancaria (Ahorro, Corriente)",
        icon: Wallet,
        href: "/admin/config/general/bank-account-types",
        color: "text-yellow-500",
        bg: "bg-yellow-500/10"
    },
    {
        title: "Tipos de Relación",
        description: "Parentescos y tipos de relación familiar",
        icon: Share2,
        href: "/admin/config/general/relationship-types",
        color: "text-rose-500",
        bg: "bg-rose-500/10"
    },
    {
        title: "Códigos de Operadora",
        description: "Códigos de área por operadora telefónica",
        icon: Hash,
        href: "/admin/config/general/phone-carrier-codes",
        color: "text-blue-600",
        bg: "bg-blue-600/10"
    }
];

export default function GeneralConfigPage() {
    const [searchQuery, setSearchQuery] = useState("");

    const filteredCatalogs = catalogs.filter(catalog =>
        catalog.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
        catalog.description.toLowerCase().includes(searchQuery.toLowerCase())
    );

    return (
        <div className="space-y-6">
            <div className="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                <div>
                    <h1 className="text-3xl font-bold text-foreground">Catálogos Generales</h1>
                    <p className="text-muted-foreground">
                        Configuración de catálogos base del sistema
                    </p>
                </div>
                <div className="relative w-full md:w-72">
                    <Search className="absolute left-2 top-2.5 h-4 w-4 text-muted-foreground" />
                    <Input
                        placeholder="Buscar catálogos..."
                        className="pl-8"
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                    />
                </div>
            </div>

            <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                {filteredCatalogs.map((catalog) => (
                    <Link key={catalog.href} href={catalog.href}>
                        <Card className="h-full hover:bg-accent/50 transition-colors cursor-pointer border-border">
                            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                                <CardTitle className="text-sm font-medium">
                                    {catalog.title}
                                </CardTitle>
                                <div className={`p-2 rounded-full ${catalog.bg}`}>
                                    <catalog.icon className={`h-4 w-4 ${catalog.color}`} />
                                </div>
                            </CardHeader>
                            <CardContent>
                                <CardDescription className="line-clamp-2">
                                    {catalog.description}
                                </CardDescription>
                            </CardContent>
                        </Card>
                    </Link>
                ))}
            </div>
        </div>
    );
}
</file>

<file path="frontend2/app/(test)/generales-two/page.tsx">
"use client";

import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import {
    Globe2,
    Map,
    Users,
    HeartHandshake,
    MapPin,
    Phone,
    Cpu,
    Mail,
    Landmark,
    Wallet,
    Share2,
    Search,
    Hash,
} from "lucide-react";
import Link from "next/link";
import { useState } from "react";

const catalogs = [
    {
        title: "Países",
        description: "Gestión de países para direcciones y nacionalidades",
        icon: Globe2,
        href: "/admin/config/general/countries",
    },
    {
        title: "Estados",
        description: "Gestión de estados y provincias por país",
        icon: Map,
        href: "/admin/config/general/states",
    },
    {
        title: "Géneros",
        description: "Catálogo de géneros e identidades",
        icon: Users,
        href: "/admin/config/general/genders",
    },
    {
        title: "Estado Civil",
        description: "Tipos de estado civil",
        icon: HeartHandshake,
        href: "/admin/config/general/marital-statuses",
    },
    {
        title: "Tipos de Dirección",
        description: "Clasificación de direcciones (Casa, Trabajo, etc.)",
        icon: MapPin,
        href: "/admin/config/general/address-types",
    },
    {
        title: "Tipos de Teléfono",
        description: "Clasificación de teléfonos (Móvil, Fijo, etc.)",
        icon: Phone,
        href: "/admin/config/general/phone-types",
    },
    {
        title: "Operadoras",
        description: "Operadoras de telefonía móvil y fija",
        icon: Cpu,
        href: "/admin/config/general/phone-carriers",
    },
    {
        title: "Tipos de Email",
        description: "Clasificación de correos (Personal, Corporativo)",
        icon: Mail,
        href: "/admin/config/general/email-types",
    },
    {
        title: "Bancos",
        description: "Instituciones bancarias y financieras",
        icon: Landmark,
        href: "/admin/config/general/banks",
    },
    {
        title: "Tipos de Cuenta",
        description: "Tipos de cuenta bancaria (Ahorro, Corriente)",
        icon: Wallet,
        href: "/admin/config/general/bank-account-types",
    },
    {
        title: "Tipos de Relación",
        description: "Parentescos y tipos de relación familiar",
        icon: Share2,
        href: "/admin/config/general/relationship-types",
    },
    {
        title: "Códigos de Operadora",
        description: "Códigos de área por operadora telefónica",
        icon: Hash,
        href: "/admin/config/general/phone-carrier-codes",
    }
];

export default function GeneralConfigPage() {
    const [searchQuery, setSearchQuery] = useState("");

    const normalizeText = (text: string) =>
        text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();

    const filteredCatalogs = catalogs.filter(catalog =>
        normalizeText(catalog.title).includes(normalizeText(searchQuery)) ||
        normalizeText(catalog.description).includes(normalizeText(searchQuery))
    );

    return (
        <div className="space-y-6">
            <div className="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                <div>
                    <h1 className="text-3xl font-bold text-foreground">Catálogos Generales</h1>
                    <p className="text-muted-foreground">
                        Configuración de catálogos base del sistema
                    </p>
                </div>
                <div className="relative w-full md:w-72">
                    <Search className="absolute left-2 top-2.5 h-4 w-4 text-muted-foreground" />
                    <Input
                        placeholder="Buscar catálogos..."
                        className="pl-8"
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                    />
                </div>
            </div>

            <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                {filteredCatalogs.map((catalog) => (
                    <Link key={catalog.href} href={catalog.href}>
                        <Card className="relative h-[140px] flex flex-col p-5 overflow-hidden bg-primary hover:scale-105 hover:contrast-125 hover:shadow-xl transition-all duration-300 ease-out group cursor-pointer text-primary-foreground border-0">
                            <div className="h-full relative z-10 flex flex-col justify-between gap-1">
                                <CardHeader className="p-0 space-y-0">
                                    <CardTitle className="mr-20 text-xl font-bold leading-tight">
                                        {catalog.title}
                                    </CardTitle>
                                </CardHeader>
                                <CardContent className="p-0">
                                    <CardDescription className="mr-26 text-primary-foreground/90 text-sm font-medium line-clamp-2">
                                        {catalog.description}
                                    </CardDescription>
                                </CardContent>
                            </div>

                            <catalog.icon
                                strokeWidth={1.5}
                                className="absolute -right-6 -bottom-6 size-32 text-chart-1 -rotate-6 group-hover:rotate-6 group-hover:text-white group-hover:scale-110 transition-all duration-300 ease-in-out"
                            />
                        </Card>
                    </Link>
                ))}
            </div>
        </div>
    );
}
</file>

<file path="frontend2/app/(test)/guide/page.tsx">
import React from 'react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Separator } from '@/components/ui/separator';

export default function ColorGuidePage() {
    const colors = [
        {
            name: 'Primary (Magenta)',
            hex: '#F213A4',
            variable: '--brand-primary',
            class: 'bg-brand-primary',
            textClass: 'text-brand-primary',
            description: 'Color principal de la marca. Usado para acciones principales, botones primarios y elementos destacados.',
        },
        {
            name: 'Secondary (Verde)',
            hex: '#15BF0F',
            variable: '--brand-secondary',
            class: 'bg-brand-secondary',
            textClass: 'text-brand-secondary',
            description: 'Color secundario. Usado para acciones de éxito, confirmación o elementos complementarios.',
        },
        {
            name: 'Tertiary (Naranja)',
            hex: '#FEC821',
            variable: '--brand-tertiary',
            class: 'bg-brand-tertiary',
            textClass: 'text-brand-tertiary',
            description: 'Color terciario. Usado para advertencias, destacados especiales o notas importantes.',
        },
        {
            name: 'Black',
            hex: '#000000',
            variable: '--brand-black',
            class: 'bg-brand-black',
            textClass: 'text-brand-black',
            description: 'Negro puro de la marca.',
        },
        {
            name: 'White',
            hex: '#FFFFFF',
            variable: '--brand-white',
            class: 'bg-brand-white',
            textClass: 'text-brand-white',
            description: 'Blanco puro de la marca.',
        },
    ];

    return (
        <div className="container mx-auto py-10 space-y-8">
            <div className="space-y-2">
                <h1 className="text-3xl font-bold tracking-tight">Guía de Colores IUTIRLA</h1>
                <p className="text-muted-foreground">
                    Referencia visual y técnica de los colores oficiales de la institución para el desarrollo frontend.
                </p>
            </div>

            <Separator />

            <section className="space-y-4">
                <h2 className="text-2xl font-semibold">Paleta de Colores Oficial</h2>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {colors.map((color) => (
                        <Card key={color.name} className="overflow-hidden">
                            <div
                                className="h-32 w-full transition-all hover:opacity-90"
                                style={{ backgroundColor: color.hex }}
                            />
                            <CardHeader>
                                <CardTitle className="flex items-center justify-between">
                                    <span>{color.name}</span>
                                </CardTitle>
                                <CardDescription className="font-mono text-xs">
                                    {color.hex}
                                </CardDescription>
                            </CardHeader>
                            <CardContent className="space-y-4">
                                <p className="text-sm text-muted-foreground">
                                    {color.description}
                                </p>
                                <div className="space-y-2 text-xs font-mono bg-muted p-3 rounded-md">
                                    <div className="flex justify-between">
                                        <span className="text-muted-foreground">Variable:</span>
                                        <span>{color.variable}</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="text-muted-foreground">Clase BG:</span>
                                        <span>{color.class}</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="text-muted-foreground">Clase Texto:</span>
                                        <span>{color.textClass}</span>
                                    </div>
                                </div>
                            </CardContent>
                        </Card>
                    ))}
                </div>
            </section>

            <Separator />

            <section className="space-y-6">
                <h2 className="text-2xl font-semibold">Ejemplos de Uso</h2>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <Card>
                        <CardHeader>
                            <CardTitle>Botones y Elementos UI</CardTitle>
                            <CardDescription>Cómo se aplican los colores en componentes comunes.</CardDescription>
                        </CardHeader>
                        <CardContent className="space-y-4">
                            <div className="flex flex-wrap gap-4">
                                <Button className="bg-[#F213A4] hover:bg-[#F213A4]/90">
                                    Primary Button
                                </Button>
                                <Button className="bg-[#15BF0F] hover:bg-[#15BF0F]/90 text-white">
                                    Secondary Button
                                </Button>
                                <Button className="bg-[#FEC821] hover:bg-[#FEC821]/90 text-black">
                                    Tertiary Button
                                </Button>
                            </div>

                            <div className="flex flex-wrap gap-4 mt-4">
                                <Badge className="bg-[#F213A4] hover:bg-[#F213A4]/90">Primary Badge</Badge>
                                <Badge className="bg-[#15BF0F] hover:bg-[#15BF0F]/90">Secondary Badge</Badge>
                                <Badge className="bg-[#FEC821] hover:bg-[#FEC821]/90 text-black">Tertiary Badge</Badge>
                            </div>
                        </CardContent>
                    </Card>

                    <Card>
                        <CardHeader>
                            <CardTitle>Tipografía y Fondos</CardTitle>
                            <CardDescription>Ejemplos de contraste y legibilidad.</CardDescription>
                        </CardHeader>
                        <CardContent className="space-y-4">
                            <div className="p-4 rounded-lg border" style={{ borderColor: '#F213A4' }}>
                                <h3 className="font-bold" style={{ color: '#F213A4' }}>Texto Primario</h3>
                                <p className="text-sm text-muted-foreground">
                                    Este contenedor tiene un borde primario y título primario.
                                </p>
                            </div>

                            <div className="p-4 rounded-lg bg-[#15BF0F]/10 border" style={{ borderColor: '#15BF0F' }}>
                                <h3 className="font-bold" style={{ color: '#15BF0F' }}>Texto Secundario</h3>
                                <p className="text-sm text-muted-foreground">
                                    Fondo con opacidad y texto secundario.
                                </p>
                            </div>

                            <div className="p-4 rounded-lg bg-[#FEC821]/10 border" style={{ borderColor: '#FEC821' }}>
                                <h3 className="font-bold" style={{ color: '#FEC821' }}>Texto Terciario</h3>
                                <p className="text-sm text-muted-foreground">
                                    Fondo con opacidad y texto terciario.
                                </p>
                            </div>
                        </CardContent>
                    </Card>
                </div>
            </section>

            <Separator />

            <section className="space-y-4">
                <h2 className="text-2xl font-semibold">Notas de Implementación</h2>
                <div className="prose dark:prose-invert max-w-none">
                    <ul className="list-disc pl-6 space-y-2">
                        <li>
                            El color <strong>Primary</strong> (#F213A4) se usa automáticamente en componentes shadcn con <code>variant="default"</code>.
                        </li>
                        <li>
                            Los colores <strong>Secondary</strong> (#15BF0F) y <strong>Tertiary</strong> (#FEC821) deben aplicarse explícitamente usando clases de utilidad o estilos en línea.
                        </li>
                        <li>
                            <strong>Importante:</strong> Las variables <code>--secondary</code> y <code>--accent</code> de shadcn son grises neutrales, NO los colores de la marca. Usa <code>--brand-secondary</code> para el verde oficial.
                        </li>
                        <li>
                            Para gráficos (Charts), se deben especificar los colores manualmente usando el array de colores de la marca.
                        </li>
                    </ul>
                </div>
            </section>
        </div>
    );
}
</file>

<file path="frontend2/app/(test)/kanban/page.tsx">
"use client";

import React, { useState } from "react";
import {
    DndContext,
    useDraggable,
    useDroppable,
    DragOverlay,
    DragStartEvent,
    DragOverEvent,
    DragEndEvent,
    MouseSensor,
    TouchSensor,
    useSensor,
    useSensors,
} from "@dnd-kit/core";
import { cn } from "@/lib/utils";
import { CANDIDATE_STAGE_LABELS, CandidateStage } from "@/types/ats";

const STAGES: CandidateStage[] = ['NEW', 'REV', 'INT', 'OFF', 'HIRED', 'REJ', 'POOL'];

const STAGE_COLORS: Record<CandidateStage, string> = {
    NEW: "bg-red-500",
    REV: "bg-orange-500",
    INT: "bg-yellow-500",
    OFF: "bg-teal-500",
    HIRED: "bg-green-600",
    REJ: "bg-slate-500",
    POOL: "bg-blue-500",
};

const STAGE_TEXT_COLORS: Record<CandidateStage, string> = {
    NEW: "text-red-50",
    REV: "text-orange-50",
    INT: "text-yellow-50",
    OFF: "text-teal-50",
    HIRED: "text-green-50",
    REJ: "text-slate-50",
    POOL: "text-blue-50",
};

// --- Child Components ---

function DraggableItem() {
    const { attributes, listeners, setNodeRef, isDragging } = useDraggable({
        id: "test-candidate",
    });

    return (
        <div
            ref={setNodeRef}
            {...listeners}
            {...attributes}
            className={cn(
                "w-full h-24 rounded-lg shadow-lg cursor-grab active:cursor-grabbing flex items-center justify-center font-bold text-white transition-transform hover:scale-105",
                "bg-white/20 backdrop-blur-sm border-2 border-white/50",
                isDragging ? "opacity-0" : "opacity-100"
            )}
        >
            Candidato
        </div>
    );
}

interface AccordionColumnProps {
    stage: CandidateStage;
    isActive: boolean;
    onHover: (stage: CandidateStage) => void;
    children: React.ReactNode;
}

function AccordionColumn({
    stage,
    isActive,
    onHover,
    children,
}: AccordionColumnProps) {
    const { setNodeRef } = useDroppable({
        id: stage,
    });

    return (
        <div
            ref={setNodeRef}
            // On mobile, click to expand. On desktop, hover handles it.
            onClick={() => onHover(stage)}
            onMouseEnter={() => onHover(stage)}
            className={cn(
                // Base: Vertical Layout (Mobile)
                // md: Horizontal Layout (Desktop)
                "transition-all duration-500 ease-in-out relative flex flex-col overflow-hidden",
                "w-full md:h-full md:w-auto", // Width full on mobile, auto on desktop
                STAGE_COLORS[stage],
                isActive
                    ? "flex-3 opacity-100 md:w-[320px] md:flex-none" // Mobile: grow vertically. Desktop: fixed width.
                    : "flex-1 opacity-90 hover:opacity-100 cursor-pointer md:flex-1" // Mobile: share remaining height. Desktop: share remaining width.
            )}
        >
            {isActive ? (
                // Expanded Content
                <div className="p-4 md:p-6 flex flex-col h-full animate-in fade-in duration-500 w-full min-h-[200px] md:min-w-[300px]">
                    <h2 className="text-xl md:text-2xl font-bold text-white mb-4 md:mb-6 uppercase tracking-wider">
                        {CANDIDATE_STAGE_LABELS[stage]}
                    </h2>
                    <div className="flex-1 rounded-xl bg-black/10 p-4 space-y-4 border border-white/10 overflow-y-auto">
                        {children}
                    </div>
                </div>
            ) : (
                // Collapsed Content
                // Mobile: Horizontal Text centered. Desktop: Vertical Text rotated.
                <div className="h-full w-full flex items-center justify-center min-h-[40px] md:min-w-[60px]">
                    <div className="rotate-0 md:-rotate-90 whitespace-nowrap text-lg md:text-xl font-bold text-white/80 uppercase tracking-widest">
                        {CANDIDATE_STAGE_LABELS[stage]}
                    </div>

                    {/* Indicator */}
                    {React.Children.count(children) > 0 && (
                        <div className="absolute right-4 md:right-auto md:bottom-10 w-6 h-6 rounded-full bg-white text-black text-xs flex items-center justify-center font-bold">
                            {React.Children.count(children)}
                        </div>
                    )}
                </div>
            )}

            {/* Overlay */}
            {!isActive && <div className="absolute inset-0 bg-black/10 hover:bg-black/0 transition-colors" />}
        </div>
    );
}

// --- Main Page ---

export default function TestKanbanPage() {
    const [activeStage, setActiveStage] = useState<CandidateStage>('NEW');
    const [itemStage, setItemStage] = useState<CandidateStage>('NEW');
    const [activeId, setActiveId] = useState<string | null>(null);

    const sensors = useSensors(
        useSensor(MouseSensor, {
            activationConstraint: {
                distance: 10,
            },
        }),
        useSensor(TouchSensor, {
            activationConstraint: {
                delay: 250,
                tolerance: 5,
            },
        })
    );

    const handleDragStart = (event: DragStartEvent) => {
        setActiveId(event.active.id as string);
    };

    const handleDragOver = (event: DragOverEvent) => {
        const { over } = event;
        if (over && STAGES.includes(over.id as CandidateStage)) {
            // Expand the column we are hovering over
            setActiveStage(over.id as CandidateStage);
        }
    };

    const handleDragEnd = (event: DragEndEvent) => {
        const { over } = event;
        setActiveId(null);
        if (over) {
            const newStage = over.id as CandidateStage;
            setItemStage(newStage);
            // Keep the target column expanded after drop
            setActiveStage(newStage);
        }
    };

    return (
        <div className="h-[calc(100vh-4rem)] w-full p-4 md:p-6 bg-slate-100 dark:bg-slate-950 overflow-hidden">
            <h1 className="text-2xl font-bold mb-4">Accordion Kanban Test</h1>
            <div className="h-[calc(100%-80px)] md:h-[600px] w-full bg-white dark:bg-slate-900 rounded-xl shadow-xl overflow-hidden flex flex-col md:flex-row border border-slate-200 dark:border-slate-800">
                <DndContext
                    sensors={sensors}
                    onDragStart={handleDragStart}
                    onDragOver={handleDragOver}
                    onDragEnd={handleDragEnd}
                >
                    {STAGES.map((stage) => (
                        <AccordionColumn
                            key={stage}
                            stage={stage}
                            isActive={stage === activeStage}
                            onHover={setActiveStage}
                        >
                            {itemStage === stage && <DraggableItem />}
                        </AccordionColumn>
                    ))}

                    <DragOverlay>
                        {activeId ? (
                            <div className="w-full h-24 rounded-lg bg-white/20 backdrop-blur-sm border-2 border-white/50 flex items-center justify-center font-bold text-white shadow-2xl rotate-3 cursor-grabbing">
                                Candidato
                            </div>
                        ) : null}
                    </DragOverlay>
                </DndContext>
            </div>
            <p className="mt-4 text-muted-foreground text-sm">
                Hover over sections to expand them. Drag the "Candidato" card to move it between stages.
            </p>
        </div>
    );
}
</file>

<file path="frontend2/app/(test)/test/page.tsx">
import { Card, CardHeader, CardContent } from "@/components/ui/card";
import { Globe2 } from "lucide-react";

export default function CountryCard() {
    return (
        <div className="h-screen w-full flex items-center justify-center">
            <Card className="relative w-[395px] h-[140px] flex flex-col justify-between p-5 overflow-hidden bg-linear-to-br from-blue-900 via-blue-700 to-blue-500 hover:scale-105 hover:contrast-125 hover:shadow-xl transition-all duration-300 ease-out group cursor-pointer text-white">

                <CardHeader className="p-0 text-2xl font-bold mb-1">
                    Paises
                </CardHeader>
                <CardContent className="p-0 text-sm font-medium mr-26">
                    Gestión de países para direcciones y funcionalidades
                </CardContent>

                <Globe2
                    strokeWidth={1}
                    className="absolute -right-6 -bottom-6 size-32 text-blue-200/90 group-hover:text-white/80 rotate-0 group-hover:-rotate-6 group-hover:scale-110 transition-all duration-300 ease-in-out" />
            </Card>
        </div>
    );
}
</file>

<file path="frontend2/app/globals.css">
@import "tailwindcss";
@import "tw-animate-css";

@custom-variant dark (&:is(.dark *));

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
  --color-sidebar-ring: var(--sidebar-ring);
  --color-sidebar-border: var(--sidebar-border);
  --color-sidebar-accent-foreground: var(--sidebar-accent-foreground);
  --color-sidebar-accent: var(--sidebar-accent);
  --color-sidebar-primary-foreground: var(--sidebar-primary-foreground);
  --color-sidebar-primary: var(--sidebar-primary);
  --color-sidebar-foreground: var(--sidebar-foreground);
  --color-sidebar: var(--sidebar);
  --color-chart-5: var(--chart-5);
  --color-chart-4: var(--chart-4);
  --color-chart-3: var(--chart-3);
  --color-chart-2: var(--chart-2);
  --color-chart-1: var(--chart-1);
  --color-ring: var(--ring);
  --color-input: var(--input);
  --color-border: var(--border);
  --color-destructive: var(--destructive);
  --color-accent-foreground: var(--accent-foreground);
  --color-accent: var(--accent);
  --color-muted-foreground: var(--muted-foreground);
  --color-muted: var(--muted);
  --color-secondary-foreground: var(--secondary-foreground);
  --color-secondary: var(--secondary);
  --color-primary-foreground: var(--primary-foreground);
  --color-primary: var(--primary);
  --color-popover-foreground: var(--popover-foreground);
  --color-popover: var(--popover);
  --color-card-foreground: var(--card-foreground);
  --color-card: var(--card);
  --radius-sm: calc(var(--radius) - 4px);
  --radius-md: calc(var(--radius) - 2px);
  --radius-lg: var(--radius);
  --radius-xl: calc(var(--radius) + 4px);

  --header-height: 64px;
  --sidebar-height: 64px;
  --sidebar-width: 72px;
  --font-montserrat: var(--font-montserrat);

  /* IUTIRLA Brand Colors */
  --color-brand-primary: var(--brand-primary);
  --color-brand-primary-foreground: var(--brand-primary-foreground);
  --color-brand-secondary: var(--brand-secondary);
  --color-brand-secondary-foreground: var(--brand-secondary-foreground);
  --color-brand-tertiary: var(--brand-tertiary);
  --color-brand-tertiary-foreground: var(--brand-tertiary-foreground);
}

/* @media (prefers-color-scheme: dark) {
  :root {
    --background: #0a0a0a;
    --foreground: #ededed;
  }
} */

:root {
  /* IUTIRLA Brand Colors */
  --brand-primary: oklch(0.57 0.27 338);
  --brand-primary-foreground: oklch(1 0 0);
  --brand-secondary: oklch(0.68 0.23 142);
  --brand-secondary-foreground: oklch(0.1 0 0);
  --brand-tertiary: oklch(0.73 0.16 70);
  --brand-tertiary-foreground: oklch(0.1 0 0);

  --radius: 0.65rem;
  --background: oklch(1 0 0);
  --foreground: oklch(0.141 0.005 285.823);
  --card: oklch(1 0 0);
  --card-foreground: oklch(0.141 0.005 285.823);
  --popover: oklch(1 0 0);
  --popover-foreground: oklch(0.141 0.005 285.823);

  /* Primary adapted to Brand Primary */
  --primary: var(--brand-primary);
  --primary-foreground: var(--brand-primary-foreground);

  /* Secondary kept neutral from snippet */
  --secondary: oklch(0.967 0.001 286.375);
  --secondary-foreground: oklch(0.21 0.006 285.885);

  --muted: oklch(0.967 0.001 286.375);
  --muted-foreground: oklch(0.552 0.016 285.938);
  --accent: oklch(0.967 0.001 286.375);
  --accent-foreground: oklch(0.21 0.006 285.885);
  --destructive: oklch(0.577 0.245 27.325);
  --border: oklch(0.92 0.004 286.32);
  --input: oklch(0.92 0.004 286.32);
  --ring: var(--brand-primary);

  /* Charts adapted to Brand Primary (Hue 338) */
  --chart-1: oklch(0.811 0.111 338);
  --chart-2: oklch(0.606 0.25 338);
  --chart-3: oklch(0.57 0.27 338);
  /* Primary */
  --chart-4: oklch(0.491 0.27 338);
  --chart-5: oklch(0.432 0.232 338);

  --sidebar: oklch(0.985 0 0);
  --sidebar-foreground: oklch(0.141 0.005 285.823);
  --sidebar-primary: var(--brand-primary);
  --sidebar-primary-foreground: var(--brand-primary-foreground);
  --sidebar-accent: oklch(0.967 0.001 286.375);
  --sidebar-accent-foreground: oklch(0.21 0.006 285.885);
  --sidebar-border: oklch(0.92 0.004 286.32);
  --sidebar-ring: var(--brand-primary);
}

.dark {
  /* IUTIRLA Brand Colors - Dark Mode */
  --brand-primary: oklch(0.60 0.27 338);
  --brand-secondary: oklch(0.65 0.23 142);
  --brand-tertiary: oklch(0.70 0.16 70);

  --background: oklch(0.141 0.005 285.823);
  --foreground: oklch(0.985 0 0);
  --card: oklch(0.21 0.006 285.885);
  --card-foreground: oklch(0.985 0 0);
  --popover: oklch(0.21 0.006 285.885);
  --popover-foreground: oklch(0.985 0 0);

  /* Primary adapted */
  --primary: var(--brand-primary);
  --primary-foreground: var(--brand-primary-foreground);

  /* Secondary kept neutral */
  --secondary: oklch(0.274 0.006 286.033);
  --secondary-foreground: oklch(0.985 0 0);

  --muted: oklch(0.274 0.006 286.033);
  --muted-foreground: oklch(0.705 0.015 286.067);
  --accent: oklch(0.274 0.006 286.033);
  --accent-foreground: oklch(0.985 0 0);
  --destructive: oklch(0.704 0.191 22.216);
  --border: oklch(1 0 0 / 10%);
  --input: oklch(1 0 0 / 15%);
  --ring: var(--brand-primary);

  /* Charts adapted */
  --chart-1: oklch(0.811 0.111 338);
  --chart-2: oklch(0.606 0.25 338);
  --chart-3: oklch(0.57 0.27 338);
  --chart-4: oklch(0.491 0.27 338);
  --chart-5: oklch(0.432 0.232 338);

  --sidebar: oklch(0.21 0.006 285.885);
  --sidebar-foreground: oklch(0.985 0 0);
  --sidebar-primary: var(--brand-primary);
  --sidebar-primary-foreground: var(--brand-primary-foreground);
  --sidebar-accent: oklch(0.274 0.006 286.033);
  --sidebar-accent-foreground: oklch(0.985 0 0);
  --sidebar-border: oklch(1 0 0 / 10%);
  --sidebar-ring: var(--brand-primary);
}

@layer base {
  * {
    @apply border-border outline-ring/50;
  }

  body {
    @apply bg-background text-foreground;
  }
}
</file>

<file path="frontend2/app/layout.tsx">
import "./globals.css";
import { Providers } from "@/components/providers";

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="es">
      <body>
        <Providers>
          {children}
        </Providers>
      </body>
    </html>
  );
}
</file>

<file path="frontend2/components/ats/JobCandidatesGrid.tsx">
"use client";

import useSWR from "swr";
import { CandidateCard } from "./KanbanComponents";
import { Candidate } from "@/types/ats";
import apiClient from "@/lib/api-client";
import { Users } from "lucide-react";

const fetcher = (url: string) => apiClient.get(url).then((res) => res.data.results || res.data);

interface JobCandidatesGridProps {
    jobId: string | number;
}

export function JobCandidatesGrid({ jobId }: JobCandidatesGridProps) {
    const { data: candidates, error, isLoading } = useSWR<Candidate[]>(
        `/api/ats/candidates/?job_posting=${jobId}`,
        fetcher
    );

    if (isLoading) {
        return <div className="py-8 text-center text-muted-foreground">Cargando candidatos...</div>;
    }

    if (error) {
        return <div className="py-8 text-center text-red-500">Error al cargar candidatos</div>;
    }

    if (!candidates || candidates.length === 0) {
        return (
            <div className="text-center py-12 text-muted-foreground bg-muted/20 rounded-lg border border-dashed">
                <Users className="w-12 h-12 mx-auto mb-4 opacity-50" />
                <p className="text-lg font-medium">No hay candidatos</p>
                <p className="text-sm mt-2">Esta vacante aún no tiene postulaciones registradas</p>
            </div>
        );
    }

    return (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
            {candidates.map((candidate) => (
                <CandidateCard
                    key={candidate.id}
                    candidate={candidate}
                // No pasamos acciones de mover aquí, pero podríamos
                />
            ))}
        </div>
    );
}
</file>

<file path="frontend2/components/ats/JobKanbanBoard.tsx">
"use client";

import React, { useState } from "react";
import useSWR from "swr";
import {
    DndContext,
    DragEndEvent,
    DragOverlay,
    DragStartEvent,
    DragOverEvent,
    closestCenter,
    PointerSensor,
    useSensor,
    useSensors,
    TouchSensor,
    MouseSensor
} from "@dnd-kit/core";
import { SortableContext, verticalListSortingStrategy } from "@dnd-kit/sortable";
import { useDroppable } from "@dnd-kit/core";
import {
    AlertDialog,
    AlertDialogAction,
    AlertDialogCancel,
    AlertDialogContent,
    AlertDialogDescription,
    AlertDialogFooter,
    AlertDialogHeader,
    AlertDialogTitle,
} from "@/components/ui/alert-dialog";
import { CandidateCard, SortableCandidateCard } from "./KanbanComponents";
import { Candidate, CandidateStage, CANDIDATE_STAGE_LABELS } from "@/types/ats";
import apiClient from "@/lib/api-client";
import { toast } from "sonner";
import { cn } from "@/lib/utils";

const fetcher = (url: string) => apiClient.get(url).then((res) => res.data.results || res.data);

const STAGES: CandidateStage[] = ['NEW', 'REV', 'INT', 'OFF', 'HIRED', 'REJ', 'POOL'];

const STAGE_COLORS: Record<CandidateStage, string> = {
    NEW: "bg-red-500",
    REV: "bg-orange-500",
    INT: "bg-yellow-500",
    OFF: "bg-teal-500",
    HIRED: "bg-green-600",
    REJ: "bg-slate-500",
    POOL: "bg-blue-500",
};

interface JobKanbanBoardProps {
    jobId: string | number;
}

interface AccordionColumnProps {
    stage: CandidateStage;
    isActive: boolean;
    onHover: (stage: CandidateStage) => void;
    children: React.ReactNode;
    count: number;
}

function AccordionDroppableColumn({
    stage,
    isActive,
    onHover,
    children,
    count,
}: AccordionColumnProps) {
    const { setNodeRef } = useDroppable({
        id: stage,
    });

    return (
        <div
            ref={setNodeRef}
            onClick={() => onHover(stage)}
            onMouseEnter={() => onHover(stage)}
            className={cn(
                "transition-all duration-500 ease-in-out relative flex flex-col overflow-hidden",
                "w-full md:w-auto", // Removed fixed md:h-full to allow natural growth, flex stretch handles equal height
                isActive ? "bg-slate-50 dark:bg-slate-900" : STAGE_COLORS[stage], // Active: Neutral BG. Inactive: Colored Spine.
                isActive
                    ? "flex-3 opacity-100 md:w-[350px] md:flex-none"
                    : "flex-1 opacity-90 hover:opacity-100 cursor-pointer md:flex-1 text-white" // Text white for colored spines
            )}
        >
            {isActive ? (
                // Expanded Content
                <div className="flex flex-col animate-in fade-in duration-500 w-full min-h-[200px] md:min-w-[300px] h-full">
                    {/* Header Strip */}
                    <div className={cn("p-4 md:p-6 sticky top-0 z-10 shadow-sm", STAGE_COLORS[stage])}>
                        <h2 className="text-xl md:text-2xl font-bold text-white uppercase tracking-wider">
                            {CANDIDATE_STAGE_LABELS[stage]}
                        </h2>
                    </div>

                    {/* Content Body (White/Neutral) */}
                    <div className="p-4 space-y-4 flex-1 overflow-y-auto">
                        {children}
                    </div>
                </div>
            ) : (
                // Collapsed Content
                <div className="h-full w-full flex items-center justify-center min-h-[40px] md:min-w-[60px] py-4">
                    <div className="rotate-0 md:-rotate-90 whitespace-nowrap text-lg md:text-xl font-bold text-white/90 uppercase tracking-widest">
                        {CANDIDATE_STAGE_LABELS[stage]}
                    </div>
                    {/* Indicator */}
                    {count > 0 && (
                        <div className="absolute right-4 md:right-auto md:bottom-10 w-6 h-6 rounded-full bg-white text-black text-xs flex items-center justify-center font-bold shadow-sm">
                            {count}
                        </div>
                    )}
                </div>
            )}

            {/* Overlay for collapsed items only if we want to darken them further, but strictly colors are better */}
            {!isActive && <div className="absolute inset-0 bg-black/5 hover:bg-black/0 transition-colors" />}
        </div>
    );
}

export function JobKanbanBoard({ jobId }: JobKanbanBoardProps) {
    const [activeId, setActiveId] = useState<number | null>(null);
    const [activeStage, setActiveStage] = useState<CandidateStage>('NEW');

    // State for confirmation dialog
    const [pendingMove, setPendingMove] = useState<{ candidateId: number; newStage: CandidateStage } | null>(null);

    const { data: candidates, mutate } = useSWR<Candidate[]>(
        `/api/ats/candidates/?job_posting=${jobId}`,
        fetcher
    );

    const sensors = useSensors(
        useSensor(MouseSensor, {
            activationConstraint: {
                distance: 10,
            },
        }),
        useSensor(TouchSensor, {
            activationConstraint: {
                delay: 250,
                tolerance: 5,
            },
        })
    );

    const groupCandidatesByStage = (candidates: Candidate[] | undefined) => {
        if (!candidates) return {};
        const grouped: Record<string, Candidate[]> = {};
        STAGES.forEach(stage => grouped[stage] = []);
        candidates.forEach(candidate => {
            if (grouped[candidate.stage]) {
                grouped[candidate.stage].push(candidate);
            }
        });
        return grouped;
    };

    const handleDragStart = (event: DragStartEvent) => {
        setActiveId(event.active.id as number);
    };

    const handleDragOver = (event: DragOverEvent) => {
        const { over } = event;
        if (over && STAGES.includes(over.id as CandidateStage)) {
            setActiveStage(over.id as CandidateStage);
        }
    };

    const handleDragEnd = (event: DragEndEvent) => {
        const { active, over } = event;
        setActiveId(null);

        if (!over || active.id === over.id) return;

        const candidateId = active.id as number;
        const newStage = over.id as CandidateStage;
        const currentCandidate = candidates?.find(c => c.id === candidateId);

        if (!currentCandidate || currentCandidate.stage === newStage) return;

        // Trigger confirmation dialog
        setPendingMove({ candidateId, newStage });
    };

    const confirmMove = async () => {
        if (!pendingMove) return;

        const { candidateId, newStage } = pendingMove;
        setPendingMove(null); // Close dialog

        // Optimistic update
        mutate(
            (current) => {
                if (!current) return current;
                return current.map((c) =>
                    c.id === candidateId ? { ...c, stage: newStage } : c
                );
            },
            false
        );

        try {
            await apiClient.post(`/api/ats/candidates/${candidateId}/change-stage/`, {
                stage: newStage,
            });
            toast.success("Candidato movido exitosamente");
            mutate();
        } catch (error: any) {
            console.error("Error changing stage:", error);
            toast.error("Error al mover candidato");
            mutate(); // Revert
        }
    };

    const activeCandidate = candidates?.find(c => c.id === activeId);
    const groupedCandidates = groupCandidatesByStage(candidates);

    if (!candidates) return <div className="p-8 text-center">Cargando tablero...</div>;

    return (
        <>
            <div className="min-h-[500px] h-auto w-full bg-white dark:bg-slate-900 rounded-xl shadow-xl overflow-hidden flex flex-col md:flex-row border border-slate-200 dark:border-slate-800 items-stretch">
                <DndContext
                    sensors={sensors}
                    collisionDetection={closestCenter}
                    onDragStart={handleDragStart}
                    onDragOver={handleDragOver}
                    onDragEnd={handleDragEnd}
                >
                    {STAGES.map((stage) => {
                        const stageCandidates = groupedCandidates[stage] || [];
                        const candidateIds = stageCandidates.map(c => c.id);

                        return (
                            <AccordionDroppableColumn
                                key={stage}
                                stage={stage}
                                isActive={stage === activeStage}
                                onHover={setActiveStage}
                                count={stageCandidates.length}
                            >
                                <SortableContext items={candidateIds} strategy={verticalListSortingStrategy}>
                                    {stageCandidates.map((candidate) => (
                                        <SortableCandidateCard
                                            key={candidate.id}
                                            candidate={candidate}
                                            color={STAGE_COLORS[stage]}
                                        />
                                    ))}
                                </SortableContext>
                                {stageCandidates.length === 0 && (
                                    <div className="text-center py-12 text-slate-400 text-sm italic">
                                        Arrastra aquí
                                    </div>
                                )}
                            </AccordionDroppableColumn>
                        );
                    })}

                    <DragOverlay>
                        {activeCandidate ? (
                            <CandidateCard
                                candidate={activeCandidate}
                                color={STAGE_COLORS[activeCandidate.stage]}
                            />
                        ) : null}
                    </DragOverlay>
                </DndContext>
            </div>

            <AlertDialog open={!!pendingMove} onOpenChange={(open) => !open && setPendingMove(null)}>
                <AlertDialogContent>
                    <AlertDialogHeader>
                        <AlertDialogTitle>¿Mover candidato?</AlertDialogTitle>
                        <AlertDialogDescription>
                            ¿Estás seguro de que deseas mover al candidato a la etapa
                            <span className="font-bold text-foreground"> {pendingMove ? CANDIDATE_STAGE_LABELS[pendingMove.newStage] : ''}</span>?
                        </AlertDialogDescription>
                    </AlertDialogHeader>
                    <AlertDialogFooter>
                        <AlertDialogCancel>Cancelar</AlertDialogCancel>
                        <AlertDialogAction onClick={confirmMove}>Confirmar</AlertDialogAction>
                    </AlertDialogFooter>
                </AlertDialogContent>
            </AlertDialog>
        </>
    );
}
</file>

<file path="frontend2/components/ats/KanbanComponents.tsx">
"use client";

import { useSortable } from "@dnd-kit/sortable";
import { useDroppable } from "@dnd-kit/core";
import { CSS } from "@dnd-kit/utilities";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Eye, UserCheck, Users } from "lucide-react";
import { Candidate } from "@/types/ats";
import { useRouter } from "next/navigation";
import { cn } from "@/lib/utils";

interface CandidateCardProps {
    candidate: Candidate;
    onMove?: (candidate: Candidate) => void;
    onHire?: (candidate: Candidate) => void;
    onInterview?: (candidate: Candidate) => void;
    showMove?: boolean;
    showHire?: boolean;
    showInterview?: boolean;
    color?: string; // Expect a border/bg color class prefix e.g 'border-red-500'
}

export function CandidateCard({
    candidate,
    onMove,
    onHire,
    onInterview,
    showMove,
    showHire,
    showInterview,
    color = "bg-primary", // Expect a bg color class now
}: CandidateCardProps) {
    const router = useRouter();

    return (
        <Card className="cursor-grab transition-all hover:shadow-md active:cursor-grabbing bg-white dark:bg-slate-800 rounded-lg border-0 shadow-sm overflow-hidden flex flex-col group p-0">
            {/* Header Strip with Color */}
            <div className={cn("h-8 px-3 flex items-center justify-between text-[10px] font-bold text-white uppercase tracking-wider md:text-xs", color)}>
                <span className="opacity-90">
                    {candidate.created_at
                        ? new Date(candidate.created_at).toLocaleString("es-VE", {
                            day: "2-digit",
                            month: "short",
                            hour: "2-digit",
                            minute: "2-digit"
                        })
                        : "-"}
                </span>

                {/* Actions overlaid on header or just icons */}
                <div className="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                    <Button
                        variant="ghost"
                        size="icon"
                        className="h-5 w-5 text-white hover:bg-white/20 hover:text-white"
                        onClick={(e) => {
                            e.stopPropagation();
                            router.push(`/admin/ats/candidates/${candidate.id}`);
                        }}
                        title="Ver detalle"
                    >
                        <Eye className="h-3.5 w-3.5" />
                    </Button>
                </div>
            </div>

            <CardContent className="p-3 flex flex-col gap-3">
                {/* Main Info */}
                <div className="flex flex-col gap-0.5">
                    <span className="text-[10px] font-bold text-muted-foreground uppercase tracking-widest truncate">
                        {candidate.job_posting_title || "Candidato"}
                    </span>
                    <h3 className="font-bold text-sm text-foreground leading-tight line-clamp-2 uppercase">
                        {candidate.first_name} {candidate.last_name}
                    </h3>
                </div>

                {/* Footer: Avatar & Context */}
                <div className="flex items-center justify-between pt-1">
                    <div className="flex items-center gap-2">
                        {candidate.avatar ? (
                            <img
                                src={candidate.avatar}
                                alt="avatar"
                                className="h-8 w-8 rounded-full object-cover border-2 border-slate-100 dark:border-slate-700"
                            />
                        ) : (
                            <div className="h-8 w-8 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center text-[10px] font-bold border-2 border-white dark:border-slate-700 shadow-sm">
                                {candidate.first_name[0]}{candidate.last_name[0]}
                            </div>
                        )}
                        <div className="flex flex-col justify-center">
                            <span className="text-[10px] text-muted-foreground leading-none">{candidate.email}</span>
                        </div>
                    </div>
                </div>

                {/* Bottom Action Bar (if needed explicit actions) */}
                <div className="flex items-center justify-end gap-2 border-t pt-2 border-dashed border-slate-100 dark:border-slate-700">
                    {showMove && onMove && (
                        <div className="p-1.5 rounded hover:bg-slate-100 dark:hover:bg-slate-700 cursor-move text-slate-400 hover:text-foreground transition-colors" title="Arrastrar para mover">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2v20" /><path d="m5 9-3 3 3 3" /><path d="m19 9 3 3-3 3" /><path d="M2 12h20" /><path d="m9 5 3-3 3 3" /><path d="m9 19 3 3 3-3" /></svg>
                        </div>
                    )}
                    {showInterview && onInterview && (
                        <Button
                            variant="ghost"
                            size="sm"
                            className="h-6 px-2 text-[10px] bg-green-50 text-green-600 hover:bg-green-100 hover:text-green-700"
                            onClick={(e) => { e.stopPropagation(); onInterview!(candidate); }}
                        >
                            <UserCheck className="h-3 w-3 mr-1" />
                            Entrevistar
                        </Button>
                    )}
                </div>
            </CardContent>
        </Card>
    );
}

export function SortableCandidateCard(props: CandidateCardProps) {
    const { attributes, listeners, setNodeRef, transform, transition, isDragging } = useSortable({
        id: props.candidate.id,
    });

    const style = {
        transform: CSS.Transform.toString(transform),
        transition,
        opacity: isDragging ? 0.8 : 1, // Slightly less transparent on drag
        zIndex: isDragging ? 50 : "auto", // Ensure visibility on drag
        position: 'relative' as 'relative', // Explicit for type safety
    };

    return (
        <div ref={setNodeRef} style={style} {...attributes} {...listeners} className="touch-none">
            <CandidateCard {...props} />
        </div>
    );
}

export function DroppableColumn({
    id,
    children,
    className,
}: {
    id: string;
    children: React.ReactNode;
    className?: string;
}) {
    const { setNodeRef } = useDroppable({ id });

    return (
        <div ref={setNodeRef} className={className}>
            {children}
        </div>
    );
}
</file>

<file path="frontend2/components/catalogs/catalog-card.tsx">
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { LucideIcon } from "lucide-react";
import Link from "next/link";

interface CatalogCardProps {
    title: string;
    description: string;
    icon: LucideIcon;
    href: string;
    gradient: string;
    iconColor: string;
}

export function CatalogCard({
    title,
    description,
    icon: Icon,
    href,
    gradient,
    iconColor,
}: CatalogCardProps) {
    return (
        <Link href={href}>
            <Card className={`relative h-[140px] flex flex-col p-5 overflow-hidden bg-linear-to-br ${gradient} hover:scale-105 hover:contrast-125 hover:shadow-xl transition-all duration-300 ease-out group cursor-pointer text-white border-0`}>
                <div className="h-full relative z-10 flex flex-col justify-between gap-1">
                    <CardHeader className="p-0 space-y-0">
                        <CardTitle className="mr-20 text-xl font-bold leading-tight">
                            {title}
                        </CardTitle>
                    </CardHeader>
                    <CardContent className="p-0">
                        <CardDescription className="mr-26 text-white/90 text-sm font-medium line-clamp-2">
                            {description}
                        </CardDescription>
                    </CardContent>
                </div>

                <Icon
                    strokeWidth={1.5}
                    className={`absolute -right-6 -bottom-6 size-32 ${iconColor} -rotate-6 group-hover:rotate-6 group-hover:text-white group-hover:scale-110 transition-all duration-300 ease-in-out`}
                />
            </Card>
        </Link>
    );
}
</file>

<file path="frontend2/components/courses/course-module-accordion.tsx">
"use client";

import { useState } from "react";
import { useRouter } from "next/navigation";
import {
    Accordion,
    AccordionContent,
    AccordionItem,
    AccordionTrigger,
} from "@/components/ui/accordion";
import { Button } from "@/components/ui/button";
import Link from "next/link";
import { Badge } from "@/components/ui/badge";
import {
    CheckCircle,
    Circle,
    PlayCircle,
    FileText,
    Clock,
    Lock,
    ExternalLink,
    Download,
    File,
    Trash2
} from "lucide-react";
import {
    Dialog,
    DialogContent,
    DialogDescription,
    DialogHeader,
    DialogTitle,
} from "@/components/ui/dialog";
import { CourseModule, CourseLesson, LessonProgress } from "@/types/course";
import apiClient from "@/lib/api-client";
import { toast } from "sonner";
import { cn } from "@/lib/utils";

import {
    AlertDialog,
    AlertDialogAction,
    AlertDialogCancel,
    AlertDialogContent,
    AlertDialogDescription,
    AlertDialogFooter,
    AlertDialogHeader,
    AlertDialogTitle,
} from "@/components/ui/alert-dialog";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { DialogFooter } from "@/components/ui/dialog";
import { Pencil } from "lucide-react";

interface CourseModuleAccordionProps {
    modules: CourseModule[];
    progress?: LessonProgress[];
    onLessonComplete?: (lessonId: number) => void;
    isInstructor?: boolean;
    onUpdateModule?: (moduleId: number, newName: string) => void;
    onDeleteModule?: (moduleId: number) => void;
}

export function CourseModuleAccordion({
    modules,
    progress = [],
    onLessonComplete,
    isInstructor = false,
    onUpdateModule,
    onDeleteModule
}: CourseModuleAccordionProps) {
    const router = useRouter();
    const [completingLessonId, setCompletingLessonId] = useState<number | null>(null);

    // Edit Module State
    const [isEditModuleOpen, setIsEditModuleOpen] = useState(false);
    const [moduleToEdit, setModuleToEdit] = useState<{ id: number; name: string } | null>(null);
    const [newModuleName, setNewModuleName] = useState("");

    // Delete Module State
    const [isDeleteAlertOpen, setIsDeleteAlertOpen] = useState(false);
    const [moduleToDeleteId, setModuleToDeleteId] = useState<number | null>(null);

    const isLessonCompleted = (lessonId: number) => {
        return progress.some(p => p.lesson === lessonId && p.completed);
    };

    const handleMarkComplete = async (e: React.MouseEvent, lessonId: number) => {
        e.stopPropagation();
        if (isLessonCompleted(lessonId)) return;

        setCompletingLessonId(lessonId);
        try {
            await apiClient.post(`/api/training/lesson-progress/mark_complete/`, {
                lesson_id: lessonId
            });
            toast.success("Lección completada");
            if (onLessonComplete) onLessonComplete(lessonId);
        } catch (error) {
            console.error("Error marking lesson complete:", error);
            toast.error("Error al marcar como completada");
        } finally {
            setCompletingLessonId(null);
        }
    };

    const handleUnmarkComplete = async (e: React.MouseEvent, lessonId: number) => {
        e.stopPropagation();
        const progressRecord = progress.find(p => p.lesson === lessonId);
        if (!progressRecord) return;

        try {
            await apiClient.delete(`/api/training/lesson-progress/${progressRecord.id}/`);
            toast.success("Lección desmarcada");
            if (onLessonComplete) onLessonComplete(lessonId);
        } catch (error) {
            console.error("Error unmarking lesson:", error);
            toast.error("Error al desmarcar lección");
        }
    };

    const openEditModal = (module: CourseModule) => {
        setModuleToEdit({ id: module.id, name: module.name });
        setNewModuleName(module.name);
        setIsEditModuleOpen(true);
    };

    const handleUpdateModuleSubmit = () => {
        if (moduleToEdit && onUpdateModule && newModuleName.trim()) {
            onUpdateModule(moduleToEdit.id, newModuleName);
            setIsEditModuleOpen(false);
            setModuleToEdit(null);
            setNewModuleName("");
        }
    };

    const openDeleteAlert = (moduleId: number) => {
        setModuleToDeleteId(moduleId);
        setIsDeleteAlertOpen(true);
    };

    const handleDeleteModuleConfirm = () => {
        if (moduleToDeleteId && onDeleteModule) {
            onDeleteModule(moduleToDeleteId);
            setIsDeleteAlertOpen(false);
            setModuleToDeleteId(null);
        }
    };

    if (!modules || modules.length === 0) {
        return (
            <div className="text-center py-12 text-muted-foreground bg-muted/30 rounded-lg border border-dashed">
                <FileText className="h-12 w-12 mx-auto mb-4 opacity-20" />
                <p>No hay contenido disponible para este curso aún.</p>
            </div>
        );
    }

    return (
        <>
            <Accordion type="multiple" className="w-full space-y-4">
                {modules.map((module) => (
                    <AccordionItem
                        key={module.id}
                        value={`module-${module.id}`}
                        className="border rounded-lg bg-card px-4 relative pb-12 last:border-b" // Added pb-12 for button space
                    >
                        <div className="flex items-center w-full">
                            <AccordionTrigger chevronPosition="left" className="hover:no-underline py-4 flex-1">
                                <div className="flex flex-col items-start text-left w-full">
                                    <div className="flex items-center w-full justify-between pr-4">
                                        <span className="font-semibold text-lg">{module.name}</span>
                                        <Badge variant="secondary" className="ml-2">
                                            {module.lessons?.length || 0} lecciones
                                        </Badge>
                                    </div>
                                    {module.description && (
                                        <p className="text-sm text-muted-foreground mt-1 font-normal">
                                            {module.description}
                                        </p>
                                    )}
                                </div>
                            </AccordionTrigger>
                        </div>

                        <AccordionContent className="pt-2 pb-4 space-y-2">
                            {module.lessons && module.lessons.length > 0 ? (
                                <div className="space-y-2">
                                    {module.lessons.map((lesson) => {
                                        const completed = isLessonCompleted(lesson.id);

                                        return (
                                            <div
                                                key={lesson.id}
                                                className={cn(
                                                    "flex items-center justify-between p-3 rounded-md border transition-colors",
                                                    completed ? "bg-green-50/50 border-green-100" : "bg-background hover:bg-accent/50"
                                                )}
                                            >
                                                <div className="flex items-center space-x-3 overflow-hidden">
                                                    <div className={cn(
                                                        "flex-shrink-0 h-8 w-8 rounded-full flex items-center justify-center",
                                                        completed ? "bg-green-100 text-green-600" : "bg-primary/10 text-primary"
                                                    )}>
                                                        {completed ? (
                                                            <CheckCircle className="h-5 w-5" />
                                                        ) : (
                                                            <PlayCircle className="h-5 w-5" />
                                                        )}
                                                    </div>
                                                    <div className="flex flex-col min-w-0">
                                                        <span className={cn(
                                                            "font-medium truncate",
                                                            completed && "text-muted-foreground line-through decoration-green-500/30"
                                                        )}>
                                                            {lesson.title}
                                                        </span>
                                                        <div className="flex items-center text-xs text-muted-foreground space-x-2">
                                                            <span className="flex items-center">
                                                                <Clock className="h-3 w-3 mr-1" />
                                                                {lesson.duration_minutes} min
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div className="flex items-center space-x-2 ml-4">
                                                    <Button
                                                        variant="ghost"
                                                        size="sm"
                                                        asChild
                                                    >
                                                        <Link href={`/training/${module.course}/lessons/${lesson.id}`}>
                                                            Ver Contenido
                                                        </Link>
                                                    </Button>

                                                    {!isInstructor && !completed && (
                                                        <Button
                                                            size="sm"
                                                            variant="outline"
                                                            className="h-8"
                                                            onClick={(e) => handleMarkComplete(e, lesson.id)}
                                                            disabled={completingLessonId === lesson.id}
                                                        >
                                                            {completingLessonId === lesson.id ? "..." : "Marcar Listo"}
                                                        </Button>
                                                    )}

                                                    {!isInstructor && completed && (
                                                        <div className="flex items-center space-x-2">
                                                            <Badge variant="outline" className="bg-green-50 text-green-700 border-green-200">
                                                                Completado
                                                            </Badge>
                                                            <Button
                                                                size="sm"
                                                                variant="ghost"
                                                                className="h-8 text-muted-foreground hover:text-destructive"
                                                                onClick={(e) => handleUnmarkComplete(e, lesson.id)}
                                                            >
                                                                Desmarcar
                                                            </Button>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            ) : (
                                <p className="text-sm text-muted-foreground italic pl-4">
                                    No hay lecciones en este módulo.
                                </p>
                            )}
                        </AccordionContent>

                        {/* Instructor Actions - Bottom Right */}
                        {isInstructor && (
                            <div className="absolute bottom-2 right-4 flex items-center gap-2">
                                <Button
                                    variant="ghost"
                                    size="sm"
                                    className="h-8 w-8 text-muted-foreground hover:text-primary"
                                    onClick={() => openEditModal(module)}
                                >
                                    <Pencil className="h-4 w-4" />
                                </Button>
                                <Button
                                    variant="ghost"
                                    size="sm"
                                    className="h-8 w-8 text-muted-foreground hover:text-destructive"
                                    onClick={() => openDeleteAlert(module.id)}
                                >
                                    <Trash2 className="h-4 w-4" />
                                </Button>
                            </div>
                        )}
                    </AccordionItem>
                ))}
            </Accordion>

            {/* Edit Module Dialog */}
            <Dialog open={isEditModuleOpen} onOpenChange={setIsEditModuleOpen}>
                <DialogContent>
                    <DialogHeader>
                        <DialogTitle>Editar Módulo</DialogTitle>
                        <DialogDescription>
                            Modifica el nombre del módulo.
                        </DialogDescription>
                    </DialogHeader>
                    <div className="grid gap-4 py-4">
                        <div className="grid gap-2">
                            <Label htmlFor="name">Nombre del Módulo</Label>
                            <Input
                                id="name"
                                value={newModuleName}
                                onChange={(e) => setNewModuleName(e.target.value)}
                            />
                        </div>
                    </div>
                    <DialogFooter>
                        <Button variant="outline" onClick={() => setIsEditModuleOpen(false)}>Cancelar</Button>
                        <Button onClick={handleUpdateModuleSubmit}>Guardar Cambios</Button>
                    </DialogFooter>
                </DialogContent>
            </Dialog>

            {/* Delete Confirmation Alert */}
            <AlertDialog open={isDeleteAlertOpen} onOpenChange={setIsDeleteAlertOpen}>
                <AlertDialogContent>
                    <AlertDialogHeader>
                        <AlertDialogTitle>¿Estás seguro?</AlertDialogTitle>
                        <AlertDialogDescription>
                            Esta acción no se puede deshacer. Esto eliminará permanentemente el módulo y todas las lecciones asociadas.
                        </AlertDialogDescription>
                    </AlertDialogHeader>
                    <AlertDialogFooter>
                        <AlertDialogCancel>Cancelar</AlertDialogCancel>
                        <AlertDialogAction onClick={handleDeleteModuleConfirm} className="bg-destructive text-destructive-foreground hover:bg-destructive/90">
                            Eliminar
                        </AlertDialogAction>
                    </AlertDialogFooter>
                </AlertDialogContent>
            </AlertDialog>
        </>
    );
}
</file>

<file path="frontend2/components/departments/department-card.tsx">
"use client";

import { useState } from "react";
import Image from "next/image";
import { useRouter } from "next/navigation";
import { Card, CardContent, CardFooter } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Users, ArrowRight } from "lucide-react";

interface Department {
    id: number;
    name: string;
    manager: {
        name: string;
        position: string;
    } | null;
}

interface DepartmentCardProps {
    department: Department;
    href?: string;
}

export function DepartmentCard({ department, href }: DepartmentCardProps) {
    const router = useRouter();
    const [imageError, setImageError] = useState(false);

    const coverImageSrc = !imageError
        ? "/images/department-placeholder.webp"
        : "/images/department-placeholder.webp";

    const handleClick = () => {
        if (href) {
            router.push(href);
        }
    };

    return (
        <Card className="overflow-hidden hover:shadow-lg transition-shadow duration-300 h-full flex flex-col p-0">
            {/* Cover Image */}
            <div className="relative h-48 w-full overflow-hidden">
                <Image
                    src={coverImageSrc}
                    alt={department.name}
                    fill
                    className="object-cover"
                    onError={() => setImageError(true)}
                />
            </div>

            <CardContent className="flex-1 flex flex-col gap-4 p-4">
                {/* Department Name */}
                <h3 className="text-lg font-semibold line-clamp-2">
                    {department.name}
                </h3>

                {/* Manager Info */}
                <div className="flex flex-col border-t pt-4">
                    <div className="flex items-start gap-2 text-sm">
                        <Users className="h-4 w-4 text-muted-foreground mt-0.5 shrink-0" />
                        <div className="flex-1 min-w-0">
                            <p className="text-xs text-muted-foreground">Gerente</p>
                            {department.manager ? (
                                <div>
                                    <p className="font-medium truncate">{department.manager.name}</p>
                                    <p className="text-xs text-muted-foreground truncate">
                                        {department.manager.position.split(" - ")[0]}
                                    </p>
                                </div>
                            ) : (
                                <p className="text-muted-foreground italic text-sm">Sin gerente asignado</p>
                            )}
                        </div>
                    </div>
                </div>
            </CardContent>

            <CardFooter className="p-4 pt-0">
                <Button onClick={handleClick} variant="outline" className="w-full">
                    Ver Departamento
                    <ArrowRight className="ml-2 h-4 w-4" />
                </Button>
            </CardFooter>
        </Card>
    );
}
</file>

<file path="frontend2/components/departments/department-org-chart.tsx">
"use client";

import { useMemo, useState, useEffect } from "react";
import ReactFlow, {
    Background,
    Controls,
    Edge,
    Node,
    Position as FlowPosition,
    useNodesState,
    useEdgesState,
    Handle,
    Panel,
    useReactFlow,
    ReactFlowProvider,
} from "reactflow";
import "reactflow/dist/style.css";
import dagre from "dagre";
import { toPng } from "html-to-image";
import { jsPDF } from "jspdf";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Card, CardContent } from "@/components/ui/card";
import {
    DropdownMenu,
    DropdownMenuContent,
    DropdownMenuItem,
    DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { Label } from "@/components/ui/label";
import { Switch } from "@/components/ui/switch";
import { Star, User, Download, ChevronDown, FileImage, FileText } from "lucide-react";

// --- TYPES ---
interface Occupant {
    id: number;
    name: string;
    email: string | null;
    photo: string | null;
    is_current_user: boolean;
}

interface PositionData {
    id: number;
    name: string;
    is_manager: boolean;
    vacancies: number;
    occupants: Occupant[];
    manager_positions: { id: number; name: string }[];
    isRoot?: boolean;
}

interface OrgChartProps {
    positions: PositionData[];
    departmentId: number;
}

// --- CUSTOM NODE ---
// --- CUSTOM NODE ---
// --- CUSTOM NODE ---
const EmployeeNode = ({ data }: { data: PositionData & { showEmployees: boolean } }) => {
    const occupant = data.occupants[0];
    const isVacancy = !occupant;
    const showEmployees = data.showEmployees;

    // Derived styles to match SVG/PDF exactly
    const isManager = data.is_manager;

    // Exact sizing from SVG generation:
    // Width: 270px
    // Header Height: 42px
    // Body Height: 58px (Total 100px)
    // Avatar Left: 16px
    // Font Header: 13px
    // Font Name: 12px

    // PDF Style Replication:
    // Manager: Yellow Border (#fbbf24), Header Bg (#f8fafc).
    // Others: Slate Border (#cbd5e1), Header Bg (#f8fafc).

    return (
        <div className="w-[270px] relative">
            <Handle
                type="target"
                position={FlowPosition.Top}
                className="!bg-transparent !w-px !h-px !min-w-0 !min-h-0 !border-0 !top-0 !-translate-y-1/2"
            />

            <div className={`
                flex flex-col rounded-lg overflow-hidden bg-white shadow-sm transition-all duration-200 border transform-gpu 
                ${isManager ? "border-amber-400 ring-1 ring-amber-400/20" : "border-slate-400 hover:border-slate-500"}
            `}>
                {/* Header: Position Name */}
                <div className={`
                    flex items-center justify-center px-2 h-[42px] text-center shrink-0
                    ${showEmployees ? 'border-b' : ''}
                    ${isManager ? 'bg-slate-50 border-slate-300' : 'bg-slate-50 border-slate-300'}
                `}>
                    <span className={`text-[13px] leading-tight line-clamp-2 ${isManager ? "font-bold text-slate-900" : "font-semibold text-slate-800"}`} title={data.name}>
                        {data.name}
                    </span>
                </div>

                {/* Body: Employee Info (Conditional) List */}
                {showEmployees && (
                    <div className="flex flex-col bg-white shrink-0 relative">
                        {/* 1. Render Occupants */}
                        {data.occupants.map((occupant, index) => (
                            <div key={`occ-${occupant.id}`} className="h-[58px] flex items-center pl-[16px] pr-3 border-t border-slate-300 first:border-t-0 relative">
                                {/* Avatar */}
                                <div className="shrink-0 mr-[12px]">
                                    <Avatar className="h-[36px] w-[36px] border border-slate-300">
                                        <AvatarImage src={occupant?.photo || undefined} alt={occupant?.name} className="object-cover" />
                                        <AvatarFallback className="text-[10px] font-medium bg-slate-100 text-slate-600">
                                            {occupant?.name?.charAt(0).toUpperCase()}
                                        </AvatarFallback>
                                    </Avatar>
                                </div>
                                {/* Name */}
                                <div className="flex-1 min-w-0 flex flex-col justify-center">
                                    <span className={`text-[12px] truncate font-medium leading-tight ${occupant.is_current_user ? "text-blue-600" : "text-slate-700"}`} title={occupant.name}>
                                        {occupant.name}
                                    </span>
                                </div>
                            </div>
                        ))}

                        {/* 2. Render Vacancies */}
                        {Array.from({ length: Math.max(0, data.vacancies || 0) }).map((_, index) => (
                            <div key={`vac-${index}`} className="h-[58px] flex items-center pl-[16px] pr-3 border-t border-slate-300 first:border-t-0 relative">
                                <div className="shrink-0 mr-[12px]">
                                    <div className="h-[36px] w-[36px] rounded-full bg-slate-100 flex items-center justify-center border border-slate-200">
                                        <User className="h-4 w-4 text-slate-400" />
                                    </div>
                                </div>
                                <div className="flex-1 min-w-0 flex flex-col justify-center">
                                    <span className="text-[12px] text-slate-400 italic font-medium">Vacante</span>
                                </div>
                            </div>
                        ))}

                        {/* 3. Empty State fallback (if neither occupants nor vacancies) */}
                        {data.occupants.length === 0 && (data.vacancies || 0) === 0 && (
                            <div className="h-[58px] flex items-center pl-[16px] pr-3 border-t border-slate-300 first:border-t-0 relative">
                                <div className="shrink-0 mr-[12px]">
                                    <div className="h-[36px] w-[36px] rounded-full bg-slate-100 flex items-center justify-center border border-slate-200">
                                        <User className="h-4 w-4 text-slate-400" />
                                    </div>
                                </div>
                                <div className="flex-1 min-w-0 flex flex-col justify-center">
                                    <span className="text-[12px] text-slate-400 italic font-medium">Vacante</span>
                                </div>
                            </div>
                        )}

                        {/* Manager Icon Indicator (Only on first row? or floating? Floating looks better for 'Position' level) */}
                        {data.is_manager && !data.isRoot && (
                            <div className="absolute right-3 top-[29px] -translate-y-1/2 z-10" title="Posición Gerencial">
                                <div className="h-5 w-5 bg-amber-50 rounded-full flex items-center justify-center border border-amber-200">
                                    <Star className="h-3 w-3 fill-amber-400 text-amber-400" />
                                </div>
                            </div>
                        )}
                    </div>
                )}
            </div>

            <Handle
                type="source"
                position={FlowPosition.Bottom}
                className="!bg-transparent !w-px !h-px !min-w-0 !min-h-0 !border-0 !bottom-0 !translate-y-1/2"
            />
        </div>
    );
};

const nodeTypes = {
    employee: EmployeeNode,
};

// --- HELPER: GENERATE CLEAN SVG FROM REACT FLOW DATA ---
const generateOrgChartSVG = async (nodes: Node[], edges: Edge[], width: number, height: number, showEmployees: boolean) => {
    if (nodes.length === 0) return '';

    // 1. Calculate bounding box
    let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
    nodes.forEach(node => {
        if (node.position.x < minX) minX = node.position.x;
        if (node.position.y < minY) minY = node.position.y;
        if (node.position.x + (node.width || 270) > maxX) maxX = node.position.x + (node.width || 270);
        if (node.position.y + (node.height || (showEmployees ? 100 : 50)) > maxY) maxY = node.position.y + (node.height || (showEmployees ? 100 : 50));
    });

    if (!isFinite(minX) || !isFinite(maxX) || !isFinite(minY) || !isFinite(maxY)) {
        return '';
    }

    // Add padding
    const padding = 50;
    minX -= padding; minY -= padding;
    maxX += padding; maxY += padding;
    const viewWidth = maxX - minX;
    const viewHeight = maxY - minY;

    // 2. Helper to escape XML special chars
    const esc = (s: string) => s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');

    // 3. Helper to fetch image and convert to base64
    const getBase64Image = async (url: string) => {
        try {
            const response = await fetch(url);
            const blob = await response.blob();
            return new Promise<string>((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result as string);
                reader.readAsDataURL(blob);
            });
        } catch (e) {
            return null;
        }
    };

    // 4. Build SVG parts
    // Using standard Tailwind colors for "Premium" look

    // UPDATED COLORS PER USER REQUEST:
    // Card border: #cbd5e1 (slate-300) - was 200
    // Header bg (Position): #f8fafc (slate-50) for ALL, including manager

    let svgContent = `<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="${minX} ${minY} ${viewWidth} ${viewHeight}" width="${viewWidth}" height="${viewHeight}">
    <style>
        .font-sans { font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .text-position { font-size: 13px; font-weight: 600; fill: #0f172a; dominant-baseline: middle; text-anchor: middle; }
        .text-name { font-size: 12px; font-weight: 500; fill: #334155; dominant-baseline: middle; text-anchor: start; }
        .text-vacancy { font-size: 12px; fill: #94a3b8; font-style: italic; dominant-baseline: middle; text-anchor: start; }
        
        .card-base { fill: #ffffff; stroke: #94a3b8; stroke-width: 1.5px; }
        .card-manager { stroke: #94a3b8; stroke-width: 1.5px; }
        .card-border { fill: none; stroke: #94a3b8; stroke-width: 1.5px; }
        .card-header { fill: #f8fafc; }
        
        .badge-manager { fill: #fffbeb; stroke: #fbbf24; }
        .badge-text { font-size: 10px; fill: #b45309; font-weight: 600; text-anchor: middle; dominant-baseline: middle; }
        
        .edge-path { stroke: #94a3b8; stroke-width: 2px; fill: none; }
    </style>
    <rect x="${minX}" y="${minY}" width="${viewWidth}" height="${viewHeight}" fill="#ffffff" /> 
    <g>`;

    // Draw Edges
    edges.forEach(edge => {
        const sourceNode = nodes.find(n => n.id === edge.source);
        const targetNode = nodes.find(n => n.id === edge.target);
        if (!sourceNode || !targetNode) return;

        // Visual height logic matching functionality
        const visualHeightExpanded = 100;
        const visualHeightCollapsed = 42;
        const srcHeight = showEmployees ? visualHeightExpanded : visualHeightCollapsed;

        const sx = sourceNode.position.x + (sourceNode.width || 270) / 2;
        const sy = sourceNode.position.y + srcHeight;
        const tx = targetNode.position.x + (targetNode.width || 270) / 2;
        const ty = targetNode.position.y;

        // Actually, previous logic assumed fixed visualHeightExpanded=100.
        // But now nodes have variable heights.
        // We must trust the Edge source handle, but here we are manual drawing.
        // The source handle is at Bottom. 
        // node.height was updated in layout.

        const realSrcHeight = sourceNode.height || (showEmployees ? 100 : 42);

        const sx_real = sourceNode.position.x + (sourceNode.width || 270) / 2;
        const sy_real = sourceNode.position.y + realSrcHeight;

        const midY = sy_real + (ty - sy_real) / 2;

        const pathData = `M ${sx_real} ${sy_real} L ${sx_real} ${midY} L ${tx} ${midY} L ${tx} ${ty}`;

        svgContent += `<path d="${pathData}" class="edge-path" />`;
    });

    // Draw Nodes
    for (const node of nodes) {
        const x = node.position.x;
        const y = node.position.y;
        const w = node.width || 270;

        // Use the calculated layout height
        const visualHeight = node.height || (showEmployees ? 100 : 42);
        const headerHeight = 42;
        const rowHeight = 58;

        const data = node.data as PositionData;

        const occupants = data.occupants || [];
        const vacancies = data.vacancies || 0;

        // Determine Rows
        let rows: { type: 'occupant' | 'vacancy', data?: Occupant }[] = [];
        occupants.forEach(occ => rows.push({ type: 'occupant', data: occ }));
        for (let i = 0; i < vacancies; i++) rows.push({ type: 'vacancy' });

        // Is Empty? Fallback
        if (rows.length === 0) rows.push({ type: 'vacancy' });

        const isManager = data.is_manager;

        // CARD CONTAINER
        // Main Border Rect
        const strokeClass = isManager ? "card-manager" : "card-base";
        const rx = 8;

        // Clip path for main card
        const cardClipId = `card-clip-${node.id}`;
        svgContent += `<defs><clipPath id="${cardClipId}"><rect x="${x}" y="${y}" width="${w}" height="${visualHeight}" rx="${rx}" ry="${rx}" /></clipPath></defs>`;

        // 1. Draw Base Card Background (No Border yet)
        svgContent += `<rect x="${x}" y="${y}" width="${w}" height="${visualHeight}" rx="${rx}" ry="${rx}" fill="#ffffff" />`;

        // 2. HEADER Background
        svgContent += `<rect x="${x}" y="${y}" width="${w}" height="${headerHeight}" class="card-header" clip-path="url(#${cardClipId})" />`;

        // Position Name Text
        svgContent += `<text x="${x + w / 2}" y="${y + headerHeight / 2 + 1}" class="text-position font-sans">${esc(data.name)}</text>`;

        // BODY (Rows)
        if (showEmployees) {
            let currentY = y + headerHeight;

            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const centerY = currentY + rowHeight / 2;

                // Separator (except first)
                if (i > 0) {
                    svgContent += `<line x1="${x}" y1="${currentY}" x2="${x + w}" y2="${currentY}" stroke="#cbd5e1" stroke-width="1" />`;
                } else {
                    // Main header separator
                    svgContent += `<line x1="${x}" y1="${currentY}" x2="${x + w}" y2="${currentY}" stroke="#cbd5e1" stroke-width="1" />`;
                }

                // Avatar
                const avatarSize = 36;
                const avatarX = x + 16;
                const avatarY = centerY - avatarSize / 2;

                const avatarClipId = `avatar-clip-${node.id}-${i}`;
                svgContent += `<defs><clipPath id="${avatarClipId}"><circle cx="${avatarX + avatarSize / 2}" cy="${avatarY + avatarSize / 2}" r="${avatarSize / 2}" /></clipPath></defs>`;
                svgContent += `<circle cx="${avatarX + avatarSize / 2}" cy="${avatarY + avatarSize / 2}" r="${avatarSize / 2}" fill="#f1f5f9" stroke="#cbd5e1" stroke-width="1" />`;

                if (row.type === 'occupant' && row.data?.photo) {
                    const base64Photo = await getBase64Image(row.data.photo);
                    if (base64Photo) {
                        svgContent += `<image xlink:href="${base64Photo}" x="${avatarX}" y="${avatarY}" width="${avatarSize}" height="${avatarSize}" clip-path="url(#${avatarClipId})" preserveAspectRatio="xMidYMid slice" />`;
                    }
                } else {
                    // Fallback Icon -> Initials to match Frontend AvatarFallback
                    // Frontend: bg-slate-100 (#f1f5f9), text-slate-600 (#475569), font-medium
                    // Circle background is already drawn above.
                    const initial = row.type === 'occupant' ? row.data!.name.charAt(0).toUpperCase() : "";

                    if (initial) {
                        svgContent += `<text x="${avatarX + avatarSize / 2}" y="${avatarY + avatarSize / 2 + 1}" text-anchor="middle" dominant-baseline="middle" font-size="14" font-weight="600" fill="#475569" class="font-sans">${initial}</text>`;
                    } else {
                        // Vacancy Icon Fallback (keep icon for Vacancy)
                        svgContent += `<g transform="translate(${avatarX + 9}, ${avatarY + 9}) scale(0.75)">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" stroke="#94a3b8" stroke-width="2" fill="none"/>
                            <circle cx="12" cy="7" r="4" stroke="#94a3b8" stroke-width="2" fill="none"/>
                        </g>`;
                    }
                }

                // Text
                const textX = avatarX + avatarSize + 12;
                const name = row.type === 'occupant' ? row.data!.name : "Vacante";
                const textClass = row.type === 'vacancy' ? "text-vacancy" : "text-name";

                svgContent += `<text x="${textX}" y="${centerY}" class="${textClass} font-sans">${esc(name)}</text>`;

                // Advance Y
                currentY += rowHeight;
            }

            // Manager Badge (Only on first row logic or floating?)
            // Floating in CSS, but in SVG hard to float. We'll put it on top right of the *first* row's area visually.
            if (isManager && !data.isRoot) {
                const badgeSize = 20;
                const badgeX = x + w - badgeSize - 12;
                const badgeY = (y + headerHeight + rowHeight / 2) - badgeSize / 2; // Vertically centered on first row

                svgContent += `<circle cx="${badgeX + badgeSize / 2}" cy="${badgeY + badgeSize / 2}" r="${badgeSize / 2}" fill="#fffbeb" stroke="#fbbf24" stroke-width="1" />`;
                svgContent += `<path d="M${badgeX + 6} ${badgeY + 8} l1.5 -4.5 l1.5 4.5 h4.5 l-3.5 2.5 l1.5 4.5 l-3.5 -2.5 l-3.5 2.5 l1.5 -4.5 l-3.5 -2.5 z" fill="#fbbf24" transform="scale(0.5) translate(${badgeX * 2}, ${badgeY * 2})" />`;
            }

        }

        // Draw Card Border ON TOP to ensure uniform thickness
        // Header background won't overlap half the stroke now.
        // Use separate class or reuse logic
        const borderStrokeClass = isManager ? "card-manager" : "card-border";
        // Actually card-manager in style has stroke. We need 'fill: none' for this top rect.
        svgContent += `<rect x="${x}" y="${y}" width="${w}" height="${visualHeight}" rx="${rx}" ry="${rx}" class="${borderStrokeClass}" fill="none" />`;
    }

    svgContent += `</g></svg>`;
    return svgContent;
};

// --- DOWNLOAD BUTTON COMPONENT ---
function DownloadButton({ departmentId, showEmployees }: { departmentId: number, showEmployees: boolean }) {
    const { fitView, getNodes, getEdges } = useReactFlow();

    const downloadImage = async (format: 'png' | 'pdf' | 'svg') => {
        if (format === 'png') {
            // PNG: High-quality screenshot
            fitView({ padding: 0.2, duration: 0 });
            await new Promise(resolve => setTimeout(resolve, 100));

            const container = document.querySelector('.react-flow') as HTMLElement;
            if (!container) return;

            const dataUrl = await toPng(container, {
                backgroundColor: '#ffffff',
                fontEmbedCSS: '',
                pixelRatio: 4,
                filter: (node) => {
                    const element = node as HTMLElement;
                    if (element.classList) {
                        return !['react-flow__controls', 'react-flow__panel', 'react-flow__attribution'].some(c => element.classList.contains(c));
                    }
                    return true;
                }
            });

            const a = document.createElement('a');
            a.setAttribute('download', 'organigrama-departamento.png');
            a.setAttribute('href', dataUrl);
            a.click();
        } else {
            // PDF/SVG: Generate clean SVG from layout data and send to backend
            try {
                const nodes = getNodes();
                const edges = getEdges();
                const svgContent = await generateOrgChartSVG(nodes, edges, 0, 0, showEmployees);
                if (!svgContent) {
                    alert("El gráfico está vacío o cargando.");
                    return;
                }

                const apiClient = (await import('@/lib/api-client')).default;
                const response = await apiClient.post(
                    `/api/organization/departments/${departmentId}/export-org-chart/`,
                    { format, svg_content: svgContent },
                    { responseType: 'blob' }
                );

                const blob = response.data as Blob;
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `organigrama-departamento.${format}`;
                a.click();
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Export error:', error);
                alert('Error al exportar el organigrama');
            }
        }
    };

    return (
        <DropdownMenu>
            <DropdownMenuTrigger asChild>
                <Button variant="outline" size="sm" className="bg-background/80 backdrop-blur-sm shadow-sm">
                    <Download className="mr-2 size-4" />
                    Descargar
                    <ChevronDown className="ml-2 size-3 opacity-50" />
                </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="end">
                <DropdownMenuItem onClick={() => downloadImage('png')}>
                    <FileImage className="mr-2 size-4" />
                    Imagen (PNG)
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => downloadImage('svg')}>
                    <FileImage className="mr-2 size-4" />
                    Vector (SVG)
                </DropdownMenuItem>
                <DropdownMenuItem onClick={() => downloadImage('pdf')}>
                    <FileText className="mr-2 size-4" />
                    Documento (PDF)
                </DropdownMenuItem>
            </DropdownMenuContent>
        </DropdownMenu>
    );
}

// --- LAYOUT HELPER ---
const getLayoutedElements = (nodes: Node[], edges: Edge[], showEmployees: boolean) => {
    const dagreGraph = new dagre.graphlib.Graph();
    dagreGraph.setDefaultEdgeLabel(() => ({}));
    dagreGraph.setGraph({ rankdir: "TB", ranksep: 60, nodesep: 30 }); // Tighter packing

    const nodeWidth = 270;

    // 1. Calculate Real Heights and build Hierarchy for Top Alignment
    const nodeHeights: Record<string, number> = {};
    const nodeLevels: Record<string, number> = {};
    const childrenMap: Record<string, string[]> = {};
    const parentMap: Record<string, string[]> = {}; // for finding roots

    nodes.forEach(node => {
        const data = node.data as PositionData;
        const rowCount = Math.max(1, (data.occupants?.length || 0) + (data.vacancies || 0));
        const h = showEmployees ? 42 + (rowCount * 58) : 42;
        nodeHeights[node.id] = h;
        node.height = h;
        node.width = nodeWidth;

        childrenMap[node.id] = [];
        if (!parentMap[node.id]) parentMap[node.id] = [];
    });

    edges.forEach(edge => {
        if (childrenMap[edge.source]) childrenMap[edge.source].push(edge.target);
        if (!parentMap[edge.target]) parentMap[edge.target] = [];
        parentMap[edge.target].push(edge.source);
    });

    // 2. BFS for Levels
    const queue: { id: string, level: number }[] = [];

    // Find roots (nodes with no parents within the graph subset)
    nodes.forEach(node => {
        if ((parentMap[node.id] || []).length === 0) {
            queue.push({ id: node.id, level: 0 });
        }
    });

    const maxHeightsByLevel: Record<number, number> = {};

    while (queue.length > 0) {
        const { id, level } = queue.shift()!;
        if (nodeLevels[id] !== undefined) continue; // Visited

        nodeLevels[id] = level;

        // Update Max Height for this level
        const h = nodeHeights[id];
        if (!maxHeightsByLevel[level] || h > maxHeightsByLevel[level]) {
            maxHeightsByLevel[level] = h;
        }

        // Add children
        const children = childrenMap[id] || [];
        children.forEach(childId => {
            queue.push({ id: childId, level: level + 1 });
        });
    }

    // 3. Set Graph with Uniform Heights per Level (Logic for Top Alignment)
    nodes.forEach((node) => {
        const level = nodeLevels[node.id] || 0;
        // Use Max Height of the level so Dagre spaces them evenly for that row
        const uniformHeight = maxHeightsByLevel[level] || nodeHeights[node.id];

        dagreGraph.setNode(node.id, { width: nodeWidth, height: uniformHeight });
    });

    edges.forEach((edge) => {
        dagreGraph.setEdge(edge.source, edge.target);
    });

    dagre.layout(dagreGraph);

    // 4. Apply positions
    nodes.forEach((node) => {
        const nodeWithPosition = dagreGraph.node(node.id);
        const level = nodeLevels[node.id] || 0;
        const uniformHeight = maxHeightsByLevel[level] || node.height || 42;

        // Calculate Top-Left Position
        // Since we lied to Dagre about height (using uniformHeight), nodeWithPosition.y is center of that large box.
        // Subtracting half of uniformHeight gives us the Top Y shared by all in this row.
        node.position = {
            x: nodeWithPosition.x - nodeWidth / 2,
            y: nodeWithPosition.y - uniformHeight / 2,
        };
    });

    return { nodes, edges };
};

// --- MAIN COMPONENT ---
export function DepartmentOrgChart({ positions, departmentId }: OrgChartProps) {
    return (
        <div className="h-[600px] w-full border rounded-md bg-white overflow-hidden relative group">
            <ReactFlowProvider>
                <DepartmentOrgChartContent positions={positions} departmentId={departmentId} />
            </ReactFlowProvider>
        </div>
    );
}

function DepartmentOrgChartContent({ positions, departmentId }: OrgChartProps) {
    const { fitView } = useReactFlow();
    const [showEmployees, setShowEmployees] = useState(true);

    // Initial Data Calculation
    const { initialNodes, initialEdges } = useMemo(() => {
        const nodes: Node[] = [];
        const edges: Edge[] = [];

        // Helper to find root
        const isRootPosition = (pos: PositionData) => {
            if (pos.manager_positions.length === 0) return true;
            return !pos.manager_positions.some(manager => positions.some(p => p.id === manager.id));
        };

        positions.forEach((pos) => {
            const isRoot = isRootPosition(pos);
            const nodeId = `pos-${pos.id}`;

            // One node per position, passing all occupants
            nodes.push({
                id: nodeId,
                type: "employee",
                data: { ...pos, isRoot, showEmployees }, // pos contains occupants array
                position: { x: 0, y: 0 },
            });
        });

        // Edges
        positions.forEach((pos) => {
            // My ID is pos.id
            const targetId = `pos-${pos.id}`;

            pos.manager_positions.forEach((manager) => {
                // Check if manager exists in our set
                if (positions.some(p => p.id === manager.id)) {
                    const sourceId = `pos-${manager.id}`;
                    edges.push({
                        id: `e-${sourceId}-${targetId}`,
                        source: sourceId,
                        target: targetId,
                        type: 'step',
                        style: { stroke: '#94a3b8', strokeWidth: 1.5 },
                    });
                }
            });
        });

        return { initialNodes: nodes, initialEdges: edges };
    }, [positions]); // Dependencies

    const [nodes, setNodes, onNodesChange] = useNodesState([]);
    const [edges, setEdges, onEdgesChange] = useEdgesState([]);

    // Effect to update layout when showEmployees changes
    useEffect(() => {
        // Update data in all nodes
        const updatedNodes = initialNodes.map(node => ({
            ...node,
            data: { ...node.data, showEmployees }
        }));

        const { nodes: layoutedNodes, edges: layoutedEdges } = getLayoutedElements(
            updatedNodes,
            initialEdges,
            showEmployees
        );

        setNodes([...layoutedNodes]);
        setEdges([...layoutedEdges]);

        // Fit view after small delay to allow render
        setTimeout(() => {
            fitView({ padding: 0.2, duration: 800 });
        }, 50);

    }, [initialNodes, initialEdges, showEmployees, setNodes, setEdges, fitView]);

    return (
        <>
            <ReactFlow
                nodes={nodes}
                edges={edges}
                onNodesChange={onNodesChange}
                onEdgesChange={onEdgesChange}
                nodeTypes={nodeTypes}
                fitView
                attributionPosition="bottom-right"
                minZoom={0.1}
            >
                <Controls showInteractive={false} />
                <Background color="#ffffff" gap={20} />

                {/* Custom Controls Panel */}
                <Panel position="top-right" className="flex items-center gap-2">
                    <div className="bg-white/90 backdrop-blur shadow-sm border rounded-md px-3 py-1.5 flex items-center gap-2">
                        <Label htmlFor="toggle-employees" className="text-xs font-medium text-slate-600 cursor-pointer">
                            Mostrar Empleados
                        </Label>
                        <Switch
                            id="toggle-employees"
                            checked={showEmployees}
                            onCheckedChange={setShowEmployees}
                            className="scale-75"
                        />
                    </div>
                    <DownloadButton departmentId={departmentId} showEmployees={showEmployees} />
                </Panel>
            </ReactFlow>
        </>
    );
}
</file>

<file path="frontend2/components/departments/pending-evaluations.tsx">
"use client";

import useSWR from "swr";
import { useRouter } from "next/navigation";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Badge } from "@/components/ui/badge";
import { AlertCircle, Calendar, ArrowRight, ClipboardList } from "lucide-react";
import apiClient from "@/lib/api-client";
import { Skeleton } from "@/components/ui/skeleton";

interface Review {
    id: number;
    employee_name: string;
    employee_person_id: number;
    position_name: string;
    period_name: string;
    status: string;
    status_display: string;
    // We can assume photo might be needed but serializer doesn't strictly provide it yet without deep nesting handling or consistent mocked data.
    // For now, we use initials fallback.
}

interface PaginatedResponse<T> {
    count: number;
    next: string | null;
    previous: string | null;
    results: T[];
}

const fetcher = (url: string) => apiClient.get(url).then((res) => res.data);

export function PendingEvaluations({ departmentId }: { departmentId: number }) {
    const router = useRouter();

    // Fetch reviews where scope=given (I am manager) for this department
    // scope=given ensures only managers see their subordinates' reviews
    const { data: response, isLoading } = useSWR<PaginatedResponse<Review>>(
        `/api/performance/reviews/?scope=given&department=${departmentId}`,
        fetcher
    );

    // Filter for drafts only (status=BOR)
    const pendingReviews = response?.results?.filter(r => r.status === 'BOR') || [];

    if (isLoading) {
        return <Skeleton className="h-24 w-full rounded-md" />;
    }

    if (pendingReviews.length === 0) {
        return null;
    }

    return (
        <Card className="border-amber-200 bg-amber-50/50">
            <CardHeader className="pb-3">
                <div className="flex items-center gap-2">
                    <ClipboardList className="h-5 w-5 text-amber-600" />
                    <CardTitle className="text-lg font-semibold text-amber-900">
                        Evaluaciones Pendientes
                    </CardTitle>
                </div>
                <CardDescription className="text-amber-700/80">
                    Tienes {pendingReviews.length} evaluación{pendingReviews.length !== 1 ? 'es' : ''} de desempeño por completar en este departamento.
                </CardDescription>
            </CardHeader>
            <CardContent className="grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
                {pendingReviews.map((review) => (
                    <div
                        key={review.id}
                        className="flex flex-col gap-3 p-4 rounded-lg border border-amber-200 bg-white shadow-sm hover:shadow-md transition-shadow"
                    >
                        <div className="flex items-start justify-between">
                            <div className="flex items-center gap-3">
                                <Avatar className="h-10 w-10 border border-amber-100">
                                    <AvatarFallback className="bg-amber-100 text-amber-700 font-medium">
                                        {review.employee_name.charAt(0)}
                                    </AvatarFallback>
                                </Avatar>
                                <div>
                                    <p className="font-medium text-slate-900 line-clamp-1" title={review.employee_name}>
                                        {review.employee_name}
                                    </p>
                                    <p className="text-xs text-slate-500 line-clamp-1" title={review.position_name}>
                                        {review.position_name}
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div className="flex items-center gap-2 text-xs text-slate-500">
                            <Calendar className="h-3 w-3" />
                            <span>{review.period_name}</span>
                        </div>

                        <Button
                            size="sm"
                            className="w-full mt-auto bg-amber-600 hover:bg-amber-700 text-white border-none"
                            onClick={() => router.push(`/performance/${review.id}`)}
                        >
                            Evaluar Ahora
                            <ArrowRight className="ml-2 h-3 w-3" />
                        </Button>
                    </div>
                ))}
            </CardContent>
        </Card>
    );
}
</file>

<file path="frontend2/components/iutirla/ApplicationForm.tsx">
"use client";

import { useState, useEffect } from "react";
import { useForm, Controller } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { z } from "zod";
import { Loader2, Send, Plus, Trash2 } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Alert, AlertDescription, AlertTitle } from "@/components/ui/alert";
import { AlertCircle } from "lucide-react";
import {
    Select,
    SelectContent,
    SelectItem,
    SelectTrigger,
    SelectValue,
} from "@/components/ui/select";

// Schema base
const baseSchema = z.object({
    first_name: z.string().min(2, "El nombre debe tener al menos 2 caracteres"),
    last_name: z.string().min(2, "El apellido debe tener al menos 2 caracteres"),
    email: z.string().email("Email inválido"),
    national_id_type: z.string().min(1, "Selecciona el tipo de documento"),
    national_id: z.string().min(5, "Cédula inválida"),
    phone_area_code: z.string().min(1, "Selecciona el código de área"),
    phone_subscriber: z.string().min(7, "El número debe tener al menos 7 dígitos"),
    cv_file: z
        .any()
        .refine((files) => {
            // Solo validar en el cliente
            if (typeof window === 'undefined') return true;
            return files?.length > 0;
        }, "El CV es obligatorio")
        .refine((files) => {
            // Solo validar en el cliente
            if (typeof window === 'undefined') return true;
            if (!files?.length) return true;
            return files[0]?.type === 'application/pdf';
        }, "El archivo debe ser un PDF"),
    avatar: z
        .any()
        .optional()
        .refine((files) => {
            if (typeof window === 'undefined') return true;
            if (!files?.length) return true;
            return files[0]?.type.startsWith('image/');
        }, "El archivo debe ser una imagen"),
});

// Schema dinámico se construirá en el componente

interface ApplicationFormProps {
    jobId: number;
    askEducation: boolean;
}

export default function ApplicationForm({
    jobId,
    askEducation,
}: ApplicationFormProps) {
    const [isSubmitting, setIsSubmitting] = useState(false);
    const [submitSuccess, setSubmitSuccess] = useState(false);
    const [submitErrors, setSubmitErrors] = useState<string[]>([]);

    // Opciones para selectores
    const [eduOptions, setEduOptions] = useState<{ levels: any[], fields: any[] }>({ levels: [], fields: [] });
    const [phoneCodes, setPhoneCodes] = useState<any[]>([]);

    // Arrays para educación
    const [education, setEducation] = useState<any[]>([]);
    const [educationErrors, setEducationErrors] = useState<Record<number, Record<string, string>>>({});

    // Tipos de documento
    const documentTypes = [
        { value: "V", label: "V - Venezolano" },
        { value: "E", label: "E - Extranjero" },
        { value: "J", label: "J - Jurídico" },
        { value: "G", label: "G - Gubernamental" },
        { value: "P", label: "P - Pasaporte" },
    ];

    // Cargar opciones de educación y códigos de teléfono
    useEffect(() => {
        // Cargar códigos de teléfono (siempre)
        fetch("http://localhost:8000/api/ats/public/phone-codes/")
            .then(res => res.json())
            .then(data => setPhoneCodes(data))
            .catch(err => console.error("Error loading phone codes:", err));

        // Cargar educación (si se requiere)
        if (askEducation) {
            fetch("http://localhost:8000/api/ats/public/education-options/")
                .then(res => res.json())
                .then(data => setEduOptions(data))
                .catch(err => console.error("Error loading education options:", err));
        }
    }, [askEducation]);

    const {
        register,
        handleSubmit,
        formState: { errors },
        reset,
        control,
    } = useForm({
        resolver: zodResolver(baseSchema),
        defaultValues: {
            first_name: "",
            last_name: "",
            email: "",
            national_id_type: "V",
            national_id: "",
            phone_area_code: "",
            phone_subscriber: "",
        },
    });

    const onSubmit = async (data: any) => {
        setIsSubmitting(true);

        try {
            // Limpiar errores previos
            setSubmitErrors([]);

            // Validar campos dinámicos
            const errors: string[] = [];

            // Validar educación si es requerida
            let hasEduErrors = false;
            if (askEducation) {
                if (education.length === 0) {
                    errors.push("Debes agregar al menos un registro de educación.");
                } else {
                    const eduErrors: Record<number, Record<string, string>> = {};

                    education.forEach((edu, index) => {
                        const itemErrors: Record<string, string> = {};

                        // Validaciones
                        if (!edu.school_name) itemErrors.school_name = "La institución es obligatoria";
                        else if (/\d/.test(edu.school_name)) itemErrors.school_name = "No debe contener números";

                        if (!edu.level_name) itemErrors.level_name = "El nivel es obligatorio";

                        if (!edu.field_name) itemErrors.field_name = "El área es obligatoria";
                        else if (/\d/.test(edu.field_name)) itemErrors.field_name = "No debe contener números";

                        if (!edu.start_date) itemErrors.start_date = "La fecha de inicio es obligatoria";

                        if (edu.start_date && edu.end_date) {
                            if (new Date(edu.start_date) > new Date(edu.end_date)) {
                                itemErrors.end_date = "La fecha fin debe ser mayor a la inicio";
                            }
                        }

                        if (Object.keys(itemErrors).length > 0) {
                            eduErrors[index] = itemErrors;
                            hasEduErrors = true;
                        }
                    });

                    setEducationErrors(eduErrors);
                }
            }

            if (errors.length > 0 || hasEduErrors) {
                setSubmitErrors(errors);
                setIsSubmitting(false);
                return;
            }

            // Crear FormData
            const formData = new FormData();
            formData.append("job_posting", jobId.toString());
            formData.append("first_name", data.first_name);
            formData.append("last_name", data.last_name);
            formData.append("email", data.email);
            formData.append("phone_area_code", data.phone_area_code);
            formData.append("phone_subscriber", data.phone_subscriber);
            formData.append("national_id", `${data.national_id_type}-${data.national_id}`);
            formData.append("cv_file", data.cv_file[0]);
            if (data.avatar && data.avatar.length > 0) {
                formData.append("avatar", data.avatar[0]);
            }

            // Agregar educación si aplica
            if (askEducation && education.length > 0) {
                formData.append("education", JSON.stringify(education));
            }

            const response = await fetch("http://localhost:8000/api/ats/public/apply/", {
                method: "POST",
                body: formData,
            });

            if (!response.ok) {
                const errorData = await response.json();

                // Parsear errores del backend
                let errorMessage = "Error al enviar la postulación";

                if (errorData) {
                    // Si hay errores de validación de campos específicos
                    const errors = [];
                    for (const [field, messages] of Object.entries(errorData)) {
                        if (Array.isArray(messages)) {
                            errors.push(...messages);
                        } else if (typeof messages === 'string') {
                            errors.push(messages);
                        }
                    }

                    if (errors.length > 0) {
                        setSubmitErrors(errors);
                        setIsSubmitting(false);
                        return;
                    } else if (errorData.error) {
                        errorMessage = errorData.error;
                    }
                }

                throw new Error(errorMessage);
            }

            setSubmitSuccess(true);
            reset();
            setEducation([]);
        } catch (error: any) {
            console.error("Error submitting application:", error);
            setSubmitErrors([error.message || "Error al enviar la postulación"]);
        } finally {
            setIsSubmitting(false);
        }
    };

    if (submitSuccess) {
        return (
            <div className="rounded-xl bg-white p-8 shadow-lg">
                <div className="text-center">
                    <div className="mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-green-100">
                        <Send className="h-8 w-8 text-green-600" />
                    </div>
                    <h3 className="mb-2 text-xl font-bold text-slate-900">¡Postulación Enviada!</h3>
                    <p className="text-slate-600">
                        Hemos recibido tu aplicación. Te contactaremos pronto.
                    </p>
                    <Button
                        variant="outline"
                        className="mt-6"
                        onClick={() => setSubmitSuccess(false)}
                    >
                        Enviar otra postulación
                    </Button>
                </div>
            </div>
        );
    }

    return (
        <div className="rounded-xl bg-white p-8 shadow-lg">
            <form onSubmit={handleSubmit(onSubmit)} className="space-y-6">
                {/* Error Messages */}
                {submitErrors.length > 0 && (
                    <Alert variant="destructive">
                        <AlertCircle className="h-4 w-4" />
                        <AlertTitle>Por favor corrige los siguientes errores</AlertTitle>
                        <AlertDescription>
                            <ul className="mt-2 list-disc list-inside space-y-1">
                                {submitErrors.map((error, index) => (
                                    <li key={index}>
                                        {error}
                                    </li>
                                ))}
                            </ul>
                        </AlertDescription>
                    </Alert>
                )}
                {/* Información Personal */}
                <div className="space-y-4">
                    <h3 className="font-semibold text-slate-900">Información Personal</h3>

                    <div className="grid gap-4 md:grid-cols-2">
                        <div>
                            <Label htmlFor="first_name">Nombre *</Label>
                            <Input id="first_name" {...register("first_name")} />
                            {errors.first_name && (
                                <p className="mt-1 text-sm text-red-600">{errors.first_name.message as string}</p>
                            )}
                        </div>

                        <div>
                            <Label htmlFor="last_name">Apellido *</Label>
                            <Input id="last_name" {...register("last_name")} />
                            {errors.last_name && (
                                <p className="mt-1 text-sm text-red-600">{errors.last_name.message as string}</p>
                            )}
                        </div>
                    </div>

                    <div className="grid gap-4 md:grid-cols-2">
                        <div>
                            <Label htmlFor="email">Email *</Label>
                            <Input id="email" type="email" {...register("email")} />
                            {errors.email && (
                                <p className="mt-1 text-sm text-red-600">{errors.email.message as string}</p>
                            )}
                        </div>

                        <div>
                            <Label htmlFor="phone_area_code">Teléfono *</Label>
                            <div className="grid grid-cols-5 gap-2">
                                <div className="col-span-2">
                                    <Controller
                                        name="phone_area_code"
                                        control={control}
                                        render={({ field }) => (
                                            <Select onValueChange={field.onChange} value={field.value}>
                                                <SelectTrigger>
                                                    <SelectValue placeholder="Código" />
                                                </SelectTrigger>
                                                <SelectContent>
                                                    {phoneCodes.map((code) => (
                                                        <SelectItem key={code.id} value={code.id.toString()}>
                                                            {code.code}
                                                        </SelectItem>
                                                    ))}
                                                </SelectContent>
                                            </Select>
                                        )}
                                    />
                                    {errors.phone_area_code && (
                                        <p className="mt-1 text-sm text-red-600">{errors.phone_area_code.message as string}</p>
                                    )}
                                </div>
                                <div className="col-span-3">
                                    <Input
                                        id="phone_subscriber"
                                        placeholder="1234567"
                                        {...register("phone_subscriber")}
                                    />
                                    {errors.phone_subscriber && (
                                        <p className="mt-1 text-sm text-red-600">{errors.phone_subscriber.message as string}</p>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-4 gap-2">
                        <div>
                            <Label htmlFor="national_id_type">Tipo *</Label>
                            <Controller
                                name="national_id_type"
                                control={control}
                                render={({ field }) => (
                                    <Select onValueChange={field.onChange} value={field.value}>
                                        <SelectTrigger>
                                            <SelectValue placeholder="Tipo" />
                                        </SelectTrigger>
                                        <SelectContent>
                                            {documentTypes.map((type) => (
                                                <SelectItem key={type.value} value={type.value}>
                                                    {type.label}
                                                </SelectItem>
                                            ))}
                                        </SelectContent>
                                    </Select>
                                )}
                            />
                            {errors.national_id_type && (
                                <p className="mt-1 text-sm text-red-600">{errors.national_id_type.message as string}</p>
                            )}
                        </div>
                        <div className="col-span-3">
                            <Label htmlFor="national_id">Número de Cédula *</Label>
                            <Input id="national_id" placeholder="12345678" {...register("national_id")} />
                            {errors.national_id && (
                                <p className="mt-1 text-sm text-red-600">{errors.national_id.message as string}</p>
                            )}
                        </div>
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <Label htmlFor="avatar">Foto de Perfil (Opcional)</Label>
                            <Input
                                id="avatar"
                                type="file"
                                accept="image/*"
                                {...register("avatar")}
                                className="cursor-pointer"
                            />
                            {errors.avatar && (
                                <p className="mt-1 text-sm text-red-600">{errors.avatar.message as string}</p>
                            )}
                        </div>
                        <div>
                            <Label htmlFor="cv_file">Currículum (PDF) *</Label>
                            <Input
                                id="cv_file"
                                type="file"
                                accept=".pdf"
                                {...register("cv_file")}
                                className="cursor-pointer"
                            />
                            {errors.cv_file && (
                                <p className="mt-1 text-sm text-red-600">{errors.cv_file.message as string}</p>
                            )}
                        </div>
                    </div>
                </div>

                {/* Educación (si se requiere) */}
                {askEducation && (
                    <div className="space-y-4 border-t border-slate-200 pt-6">
                        <div className="flex items-center justify-between">
                            <h3 className="font-semibold text-slate-900">Educación *</h3>
                            <Button
                                type="button"
                                variant="outline"
                                size="sm"
                                onClick={() => {
                                    const newEdu = {
                                        school_name: "",
                                        level_name: "",
                                        field_name: "",
                                        start_date: "",
                                        end_date: "",
                                    };
                                    setEducation([...education, newEdu]);
                                }}
                            >
                                <Plus className="mr-2 h-4 w-4" />
                                Agregar
                            </Button>
                        </div>

                        {education.map((edu, index) => (
                            <div key={index} className="rounded-lg border border-slate-200 p-4">
                                <div className="mb-3 flex items-center justify-between">
                                    <span className="text-sm font-medium">Educación {index + 1}</span>
                                    <Button
                                        type="button"
                                        variant="ghost"
                                        size="sm"
                                        onClick={() => {
                                            setEducation(education.filter((_, i) => i !== index));
                                        }}
                                    >
                                        <Trash2 className="h-4 w-4 text-red-600" />
                                    </Button>
                                </div>
                                <div className="space-y-3">
                                    <div className="space-y-1">
                                        <Input
                                            placeholder="Institución"
                                            value={edu.school_name}
                                            onChange={(e) => {
                                                const newEdu = [...education];
                                                newEdu[index].school_name = e.target.value;
                                                setEducation(newEdu);
                                            }}
                                            className={educationErrors[index]?.school_name ? "border-red-500" : ""}
                                        />
                                        {educationErrors[index]?.school_name && (
                                            <p className="text-xs text-red-500">{educationErrors[index].school_name}</p>
                                        )}
                                    </div>

                                    <div className="grid gap-4 md:grid-cols-2">
                                        <div className="space-y-1">
                                            <Select
                                                value={edu.level_name}
                                                onValueChange={(value) => {
                                                    const newEdu = [...education];
                                                    newEdu[index].level_name = value;
                                                    setEducation(newEdu);
                                                }}
                                            >
                                                <SelectTrigger className={educationErrors[index]?.level_name ? "border-red-500" : ""}>
                                                    <SelectValue placeholder="Nivel Académico" />
                                                </SelectTrigger>
                                                <SelectContent>
                                                    {eduOptions.levels.map((level) => (
                                                        <SelectItem key={level.id} value={level.name}>
                                                            {level.name}
                                                        </SelectItem>
                                                    ))}
                                                </SelectContent>
                                            </Select>
                                            {educationErrors[index]?.level_name && (
                                                <p className="text-xs text-red-500">{educationErrors[index].level_name}</p>
                                            )}
                                        </div>

                                        <div className="space-y-1">
                                            <Select
                                                value={edu.field_name}
                                                onValueChange={(value) => {
                                                    const newEdu = [...education];
                                                    newEdu[index].field_name = value;
                                                    setEducation(newEdu);
                                                }}
                                            >
                                                <SelectTrigger className={educationErrors[index]?.field_name ? "border-red-500" : ""}>
                                                    <SelectValue placeholder="Área de Estudio" />
                                                </SelectTrigger>
                                                <SelectContent>
                                                    {eduOptions.fields.map((field) => (
                                                        <SelectItem key={field.id} value={field.name}>
                                                            {field.name}
                                                        </SelectItem>
                                                    ))}
                                                </SelectContent>
                                            </Select>
                                            {educationErrors[index]?.field_name && (
                                                <p className="text-xs text-red-500">{educationErrors[index].field_name}</p>
                                            )}
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-2 gap-2">
                                        <div className="space-y-1">
                                            <Input
                                                type="date"
                                                placeholder="Inicio"
                                                value={edu.start_date}
                                                onChange={(e) => {
                                                    const newEdu = [...education];
                                                    newEdu[index].start_date = e.target.value;
                                                    setEducation(newEdu);
                                                }}
                                                className={educationErrors[index]?.start_date ? "border-red-500" : ""}
                                            />
                                            {educationErrors[index]?.start_date && (
                                                <p className="text-xs text-red-500">{educationErrors[index].start_date}</p>
                                            )}
                                        </div>
                                        <div className="space-y-1">
                                            <Input
                                                type="date"
                                                placeholder="Fin (opcional)"
                                                value={edu.end_date}
                                                onChange={(e) => {
                                                    const newEdu = [...education];
                                                    newEdu[index].end_date = e.target.value;
                                                    setEducation(newEdu);
                                                }}
                                                className={educationErrors[index]?.end_date ? "border-red-500" : ""}
                                            />
                                            {educationErrors[index]?.end_date && (
                                                <p className="text-xs text-red-500">{educationErrors[index].end_date}</p>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ))}

                        {education.length === 0 && (
                            <p className="text-sm text-slate-500">
                                Haz clic en "Agregar" para incluir tu información educativa
                            </p>
                        )}
                    </div>
                )}





                {/* Submit Button */}
                <Button
                    type="submit"
                    className="w-full"
                    size="lg"
                    disabled={isSubmitting}
                >
                    {isSubmitting ? (
                        <>
                            <Loader2 className="mr-2 h-5 w-5 animate-spin" />
                            Enviando...
                        </>
                    ) : (
                        <>
                            <Send className="mr-2 h-5 w-5" />
                            Enviar Postulación
                        </>
                    )}
                </Button>
            </form>
        </div>
    );
}
</file>

<file path="frontend2/components/iutirla/JobCard.tsx">
import Link from "next/link";
import { MapPin, DollarSign, Briefcase, Calendar, ArrowRight } from "lucide-react";

interface JobCardProps {
    id: number;
    title: string;
    departmentName: string;
    location?: string;
    salaryRange?: string;
    positionTitle?: string;
    publishedDate: string;
    closingDate?: string;
}

export default function JobCard({
    id,
    title,
    departmentName,
    location,
    salaryRange,
    positionTitle,
    publishedDate,
    closingDate,
}: JobCardProps) {
    const formattedPublished = new Date(publishedDate).toLocaleDateString("es-VE", {
        day: "numeric",
        month: "short",
        year: "numeric",
    });

    const formattedClosing = closingDate
        ? new Date(closingDate).toLocaleDateString("es-VE", {
            day: "numeric",
            month: "short",
            year: "numeric",
        })
        : null;

    return (
        <Link href={`/portal/jobs/${id}`}>
            <div className="group h-full rounded-xl border border-slate-200 bg-white p-6 shadow-md transition-all hover:-translate-y-1 hover:shadow-xl">
                <div className="mb-4">
                    <h3 className="mb-2 text-xl font-bold text-slate-900 transition-colors group-hover:text-brand-primary">
                        {title}
                    </h3>
                    <div className="flex items-center gap-2 text-sm text-slate-600">
                        <Briefcase className="h-4 w-4" />
                        <span>{departmentName}</span>
                        {positionTitle && (
                            <>
                                <span className="text-slate-400">•</span>
                                <span>{positionTitle}</span>
                            </>
                        )}
                    </div>
                </div>

                <div className="mb-4 space-y-2">
                    {location && (
                        <div className="flex items-center gap-2 text-sm text-slate-600">
                            <MapPin className="h-4 w-4 text-brand-primary" />
                            <span>{location}</span>
                        </div>
                    )}
                    {salaryRange && (
                        <div className="flex items-center gap-2 text-sm text-slate-600">
                            <DollarSign className="h-4 w-4 text-green-600" />
                            <span>{salaryRange}</span>
                        </div>
                    )}
                </div>

                <div className="mb-4 flex items-center justify-between border-t border-slate-100 pt-4 text-xs text-slate-500">
                    <div className="flex items-center gap-1">
                        <Calendar className="h-3 w-3" />
                        <span>Publicado: {formattedPublished}</span>
                    </div>
                    {formattedClosing && (
                        <div className="flex items-center gap-1">
                            <span>Cierra: {formattedClosing}</span>
                        </div>
                    )}
                </div>

                <div className="flex items-center gap-2 font-semibold text-brand-primary transition-all group-hover:gap-3">
                    Ver detalles
                    <ArrowRight className="h-4 w-4" />
                </div>
            </div>
        </Link>
    );
}
</file>

<file path="frontend2/components/iutirla/PublicFooter.tsx">
import { Building2, Mail, MapPin, Phone } from "lucide-react";
import Link from "next/link";

export default function PublicFooter() {
    return (
        <footer className="border-t border-slate-200 bg-slate-900 text-slate-300">
            <div className="container mx-auto px-4 py-12">
                <div className="grid gap-8 md:grid-cols-4">
                    {/* Logo y descripción */}
                    <div className="md:col-span-2">
                        <div className="mb-4 flex items-center gap-2">
                            <Building2 className="h-8 w-8 text-blue-400" />
                            <span className="text-xl font-bold text-white">IUTIRLA</span>
                        </div>
                        <p className="mb-4 text-sm text-slate-400">
                            Instituto Universitario de Tecnología Industrial Rodolfo Loero Arismendi.
                            Formando profesionales de excelencia desde 1974.
                        </p>
                    </div>

                    {/* Quick Links */}
                    <div>
                        <h3 className="mb-4 font-semibold text-slate-900">Enlaces Rápidos</h3>
                        <ul className="space-y-2 text-sm text-slate-600">
                            <li>
                                <Link href="/portal" className="hover:text-blue-600">
                                    Inicio
                                </Link>
                            </li>
                            <li>
                                <Link href="/portal/jobs" className="hover:text-blue-600">
                                    Vacantes Disponibles
                                </Link>
                            </li>
                            <li>
                                <Link href="#" className="hover:text-blue-600">
                                    Sobre Nosotros
                                </Link>
                            </li>
                            <li>
                                <Link href="#" className="hover:text-blue-600">
                                    Beneficios
                                </Link>
                            </li>
                        </ul>
                    </div>
                    {/* Contacto */}
                    <div>
                        <h3 className="mb-4 font-semibold text-white">Contacto</h3>
                        <ul className="space-y-3 text-sm">
                            <li className="flex items-start gap-2">
                                <MapPin className="h-4 w-4 flex-shrink-0 text-blue-400" />
                                <span>Caracas, Venezuela</span>
                            </li>
                            <li className="flex items-center gap-2">
                                <Phone className="h-4 w-4 text-blue-400" />
                                <span>+58 123-456-7890</span>
                            </li>
                            <li className="flex items-center gap-2">
                                <Mail className="h-4 w-4 text-blue-400" />
                                <span>rrhh@iutirla.edu.ve</span>
                            </li>
                        </ul>
                    </div>
                </div>

                <div className="mt-8 border-t border-slate-800 pt-8 text-center text-sm text-slate-500">
                    <p>&copy; {new Date().getFullYear()} IUTIRLA. Todos los derechos reservados.</p>
                </div>
            </div>
        </footer>
    );
}
</file>

<file path="frontend2/components/iutirla/PublicNavbar.tsx">
"use client";

import Link from "next/link";
import { Building2, Facebook, Instagram, Linkedin } from "lucide-react";

export default function PublicNavbar() {
    return (
        <nav className="sticky top-0 z-50 border-b border-slate-200 bg-white/80 backdrop-blur-lg">
            <div className="container mx-auto px-4">
                <div className="flex h-16 items-center justify-between">
                    <Link href="/portal" className="flex items-center gap-2">
                        <div className="flex h-10 w-10 items-center justify-center rounded-lg bg-brand-primary text-white">
                            <span className="text-xl font-bold">I</span>
                        </div>
                        <span className="text-xl font-bold text-slate-900">IUTIRLA</span>
                    </Link>

                    <div className="hidden md:flex md:items-center md:gap-8">
                        <Link href="/portal" className="text-sm font-medium text-slate-600 hover:text-brand-primary">
                            Inicio
                        </Link>
                        <Link href="/portal/jobs" className="text-sm font-medium text-slate-600 hover:text-brand-primary">
                            Vacantes
                        </Link>
                        <Link href="#" className="text-sm font-medium text-slate-600 hover:text-brand-primary">
                            Nosotros
                        </Link>
                        <Link href="#" className="text-sm font-medium text-slate-600 hover:text-brand-primary">
                            Beneficios
                        </Link>
                    </div>

                    <div className="flex items-center gap-4">
                        <Link
                            href="/login"
                            className="rounded-full px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-100"
                        >
                            Soy Empleado
                        </Link>
                        <Link
                            href="/portal/jobs"
                            className="rounded-full bg-brand-primary px-4 py-2 text-sm font-medium text-white hover:bg-brand-primary/90"
                        >
                            Ver Vacantes
                        </Link>
                    </div>
                </div>
            </div>
        </nav>
    );
}
</file>

<file path="frontend2/components/performance/competency-rating.tsx">
"use client";

import { useState } from "react";
import { Star } from "lucide-react";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { ReviewDetail } from "@/types/performance";
import { cn } from "@/lib/utils";

interface CompetencyRatingProps {
    detail: ReviewDetail;
    onChange: (detail: ReviewDetail) => void;
    disabled?: boolean;
}

export function CompetencyRating({ detail, onChange, disabled = false }: CompetencyRatingProps) {
    const [hoveredScore, setHoveredScore] = useState<number | null>(null);

    const handleScoreChange = (score: number) => {
        if (!disabled) {
            onChange({ ...detail, score });
        }
    };

    const handleCommentChange = (comment: string) => {
        if (!disabled) {
            onChange({ ...detail, comment });
        }
    };

    return (
        <div className="border rounded-lg p-4 space-y-4 hover:bg-accent/50 transition-colors">
            {/* Competency Header */}
            <div>
                <h4 className="font-semibold text-base">{detail.competency_name}</h4>
                <p className="text-sm text-muted-foreground mt-1">{detail.competency_description}</p>
            </div>

            {/* Star Rating */}
            <div className="space-y-2">
                <Label className="text-sm font-medium">Calificación *</Label>
                <div className="flex items-center gap-2">
                    {[1, 2, 3, 4, 5].map((score) => {
                        const isActive = score <= (hoveredScore ?? detail.score);
                        return (
                            <button
                                key={score}
                                type="button"
                                disabled={disabled}
                                onMouseEnter={() => !disabled && setHoveredScore(score)}
                                onMouseLeave={() => !disabled && setHoveredScore(null)}
                                onClick={() => handleScoreChange(score)}
                                className={cn(
                                    "transition-all duration-150 focus:outline-none focus:ring-2 focus:ring-brand-primary focus:ring-offset-2 rounded",
                                    disabled && "cursor-not-allowed opacity-50"
                                )}
                            >
                                <Star
                                    className={cn(
                                        "w-8 h-8 transition-all",
                                        isActive
                                            ? "fill-yellow-400 text-yellow-400"
                                            : "text-gray-300"
                                    )}
                                />
                            </button>
                        );
                    })}
                    <span className="ml-2 text-sm font-medium text-muted-foreground">
                        {detail.score > 0 ? `${detail.score}/5` : "Sin calificar"}
                    </span>
                </div>
            </div>

            {/* Comment */}
            <div className="space-y-2">
                <Label htmlFor={`comment-${detail.competency}`} className="text-sm font-medium">
                    Observaciones (Opcional)
                </Label>
                <Textarea
                    id={`comment-${detail.competency}`}
                    value={detail.comment || ""}
                    onChange={(e) => handleCommentChange(e.target.value)}
                    placeholder="Agrega comentarios específicos sobre esta competencia..."
                    rows={2}
                    disabled={disabled}
                    className="resize-none"
                />
            </div>
        </div>
    );
}
</file>

<file path="frontend2/components/performance/performance-evaluation-form.tsx">
"use client";

import { useState, useEffect, useCallback, useRef } from 'react';
import { useRouter } from 'next/navigation';
import { useAuth } from "@/context/auth-context";
import apiClient from "@/lib/api-client";
import { toast } from "sonner";
import { cn } from '@/lib/utils';
import {
    Loader2, Save, Send, CheckCircle2,
    Star, MessageSquare, ArrowLeft, Briefcase, User
} from "lucide-react";

// UI Components
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Textarea } from "@/components/ui/textarea";
import { Badge } from "@/components/ui/badge";
import { Separator } from "@/components/ui/separator";
import { Alert, AlertDescription, AlertTitle } from "@/components/ui/alert";
import { Avatar, AvatarFallback } from "@/components/ui/avatar";
import { Label } from '@/components/ui/label';
import { PerformanceRadarChart } from "@/components/performance/performance-radar-chart";

// Types
interface ReviewDetail {
    id: number;
    competency: number;
    competency_name: string;
    competency_description: string;
    competency_category: string;
    competency_category_display: string;
    score: number;
    comment: string;
}

interface PerformanceReview {
    id: number;
    employee_name: string;
    position_name: string;
    department_name: string;
    evaluator_name: string;
    period_name: string;
    status: 'BOR' | 'ENV' | 'ACE';
    status_display: string;
    final_score: number | null;
    feedback_manager: string;
    feedback_employee: string;
    details: ReviewDetail[];
    employee_person_id: number;
    evaluator_id: number;
}

interface RadarDataPoint {
    category: string;
    score: number;
    fullMark: number;
}

export function PerformanceEvaluationForm({ reviewId }: { reviewId: number }) {
    const { user } = useAuth();
    const router = useRouter();

    const [review, setReview] = useState<PerformanceReview | null>(null);
    const [loading, setLoading] = useState(true);
    const [isSubmitting, setIsSubmitting] = useState(false);

    // Local Editing State
    const [localDetails, setLocalDetails] = useState<ReviewDetail[]>([]);
    const [managerFeedback, setManagerFeedback] = useState("");
    const [employeeFeedback, setEmployeeFeedback] = useState("");

    // UI Logic for Action Bar Alignment
    const containerRef = useRef<HTMLDivElement>(null);
    const [barStyle, setBarStyle] = useState<{ left: number, width: number } | null>(null);

    useEffect(() => {
        const updatePosition = () => {
            if (containerRef.current) {
                const rect = containerRef.current.getBoundingClientRect();
                setBarStyle({
                    left: rect.left,
                    width: rect.width
                });
            }
        };

        // Initial update
        updatePosition();

        // Update on resize/scroll
        window.addEventListener('resize', updatePosition);
        window.addEventListener('scroll', updatePosition);

        // Also use ResizeObserver for container changes
        const observer = new ResizeObserver(updatePosition);
        if (containerRef.current) {
            observer.observe(containerRef.current);
        }

        return () => {
            window.removeEventListener('resize', updatePosition);
            window.removeEventListener('scroll', updatePosition);
            observer.disconnect();
        };
    }, []);

    // Use currentPersonId from auth context
    // Assuming user object has a person property with id
    const currentPersonId = user?.person?.id;

    // Derived Roles
    const isEvaluator = currentPersonId === review?.evaluator_id;
    const isEmployee = currentPersonId === review?.employee_person_id;

    // Process States
    const isEditingAllowed = isEvaluator && (review?.status === 'BOR');
    const isSigningAllowed = isEmployee && (review?.status === 'ENV');
    const isFinalized = review?.status === 'ACE';
    const showRadarChart = review?.status !== 'BOR';

    const fetchData = useCallback(async () => {
        try {
            const { data } = await apiClient.get(`/api/performance/reviews/${reviewId}/`);
            setReview(data);
            setLocalDetails(data.details);
            setManagerFeedback(data.feedback_manager || "");
            setEmployeeFeedback(data.feedback_employee || "");
        } catch (error) {
            console.error(error);
            toast.error("No se pudo cargar la evaluación.");
            setReview(null);
        } finally {
            setLoading(false);
        }
    }, [reviewId]);

    useEffect(() => {
        if (currentPersonId) fetchData();
    }, [currentPersonId, fetchData]);

    // Calculate Radar Data
    const getRadarData = (): RadarDataPoint[] => {
        if (!localDetails.length) return [];

        const categoryMap = new Map<string, { total: number; count: number; name: string }>();

        localDetails.forEach(d => {
            const cat = d.competency_category || "SIN";
            const name = d.competency_category_display || "General";
            if (!categoryMap.has(cat)) {
                categoryMap.set(cat, { total: 0, count: 0, name });
            }
            const current = categoryMap.get(cat)!;
            current.total += d.score;
            current.count += 1;
        });

        return Array.from(categoryMap.values()).map(c => ({
            category: c.name,
            score: c.count ? c.total / c.count : 0,
            fullMark: 5
        }));
    };

    const handleScoreChange = (detailId: number, newScore: number) => {
        if (!isEditingAllowed) return;
        setLocalDetails(prev => prev.map(d =>
            d.id === detailId ? { ...d, score: newScore } : d
        ));
    };

    const handleCommentChange = (detailId: number, comment: string) => {
        if (!isEditingAllowed) return;
        setLocalDetails(prev => prev.map(d =>
            d.id === detailId ? { ...d, comment } : d
        ));
    };

    const saveProgress = async (action: 'draft' | 'submit' | 'accept') => {
        if (!review || isSubmitting) return;

        setIsSubmitting(true);
        try {
            // 1. Save Details (Only Evaluator)
            if (isEvaluator) {
                const updatePromises = localDetails.map(detail =>
                    apiClient.patch(`/api/performance/details/${detail.id}/`, {
                        score: detail.score,
                        comment: detail.comment
                    })
                );
                await Promise.all(updatePromises);
            }

            // 2. Save Header
            const payload: any = {};
            if (action === 'draft') {
                payload.feedback_manager = managerFeedback;
            } else if (action === 'submit') {
                payload.feedback_manager = managerFeedback;
                payload.status = 'ENV';
            } else if (action === 'accept') {
                payload.feedback_employee = employeeFeedback;
                payload.status = 'ACE';
            }

            await apiClient.patch(`/api/performance/reviews/${reviewId}/`, payload);

            toast.success(
                action === 'accept' ? "Resultados firmados." :
                    action === 'submit' ? "Evaluación enviada." : "Borrador guardado."
            );

            if (action === 'submit' || action === 'accept') {
                router.push('/performance'); // Redirect to main list
            } else {
                window.location.reload();
            }

        } catch (error) {
            toast.error("Error al guardar la evaluación.");
        } finally {
            setIsSubmitting(false);
        }
    };

    if (loading) return <div className="flex h-[50vh] justify-center items-center"><Loader2 className="h-8 w-8 animate-spin text-muted-foreground" /></div>;
    if (!review) return <div className="p-8 text-center text-muted-foreground">No se pudo encontrar la evaluación.</div>;

    const roleLabel = isEvaluator ? "Supervisor" : (isEmployee ? "Evaluado" : "Observador");
    const statusColor = review.status === 'BOR' ? "bg-yellow-500" : review.status === 'ENV' ? "bg-blue-500" : "bg-green-600";
    const currentScore = localDetails.filter(d => d.score > 0).length;

    // Validation: All competencies must have score AND comment
    const allCompetenciesComplete = localDetails.every(d => d.score > 0 && d.comment?.trim().length > 0);
    const canSubmit = allCompetenciesComplete;

    return (
        <div ref={containerRef} className=" mx-auto space-y-8 pb-20">
            <Button variant="ghost" size="sm" onClick={() => router.back()} className="mb-2">
                <ArrowLeft className="mr-2 h-4 w-4" /> Volver
            </Button>

            {/* HEADER */}
            <Card className="overflow-hidden border-none shadow-md bg-white pt-0">
                <div className={cn("h-2 w-full bg-brand-primary")} />
                <CardHeader>
                    <div className="flex flex-col md:flex-row justify-between items-start gap-4">
                        <div className="space-y-1">
                            <CardTitle className="text-2xl font-bold">{review.period_name}</CardTitle>
                            <CardDescription className="text-base">
                                {review.position_name.split(' - ')[0]} • {review.department_name}
                            </CardDescription>
                            <Badge className={cn("mt-2", statusColor)}>{review.status_display}</Badge>
                        </div>
                        <div className="text-right bg-slate-50 p-3 rounded-lg border">
                            <p className="text-xs font-semibold uppercase text-muted-foreground mb-1">Nota Final</p>
                            <p className="text-3xl font-bold text-slate-800">
                                {review.final_score ? Number(review.final_score).toFixed(2) : '--'}
                                <span className="text-base font-normal text-muted-foreground ml-1">/ 5</span>
                            </p>
                        </div>
                    </div>

                    <Separator className="my-6" />

                    <div className="grid md:grid-cols-2 gap-6">
                        {/* Employee */}
                        <div className="flex items-center gap-4 p-3 rounded-lg border bg-slate-50/50">
                            <Avatar className="h-12 w-12 border-2 border-white shadow-sm">
                                <AvatarFallback className="bg-indigo-100 text-indigo-700 font-bold">
                                    {review.employee_name.charAt(0)}
                                </AvatarFallback>
                            </Avatar>
                            <div>
                                <p className="text-xs font-medium text-muted-foreground uppercase tracking-wide">Evaluado</p>
                                <p className="font-semibold text-lg leading-tight">{review.employee_name}</p>
                            </div>
                        </div>

                        {/* Evaluator */}
                        <div className="flex items-center gap-4 p-3 rounded-lg border bg-slate-50/50">
                            <Avatar className="h-12 w-12 border-2 border-white shadow-sm">
                                <AvatarFallback className="bg-slate-100 text-slate-700 font-bold">
                                    {review.evaluator_name.charAt(0)}
                                </AvatarFallback>
                            </Avatar>
                            <div>
                                <p className="text-xs font-medium text-muted-foreground uppercase tracking-wide">Evaluador</p>
                                <p className="font-semibold text-lg leading-tight">{review.evaluator_name}</p>
                            </div>
                        </div>
                    </div>
                </CardHeader>
            </Card>

            {/* RADAR CHART (Only if completed/submitted) */}
            {showRadarChart && (
                <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
                    <PerformanceRadarChart
                        data={getRadarData()}
                        title="Resultados por Categoría"
                        description="Visualización del desempeño en las dimensiones evaluadas."
                    />
                </div>
            )}

            {/* COMPETENCIES LIST */}
            <div className="space-y-6">
                <div className="flex items-center gap-2 pb-2 border-b">
                    <Star className="h-5 w-5 text-amber-500 fill-amber-500" />
                    <h3 className="text-xl font-semibold text-slate-800">Competencias</h3>
                </div>

                {localDetails.map((detail) => (
                    <Card key={detail.id} className="overflow-hidden border shadow-sm hover:shadow-md transition-shadow p-0">
                        <div className="bg-brand-primary p-4 border-b border-white/10">
                            <div className="flex justify-between items-start gap-4">
                                <div>
                                    <div className="flex items-center gap-2 mb-1">
                                        <h4 className="font-bold text-base text-white">{detail.competency_name}</h4>
                                        <Badge variant="secondary" className="text-xs font-normal bg-white text-brand-primary hover:bg-white/90">
                                            {detail.competency_category_display || "General"}
                                        </Badge>
                                    </div>
                                    <p className="text-sm text-white/90 leading-relaxed">{detail.competency_description}</p>
                                </div>
                                {isFinalized && detail.score > 0 && (
                                    <Badge
                                        variant="secondary"
                                        className={cn(
                                            "text-sm px-3 py-1 bg-white hover:bg-white/90 shadow-sm font-bold border-0",
                                            detail.score >= 4 ? "text-green-600" :
                                                detail.score >= 3 ? "text-amber-600" :
                                                    "text-red-600"
                                        )}
                                    >
                                        {detail.score} / 5
                                    </Badge>
                                )}
                            </div>
                        </div>

                        <CardContent className="p-5 flex flex-col md:flex-row gap-6">
                            {/* SCORE SELECTION (Interactive) */}
                            <div className="flex-none min-w-fit flex flex-col justify-start gap-3">
                                <span className="text-xs font-bold uppercase text-muted-foreground tracking-wider">Calificación</span>
                                <div className="w-fit">
                                    <div className="flex gap-1.5 mb-1">
                                        {[1, 2, 3, 4, 5].map((star) => (
                                            <button
                                                key={star}
                                                type="button"
                                                disabled={!isEditingAllowed}
                                                onClick={() => handleScoreChange(detail.id, star)}
                                                className={cn(
                                                    "w-10 h-10 text-sm font-bold transition-all rounded-lg border-2 flex items-center justify-center",
                                                    detail.score >= star
                                                        ? "bg-amber-400 border-amber-500 text-white shadow-sm scale-100"
                                                        : "bg-slate-50 border-slate-200 text-slate-300 hover:border-slate-300",
                                                    !isEditingAllowed && detail.score < star && "opacity-30",
                                                    !isEditingAllowed && detail.score >= star && "opacity-100"
                                                )}
                                            >
                                                {star}
                                            </button>
                                        ))}
                                    </div>
                                    <div className="flex justify-between px-1 text-xs text-muted-foreground w-full">
                                        <span>Bajo</span>
                                        <span>Alto</span>
                                    </div>
                                </div>
                            </div>

                            {/* COMMENT */}
                            <div className="flex-1 w-full">
                                <span className="text-xs font-bold uppercase text-muted-foreground mb-2 block tracking-wider">Observación</span>
                                <Textarea
                                    disabled={!isEditingAllowed}
                                    value={detail.comment || ""}
                                    onChange={(e) => handleCommentChange(detail.id, e.target.value)}
                                    placeholder={isEditingAllowed ? "Justifique la calificación con ejemplos..." : "Sin observaciones registradas."}
                                    className={cn(
                                        "resize-none h-24 text-sm transition-colors",
                                        isEditingAllowed ? "bg-white" : "bg-slate-50 text-slate-600 border-transparent resize-none"
                                    )}
                                />
                            </div>
                        </CardContent>
                    </Card>
                ))}
            </div>

            {/* FEEDBACK SECTION */}
            <Card className="border shadow-sm">
                <CardHeader>
                    <CardTitle className="flex items-center gap-2 text-xl">
                        <MessageSquare className="h-5 w-5 text-brand-primary" /> Feedback y Conclusiones
                    </CardTitle>
                </CardHeader>
                <CardContent className="space-y-6">
                    <div className="space-y-2">
                        <Label className="text-base font-semibold text-slate-800">Comentarios del Supervisor</Label>
                        <Textarea
                            disabled={!isEditingAllowed}
                            value={managerFeedback}
                            onChange={(e) => setManagerFeedback(e.target.value)}
                            placeholder="Fortalezas, áreas de mejora y plan de acción..."
                            className="min-h-[120px]"
                        />
                    </div>

                    {(isEmployee || isFinalized || review.status === 'ENV') && (
                        <div className="space-y-2 pt-6 border-t border-dashed">
                            <Label className="text-base font-semibold text-slate-800">Comentarios del Evaluado</Label>
                            <p className="text-xs text-muted-foreground mb-2">Este espacio es para que el evaluado exprese su acuerdo, desacuerdo o comentarios finales.</p>
                            <Textarea
                                disabled={!isSigningAllowed}
                                value={employeeFeedback}
                                onChange={(e) => setEmployeeFeedback(e.target.value)}
                                placeholder="Comentarios sobre su evaluación..."
                                className={cn(
                                    "min-h-[120px]",
                                    isSigningAllowed && "border-indigo-300 bg-indigo-50/20 focus:border-indigo-500"
                                )}
                            />
                        </div>
                    )}
                </CardContent>
            </Card>

            {/* ACTION BAR */}
            {barStyle && (
                <div
                    className="fixed bottom-4 z-50 transition-all duration-75 ease-out"
                    style={{
                        left: `${barStyle.left}px`,
                        width: `${barStyle.width}px`
                    }}
                >
                    <div className="bg-white/95 backdrop-blur-md border rounded-xl p-2 sm:p-3 shadow-lg w-full">
                        <div className="flex flex-col sm:flex-row items-center justify-between gap-3 sm:gap-4">
                            <div className="text-sm text-muted-foreground hidden sm:block">
                                {isEditingAllowed && "Modo Edición: Supervisor"}
                                {isSigningAllowed && "Modo Revisión: Evaluado"}
                                {isFinalized && "Evaluación Finalizada"}
                            </div>

                            <div className="flex flex-wrap items-center justify-end gap-2 sm:gap-3 w-full sm:w-auto ml-auto">
                                {isEvaluator && review.status === 'BOR' && (
                                    <>
                                        <Button variant="outline" onClick={() => saveProgress('draft')} disabled={isSubmitting} className="flex-1 sm:flex-none text-xs sm:text-sm h-9 sm:h-10">
                                            <Save className="mr-2 h-3 w-3 sm:h-4 sm:w-4" /> Borrador
                                        </Button>
                                        <Button
                                            onClick={() => saveProgress('submit')}
                                            disabled={isSubmitting || !canSubmit}
                                            className="bg-brand-primary hover:bg-brand-primary/90 flex-1 sm:flex-none text-xs sm:text-sm h-9 sm:h-10"
                                        >
                                            {isSubmitting ? <Loader2 className="mr-2 h-3 w-3 sm:h-4 sm:w-4 animate-spin" /> : <Send className="mr-2 h-3 w-3 sm:h-4 sm:w-4" />}
                                            Finalizar
                                        </Button>
                                    </>
                                )}

                                {isSigningAllowed && (
                                    <Button onClick={() => saveProgress('accept')} className="bg-green-600 hover:bg-green-700 text-white w-full sm:w-auto" disabled={isSubmitting}>
                                        {isSubmitting ? <Loader2 className="mr-2 h-4 w-4 animate-spin" /> : <CheckCircle2 className="mr-2 h-4 w-4" />}
                                        Firmar y Aceptar
                                    </Button>
                                )}

                                {isFinalized && (
                                    <Alert className="bg-green-50 border-green-200 py-2 px-4 h-10 flex items-center w-full sm:w-auto justify-center">
                                        <CheckCircle2 className="h-4 w-4 text-green-600 mr-2" />
                                        <span className="text-sm font-medium text-green-800">Firmado y Cerrado</span>
                                    </Alert>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}
</file>

<file path="frontend2/components/performance/performance-radar-chart.tsx">
"use client";

import { TrendingUp } from "lucide-react";
import { PolarAngleAxis, PolarGrid, PolarRadiusAxis, Radar, RadarChart } from "recharts";

import {
    Card,
    CardContent,
    CardDescription,
    CardFooter,
    CardHeader,
    CardTitle,
} from "@/components/ui/card";
import {
    ChartConfig,
    ChartContainer,
    ChartTooltip,
    ChartTooltipContent,
} from "@/components/ui/chart";

interface CategoryScore {
    category: string;
    score: number;
    fullMark: number;
}

interface PerformanceRadarChartProps {
    data: CategoryScore[];
    title?: string;
    description?: string;
}

const chartConfig = {
    score: {
        label: "Puntaje",
        color: "var(--brand-primary)",
    },
} satisfies ChartConfig;

export function PerformanceRadarChart({ data, title, description }: PerformanceRadarChartProps) {
    return (
        <Card>
            <CardHeader className="items-center pb-4">
                <CardTitle>{title || "Radar Chart"}</CardTitle>
                <CardDescription>
                    {description || "Visualización del desempeño en las dimensiones evaluadas."}
                </CardDescription>
            </CardHeader>
            <CardContent className="pb-0">
                <ChartContainer
                    config={chartConfig}
                    className="mx-auto aspect-square max-h-[450px] min-h-[300px] w-full"
                >
                    <RadarChart data={data} outerRadius="65%" margin={{ top: 20, right: 80, bottom: 20, left: 80 }}>
                        <ChartTooltip cursor={false} content={<ChartTooltipContent />} />
                        <PolarAngleAxis dataKey="category" tick={{ fontSize: 12 }} />
                        <PolarGrid />
                        <PolarRadiusAxis angle={30} domain={[0, 5]} tickCount={6} tick={false} axisLine={false} />
                        <Radar
                            dataKey="score"
                            fill="var(--color-score)"
                            fillOpacity={0.6}
                        />
                    </RadarChart>
                </ChartContainer>
            </CardContent>
            {/* <CardFooter className="flex-col gap-2 text-sm">
        <div className="flex items-center gap-2 leading-none font-medium">
          Trending up by 5.2% this month <TrendingUp className="h-4 w-4" />
        </div>
        <div className="text-muted-foreground flex items-center gap-2 leading-none">
          January - June 2024
        </div>
      </CardFooter> */}
        </Card>
    );
}
</file>

<file path="frontend2/components/skeletons/dashboard-skeleton.tsx">
import { Skeleton } from "@/components/ui/skeleton";
import { cn } from "@/lib/utils";
import { ChevronRight } from "lucide-react";

export function DashboardSkeleton({ showBreadcrumbs = false, className }: { showBreadcrumbs?: boolean, className?: string }) {
    return (
        <div className={cn("flex-1", className)}>
            {/* Breadcrumb Skeleton */}
            {showBreadcrumbs && (
                <div className="flex items-center gap-2 mb-4">
                    <Skeleton className="h-5 w-16" />
                    <ChevronRight className="h-4 w-4 text-muted-foreground" />
                    <Skeleton className="h-5 w-24" />
                </div>
            )}

            {/* Header Skeleton */}
            <div className="space-y-2 mb-6">
                <Skeleton className="h-9 w-64" />
                <Skeleton className="h-6 w-96" />
            </div>
            <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-4 mb-6">
                {Array.from({ length: 4 }).map((_, i) => (
                    <Skeleton key={i} className="h-32 rounded-xl" />
                ))}
            </div>
            <div className="grid gap-6 grid-cols-1 lg:grid-cols-2">
                <Skeleton className="h-[300px] rounded-xl" />
                <Skeleton className="h-[300px] rounded-xl" />
            </div>
        </div>
    );
}
</file>

<file path="frontend2/components/skeletons/general-catalog-skeleton.tsx">
import { Skeleton } from "@/components/ui/skeleton";

import { cn } from "@/lib/utils";
import { ChevronRight } from "lucide-react";

export function GeneralCatalogSkeleton({ showBreadcrumbs = false, className }: { showBreadcrumbs?: boolean, className?: string }) {
    return (
        <div className={cn("", className)}>
            {/* Breadcrumb Skeleton */}
            {showBreadcrumbs && (
                <div className="flex items-center gap-2 mb-4">
                    <Skeleton className="h-5 w-16" />
                    <ChevronRight className="h-4 w-4 text-muted-foreground" />
                    <Skeleton className="h-5 w-24" />
                    <ChevronRight className="h-4 w-4 text-muted-foreground" />
                    <Skeleton className="h-5 w-32" />
                </div>
            )}

            <div className="flex flex-col gap-4 md:flex-row md:items-center md:justify-between mb-6">
                <div className="space-y-2">
                    <Skeleton className="h-9 w-64" />
                    <Skeleton className="h-6 w-96" />
                </div>
                <Skeleton className="h-10 w-full md:w-72" />
            </div>

            <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                {Array.from({ length: 9 }).map((_, i) => (
                    <Skeleton key={i} className="h-[140px] w-full rounded-xl" />
                ))}
            </div>
        </div>
    );
}
</file>

<file path="frontend2/components/skeletons/specific-catalog-skeleton.tsx">
import { Skeleton } from "@/components/ui/skeleton";
import { TableSkeleton } from "@/components/skeletons/table-skeleton";
import { ChevronRight } from "lucide-react";
import { cn } from "@/lib/utils";

export function SpecificCatalogSkeleton({ showBreadcrumbs = false, className }: { showBreadcrumbs?: boolean, className?: string }) {
    return (
        <div className={cn("space-y-6", className)}>
            {/* Breadcrumb Skeleton */}
            {showBreadcrumbs && (
                <div className="flex items-center gap-2 mb-4">
                    <Skeleton className="h-5 w-16" />
                    <ChevronRight className="h-4 w-4 text-muted-foreground" />
                    <Skeleton className="h-5 w-24" />
                    <ChevronRight className="h-4 w-4 text-muted-foreground" />
                    <Skeleton className="h-5 w-32" />
                </div>
            )}

            <div className="flex items-center justify-between">
                <Skeleton className="h-9 w-48" /> {/* Title */}
                <Skeleton className="h-10 w-24" /> {/* New Button */}
            </div>

            <TableSkeleton columnCount={3} rowCount={5} />
        </div>
    )
}
</file>

<file path="frontend2/components/skeletons/table-skeleton.tsx">
import { Skeleton } from "@/components/ui/skeleton";


interface TableSkeletonProps {
    columnCount: number;
    rowCount?: number;
}

export function TableSkeleton({ columnCount, rowCount = 5, withSearch = true }: TableSkeletonProps & { withSearch?: boolean }) {
    return (
        <div className="space-y-4">
            {withSearch && (
                <div className="flex items-center">
                    <Skeleton className="h-10 w-full max-w-sm" />
                </div>
            )}
            <div className="space-y-3">
                {/* Header */}
                <div className="flex items-center justify-between px-4 py-3 border rounded-md bg-muted/10">
                    {Array.from({ length: columnCount }).map((_, i) => (
                        <Skeleton key={i} className="h-4 w-24" />
                    ))}
                </div>

                {/* Rows */}
                <div className="space-y-2">
                    {Array.from({ length: rowCount }).map((_, i) => (
                        <div key={i} className="flex items-center justify-between px-4 py-3 border rounded-md">
                            {Array.from({ length: columnCount }).map((_, j) => (
                                <Skeleton key={j} className="h-4 w-24" />
                            ))}
                        </div>
                    ))}
                </div>
            </div>
        </div>
    );
}
</file>

<file path="frontend2/components/ui/accordion.tsx">
"use client"

import * as React from "react"
import * as AccordionPrimitive from "@radix-ui/react-accordion"
import { ChevronDownIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Accordion({
  ...props
}: React.ComponentProps<typeof AccordionPrimitive.Root>) {
  return <AccordionPrimitive.Root data-slot="accordion" {...props} />
}

function AccordionItem({
  className,
  ...props
}: React.ComponentProps<typeof AccordionPrimitive.Item>) {
  return (
    <AccordionPrimitive.Item
      data-slot="accordion-item"
      className={cn("border-b last:border-b-0", className)}
      {...props}
    />
  )
}

function AccordionTrigger({
  className,
  children,
  chevronPosition = "right",
  ...props
}: React.ComponentProps<typeof AccordionPrimitive.Trigger> & { chevronPosition?: "left" | "right" }) {
  return (
    <AccordionPrimitive.Header className="flex">
      <AccordionPrimitive.Trigger
        data-slot="accordion-trigger"
        className={cn(
          "focus-visible:border-ring focus-visible:ring-ring/50 flex flex-1 items-center gap-4 rounded-md py-4 text-left text-sm font-medium transition-all outline-none hover:underline focus-visible:ring-[3px] disabled:pointer-events-none disabled:opacity-50 [&[data-state=open]>svg]:rotate-180",
          chevronPosition === "right" ? "justify-between" : "justify-start",
          className
        )}
        {...props}
      >
        {chevronPosition === "left" && (
          <ChevronDownIcon className="text-muted-foreground pointer-events-none size-4 shrink-0 transition-transform duration-200" />
        )}
        {children}
        {chevronPosition === "right" && (
          <ChevronDownIcon className="text-muted-foreground pointer-events-none size-4 shrink-0 transition-transform duration-200" />
        )}
      </AccordionPrimitive.Trigger>
    </AccordionPrimitive.Header>
  )
}

function AccordionContent({
  className,
  children,
  ...props
}: React.ComponentProps<typeof AccordionPrimitive.Content>) {
  return (
    <AccordionPrimitive.Content
      data-slot="accordion-content"
      className="data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down overflow-hidden text-sm"
      {...props}
    >
      <div className={cn("pt-0 pb-4", className)}>{children}</div>
    </AccordionPrimitive.Content>
  )
}

export { Accordion, AccordionItem, AccordionTrigger, AccordionContent }
</file>

<file path="frontend2/components/ui/alert-dialog.tsx">
"use client"

import * as React from "react"
import * as AlertDialogPrimitive from "@radix-ui/react-alert-dialog"

import { cn } from "@/lib/utils"
import { buttonVariants } from "@/components/ui/button"

function AlertDialog({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Root>) {
  return <AlertDialogPrimitive.Root data-slot="alert-dialog" {...props} />
}

function AlertDialogTrigger({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Trigger>) {
  return (
    <AlertDialogPrimitive.Trigger data-slot="alert-dialog-trigger" {...props} />
  )
}

function AlertDialogPortal({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Portal>) {
  return (
    <AlertDialogPrimitive.Portal data-slot="alert-dialog-portal" {...props} />
  )
}

function AlertDialogOverlay({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Overlay>) {
  return (
    <AlertDialogPrimitive.Overlay
      data-slot="alert-dialog-overlay"
      className={cn(
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50",
        className
      )}
      {...props}
    />
  )
}

function AlertDialogContent({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Content>) {
  return (
    <AlertDialogPortal>
      <AlertDialogOverlay />
      <AlertDialogPrimitive.Content
        data-slot="alert-dialog-content"
        className={cn(
          "bg-background data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200 sm:max-w-lg",
          className
        )}
        {...props}
      />
    </AlertDialogPortal>
  )
}

function AlertDialogHeader({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-dialog-header"
      className={cn("flex flex-col gap-2 text-center sm:text-left", className)}
      {...props}
    />
  )
}

function AlertDialogFooter({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-dialog-footer"
      className={cn(
        "flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",
        className
      )}
      {...props}
    />
  )
}

function AlertDialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Title>) {
  return (
    <AlertDialogPrimitive.Title
      data-slot="alert-dialog-title"
      className={cn("text-lg font-semibold", className)}
      {...props}
    />
  )
}

function AlertDialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Description>) {
  return (
    <AlertDialogPrimitive.Description
      data-slot="alert-dialog-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

function AlertDialogAction({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Action>) {
  return (
    <AlertDialogPrimitive.Action
      className={cn(buttonVariants(), className)}
      {...props}
    />
  )
}

function AlertDialogCancel({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Cancel>) {
  return (
    <AlertDialogPrimitive.Cancel
      className={cn(buttonVariants({ variant: "outline" }), className)}
      {...props}
    />
  )
}

export {
  AlertDialog,
  AlertDialogPortal,
  AlertDialogOverlay,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogFooter,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogAction,
  AlertDialogCancel,
}
</file>

<file path="frontend2/components/ui/alert.tsx">
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const alertVariants = cva(
  "relative w-full rounded-lg border px-4 py-3 text-sm grid has-[>svg]:grid-cols-[calc(var(--spacing)*4)_1fr] grid-cols-[0_1fr] has-[>svg]:gap-x-3 gap-y-0.5 items-start [&>svg]:size-4 [&>svg]:translate-y-0.5 [&>svg]:text-current",
  {
    variants: {
      variant: {
        default: "bg-card text-card-foreground",
        destructive:
          "text-destructive bg-card [&>svg]:text-current *:data-[slot=alert-description]:text-destructive/90",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

function Alert({
  className,
  variant,
  ...props
}: React.ComponentProps<"div"> & VariantProps<typeof alertVariants>) {
  return (
    <div
      data-slot="alert"
      role="alert"
      className={cn(alertVariants({ variant }), className)}
      {...props}
    />
  )
}

function AlertTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-title"
      className={cn(
        "col-start-2 line-clamp-1 min-h-4 font-medium tracking-tight",
        className
      )}
      {...props}
    />
  )
}

function AlertDescription({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-description"
      className={cn(
        "text-muted-foreground col-start-2 grid justify-items-start gap-1 text-sm [&_p]:leading-relaxed",
        className
      )}
      {...props}
    />
  )
}

export { Alert, AlertTitle, AlertDescription }
</file>

<file path="frontend2/components/ui/avatar.tsx">
"use client"

import * as React from "react"
import * as AvatarPrimitive from "@radix-ui/react-avatar"

import { cn } from "@/lib/utils"

function Avatar({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Root>) {
  return (
    <AvatarPrimitive.Root
      data-slot="avatar"
      className={cn(
        "relative flex size-8 shrink-0 overflow-hidden rounded-full",
        className
      )}
      {...props}
    />
  )
}

function AvatarImage({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Image>) {
  return (
    <AvatarPrimitive.Image
      data-slot="avatar-image"
      className={cn("aspect-square size-full", className)}
      {...props}
    />
  )
}

function AvatarFallback({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Fallback>) {
  return (
    <AvatarPrimitive.Fallback
      data-slot="avatar-fallback"
      className={cn(
        "bg-muted flex size-full items-center justify-center rounded-full",
        className
      )}
      {...props}
    />
  )
}

export { Avatar, AvatarImage, AvatarFallback }
</file>

<file path="frontend2/components/ui/breadcrumb.tsx">
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { ChevronRight, MoreHorizontal } from "lucide-react"

import { cn } from "@/lib/utils"

function Breadcrumb({ ...props }: React.ComponentProps<"nav">) {
  return <nav aria-label="breadcrumb" data-slot="breadcrumb" {...props} />
}

function BreadcrumbList({ className, ...props }: React.ComponentProps<"ol">) {
  return (
    <ol
      data-slot="breadcrumb-list"
      className={cn(
        "text-muted-foreground flex flex-wrap items-center gap-1.5 text-sm break-words sm:gap-2.5",
        className
      )}
      {...props}
    />
  )
}

function BreadcrumbItem({ className, ...props }: React.ComponentProps<"li">) {
  return (
    <li
      data-slot="breadcrumb-item"
      className={cn("inline-flex items-center gap-1.5", className)}
      {...props}
    />
  )
}

function BreadcrumbLink({
  asChild,
  className,
  ...props
}: React.ComponentProps<"a"> & {
  asChild?: boolean
}) {
  const Comp = asChild ? Slot : "a"

  return (
    <Comp
      data-slot="breadcrumb-link"
      className={cn("hover:text-foreground transition-colors", className)}
      {...props}
    />
  )
}

function BreadcrumbPage({ className, ...props }: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="breadcrumb-page"
      role="link"
      aria-disabled="true"
      aria-current="page"
      className={cn("text-foreground font-normal", className)}
      {...props}
    />
  )
}

function BreadcrumbSeparator({
  children,
  className,
  ...props
}: React.ComponentProps<"li">) {
  return (
    <li
      data-slot="breadcrumb-separator"
      role="presentation"
      aria-hidden="true"
      className={cn("[&>svg]:size-3.5", className)}
      {...props}
    >
      {children ?? <ChevronRight />}
    </li>
  )
}

function BreadcrumbEllipsis({
  className,
  ...props
}: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="breadcrumb-ellipsis"
      role="presentation"
      aria-hidden="true"
      className={cn("flex size-9 items-center justify-center", className)}
      {...props}
    >
      <MoreHorizontal className="size-4" />
      <span className="sr-only">More</span>
    </span>
  )
}

export {
  Breadcrumb,
  BreadcrumbList,
  BreadcrumbItem,
  BreadcrumbLink,
  BreadcrumbPage,
  BreadcrumbSeparator,
  BreadcrumbEllipsis,
}
</file>

<file path="frontend2/components/ui/button.tsx">
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
  {
    variants: {
      variant: {
        default: "bg-primary text-primary-foreground hover:bg-primary/90",
        destructive:
          "bg-destructive text-white hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",
        secondary:
          "bg-secondary text-secondary-foreground hover:bg-secondary/80",
        ghost:
          "hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-9 px-4 py-2 has-[>svg]:px-3",
        sm: "h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",
        lg: "h-10 rounded-md px-6 has-[>svg]:px-4",
        icon: "size-9",
        "icon-sm": "size-8",
        "icon-lg": "size-10",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

function Button({
  className,
  variant,
  size,
  asChild = false,
  ...props
}: React.ComponentProps<"button"> &
  VariantProps<typeof buttonVariants> & {
    asChild?: boolean
  }) {
  const Comp = asChild ? Slot : "button"

  return (
    <Comp
      data-slot="button"
      className={cn(buttonVariants({ variant, size, className }))}
      {...props}
    />
  )
}

export { Button, buttonVariants }
</file>

<file path="frontend2/components/ui/calendar.tsx">
"use client"

import * as React from "react"
import {
  ChevronDownIcon,
  ChevronLeftIcon,
  ChevronRightIcon,
} from "lucide-react"
import { DayButton, DayPicker, getDefaultClassNames } from "react-day-picker"

import { cn } from "@/lib/utils"
import { Button, buttonVariants } from "@/components/ui/button"

function Calendar({
  className,
  classNames,
  showOutsideDays = true,
  captionLayout = "label",
  buttonVariant = "ghost",
  formatters,
  components,
  ...props
}: React.ComponentProps<typeof DayPicker> & {
  buttonVariant?: React.ComponentProps<typeof Button>["variant"]
}) {
  const defaultClassNames = getDefaultClassNames()

  return (
    <DayPicker
      showOutsideDays={showOutsideDays}
      className={cn(
        "bg-background group/calendar p-3 [--cell-size:--spacing(8)] [[data-slot=card-content]_&]:bg-transparent [[data-slot=popover-content]_&]:bg-transparent",
        String.raw`rtl:**:[.rdp-button\_next>svg]:rotate-180`,
        String.raw`rtl:**:[.rdp-button\_previous>svg]:rotate-180`,
        className
      )}
      captionLayout={captionLayout}
      formatters={{
        formatMonthDropdown: (date) =>
          date.toLocaleString("default", { month: "short" }),
        ...formatters,
      }}
      classNames={{
        root: cn("w-fit", defaultClassNames.root),
        months: cn(
          "flex gap-4 flex-col md:flex-row relative",
          defaultClassNames.months
        ),
        month: cn("flex flex-col w-full gap-4", defaultClassNames.month),
        nav: cn(
          "flex items-center gap-1 w-full absolute top-0 inset-x-0 justify-between",
          defaultClassNames.nav
        ),
        button_previous: cn(
          buttonVariants({ variant: buttonVariant }),
          "size-(--cell-size) aria-disabled:opacity-50 p-0 select-none",
          defaultClassNames.button_previous
        ),
        button_next: cn(
          buttonVariants({ variant: buttonVariant }),
          "size-(--cell-size) aria-disabled:opacity-50 p-0 select-none",
          defaultClassNames.button_next
        ),
        month_caption: cn(
          "flex items-center justify-center h-(--cell-size) w-full px-(--cell-size)",
          defaultClassNames.month_caption
        ),
        dropdowns: cn(
          "w-full flex items-center text-sm font-medium justify-center h-(--cell-size) gap-1.5",
          defaultClassNames.dropdowns
        ),
        dropdown_root: cn(
          "relative has-focus:border-ring border border-input shadow-xs has-focus:ring-ring/50 has-focus:ring-[3px] rounded-md",
          defaultClassNames.dropdown_root
        ),
        dropdown: cn(
          "absolute bg-popover inset-0 opacity-0",
          defaultClassNames.dropdown
        ),
        caption_label: cn(
          "select-none font-medium",
          captionLayout === "label"
            ? "text-sm"
            : "rounded-md pl-2 pr-1 flex items-center gap-1 text-sm h-8 [&>svg]:text-muted-foreground [&>svg]:size-3.5",
          defaultClassNames.caption_label
        ),
        table: "w-full border-collapse",
        weekdays: cn("flex", defaultClassNames.weekdays),
        weekday: cn(
          "text-muted-foreground rounded-md flex-1 font-normal text-[0.8rem] select-none",
          defaultClassNames.weekday
        ),
        week: cn("flex w-full mt-2", defaultClassNames.week),
        week_number_header: cn(
          "select-none w-(--cell-size)",
          defaultClassNames.week_number_header
        ),
        week_number: cn(
          "text-[0.8rem] select-none text-muted-foreground",
          defaultClassNames.week_number
        ),
        day: cn(
          "relative w-full h-full p-0 text-center [&:last-child[data-selected=true]_button]:rounded-r-md group/day aspect-square select-none",
          props.showWeekNumber
            ? "[&:nth-child(2)[data-selected=true]_button]:rounded-l-md"
            : "[&:first-child[data-selected=true]_button]:rounded-l-md",
          defaultClassNames.day
        ),
        range_start: cn(
          "rounded-l-md bg-accent",
          defaultClassNames.range_start
        ),
        range_middle: cn("rounded-none", defaultClassNames.range_middle),
        range_end: cn("rounded-r-md bg-accent", defaultClassNames.range_end),
        today: cn(
          "bg-accent text-accent-foreground rounded-md data-[selected=true]:rounded-none",
          defaultClassNames.today
        ),
        outside: cn(
          "text-muted-foreground aria-selected:text-muted-foreground",
          defaultClassNames.outside
        ),
        disabled: cn(
          "text-muted-foreground opacity-50",
          defaultClassNames.disabled
        ),
        hidden: cn("invisible", defaultClassNames.hidden),
        ...classNames,
      }}
      components={{
        Root: ({ className, rootRef, ...props }) => {
          return (
            <div
              data-slot="calendar"
              ref={rootRef}
              className={cn(className)}
              {...props}
            />
          )
        },
        Chevron: ({ className, orientation, ...props }) => {
          if (orientation === "left") {
            return (
              <ChevronLeftIcon className={cn("size-4", className)} {...props} />
            )
          }

          if (orientation === "right") {
            return (
              <ChevronRightIcon
                className={cn("size-4", className)}
                {...props}
              />
            )
          }

          return (
            <ChevronDownIcon className={cn("size-4", className)} {...props} />
          )
        },
        DayButton: CalendarDayButton,
        WeekNumber: ({ children, ...props }) => {
          return (
            <td {...props}>
              <div className="flex size-(--cell-size) items-center justify-center text-center">
                {children}
              </div>
            </td>
          )
        },
        ...components,
      }}
      {...props}
    />
  )
}

function CalendarDayButton({
  className,
  day,
  modifiers,
  ...props
}: React.ComponentProps<typeof DayButton>) {
  const defaultClassNames = getDefaultClassNames()

  const ref = React.useRef<HTMLButtonElement>(null)
  React.useEffect(() => {
    if (modifiers.focused) ref.current?.focus()
  }, [modifiers.focused])

  return (
    <Button
      ref={ref}
      variant="ghost"
      size="icon"
      data-day={day.date.toLocaleDateString()}
      data-selected-single={
        modifiers.selected &&
        !modifiers.range_start &&
        !modifiers.range_end &&
        !modifiers.range_middle
      }
      data-range-start={modifiers.range_start}
      data-range-end={modifiers.range_end}
      data-range-middle={modifiers.range_middle}
      className={cn(
        "data-[selected-single=true]:bg-primary data-[selected-single=true]:text-primary-foreground data-[range-middle=true]:bg-accent data-[range-middle=true]:text-accent-foreground data-[range-start=true]:bg-primary data-[range-start=true]:text-primary-foreground data-[range-end=true]:bg-primary data-[range-end=true]:text-primary-foreground group-data-[focused=true]/day:border-ring group-data-[focused=true]/day:ring-ring/50 dark:hover:text-accent-foreground flex aspect-square size-auto w-full min-w-(--cell-size) flex-col gap-1 leading-none font-normal group-data-[focused=true]/day:relative group-data-[focused=true]/day:z-10 group-data-[focused=true]/day:ring-[3px] data-[range-end=true]:rounded-md data-[range-end=true]:rounded-r-md data-[range-middle=true]:rounded-none data-[range-start=true]:rounded-md data-[range-start=true]:rounded-l-md [&>span]:text-xs [&>span]:opacity-70",
        defaultClassNames.day,
        className
      )}
      {...props}
    />
  )
}

export { Calendar, CalendarDayButton }
</file>

<file path="frontend2/components/ui/card.tsx">
import * as React from "react"

import { cn } from "@/lib/utils"

function Card({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card"
      className={cn(
        "bg-card text-card-foreground flex flex-col gap-6 rounded-xl border py-6 shadow-sm",
        className
      )}
      {...props}
    />
  )
}

function CardHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-header"
      className={cn(
        "@container/card-header grid auto-rows-min grid-rows-[auto_auto] items-start gap-2 px-6 has-data-[slot=card-action]:grid-cols-[1fr_auto] [.border-b]:pb-6",
        className
      )}
      {...props}
    />
  )
}

function CardTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-title"
      className={cn("leading-none font-semibold", className)}
      {...props}
    />
  )
}

function CardDescription({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

function CardAction({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-action"
      className={cn(
        "col-start-2 row-span-2 row-start-1 self-start justify-self-end",
        className
      )}
      {...props}
    />
  )
}

function CardContent({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-content"
      className={cn("px-6", className)}
      {...props}
    />
  )
}

function CardFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-footer"
      className={cn("flex items-center px-6 [.border-t]:pt-6", className)}
      {...props}
    />
  )
}

export {
  Card,
  CardHeader,
  CardFooter,
  CardTitle,
  CardAction,
  CardDescription,
  CardContent,
}
</file>

<file path="frontend2/components/ui/carousel.tsx">
"use client"

import * as React from "react"
import useEmblaCarousel, {
  type UseEmblaCarouselType,
} from "embla-carousel-react"
import { ArrowLeft, ArrowRight } from "lucide-react"

import { cn } from "@/lib/utils"
import { Button } from "@/components/ui/button"

type CarouselApi = UseEmblaCarouselType[1]
type UseCarouselParameters = Parameters<typeof useEmblaCarousel>
type CarouselOptions = UseCarouselParameters[0]
type CarouselPlugin = UseCarouselParameters[1]

type CarouselProps = {
  opts?: CarouselOptions
  plugins?: CarouselPlugin
  orientation?: "horizontal" | "vertical"
  setApi?: (api: CarouselApi) => void
}

type CarouselContextProps = {
  carouselRef: ReturnType<typeof useEmblaCarousel>[0]
  api: ReturnType<typeof useEmblaCarousel>[1]
  scrollPrev: () => void
  scrollNext: () => void
  canScrollPrev: boolean
  canScrollNext: boolean
} & CarouselProps

const CarouselContext = React.createContext<CarouselContextProps | null>(null)

function useCarousel() {
  const context = React.useContext(CarouselContext)

  if (!context) {
    throw new Error("useCarousel must be used within a <Carousel />")
  }

  return context
}

function Carousel({
  orientation = "horizontal",
  opts,
  setApi,
  plugins,
  className,
  children,
  ...props
}: React.ComponentProps<"div"> & CarouselProps) {
  const [carouselRef, api] = useEmblaCarousel(
    {
      ...opts,
      axis: orientation === "horizontal" ? "x" : "y",
    },
    plugins
  )
  const [canScrollPrev, setCanScrollPrev] = React.useState(false)
  const [canScrollNext, setCanScrollNext] = React.useState(false)

  const onSelect = React.useCallback((api: CarouselApi) => {
    if (!api) return
    setCanScrollPrev(api.canScrollPrev())
    setCanScrollNext(api.canScrollNext())
  }, [])

  const scrollPrev = React.useCallback(() => {
    api?.scrollPrev()
  }, [api])

  const scrollNext = React.useCallback(() => {
    api?.scrollNext()
  }, [api])

  const handleKeyDown = React.useCallback(
    (event: React.KeyboardEvent<HTMLDivElement>) => {
      if (event.key === "ArrowLeft") {
        event.preventDefault()
        scrollPrev()
      } else if (event.key === "ArrowRight") {
        event.preventDefault()
        scrollNext()
      }
    },
    [scrollPrev, scrollNext]
  )

  React.useEffect(() => {
    if (!api || !setApi) return
    setApi(api)
  }, [api, setApi])

  React.useEffect(() => {
    if (!api) return
    onSelect(api)
    api.on("reInit", onSelect)
    api.on("select", onSelect)

    return () => {
      api?.off("select", onSelect)
    }
  }, [api, onSelect])

  return (
    <CarouselContext.Provider
      value={{
        carouselRef,
        api: api,
        opts,
        orientation:
          orientation || (opts?.axis === "y" ? "vertical" : "horizontal"),
        scrollPrev,
        scrollNext,
        canScrollPrev,
        canScrollNext,
      }}
    >
      <div
        onKeyDownCapture={handleKeyDown}
        className={cn("relative", className)}
        role="region"
        aria-roledescription="carousel"
        data-slot="carousel"
        {...props}
      >
        {children}
      </div>
    </CarouselContext.Provider>
  )
}

function CarouselContent({ className, ...props }: React.ComponentProps<"div">) {
  const { carouselRef, orientation } = useCarousel()

  return (
    <div
      ref={carouselRef}
      className="overflow-hidden"
      data-slot="carousel-content"
    >
      <div
        className={cn(
          "flex",
          orientation === "horizontal" ? "-ml-4" : "-mt-4 flex-col",
          className
        )}
        {...props}
      />
    </div>
  )
}

function CarouselItem({ className, ...props }: React.ComponentProps<"div">) {
  const { orientation } = useCarousel()

  return (
    <div
      role="group"
      aria-roledescription="slide"
      data-slot="carousel-item"
      className={cn(
        "min-w-0 shrink-0 grow-0 basis-full",
        orientation === "horizontal" ? "pl-4" : "pt-4",
        className
      )}
      {...props}
    />
  )
}

function CarouselPrevious({
  className,
  variant = "outline",
  size = "icon",
  ...props
}: React.ComponentProps<typeof Button>) {
  const { orientation, scrollPrev, canScrollPrev } = useCarousel()

  return (
    <Button
      data-slot="carousel-previous"
      variant={variant}
      size={size}
      className={cn(
        "absolute size-8 rounded-full",
        orientation === "horizontal"
          ? "top-1/2 -left-12 -translate-y-1/2"
          : "-top-12 left-1/2 -translate-x-1/2 rotate-90",
        className
      )}
      disabled={!canScrollPrev}
      onClick={scrollPrev}
      {...props}
    >
      <ArrowLeft />
      <span className="sr-only">Previous slide</span>
    </Button>
  )
}

function CarouselNext({
  className,
  variant = "outline",
  size = "icon",
  ...props
}: React.ComponentProps<typeof Button>) {
  const { orientation, scrollNext, canScrollNext } = useCarousel()

  return (
    <Button
      data-slot="carousel-next"
      variant={variant}
      size={size}
      className={cn(
        "absolute size-8 rounded-full",
        orientation === "horizontal"
          ? "top-1/2 -right-12 -translate-y-1/2"
          : "-bottom-12 left-1/2 -translate-x-1/2 rotate-90",
        className
      )}
      disabled={!canScrollNext}
      onClick={scrollNext}
      {...props}
    >
      <ArrowRight />
      <span className="sr-only">Next slide</span>
    </Button>
  )
}

export {
  type CarouselApi,
  Carousel,
  CarouselContent,
  CarouselItem,
  CarouselPrevious,
  CarouselNext,
}
</file>

<file path="frontend2/components/ui/chart.tsx">
"use client"

import * as React from "react"
import * as RechartsPrimitive from "recharts"

import { cn } from "@/lib/utils"

// Format: { THEME_NAME: CSS_SELECTOR }
const THEMES = { light: "", dark: ".dark" } as const

export type ChartConfig = {
  [k in string]: {
    label?: React.ReactNode
    icon?: React.ComponentType
  } & (
    | { color?: string; theme?: never }
    | { color?: never; theme: Record<keyof typeof THEMES, string> }
  )
}

type ChartContextProps = {
  config: ChartConfig
}

const ChartContext = React.createContext<ChartContextProps | null>(null)

function useChart() {
  const context = React.useContext(ChartContext)

  if (!context) {
    throw new Error("useChart must be used within a <ChartContainer />")
  }

  return context
}

function ChartContainer({
  id,
  className,
  children,
  config,
  ...props
}: React.ComponentProps<"div"> & {
  config: ChartConfig
  children: React.ComponentProps<
    typeof RechartsPrimitive.ResponsiveContainer
  >["children"]
}) {
  const uniqueId = React.useId()
  const chartId = `chart-${id || uniqueId.replace(/:/g, "")}`

  return (
    <ChartContext.Provider value={{ config }}>
      <div
        data-slot="chart"
        data-chart={chartId}
        className={cn(
          "[&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border flex aspect-video justify-center text-xs [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-hidden [&_.recharts-sector]:outline-hidden [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-surface]:outline-hidden",
          className
        )}
        {...props}
      >
        <ChartStyle id={chartId} config={config} />
        <RechartsPrimitive.ResponsiveContainer>
          {children}
        </RechartsPrimitive.ResponsiveContainer>
      </div>
    </ChartContext.Provider>
  )
}

const ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {
  const colorConfig = Object.entries(config).filter(
    ([, config]) => config.theme || config.color
  )

  if (!colorConfig.length) {
    return null
  }

  return (
    <style
      dangerouslySetInnerHTML={{
        __html: Object.entries(THEMES)
          .map(
            ([theme, prefix]) => `
${prefix} [data-chart=${id}] {
${colorConfig
                .map(([key, itemConfig]) => {
                  const color =
                    itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||
                    itemConfig.color
                  return color ? `  --color-${key}: ${color};` : null
                })
                .join("\n")}
}
`
          )
          .join("\n"),
      }}
    />
  )
}

const ChartTooltip = RechartsPrimitive.Tooltip

function ChartTooltipContent({
  active,
  payload,
  className,
  indicator = "dot",
  hideLabel = false,
  hideIndicator = false,
  label,
  labelFormatter,
  labelClassName,
  formatter,
  color,
  nameKey,
  labelKey,
}: React.ComponentProps<typeof RechartsPrimitive.Tooltip> &
  React.ComponentProps<"div"> & {
    hideLabel?: boolean
    hideIndicator?: boolean
    indicator?: "line" | "dot" | "dashed"
    nameKey?: string
    labelKey?: string
  }) {
  const { config } = useChart()

  const tooltipLabel = React.useMemo(() => {
    if (hideLabel || !payload?.length) {
      return null
    }

    const [item] = payload
    const key = `${labelKey || item?.dataKey || item?.name || "value"}`
    const itemConfig = getPayloadConfigFromPayload(config, item, key)
    const value =
      !labelKey && typeof label === "string"
        ? config[label as keyof typeof config]?.label || label
        : itemConfig?.label

    if (labelFormatter) {
      return (
        <div className={cn("font-medium", labelClassName)}>
          {labelFormatter(value, payload)}
        </div>
      )
    }

    if (!value) {
      return null
    }

    return <div className={cn("font-medium", labelClassName)}>{value}</div>
  }, [
    label,
    labelFormatter,
    payload,
    hideLabel,
    labelClassName,
    config,
    labelKey,
  ])

  if (!active || !payload?.length) {
    return null
  }

  const nestLabel = payload.length === 1 && indicator !== "dot"

  return (
    <div
      className={cn(
        "border-border/50 bg-background grid min-w-[8rem] items-start gap-1.5 rounded-lg border px-2.5 py-1.5 text-xs shadow-xl",
        className
      )}
    >
      {!nestLabel ? tooltipLabel : null}
      <div className="grid gap-1.5">
        {payload
          .filter((item) => item.type !== "none")
          .map((item, index) => {
            const key = `${nameKey || item.name || item.dataKey || "value"}`
            const itemConfig = getPayloadConfigFromPayload(config, item, key)
            const indicatorColor = color || item.payload.fill || item.color

            return (
              <div
                key={item.dataKey}
                className={cn(
                  "[&>svg]:text-muted-foreground flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5",
                  indicator === "dot" && "items-center"
                )}
              >
                {formatter && item?.value !== undefined && item.name ? (
                  formatter(item.value, item.name, item, index, item.payload)
                ) : (
                  <>
                    {itemConfig?.icon ? (
                      <itemConfig.icon />
                    ) : (
                      !hideIndicator && (
                        <div
                          className={cn(
                            "shrink-0 rounded-[2px] border-(--color-border) bg-(--color-bg)",
                            {
                              "h-2.5 w-2.5": indicator === "dot",
                              "w-1": indicator === "line",
                              "w-0 border-[1.5px] border-dashed bg-transparent":
                                indicator === "dashed",
                              "my-0.5": nestLabel && indicator === "dashed",
                            }
                          )}
                          style={
                            {
                              "--color-bg": indicatorColor,
                              "--color-border": indicatorColor,
                            } as React.CSSProperties
                          }
                        />
                      )
                    )}
                    <div
                      className={cn(
                        "flex flex-1 justify-between leading-none gap-2",
                        nestLabel ? "items-end" : "items-center"
                      )}
                    >
                      <div className="grid gap-1.5">
                        {nestLabel ? tooltipLabel : null}
                        <span className="text-muted-foreground">
                          {itemConfig?.label || item.name}
                        </span>
                      </div>
                      {item.value && (
                        <span className="text-foreground font-mono font-medium tabular-nums">
                          {item.value.toLocaleString()}
                        </span>
                      )}
                    </div>
                  </>
                )}
              </div>
            )
          })}
      </div>
    </div>
  )
}

const ChartLegend = RechartsPrimitive.Legend

function ChartLegendContent({
  className,
  hideIcon = false,
  payload,
  verticalAlign = "bottom",
  nameKey,
}: React.ComponentProps<"div"> &
  Pick<RechartsPrimitive.LegendProps, "payload" | "verticalAlign"> & {
    hideIcon?: boolean
    nameKey?: string
  }) {
  const { config } = useChart()

  if (!payload?.length) {
    return null
  }

  return (
    <div
      className={cn(
        "flex items-center justify-center gap-4",
        verticalAlign === "top" ? "pb-3" : "pt-3",
        className
      )}
    >
      {payload
        .filter((item) => item.type !== "none")
        .map((item) => {
          const key = `${nameKey || item.dataKey || "value"}`
          const itemConfig = getPayloadConfigFromPayload(config, item, key)

          return (
            <div
              key={item.value}
              className={cn(
                "[&>svg]:text-muted-foreground flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3"
              )}
            >
              {itemConfig?.icon && !hideIcon ? (
                <itemConfig.icon />
              ) : (
                <div
                  className="h-2 w-2 shrink-0 rounded-[2px]"
                  style={{
                    backgroundColor: item.color,
                  }}
                />
              )}
              {itemConfig?.label}
            </div>
          )
        })}
    </div>
  )
}

// Helper to extract item config from a payload.
function getPayloadConfigFromPayload(
  config: ChartConfig,
  payload: unknown,
  key: string
) {
  if (typeof payload !== "object" || payload === null) {
    return undefined
  }

  const payloadPayload =
    "payload" in payload &&
      typeof payload.payload === "object" &&
      payload.payload !== null
      ? payload.payload
      : undefined

  let configLabelKey: string = key

  if (
    key in payload &&
    typeof payload[key as keyof typeof payload] === "string"
  ) {
    configLabelKey = payload[key as keyof typeof payload] as string
  } else if (
    payloadPayload &&
    key in payloadPayload &&
    typeof payloadPayload[key as keyof typeof payloadPayload] === "string"
  ) {
    configLabelKey = payloadPayload[
      key as keyof typeof payloadPayload
    ] as string
  }

  return configLabelKey in config
    ? config[configLabelKey]
    : config[key as keyof typeof config]
}

export {
  ChartContainer,
  ChartTooltip,
  ChartTooltipContent,
  ChartLegend,
  ChartLegendContent,
  ChartStyle,
}
</file>

<file path="frontend2/components/ui/command.tsx">
"use client"

import * as React from "react"
import { Command as CommandPrimitive } from "cmdk"
import { SearchIcon } from "lucide-react"

import { cn } from "@/lib/utils"
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog"

function Command({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive>) {
  return (
    <CommandPrimitive
      data-slot="command"
      className={cn(
        "bg-popover text-popover-foreground flex h-full w-full flex-col overflow-hidden rounded-md",
        className
      )}
      {...props}
    />
  )
}

function CommandDialog({
  title = "Command Palette",
  description = "Search for a command to run...",
  children,
  className,
  showCloseButton = true,
  ...props
}: React.ComponentProps<typeof Dialog> & {
  title?: string
  description?: string
  className?: string
  showCloseButton?: boolean
}) {
  return (
    <Dialog {...props}>
      <DialogHeader className="sr-only">
        <DialogTitle>{title}</DialogTitle>
        <DialogDescription>{description}</DialogDescription>
      </DialogHeader>
      <DialogContent
        className={cn("overflow-hidden p-0", className)}
        showCloseButton={showCloseButton}
      >
        <Command className="[&_[cmdk-group-heading]]:text-muted-foreground **:data-[slot=command-input-wrapper]:h-12 [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group]]:px-2 [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5">
          {children}
        </Command>
      </DialogContent>
    </Dialog>
  )
}

function CommandInput({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Input>) {
  return (
    <div
      data-slot="command-input-wrapper"
      className="flex h-9 items-center gap-2 border-b px-3"
    >
      <SearchIcon className="size-4 shrink-0 opacity-50" />
      <CommandPrimitive.Input
        data-slot="command-input"
        className={cn(
          "placeholder:text-muted-foreground flex h-10 w-full rounded-md bg-transparent py-3 text-sm outline-hidden disabled:cursor-not-allowed disabled:opacity-50",
          className
        )}
        {...props}
      />
    </div>
  )
}

function CommandList({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.List>) {
  return (
    <CommandPrimitive.List
      data-slot="command-list"
      className={cn(
        "max-h-[300px] scroll-py-1 overflow-x-hidden overflow-y-auto",
        className
      )}
      {...props}
    />
  )
}

function CommandEmpty({
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Empty>) {
  return (
    <CommandPrimitive.Empty
      data-slot="command-empty"
      className="py-6 text-center text-sm"
      {...props}
    />
  )
}

function CommandGroup({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Group>) {
  return (
    <CommandPrimitive.Group
      data-slot="command-group"
      className={cn(
        "text-foreground [&_[cmdk-group-heading]]:text-muted-foreground overflow-hidden p-1 [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium",
        className
      )}
      {...props}
    />
  )
}

function CommandSeparator({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Separator>) {
  return (
    <CommandPrimitive.Separator
      data-slot="command-separator"
      className={cn("bg-border -mx-1 h-px", className)}
      {...props}
    />
  )
}

function CommandItem({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Item>) {
  return (
    <CommandPrimitive.Item
      data-slot="command-item"
      className={cn(
        "data-[selected=true]:bg-accent data-[selected=true]:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled=true]:pointer-events-none data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    />
  )
}

function CommandShortcut({
  className,
  ...props
}: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="command-shortcut"
      className={cn(
        "text-muted-foreground ml-auto text-xs tracking-widest",
        className
      )}
      {...props}
    />
  )
}

export {
  Command,
  CommandDialog,
  CommandInput,
  CommandList,
  CommandEmpty,
  CommandGroup,
  CommandItem,
  CommandShortcut,
  CommandSeparator,
}
</file>

<file path="frontend2/components/ui/dialog.tsx">
"use client"

import * as React from "react"
import * as DialogPrimitive from "@radix-ui/react-dialog"
import { XIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Dialog({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Root>) {
  return <DialogPrimitive.Root data-slot="dialog" {...props} />
}

function DialogTrigger({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Trigger>) {
  return <DialogPrimitive.Trigger data-slot="dialog-trigger" {...props} />
}

function DialogPortal({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Portal>) {
  return <DialogPrimitive.Portal data-slot="dialog-portal" {...props} />
}

function DialogClose({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Close>) {
  return <DialogPrimitive.Close data-slot="dialog-close" {...props} />
}

function DialogOverlay({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Overlay>) {
  return (
    <DialogPrimitive.Overlay
      data-slot="dialog-overlay"
      className={cn(
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50",
        className
      )}
      {...props}
    />
  )
}

function DialogContent({
  className,
  children,
  showCloseButton = true,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Content> & {
  showCloseButton?: boolean
}) {
  return (
    <DialogPortal data-slot="dialog-portal">
      <DialogOverlay />
      <DialogPrimitive.Content
        data-slot="dialog-content"
        className={cn(
          "bg-background data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200 sm:max-w-lg",
          className
        )}
        {...props}
      >
        {children}
        {showCloseButton && (
          <DialogPrimitive.Close
            data-slot="dialog-close"
            className="ring-offset-background focus:ring-ring data-[state=open]:bg-accent data-[state=open]:text-muted-foreground absolute top-4 right-4 rounded-xs opacity-70 transition-opacity hover:opacity-100 focus:ring-2 focus:ring-offset-2 focus:outline-hidden disabled:pointer-events-none [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4"
          >
            <XIcon />
            <span className="sr-only">Close</span>
          </DialogPrimitive.Close>
        )}
      </DialogPrimitive.Content>
    </DialogPortal>
  )
}

function DialogHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="dialog-header"
      className={cn("flex flex-col gap-2 text-center sm:text-left", className)}
      {...props}
    />
  )
}

function DialogFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="dialog-footer"
      className={cn(
        "flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",
        className
      )}
      {...props}
    />
  )
}

function DialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Title>) {
  return (
    <DialogPrimitive.Title
      data-slot="dialog-title"
      className={cn("text-lg leading-none font-semibold", className)}
      {...props}
    />
  )
}

function DialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Description>) {
  return (
    <DialogPrimitive.Description
      data-slot="dialog-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

export {
  Dialog,
  DialogClose,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogOverlay,
  DialogPortal,
  DialogTitle,
  DialogTrigger,
}
</file>

<file path="frontend2/components/ui/dropdown-menu.tsx">
"use client"

import * as React from "react"
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu"
import { CheckIcon, ChevronRightIcon, CircleIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function DropdownMenu({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Root>) {
  return <DropdownMenuPrimitive.Root data-slot="dropdown-menu" {...props} />
}

function DropdownMenuPortal({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Portal>) {
  return (
    <DropdownMenuPrimitive.Portal data-slot="dropdown-menu-portal" {...props} />
  )
}

function DropdownMenuTrigger({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Trigger>) {
  return (
    <DropdownMenuPrimitive.Trigger
      data-slot="dropdown-menu-trigger"
      {...props}
    />
  )
}

function DropdownMenuContent({
  className,
  sideOffset = 4,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Content>) {
  return (
    <DropdownMenuPrimitive.Portal>
      <DropdownMenuPrimitive.Content
        data-slot="dropdown-menu-content"
        sideOffset={sideOffset}
        className={cn(
          "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 max-h-(--radix-dropdown-menu-content-available-height) min-w-[8rem] origin-(--radix-dropdown-menu-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border p-1 shadow-md",
          className
        )}
        {...props}
      />
    </DropdownMenuPrimitive.Portal>
  )
}

function DropdownMenuGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Group>) {
  return (
    <DropdownMenuPrimitive.Group data-slot="dropdown-menu-group" {...props} />
  )
}

function DropdownMenuItem({
  className,
  inset,
  variant = "default",
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Item> & {
  inset?: boolean
  variant?: "default" | "destructive"
}) {
  return (
    <DropdownMenuPrimitive.Item
      data-slot="dropdown-menu-item"
      data-inset={inset}
      data-variant={variant}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    />
  )
}

function DropdownMenuCheckboxItem({
  className,
  children,
  checked,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.CheckboxItem>) {
  return (
    <DropdownMenuPrimitive.CheckboxItem
      data-slot="dropdown-menu-checkbox-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      checked={checked}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.CheckboxItem>
  )
}

function DropdownMenuRadioGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioGroup>) {
  return (
    <DropdownMenuPrimitive.RadioGroup
      data-slot="dropdown-menu-radio-group"
      {...props}
    />
  )
}

function DropdownMenuRadioItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioItem>) {
  return (
    <DropdownMenuPrimitive.RadioItem
      data-slot="dropdown-menu-radio-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CircleIcon className="size-2 fill-current" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.RadioItem>
  )
}

function DropdownMenuLabel({
  className,
  inset,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Label> & {
  inset?: boolean
}) {
  return (
    <DropdownMenuPrimitive.Label
      data-slot="dropdown-menu-label"
      data-inset={inset}
      className={cn(
        "px-2 py-1.5 text-sm font-medium data-[inset]:pl-8",
        className
      )}
      {...props}
    />
  )
}

function DropdownMenuSeparator({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Separator>) {
  return (
    <DropdownMenuPrimitive.Separator
      data-slot="dropdown-menu-separator"
      className={cn("bg-border -mx-1 my-1 h-px", className)}
      {...props}
    />
  )
}

function DropdownMenuShortcut({
  className,
  ...props
}: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="dropdown-menu-shortcut"
      className={cn(
        "text-muted-foreground ml-auto text-xs tracking-widest",
        className
      )}
      {...props}
    />
  )
}

function DropdownMenuSub({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Sub>) {
  return <DropdownMenuPrimitive.Sub data-slot="dropdown-menu-sub" {...props} />
}

function DropdownMenuSubTrigger({
  className,
  inset,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubTrigger> & {
  inset?: boolean
}) {
  return (
    <DropdownMenuPrimitive.SubTrigger
      data-slot="dropdown-menu-sub-trigger"
      data-inset={inset}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      {children}
      <ChevronRightIcon className="ml-auto size-4" />
    </DropdownMenuPrimitive.SubTrigger>
  )
}

function DropdownMenuSubContent({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubContent>) {
  return (
    <DropdownMenuPrimitive.SubContent
      data-slot="dropdown-menu-sub-content"
      className={cn(
        "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 min-w-[8rem] origin-(--radix-dropdown-menu-content-transform-origin) overflow-hidden rounded-md border p-1 shadow-lg",
        className
      )}
      {...props}
    />
  )
}

export {
  DropdownMenu,
  DropdownMenuPortal,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuGroup,
  DropdownMenuLabel,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioGroup,
  DropdownMenuRadioItem,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuSub,
  DropdownMenuSubTrigger,
  DropdownMenuSubContent,
}
</file>

<file path="frontend2/components/ui/field.tsx">
"use client"

import { useMemo } from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"
import { Label } from "@/components/ui/label"
import { Separator } from "@/components/ui/separator"

function FieldSet({ className, ...props }: React.ComponentProps<"fieldset">) {
  return (
    <fieldset
      data-slot="field-set"
      className={cn(
        "flex flex-col gap-6",
        "has-[>[data-slot=checkbox-group]]:gap-3 has-[>[data-slot=radio-group]]:gap-3",
        className
      )}
      {...props}
    />
  )
}

function FieldLegend({
  className,
  variant = "legend",
  ...props
}: React.ComponentProps<"legend"> & { variant?: "legend" | "label" }) {
  return (
    <legend
      data-slot="field-legend"
      data-variant={variant}
      className={cn(
        "mb-3 font-medium",
        "data-[variant=legend]:text-base",
        "data-[variant=label]:text-sm",
        className
      )}
      {...props}
    />
  )
}

function FieldGroup({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="field-group"
      className={cn(
        "group/field-group @container/field-group flex w-full flex-col gap-7 data-[slot=checkbox-group]:gap-3 [&>[data-slot=field-group]]:gap-4",
        className
      )}
      {...props}
    />
  )
}

const fieldVariants = cva(
  "group/field flex w-full gap-3 data-[invalid=true]:text-destructive",
  {
    variants: {
      orientation: {
        vertical: ["flex-col [&>*]:w-full [&>.sr-only]:w-auto"],
        horizontal: [
          "flex-row items-center",
          "[&>[data-slot=field-label]]:flex-auto",
          "has-[>[data-slot=field-content]]:items-start has-[>[data-slot=field-content]]:[&>[role=checkbox],[role=radio]]:mt-px",
        ],
        responsive: [
          "flex-col [&>*]:w-full [&>.sr-only]:w-auto @md/field-group:flex-row @md/field-group:items-center @md/field-group:[&>*]:w-auto",
          "@md/field-group:[&>[data-slot=field-label]]:flex-auto",
          "@md/field-group:has-[>[data-slot=field-content]]:items-start @md/field-group:has-[>[data-slot=field-content]]:[&>[role=checkbox],[role=radio]]:mt-px",
        ],
      },
    },
    defaultVariants: {
      orientation: "vertical",
    },
  }
)

function Field({
  className,
  orientation = "vertical",
  ...props
}: React.ComponentProps<"div"> & VariantProps<typeof fieldVariants>) {
  return (
    <div
      role="group"
      data-slot="field"
      data-orientation={orientation}
      className={cn(fieldVariants({ orientation }), className)}
      {...props}
    />
  )
}

function FieldContent({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="field-content"
      className={cn(
        "group/field-content flex flex-1 flex-col gap-1.5 leading-snug",
        className
      )}
      {...props}
    />
  )
}

function FieldLabel({
  className,
  ...props
}: React.ComponentProps<typeof Label>) {
  return (
    <Label
      data-slot="field-label"
      className={cn(
        "group/field-label peer/field-label flex w-fit gap-2 leading-snug group-data-[disabled=true]/field:opacity-50",
        "has-[>[data-slot=field]]:w-full has-[>[data-slot=field]]:flex-col has-[>[data-slot=field]]:rounded-md has-[>[data-slot=field]]:border [&>*]:data-[slot=field]:p-4",
        "has-data-[state=checked]:bg-primary/5 has-data-[state=checked]:border-primary dark:has-data-[state=checked]:bg-primary/10",
        className
      )}
      {...props}
    />
  )
}

function FieldTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="field-label"
      className={cn(
        "flex w-fit items-center gap-2 text-sm leading-snug font-medium group-data-[disabled=true]/field:opacity-50",
        className
      )}
      {...props}
    />
  )
}

function FieldDescription({ className, ...props }: React.ComponentProps<"p">) {
  return (
    <p
      data-slot="field-description"
      className={cn(
        "text-muted-foreground text-sm leading-normal font-normal group-has-[[data-orientation=horizontal]]/field:text-balance",
        "last:mt-0 nth-last-2:-mt-1 [[data-variant=legend]+&]:-mt-1.5",
        "[&>a:hover]:text-primary [&>a]:underline [&>a]:underline-offset-4",
        className
      )}
      {...props}
    />
  )
}

function FieldSeparator({
  children,
  className,
  ...props
}: React.ComponentProps<"div"> & {
  children?: React.ReactNode
}) {
  return (
    <div
      data-slot="field-separator"
      data-content={!!children}
      className={cn(
        "relative -my-2 h-5 text-sm group-data-[variant=outline]/field-group:-mb-2",
        className
      )}
      {...props}
    >
      <Separator className="absolute inset-0 top-1/2" />
      {children && (
        <span
          className="bg-background text-muted-foreground relative mx-auto block w-fit px-2"
          data-slot="field-separator-content"
        >
          {children}
        </span>
      )}
    </div>
  )
}

function FieldError({
  className,
  children,
  errors,
  ...props
}: React.ComponentProps<"div"> & {
  errors?: Array<{ message?: string } | undefined>
}) {
  const content = useMemo(() => {
    if (children) {
      return children
    }

    if (!errors?.length) {
      return null
    }

    const uniqueErrors = [
      ...new Map(errors.map((error) => [error?.message, error])).values(),
    ]

    if (uniqueErrors?.length == 1) {
      return uniqueErrors[0]?.message
    }

    return (
      <ul className="ml-4 flex list-disc flex-col gap-1">
        {uniqueErrors.map(
          (error, index) =>
            error?.message && <li key={index}>{error.message}</li>
        )}
      </ul>
    )
  }, [children, errors])

  if (!content) {
    return null
  }

  return (
    <div
      role="alert"
      data-slot="field-error"
      className={cn("text-destructive text-sm font-normal", className)}
      {...props}
    >
      {content}
    </div>
  )
}

export {
  Field,
  FieldLabel,
  FieldDescription,
  FieldError,
  FieldGroup,
  FieldLegend,
  FieldSeparator,
  FieldSet,
  FieldContent,
  FieldTitle,
}
</file>

<file path="frontend2/components/ui/file-upload.tsx">
"use client";

import { useCallback, useState, useEffect } from "react";
import { CloudUpload, X } from "lucide-react";
import { Button } from "@/components/ui/button";
import {
    Item,
    ItemContent,
    ItemDescription,
    ItemGroup,
    ItemMedia,
    ItemTitle,
    ItemActions,
} from "@/components/ui/item";

interface FileUploadProps {
    onFileSelect: (file: File | null) => void;
    accept?: string;
    currentFile?: File | null;
    initialPreviewUrl?: string | null;
    onRemove?: () => void;
}

export function FileUpload({ onFileSelect, accept = "image/*", currentFile, initialPreviewUrl, onRemove }: FileUploadProps) {
    const [isDragging, setIsDragging] = useState(false);
    const [previewUrl, setPreviewUrl] = useState<string | null>(initialPreviewUrl || null);

    const handleDragOver = useCallback((e: React.DragEvent) => {
        e.preventDefault();
        setIsDragging(true);
    }, []);

    const handleDragLeave = useCallback((e: React.DragEvent) => {
        e.preventDefault();
        setIsDragging(false);
    }, []);

    const handleDrop = useCallback((e: React.DragEvent) => {
        e.preventDefault();
        setIsDragging(false);

        const file = e.dataTransfer.files[0];
        if (file) {
            onFileSelect(file);
        }
    }, [onFileSelect]);

    const handleFileChange = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
        const file = e.target.files?.[0];
        if (file) {
            onFileSelect(file);
        }
    }, [onFileSelect]);

    const handleRemove = useCallback(() => {
        onFileSelect(null);
        setPreviewUrl(null);
        if (onRemove) onRemove();
    }, [onFileSelect, onRemove]);

    // Generate preview URL when file changes
    useEffect(() => {
        if (currentFile && currentFile.type.startsWith("image/")) {
            const url = URL.createObjectURL(currentFile);
            setPreviewUrl(url);
            return () => URL.revokeObjectURL(url);
        } else if (!currentFile && initialPreviewUrl) {
            // If no new file selected but we have initial, revert to initial? 
            // Or if user removed it, we should respect that.
            // The handleRemove sets previewUrl to null, so we shouldn't automatically revert here unless we track "removed" state.
            // But for simplicity, if currentFile is null, we don't necessarily want to show initial if it was removed.
            // However, on mount, currentFile is null and initialPreviewUrl is set.
            // So we need to distinguish between "initial load" and "user removed file".
            // Actually, handleRemove sets previewUrl to null directly.
            // This useEffect runs when currentFile changes.
            // If currentFile becomes null (removed), we might not want to reset to initial.
            // Let's rely on state initialization for initialPreviewUrl and only update if currentFile is present.
        }
    }, [currentFile]);

    // If we have a preview URL (either from file or initial), show the item
    // We need a way to show the name/size for initial files too if possible, or just "Imagen Actual"

    const showPreview = previewUrl;
    const fileName = currentFile?.name || "Imagen Actual";
    const fileSize = currentFile ? (currentFile.size / 1024 / 1024).toFixed(2) + " MB" : "";

    if (showPreview) {
        return (
            <ItemGroup>
                <Item variant="outline">
                    <ItemMedia variant="image">
                        <img
                            src={previewUrl!}
                            alt={fileName}
                            className="object-cover"
                        />
                    </ItemMedia>
                    <ItemContent>
                        <ItemTitle className="line-clamp-1">
                            {fileName}
                        </ItemTitle>
                        {fileSize && (
                            <ItemDescription>
                                {fileSize}
                            </ItemDescription>
                        )}
                    </ItemContent>
                    <ItemActions>
                        <Button
                            type="button"
                            variant="ghost"
                            size="icon"
                            className="h-8 w-8 text-muted-foreground hover:text-destructive"
                            onClick={handleRemove}
                        >
                            <X className="h-4 w-4" />
                            <span className="sr-only">Remover archivo</span>
                        </Button>
                    </ItemActions>
                </Item>
            </ItemGroup>
        );
    }

    return (
        <div
            onDragOver={handleDragOver}
            onDragLeave={handleDragLeave}
            onDrop={handleDrop}
            className={`
                relative flex flex-col items-center justify-center
                border-2 border-dashed rounded-lg
                p-8 transition-colors
                ${isDragging ? "border-primary bg-primary/5" : "border-gray-300"}
            `}
        >
            <CloudUpload className="h-12 w-12 text-gray-400 mb-4" />

            <p className="text-lg text-center font-medium text-gray-700 mb-2">
                Arrastra archivos aquí
            </p>

            <p className="text-sm text-gray-500 mb-4">o</p>

            <input
                type="file"
                accept={accept}
                onChange={handleFileChange}
                className="hidden"
                id="file-upload-input"
            />

            <Button
                type="button"
                variant="outline"
                onClick={() => document.getElementById("file-upload-input")?.click()}
            >
                Buscar Archivos
            </Button>
        </div>
    );
}
</file>

<file path="frontend2/components/ui/form.tsx">
"use client"

import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"
import { Slot } from "@radix-ui/react-slot"
import {
  Controller,
  FormProvider,
  useFormContext,
  useFormState,
  type ControllerProps,
  type FieldPath,
  type FieldValues,
} from "react-hook-form"

import { cn } from "@/lib/utils"
import { Label } from "@/components/ui/label"

const Form = FormProvider

type FormFieldContextValue<
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>,
> = {
  name: TName
}

const FormFieldContext = React.createContext<FormFieldContextValue>(
  {} as FormFieldContextValue
)

const FormField = <
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>,
>({
  ...props
}: ControllerProps<TFieldValues, TName>) => {
  return (
    <FormFieldContext.Provider value={{ name: props.name }}>
      <Controller {...props} />
    </FormFieldContext.Provider>
  )
}

const useFormField = () => {
  const fieldContext = React.useContext(FormFieldContext)
  const itemContext = React.useContext(FormItemContext)
  const { getFieldState } = useFormContext()
  const formState = useFormState({ name: fieldContext.name })
  const fieldState = getFieldState(fieldContext.name, formState)

  if (!fieldContext) {
    throw new Error("useFormField should be used within <FormField>")
  }

  const { id } = itemContext

  return {
    id,
    name: fieldContext.name,
    formItemId: `${id}-form-item`,
    formDescriptionId: `${id}-form-item-description`,
    formMessageId: `${id}-form-item-message`,
    ...fieldState,
  }
}

type FormItemContextValue = {
  id: string
}

const FormItemContext = React.createContext<FormItemContextValue>(
  {} as FormItemContextValue
)

function FormItem({ className, ...props }: React.ComponentProps<"div">) {
  const id = React.useId()

  return (
    <FormItemContext.Provider value={{ id }}>
      <div
        data-slot="form-item"
        className={cn("grid gap-2", className)}
        {...props}
      />
    </FormItemContext.Provider>
  )
}

function FormLabel({
  className,
  ...props
}: React.ComponentProps<typeof LabelPrimitive.Root>) {
  const { error, formItemId } = useFormField()

  return (
    <Label
      data-slot="form-label"
      data-error={!!error}
      className={cn("data-[error=true]:text-destructive", className)}
      htmlFor={formItemId}
      {...props}
    />
  )
}

function FormControl({ ...props }: React.ComponentProps<typeof Slot>) {
  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()

  return (
    <Slot
      data-slot="form-control"
      id={formItemId}
      aria-describedby={
        !error
          ? `${formDescriptionId}`
          : `${formDescriptionId} ${formMessageId}`
      }
      aria-invalid={!!error}
      {...props}
    />
  )
}

function FormDescription({ className, ...props }: React.ComponentProps<"p">) {
  const { formDescriptionId } = useFormField()

  return (
    <p
      data-slot="form-description"
      id={formDescriptionId}
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

function FormMessage({ className, ...props }: React.ComponentProps<"p">) {
  const { error, formMessageId } = useFormField()
  const body = error ? String(error?.message ?? "") : props.children

  if (!body) {
    return null
  }

  return (
    <p
      data-slot="form-message"
      id={formMessageId}
      className={cn("text-destructive text-sm", className)}
      {...props}
    >
      {body}
    </p>
  )
}

export {
  useFormField,
  Form,
  FormItem,
  FormLabel,
  FormControl,
  FormDescription,
  FormMessage,
  FormField,
}
</file>

<file path="frontend2/components/ui/input.tsx">
import * as React from "react"

import { cn } from "@/lib/utils"

function Input({ className, type, ...props }: React.ComponentProps<"input">) {
  return (
    <input
      type={type}
      data-slot="input"
      className={cn(
        "file:text-foreground placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground dark:bg-input/30 border-input h-9 w-full min-w-0 rounded-md border bg-transparent px-3 py-1 text-base shadow-xs transition-[color,box-shadow] outline-none file:inline-flex file:h-7 file:border-0 file:bg-transparent file:text-sm file:font-medium disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        "focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]",
        "aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
        className
      )}
      {...props}
    />
  )
}

export { Input }
</file>

<file path="frontend2/components/ui/item.tsx">
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"
import { Separator } from "@/components/ui/separator"

function ItemGroup({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      role="list"
      data-slot="item-group"
      className={cn("group/item-group flex flex-col", className)}
      {...props}
    />
  )
}

function ItemSeparator({
  className,
  ...props
}: React.ComponentProps<typeof Separator>) {
  return (
    <Separator
      data-slot="item-separator"
      orientation="horizontal"
      className={cn("my-0", className)}
      {...props}
    />
  )
}

const itemVariants = cva(
  "group/item flex items-center border border-transparent text-sm rounded-md transition-colors [a]:hover:bg-accent/50 [a]:transition-colors duration-100 flex-wrap outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]",
  {
    variants: {
      variant: {
        default: "bg-transparent",
        outline: "border-border",
        muted: "bg-muted/50",
      },
      size: {
        default: "p-4 gap-4 ",
        sm: "py-3 px-4 gap-2.5",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

function Item({
  className,
  variant = "default",
  size = "default",
  asChild = false,
  ...props
}: React.ComponentProps<"div"> &
  VariantProps<typeof itemVariants> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : "div"
  return (
    <Comp
      data-slot="item"
      data-variant={variant}
      data-size={size}
      className={cn(itemVariants({ variant, size, className }))}
      {...props}
    />
  )
}

const itemMediaVariants = cva(
  "flex shrink-0 items-center justify-center gap-2 group-has-[[data-slot=item-description]]/item:self-start [&_svg]:pointer-events-none group-has-[[data-slot=item-description]]/item:translate-y-0.5",
  {
    variants: {
      variant: {
        default: "bg-transparent",
        icon: "size-8 border rounded-sm bg-muted [&_svg:not([class*='size-'])]:size-4",
        image:
          "size-10 rounded-sm overflow-hidden [&_img]:size-full [&_img]:object-cover",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

function ItemMedia({
  className,
  variant = "default",
  ...props
}: React.ComponentProps<"div"> & VariantProps<typeof itemMediaVariants>) {
  return (
    <div
      data-slot="item-media"
      data-variant={variant}
      className={cn(itemMediaVariants({ variant, className }))}
      {...props}
    />
  )
}

function ItemContent({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="item-content"
      className={cn(
        "flex flex-1 flex-col gap-1 [&+[data-slot=item-content]]:flex-none",
        className
      )}
      {...props}
    />
  )
}

function ItemTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="item-title"
      className={cn(
        "flex w-fit items-center gap-2 text-sm leading-snug font-medium",
        className
      )}
      {...props}
    />
  )
}

function ItemDescription({ className, ...props }: React.ComponentProps<"p">) {
  return (
    <p
      data-slot="item-description"
      className={cn(
        "text-muted-foreground line-clamp-2 text-sm leading-normal font-normal text-balance",
        "[&>a:hover]:text-primary [&>a]:underline [&>a]:underline-offset-4",
        className
      )}
      {...props}
    />
  )
}

function ItemActions({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="item-actions"
      className={cn("flex items-center gap-2", className)}
      {...props}
    />
  )
}

function ItemHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="item-header"
      className={cn(
        "flex basis-full items-center justify-between gap-2",
        className
      )}
      {...props}
    />
  )
}

function ItemFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="item-footer"
      className={cn(
        "flex basis-full items-center justify-between gap-2",
        className
      )}
      {...props}
    />
  )
}

export {
  Item,
  ItemMedia,
  ItemContent,
  ItemActions,
  ItemGroup,
  ItemSeparator,
  ItemTitle,
  ItemDescription,
  ItemHeader,
  ItemFooter,
}
</file>

<file path="frontend2/components/ui/kbd.tsx">
import { cn } from "@/lib/utils"

function Kbd({ className, ...props }: React.ComponentProps<"kbd">) {
  return (
    <kbd
      data-slot="kbd"
      className={cn(
        "bg-muted text-muted-foreground pointer-events-none inline-flex h-5 w-fit min-w-5 items-center justify-center gap-1 rounded-sm px-1 font-sans text-xs font-medium select-none",
        "[&_svg:not([class*='size-'])]:size-3",
        "[[data-slot=tooltip-content]_&]:bg-background/20 [[data-slot=tooltip-content]_&]:text-background dark:[[data-slot=tooltip-content]_&]:bg-background/10",
        className
      )}
      {...props}
    />
  )
}

function KbdGroup({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <kbd
      data-slot="kbd-group"
      className={cn("inline-flex items-center gap-1", className)}
      {...props}
    />
  )
}

export { Kbd, KbdGroup }
</file>

<file path="frontend2/components/ui/label.tsx">
"use client"

import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"

import { cn } from "@/lib/utils"

function Label({
  className,
  ...props
}: React.ComponentProps<typeof LabelPrimitive.Root>) {
  return (
    <LabelPrimitive.Root
      data-slot="label"
      className={cn(
        "flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50",
        className
      )}
      {...props}
    />
  )
}

export { Label }
</file>

<file path="frontend2/components/ui/popover.tsx">
"use client"

import * as React from "react"
import * as PopoverPrimitive from "@radix-ui/react-popover"

import { cn } from "@/lib/utils"

const Popover = PopoverPrimitive.Root

const PopoverTrigger = PopoverPrimitive.Trigger

const PopoverContent = React.forwardRef<
    React.ElementRef<typeof PopoverPrimitive.Content>,
    React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>
>(({ className, align = "center", sideOffset = 4, ...props }, ref) => (
    <PopoverPrimitive.Portal>
        <PopoverPrimitive.Content
            ref={ref}
            align={align}
            sideOffset={sideOffset}
            className={cn(
                "z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
                className
            )}
            {...props}
        />
    </PopoverPrimitive.Portal>
))
PopoverContent.displayName = PopoverPrimitive.Content.displayName

export { Popover, PopoverTrigger, PopoverContent }
</file>

<file path="frontend2/components/ui/progress.tsx">
"use client"

import * as React from "react"
import * as ProgressPrimitive from "@radix-ui/react-progress"

import { cn } from "@/lib/utils"

function Progress({
  className,
  value,
  ...props
}: React.ComponentProps<typeof ProgressPrimitive.Root>) {
  return (
    <ProgressPrimitive.Root
      data-slot="progress"
      className={cn(
        "bg-primary/20 relative h-2 w-full overflow-hidden rounded-full",
        className
      )}
      {...props}
    >
      <ProgressPrimitive.Indicator
        data-slot="progress-indicator"
        className="bg-primary h-full w-full flex-1 transition-all"
        style={{ transform: `translateX(-${100 - (value || 0)}%)` }}
      />
    </ProgressPrimitive.Root>
  )
}

export { Progress }
</file>

<file path="frontend2/components/ui/select.tsx">
"use client"

import * as React from "react"
import * as SelectPrimitive from "@radix-ui/react-select"
import { CheckIcon, ChevronDownIcon, ChevronUpIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Select({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Root>) {
  return <SelectPrimitive.Root data-slot="select" {...props} />
}

function SelectGroup({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Group>) {
  return <SelectPrimitive.Group data-slot="select-group" {...props} />
}

function SelectValue({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Value>) {
  return <SelectPrimitive.Value data-slot="select-value" {...props} />
}

function SelectTrigger({
  className,
  size = "default",
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Trigger> & {
  size?: "sm" | "default"
}) {
  return (
    <SelectPrimitive.Trigger
      data-slot="select-trigger"
      data-size={size}
      className={cn(
        "border-input data-[placeholder]:text-muted-foreground [&_svg:not([class*='text-'])]:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 dark:hover:bg-input/50 flex w-fit items-center justify-between gap-2 rounded-md border bg-transparent px-3 py-2 text-sm whitespace-nowrap shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 data-[size=default]:h-9 data-[size=sm]:h-8 *:data-[slot=select-value]:line-clamp-1 *:data-[slot=select-value]:flex *:data-[slot=select-value]:items-center *:data-[slot=select-value]:gap-2 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      {children}
      <SelectPrimitive.Icon asChild>
        <ChevronDownIcon className="size-4 opacity-50" />
      </SelectPrimitive.Icon>
    </SelectPrimitive.Trigger>
  )
}

function SelectContent({
  className,
  children,
  position = "popper",
  align = "center",
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Content>) {
  return (
    <SelectPrimitive.Portal>
      <SelectPrimitive.Content
        data-slot="select-content"
        className={cn(
          "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 relative z-50 max-h-(--radix-select-content-available-height) min-w-[8rem] origin-(--radix-select-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border shadow-md",
          position === "popper" &&
            "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
          className
        )}
        position={position}
        align={align}
        {...props}
      >
        <SelectScrollUpButton />
        <SelectPrimitive.Viewport
          className={cn(
            "p-1",
            position === "popper" &&
              "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)] scroll-my-1"
          )}
        >
          {children}
        </SelectPrimitive.Viewport>
        <SelectScrollDownButton />
      </SelectPrimitive.Content>
    </SelectPrimitive.Portal>
  )
}

function SelectLabel({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Label>) {
  return (
    <SelectPrimitive.Label
      data-slot="select-label"
      className={cn("text-muted-foreground px-2 py-1.5 text-xs", className)}
      {...props}
    />
  )
}

function SelectItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Item>) {
  return (
    <SelectPrimitive.Item
      data-slot="select-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground relative flex w-full cursor-default items-center gap-2 rounded-sm py-1.5 pr-8 pl-2 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4 *:[span]:last:flex *:[span]:last:items-center *:[span]:last:gap-2",
        className
      )}
      {...props}
    >
      <span className="absolute right-2 flex size-3.5 items-center justify-center">
        <SelectPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </SelectPrimitive.ItemIndicator>
      </span>
      <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
    </SelectPrimitive.Item>
  )
}

function SelectSeparator({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Separator>) {
  return (
    <SelectPrimitive.Separator
      data-slot="select-separator"
      className={cn("bg-border pointer-events-none -mx-1 my-1 h-px", className)}
      {...props}
    />
  )
}

function SelectScrollUpButton({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.ScrollUpButton>) {
  return (
    <SelectPrimitive.ScrollUpButton
      data-slot="select-scroll-up-button"
      className={cn(
        "flex cursor-default items-center justify-center py-1",
        className
      )}
      {...props}
    >
      <ChevronUpIcon className="size-4" />
    </SelectPrimitive.ScrollUpButton>
  )
}

function SelectScrollDownButton({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.ScrollDownButton>) {
  return (
    <SelectPrimitive.ScrollDownButton
      data-slot="select-scroll-down-button"
      className={cn(
        "flex cursor-default items-center justify-center py-1",
        className
      )}
      {...props}
    >
      <ChevronDownIcon className="size-4" />
    </SelectPrimitive.ScrollDownButton>
  )
}

export {
  Select,
  SelectContent,
  SelectGroup,
  SelectItem,
  SelectLabel,
  SelectScrollDownButton,
  SelectScrollUpButton,
  SelectSeparator,
  SelectTrigger,
  SelectValue,
}
</file>

<file path="frontend2/components/ui/separator.tsx">
"use client"

import * as React from "react"
import * as SeparatorPrimitive from "@radix-ui/react-separator"

import { cn } from "@/lib/utils"

function Separator({
  className,
  orientation = "horizontal",
  decorative = true,
  ...props
}: React.ComponentProps<typeof SeparatorPrimitive.Root>) {
  return (
    <SeparatorPrimitive.Root
      data-slot="separator"
      decorative={decorative}
      orientation={orientation}
      className={cn(
        "bg-border shrink-0 data-[orientation=horizontal]:h-px data-[orientation=horizontal]:w-full data-[orientation=vertical]:h-full data-[orientation=vertical]:w-px",
        className
      )}
      {...props}
    />
  )
}

export { Separator }
</file>

<file path="frontend2/components/ui/sheet.tsx">
"use client"

import * as React from "react"
import * as SheetPrimitive from "@radix-ui/react-dialog"
import { XIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Sheet({ ...props }: React.ComponentProps<typeof SheetPrimitive.Root>) {
  return <SheetPrimitive.Root data-slot="sheet" {...props} />
}

function SheetTrigger({
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Trigger>) {
  return <SheetPrimitive.Trigger data-slot="sheet-trigger" {...props} />
}

function SheetClose({
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Close>) {
  return <SheetPrimitive.Close data-slot="sheet-close" {...props} />
}

function SheetPortal({
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Portal>) {
  return <SheetPrimitive.Portal data-slot="sheet-portal" {...props} />
}

function SheetOverlay({
  className,
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Overlay>) {
  return (
    <SheetPrimitive.Overlay
      data-slot="sheet-overlay"
      className={cn(
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50",
        className
      )}
      {...props}
    />
  )
}

function SheetContent({
  className,
  children,
  side = "right",
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Content> & {
  side?: "top" | "right" | "bottom" | "left"
}) {
  return (
    <SheetPortal>
      <SheetOverlay />
      <SheetPrimitive.Content
        data-slot="sheet-content"
        className={cn(
          "bg-background data-[state=open]:animate-in data-[state=closed]:animate-out fixed z-50 flex flex-col gap-4 shadow-lg transition ease-in-out data-[state=closed]:duration-300 data-[state=open]:duration-500",
          side === "right" &&
            "data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right inset-y-0 right-0 h-full w-3/4 border-l sm:max-w-sm",
          side === "left" &&
            "data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left inset-y-0 left-0 h-full w-3/4 border-r sm:max-w-sm",
          side === "top" &&
            "data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top inset-x-0 top-0 h-auto border-b",
          side === "bottom" &&
            "data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom inset-x-0 bottom-0 h-auto border-t",
          className
        )}
        {...props}
      >
        {children}
        <SheetPrimitive.Close className="ring-offset-background focus:ring-ring data-[state=open]:bg-secondary absolute top-4 right-4 rounded-xs opacity-70 transition-opacity hover:opacity-100 focus:ring-2 focus:ring-offset-2 focus:outline-hidden disabled:pointer-events-none">
          <XIcon className="size-4" />
          <span className="sr-only">Close</span>
        </SheetPrimitive.Close>
      </SheetPrimitive.Content>
    </SheetPortal>
  )
}

function SheetHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="sheet-header"
      className={cn("flex flex-col gap-1.5 p-4", className)}
      {...props}
    />
  )
}

function SheetFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="sheet-footer"
      className={cn("mt-auto flex flex-col gap-2 p-4", className)}
      {...props}
    />
  )
}

function SheetTitle({
  className,
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Title>) {
  return (
    <SheetPrimitive.Title
      data-slot="sheet-title"
      className={cn("text-foreground font-semibold", className)}
      {...props}
    />
  )
}

function SheetDescription({
  className,
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Description>) {
  return (
    <SheetPrimitive.Description
      data-slot="sheet-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

export {
  Sheet,
  SheetTrigger,
  SheetClose,
  SheetContent,
  SheetHeader,
  SheetFooter,
  SheetTitle,
  SheetDescription,
}
</file>

<file path="frontend2/components/ui/skeleton.tsx">
import { cn } from "@/lib/utils"

function Skeleton({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="skeleton"
      className={cn("bg-accent animate-pulse rounded-md", className)}
      {...props}
    />
  )
}

export { Skeleton }
</file>

<file path="frontend2/components/ui/sonner.tsx">
"use client"

import {
  CircleCheckIcon,
  InfoIcon,
  Loader2Icon,
  OctagonXIcon,
  TriangleAlertIcon,
} from "lucide-react"
import { useTheme } from "next-themes"
import { Toaster as Sonner, type ToasterProps } from "sonner"

const Toaster = ({ ...props }: ToasterProps) => {
  const { theme = "system" } = useTheme()

  return (
    <Sonner
      theme={theme as ToasterProps["theme"]}
      position="top-center"
      richColors
      className="toaster group"
      icons={{
        success: <CircleCheckIcon className="size-4" />,
        info: <InfoIcon className="size-4" />,
        warning: <TriangleAlertIcon className="size-4" />,
        error: <OctagonXIcon className="size-4" />,
        loading: <Loader2Icon className="size-4 animate-spin" />,
      }}
      style={
        {
          "--normal-bg": "var(--popover)",
          "--normal-text": "var(--popover-foreground)",
          "--normal-border": "var(--border)",
          "--border-radius": "var(--radius)",
        } as React.CSSProperties
      }
      {...props}
    />
  )
}

export { Toaster }
</file>

<file path="frontend2/components/ui/switch.tsx">
"use client"

import * as React from "react"
import * as SwitchPrimitive from "@radix-ui/react-switch"

import { cn } from "@/lib/utils"

function Switch({
  className,
  ...props
}: React.ComponentProps<typeof SwitchPrimitive.Root>) {
  return (
    <SwitchPrimitive.Root
      data-slot="switch"
      className={cn(
        "peer data-[state=checked]:bg-primary data-[state=unchecked]:bg-input focus-visible:border-ring focus-visible:ring-ring/50 dark:data-[state=unchecked]:bg-input/80 inline-flex h-[1.15rem] w-8 shrink-0 items-center rounded-full border border-transparent shadow-xs transition-all outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    >
      <SwitchPrimitive.Thumb
        data-slot="switch-thumb"
        className={cn(
          "bg-background dark:data-[state=unchecked]:bg-foreground dark:data-[state=checked]:bg-primary-foreground pointer-events-none block size-4 rounded-full ring-0 transition-transform data-[state=checked]:translate-x-[calc(100%-2px)] data-[state=unchecked]:translate-x-0"
        )}
      />
    </SwitchPrimitive.Root>
  )
}

export { Switch }
</file>

<file path="frontend2/components/ui/table.tsx">
"use client"

import * as React from "react"

import { cn } from "@/lib/utils"

function Table({ className, ...props }: React.ComponentProps<"table">) {
  return (
    <div
      data-slot="table-container"
      className="relative w-full overflow-x-auto"
    >
      <table
        data-slot="table"
        className={cn("w-full caption-bottom text-sm", className)}
        {...props}
      />
    </div>
  )
}

function TableHeader({ className, ...props }: React.ComponentProps<"thead">) {
  return (
    <thead
      data-slot="table-header"
      className={cn("[&_tr]:border-b", className)}
      {...props}
    />
  )
}

function TableBody({ className, ...props }: React.ComponentProps<"tbody">) {
  return (
    <tbody
      data-slot="table-body"
      className={cn("[&_tr:last-child]:border-0", className)}
      {...props}
    />
  )
}

function TableFooter({ className, ...props }: React.ComponentProps<"tfoot">) {
  return (
    <tfoot
      data-slot="table-footer"
      className={cn(
        "bg-muted/50 border-t font-medium [&>tr]:last:border-b-0",
        className
      )}
      {...props}
    />
  )
}

function TableRow({ className, ...props }: React.ComponentProps<"tr">) {
  return (
    <tr
      data-slot="table-row"
      className={cn(
        "hover:bg-muted/50 data-[state=selected]:bg-muted border-b transition-colors",
        className
      )}
      {...props}
    />
  )
}

function TableHead({ className, ...props }: React.ComponentProps<"th">) {
  return (
    <th
      data-slot="table-head"
      className={cn(
        "text-foreground h-10 px-2 text-left align-middle font-medium whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
        className
      )}
      {...props}
    />
  )
}

function TableCell({ className, ...props }: React.ComponentProps<"td">) {
  return (
    <td
      data-slot="table-cell"
      className={cn(
        "p-2 align-middle whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
        className
      )}
      {...props}
    />
  )
}

function TableCaption({
  className,
  ...props
}: React.ComponentProps<"caption">) {
  return (
    <caption
      data-slot="table-caption"
      className={cn("text-muted-foreground mt-4 text-sm", className)}
      {...props}
    />
  )
}

export {
  Table,
  TableHeader,
  TableBody,
  TableFooter,
  TableHead,
  TableRow,
  TableCell,
  TableCaption,
}
</file>

<file path="frontend2/components/ui/tabs.tsx">
"use client"

import * as React from "react"
import * as TabsPrimitive from "@radix-ui/react-tabs"

import { cn } from "@/lib/utils"

function Tabs({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Root>) {
  return (
    <TabsPrimitive.Root
      data-slot="tabs"
      className={cn("flex flex-col gap-2", className)}
      {...props}
    />
  )
}

function TabsList({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.List>) {
  return (
    <TabsPrimitive.List
      data-slot="tabs-list"
      className={cn(
        "bg-muted text-muted-foreground inline-flex h-9 w-fit items-center justify-center rounded-lg p-[3px]",
        className
      )}
      {...props}
    />
  )
}

function TabsTrigger({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Trigger>) {
  return (
    <TabsPrimitive.Trigger
      data-slot="tabs-trigger"
      className={cn(
        "data-[state=active]:bg-background dark:data-[state=active]:text-foreground focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:outline-ring dark:data-[state=active]:border-input dark:data-[state=active]:bg-input/30 text-foreground dark:text-muted-foreground inline-flex h-[calc(100%-1px)] flex-1 items-center justify-center gap-1.5 rounded-md border border-transparent px-2 py-1 text-sm font-medium whitespace-nowrap transition-[color,box-shadow] focus-visible:ring-[3px] focus-visible:outline-1 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:shadow-sm [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    />
  )
}

function TabsContent({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Content>) {
  return (
    <TabsPrimitive.Content
      data-slot="tabs-content"
      className={cn("flex-1 outline-none", className)}
      {...props}
    />
  )
}

export { Tabs, TabsList, TabsTrigger, TabsContent }
</file>

<file path="frontend2/components/ui/textarea.tsx">
import * as React from "react"

import { cn } from "@/lib/utils"

function Textarea({ className, ...props }: React.ComponentProps<"textarea">) {
    return (
        <textarea
            data-slot="textarea"
            className={cn(
                "border-input placeholder:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive flex field-sizing-content min-h-16 w-full rounded-md border bg-transparent px-3 py-2 text-base shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
                className
            )}
            {...props}
        />
    )
}

export { Textarea }
</file>

<file path="frontend2/components/auth-loading.tsx">
"use client";

import { useAuth } from "@/context/auth-context";
import { Skeleton } from "@/components/ui/skeleton";
import { usePathname } from "next/navigation";
import { DashboardSkeleton } from "@/components/skeletons/dashboard-skeleton";
import { GeneralCatalogSkeleton } from "@/components/skeletons/general-catalog-skeleton";
import { SpecificCatalogSkeleton } from "@/components/skeletons/specific-catalog-skeleton";

export function AuthLoading({ children }: { children: React.ReactNode }) {
    const { isLoading } = useAuth();
    const pathname = usePathname();

    // Don't show skeleton on login page
    if (pathname === "/login") {
        return <>{children}</>;
    }

    if (isLoading) {
        // Determine which skeleton to show based on the route
        let ContentSkeleton = DashboardSkeleton; // Default

        if (pathname === "/admin/dashboard") {
            ContentSkeleton = DashboardSkeleton;
        } else if (pathname === "/admin/config/general") {
            ContentSkeleton = GeneralCatalogSkeleton;
        } else if (pathname?.startsWith("/admin/config/general/")) {
            ContentSkeleton = SpecificCatalogSkeleton;
        }

        return (
            <div className="min-h-screen bg-background">
                {/* Sidebar Skeleton - Fixed */}
                <div className="hidden md:block fixed left-0 top-0 h-screen w-64 border-r bg-card z-40">
                    <div className="h-14 border-b flex items-center px-6">
                        <Skeleton className="h-8 w-32" />
                    </div>
                    <div className="p-4 space-y-4">
                        <div className="flex items-center gap-2 px-2">
                            <Skeleton className="h-10 w-10 rounded-lg" />
                            <Skeleton className="h-6 w-32" />
                        </div>
                        <div className="flex flex-col gap-2 mt-4">
                            {Array.from({ length: 8 }).map((_, i) => (
                                <Skeleton key={i} className="h-10 w-full rounded-md" />
                            ))}
                        </div>
                    </div>
                </div>

                {/* Header Skeleton - Fixed */}
                <div className="fixed top-0 right-0 left-0 md:left-64 h-14 border-b bg-background z-30 flex items-center justify-between px-6">
                    <Skeleton className="h-5 w-48" />
                    <div className="flex gap-4">
                        <Skeleton className="h-9 w-9 rounded-full" />
                        <Skeleton className="h-9 w-9 rounded-full" />
                    </div>
                </div>

                {/* Main Content Skeleton */}
                <main className="pt-14 transition-all duration-300 ml-0 md:ml-64">
                    <ContentSkeleton showBreadcrumbs={true} className="p-6" />
                </main>
            </div>
        );
    }

    return <>{children}</>;
}
</file>

<file path="frontend2/components/iutirla-logo.tsx">
import Image from "next/image";
import { cn } from "@/lib/utils";

interface IutirlaLogoProps {
    collapsed?: boolean;
    className?: string;
}

export function IutirlaLogo({ collapsed, className }: IutirlaLogoProps) {
    return (
        <div className={cn("flex items-center gap-1 cursor-pointer", className)}>
            <div className={cn("flex items-center justify-center shrink-0", collapsed ? "w-16 h-14" : "ml-3 h-14")}>
                <Image
                    src="/images/logoiutirla.webp"
                    alt="Logo de IUTIRLA"
                    width={256}
                    height={351}
                    className="h-10 w-auto"
                />
            </div>
            {!collapsed && (
                <div className="relative h-10 flex items-center font-montserrat text-2xl italic font-bold animate-in fade-in duration-300 whitespace-nowrap">
                    <span>IUTIRLA</span>
                    <span className="absolute top-0 font-semibold -right-4 text-[8px]">HCM</span>
                </div>
            )}
        </div>
    )
}
</file>

<file path="frontend2/components/login-form.tsx">
"use client";

import { cn } from "@/lib/utils"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import Link from "next/link"
import { useAuth } from "@/context/auth-context"
import { useState } from "react"
import { Loader2, AlertCircle } from "lucide-react"
import { Alert, AlertDescription, AlertTitle } from "@/components/ui/alert"
import { zodResolver } from "@hookform/resolvers/zod"
import { useForm } from "react-hook-form"
import { z } from "zod"
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from "@/components/ui/form"

const formSchema = z.object({
  username: z.string().min(1, {
    message: "El usuario es requerido.",
  }),
  password: z.string().min(1, {
    message: "La contraseña es requerida.",
  }),
})

export function LoginForm({
  className,
  ...props
}: React.ComponentProps<"div">) {
  const { login } = useAuth();
  const [error, setError] = useState<string | null>(null);
  const [isLoading, setIsLoading] = useState(false);

  const form = useForm<z.infer<typeof formSchema>>({
    resolver: zodResolver(formSchema),
    defaultValues: {
      username: "",
      password: "",
    },
  })

  async function onSubmit(values: z.infer<typeof formSchema>) {
    setError(null);
    setIsLoading(true);

    try {
      await login(values.username, values.password);
    } catch (err: any) {
      // console.error("Login error:", err);
      if (err.response) {
        if (err.response.status === 400) {
          // Field validation errors
          const data = err.response.data;
          if (data.non_field_errors) {
            setError(data.non_field_errors[0]);
          } else if (data.detail) {
            setError(data.detail);
          } else {
            // Set field errors in react-hook-form
            Object.keys(data).forEach((key) => {
              if (key === "username" || key === "password") {
                form.setError(key as "username" | "password", {
                  type: "manual",
                  message: data[key][0],
                });
              }
            });
          }
        } else if (err.response.status === 401) {
          const data = err.response.data;
          setError(data.detail || "Credenciales inválidas. Por favor verifique su usuario y contraseña.");
        } else {
          setError("Ocurrió un error al iniciar sesión. Intente nuevamente.");
        }
      } else {
        setError("Error de conexión. Verifique su internet.");
      }
    } finally {
      setIsLoading(false);
    }
  }

  return (
    <div className={cn("flex flex-col gap-6", className)} {...props}>
      <div className="flex flex-col items-center gap-2 text-center">
        <h1 className="text-2xl font-bold">Iniciar sesión</h1>
        <p className="text-muted-foreground text-sm text-balance">
          Ingrese sus credenciales
        </p>
      </div>

      {error && (
        <Alert variant="destructive">
          <AlertCircle className="h-4 w-4" />
          <AlertTitle>Error</AlertTitle>
          <AlertDescription>
            {error}
          </AlertDescription>
        </Alert>
      )}

      <Form {...form}>
        <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
          <FormField
            control={form.control}
            name="username"
            render={({ field }) => (
              <FormItem>
                <FormLabel>Usuario</FormLabel>
                <FormControl>
                  <Input placeholder="" {...field} disabled={isLoading} />
                </FormControl>
                <FormMessage />
              </FormItem>
            )}
          />
          <FormField
            control={form.control}
            name="password"
            render={({ field }) => (
              <FormItem>
                <FormLabel>Contraseña</FormLabel>
                <FormControl>
                  <Input type="password" placeholder="" {...field} disabled={isLoading} />
                </FormControl>
                <FormMessage />
              </FormItem>
            )}
          />

          <div className="pt-2">
            <Button type="submit" disabled={isLoading} className="w-full bg-brand-primary hover:bg-brand-primary/90">
              {isLoading ? (
                <>
                  <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                  Iniciando...
                </>
              ) : (
                "Iniciar sesión"
              )}
            </Button>
          </div>

          <div className="flex justify-end">
            <Link href="#" className="text-sm text-end underline-offset-4 hover:underline hover:text-primary">
              ¿Olvidaste tu contraseña?
            </Link>
          </div>
        </form>
      </Form>
    </div>
  )
}
</file>

<file path="frontend2/components/protected-route.tsx">
"use client";

import { useAuth } from "@/context/auth-context";
import { useRouter, usePathname } from "next/navigation";
import { useEffect } from "react";
import { AuthLoading } from "./auth-loading";

interface ProtectedRouteProps {
    children: React.ReactNode;
    requireAdmin?: boolean;
}

export function ProtectedRoute({ children, requireAdmin = false }: ProtectedRouteProps) {
    const { user, isLoading } = useAuth();
    const router = useRouter();
    const pathname = usePathname();

    useEffect(() => {
        if (!isLoading) {
            let targetPath = null;

            if (!user) {
                targetPath = `/login?returnUrl=${encodeURIComponent(pathname)}`;
            } else if (requireAdmin && !user.is_staff) {
                targetPath = '/';
            }

            if (targetPath) {
                router.replace(targetPath);
            }
        }
    }, [user, isLoading, requireAdmin, router, pathname]);

    const isAuthenticated = user && (!requireAdmin || user.is_staff);

    if (isLoading || !isAuthenticated) {
        // Reuse the AuthLoading component for consistency, or just show nothing while redirecting
        // Since AuthLoading handles isLoading internally, we can use it here if we want the skeleton
        // But here we might want to block rendering until we are sure.
        // If !isAuthenticated and !isLoading, we are redirecting, so showing a loader or skeleton is fine.
        return (
            <AuthLoading>
                <div />
            </AuthLoading>
        );
    }

    return <>{children}</>;
}
</file>

<file path="frontend2/components/providers.tsx">
"use client";

import { AuthProvider } from "@/context/auth-context";
import { AuthLoading } from "@/components/auth-loading";
import { Toaster } from "@/components/ui/sonner";

export function Providers({ children }: { children: React.ReactNode }) {
    return (
        <AuthProvider>
            <AuthLoading>
                {children}
                <Toaster position="top-center" theme="light" richColors />
            </AuthLoading>
        </AuthProvider>
    );
}
</file>

<file path="frontend2/components/task-sheet.tsx">
import { Button } from "@/components/ui/button";
import {
    Sheet,
    SheetContent,
    SheetDescription,
    SheetHeader,
    SheetTitle,
    SheetTrigger,
} from "@/components/ui/sheet";
import { CheckCircle, Clock, AlertCircle, ArrowRight } from "lucide-react";
import { cn } from "@/lib/utils";

const tasks = [
    {
        id: 1,
        title: "Revisar nómina quincenal",
        status: "pending",
        priority: "high",
        dueDate: "Hoy, 5:00 PM"
    },
    {
        id: 2,
        title: "Aprobar vacaciones de J. Pérez",
        status: "in-progress",
        priority: "medium",
        dueDate: "Mañana, 10:00 AM"
    },
    {
        id: 3,
        title: "Actualizar manual de organización",
        status: "pending",
        priority: "low",
        dueDate: "Viernes, 12:00 PM"
    },
    {
        id: 4,
        title: "Entrevista con candidato Sr.",
        status: "completed",
        priority: "high",
        dueDate: "Ayer"
    }
];

export function TaskSheet() {
    return (
        <Sheet>
            <SheetTrigger asChild>
                <Button variant="ghost" size="icon" aria-label="Tareas" className="text-primary-foreground hover:bg-primary-foreground/10 hover:text-primary-foreground">
                    <CheckCircle className="size-5" />
                </Button>
            </SheetTrigger>

            <SheetContent className="w-[400px] sm:w-[540px] flex flex-col h-full py-6 px-4">
                <SheetHeader className="pb-4 border-b border-border">
                    <SheetTitle className="flex items-center gap-2 text-xl">
                        <CheckCircle className="size-5 text-brand-primary" />
                        <span>Lista de tareas</span>
                    </SheetTitle>
                </SheetHeader>

                <div className="flex-1 overflow-y-auto">
                    <div className="space-y-4">
                        {tasks.map((task) => (
                            <div
                                key={task.id}
                                className="group flex items-start gap-3 p-4 rounded-xl border border-border bg-card hover:shadow-md hover:border-brand-primary/50 transition-all duration-200"
                            >
                                <div className={cn(
                                    "mt-1 size-2 rounded-full shrink-0",
                                    task.priority === "high" ? "bg-destructive" :
                                        task.priority === "medium" ? "bg-brand-tertiary" :
                                            "bg-brand-secondary"
                                )} />

                                <div className="flex-1 min-w-0">
                                    <h4 className={cn(
                                        "text-sm font-semibold text-foreground mb-1 group-hover:text-brand-primary transition-colors",
                                        task.status === "completed" && "line-through text-muted-foreground"
                                    )}>
                                        {task.title}
                                    </h4>

                                    <div className="flex items-center gap-3 text-xs text-muted-foreground">
                                        <div className="flex items-center gap-1">
                                            <Clock className="size-3" />
                                            <span>{task.dueDate}</span>
                                        </div>

                                        <span className={cn(
                                            "px-2 py-0.5 rounded-full text-[10px] font-medium capitalize",
                                            task.status === "pending" ? "bg-brand-tertiary/10 text-brand-tertiary" :
                                                task.status === "in-progress" ? "bg-brand-primary/10 text-brand-primary" :
                                                    "bg-brand-secondary/10 text-brand-secondary"
                                        )}>
                                            {task.status === "in-progress" ? "En curso" :
                                                task.status === "pending" ? "Pendiente" : "Completada"}
                                        </span>
                                    </div>
                                </div>

                                <Button variant="ghost" size="icon" className="h-8 w-8 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <ArrowRight className="size-4 text-muted-foreground hover:text-foreground" />
                                </Button>
                            </div>
                        ))}
                    </div>
                </div>

                <div className="pt-4 mt-auto border-t border-border">
                    <Button className="w-full bg-brand-primary hover:bg-brand-primary/90 text-white">
                        Ver todas las tareas
                    </Button>
                </div>
            </SheetContent>
        </Sheet>
    );
}
</file>

<file path="frontend2/context/auth-context.tsx">
'use client';

import { createContext, useState, useContext, useEffect, ReactNode } from "react";
import apiClient from "../lib/api-client";
import { useRouter } from "next/navigation";

// --- Tipos ---

// Definimos Person alineado con tu backend
export interface Person {
    id: number;
    first_name: string;
    second_name?: string | null;
    paternal_surname: string;
    maternal_surname?: string | null;
    photo?: string | null;
    birthdate?: string | null;
}

// Definimos User alineado con tu backend
export interface User {
    pk: number;
    username: string;
    is_staff: boolean;
    person: Person | null;
}

interface AuthContextType {
    user: User | null;
    isLoading: boolean;
    login: (username: string, password: string) => Promise<void>;
    logout: () => void;
}

const AuthContext = createContext<AuthContextType | null>(null);

export const AuthProvider = ({ children }: { children: ReactNode }) => {
    const [user, setUser] = useState<User | null>(null);
    const [isLoading, setIsLoading] = useState(true);
    const router = useRouter();

    // 1. Inicialización: Recuperar sesión y refrescar datos
    useEffect(() => {
        const initAuth = async () => {
            const storedToken = localStorage.getItem("access_token");

            if (storedToken) {
                try {
                    // 1. Restaurar header
                    if (apiClient.defaults.headers.common) {
                        apiClient.defaults.headers.common["Authorization"] = `Bearer ${storedToken}`;
                    }

                    // 2. Obtener datos frescos del usuario
                    const { data } = await apiClient.get("/api/auth/user/");

                    // 3. Actualizar estado y storage
                    setUser(data);
                    localStorage.setItem("user", JSON.stringify(data));

                } catch (e: any) {
                    console.error("Error validando sesión", e);
                    // Si el token es inválido (401/403), cerramos sesión
                    if (e.response && (e.response.status === 401 || e.response.status === 403)) {
                        localStorage.removeItem("user");
                        localStorage.removeItem("access_token");
                        if (apiClient.defaults.headers.common) {
                            delete apiClient.defaults.headers.common["Authorization"];
                        }
                        setUser(null);
                    } else {
                        // Si es otro error (ej. red), intentamos usar lo que hay en storage como fallback
                        const storedUser = localStorage.getItem("user");
                        if (storedUser) {
                            try {
                                setUser(JSON.parse(storedUser));
                            } catch (parseError) {
                                console.error("Error parsing stored user fallback", parseError);
                            }
                        }
                    }
                }
            }
            setIsLoading(false);
        };

        initAuth();
    }, []);

    // 2. Login
    const login = async (username: string, password: string) => {
        try {
            // Solicitud al backend
            const response = await apiClient.post("/api/auth/login/", {
                username,
                password,
            });

            const { access, user: userData } = response.data;
            const typedUser = userData as User;

            // Actualizar Estados y Storage
            setUser(typedUser);
            localStorage.setItem("user", JSON.stringify(typedUser));
            localStorage.setItem("access_token", access);

            // Configurar Axios para futuras peticiones
            if (apiClient.defaults.headers.common) {
                apiClient.defaults.headers.common["Authorization"] = `Bearer ${access}`;
            }

            // Redirección basada en rol
            if (typedUser.is_staff) {
                router.push("/admin/dashboard");
            } else {
                router.push("/");
            }

        } catch (error) {
            throw error;
        }
    };

    // 3. Logout
    const logout = async () => {
        try {
            await apiClient.post("/api/auth/logout/");
        } catch (error) {
            console.warn("Logout en servidor falló, cerrando sesión local.", error);
        } finally {
            setUser(null);
            localStorage.removeItem("user");
            localStorage.removeItem("access_token");

            if (apiClient.defaults.headers.common) {
                delete apiClient.defaults.headers.common["Authorization"];
            }

            router.push("/login");
        }
    };

    return (
        <AuthContext.Provider value={{ user, login, logout, isLoading }}>
            {children}
        </AuthContext.Provider>
    );
};

export const useAuth = () => {
    const context = useContext(AuthContext);
    if (!context) {
        throw new Error("useAuth debe usarse dentro de un AuthProvider");
    }
    return context;
};
</file>

<file path="frontend2/context/breadcrumb-context.tsx">
"use client";

import React, { createContext, useContext, useState, useCallback } from "react";

interface BreadcrumbContextType {
    labels: Record<string, string>;
    setLabel: (segment: string, label: string) => void;
}

const BreadcrumbContext = createContext<BreadcrumbContextType | undefined>(undefined);

export function BreadcrumbProvider({ children }: { children: React.ReactNode }) {
    const [labels, setLabels] = useState<Record<string, string>>({});

    const setLabel = useCallback((segment: string, label: string) => {
        setLabels((prev) => {
            if (prev[segment] === label) return prev;
            return { ...prev, [segment]: label };
        });
    }, []);

    return (
        <BreadcrumbContext.Provider value={{ labels, setLabel }}>
            {children}
        </BreadcrumbContext.Provider>
    );
}

export function useBreadcrumb() {
    const context = useContext(BreadcrumbContext);
    if (context === undefined) {
        throw new Error("useBreadcrumb must be used within a BreadcrumbProvider");
    }
    return context;
}
</file>

<file path="frontend2/lib/api-client.ts">
import axios, { AxiosError, InternalAxiosRequestConfig, AxiosResponse } from "axios";

// Definimos la estructura de los items en la cola de espera
interface QueueItem {
    resolve: (token: string) => void;
    reject: (error: unknown) => void;
}

// Usamos variable de entorno para no quemar la URL
const baseURL = process.env.NEXT_PUBLIC_API_URL || "http://127.0.0.1:8000";

const apiClient = axios.create({
    baseURL: baseURL,
    withCredentials: true,
    headers: {
        "Content-Type": "application/json",
    },
});

// --- Variables para el Bloqueo de Concurrencia ---
let isRefreshing = false;
let failedQueue: QueueItem[] = [];

// Función para procesar la cola. Recibe un error (si falló) o el nuevo token.
const processQueue = (error: AxiosError | null, token: string | null = null) => {
    failedQueue.forEach((prom) => {
        if (error) {
            prom.reject(error);
        } else if (token) {
            prom.resolve(token);
        }
    });
    failedQueue = [];
};

// --- Interceptor de Petición ---
apiClient.interceptors.request.use(
    (config: InternalAxiosRequestConfig) => {
        // No inyectar token en rutas de auth para evitar conflictos
        if (config.url && (config.url.includes("/auth/login") || config.url.includes("/auth/register"))) {
            return config;
        }

        // Validamos que estemos en el cliente
        if (typeof window !== "undefined") {
            const accessToken = localStorage.getItem("access_token");
            if (accessToken) {
                config.headers.set("Authorization", `Bearer ${accessToken}`);
            }
        }
        return config;
    },
    (error: AxiosError) => Promise.reject(error)
);

// --- Interceptor de Respuesta ---
apiClient.interceptors.response.use(
    (response: AxiosResponse) => response,
    async (error: AxiosError) => {
        const originalRequest = error.config as InternalAxiosRequestConfig & { _retry?: boolean };

        // Si no hay request original (error de red raro), rechazamos
        if (!originalRequest) {
            return Promise.reject(error);
        }

        // 1. PROTECCIÓN ANTI-BUCLE: Si el error viene del refresh endpoint, es el fin.
        if (originalRequest.url?.includes("/token/refresh/")) {
            if (typeof window !== "undefined") {
                localStorage.removeItem("access_token");
                localStorage.removeItem("user");
                window.location.href = '/login';
            }
            return Promise.reject(error);
        }

        // 2. Detección de 401 (Token vencido)
        // Ignoramos 401 si viene del login, ya que eso significa credenciales inválidas, no token vencido.
        if (error.response?.status === 401 && !originalRequest._retry && !originalRequest.url?.includes("/auth/login")) {

            // CASO A: Ya se está refrescando. A la cola.
            if (isRefreshing) {
                return new Promise<AxiosResponse>((resolve, reject) => {
                    failedQueue.push({
                        resolve: (token: string) => {
                            originalRequest.headers.set("Authorization", `Bearer ${token}`);
                            resolve(apiClient(originalRequest));
                        },
                        reject: (err: unknown) => reject(err)
                    });
                });
            }

            // CASO B: Iniciamos el refresco.
            originalRequest._retry = true;
            isRefreshing = true;

            try {
                // Petición de refresco
                const response = await apiClient.post<{ access: string }>("/api/auth/token/refresh/");
                const newAccessToken = response.data.access;

                if (typeof window !== "undefined") {
                    localStorage.setItem("access_token", newAccessToken);
                }

                // Actualizamos defaults
                apiClient.defaults.headers.common["Authorization"] = `Bearer ${newAccessToken}`;

                // Procesamos la cola
                processQueue(null, newAccessToken);

                // Reintentamos la original
                originalRequest.headers.set("Authorization", `Bearer ${newAccessToken}`);
                return apiClient(originalRequest);

            } catch (refreshError) {
                // Si falla, rechazamos toda la cola con el error correspondiente
                // Casteamos a AxiosError si es posible, o pasamos el error tal cual
                const axiosError = refreshError instanceof AxiosError ? refreshError : new AxiosError("Refresh failed");
                processQueue(axiosError, null);

                if (typeof window !== "undefined") {
                    localStorage.removeItem("access_token");
                    localStorage.removeItem("user");
                    window.location.href = '/login';
                }
                return Promise.reject(refreshError);

            } finally {
                isRefreshing = false;
            }
        }

        return Promise.reject(error);
    }
);

export default apiClient;
</file>

<file path="frontend2/lib/command-menu-data.ts">
import {
    User,
    Calendar,
    Settings,
    UserCircle,
    Users
} from "lucide-react";

export const commandSections = [
    {
        heading: 'Sugerencias',
        items: [
            {
                name: 'Calendario',
                icon: Calendar
            }
        ]
    },
    {
        heading: 'Ajustes',
        items: [
            {
                name: 'Perfil',
                icon: UserCircle
            },
            {
                name: 'Ajustes',
                icon: Settings
            }
        ]
    },
    {
        heading: 'Usuarios',
        items: [
            {
                name: 'Santiago Fermin',
                icon: User
            }
        ]
    },
    {
        heading: 'Equipos',
        items: [
            {
                name: 'Coordinacion administrativa',
                icon: Users
            }
        ]
    }
];
</file>

<file path="frontend2/lib/fonts.ts">
import { Montserrat } from 'next/font/google'

export const montserrat = Montserrat({
    weight: ['100', '200', '300', '400', '500', '600', '700', '800', '900'],
    style: ['normal', 'italic'],
    subsets: ['latin'],
    variable: '--font-montserrat'
})
</file>

<file path="frontend2/types/ats.ts">
// Tipos para el módulo ATS (Applicant Tracking System)

export type JobPostingStatus = 'DRAFT' | 'PUBLISHED' | 'CLOSED' | 'FROZEN';
export type CandidateStage = 'NEW' | 'REV' | 'INT' | 'OFF' | 'HIRED' | 'REJ' | 'POOL';

export interface JobPosting {
    id: number;
    title: string;
    position: number;
    position_title?: string;
    department_name?: string;
    description: string;
    location?: string;
    closing_date?: string;
    status: JobPostingStatus;
    ask_education: boolean;
    position_objectives?: string[];
    position_requirements?: string[];
    published_date?: string;
    created_at: string;
    updated_at: string;
    candidates_count?: number;
}

export interface CandidateEducation {
    id: number;
    school_name: string;
    level_name: string;
    field_name: string;
    start_date: string;
    end_date?: string;
}

export interface Candidate {
    id: number;
    job_posting: number;
    job_posting_title?: string;
    first_name: string;
    last_name: string;
    full_name?: string;
    email: string;
    phone?: string;
    phone_area_code?: { id: number; code: string; carrier: string };
    phone_subscriber?: string;
    national_id: string;
    cv_file?: string;
    cv_url?: string;
    avatar?: string;
    stage: CandidateStage;
    stage_display?: string;
    education?: CandidateEducation[];
    applied_date?: string;
    created_at: string;
    updated_at: string;
    notes?: string;
}

export interface HireData {
    hire_date: string;
    role: number;
    employment_type: number;
    employment_status: number;
    salary?: string;
    notes?: string;
}

// Mapeo de etapas a labels legibles
export const CANDIDATE_STAGE_LABELS: Record<CandidateStage, string> = {
    NEW: 'Nuevo',
    REV: 'En revisión',
    INT: 'Entrevista',
    OFF: 'Oferta',
    HIRED: 'Contratado',
    REJ: 'Rechazado',
    POOL: 'Banco de Elegibles',
};

export const JOB_STATUS_LABELS: Record<JobPostingStatus, string> = {
    DRAFT: 'Borrador',
    PUBLISHED: 'Publicada',
    CLOSED: 'Cerrada',
    FROZEN: 'Congelada',
};
</file>

<file path="frontend2/types/performance.ts">
export interface Competency {
    id: number;
    name: string;
    description: string;
    category: string;
    category_display: string;
    is_global: boolean;
    job_titles?: number[];
}

export interface ReviewDetail {
    id?: number;
    competency: number;
    competency_name: string;
    competency_description: string;
    competency_category: string;
    competency_category_display: string;
    score: number;
    comment?: string;
}

export interface PerformanceReview {
    id: number;
    period: number;
    period_name: string;
    employment: number;
    employee_name: string;
    employee_person_id: number;
    position_name: string;
    department_name: string;
    evaluator: number;
    evaluator_name: string;
    evaluator_id: number;
    final_score: number | null;
    status: 'BOR' | 'ENV' | 'ACE';
    status_display: string;
    feedback_manager: string;
    feedback_employee: string;
    created_at: string;
    updated_at: string;
    details?: ReviewDetail[];
}

export interface EvaluationPeriod {
    id: number;
    name: string;
    start_date: string;
    end_date: string;
    is_active: boolean;
}

export const CATEGORY_LABELS: Record<string, string> = {
    CAL: 'Calidad',
    COM: 'Compromiso',
    CMU: 'Comunicación',
    ORG: 'Organización',
    DIS: 'Disciplina',
    PRO: 'Proactividad',
};

export const CATEGORY_COLORS: Record<string, string> = {
    CAL: 'bg-blue-500',
    COM: 'bg-green-500',
    CMU: 'bg-purple-500',
    ORG: 'bg-yellow-500',
    DIS: 'bg-red-500',
    PRO: 'bg-cyan-500',
};
</file>

<file path="frontend2/.gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts
</file>

<file path="frontend2/components.json">
{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "new-york",
  "rsc": true,
  "tsx": true,
  "tailwind": {
    "config": "",
    "css": "app/globals.css",
    "baseColor": "neutral",
    "cssVariables": true,
    "prefix": ""
  },
  "iconLibrary": "lucide",
  "aliases": {
    "components": "@/components",
    "utils": "@/lib/utils",
    "ui": "@/components/ui",
    "lib": "@/lib",
    "hooks": "@/hooks"
  },
  "registries": {}
}
</file>

<file path="frontend2/eslint.config.mjs">
import { defineConfig, globalIgnores } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";
import nextTs from "eslint-config-next/typescript";

const eslintConfig = defineConfig([
  ...nextVitals,
  ...nextTs,
  // Override default ignores of eslint-config-next.
  globalIgnores([
    // Default ignores of eslint-config-next:
    ".next/**",
    "out/**",
    "build/**",
    "next-env.d.ts",
  ]),
]);

export default eslintConfig;
</file>

<file path="frontend2/pnpm-workspace.yaml">
ignoredBuiltDependencies:
  - sharp
  - unrs-resolver
</file>

<file path="frontend2/postcss.config.mjs">
const config = {
  plugins: {
    "@tailwindcss/postcss": {},
  },
};

export default config;
</file>

<file path="frontend2/tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts"
  ],
  "exclude": ["node_modules"]
}
</file>

<file path="backend/accounts/migrations/0001_initial.py">
# Generated by Django 5.2.8 on 2025-11-24 08:15

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('auth', '0012_alter_user_first_name_max_length'),
        ('core', '0001_initial'),
    ]

    operations = [
        migrations.CreateModel(
            name='User',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('password', models.CharField(max_length=128, verbose_name='password')),
                ('last_login', models.DateTimeField(blank=True, null=True, verbose_name='last login')),
                ('is_superuser', models.BooleanField(default=False, help_text='Designates that this user has all permissions without explicitly assigning them.', verbose_name='superuser status')),
                ('username', models.CharField(error_messages={'blank': 'El nombre de usuario es obligatorio.', 'unique': 'Este nombre de usuario ya está registrado.'}, max_length=100, unique=True)),
                ('is_active', models.BooleanField(default=True)),
                ('is_staff', models.BooleanField(default=False)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('groups', models.ManyToManyField(blank=True, help_text='The groups this user belongs to. A user will get all permissions granted to each of their groups.', related_name='user_set', related_query_name='user', to='auth.group', verbose_name='groups')),
                ('person', models.OneToOneField(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='user_account', to='core.person')),
                ('user_permissions', models.ManyToManyField(blank=True, help_text='Specific permissions for this user.', related_name='user_set', related_query_name='user', to='auth.permission', verbose_name='user permissions')),
            ],
            options={
                'abstract': False,
            },
        ),
    ]
</file>

<file path="backend/accounts/views.py">
from rest_framework import viewsets, permissions
from rest_framework.decorators import action
from rest_framework.response import Response
from django.db.models import Exists, OuterRef
from django.db import transaction
from .models import User
from .serializers import UserReadSerializer, EmployeeCreationSerializer

class UserViewSet(viewsets.ModelViewSet):
    queryset = User.objects.all().select_related('person')
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]

    def get_serializer_class(self):
        if self.action == 'create':
            return EmployeeCreationSerializer
        return UserReadSerializer

    @action(detail=False, methods=['get'])
    def check_pending_accounts(self, request):
        """
        Verifica si hay empleados activos sin cuenta de usuario.
        Retorna: { has_pending: bool, count: int }
        """
        from employment.models import Employment, is_active_status
        from core.models import Person
        
        # Obtener personas con contratos activos
        active_employments = Employment.objects.filter(
            current_status__in=['ACT', 'SUS', 'PER', 'REP']
        ).values_list('person_id', flat=True).distinct()
        
        # Filtrar las que NO tienen cuenta
        persons_without_account = Person.objects.filter(
            id__in=active_employments
        ).filter(
            user_account__isnull=True
        )
        
        count = persons_without_account.count()
        
        return Response({
            'has_pending': count > 0,
            'count': count
        })

    @action(detail=False, methods=['post'])
    def bulk_create_employee_accounts(self, request):
        """
        Crea cuentas de usuario para todos los empleados activos que no tienen cuenta.
        Username y password inicial = cédula (número del documento)
        """
        from employment.models import Employment
        from core.models import Person, NationalId
        
        created_accounts = []
        errors = []
        
        with transaction.atomic():
            # 1. Obtener personas con contratos activos
            active_person_ids = Employment.objects.filter(
                current_status__in=['ACT', 'SUS', 'PER', 'REP']
            ).values_list('person_id', flat=True).distinct()
            
            # 2. Filtrar las que NO tienen cuenta
            persons_without_account = Person.objects.filter(
                id__in=active_person_ids,
                user_account__isnull=True
            ).select_related('gender', 'marital_status')
            
            # 3. Crear cuentas
            for person in persons_without_account:
                try:
                    # Obtener cédula principal
                    national_id = person.national_ids.filter(
                        category='CEDULA',
                        is_primary=True
                    ).first()
                    
                    if not national_id:
                        errors.append({
                            'person_id': person.id,
                            'person_name': str(person),
                            'error': 'No tiene cédula registrada'
                        })
                        continue
                    
                    # Extraer número de cédula limpio
                    cedula_number = national_id.number.replace('.', '').replace('-', '').strip()
                    
                    # Generar username: Primera Letra Nombre + Primer Apellido + Últimos 4 dígitos Cédula
                    import unicodedata
                    def normalize_text(text):
                        return ''.join(c for c in unicodedata.normalize('NFD', text) if unicodedata.category(c) != 'Mn').lower()
                    
                    first_initial = normalize_text(person.first_name[0])
                    surname = normalize_text(person.paternal_surname)
                    last_4_digits = cedula_number[-4:].zfill(4)
                    
                    base_username = f"{first_initial}{surname}{last_4_digits}"
                    username = base_username
                    
                    # Manejo de colisiones
                    counter = 1
                    while User.objects.filter(username=username).exists():
                        username = f"{base_username}{counter}"
                        counter += 1
                    
                    # Crear usuario
                    user = User.objects.create_user(
                        username=username,
                        password=cedula_number,  # Password inicial = cédula
                        person=person,
                        is_active=True,
                        is_staff=False
                    )
                    
                    created_accounts.append({
                        'person_id': person.id,
                        'person_name': str(person),
                        'username': username
                    })
                    
                except Exception as e:
                    errors.append({
                        'person_id': person.id,
                        'person_name': str(person),
                        'error': str(e)
                    })
        
        return Response({
            'created_count': len(created_accounts),
            'error_count': len(errors),
            'created_accounts': created_accounts,
            'errors': errors
        })
</file>

<file path="backend/ats/serializers.py">
from rest_framework import serializers
from .models import JobPosting, Candidate, CandidateEducation, CandidateLog
from organization.models import Position, Department
from core.models import PhoneCarrierCode


# --- Serializers para Educación y Experiencia (Anidados) ---

class CandidateEducationSerializer(serializers.ModelSerializer):
    class Meta:
        model = CandidateEducation
        fields = ['id', 'school_name', 'level_name', 'field_name', 'start_date', 'end_date']





class PhoneCarrierCodeSerializer(serializers.ModelSerializer):
    class Meta:
        model = PhoneCarrierCode
        fields = ['id', 'code', 'carrier']


# --- Serializers para JobPosting ---

class JobPostingListSerializer(serializers.ModelSerializer):
    """Serializer para listar vacantes en el portal público (solo campos públicos)"""
    department_name = serializers.CharField(source='position.department.name', read_only=True)
    position_title = serializers.CharField(source='position.job_title.name', read_only=True, allow_null=True)
    candidates_count = serializers.SerializerMethodField()
    
    class Meta:
        model = JobPosting
        fields = [
            'id', 'title', 'location', 
            'department_name', 'position_title',
            'published_date', 'closing_date', 'candidates_count'
        ]
    
    def get_candidates_count(self, obj):
        return obj.candidates.count()


class JobPostingDetailSerializer(serializers.ModelSerializer):
    """Serializer detallado para ver una vacante específica (incluye configuración)"""
    department_name = serializers.CharField(source='position.department.name', read_only=True)
    position_title = serializers.CharField(source='position.job_title.name', read_only=True, allow_null=True)
    position_objective = serializers.CharField(source='position.objective', read_only=True, allow_null=True)
    position_objectives = serializers.SerializerMethodField()
    position_requirements = serializers.SerializerMethodField()
    position_functions = serializers.SerializerMethodField()
    
    class Meta:
        model = JobPosting
        fields = [
            'id', 'title', 'description', 'location',
            'department_name',
            'position', 'position_title', 'position_objective', 
            'position_objectives', 'position_requirements', 'position_functions',
            'ask_education',
            'status', 'published_date', 'closing_date',
            'created_at', 'updated_at'
        ]
    
    
    def get_position_objectives(self, obj):
        # Position has 'objective' (singular TextField), not 'objectives'
        if obj.position and obj.position.objective:
            return [obj.position.objective]  # Return as list for consistency
        return []
    
    def get_position_requirements(self, obj):
        # Position has 'requirements' related_name from PositionRequirement model
        if obj.position:
            return [{'id': r.id, 'description': r.description, 'order': r.id} for r in obj.position.requirements.all()]
        return []
    
    def get_position_functions(self, obj):
        # Position has 'functions' related_name from PositionFunction model
        if obj.position:
            return [{'id': f.id, 'description': f.description, 'order': f.order} for f in obj.position.functions.all()]
        return []


class JobPostingAdminSerializer(serializers.ModelSerializer):
    """Serializer para administración completa de vacantes"""
    candidates_count = serializers.SerializerMethodField()
    department_name = serializers.CharField(source='position.department.name', read_only=True)
    position_title = serializers.CharField(source='position.job_title.name', read_only=True, allow_null=True)
    
    class Meta:
        model = JobPosting
        fields = '__all__'
    
    def get_candidates_count(self, obj):
        return obj.candidates.count()

    def validate(self, data):
        """Validar que la posición tenga cupos disponibles y no haya vacantes duplicadas"""
        position = data.get('position')
        status = data.get('status', 'DRAFT')  # Obtener el estado que se está intentando guardar
        
        # Solo validamos si se está asignando una posición
        if position:
            # 1. Validar que no exista otra vacante PUBLISHED para la misma posición
            # Solo si intentamos publicar esta vacante
            if status == 'PUBLISHED':
                existing_posting = JobPosting.objects.filter(
                    position=position,
                    status='PUBLISHED'
                )
                if self.instance:
                    existing_posting = existing_posting.exclude(pk=self.instance.pk)
                
                if existing_posting.exists():
                    raise serializers.ValidationError({
                        "position": f"Ya existe una vacante publicada para la posición '{position.name or position.job_title.name}'. No se pueden publicar dos vacantes simultáneamente para la misma posición."
                    })

            # 2. Contar empleados activos en esta posición
            from employment.models import Employment, is_active_status
            
            # Obtener todos los empleados de esta posición y filtrar por activos
            all_employments = Employment.objects.filter(position=position)
            active_employees_count = sum(1 for emp in all_employments if is_active_status(emp.current_status))
            
            # Verificar si hay vacantes disponibles
            # Cupos libres = Total Vacantes - Empleados Activos
            if active_employees_count >= position.vacancies:
                raise serializers.ValidationError({
                    "position": f"No se puede crear la vacante. La posición '{position.name or position.job_title.name}' ya está ocupada al 100% ({active_employees_count}/{position.vacancies} ocupados)."
                })
        
        # Validar título solo letras y espacios
        title = data.get('title')
        if title:
            import re
            if not re.match(r'^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$', title):
                raise serializers.ValidationError({"title": "El título solo puede contener letras y espacios."})

        return data


# --- Serializers para Candidate ---

class CandidateCreateSerializer(serializers.ModelSerializer):
    """Serializer para crear candidato desde el portal público (postulación)"""
    education = CandidateEducationSerializer(many=True, required=False)
    class Meta:
        model = Candidate
        fields = [
            'job_posting', 'first_name', 'last_name', 'email',
            'phone_area_code', 'phone_subscriber', 'phone',  # Ambos formatos
            'national_id', 'cv_file', 'avatar',
            'education'
        ]
        extra_kwargs = {
            'phone': {'required': False},  # Opcional, para retrocompatibilidad
            'phone_area_code': {'required': False},
            'phone_subscriber': {'required': False},
        }
    
    def validate_email(self, value):
        """Validar que el email no pertenezca a un empleado existente"""
        from core.models import PersonEmail
        
        if PersonEmail.objects.filter(email_address=value).exists():
            raise serializers.ValidationError(
                "Este correo electrónico ya está registrado en el sistema. "
                "Si ya trabajas en la institución, por favor contacta al departamento de RRHH."
            )
        return value
    
    def validate_national_id(self, value):
        """Validar que la cédula no pertenezca a un empleado existente"""
        from core.models import NationalId
        import re
        
        # El valor puede venir como "V-12345678" o solo "12345678"
        # Limpiar y parsear
        cleaned = value.strip().upper()
        
        # Intentar extraer tipo y número
        match = re.match(r'^([VEJGP])-?(\d+)$', cleaned)
        if match:
            doc_type = match.group(1)
            doc_number = match.group(2)
            
            # Verificar si ya existe en NationalId
            if NationalId.objects.filter(document_type=doc_type, number=doc_number).exists():
                raise serializers.ValidationError(
                    "Esta cédula ya está registrada en el sistema. "
                    "Si ya trabajas en la institución, por favor contacta al departamento de RRHH."
                )
        
        return value

    def to_internal_value(self, data):
        # Si data es un QueryDict (multipart), convertir a dict estándar
        # para evitar problemas al asignar listas de objetos (education)
        if hasattr(data, 'dict') or hasattr(data, '_mutable'):
            data_dict = {}
            for key, value in data.items():
                data_dict[key] = value
            data = data_dict
        
        # Parsear education si viene como JSON string
        if 'education' in data and isinstance(data['education'], str):
            import json
            try:
                data['education'] = json.loads(data['education'])
            except json.JSONDecodeError:
                data['education'] = []
            
        return super().to_internal_value(data)
    
    def validate(self, data):
        """Validación cruzada de teléfono y otros campos"""
        from core.models import PersonPhone
        

        
        # Validar que se proporcione teléfono (en algún formato)
        phone_area_code = data.get('phone_area_code')
        phone_subscriber = data.get('phone_subscriber')
        old_phone = data.get('phone')
        
        # Considerar que los campos pueden venir como strings vacíos
        if phone_area_code and phone_subscriber:
            has_new_format = True
        else:
            has_new_format = False
            
        has_old_format = bool(old_phone and old_phone.strip())
        
        if not (has_new_format or has_old_format):
            raise serializers.ValidationError({
                'phone': 'Debes proporcionar un número de teléfono.'
            })
        
        # Si se usa el nuevo formato, validar contra PersonPhone
        if has_new_format:
            if PersonPhone.objects.filter(carrier_code=phone_area_code, subscriber_number=phone_subscriber).exists():
                raise serializers.ValidationError({
                    'phone_subscriber': (
                        "Este número de teléfono ya está registrado en el sistema. "
                        "Si ya trabajas en la institución, por favor contacta al departamento de RRHH."
                    )
                })
        
        # Validación de email duplicado en misma vacante
        job_posting = data.get('job_posting')
        if job_posting and data.get('email'):
            existing = Candidate.objects.filter(
                job_posting=job_posting,
                email=data['email']
            )
            if existing.exists():
                raise serializers.ValidationError({
                    'email': 'Ya te has postulado a esta vacante con este correo electrónico.'
                })
        
        if job_posting:
            # Validar que se incluya educación si la vacante lo requiere
            if job_posting.ask_education:
                education = data.get('education', [])
                if not education or len(education) == 0:
                    raise serializers.ValidationError({
                        'education': 'Esta vacante requiere información educativa.'
                    })
        
        return data
    
    def create(self, validated_data):
        import json
        
        # Parsear education si viene como JSON string (desde FormData)
        education_data = validated_data.pop('education', [])
        if isinstance(education_data, str):
            try:
                education_data = json.loads(education_data)
            except json.JSONDecodeError:
                education_data = []
        
        # Crear el candidato
        candidate = Candidate.objects.create(**validated_data)
        
        # Crear educación
        for edu in education_data:
            CandidateEducation.objects.create(candidate=candidate, **edu)
        
        return candidate


class CandidateListSerializer(serializers.ModelSerializer):
    """Serializer para listar candidatos (vista administrativa)"""
    job_posting_title = serializers.CharField(source='job_posting.title', read_only=True)
    stage_display = serializers.CharField(source='get_stage_display', read_only=True)
    phone_area_code = PhoneCarrierCodeSerializer(read_only=True)
    
    class Meta:
        model = Candidate
        fields = [
            'id', 'first_name', 'last_name', 'email', 'phone',
            'job_posting', 'job_posting_title',
            'stage', 'stage_display',
            'created_at', 'updated_at', 'avatar',
            'national_id', 'phone_area_code', 'phone_subscriber'
        ]


class CandidateDetailSerializer(serializers.ModelSerializer):
    """Serializer detallado para administración de candidatos"""
    job_posting_title = serializers.CharField(source='job_posting.title', read_only=True)
    stage_display = serializers.CharField(source='get_stage_display', read_only=True)
    education = CandidateEducationSerializer(many=True, read_only=True)
    phone_area_code = PhoneCarrierCodeSerializer(read_only=True)
    cv_url = serializers.SerializerMethodField()
    
    class Meta:
        model = Candidate
        fields = '__all__'
    
    def get_cv_url(self, obj):
        if obj.cv_file:
            request = self.context.get('request')
            if request:
                return request.build_absolute_uri(obj.cv_file.url)
        return None


class CandidateStageUpdateSerializer(serializers.Serializer):
    """Serializer para cambiar la etapa de un candidato"""
    stage = serializers.ChoiceField(choices=Candidate.STAGE_CHOICES)
    notes = serializers.CharField(required=False, allow_blank=True)


class HireCandidateSerializer(serializers.Serializer):
    """Serializer para el proceso de contratación"""
    hire_date = serializers.DateField()
    role = serializers.CharField(help_text="Código del Role (EMP, MGR)")
    employment_type = serializers.CharField(help_text="Código del EmploymentType (FIJ, TMP, PAS)")
    employment_status = serializers.CharField(help_text="Código del EmploymentStatus (ACT, SUS, etc)")
    end_date = serializers.DateField(required=False, allow_null=True)
    salary = serializers.DecimalField(max_digits=10, decimal_places=2, required=False)
    notes = serializers.CharField(required=False, allow_blank=True)


class CandidateLogSerializer(serializers.ModelSerializer):
    """Serializer para el historial de cambios"""
    user_name = serializers.SerializerMethodField()
    
    class Meta:
        model = CandidateLog
        fields = ['id', 'user', 'user_name', 'action', 'details', 'timestamp']
        
    def get_user_name(self, obj):
        if obj.user:
            return f"{obj.user.first_name} {obj.user.last_name}".strip() or obj.user.username
        return "Sistema"
</file>

<file path="backend/ats/services.py">
from django.db import transaction
from django.db.models import F
from django.core.exceptions import ValidationError
from core.models import Person
from talent.models import PersonEducation, EducationLevel, FieldOfStudy
from employment.models import (
    Employment, 
    RoleChoices, 
    EmploymentTypeChoices, 
    EmploymentStatusChoices
)
from .models import Candidate, CandidateEducation


@transaction.atomic
def hire_candidate(candidate, hire_data):
    """
    Transacción atómica para contratar un candidato.
    
    Proceso:
    1. Validar cupos disponibles
    2. Crear Person (migrar identidad)
    3. Migrar educación a PersonEducation
    4. Crear Employment
    5. Actualizar estado del candidato
    6. Decrementar vacantes
    7. Detectar otros finalistas
    
    Args:
        candidate: Instancia de Candidate
        hire_data: Dict con {hire_date, role, employment_type, employment_status, salary, notes}
                   Ahora los valores son códigos de Choice (ej: 'EMP', 'FIJ', 'ACT')
    
    Returns:
        Dict: {person, employment, other_finalists}
    
    Raises:
        ValidationError: Si no hay cupos disponibles
    """
    
    # 1. Validar cupos disponibles con bloqueo optimista
    position = candidate.job_posting.position
    
    if not position:
        raise ValidationError("La vacante no tiene una posición asignada.")
    
    # Bloqueo de fila para evitar condiciones de carrera
    position = position.__class__.objects.select_for_update().get(pk=position.pk)
    
    if position.vacancies <= 0:
        raise ValidationError(
            f"No hay cupos disponibles para la posición '{position}'. "
            f"Vacantes actuales: {position.vacancies}"
        )
    
    # 2. Migración de identidad (Core) - Crear Person
    # Person solo tiene: first_name, second_name, paternal_surname, maternal_surname, 
    # salutation, gender, marital_status, birthdate, country_of_birth, photo
    person = Person.objects.create(
        first_name=candidate.first_name,
        paternal_surname=candidate.last_name,
        # Los campos opcionales se pueden agregar después
    )
    
    # 2.1 Crear NationalId (cédula) si existe
    if hasattr(candidate, 'national_id') and candidate.national_id:
        from core.models import NationalId
        # Parseamos el national_id del candidato (formato: V-12345678)
        national_id_str = str(candidate.national_id)
        if '-' in national_id_str:
            prefix, number = national_id_str.split('-', 1)
        else:
            prefix = 'V'  # Default
            number = national_id_str
        
        NationalId.objects.create(
            person=person,
            category='CEDULA',
            document_type=prefix,
            number=number,
            is_primary=True
        )
    
    # 2.2 Crear PersonEmail si existe
    if candidate.email:
        from core.models import PersonEmail
        PersonEmail.objects.create(
            person=person,
            email_address=candidate.email,
            is_primary=True
        )
    
    
    # 2.3 Crear PersonPhone si existe
    if hasattr(candidate, 'phone') and candidate.phone:
        from core.models import PersonPhone
        # Parsear el teléfono (asumiendo formato simple number o con código)
        phone_str = str(candidate.phone)
        PersonPhone.objects.create(
            person=person,
            subscriber_number=phone_str,
            is_primary=True
        )
    
    # 3. Migración del CV (simplificado para desarrollo local)
    # El archivo permanece en su ubicación original
    # En producción: aquí se movería a un bucket privado
    
    # 4. Migración de educación (Talent)
    for edu in candidate.education.all():
        # Intentar encontrar EducationLevel y FieldOfStudy existentes
        education_level, _ = EducationLevel.objects.get_or_create(
            name=edu.level_name
        )
        field_of_study, _ = FieldOfStudy.objects.get_or_create(
            name=edu.field_name
        )
        
        PersonEducation.objects.create(
            person=person,
            school_name=edu.school_name,
            level=education_level,
            field_of_study=field_of_study,
            start_date=edu.start_date,
            end_date=edu.end_date
        )
    
    # 5. Validar que los valores de Choice sean válidos
    role = hire_data.get('role', RoleChoices.EMPLOYEE)
    employment_type = hire_data.get('employment_type', EmploymentTypeChoices.PERMANENT)
    employment_status = hire_data.get('employment_status', EmploymentStatusChoices.ACTIVE)
    
    # Validar que sean valores válidos de Choices
    if role not in dict(RoleChoices.choices):
        raise ValidationError(f"Rol inválido: {role}")
    if employment_type not in dict(EmploymentTypeChoices.choices):
        raise ValidationError(f"Tipo de empleo inválido: {employment_type}")
    if employment_status not in dict(EmploymentStatusChoices.choices):
        raise ValidationError(f"Estatus inválido: {employment_status}")
    
    # 6. Crear contrato (Employment)
    employment = Employment.objects.create(
        person=person,
        position=position,
        role=role,
        employment_type=employment_type,
        current_status=employment_status,
        hire_date=hire_data['hire_date'],
        end_date=hire_data.get('end_date')  # Opcional para contratos temporales
    )
    
    # 7. Actualizar estado del candidato
    candidate.stage = 'HIRED'
    candidate.notes = (candidate.notes or '') + f"\n[CONTRATADO] {hire_data['hire_date']}"
    candidate.save()
    
    # 8. Decrementar vacante (de forma atómica)
    # AHORA SE MANEJA AUTOMÁTICAMENTE EN Employment.save()
    # position.refresh_from_db()
    # position.vacancies -= 1
    # position.save()
    
    # 9. Detectar otros finalistas (candidatos en etapas avanzadas)
    other_finalists = Candidate.objects.filter(
        job_posting=candidate.job_posting,
        stage__in=['OFF', 'INT']
    ).exclude(pk=candidate.pk)
    
    return {
        'person': person,
        'employment': employment,
        'other_finalists': list(other_finalists),
        'remaining_vacancies': position.vacancies
    }


def move_finalists_to_pool(candidate_ids):
    """
    Mover candidatos finalistas al banco de elegibles.
    
    Args:
        candidate_ids: Lista de IDs de candidatos
    
    Returns:
        int: Número de candidatos movidos
    """
    updated = Candidate.objects.filter(
        id__in=candidate_ids,
        stage__in=['OFF', 'INT']
    ).update(
        stage='POOL',
        notes=F('notes') + '\n[Movido a Banco de Elegibles automáticamente]'
    )
    
    return updated
</file>

<file path="backend/ats/utils.py">
from django.core.mail import EmailMultiAlternatives
from django.conf import settings
from email.mime.image import MIMEImage
import os

def send_status_change_email(candidate, new_stage):
    """
    Envía un correo electrónico al candidato notificando el cambio de estado.
    """
    subject = f"Actualización de tu aplicación: {candidate.job_posting.title}"
    
    # Mapeo de etapas a mensajes amigables
    stage_messages = {
        'REV': 'Tu aplicación ha sido revisada y hemos avanzado a la etapa de Revisión.',
        'INT': 'Nos gustaría invitarte a una entrevista para conocerte mejor.',
        'OFF': '¡Felicidades! Queremos hacerte una oferta formal para unirte a nuestro equipo.',
        'HIRED': '¡Bienvenido al equipo! Has sido contratado exitosamente.',
        'REJ': 'Gracias por tu interés en IUTIRLA. En esta ocasión hemos decidido avanzar con otros candidatos, pero mantendremos tu perfil en cuenta para futuras oportunidades.',
        'POOL': 'Has sido seleccionado para nuestro Banco de Elegibles. Te contactaremos cuando se abra una vacante que se ajuste a tu perfil.',
    }
    
    stage_message = stage_messages.get(new_stage, f"Tu aplicación ha cambiado al estado: {new_stage}")
    
    html_message = f"""
    <!DOCTYPE html>
    <html>
    <head>
        <style>
            body {{ font-family: 'Arial', sans-serif; line-height: 1.6; color: #333; }}
            .container {{ max-width: 600px; margin: 0 auto; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #ffffff; }}
            .header {{ text-align: center; padding-bottom: 20px; border-bottom: 2px solid #f0f0f0; margin-bottom: 20px; }}
            .logo {{ max-width: 150px; height: auto; }}
            .content {{ padding: 0 10px; }}
            .footer {{ margin-top: 30px; padding-top: 20px; border-top: 1px solid #f0f0f0; text-align: center; font-size: 12px; color: #888; }}
            .button {{ display: inline-block; padding: 10px 20px; background-color: #0056b3; color: #ffffff; text-decoration: none; border-radius: 5px; margin-top: 20px; }}
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <img src="cid:logoiutirla" alt="IUTIRLA Logo" class="logo">
            </div>
            <div class="content">
                <h2>Hola, {candidate.first_name}</h2>
                <p>{stage_message}</p>
                <p>Agradecemos tu interés en formar parte de nuestra institución.</p>
                <p>Si tienes alguna duda, por favor no dudes en contactarnos.</p>
            </div>
            <div class="footer">
                <p>&copy; <a href="https://iutirlaoficial.com/" style="color: inherit; text-decoration: none;">iutirlaoficial.com</a>. Todos los derechos reservados.</p>
                <p>Este es un correo automático, por favor no respondas a esta dirección.</p>
            </div>
        </div>
    </body>
    </html>
    """
    
    plain_message = f"""
    Hola {candidate.first_name},
    
    {stage_message}
    
    Saludos,
    Equipo de RRHH - IUTIRLA
    """
    
    recipient_list = [candidate.email]
    
    try:
        msg = EmailMultiAlternatives(
            subject,
            plain_message,
            settings.DEFAULT_FROM_EMAIL,
            recipient_list
        )
        msg.attach_alternative(html_message, "text/html")
        
        # Adjuntar logo
        # Ruta asumiendo estructura: backend/ats/utils.py -> backend/ -> ../frontend/public/logoiutirla.png
        # Ajustamos la ruta base para llegar al frontend
        base_dir = settings.BASE_DIR # backend/
        logo_path = os.path.join(base_dir.parent, 'frontend2', 'public', 'email-logoiutirla.webp')
        
        if os.path.exists(logo_path):
            with open(logo_path, 'rb') as f:
                logo_data = f.read()
                logo = MIMEImage(logo_data)
                logo.add_header('Content-ID', '<logoiutirla>')
                logo.add_header('Content-Disposition', 'inline', filename='email-logoiutirla.webp')
                msg.attach(logo)
        else:
            print(f"Logo not found at {logo_path}")
            
        msg.send(fail_silently=False)
        return True
    except Exception as e:
        print(f"Error sending email to {candidate.email}: {e}")
        return False
</file>

<file path="backend/core/migrations/0001_initial.py">
# Generated by Django 5.2.8 on 2025-11-24 08:15

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
    ]

    operations = [
        migrations.CreateModel(
            name='AddressType',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, max_length=50, unique=True)),
            ],
        ),
        migrations.CreateModel(
            name='Bank',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, max_length=100, unique=True)),
                ('code', models.CharField(error_messages={'unique': 'Ya existe un registro con este código.'}, max_length=4, unique=True)),
            ],
        ),
        migrations.CreateModel(
            name='BankAccountType',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, max_length=50, unique=True)),
            ],
        ),
        migrations.CreateModel(
            name='Country',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, max_length=100, unique=True)),
                ('iso_2', models.CharField(error_messages={'unique': 'Ya existe un registro con este código ISO.'}, help_text='Ej: US, VE.', max_length=2, unique=True)),
                ('phone_prefix', models.CharField(error_messages={'unique': 'Ya existe un país con este prefijo.'}, help_text='Prefijo telefónico (ej: +58).', max_length=10, unique=True)),
            ],
        ),
        migrations.CreateModel(
            name='DisabilityGroup',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, max_length=100, unique=True)),
            ],
        ),
        migrations.CreateModel(
            name='DisabilityStatus',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, max_length=50, unique=True)),
            ],
        ),
        migrations.CreateModel(
            name='DisabilityType',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, max_length=100, unique=True)),
            ],
        ),
        migrations.CreateModel(
            name='EmailType',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, max_length=50, unique=True)),
            ],
        ),
        migrations.CreateModel(
            name='Gender',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, max_length=50, unique=True)),
            ],
        ),
        migrations.CreateModel(
            name='MaritalStatus',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, max_length=50, unique=True)),
            ],
        ),
        migrations.CreateModel(
            name='Person',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('first_name', models.CharField(max_length=100)),
                ('second_name', models.CharField(blank=True, max_length=100, null=True)),
                ('paternal_surname', models.CharField(max_length=100)),
                ('maternal_surname', models.CharField(blank=True, max_length=100, null=True)),
                ('birthdate', models.DateField(blank=True, null=True)),
                ('photo', models.ImageField(blank=True, null=True, upload_to='photos/person/')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('country_of_birth', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.country')),
                ('gender', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.gender')),
                ('marital_status', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.maritalstatus')),
            ],
        ),
        migrations.CreateModel(
            name='PhoneCarrier',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, max_length=50, unique=True)),
            ],
        ),
        migrations.CreateModel(
            name='PhoneType',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, max_length=50, unique=True)),
            ],
        ),
        migrations.CreateModel(
            name='RelationshipType',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, max_length=50, unique=True)),
            ],
        ),
        migrations.CreateModel(
            name='Salutation',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, max_length=50, unique=True)),
            ],
        ),
        migrations.CreateModel(
            name='PersonBankAccount',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('account_number', models.CharField(max_length=20, unique=True)),
                ('is_primary', models.BooleanField(default=False)),
                ('bank', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.bank')),
                ('bank_account_type', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.bankaccounttype')),
                ('person', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='bank_accounts', to='core.person')),
            ],
        ),
        migrations.CreateModel(
            name='PersonDocument',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('file', models.FileField(blank=True, null=True, upload_to='documents/person/')),
                ('description', models.CharField(blank=True, max_length=255, null=True)),
                ('person', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='documents', to='core.person')),
            ],
        ),
        migrations.CreateModel(
            name='PersonEmail',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('email_address', models.EmailField(error_messages={'unique': 'Este correo electrónico ya está registrado.'}, max_length=254, unique=True)),
                ('is_primary', models.BooleanField(default=False)),
                ('email_type', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.emailtype')),
                ('person', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='emails', to='core.person')),
            ],
        ),
        migrations.CreateModel(
            name='PhoneAreaCode',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('code', models.CharField(max_length=5)),
                ('type', models.CharField(max_length=20)),
                ('country', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='core.country')),
                ('carrier', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.phonecarrier')),
            ],
            options={
                'unique_together': {('country', 'code', 'carrier')},
            },
        ),
        migrations.CreateModel(
            name='EmergencyContact',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('first_name', models.CharField(max_length=100)),
                ('second_name', models.CharField(blank=True, max_length=100, null=True)),
                ('paternal_surname', models.CharField(max_length=100)),
                ('maternal_surname', models.CharField(blank=True, max_length=100, null=True)),
                ('phone_number', models.CharField(max_length=10)),
                ('is_primary', models.BooleanField(default=False)),
                ('person', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='emergency_contacts', to='core.person')),
                ('phone_area_code', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.phoneareacode')),
                ('relationship', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.relationshiptype')),
            ],
        ),
        migrations.AddField(
            model_name='person',
            name='salutation',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.salutation'),
        ),
        migrations.CreateModel(
            name='State',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=100)),
                ('country', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='core.country')),
            ],
            options={
                'unique_together': {('country', 'name')},
            },
        ),
        migrations.CreateModel(
            name='Address',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('city', models.CharField(max_length=100)),
                ('postal_code', models.CharField(blank=True, max_length=20, null=True)),
                ('street_name_and_number', models.CharField(max_length=255)),
                ('extra_address_line', models.CharField(blank=True, max_length=255, null=True)),
                ('house_number', models.CharField(blank=True, max_length=50, null=True)),
                ('apartment', models.CharField(blank=True, max_length=50, null=True)),
                ('street_2', models.CharField(blank=True, max_length=255, null=True)),
                ('address_type', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.addresstype')),
                ('country', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.country')),
                ('person', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='addresses', to='core.person')),
                ('state', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.state')),
            ],
        ),
        migrations.CreateModel(
            name='PersonDisabilityVE',
            fields=[
                ('person', models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, primary_key=True, serialize=False, to='core.person')),
                ('date_learned', models.DateField(blank=True, null=True)),
                ('disability_degree', models.CharField(blank=True, max_length=50, null=True)),
                ('issuing_authority', models.CharField(blank=True, max_length=100, null=True)),
                ('reference_number', models.CharField(blank=True, max_length=50, null=True)),
                ('date_of_determination', models.DateField(blank=True, null=True)),
                ('disability_group', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.disabilitygroup')),
                ('disability_status', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.disabilitystatus')),
                ('disability_type', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.disabilitytype')),
            ],
        ),
        migrations.CreateModel(
            name='NationalId',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('category', models.CharField(choices=[('CEDULA', 'Cédula de Identidad'), ('RIF', 'RIF'), ('PASSPORT', 'Pasaporte')], default='CEDULA', max_length=10)),
                ('document_type', models.CharField(choices=[('V', 'V - Venezolano / Persona Natural'), ('E', 'E - Extranjero / Persona Natural'), ('J', 'J - Jurídico'), ('G', 'G - Gubernamental'), ('P', 'P - Pasaporte')], default='V', max_length=1, verbose_name='Prefijo')),
                ('number', models.CharField(help_text='Solo números.', max_length=20)),
                ('is_primary', models.BooleanField(default=False)),
                ('file', models.FileField(blank=True, null=True, upload_to='documents/national_id/')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('person', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='national_ids', to='core.person')),
            ],
            options={
                'unique_together': {('document_type', 'number'), ('person', 'category')},
            },
        ),
        migrations.CreateModel(
            name='PersonNationality',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('country', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='core.country')),
                ('person', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='nationalities', to='core.person')),
            ],
            options={
                'unique_together': {('person', 'country')},
            },
        ),
        migrations.CreateModel(
            name='PersonPhone',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('subscriber_number', models.CharField(max_length=10)),
                ('is_primary', models.BooleanField(default=False)),
                ('person', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='phones', to='core.person')),
                ('area_code', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.phoneareacode')),
                ('phone_type', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.phonetype')),
            ],
            options={
                'constraints': [models.UniqueConstraint(fields=('area_code', 'subscriber_number'), name='phone_unique', violation_error_message='Este número de teléfono ya se encuentra registrado.'), models.UniqueConstraint(condition=models.Q(('is_primary', True)), fields=('person',), name='one_primary_phone_per_person', violation_error_message='La persona ya tiene un teléfono principal registrado.')],
            },
        ),
        migrations.CreateModel(
            name='Dependent',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('first_name', models.CharField(max_length=100)),
                ('second_name', models.CharField(blank=True, max_length=100, null=True)),
                ('paternal_surname', models.CharField(max_length=100)),
                ('maternal_surname', models.CharField(blank=True, max_length=100, null=True)),
                ('birthdate', models.DateField()),
                ('gender', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.gender')),
                ('person', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='dependents', to='core.person')),
                ('relationship', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.relationshiptype')),
            ],
            options={
                'unique_together': {('person', 'first_name', 'paternal_surname')},
            },
        ),
    ]
</file>

<file path="backend/core/apps.py">
from django.apps import AppConfig
from django.db.backends.signals import connection_created
from django.db.models import Transform
from django.db.models import CharField, TextField

class Unaccent(Transform):
    lookup_name = 'unaccent'
    function = 'unaccent'

def register_sqlite_functions(sender, connection, **kwargs):
    if connection.vendor == 'sqlite':
        from .db_utils import remove_accents
        connection.connection.create_function("unaccent", 1, remove_accents)

class CoreConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'core'

    def ready(self):
        connection_created.connect(register_sqlite_functions)
        CharField.register_lookup(Unaccent)
        TextField.register_lookup(Unaccent)
</file>

<file path="backend/core/filters.py">
from rest_framework import filters
from .db_utils import remove_accents

class UnaccentSearchFilter(filters.SearchFilter):
    def get_search_fields(self, view, request):
        """
        Search fields are obtained from the view, but the request can override them
        with a specific field using the 'search_field' query parameter.
        """
        search_field = request.query_params.get('search_field')
        allowed_fields = getattr(view, 'search_fields', [])
        
        if search_field and search_field in allowed_fields:
            return [search_field]
            
        return allowed_fields

    def get_search_terms(self, request):
        """
        Search terms are set by a ?search=... query parameter.
        We treat the entire query as a single phrase to support exact substring matching
        (respecting spaces), while ignoring accents and case.
        """
        params = request.query_params.get(self.search_param, '')
        if not params:
            return []
        
        # Apply remove_accents to the entire phrase, preserving spaces
        return [remove_accents(params)]

    def filter_queryset(self, request, queryset, view):
        search_terms = self.get_search_terms(request)

        if not search_terms:
            return queryset

        # Standard Django filtering (will work if DB supports unaccent or exact match)
        # However, since we stripped accents from terms, exact match against accented DB fails.
        # And SQLite doesn't support unaccent lookup.
        
        # Try standard filtering first (in case we move to Postgres later or have unaccent lookup)
        # But for now, we need to force a match.
        
        # If we are on SQLite (or just generally want to support this without extensions),
        # and the dataset is small (like catalogs), we can filter in Python.
        # This is inefficient for large tables but fine for Departments/JobTitles.
        
        # Check if we should use python fallback
        use_python_fallback = True # We can make this conditional on DB engine if needed

        if use_python_fallback:
            # Get all objects (this hits the DB)
            # We optimize by only fetching if search terms exist
            
            # Note: This breaks pagination if done naively on large sets, 
            # but for catalogs < 1000 items it's instantaneous.
            
            # We need to filter the queryset. 
            # Ideally we construct a Q object, but we can't do unaccent(field) in SQLite easily.
            
            # Let's try to do it in memory.
            # Warning: This evaluates the queryset!
            
            # To be safe, let's only do this for specific views or small querysets if possible.
            # But since this is a global filter, we should be careful.
            
            # Better approach for SQLite:
            # Register a custom function? No, too complex for this context.
            
            # Let's iterate and filter.
            initial_results = list(queryset.all())
            filtered_results = []
            
            search_fields = self.get_search_fields(view, request)
            
            for obj in initial_results:
                # AND logic: ALL terms must match at least one field in the object
                all_terms_match = True
                
                for term in search_terms:
                    term_unaccented = remove_accents(term).lower()
                    term_match = False
                    
                    # Check each search field for this specific term
                    for field in search_fields:
                        # Handle related fields (e.g. job_title__name)
                        field_value = self.get_field_value(obj, field)
                        
                        if field_value:
                            value_unaccented = remove_accents(str(field_value)).lower()
                            if term_unaccented in value_unaccented:
                                term_match = True
                                break
                    
                    if not term_match:
                        all_terms_match = False
                        break
                
                if all_terms_match:
                    filtered_results.append(obj.pk)
            
            return queryset.filter(pk__in=filtered_results)

        return super().filter_queryset(request, queryset, view)

    def get_field_value(self, obj, field_name):
        """Helper to get value from potentially related fields"""
        try:
            if '__' in field_name:
                parts = field_name.split('__')
                value = obj
                for part in parts:
                    value = getattr(value, part)
                    if value is None:
                        return None
                return value
            return getattr(obj, field_name)
        except AttributeError:
            return None
</file>

<file path="backend/employment/migrations/0001_initial.py">
# Generated by Django 5.2.8 on 2025-11-24 08:15

import django.db.models.deletion
import django.utils.timezone
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('core', '0001_initial'),
        ('organization', '0001_initial'),
    ]

    operations = [
        migrations.CreateModel(
            name='EmploymentStatus',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, help_text='Ej: Activo, En Reposo, Suspendido, Finalizado', max_length=50, unique=True)),
                ('is_active_relationship', models.BooleanField(default=True, help_text='Si está marcado, este estatus cuenta como que el empleado ocupa el cargo (ej: Activo, Reposo). Si no (ej: Finalizado), libera el cargo.', verbose_name='¿Es vinculación activa?')),
            ],
        ),
        migrations.CreateModel(
            name='EmploymentType',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, help_text='Ej: Período de Prueba, Tiempo Indefinido', max_length=100, unique=True)),
            ],
        ),
        migrations.CreateModel(
            name='Role',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, help_text='Manager, Supervisor, Employee', max_length=50, unique=True)),
                ('description', models.TextField(blank=True, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
            ],
        ),
        migrations.CreateModel(
            name='Employment',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('exit_reason', models.CharField(blank=True, choices=[('REN', 'Renuncia Voluntaria'), ('DES', 'Despido / Cese'), ('FIN', 'Fin de Contrato (Tiempo Cumplido)'), ('JUB', 'Jubilación'), ('FAL', 'Fallecimiento'), ('OTR', 'Otro Motivo')], max_length=3, null=True, verbose_name='Motivo de Salida')),
                ('exit_notes', models.TextField(blank=True, help_text='Detalle o carta de renuncia.', null=True, verbose_name='Observaciones')),
                ('hire_date', models.DateField(verbose_name='Fecha de Contratación')),
                ('end_date', models.DateField(blank=True, help_text="Fecha de fin de contrato (para 'Tiempo Determinado' o 'Prueba')", null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('person', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='employments', to='core.person', verbose_name='Colaborador')),
                ('position', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='employments', to='organization.position', verbose_name='Cargo / Posición')),
                ('current_status', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='active_employments', to='employment.employmentstatus', verbose_name='Estatus Actual')),
                ('employment_type', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='employments', to='employment.employmenttype', verbose_name='Tipo de Contrato')),
                ('role', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='employments', to='employment.role', verbose_name='Rol Funcional')),
            ],
            options={
                'verbose_name': 'Expediente Laboral',
                'ordering': ['-hire_date'],
            },
        ),
        migrations.CreateModel(
            name='EmploymentStatusLog',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('start_date', models.DateField(default=django.utils.timezone.now, help_text='Fecha de inicio de este estatus')),
                ('reason', models.TextField(blank=True, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('employment', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='status_logs', to='employment.employment')),
                ('status', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, to='employment.employmentstatus')),
            ],
            options={
                'verbose_name': 'Historial de Estatus',
                'ordering': ['-created_at'],
            },
        ),
    ]
</file>

<file path="backend/organization/migrations/0001_initial.py">
# Generated by Django 5.2.8 on 2025-11-23 08:49

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
    ]

    operations = [
        migrations.CreateModel(
            name='JobTitle',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, max_length=100, unique=True)),
                ('description', models.TextField(blank=True, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
            ],
        ),
        migrations.CreateModel(
            name='Department',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, max_length=100, unique=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('parent', models.ForeignKey(blank=True, help_text='Departamento superior al que reporta este departamento.', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='sub_departments', to='organization.department')),
            ],
        ),
        migrations.CreateModel(
            name='Position',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('vacancies', models.PositiveIntegerField(default=1, help_text='Número de vacantes disponibles')),
                ('name', models.CharField(blank=True, help_text="Nombre descriptivo opcional, ej: 'Gerente de Finanzas (VE)'", max_length=100, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('department', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='organization.department')),
                ('job_title', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='organization.jobtitle')),
                ('manager_position', models.ForeignKey(blank=True, help_text='Posición a la que reporta directamente (Jefe Inmediato).', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='direct_reports', to='organization.position')),
            ],
        ),
        migrations.CreateModel(
            name='PositionObjective',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('description', models.TextField(help_text='Un objetivo de la posición')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('position', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='objectives', to='organization.position')),
            ],
        ),
        migrations.CreateModel(
            name='PositionRequirement',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('description', models.TextField(help_text='Un requisito de la posición')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('position', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='requirements', to='organization.position')),
            ],
        ),
    ]
</file>

<file path="backend/performance/admin.py">
from django.contrib import admin
from django.db.models import Count, DecimalField
from django.utils.html import format_html
from . import models

# --- 1. INLINE (Para ver las preguntas dentro de la boleta) ---

class ReviewDetailInline(admin.TabularInline):
    """Muestra las competencias evaluadas dentro del formulario de PerformanceReview."""
    model = models.ReviewDetail
    extra = 0
    raw_id_fields = ('competency',)
    fields = ('competency', 'score', 'comment')
    readonly_fields = ('competency',)
    min_num = 1 # Debe haber al menos una competencia si se crea manualmente


# --- 2. REGISTRO PRINCIPAL DE EVALUACIONES ---

@admin.register(models.PerformanceReview)
class PerformanceReviewAdmin(admin.ModelAdmin):
    list_display = (
        '__str__',
        'employee_name', # Método para mostrar el nombre
        'evaluator_name',
        'status',
        'final_score',
        'period',
        'created_at',
    )
    list_filter = ('status', 'period', 'evaluator')
    search_fields = ('employment__person__first_name', 'employment__person__paternal_surname', 'period__name')
    
    # Detalle de la boleta anidado
    inlines = [ReviewDetailInline]
    
    # Campos que son propiedades calculadas o navegadas
    readonly_fields = ('final_score', 'employee_name', 'evaluator_name')

    # Navegación a través de las relaciones (evita N+1 queries)
    list_select_related = ('employment__person', 'evaluator', 'period') 
    
    # Métodos para list_display (extraídos del Serializer para el Admin)
    def employee_name(self, obj):
        return str(obj.employment.person)
    employee_name.short_description = 'Empleado'

    def evaluator_name(self, obj):
        return str(obj.evaluator)
    evaluator_name.short_description = 'Evaluador'


# --- 3. CONFIGURACIÓN DE CATÁLOGOS ---

@admin.register(models.Competency)
class CompetencyAdmin(admin.ModelAdmin):
    """Configuración de las preguntas/criterios a evaluar."""
    list_display = ('name', 'category', 'is_global', 'description')
    list_filter = ('category', 'is_global',)
    search_fields = ('name',)
    
    # CLAVE: Permite seleccionar múltiples JobTitles para competencias específicas
    filter_horizontal = ('job_titles',) 
    
    # Los campos de Global y JobTitles solo se muestran si aplican
    fieldsets = (
        (None, {'fields': ('name', 'description', 'category')}),
        ('SEGMENTACIÓN', {
            'fields': ('is_global', 'job_titles'),
            'description': 'Si es global, aplica a todos. Si es específico, seleccione los cargos.',
        }),
    )

@admin.register(models.EvaluationPeriod)
class EvaluationPeriodAdmin(admin.ModelAdmin):
    """Admin para gestionar los ciclos y disparar la generación masiva."""
    list_display = ('name', 'start_date', 'end_date', 'is_active', 'review_count')
    list_filter = ('is_active', 'start_date')
    
    # Agrega un campo calculado de conteo de evaluaciones
    def get_queryset(self, request):
        queryset = super().get_queryset(request)
        # Anotamos cuántas revisiones se crearon para cada periodo
        return queryset.annotate(
            _review_count=Count('performance_review')
        )
    
    def review_count(self, obj):
        return obj._review_count
    review_count.short_description = 'Boletas Creadas'


# --- 4. REGISTRO DE DETALLES ---
@admin.register(models.ReviewDetail)
class ReviewDetailAdmin(admin.ModelAdmin):
    list_display = ('review', 'competency', 'score')
    list_filter = ('competency', 'review__period')
    search_fields = ('review__employment__person__first_name', 'competency__name')
    raw_id_fields = ('review', 'competency')
</file>

<file path="backend/performance/models.py">
from django.db import models
from django.core.validators import MinValueValidator, MaxValueValidator
from core.models import Person
from employment.models import Employment
from organization.models import JobTitle # Importamos JobTitle para la relación

class EvaluationPeriod(models.Model):
    """Define el ciclo de evaluación (Ej: 'Evaluación 2025-I')"""
    name = models.CharField(max_length=100, unique=True)
    start_date = models.DateField(verbose_name="Inicio")
    end_date = models.DateField(verbose_name="Cierre")
    is_active = models.BooleanField(default=True, verbose_name="Activo")
    
    class Meta:
        verbose_name = "Periodo de Evaluación"
        ordering = ['-start_date']

    def __str__(self): return self.name

class Competency(models.Model):
    """
    Diccionario de criterios a evaluar.
    """
    class Category(models.TextChoices):
        QUALITY = 'CAL', 'Calidad'
        COMMITMENT = 'COM', 'Compromiso'
        COMMUNICATION = 'CMU', 'Comunicación'
        ORGANIZATION = 'ORG', 'Organización'
        DISCIPLINE = 'DIS', 'Disciplina'
        PROACTIVITY = 'PRO', 'Proactividad'
    
    name = models.CharField(max_length=100)
    description = models.TextField(blank=True, null=True)
    
    # NUEVA CATEGORÍA: Para agrupar competencias según performance.md
    category = models.CharField(
        max_length=3,
        choices=Category.choices,
        blank=True,
        null=True,
        verbose_name="Categoría",
        help_text="Categoría de evaluación según la matriz de desempeño global",
        db_index=True  # Índice para mejorar rendimiento en queries por categoría
    )
    
    # LÓGICA DE SEGMENTACIÓN
    is_global = models.BooleanField(
        default=True, 
        verbose_name="¿Es Global?",
        help_text="Si se marca, aplica a todos los empleados."
    )
    
    # Relación con Títulos de Cargo (NO con Posiciones individuales)
    job_titles = models.ManyToManyField(
        JobTitle, 
        blank=True, 
        related_name='specific_competencies',
        verbose_name="Aplica a Cargos Específicos"
    )

    class Meta:
        verbose_name = "Competencia / Criterio"
        verbose_name_plural = "Competencias"

    def __str__(self): return self.name

class PerformanceReview(models.Model):
    """La boleta de evaluación de un CONTRATO específico."""
    
    class Status(models.TextChoices):
        DRAFT = 'BOR', 'Borrador'
        SUBMITTED = 'ENV', 'Enviada / Finalizada'
        ACKNOWLEDGED = 'ACE', 'Aceptada por Empleado'

    period = models.ForeignKey(EvaluationPeriod, on_delete=models.PROTECT)
    
    # Evaluamos al CONTRATO (Employment), para soportar pluriempleo
    employment = models.ForeignKey(
        Employment, 
        on_delete=models.CASCADE, 
        related_name='reviews'
    )
    
    # El evaluador es el JEFE en ese momento
    evaluator = models.ForeignKey(
        Person, 
        on_delete=models.PROTECT, 
        related_name='reviews_given'
    )
    
    final_score = models.DecimalField(
        max_digits=4, decimal_places=2, 
        null=True, blank=True, 
        verbose_name="Promedio Final"
    )
    
    status = models.CharField(max_length=3, choices=Status.choices, default=Status.DRAFT)
    
    feedback_manager = models.TextField(verbose_name="Comentarios del Jefe", blank=True)
    feedback_employee = models.TextField(verbose_name="Comentarios del Empleado", blank=True)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        # Un contrato solo puede ser evaluado una vez por periodo
        unique_together = ('period', 'employment') 
        verbose_name = "Evaluación de Desempeño"
        verbose_name_plural = "Evaluaciones de Desempeño"

    def __str__(self):
        return f"{self.employment.person} - {self.period}"
        
    def calculate_score(self):
        """Recalcula el promedio."""
        details = self.details.all()
        if not details.exists():
            self.final_score = 0
        else:
            total = sum([d.score for d in details])
            self.final_score = total / details.count()
        self.save()

class ReviewDetail(models.Model):
    """Cada pregunta y su respuesta."""
    review = models.ForeignKey(PerformanceReview, on_delete=models.CASCADE, related_name='details')
    competency = models.ForeignKey(Competency, on_delete=models.PROTECT)
    
    score = models.PositiveIntegerField(
        default=0,
        validators=[MinValueValidator(0), MaxValueValidator(5)],
        verbose_name="Puntaje (1-5)"
    )
    comment = models.TextField(blank=True, null=True, verbose_name="Observación")

    class Meta:
        unique_together = ('review', 'competency')

    def __str__(self):
        return f"{self.competency}: {self.score}"
</file>

<file path="backend/performance/serializers.py">
from rest_framework import serializers
from .models import EvaluationPeriod, Competency, PerformanceReview, ReviewDetail
from core.serializers import title_case_cleaner

class EvaluationPeriodSerializer(serializers.ModelSerializer):
    class Meta: model = EvaluationPeriod; fields = '__all__'

class CompetencySerializer(serializers.ModelSerializer):
    job_titles_names = serializers.StringRelatedField(many=True, source='job_titles', read_only=True)
    category_display = serializers.CharField(source='get_category_display', read_only=True)

    class Meta: 
        model = Competency
        fields = '__all__'
    
    def validate_name(self, value):
        return title_case_cleaner(value)

class ReviewDetailSerializer(serializers.ModelSerializer):
    competency_name = serializers.CharField(source='competency.name', read_only=True)
    competency_description = serializers.CharField(source='competency.description', read_only=True)
    competency_category = serializers.CharField(source='competency.category', read_only=True)
    competency_category_display = serializers.CharField(source='competency.get_category_display', read_only=True)
    
    class Meta: 
        model = ReviewDetail
        fields = ['id', 'competency', 'competency_name', 'competency_description', 
                  'competency_category', 'competency_category_display', 'score', 'comment']

class PerformanceReviewSerializer(serializers.ModelSerializer):
    # Datos de lectura enriquecidos navegando las relaciones de Employment
    employee_name = serializers.CharField(source='employment.person.__str__', read_only=True)
    employee_person_id = serializers.IntegerField(source='employment.person.id', read_only=True) # ID para validar en frontend
    
    position_name = serializers.CharField(source='employment.position.__str__', read_only=True)
    department_name = serializers.CharField(source='employment.position.department.name', read_only=True)
    
    evaluator_name = serializers.CharField(source='evaluator.__str__', read_only=True)
    evaluator_id = serializers.IntegerField(source='evaluator.id', read_only=True) # ID para validar en frontend
    
    period_name = serializers.CharField(source='period.name', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)
    
    # Detalles (Preguntas) anidados
    details = ReviewDetailSerializer(many=True, read_only=True)

    class Meta:
        model = PerformanceReview
        fields = '__all__'
</file>

<file path="backend/performance/views.py">
from rest_framework import viewsets, permissions, status
from rest_framework.decorators import action
from rest_framework.response import Response
from django.db import transaction
from django.db.models import Q, Count, F
from .models import EvaluationPeriod, Competency, PerformanceReview, ReviewDetail
from .serializers import EvaluationPeriodSerializer, CompetencySerializer, PerformanceReviewSerializer, ReviewDetailSerializer
from employment.models import Employment

class EvaluationPeriodViewSet(viewsets.ModelViewSet):
    queryset = EvaluationPeriod.objects.all()
    serializer_class = EvaluationPeriodSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    pagination_class = None  # Devolver todos sin paginar

    @action(detail=True, methods=['post'])
    def generate_reviews(self, request, pk=None):
        """
        Genera masivamente las evaluaciones para todos los empleados activos.
        """
        period = self.get_object()
        count_created = 0
        
        # Estatus que representan vinculación activa
        ACTIVE_STATUSES = ['ACT', 'SUS', 'PER', 'REP']
        
        # 1. Buscar contratos activos (ocupan silla)
        active_employments = Employment.objects.filter(
            current_status__in=ACTIVE_STATUSES
        ).select_related('position__department', 'position__job_title', 'person')

        try:
            with transaction.atomic():
                for emp in active_employments:
                    # A. Determinar Jefe (Evaluador)
                    # manager_positions es ManyToMany, tomamos el primero
                    manager_positions = emp.position.manager_positions.all()
                    evaluator = None
                    
                    for boss_pos in manager_positions:
                        # Buscamos quién ocupa esa posición gerencial actualmente
                        boss = Employment.objects.filter(
                            position=boss_pos, 
                            current_status__in=ACTIVE_STATUSES
                        ).first()
                        if boss:
                            evaluator = boss.person
                            break  # Usamos el primer jefe encontrado
                    
                    # Si no tiene jefe asignado, no generamos.
                    if not evaluator:
                        continue 

                    # B. Crear Boleta
                    review, created = PerformanceReview.objects.get_or_create(
                        period=period,
                        employment=emp,
                        defaults={'evaluator': evaluator, 'status': 'BOR'}
                    )

                    if created:
                        count_created += 1
                        
                        # C. Asignar Competencias (Híbridas: Globales + Específicas del JobTitle)
                        comps = Competency.objects.filter(
                            Q(is_global=True) | 
                            Q(job_titles=emp.position.job_title)
                        ).distinct()
                        
                        details = [
                            ReviewDetail(review=review, competency=c, score=0)
                            for c in comps
                        ]
                        ReviewDetail.objects.bulk_create(details)

            return Response({"message": f"Proceso finalizado. Se generaron {count_created} evaluaciones nuevas."}, status=200)
        
        except Exception as e:
            return Response({"error": str(e)}, status=500)


class CompetencyViewSet(viewsets.ModelViewSet):
    queryset = Competency.objects.all().order_by('category', 'name')
    serializer_class = CompetencySerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    search_fields = ['name', 'description']
    filterset_fields = ['category', 'is_global']
    
    def filter_queryset(self, queryset):
        """Salta los filtros por defecto cuando se busca por categoría"""
        search_field = self.request.query_params.get('search_field', '')
        if search_field == 'category':
            # Ya filtrado en get_queryset, saltar SearchFilter
            return queryset
        return super().filter_queryset(queryset)
    
    def get_queryset(self):
        queryset = super().get_queryset()
        
        # Filtro personalizado por nombre de categoría
        search = self.request.query_params.get('search', '')
        search_field = self.request.query_params.get('search_field', '')
        
        if search and search_field == 'category':
            # Mapeo de nombres a códigos
            category_map = {
                'calidad': 'CAL',
                'compromiso': 'COM', 
                'comunicación': 'CMU',
                'comunicacion': 'CMU',
                'organización': 'ORG',
                'organizacion': 'ORG',
                'disciplina': 'DIS',
                'proactividad': 'PRO',
            }
            
            search_lower = search.lower()
            # Buscar categorías que coincidan parcialmente
            matching_codes = [
                code for name, code in category_map.items()
                if search_lower in name
            ]
            
            if matching_codes:
                queryset = queryset.filter(category__in=matching_codes)
            else:
                queryset = queryset.none()  # No hay coincidencias
        
        return queryset


class PerformanceReviewViewSet(viewsets.ModelViewSet):
    queryset = PerformanceReview.objects.all()
    serializer_class = PerformanceReviewSerializer
    permission_classes = [permissions.IsAuthenticated]

    def get_queryset(self):
        user = self.request.user
        queryset = PerformanceReview.objects.all()

        # 1. FILTRO DE SEGURIDAD BASE (Quién puede ver qué en general)
        if not user.is_staff:
            if hasattr(user, 'person'):
                queryset = queryset.filter(
                    Q(evaluator=user.person) |          # Soy el Jefe
                    Q(employment__person=user.person)   # Soy el Empleado
                )
            else:
                return PerformanceReview.objects.none()

        # 2. FILTRO DE ALCANCE (NUEVO - CRÍTICO PARA TU PROBLEMA)
        scope = self.request.query_params.get('scope')
        
        if scope == 'received':
            # CASO: "Mis Evaluaciones" (Soy el empleado)
            if hasattr(user, 'person'):
                queryset = queryset.filter(employment__person=user.person)
            else:
                return PerformanceReview.objects.none() # Admin sin persona no tiene evaluaciones propias
                
        elif scope == 'given':
            # CASO: "Mi Equipo" (Soy el jefe)
            if hasattr(user, 'person'):
                queryset = queryset.filter(evaluator=user.person)
        
        # 3. FILTRO POR DEPARTAMENTO (Existente)
        dept_id = self.request.query_params.get('department')
        if dept_id:
            if dept_id == '0':
                queryset = queryset.filter(employment__position__department__isnull=True)
            else:
                queryset = queryset.filter(employment__position__department_id=dept_id)

        return queryset.distinct()

    @action(detail=False, methods=['get'])
    def my_teams_summary(self, request):
        """
        Devuelve el resumen de equipos que el usuario supervisa, 
        basado en la JERARQUÍA y su ROL FUNCIONAL.
        """
        user = request.user
        
        if not hasattr(user, 'person'):
            return Response([])

        # Definimos los roles funcionales que otorgan permiso de supervisión
        # 🚨 IMPORTANTE: Estos nombres deben coincidir exactamente con los que has creado en la tabla 'Role'
        SUPERVISORY_ROLES = ['Manager', 'Supervisor', 'Gerente', 'Director'] 

        # 1. Identificar todas las POSICIONES activas que ocupa este usuario Y que tienen rol de JEFE
        user_manager_positions = Employment.objects.filter(
            person=user.person,
            current_status__is_active_relationship=True,
            # CRÍTICO: Filtramos por el nombre del rol (Employment.role.name)
            role__name__in=SUPERVISORY_ROLES 
        ).values_list('position_id', flat=True)

        
        # 2. Si el usuario no tiene ninguna posición activa de Manager, no ve equipos.
        # (Excepción: El Admin puede ver todo)
        if not user_manager_positions.exists() and not user.is_staff:
            return Response([])
        
        # 3. Definir el QuerySet Base
        if user.is_staff:
            # Si es admin, ve todas las evaluaciones generadas para monitoreo
            base_qs = PerformanceReview.objects.all()
        else:
            # Si es Gerente/Supervisor, solo ve las evaluaciones de subordinados que reportan a SUS posiciones
            # La evaluación del subordinado debe reportar a una de las sillas que yo ocupo
            base_qs = PerformanceReview.objects.filter(
                employment__position__manager_position__in=user_manager_positions,
                evaluator=user.person # Filtro de seguridad adicional: solo si me asignaron como evaluador
            )
        
        # 4. Agrupar y contar (El proceso de agrupamiento sigue igual)
        teams = base_qs.values(
            dept_id=F('employment__position__department__id'),
            dept_name=F('employment__position__department__name')
        ).annotate(
            total=Count('id'),
            pending=Count('id', filter=Q(status='BOR'))
        ).order_by('dept_name')

        return Response(list(teams))

class ReviewDetailViewSet(viewsets.ModelViewSet):
    queryset = ReviewDetail.objects.all()
    serializer_class = ReviewDetailSerializer
    permission_classes = [permissions.IsAuthenticated]
    
    def update(self, request, *args, **kwargs):
        response = super().update(request, *args, **kwargs)
        # Recalcular promedio del padre al guardar un detalle
        self.get_object().review.calculate_score()
        return response
</file>

<file path="backend/talent/migrations/0001_initial.py">
# Generated by Django 5.2.8 on 2025-11-24 08:15

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('core', '0001_initial'),
    ]

    operations = [
        migrations.CreateModel(
            name='BusinessFunction',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, help_text='Ej: Human Resources, Finance, IT', max_length=100, unique=True)),
                ('description', models.TextField(blank=True, null=True)),
            ],
        ),
        migrations.CreateModel(
            name='EducationLevel',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, help_text='Ej: Ingeniería, Maestría, Bachillerato', max_length=100, unique=True)),
            ],
        ),
        migrations.CreateModel(
            name='FieldOfStudy',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, help_text='Ej: Software, Recursos Humanos, N/A', max_length=100, unique=True)),
            ],
        ),
        migrations.CreateModel(
            name='Language',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, max_length=100, unique=True)),
            ],
        ),
        migrations.CreateModel(
            name='LanguageProficiency',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, max_length=50, unique=True)),
            ],
        ),
        migrations.CreateModel(
            name='PersonAward',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=255)),
                ('description', models.TextField(blank=True, null=True)),
                ('institution', models.CharField(blank=True, max_length=255, null=True)),
                ('issue_date', models.DateField()),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('person', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='awards', to='core.person')),
            ],
        ),
        migrations.CreateModel(
            name='PersonCertification',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=255)),
                ('description', models.TextField(blank=True, null=True)),
                ('institution', models.CharField(max_length=255)),
                ('effective_date', models.DateField()),
                ('expiration_date', models.DateField(blank=True, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('person', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='certifications', to='core.person')),
            ],
        ),
        migrations.CreateModel(
            name='CertificationDocument',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('file', models.FileField(blank=True, null=True, upload_to='documents/certification/')),
                ('description', models.CharField(blank=True, max_length=255, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('certification', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='documents', to='talent.personcertification')),
            ],
        ),
        migrations.CreateModel(
            name='PersonEducation',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('school_name', models.CharField(max_length=255)),
                ('start_date', models.DateField()),
                ('end_date', models.DateField(blank=True, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('field_of_study', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='talent.fieldofstudy')),
                ('level', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='talent.educationlevel')),
                ('person', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='education_history', to='core.person')),
            ],
        ),
        migrations.CreateModel(
            name='PersonFunctionalExperience',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('start_date', models.DateField()),
                ('end_date', models.DateField(blank=True, help_text='NULL si es actual', null=True)),
                ('comments', models.TextField(blank=True, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('function', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='talent.businessfunction')),
                ('person', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='functional_experiences', to='core.person')),
            ],
        ),
        migrations.CreateModel(
            name='PersonLanguage',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('language', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='talent.language')),
                ('person', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='languages', to='core.person')),
                ('reading_proficiency', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='reading', to='talent.languageproficiency')),
                ('speaking_proficiency', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='speaking', to='talent.languageproficiency')),
                ('writing_proficiency', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='writing', to='talent.languageproficiency')),
            ],
        ),
        migrations.CreateModel(
            name='PersonMembership',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('organization_name', models.CharField(max_length=255)),
                ('role', models.CharField(blank=True, max_length=255, null=True)),
                ('start_date', models.DateField()),
                ('end_date', models.DateField(blank=True, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('person', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='memberships', to='core.person')),
            ],
        ),
        migrations.CreateModel(
            name='PersonSpecialAssignment',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('project_name', models.CharField(max_length=255)),
                ('description', models.TextField(blank=True, null=True)),
                ('start_date', models.DateField()),
                ('end_date', models.DateField(blank=True, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('person', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='special_assignments', to='core.person')),
            ],
        ),
        migrations.CreateModel(
            name='PersonVolunteerExperience',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('organization_name', models.CharField(max_length=255)),
                ('role', models.CharField(max_length=255)),
                ('start_date', models.DateField()),
                ('end_date', models.DateField(blank=True, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('person', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='volunteer_experiences', to='core.person')),
            ],
        ),
    ]
</file>

<file path="backend/talent/admin.py">
from django.contrib import admin
from . import models

admin.site.register(models.PersonSpecialAssignment)
admin.site.register(models.BusinessFunction)
admin.site.register(models.PersonFunctionalExperience)
admin.site.register(models.PersonCertification)
admin.site.register(models.CertificationDocument)
admin.site.register(models.EducationLevel)
admin.site.register(models.FieldOfStudy)
admin.site.register(models.PersonEducation)
admin.site.register(models.PersonVolunteerExperience)
admin.site.register(models.PersonAward)
admin.site.register(models.PersonMembership)
admin.site.register(models.Language)
admin.site.register(models.LanguageProficiency)
admin.site.register(models.PersonLanguage)
</file>

<file path="backend/talent/urls.py">
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from . import views

router = DefaultRouter()
router.register(r'special-assignments', views.PersonSpecialAssignmentViewSet, basename='specialassignment')
router.register(r'business-functions', views.BusinessFunctionViewSet, basename='businessfunction')
router.register(r'functional-experiences', views.PersonFunctionalExperienceViewSet, basename='functionalexperience')
router.register(r'certifications', views.PersonCertificationViewSet, basename='certification')
router.register(r'certification-documents', views.CertificationDocumentViewSet, basename='certificationdocument')
router.register(r'education-levels', views.EducationLevelViewSet, basename='educationlevel')
router.register(r'fields-of-study', views.FieldOfStudyViewSet, basename='fieldofstudy')
router.register(r'education', views.PersonEducationViewSet, basename='education')
router.register(r'volunteer-experiences', views.PersonVolunteerExperienceViewSet, basename='volunteerexperience')
router.register(r'awards', views.PersonAwardViewSet, basename='award')
router.register(r'memberships', views.PersonMembershipViewSet, basename='membership')
router.register(r'languages', views.LanguageViewSet, basename='language')
router.register(r'language-proficiencies', views.LanguageProficiencyViewSet, basename='languageproficiency')
router.register(r'person-languages', views.PersonLanguageViewSet, basename='personlanguage')

urlpatterns = [
    path('', include(router.urls)),
]
</file>

<file path="backend/training/permissions.py">
from rest_framework import permissions

class IsInstructorOrAdmin(permissions.BasePermission):

    def has_object_permission(self, request, view, obj):
        # --- REGLA 1: PODER SUPREMO DEL ADMIN ---
        if request.user.is_staff or request.user.is_superuser:
            return True

        # --- REGLA 2: PROTECCIÓN CONTRA BORRADO ---
        # Nadie más que el admin puede eliminar registros
        if request.method == 'DELETE':
            return False

        # --- LÓGICA DE NAVEGACIÓN AL CURSO ---
        course = None
        
        # Caso A: El objeto es el Curso mismo
        if hasattr(obj, 'participants'): 
            course = obj
        # Caso B: El objeto es directo del curso (Resource, Session, Participant)
        elif hasattr(obj, 'course'):
            course = obj.course
        # Caso C: El objeto es nieto (AttendanceRecord -> Session -> Course)
        elif hasattr(obj, 'session'):
            course = obj.session.course

        # Si no se pudo determinar el curso o usuario sin perfil, denegar.
        if not course or not hasattr(request.user, 'person'):
            return False

        # --- REGLA 3: PERMISOS DEL INSTRUCTOR ---
        # Acceso total (menos borrar) sobre SU curso
        # 🔧 REFACTOR: Verificar instructor con course.instructor
        is_instructor = course.instructor == request.user.person

        if is_instructor:
            return True

        # --- REGLA 4: PERMISOS DEL ESTUDIANTE INSCRITO ---
        # Solo lectura sobre SU curso
        is_student = course.participants.filter(
            person=request.user.person
        ).exists()

        if is_student:
            if request.method in permissions.SAFE_METHODS:
                return True

        # --- REGLA 5: PERMISOS DE CATÁLOGO (USUARIO GENERAL) ---
        # Si no es ni instructor ni estudiante, pero el curso es PÚBLICO,
        # permitimos ver los detalles para que pueda decidir inscribirse.
        if request.method in permissions.SAFE_METHODS: # Solo GET/OPTIONS
            # Verificamos si el estatus es 'PRO' (Programado) o 'EJE' (En Ejecución)
            if course.status in ['PRO', 'EJE']:
                return True

        return False
</file>

<file path="backend/training/urls.py">
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from . import views

router = DefaultRouter()

# 1. Cursos (Gestión principal)
router.register(r'courses', views.CourseViewSet, basename='course')

# 2. Recursos (Archivos y Links)
router.register(r'resources', views.CourseResourceViewSet, basename='course-resource')

# 3. Sesiones (Clases individuales para asistencia)
router.register(r'sessions', views.CourseSessionViewSet, basename='course-session')

# 4. Participantes (Inscripciones de alumnos e instructores)
router.register(r'participants', views.CourseParticipantViewSet, basename='course-participant')

# 5. Asistencia (Registros puntuales)
router.register(r'attendance', views.AttendanceRecordViewSet, basename='attendance-record')

# 🆕 NEW: 6-8. Hierarchical Content (Modules, Lessons, Progress)
router.register(r'modules', views.CourseModuleViewSet, basename='course-module')
router.register(r'lessons', views.CourseLessonViewSet, basename='course-lesson')
router.register(r'lesson-progress', views.LessonProgressViewSet, basename='lesson-progress')

urlpatterns = [
    path('', include(router.urls)),
]
</file>

<file path="frontend2/app/(main)/admin/config/general/page.tsx">
"use client";

import { CatalogCard } from "@/components/catalogs/catalog-card";
import { Input } from "@/components/ui/input";
import {
    Globe2,
    Map,
    Users,
    HeartHandshake,
    MapPin,
    Phone,
    Cpu,
    Mail,
    Landmark,
    Wallet,
    Share2,
    Search,
    Hash,
} from "lucide-react";
import { useState } from "react";

const catalogs = [
    {
        title: "Países",
        description: "Gestión de países para direcciones y nacionalidades",
        icon: Globe2,
        href: "/admin/config/general/countries",
        gradient: "from-blue-900 via-blue-700 to-blue-500",
        iconColor: "text-blue-200/90"
    },
    {
        title: "Estados",
        description: "Gestión de estados y provincias por país",
        icon: Map,
        href: "/admin/config/general/states",
        gradient: "from-emerald-900 via-emerald-700 to-emerald-500",
        iconColor: "text-emerald-200/90"
    },
    {
        title: "Géneros",
        description: "Catálogo de géneros e identidades",
        icon: Users,
        href: "/admin/config/general/genders",
        gradient: "from-purple-900 via-purple-700 to-purple-500",
        iconColor: "text-purple-200/90"
    },
    {
        title: "Estado Civil",
        description: "Tipos de estado civil",
        icon: HeartHandshake,
        href: "/admin/config/general/marital-statuses",
        gradient: "from-pink-900 via-pink-700 to-pink-500",
        iconColor: "text-pink-200/90"
    },
    {
        title: "Tipos de Dirección",
        description: "Clasificación de direcciones (Casa, Trabajo, etc.)",
        icon: MapPin,
        href: "/admin/config/general/address-types",
        gradient: "from-orange-900 via-orange-700 to-orange-500",
        iconColor: "text-orange-200/90"
    },
    {
        title: "Tipos de Teléfono",
        description: "Clasificación de teléfonos (Móvil, Fijo, etc.)",
        icon: Phone,
        href: "/admin/config/general/phone-types",
        gradient: "from-cyan-900 via-cyan-700 to-cyan-500",
        iconColor: "text-cyan-200/90"
    },
    {
        title: "Operadoras",
        description: "Operadoras de telefonía móvil y fija",
        icon: Cpu,
        href: "/admin/config/general/phone-carriers",
        gradient: "from-indigo-900 via-indigo-700 to-indigo-500",
        iconColor: "text-indigo-200/90"
    },
    {
        title: "Tipos de Email",
        description: "Clasificación de correos (Personal, Corporativo)",
        icon: Mail,
        href: "/admin/config/general/email-types",
        gradient: "from-red-900 via-red-700 to-red-500",
        iconColor: "text-red-200/90"
    },
    {
        title: "Bancos",
        description: "Instituciones bancarias y financieras",
        icon: Landmark,
        href: "/admin/config/general/banks",
        gradient: "from-green-900 via-green-700 to-green-500",
        iconColor: "text-green-200/90"
    },
    {
        title: "Tipos de Cuenta",
        description: "Tipos de cuenta bancaria (Ahorro, Corriente)",
        icon: Wallet,
        href: "/admin/config/general/bank-account-types",
        gradient: "from-yellow-900 via-yellow-700 to-yellow-500",
        iconColor: "text-yellow-200/90"
    },
    {
        title: "Tipos de Relación",
        description: "Parentescos y tipos de relación familiar",
        icon: Share2,
        href: "/admin/config/general/relationship-types",
        gradient: "from-rose-900 via-rose-700 to-rose-500",
        iconColor: "text-rose-200/90"
    },
    {
        title: "Códigos de Operadora",
        description: "Códigos de área por operadora telefónica",
        icon: Hash,
        href: "/admin/config/general/phone-carrier-codes",
        gradient: "from-blue-950 via-blue-800 to-blue-600",
        iconColor: "text-blue-200/90"
    }
];

export default function GeneralConfigPage() {
    const [searchQuery, setSearchQuery] = useState("");

    const normalizeText = (text: string) =>
        text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();

    const filteredCatalogs = catalogs.filter(catalog =>
        normalizeText(catalog.title).includes(normalizeText(searchQuery)) ||
        normalizeText(catalog.description).includes(normalizeText(searchQuery))
    );

    return (
        <div className="space-y-6">
            <div className="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                <div>
                    <h1 className="text-3xl font-bold text-foreground">Catálogos Generales</h1>
                    <p className="text-muted-foreground">
                        Configuración de catálogos base del sistema
                    </p>
                </div>
                <div className="relative w-full md:w-72">
                    <Search className="absolute left-2 top-2.5 h-4 w-4 text-muted-foreground" />
                    <Input
                        placeholder="Buscar catálogos..."
                        className="pl-8"
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                    />
                </div>
            </div>

            <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                {filteredCatalogs.map((catalog) => (
                    <CatalogCard
                        key={catalog.href}
                        {...catalog}
                    />
                ))}
            </div>
        </div>
    );
}
</file>

<file path="frontend2/app/(main)/admin/dashboard/page.tsx">
"use client";

import { useEffect, useState, useMemo } from "react";
import {
    Users,
    TrendingUp,
    Briefcase,
    ArrowUpRight,
    ArrowDownRight,
    GraduationCap,
    ClipboardCheck,
    UserPlus,
    BookOpen,
} from "lucide-react";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { BarChart, Bar, AreaChart, Area, LineChart, Line, XAxis, YAxis, CartesianGrid, ResponsiveContainer, PieChart, Pie, Cell, Label, Sector } from "recharts";
import { PieSectorDataItem } from "recharts/types/polar/Pie";
import { ChartConfig, ChartContainer, ChartTooltip, ChartTooltipContent, ChartLegend, ChartLegendContent, ChartStyle } from "@/components/ui/chart";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import apiClient from "@/lib/api-client";
import Link from "next/link";

interface DashboardStats {
    employees: {
        total: number;
        active: number;
        change: number;
    };
    courses: {
        total: number;
        active_enrollments: number;
        change: number;
    };
    performance_reviews: {
        total: number;
        pending: number;
        completed: number;
    };
    recruitment: {
        active_jobs: number;
        total_candidates: number;
        new_this_month: number;
    };
}

// Colores del brand theme
const BRAND_COLORS = {
    primary: "#F213A4",
    secondary: "#15BF0F",
    tertiary: "#F29F05",
};

const dashboardChartConfig = {
    empleados: {
        label: "Empleados Activos",
        color: "hsl(var(--brand-primary))",
    },
    inscritos: {
        label: "Personal Inscrito",
        color: "hsl(var(--brand-secondary))",
    },
    nuevos: {
        label: "Nuevas Contrataciones",
        color: "hsl(var(--brand-tertiary))",
    },
} satisfies ChartConfig;

const PIE_COLORS = [BRAND_COLORS.primary, BRAND_COLORS.secondary, BRAND_COLORS.tertiary, "#8884d8", "#82ca9d", "#ffc658"];

export default function DashboardPage() {
    const [stats, setStats] = useState<DashboardStats | null>(null);
    const [loading, setLoading] = useState(true);

    // State para datos de charts (se cargarán desde el backend)
    const [employeeTrendData, setEmployeeTrendData] = useState<any[]>([]);
    const [courseEnrollmentData, setCourseEnrollmentData] = useState<any[]>([]);
    const [departmentData, setDepartmentData] = useState<any[]>([]);
    const [hiringData, setHiringData] = useState<any[]>([]);
    const [activeDepartment, setActiveDepartment] = useState<string>("General");

    const departmentConfig = useMemo(() => {
        const config: ChartConfig = {};
        departmentData.forEach((item) => {
            config[item.name] = {
                label: item.name,
                color: item.fill,
            };
        });
        return config;
    }, [departmentData]);

    useEffect(() => {
        loadDashboardData();
    }, []);

    async function loadDashboardData() {
        try {
            // Cargar datos reales de varios endpoints con paginación completa
            const [employeesRes, coursesRes, reviewsRes, jobsRes, candidatesRes, departmentsRes, participantsRes] = await Promise.all([
                apiClient.get("/api/employment/employments/?page_size=1000").catch((e) => { console.error("Error loading employees:", e); return { data: { results: [] } }; }),
                apiClient.get("/api/training/courses/?page_size=1000").catch((e) => { console.error("Error loading courses:", e); return { data: { results: [] } }; }),
                apiClient.get("/api/performance/reviews/?page_size=1000").catch((e) => { console.error("Error loading reviews:", e); return { data: { results: [] } }; }),
                apiClient.get("/api/ats/jobs/").catch((e) => { console.error("Error loading jobs:", e); return { data: { results: [] } }; }),
                apiClient.get("/api/ats/candidates/?page_size=1000").catch((e) => { console.error("Error loading candidates:", e); return { data: { results: [] } }; }),
                apiClient.get("/api/organization/departments/").catch((e) => { console.error("Error loading departments:", e); return { data: { results: [] } }; }),
                apiClient.get("/api/training/participants/?page_size=1000").catch((e) => { console.error("Error loading participants:", e); return { data: { results: [] } }; }),
            ]);

            const employees = employeesRes.data?.results || [];
            const courses = coursesRes.data?.results || [];
            const reviews = reviewsRes.data?.results || [];
            const jobs = jobsRes.data?.results || [];
            const candidates = candidatesRes.data?.results || [];
            const departments = departmentsRes.data?.results || [];
            const participants = participantsRes.data?.results || [];

            console.log("Dashboard Data Loaded:", {
                employees: employees.length,
                courses: courses.length,
                reviews: reviews.length,
                jobs: jobs.length,
                candidates: candidates.length,
                participants: participants.length,
            });

            // Estadísticas generales
            const employeeCount = employees.length;
            const activeJobs = jobs.filter((j: any) => j.status === "PUBLISHED").length;
            const pendingReviews = reviews.filter((r: any) => r.status === "BOR").length;
            const completedReviews = reviews.filter((r: any) => r.status === "ACE").length;

            // Calcular tendencia de empleados por mes (últimos 6 meses)
            const monthNames = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
            const now = new Date();
            const employeeTrend: any[] = [];

            for (let i = 5; i >= 0; i--) {
                const targetDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const monthName = monthNames[targetDate.getMonth()];

                const employeesUpToMonth = employees.filter((emp: any) => {
                    if (!emp.hire_date) return true; // Contar empleados sin fecha como existentes
                    const hireDate = new Date(emp.hire_date);
                    return hireDate <= targetDate;
                }).length;

                const newHires = employees.filter((emp: any) => {
                    if (!emp.hire_date) return false;
                    const hireDate = new Date(emp.hire_date);
                    return hireDate.getMonth() === targetDate.getMonth() &&
                        hireDate.getFullYear() === targetDate.getFullYear();
                }).length;

                employeeTrend.push({
                    mes: monthName,
                    empleados: employeesUpToMonth || 0,
                    nuevos: newHires || 0
                });
            }
            setEmployeeTrendData(employeeTrend);
            setHiringData(employeeTrend);

            // Calcular inscripciones en cursos por mes
            const courseEnrollments: any[] = [];
            for (let i = 5; i >= 0; i--) {
                const targetDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const monthName = monthNames[targetDate.getMonth()];

                const enrollmentsUpToMonth = participants.filter((p: any) => {
                    if (!p.enrollment_date && !p.created_at) return true; // Contar participantes sin fecha
                    const enrollDate = new Date(p.enrollment_date || p.created_at);
                    return enrollDate <= targetDate;
                }).length;

                courseEnrollments.push({ mes: monthName, inscritos: enrollmentsUpToMonth || 0 });
            }
            setCourseEnrollmentData(courseEnrollments);

            // Calcular distribución por departamento
            const deptDistribution = new Map<string, number>();
            employees.forEach((emp: any) => {
                const deptName = emp.department_name || "Sin Departamento";
                deptDistribution.set(deptName, (deptDistribution.get(deptName) || 0) + 1);
            });

            const deptData = Array.from(deptDistribution.entries())
                .map(([name, value]) => ({ name, value }))
                .sort((a, b) => b.value - a.value)
                .slice(0, 6)
                .map((item, index) => ({
                    ...item,
                    fill: PIE_COLORS[index % PIE_COLORS.length]
                }));

            // Si no hay datos de departamentos, crear datos de ejemplo
            if (deptData.length === 0 && employees.length > 0) {
                deptData.push({
                    name: "General",
                    value: employees.length,
                    fill: PIE_COLORS[0]
                } as any);
            }
            setDepartmentData(deptData);

            // Calcular estadísticas
            const lastMonthParticipants = courseEnrollments[courseEnrollments.length - 1]?.inscritos || 0;
            const prevMonthParticipants = courseEnrollments[courseEnrollments.length - 2]?.inscritos || 0;
            const courseGrowth = prevMonthParticipants > 0
                ? ((lastMonthParticipants - prevMonthParticipants) / prevMonthParticipants * 100).toFixed(1)
                : "0";

            const lastMonthEmployees = employeeTrend[employeeTrend.length - 1]?.empleados || 0;
            const prevMonthEmployees = employeeTrend[employeeTrend.length - 2]?.empleados || 0;
            const employeeGrowth = prevMonthEmployees > 0
                ? ((lastMonthEmployees - prevMonthEmployees) / prevMonthEmployees * 100).toFixed(1)
                : "0";

            setStats({
                employees: {
                    total: employeeCount,
                    active: employeeCount,
                    change: parseFloat(employeeGrowth),
                },
                courses: {
                    total: courses.length,
                    active_enrollments: lastMonthParticipants,
                    change: parseFloat(courseGrowth),
                },
                performance_reviews: {
                    total: reviews.length,
                    pending: pendingReviews,
                    completed: completedReviews,
                },
                recruitment: {
                    active_jobs: activeJobs,
                    total_candidates: candidates.length,
                    new_this_month: candidates.filter((c: any) => {
                        if (!c.created_at) return false;
                        const created = new Date(c.created_at);
                        return created.getMonth() === now.getMonth() &&
                            created.getFullYear() === now.getFullYear();
                    }).length,
                },
            });
        } catch (error) {
            console.error("Error loading dashboard data:", error);
        } finally {
            setLoading(false);
        }
    }

    // Interactive Pie Chart Logic
    const activeIndex = useMemo(
        () => departmentData.findIndex((item) => item.name === activeDepartment),
        [activeDepartment, departmentData]
    );
    const departments = useMemo(() => departmentData.map((item) => item.name), [departmentData]);

    useEffect(() => {
        if (departmentData.length > 0 && !departments.includes(activeDepartment)) {
            setActiveDepartment(departmentData[0].name);
        }
    }, [departmentData, activeDepartment, departments]);

    if (loading) {
        return (
            <div className="flex items-center justify-center min-h-screen">
                <p className="text-muted-foreground">Cargando dashboard...</p>
            </div>
        );
    }

    const statsCards = [
        {
            title: "Total Empleados",
            value: stats?.employees.total.toString() || "0",
            change: stats?.employees.change ? `${stats.employees.change > 0 ? '+' : ''}${stats.employees.change.toFixed(1)}%` : "0%",
            isPositive: (stats?.employees.change || 0) >= 0,
            icon: <Users className="w-6 h-6" />,
            color: "brand-primary",
            link: "/admin/personnel/employees",
        },
        {
            title: "Cursos de Capacitación",
            value: stats?.courses.total.toString() || "0",
            change: `${stats?.courses.active_enrollments || 0} inscripciones`,
            isPositive: true,
            icon: <BookOpen className="w-6 h-6" />,
            color: "brand-secondary",
            link: "/admin/training",
        },
        {
            title: "Evaluaciones Completadas",
            value: stats?.performance_reviews.completed.toString() || "0",
            change: `${stats?.performance_reviews.pending || 0} pendientes`,
            isPositive: (stats?.performance_reviews.pending || 0) === 0,
            icon: <ClipboardCheck className="w-6 h-6" />,
            color: "brand-tertiary",
            link: "/admin/performance/reviews",
        },
        {
            title: "Proceso de Reclutamiento",
            value: stats?.recruitment.active_jobs.toString() || "0",
            change: `${stats?.recruitment.total_candidates || 0} candidatos`,
            isPositive: (stats?.recruitment.total_candidates || 0) > 0,
            icon: <Briefcase className="w-6 h-6" />,
            color: "brand-primary",
            link: "/admin/ats/jobs",
        },
    ];



    return (
        <>
            {/* Page Header */}
            <div className="mb-6">
                <h1 className="text-3xl font-bold text-foreground mb-2">Dashboard</h1>
                <p className="text-muted-foreground">
                    Bienvenido al sistema de gestión IUTIRLA - Extensión Porlamar
                </p>
            </div>

            {/* Stats Grid */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                {statsCards.map((stat, index) => (
                    <Link key={index} href={stat.link}>
                        <div className="bg-card border border-border rounded-lg p-6 hover:shadow-lg transition-all cursor-pointer">
                            <div className="flex items-center justify-between mb-4">
                                <div
                                    className={`w-12 h-12 rounded-lg flex items-center justify-center`}
                                    style={{ backgroundColor: `hsl(var(--${stat.color}) / 0.1)` }}
                                >
                                    <div style={{ color: `hsl(var(--${stat.color}))` }}>{stat.icon}</div>
                                </div>
                                <div
                                    className={`flex items-center gap-1 text-sm font-semibold ${stat.isPositive ? "text-brand-secondary" : "text-destructive"
                                        }`}
                                >
                                    {stat.isPositive ? (
                                        <ArrowUpRight className="w-4 h-4" />
                                    ) : (
                                        <ArrowDownRight className="w-4 h-4" />
                                    )}
                                    {stat.change}
                                </div>
                            </div>
                            <h3 className="text-2xl font-bold text-foreground mb-1">{stat.value}</h3>
                            <p className="text-sm text-muted-foreground">{stat.title}</p>
                        </div>
                    </Link>
                ))}
            </div>

            {/* Charts Grid */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                {/* Employee Trend Chart */}
                <Card>
                    <CardHeader>
                        <CardTitle>Crecimiento de Personal</CardTitle>
                        <CardDescription>Empleados activos últimos 6 meses</CardDescription>
                    </CardHeader>
                    <CardContent>
                        <ChartContainer config={dashboardChartConfig} className="h-[300px] w-full">
                            <AreaChart data={employeeTrendData}>
                                <defs>
                                    <linearGradient id="colorEmpleados" x1="0" y1="0" x2="0" y2="1">
                                        <stop offset="5%" stopColor={BRAND_COLORS.primary} stopOpacity={0.8} />
                                        <stop offset="95%" stopColor={BRAND_COLORS.primary} stopOpacity={0} />
                                    </linearGradient>
                                </defs>
                                <CartesianGrid strokeDasharray="3 3" stroke="hsl(var(--border))" />
                                <XAxis dataKey="mes" stroke="hsl(var(--muted-foreground))" fontSize={12} />
                                <YAxis stroke="hsl(var(--muted-foreground))" fontSize={12} />
                                <ChartTooltip content={<ChartTooltipContent />} />
                                <Area
                                    type="monotone"
                                    dataKey="empleados"
                                    stroke={BRAND_COLORS.primary}
                                    strokeWidth={2}
                                    fillOpacity={1}
                                    fill="url(#colorEmpleados)"
                                    name="Empleados Activos"
                                />
                            </AreaChart>
                        </ChartContainer>
                    </CardContent>
                </Card>

                {/* Course Enrollment Trend */}
                <Card>
                    <CardHeader>
                        <CardTitle>Inscripciones en Capacitación</CardTitle>
                        <CardDescription>Personal inscrito en programas de formación</CardDescription>
                    </CardHeader>
                    <CardContent>
                        <ChartContainer config={dashboardChartConfig} className="h-[300px] w-full">
                            <LineChart data={courseEnrollmentData}>
                                <CartesianGrid strokeDasharray="3 3" stroke="hsl(var(--border))" />
                                <XAxis dataKey="mes" stroke="hsl(var(--muted-foreground))" fontSize={12} />
                                <YAxis stroke="hsl(var(--muted-foreground))" fontSize={12} />
                                <ChartTooltip content={<ChartTooltipContent />} />
                                <Line
                                    type="monotone"
                                    dataKey="inscritos"
                                    stroke={BRAND_COLORS.secondary}
                                    strokeWidth={3}
                                    dot={{ fill: BRAND_COLORS.secondary, r: 4 }}
                                    name="Personal Inscrito"
                                />
                            </LineChart>
                        </ChartContainer>
                    </CardContent>
                </Card>
            </div>

            {/* Second Row Charts */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                {/* Department Distribution */}
                <Card data-chart="pie-interactive" className="flex flex-col">
                    <ChartStyle id="pie-interactive" config={departmentConfig} />
                    <CardHeader className="flex-row items-start space-y-0 pb-0">
                        <div className="grid gap-1">
                            <CardTitle>Distribución por Departamento</CardTitle>
                            <CardDescription>Empleados por área organizacional</CardDescription>
                        </div>
                        <Select value={activeDepartment} onValueChange={setActiveDepartment}>
                            <SelectTrigger
                                className="ml-auto h-7 w-[250px] rounded-lg pl-2.5"
                                aria-label="Select a value"
                            >
                                <SelectValue placeholder="Select department" />
                            </SelectTrigger>
                            <SelectContent align="end" className="rounded-xl">
                                {departments.map((key) => {
                                    const config = departmentConfig[key];
                                    if (!config) return null;
                                    return (
                                        <SelectItem
                                            key={key}
                                            value={key}
                                            className="rounded-lg [&_span]:flex"
                                        >
                                            <div className="flex items-center gap-2 text-xs">
                                                <span
                                                    className="flex h-3 w-3 shrink-0 rounded-sm"
                                                    style={{
                                                        backgroundColor: config.color,
                                                    }}
                                                />
                                                {config?.label}
                                            </div>
                                        </SelectItem>
                                    );
                                })}
                            </SelectContent>
                        </Select>
                    </CardHeader>
                    <CardContent className="flex flex-1 justify-center pb-0">
                        <ChartContainer
                            id="pie-interactive"
                            config={departmentConfig}
                            className="mx-auto aspect-square w-full max-w-[300px]"
                        >
                            <PieChart>
                                <ChartTooltip
                                    cursor={false}
                                    content={<ChartTooltipContent hideLabel />}
                                />
                                <Pie
                                    data={departmentData}
                                    dataKey="value"
                                    nameKey="name"
                                    innerRadius={60}
                                    strokeWidth={5}
                                    // @ts-ignore
                                    activeIndex={activeIndex}
                                    activeShape={({
                                        outerRadius = 0,
                                        ...props
                                    }: any) => (
                                        <g>
                                            <Sector {...props} outerRadius={outerRadius + 10} />
                                            <Sector
                                                {...props}
                                                outerRadius={outerRadius + 25}
                                                innerRadius={outerRadius + 12}
                                            />
                                        </g>
                                    )}
                                >
                                    <Label
                                        content={({ viewBox }) => {
                                            if (viewBox && "cx" in viewBox && "cy" in viewBox) {
                                                return (
                                                    <text
                                                        x={viewBox.cx}
                                                        y={viewBox.cy}
                                                        textAnchor="middle"
                                                        dominantBaseline="middle"
                                                    >
                                                        <tspan
                                                            x={viewBox.cx}
                                                            y={viewBox.cy}
                                                            className="fill-foreground text-3xl font-bold"
                                                        >
                                                            {departmentData[activeIndex]?.value.toLocaleString()}
                                                        </tspan>
                                                        <tspan
                                                            x={viewBox.cx}
                                                            y={(viewBox.cy || 0) + 24}
                                                            className="fill-muted-foreground"
                                                        >
                                                            Empleados
                                                        </tspan>
                                                    </text>
                                                );
                                            }
                                        }}
                                    />
                                </Pie>
                            </PieChart>
                        </ChartContainer>
                    </CardContent>
                </Card>

                {/* New Hires Bar Chart */}
                <Card>
                    <CardHeader>
                        <CardTitle>Nuevas Contrataciones</CardTitle>
                        <CardDescription>Personal incorporado mensualmente</CardDescription>
                    </CardHeader>
                    <CardContent>
                        <ChartContainer config={dashboardChartConfig} className="h-[300px] w-full">
                            <BarChart data={hiringData}>
                                <CartesianGrid strokeDasharray="3 3" stroke="hsl(var(--border))" />
                                <XAxis dataKey="mes" stroke="hsl(var(--muted-foreground))" fontSize={12} />
                                <YAxis stroke="hsl(var(--muted-foreground))" fontSize={12} />
                                <ChartTooltip content={<ChartTooltipContent />} />
                                <Bar
                                    dataKey="nuevos"
                                    fill={BRAND_COLORS.tertiary}
                                    radius={[8, 8, 0, 0]}
                                    name="Nuevas Contrataciones"
                                />
                            </BarChart>
                        </ChartContainer>
                    </CardContent>
                </Card>
            </div>

            {/* Bottom Section */}
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                {/* Quick Actions */}
                <Card>
                    <CardHeader>
                        <CardTitle>Acciones Rápidas</CardTitle>
                    </CardHeader>
                    <CardContent className="space-y-2">
                        <Link href="/admin/personnel/employees/new">
                            <button className="w-full bg-brand-primary text-brand-primary-foreground p-3 rounded-lg font-semibold text-sm hover:opacity-90 transition-opacity flex items-center justify-center gap-2">
                                <UserPlus className="w-4 h-4" />
                                Nuevo Empleado
                            </button>
                        </Link>
                        <Link href="/admin/training/new">
                            <button className="w-full bg-brand-secondary text-brand-secondary-foreground p-3 rounded-lg font-semibold text-sm hover:opacity-90 transition-opacity flex items-center justify-center gap-2">
                                <BookOpen className="w-4 h-4" />
                                Nuevo Curso
                            </button>
                        </Link>
                        <Link href="/admin/ats/jobs/new">
                            <button className="w-full bg-brand-tertiary text-brand-tertiary-foreground p-3 rounded-lg font-semibold text-sm hover:opacity-90 transition-opacity flex items-center justify-center gap-2">
                                <Briefcase className="w-4 h-4" />
                                Nueva Vacante
                            </button>
                        </Link>
                    </CardContent>
                </Card>

                {/* Recent Activity */}
                <Card className="lg:col-span-2">
                    <CardHeader>
                        <CardTitle>Actividad Reciente</CardTitle>
                    </CardHeader>
                    <CardContent>
                        <div className="space-y-4">
                            {[
                                {
                                    action: "Nueva evaluación completada",
                                    person: "María González",
                                    time: "Hace 15 minutos",
                                    color: "brand-primary",
                                },
                                {
                                    action: "Candidato postulado",
                                    person: "Sistema ATS",
                                    time: "Hace 1 hora",
                                    color: "brand-secondary",
                                },
                                {
                                    action: "Curso publicado",
                                    person: "Carlos Rodríguez",
                                    time: "Hace 2 horas",
                                    color: "brand-tertiary",
                                },
                                {
                                    action: "Empleado registrado",
                                    person: "Juan Pérez",
                                    time: "Hace 3 horas",
                                    color: "brand-primary",
                                },
                            ].map((activity, index) => (
                                <div
                                    key={index}
                                    className="flex items-start gap-3 pb-4 border-b border-border last:border-b-0 last:pb-0"
                                >
                                    <div
                                        className={`w-2 h-2 rounded-full mt-2 shrink-0`}
                                        style={{ backgroundColor: `hsl(var(--${activity.color}))` }}
                                    ></div>
                                    <div className="flex-1 min-w-0">
                                        <p className="text-sm text-foreground font-medium">{activity.action}</p>
                                        <p className="text-sm text-muted-foreground">
                                            {activity.person} • {activity.time}
                                        </p>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </CardContent>
                </Card>
            </div>
        </>
    );
}
</file>

<file path="frontend2/app/(main)/admin/organization/positions/[id]/page.tsx">
"use client";

import { use, useEffect } from "react";
import useSWR from "swr";
import { useRouter, usePathname } from "next/navigation";
import { ArrowLeft, Briefcase, Users, UserCheck, Building2, ListChecks, ScrollText, Target } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Skeleton } from "@/components/ui/skeleton";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { CatalogCRUD, CatalogField } from "@/components/catalogs/catalog-crud";
import { ColumnDef } from "@tanstack/react-table";
import apiClient from "@/lib/api-client";
import { useBreadcrumb } from "@/context/breadcrumb-context";

// Interfaces matching backend serializer
interface PositionRequirement {
    id: number;
    description: string;
}

interface PositionFunction {
    id: number;
    description: string;
}

interface Position {
    id: number;
    department_name: string;
    job_title_name: string;
    full_name: string;
    vacancies: number;
    active_employees_count: number;
    reports_to_names_display: string;
    requirements: PositionRequirement[];
    functions: PositionFunction[];
    objective?: string;
}

const fetcher = (url: string) => apiClient.get(url).then((res) => res.data);

export default function PositionDetailPage({ params }: { params: Promise<{ id: string }> }) {
    const { id } = use(params);
    const router = useRouter();
    const pathname = usePathname();
    const { setLabel } = useBreadcrumb();
    const { data: position, error, isLoading } = useSWR<Position>(`/api/organization/positions/${id}/`, fetcher);

    useEffect(() => {
        if (position) {
            // Normalize path by removing trailing slash if present to match DynamicBreadcrumbs key generation
            const normalizedPath = pathname.endsWith('/') ? pathname.slice(0, -1) : pathname;
            setLabel(normalizedPath, position.job_title_name);
        }
    }, [position, pathname, setLabel]);

    if (isLoading) {
        return <PositionDetailSkeleton />;
    }

    if (error || !position) {
        return (
            <div className="flex flex-col items-center justify-center h-full p-8 text-center">
                <h2 className="text-2xl font-bold text-destructive mb-2">Error</h2>
                <p className="text-muted-foreground mb-4">No se pudo cargar la información del cargo.</p>
                <Button onClick={() => router.back()}>Volver</Button>
            </div>
        );
    }

    // Configuration for Functions Catalog
    const functionsFields: CatalogField[] = [
        { name: "description", label: "Descripción", type: "textarea", required: true },
    ];
    const functionsColumns: ColumnDef<PositionFunction>[] = [
        { accessorKey: "description", header: "Descripción", cell: ({ row }) => <div className="whitespace-pre-wrap">{row.getValue("description")}</div> },
    ];

    // Configuration for Requirements Catalog
    const requirementsFields: CatalogField[] = [
        { name: "description", label: "Descripción", type: "textarea", required: true },
    ];
    const requirementsColumns: ColumnDef<PositionRequirement>[] = [
        { accessorKey: "description", header: "Descripción", cell: ({ row }) => <div className="whitespace-pre-wrap">{row.getValue("description")}</div> },
    ];

    return (
        <div className="flex flex-col h-full space-y-6 p-8">
            {/* Header */}
            <div className="flex items-center justify-between border-b pb-6">
                <div>
                    <h1 className="text-2xl font-bold tracking-tight">{position.job_title_name}</h1>
                    <div className="flex items-center text-muted-foreground mt-1">
                        <Building2 className="h-4 w-4 mr-2" />
                        <span>{position.department_name}</span>
                    </div>
                </div>
                <Button variant="outline" onClick={() => router.back()}>
                    <ArrowLeft className="mr size-4" />
                </Button>
            </div>

            <Tabs defaultValue="general" className="flex-1 flex flex-col">
                <TabsList className="w-full flex flex-col md:grid md:grid-cols-3 h-auto p-1 bg-muted/50 gap-1">
                    <TabsTrigger
                        value="general"
                        className="data-[state=active]:bg-primary data-[state=active]:text-primary-foreground py-3 transition-all duration-300 w-full"
                    >
                        <Briefcase className="mr-1 size-4" />
                        <p className="truncate">
                            Información General
                        </p>
                    </TabsTrigger>
                    <TabsTrigger
                        value="functions"
                        className="data-[state=active]:bg-primary data-[state=active]:text-primary-foreground py-3 transition-all duration-300 w-full"
                    >
                        <ListChecks className="mr-1 size-4" />
                        <p className="truncate">
                            Funciones
                        </p>
                    </TabsTrigger>
                    <TabsTrigger
                        value="requirements"
                        className="data-[state=active]:bg-primary data-[state=active]:text-primary-foreground py-3 transition-all duration-300 w-full"
                    >
                        <ScrollText className="mr-1 size-4" />
                        <p className="truncate">
                            Requisitos
                        </p>
                    </TabsTrigger>
                </TabsList>

                <div className="flex-1 mt-6">
                    <TabsContent value="general" className="m-0 h-full">
                        <div className="flex flex-col gap-6 w-full">
                            <Card className="hover:shadow-md transition-shadow">
                                <CardHeader>
                                    <CardTitle className="text-lg flex items-center gap-2">
                                        <Target className="h-5 w-5 text-primary" />
                                        Objetivo del Cargo
                                    </CardTitle>
                                </CardHeader>
                                <CardContent>
                                    <p className="text-sm leading-relaxed text-muted-foreground">
                                        {position.objective || "No se ha definido un objetivo para este cargo."}
                                    </p>
                                </CardContent>
                            </Card>

                            <Card className="hover:shadow-md transition-shadow">
                                <CardHeader>
                                    <CardTitle className="text-lg flex items-center gap-2">
                                        <UserCheck className="h-5 w-5 text-primary" />
                                        Jerarquía
                                    </CardTitle>
                                </CardHeader>
                                <CardContent>
                                    <h4 className="text-sm font-medium mb-2 text-muted-foreground">Reporta a:</h4>
                                    <p className="text-sm text-muted-foreground">
                                        {position.reports_to_names_display || "Posición de mayor jerarquía"}
                                    </p>
                                </CardContent>
                            </Card>

                            <Card className="hover:shadow-md transition-shadow">
                                <CardHeader>
                                    <CardTitle className="text-lg flex items-center gap-2">
                                        <Users className="h-5 w-5 text-primary" />
                                        Ocupación
                                    </CardTitle>
                                </CardHeader>
                                <CardContent className="space-y-4">
                                    <div className="flex justify-between items-center">
                                        <span className="text-sm font-medium text-muted-foreground">Vacantes Totales</span>
                                        <span className="text-sm font-bold">{position.vacancies}</span>
                                    </div>
                                    <div className="flex justify-between items-center">
                                        <span className="text-sm font-medium text-muted-foreground">Ocupadas</span>
                                        <span className="text-sm font-bold">{position.active_employees_count}</span>
                                    </div>
                                    <div className="flex justify-between items-center">
                                        <span className="text-sm font-medium text-muted-foreground">Disponibles</span>
                                        <span className="text-sm font-bold">
                                            {Math.max(0, position.vacancies - position.active_employees_count)}
                                        </span>
                                    </div>
                                </CardContent>
                            </Card>
                        </div>
                    </TabsContent>

                    <TabsContent value="functions" className="m-0 h-full">
                        <CatalogCRUD
                            title=""
                            apiUrl={`/api/organization/positions/${id}/functions/`}
                            fields={functionsFields}
                            columns={functionsColumns}
                            searchKey="description"
                        />
                    </TabsContent>

                    <TabsContent value="requirements" className="m-0 h-full">
                        <CatalogCRUD
                            title=""
                            apiUrl={`/api/organization/positions/${id}/requirements/`}
                            fields={requirementsFields}
                            columns={requirementsColumns}
                            searchKey="description"
                        />
                    </TabsContent>
                </div>
            </Tabs>
        </div>
    );
}

function PositionDetailSkeleton() {
    return (
        <div className="space-y-6 p-6">
            <div className="flex items-center gap-4">
                <Skeleton className="h-10 w-10 rounded-md" />
                <div className="space-y-2">
                    <Skeleton className="h-8 w-64" />
                    <Skeleton className="h-4 w-48" />
                </div>
            </div>
            <div className="grid gap-6 md:grid-cols-3">
                <div className="space-y-6">
                    <Skeleton className="h-[300px] w-full" />
                </div>
                <div className="md:col-span-2 space-y-6">
                    <Skeleton className="h-[200px] w-full" />
                    <Skeleton className="h-[200px] w-full" />
                </div>
            </div>
        </div>
    );
}
</file>

<file path="frontend2/app/(main)/admin/personnel/people/page.tsx">
"use client";

import { CatalogCRUD, CatalogField } from "@/components/catalogs/catalog-crud";
import { ColumnDef } from "@tanstack/react-table";
import { DropdownMenuItem } from "@/components/ui/dropdown-menu";
import { Button } from "@/components/ui/button";
import { Eye, User, Plus, Users } from "lucide-react";
import Link from "next/link";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";

export default function PeoplePage() {
    const fields: CatalogField[] = [
        { name: "first_name", label: "Primer Nombre", type: "text", required: true },
        { name: "second_name", label: "Segundo Nombre", type: "text", required: false },
        { name: "paternal_surname", label: "Apellido Paterno", type: "text", required: true },
        { name: "maternal_surname", label: "Apellido Materno", type: "text", required: false },
        {
            name: "gender",
            label: "Género",
            type: "select",
            required: true,
            optionsUrl: "/api/core/genders/",
            optionLabelKey: "name",
            optionValueKey: "id"
        },
        {
            name: "marital_status",
            label: "Estado Civil",
            type: "select",
            required: false,
            optionsUrl: "/api/core/marital-statuses/",
            optionLabelKey: "name",
            optionValueKey: "id"
        },
        { name: "birthdate", label: "Fecha de Nacimiento", type: "date", required: true },
        {
            name: "cedula_prefix",
            label: "Prefijo Cédula",
            type: "select",
            required: false,
            options: [
                { value: "V", label: "V" },
                { value: "E", label: "E" }
            ]
        },
        { name: "cedula_number", label: "Número Cédula", type: "text", required: false },
        {
            name: "country_of_birth",
            label: "País de Nacimiento",
            type: "select",
            required: false,
            optionsUrl: "/api/core/countries/",
            optionLabelKey: "name",
            optionValueKey: "id"
        },
    ];

    const columns: ColumnDef<any>[] = [
        {
            accessorKey: "photo",
            header: "",
            cell: ({ row }) => (
                <Avatar className="h-9 w-9">
                    <AvatarImage src={row.getValue("photo")} alt={row.original.full_name} />
                    <AvatarFallback><User className="h-4 w-4" /></AvatarFallback>
                </Avatar>
            ),
            enableSorting: false,
            size: 50,
        },
        {
            accessorKey: "full_name",
            header: "Nombre Completo",
            cell: ({ row }) => <div className="font-medium">{row.getValue("full_name")}</div>
        },
        {
            accessorKey: "primary_document",
            header: "Cédula",
            cell: ({ row }) => <div className="truncate">{row.getValue("primary_document")}</div>
        },
        {
            accessorKey: "primary_email",
            header: "Email",
            cell: ({ row }) => <div className="truncate">{row.getValue("primary_email")}</div>
        },
        {
            accessorKey: "primary_phone",
            header: "Teléfono",
            cell: ({ row }) => <div className="truncate">{row.getValue("primary_phone")}</div>
        },
    ];

    return (
        <div className="h-full flex-1 flex-col space-y-8 p-8 md:flex">
            <CatalogCRUD
                title="Personas"
                icon={Users}
                apiUrl="/api/core/persons/"
                fields={fields}
                columns={columns}
                searchKey="search"
                searchOptions={[
                    { label: "Nombre", value: "search" }
                ]}
                disableCreate={true}
                disableEdit={true}
                customToolbarActions={
                    <Button asChild variant="outline">
                        <Link href="/admin/personnel/people/new">
                            <Plus className="h-4 w-4" />
                            Nueva Persona
                        </Link>
                    </Button>
                }
                extraActions={(item) => (
                    <DropdownMenuItem asChild>
                        <Link href={`/admin/personnel/people/${item.id}`} className="cursor-pointer w-full flex items-center">
                            <Eye className="mr-2 h-4 w-4" />
                            Ver Detalle
                        </Link>
                    </DropdownMenuItem>
                )}
            />
        </div>
    );
}
</file>

<file path="frontend2/app/(main)/layout.tsx">
import { DashboardLayout } from "@/components/layout/dashboard-layout";
import { ProtectedRoute } from "@/components/protected-route";

import { BreadcrumbProvider } from "@/context/breadcrumb-context";

export default function MainLayout({
    children
}: {
    children: React.ReactNode
}) {
    return (
        <ProtectedRoute>
            <BreadcrumbProvider>
                <DashboardLayout>
                    {children}
                </DashboardLayout>
            </BreadcrumbProvider>
        </ProtectedRoute>
    );
}
</file>

<file path="frontend2/app/(main)/page.tsx">
"use client";

import {
    Users,
    GraduationCap,
    Briefcase,
    Settings,
    Gauge,
    BookOpen
} from "lucide-react";
import Link from "next/link";
import { useAuth } from "@/context/auth-context";

export default function HomePage() {
    const { user } = useAuth();
    const isAdmin = user?.is_staff;

    const adminCards = [
        {
            title: "Gestión de Personal",
            description: "Administra empleados, contratos y expedientes.",
            icon: Users,
            href: "/admin/personnel/employees",
            color: "text-blue-500",
            bg: "bg-blue-50"
        },
        {
            title: "Evaluación de Desempeño",
            description: "Gestiona períodos, competencias y revisiones.",
            icon: Gauge,
            href: "/admin/performance/periods",
            color: "text-purple-500",
            bg: "bg-purple-50"
        },
        {
            title: "Capacitación y Cursos",
            description: "Catálogo de cursos y planes de formación.",
            icon: BookOpen,
            href: "/admin/training",
            color: "text-orange-500",
            bg: "bg-orange-50"
        },
        {
            title: "Reclutamiento (ATS)",
            description: "Gestiona vacantes y candidatos.",
            icon: Briefcase,
            href: "/admin/ats/jobs",
            color: "text-green-500",
            bg: "bg-green-50"
        },
        {
            title: "Configuración",
            description: "Ajustes generales y catálogos del sistema.",
            icon: Settings,
            href: "/admin/config/general",
            color: "text-slate-500",
            bg: "bg-slate-50"
        }
    ];

    const employeeCards = [
        {
            title: "Mi Desempeño",
            description: "Ver mis evaluaciones y objetivos.",
            icon: Gauge,
            href: "/employee/performance",
            color: "text-purple-500",
            bg: "bg-purple-50"
        },
        {
            title: "Mi Equipo",
            description: "Ver miembros de mi departamento.",
            icon: Users,
            href: "/employee/teams",
            color: "text-blue-500",
            bg: "bg-blue-50"
        },
        {
            title: "Capacitación",
            description: "Mis cursos y planes de aprendizaje.",
            icon: BookOpen,
            href: "/training",
            color: "text-orange-500",
            bg: "bg-orange-50"
        }
    ];

    const cards = isAdmin ? adminCards : employeeCards;

    return (
        <div className="p-6">
            <div className="mb-8">
                <h1 className="text-3xl font-bold tracking-tight text-gray-900">Bienvenido al Portal HCM</h1>
                <p className="text-muted-foreground mt-2">
                    Selecciona una opción para comenzar a gestionar tu organización.
                </p>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {cards.map((card) => (
                    <Link
                        key={card.title}
                        href={card.href}
                        className="group relative flex flex-col p-6 bg-white rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-all duration-200 hover:border-brand-primary/50"
                    >
                        <div className={`p-3 w-fit rounded-lg ${card.bg} ${card.color} mb-4 group-hover:scale-110 transition-transform duration-200`}>
                            <card.icon className="w-6 h-6" />
                        </div>
                        <h3 className="text-lg font-semibold text-gray-900 mb-2 group-hover:text-brand-primary transition-colors">
                            {card.title}
                        </h3>
                        <p className="text-sm text-gray-500">
                            {card.description}
                        </p>
                    </Link>
                ))}
            </div>
        </div>
    );
}
</file>

<file path="frontend2/app/login/page.tsx">
import { Card, CardContent } from "@/components/ui/card"
import { LoginForm } from "@/components/login-form"
import { IutirlaLogo } from "@/components/iutirla-logo"

export default function LoginPage() {
  return (
    <div className="grid min-h-svh lg:grid-cols-2">
      <div className="flex flex-col gap-4 p-6 md:p-10 justify-center items-center">
        <Card className="w-full max-w-md">
          <CardContent className="pt-6">
            <div className="flex justify-center gap-2 mb-6">
              <IutirlaLogo />
            </div>
            <div className="flex items-center justify-center">
              <div className="w-full">
                <LoginForm />
              </div>
            </div>
          </CardContent>
        </Card>
      </div>
      <div className="bg-muted relative hidden lg:block">
        <img
          src="/images/iutirla-porlamar.webp"
          alt="Imagen IUTIRLA porlamar"
          className="absolute inset-0 h-full w-full object-cover dark:brightness-[0.2] dark:grayscale"
        />
      </div>
    </div>
  )
}
</file>

<file path="frontend2/components/courses/course-card.tsx">
"use client";

import { useState } from "react";
import Image from "next/image";
import { useRouter } from "next/navigation";
import { Card, CardContent, CardFooter } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Progress } from "@/components/ui/progress";
import { Separator } from "@/components/ui/separator";
import {
    Dialog,
    DialogContent,
    DialogDescription,
    DialogFooter,
    DialogHeader,
    DialogTitle,
    DialogTrigger,
} from "@/components/ui/dialog";
import {
    Calendar,
    Clock,
    Users,
    BookOpen,
    CheckCircle2,
    XCircle,
    AlertCircle,
    Loader2,
    Info,
    FileText,
    ArrowRight,
    Settings
} from "lucide-react";
import { toast } from "sonner";
import apiClient from "@/lib/api-client";
import {
    Course,
    EnrollmentStatus,
    courseModalityDisplay,
    courseStatusDisplay
} from "@/types/course";

interface CourseCardProps {
    course: Course;
    enrollmentStatus?: EnrollmentStatus;
    academicProgress?: number; // 0-100
    href?: string;
    showEnrollButton?: boolean;
    onEnrollmentSuccess?: () => void;
    isInstructor?: boolean;
}

export function CourseCard({
    course,
    enrollmentStatus,
    academicProgress,
    href,
    showEnrollButton = false,
    onEnrollmentSuccess,
    isInstructor = false,
}: CourseCardProps) {
    const router = useRouter();
    const [imageError, setImageError] = useState(false);
    const [isEnrollmentLoading, setIsEnrollmentLoading] = useState(false);
    const [isModalOpen, setIsModalOpen] = useState(false);

    // Backend returns full URLs or null
    const coverImageSrc = !imageError && course.cover_image
        ? course.cover_image
        : "/images/course-placeholder.webp";

    const handleEnroll = async () => {
        setIsEnrollmentLoading(true);
        try {
            await apiClient.post(`/api/training/courses/${course.id}/request_enrollment/`);
            toast.success("Solicitud de inscripción enviada exitosamente");
            setIsModalOpen(false);
            if (onEnrollmentSuccess) {
                onEnrollmentSuccess();
            }
        } catch (error: any) {
            console.error("Error requesting enrollment:", error);
            toast.error(error.response?.data?.error || "Error al solicitar inscripción");
        } finally {
            setIsEnrollmentLoading(false);
        }
    };

    const handleContinue = () => {
        if (href) {
            router.push(href);
        }
    };

    // Determinar el badge de estado de inscripción
    const getEnrollmentBadge = () => {
        if (!enrollmentStatus) return null;

        switch (enrollmentStatus) {
            case EnrollmentStatus.REQUESTED:
                return (
                    <Badge variant="outline" className="border-yellow-500 text-yellow-600 dark:text-yellow-500">
                        <AlertCircle className="mr-1 h-3 w-3" />
                        Solicitud Pendiente
                    </Badge>
                );
            case EnrollmentStatus.ENROLLED:
                return (
                    <Badge variant="outline" className="border-green-500 text-green-600 dark:text-green-500">
                        <CheckCircle2 className="mr-1 h-3 w-3" />
                        Inscrito
                    </Badge>
                );
            case EnrollmentStatus.REJECTED:
                return (
                    <Badge variant="destructive">
                        <XCircle className="mr-1 h-3 w-3" />
                        Rechazado
                    </Badge>
                );

            default:
                return null;
        }
    };

    const isEnrolled = enrollmentStatus === EnrollmentStatus.ENROLLED;

    return (
        <Dialog open={isModalOpen} onOpenChange={setIsModalOpen}>
            <Card className="overflow-hidden hover:shadow-lg transition-shadow duration-300 h-full flex flex-col p-0">
                {/* Cover Image */}
                <div className="relative h-48 w-full overflow-hidden">
                    <Image
                        src={coverImageSrc}
                        alt={course.name}
                        fill
                        className="object-cover"
                        onError={() => setImageError(true)}
                    />

                    <div className="absolute top-2 right-2">
                        <Badge variant="secondary" className="bg-white/90 backdrop-blur-sm shadow-sm">
                            {courseStatusDisplay[course.status]}
                        </Badge>
                    </div>
                </div>

                <CardContent className="flex-1 flex flex-col gap-2 p-4">
                    {/* Badges Row */}
                    <div className="flex flex-wrap gap-2">
                        <Badge variant="outline" className="text-xs">
                            {courseModalityDisplay[course.modality]}
                        </Badge>
                        {getEnrollmentBadge()}
                        {course.is_full && (
                            <Badge variant="destructive" className="text-xs">
                                Cupo Lleno
                            </Badge>
                        )}
                    </div>
                    {/* Course Title */}
                    <h3 className="text-lg font-semibold line-clamp-2">
                        {course.name}
                    </h3>

                    {/* Course Description */}
                    {course.description && (
                        <p className="text-sm text-muted-foreground mb-2 line-clamp-2">
                            {course.description}
                        </p>
                    )}

                    <div className="flex flex-col border-t pt-4 mt-auto">

                        {/* Academic Progress (if enrolled) */}
                        {isEnrolled && academicProgress !== undefined && (
                            <div className="mb-4">
                                <div className="flex justify-between text-xs text-muted-foreground mb-1">
                                    <span>Progreso</span>
                                    <span>{academicProgress}%</span>
                                </div>
                                <Progress value={academicProgress} className="h-2" />
                            </div>
                        )}

                        {/* Course Metadata */}
                        <div className="flex justify-between items-center flex-wrap gap-2">
                            <div className="flex items-center justify-end gap-2 text-sm text-muted-foreground">
                                <Calendar className="h-4 w-4" />
                                <span>
                                    {new Date(course.start_date).toLocaleDateString('es-ES', {
                                        day: '2-digit',
                                        month: 'short',
                                        year: 'numeric'
                                    })}
                                </span>
                            </div>

                            <div className="flex items-center gap-4 text-sm text-muted-foreground">
                                <div className="flex items-center gap-2">
                                    <Clock className="h-4 w-4" />
                                    <span>{course.duration_hours}h</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <Users className="h-4 w-4" />
                                    <span>{course.enrolled_count}/{course.max_participants}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </CardContent>

                <CardFooter className="p-4 pt-0">
                    {isInstructor ? (
                        <Button onClick={handleContinue} className="w-full" variant="default">
                            <Settings className="mr-2 h-4 w-4" />
                            Gestionar
                        </Button>
                    ) : isEnrolled ? (
                        <Button onClick={handleContinue} className="w-full">
                            <BookOpen className="mr-2 h-4 w-4" />
                            Continuar
                        </Button>
                    ) : (
                        <DialogTrigger asChild>
                            <Button variant="outline" className="w-full">
                                <Info className="mr-2 h-4 w-4" />
                                Ver Detalles
                            </Button>
                        </DialogTrigger>
                    )}
                </CardFooter>
            </Card>

            <DialogContent className="sm:max-w-[600px] p-0 overflow-hidden gap-0 border-0">
                <DialogHeader className="sr-only">
                    <DialogTitle>Inscripción: {course.name}</DialogTitle>
                    <DialogDescription>Detalles y solicitud de ingreso.</DialogDescription>
                </DialogHeader>

                {/* HEADER CON IMAGEN */}
                <div className="relative h-48 w-full bg-muted">
                    <Image
                        src={coverImageSrc}
                        alt={course.name}
                        fill
                        className="object-cover"
                        onError={() => setImageError(true)}
                    />

                    {/* Gradiente para legibilidad */}
                    <div className="absolute inset-0 bg-linear-to-t from-black/90 via-black/40 to-transparent" />

                    <div className="absolute bottom-0 left-0 w-full p-6 flex flex-col justify-end">
                        <Badge className="w-fit mb-2 bg-white/20 hover:bg-white/30 text-white border-none backdrop-blur-md shadow-sm">
                            {course.modality_display}
                        </Badge>
                        <h2 className="text-2xl font-bold text-white leading-tight shadow-sm">
                            {course.name}
                        </h2>
                    </div>
                </div>

                <div className="p-6 space-y-6">
                    {/* Detalles Clave */}
                    <div className="grid grid-cols-2 gap-4 text-sm">
                        <div className="flex items-center gap-2 text-muted-foreground">
                            <Calendar className="h-4 w-4 text-primary" />
                            <span>
                                {new Date(course.start_date).toLocaleDateString()} - {new Date(course.end_date).toLocaleDateString()}
                            </span>
                        </div>
                        <div className="flex items-center gap-2 text-muted-foreground">
                            <Clock className="h-4 w-4 text-primary" />
                            <span>{course.duration_hours} Horas académicas</span>
                        </div>
                        <div className="flex items-center gap-2 text-muted-foreground">
                            <Users className="h-4 w-4 text-primary" />
                            <span>Cupo: {course.max_participants}</span>
                        </div>
                    </div>

                    <Separator />

                    {/* Descripción */}
                    <div className="space-y-2">
                        <h3 className="font-semibold flex items-center gap-2 text-sm uppercase tracking-wide text-muted-foreground">
                            <FileText className="h-4 w-4" /> Descripción
                        </h3>
                        <p className="text-sm text-foreground leading-relaxed whitespace-pre-line">
                            {course.description || "Sin descripción detallada."}
                        </p>
                    </div>

                    {/* Nota Informativa */}
                    <div className="bg-blue-50 text-blue-800 p-3 rounded-md text-xs flex gap-2 items-start border border-blue-100">
                        <Info className="h-4 w-4 shrink-0 mt-0.5" />
                        <p>
                            Al solicitar la inscripción, tu perfil será revisado por la coordinación académica.
                            Recibirás acceso al aula virtual una vez sea aprobado.
                        </p>
                    </div>
                </div>

                <DialogFooter className="p-6 pt-2 bg-slate-50/50 border-t">
                    <Button variant="outline" onClick={() => setIsModalOpen(false)}>Cancelar</Button>
                    {enrollmentStatus === EnrollmentStatus.REQUESTED ? (
                        <Button disabled className="gap-2" variant="secondary">
                            <AlertCircle className="h-4 w-4" />
                            Solicitud Enviada
                        </Button>
                    ) : showEnrollButton ? (
                        <Button
                            onClick={handleEnroll}
                            disabled={course.is_full || isEnrollmentLoading}
                            className="gap-2"
                        >
                            {isEnrollmentLoading ? (
                                <Loader2 className="h-4 w-4 animate-spin" />
                            ) : (
                                <CheckCircle2 className="h-4 w-4" />
                            )}
                            {course.is_full ? "Cupo Lleno" : "Solicitar Inscripción"}
                        </Button>
                    ) : null}
                </DialogFooter>
            </DialogContent>
        </Dialog>
    );
}
</file>

<file path="frontend2/components/courses/course-header.tsx">
"use client";

import { useState } from "react";
import Image from "next/image";
import { Badge } from "@/components/ui/badge";
import {
    Clock,
    Users,
    Calendar,
    UserCheck
} from "lucide-react";
import {
    Course,
    courseModalityDisplay
} from "@/types/course";

interface CourseHeaderProps {
    course: Course;
}

export function CourseHeader({ course }: CourseHeaderProps) {
    const [imageError, setImageError] = useState(false);

    // Determinar la imagen de portada con fallback
    const coverImageSrc = !imageError && course.cover_image
        ? course.cover_image
        : "/images/course-placeholder.webp";

    return (
        <div className="relative w-full">
            {/* Cover Image Section */}
            <div className="relative h-64 md:h-80 w-full overflow-hidden rounded-t-lg">
                <Image
                    src={coverImageSrc}
                    alt={course.name}
                    fill
                    className="object-cover"
                    onError={() => setImageError(true)}
                    priority
                />
                {/* Gradient Overlay */}
                <div className="absolute inset-0 bg-gradient-to-t from-black/70 via-black/30 to-transparent" />

                {/* Course Title Overlay */}
                <div className="absolute bottom-0 left-0 right-0 p-6 text-white">
                    <h1 className="text-3xl md:text-4xl font-bold mb-2 drop-shadow-lg">
                        {course.name}
                    </h1>
                    <div className="flex flex-wrap gap-2 items-center">
                        <Badge variant="secondary" className="bg-white/20 backdrop-blur-sm text-white border-white/30">
                            {courseModalityDisplay[course.modality]}
                        </Badge>
                        {course.is_full && (
                            <Badge variant="destructive" className="bg-red-500/80 backdrop-blur-sm">
                                Cupo Lleno
                            </Badge>
                        )}
                    </div>
                </div>
            </div>

            {/* Info Section */}
            <div className="bg-card border-x border-b rounded-b-lg p-6">
                <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    {/* Course Metadata */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 flex-1">
                        <div className="flex items-center gap-2">
                            <Calendar className="h-5 w-5 text-muted-foreground" />
                            <div>
                                <p className="text-xs text-muted-foreground">Inicio</p>
                                <p className="text-sm font-medium">
                                    {new Date(course.start_date).toLocaleDateString('es-ES', {
                                        day: '2-digit',
                                        month: 'short',
                                        year: 'numeric'
                                    })}
                                </p>
                            </div>
                        </div>

                        <div className="flex items-center gap-2">
                            <Calendar className="h-5 w-5 text-muted-foreground" />
                            <div>
                                <p className="text-xs text-muted-foreground">Fin</p>
                                <p className="text-sm font-medium">
                                    {new Date(course.end_date).toLocaleDateString('es-ES', {
                                        day: '2-digit',
                                        month: 'short',
                                        year: 'numeric'
                                    })}
                                </p>
                            </div>
                        </div>

                        <div className="flex items-center gap-2">
                            <Clock className="h-5 w-5 text-muted-foreground" />
                            <div>
                                <p className="text-xs text-muted-foreground">Duración</p>
                                <p className="text-sm font-medium">{course.duration_hours}h</p>
                            </div>
                        </div>

                        <div className="flex items-center gap-2">
                            <Users className="h-5 w-5 text-muted-foreground" />
                            <div>
                                <p className="text-xs text-muted-foreground">Cupo</p>
                                <p className="text-sm font-medium">
                                    {course.enrolled_count}/{course.max_participants}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                {/* Instructor Section */}
                {course.instructor_name && (
                    <div className="mt-6 pt-6 border-t">
                        <div className="flex items-center gap-2 mb-3">
                            <UserCheck className="h-5 w-5 text-primary" />
                            <h3 className="font-semibold">Instructor</h3>
                        </div>
                        <Badge variant="secondary" className="text-sm">
                            {course.instructor_name}
                        </Badge>
                    </div>
                )}
            </div>
        </div>
    );
}
</file>

<file path="frontend2/components/courses/course-personnel.tsx">
"use client";

import { useState } from "react";
import useSWR, { mutate } from "swr";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Separator } from "@/components/ui/separator";
import { UserPlus, Trash2, Loader2, Plus, AlertCircle, GraduationCap } from "lucide-react";
import { toast } from "sonner";
import apiClient from "@/lib/api-client";
import { Course, ParticipantListItem, enrollmentStatusDisplay, academicStatusDisplay } from "@/types/course";
import { Combobox } from "@/components/ui/combobox";
import {
    Dialog,
    DialogContent,
    DialogDescription,
    DialogHeader,
    DialogTitle,
    DialogTrigger,
} from "@/components/ui/dialog";
import {
    AlertDialog,
    AlertDialogAction,
    AlertDialogCancel,
    AlertDialogContent,
    AlertDialogDescription,
    AlertDialogFooter,
    AlertDialogHeader,
    AlertDialogTitle,
} from "@/components/ui/alert-dialog";
import {
    DropdownMenu,
    DropdownMenuContent,
    DropdownMenuItem,
    DropdownMenuLabel,
    DropdownMenuSeparator,
    DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { MoreHorizontal, Pencil } from "lucide-react";
import { CatalogCRUD, CatalogField } from "@/components/catalogs/catalog-crud";
import { ColumnDef } from "@tanstack/react-table";
import { Alert, AlertDescription, AlertTitle } from "@/components/ui/alert";
import { DataTable } from "@/components/catalogs/data-table";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";

const fetcher = (url: string) => apiClient.get(url).then((res) => res.data.results || res.data);

interface CoursePersonnelProps {
    courseId: string;
}

export default function CoursePersonnel({ courseId }: CoursePersonnelProps) {
    const [isProcessing, setIsProcessing] = useState(false);

    // Dialog States
    const [isInstructorDialogOpen, setIsInstructorDialogOpen] = useState(false);
    const [isStudentDialogOpen, setIsStudentDialogOpen] = useState(false);
    const [isConfirmDialogOpen, setIsConfirmDialogOpen] = useState(false);
    const [isRemoveInstructorDialogOpen, setIsRemoveInstructorDialogOpen] = useState(false);
    const [isGradeDialogOpen, setIsGradeDialogOpen] = useState(false);
    const [selectedParticipant, setSelectedParticipant] = useState<ParticipantListItem | null>(null);
    const [gradeValue, setGradeValue] = useState<string>("");

    // Refresh key for students list (CatalogCRUD)
    const [studentsRefreshKey, setStudentsRefreshKey] = useState(0);

    // Selection States
    const [selectedPersonId, setSelectedPersonId] = useState<string>("");
    const [isForInstructor, setIsForInstructor] = useState(false);
    const [modalError, setModalError] = useState<string | null>(null);

    // 🔧 REFACTOR: Fetch course to get instructor
    const { data: course, mutate: mutateCourse } = useSWR<Course>(
        `/api/training/courses/${courseId}/`,
        fetcher
    );

    // Fetch list of all persons for selection
    const { data: persons } = useSWR<any[]>(
        `/api/core/persons/?page_size=1000`,
        fetcher
    );

    // 🔧 REFACTOR: Fetch only students (no more role parameter)
    // Note: We use this just for validation checks, CatalogCRUD fetches its own data
    const { data: students, mutate: mutateStudents } = useSWR<ParticipantListItem[]>(
        `/api/training/participants/?course=${courseId}&enrollment_status=ENR`,
        fetcher
    );

    const instructor = course?.instructor_id ? {
        id: course.instructor_id,
        name: course.instructor_name,
        person_id_document: course.instructor_id_document
    } : null;

    const instructorData = instructor ? [instructor] : [];

    // Prepare person options for combobox
    const personOptions = persons?.map(p => ({
        value: p.id.toString(),
        label: p.hiring_search || p.full_name
    })) || [];

    const getSelectedPersonDetails = (id: string) => {
        return persons?.find(p => p.id.toString() === id);
    };

    const selectedPerson = getSelectedPersonDetails(selectedPersonId);

    // Reset states when dialogs close
    const handleCloseDialogs = () => {
        setIsInstructorDialogOpen(false);
        setIsStudentDialogOpen(false);
        setIsConfirmDialogOpen(false);
        setIsRemoveInstructorDialogOpen(false);
        setIsGradeDialogOpen(false);
        setSelectedPersonId("");
        setIsForInstructor(false);
        setSelectedParticipant(null);
        setGradeValue("");
        setModalError(null);
    };

    const initiateAddInstructor = () => {
        setModalError(null);
        const personId = selectedPersonId;

        if (!personId) {
            setModalError("Por favor, selecciona una persona.");
            return;
        }

        // Check if person is already a student
        if (students?.some(s => s.person_id === parseInt(personId))) {
            setModalError("Esta persona ya está inscrita como estudiante.");
            return;
        }

        setIsForInstructor(true);
        setIsConfirmDialogOpen(true);
    };

    const initiateAddStudent = () => {
        setModalError(null);
        const personId = selectedPersonId;

        if (!personId) {
            setModalError("Por favor, selecciona una persona.");
            return;
        }

        // Check if person is the instructor
        if (instructor && instructor.id === parseInt(personId)) {
            setModalError("Esta persona ya es instructor del curso.");
            return;
        }

        // Check if person is already a student
        if (students?.some(s => s.person_id === parseInt(personId))) {
            setModalError("Esta persona ya está inscrita en el curso.");
            return;
        }

        setIsForInstructor(false);
        setIsConfirmDialogOpen(true);
    };

    // 🔧 REFACTOR: Add/change instructor with PATCH to course
    const handleAddInstructor = async () => {
        if (!selectedPersonId) return;

        setIsProcessing(true);
        try {
            await apiClient.patch(`/api/training/courses/${courseId}/`, {
                instructor: parseInt(selectedPersonId)
            });

            toast.success(instructor ? "Instructor cambiado exitosamente" : "Instructor asignado exitosamente");
            await mutateCourse(); // Refresh course data
            handleCloseDialogs();
        } catch (error: any) {
            // ... (error handling same)
            let errorMsg = "Error al asignar instructor";
            if (error.response?.data) {
                const data = error.response.data;
                if (data.instructor) {
                    errorMsg = Array.isArray(data.instructor) ? data.instructor[0] : data.instructor;
                } else if (data.error) {
                    errorMsg = data.error;
                } else if (data.detail) {
                    errorMsg = data.detail;
                }
            }
            setModalError(errorMsg);
            setIsConfirmDialogOpen(false);
        } finally {
            setIsProcessing(false);
        }
    };

    // Add student as participant
    const handleAddStudent = async () => {
        if (!selectedPersonId) return;

        setIsProcessing(true);
        try {
            await apiClient.post(`/api/training/participants/`, {
                course: parseInt(courseId),
                person: parseInt(selectedPersonId),
                enrollment_status: 'ENR'
            });

            toast.success("Estudiante agregado exitosamente");
            // Trigger refresh of CatalogCRUD and local SWR cache
            setStudentsRefreshKey(prev => prev + 1);
            await mutateStudents();
            handleCloseDialogs();
        } catch (error: any) {
            // ... (error handling same)
            let errorMsg = "Error al agregar estudiante";
            if (error.response?.data) {
                const data = error.response.data;
                if (data.person) {
                    errorMsg = Array.isArray(data.person) ? data.person[0] : data.person;
                } else if (data.course) {
                    errorMsg = Array.isArray(data.course) ? data.course[0] : data.course;
                } else if (data.error) {
                    errorMsg = data.error;
                } else if (data.detail) {
                    errorMsg = data.detail;
                } else if (data.non_field_errors) {
                    errorMsg = Array.isArray(data.non_field_errors) ? data.non_field_errors[0] : data.non_field_errors;
                }
            }
            setModalError(errorMsg);
            setIsConfirmDialogOpen(false);
        } finally {
            setIsProcessing(false);
        }
    };

    // 🔧 REFACTOR: Remove instructor with PATCH to course
    const handleRemoveInstructor = async () => {
        setIsProcessing(true);
        try {
            await apiClient.patch(`/api/training/courses/${courseId}/`, {
                instructor: null
            });

            toast.success("Instructor removido");
            await mutateCourse(); // Refresh course data
            setIsRemoveInstructorDialogOpen(false);
        } catch (error: any) {
            // console.error("Error removing instructor:", error);
            toast.error("Error al remover instructor");
        } finally {
            setIsProcessing(false);
        }
    };

    // Remove student participant
    const handleRemoveStudent = async (participantId: number) => {
        setIsProcessing(true);
        try {
            await apiClient.delete(`/api/training/participants/${participantId}/`);
            toast.success("Estudiante removido del curso");
            // Trigger refresh of CatalogCRUD and local SWR cache
            setStudentsRefreshKey(prev => prev + 1);
            await mutateStudents();
        } catch (error: any) {
            // console.error("Error removing student:", error);
            toast.error(error.response?.data?.error || "Error al remover");
        } finally {
            setIsProcessing(false);
        }
    };

    const renderPersonPreview = (person: any) => {
        if (!person) return null;
        return (
            <Card className="mt-4 border-dashed">
                <CardContent className="p-4 flex flex-col lg:flex-row items-center justify-between gap-4">
                    <div>
                        <p className="font-medium">{person.full_name}</p>
                        <p className="text-sm text-muted-foreground">{person.hiring_search}</p>
                        {person.primary_email && <p className="text-xs text-muted-foreground">{person.primary_email}</p>}
                    </div>
                    <Button
                        onClick={() => isForInstructor ? initiateAddInstructor() : initiateAddStudent()}
                        className="w-full lg:w-auto"
                        disabled={isProcessing}
                    >
                        {isProcessing ? (
                            <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                        ) : (
                            <UserPlus className="h-4 w-4 mr-2" />
                        )}
                        Agregar
                    </Button>
                </CardContent>
            </Card>
        );
    };

    // --- Columns Configuration ---

    // Instructor Columns
    const instructorColumns: ColumnDef<any>[] = [
        { accessorKey: "name", header: "Nombre" },
        { accessorKey: "person_id_document", header: "Cédula", cell: ({ row }) => row.original.person_id_document || "S/C" },
        {
            id: "actions",
            cell: ({ row }) => (
                <div className="flex justify-end">
                    <DropdownMenu>
                        <DropdownMenuTrigger asChild>
                            <Button variant="ghost" className="h-8 w-8 p-0">
                                <span className="sr-only">Abrir menú</span>
                                <MoreHorizontal className="h-4 w-4" />
                            </Button>
                        </DropdownMenuTrigger>
                        <DropdownMenuContent align="end">
                            <DropdownMenuLabel>Acciones</DropdownMenuLabel>
                            <DropdownMenuItem
                                onClick={() => { setSelectedPersonId(""); setModalError(null); setIsForInstructor(true); setIsInstructorDialogOpen(true); }}
                            >
                                <Pencil className="mr-2 h-4 w-4" />
                                Cambiar Instructor
                            </DropdownMenuItem>
                            <DropdownMenuSeparator />
                            <DropdownMenuItem
                                className="text-destructive focus:text-destructive"
                                onClick={() => setIsRemoveInstructorDialogOpen(true)}
                                disabled={isProcessing}
                            >
                                <Trash2 className="mr-2 h-4 w-4" />
                                Remover Instructor
                            </DropdownMenuItem>
                        </DropdownMenuContent>
                    </DropdownMenu>
                </div>
            )
        }
    ];

    // Handle grade assignment
    const handleAssignGrade = async () => {
        if (!selectedParticipant) return;
        const grade = parseFloat(gradeValue);

        if (isNaN(grade) || grade < 0 || grade > 20) {
            setModalError("La nota debe ser un número entre 0 y 20");
            return;
        }

        setIsProcessing(true);
        try {
            await apiClient.post(`/api/training/participants/${selectedParticipant.id}/assign_grade/`, {
                final_grade: grade
            });

            toast.success("Nota asignada exitosamente");
            setStudentsRefreshKey(prev => prev + 1);
            await mutateStudents();
            handleCloseDialogs();
        } catch (error: any) {
            let errorMsg = "Error al asignar nota";
            if (error.response?.data?.error) {
                errorMsg = error.response.data.error;
            }
            setModalError(errorMsg);
        } finally {
            setIsProcessing(false);
        }
    };

    // Student Columns
    const studentFields: CatalogField[] = [];
    const studentColumns: ColumnDef<any>[] = [
        { accessorKey: "person_name", header: "Nombre", cell: ({ row }) => row.getValue("person_name") },
        { accessorKey: "person_id_document", header: "Cédula", cell: ({ row }) => row.original.person_id_document || "S/C" },
        {
            accessorKey: "academic_status",
            header: "Estado Académico",
            cell: ({ row }) => (
                <Badge variant="outline">
                    {academicStatusDisplay[row.original.academic_status as keyof typeof academicStatusDisplay] || row.original.academic_status}
                </Badge>
            )
        },
        {
            accessorKey: "grade",
            header: "Nota",
            cell: ({ row }) => row.original.grade ? <Badge variant="secondary">Nota: {row.original.grade}/20</Badge> : "-"
        },
    ];

    return (
        <div className="space-y-8">
            {/* Instructor Section */}
            <div className="space-y-4">
                <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                    <h2 className="text-xl font-bold tracking-tight">Instructor</h2>
                    {!instructor && (
                        <Dialog open={isInstructorDialogOpen} onOpenChange={setIsInstructorDialogOpen}>
                            <DialogTrigger asChild>
                                <Button onClick={() => { setSelectedPersonId(""); setModalError(null); setIsForInstructor(true); }}>
                                    <Plus className="mr-2 h-4 w-4" />
                                    Asignar Instructor
                                </Button>
                            </DialogTrigger>
                            <DialogContent className="sm:max-w-[500px]">
                                <DialogHeader>
                                    <DialogTitle>Asignar Instructor</DialogTitle>
                                    <DialogDescription>
                                        Busca y selecciona una persona para asignarla como instructor.
                                    </DialogDescription>
                                </DialogHeader>

                                {modalError && (
                                    <Alert variant="destructive">
                                        <AlertCircle className="h-4 w-4" />
                                        <AlertTitle>Error</AlertTitle>
                                        <AlertDescription>{modalError}</AlertDescription>
                                    </Alert>
                                )}

                                <div className="py-4">
                                    <Combobox
                                        options={personOptions}
                                        value={selectedPersonId}
                                        onSelect={(val) => { setSelectedPersonId(val.toString()); setModalError(null); }}
                                        placeholder="Buscar por cédula..."
                                        emptyText="No se encontraron personas"
                                    />
                                    {renderPersonPreview(selectedPerson)}
                                </div>
                            </DialogContent>
                        </Dialog>
                    )}
                </div>

                <DataTable
                    columns={instructorColumns}
                    data={instructorData}
                    disablePagination={true}
                />
            </div>

            <Separator />

            {/* Students Section */}
            <div className="space-y-4">
                <CatalogCRUD
                    title="Estudiantes Inscritos"
                    apiUrl={`/api/training/participants/?course=${courseId}&enrollment_status=ENR`}
                    fields={studentFields}
                    columns={studentColumns}
                    disableCreate={true}
                    disableEdit={true}
                    disableDelete={true}
                    disablePagination={true}
                    refreshKey={studentsRefreshKey} // Pass refresh key
                    extraActions={(item) => (
                        <>
                            <Button
                                variant="ghost"
                                className="w-full justify-start"
                                onClick={() => {
                                    setSelectedParticipant(item);
                                    setGradeValue(item.grade?.toString() || "");
                                    setModalError(null);
                                    setIsGradeDialogOpen(true);
                                }}
                                disabled={isProcessing}
                            >
                                <GraduationCap className="mr-2 h-4 w-4" />
                                {item.grade ? "Editar Nota" : "Asignar Nota"}
                            </Button>
                            <Button
                                variant="ghost"
                                className="w-full justify-start text-destructive hover:text-destructive hover:bg-destructive/10"
                                onClick={() => handleRemoveStudent(item.id)}
                                disabled={isProcessing}
                            >
                                {isProcessing ? (
                                    <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                                ) : (
                                    <Trash2 className="mr-2 h-4 w-4" />
                                )}
                                Remover
                            </Button>
                        </>
                    )}
                    customToolbarActions={
                        <Dialog open={isStudentDialogOpen} onOpenChange={setIsStudentDialogOpen}>
                            <DialogTrigger asChild>
                                <Button onClick={() => { setSelectedPersonId(""); setModalError(null); setIsForInstructor(false); }}>
                                    <Plus className="mr-2 h-4 w-4" />
                                    Agregar Estudiante
                                </Button>
                            </DialogTrigger>
                            <DialogContent className="sm:max-w-[500px]">
                                <DialogHeader>
                                    <DialogTitle>Agregar Estudiante</DialogTitle>
                                    <DialogDescription>
                                        Busca y selecciona una persona para inscribirla como estudiante.
                                    </DialogDescription>
                                </DialogHeader>

                                {modalError && (
                                    <Alert variant="destructive">
                                        <AlertCircle className="h-4 w-4" />
                                        <AlertTitle>Error</AlertTitle>
                                        <AlertDescription>{modalError}</AlertDescription>
                                    </Alert>
                                )}

                                <div className="py-4">
                                    <Combobox
                                        options={personOptions}
                                        value={selectedPersonId}
                                        onSelect={(val) => { setSelectedPersonId(val.toString()); setModalError(null); }}
                                        placeholder="Buscar estudiante por cédula..."
                                        emptyText="No se encontraron personas"
                                    />
                                    {renderPersonPreview(selectedPerson)}
                                </div>
                            </DialogContent>
                        </Dialog>
                    }
                />
            </div>

            {/* Confirmation Dialog */}
            <AlertDialog open={isConfirmDialogOpen} onOpenChange={setIsConfirmDialogOpen}>
                <AlertDialogContent>
                    <AlertDialogHeader>
                        <AlertDialogTitle>¿Confirmar acción?</AlertDialogTitle>
                        <AlertDialogDescription>
                            Estás a punto de {isForInstructor ?
                                (instructor ? "cambiar el instructor" : "asignar a") :
                                "inscribir a"} {' '}
                            <strong>{selectedPerson?.full_name}</strong>
                            {isForInstructor ? " como instructor" : " como estudiante"} en este curso.
                        </AlertDialogDescription>
                    </AlertDialogHeader>
                    <AlertDialogFooter>
                        <AlertDialogCancel onClick={() => setIsConfirmDialogOpen(false)} disabled={isProcessing}>
                            Cancelar
                        </AlertDialogCancel>
                        <AlertDialogAction
                            onClick={isForInstructor ? handleAddInstructor : handleAddStudent}
                            disabled={isProcessing}
                        >
                            {isProcessing ? <Loader2 className="h-4 w-4 animate-spin mr-2" /> : null}
                            Confirmar
                        </AlertDialogAction>
                    </AlertDialogFooter>
                </AlertDialogContent>
            </AlertDialog>

            {/* Remove Instructor Dialog */}
            <AlertDialog open={isRemoveInstructorDialogOpen} onOpenChange={setIsRemoveInstructorDialogOpen}>
                <AlertDialogContent>
                    <AlertDialogHeader>
                        <AlertDialogTitle>¿Remover instructor?</AlertDialogTitle>
                        <AlertDialogDescription>
                            Estás a punto de remover a <strong>{instructor?.name}</strong> como instructor de este curso.
                            Esta acción puede revertirse asignando un nuevo instructor.
                        </AlertDialogDescription>
                    </AlertDialogHeader>
                    <AlertDialogFooter>
                        <AlertDialogCancel disabled={isProcessing}>Cancelar</AlertDialogCancel>
                        <AlertDialogAction onClick={handleRemoveInstructor} disabled={isProcessing}>
                            {isProcessing ? <Loader2 className="h-4 w-4 animate-spin mr-2" /> : null}
                            Remover
                        </AlertDialogAction>
                    </AlertDialogFooter>
                </AlertDialogContent>
            </AlertDialog>

            {/* Grade Assignment Dialog */}
            <Dialog open={isGradeDialogOpen} onOpenChange={setIsGradeDialogOpen}>
                <DialogContent className="sm:max-w-[425px]">
                    <DialogHeader>
                        <DialogTitle>Asignar Nota Final</DialogTitle>
                        <DialogDescription>
                            Asigna la nota final para {selectedParticipant?.person_name}
                        </DialogDescription>
                    </DialogHeader>

                    {modalError && (
                        <Alert variant="destructive">
                            <AlertCircle className="h-4 w-4" />
                            <AlertTitle>Error</AlertTitle>
                            <AlertDescription>{modalError}</AlertDescription>
                        </Alert>
                    )}

                    <div className="grid gap-4 py-4">
                        <div className="grid gap-2">
                            <Label htmlFor="grade">Nota (0-20)</Label>
                            <Input
                                id="grade"
                                type="number"
                                min="0"
                                max="20"
                                step="0.01"
                                value={gradeValue}
                                onChange={(e) => { setGradeValue(e.target.value); setModalError(null); }}
                                placeholder="Ingrese la nota"
                            />
                        </div>
                        {selectedParticipant?.grade && (
                            <p className="text-sm text-muted-foreground">
                                Nota actual: <strong>{selectedParticipant.grade}/20</strong>
                            </p>
                        )}
                    </div>

                    <div className="flex justify-end gap-2">
                        <Button variant="outline" onClick={() => setIsGradeDialogOpen(false)} disabled={isProcessing}>
                            Cancelar
                        </Button>
                        <Button onClick={handleAssignGrade} disabled={isProcessing}>
                            {isProcessing && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                            Asignar Nota
                        </Button>
                    </div>
                </DialogContent>
            </Dialog>
        </div>
    );
}
</file>

<file path="frontend2/components/courses/course-requests.tsx">
"use client";

import { useState } from "react";
import useSWR, { mutate } from "swr";
import { Button } from "@/components/ui/button";
import { Check, X, Loader2 } from "lucide-react";
import { toast } from "sonner";
import apiClient from "@/lib/api-client";
import { CatalogCRUD, CatalogField } from "@/components/catalogs/catalog-crud";
import { ColumnDef } from "@tanstack/react-table";

const fetcher = (url: string) => apiClient.get(url).then((res) => res.data.results || res.data);

interface CourseRequestsProps {
    courseId: string;
}

export default function CourseRequests({ courseId }: CourseRequestsProps) {
    const [isProcessing, setIsProcessing] = useState<number | null>(null);

    // Approve enrollment request
    const handleApprove = async (participantId: number) => {
        setIsProcessing(participantId);
        try {
            await apiClient.post(`/api/training/courses/${courseId}/approve_enrollment/`, {
                participant_id: participantId
            });
            toast.success("Solicitud aprobada exitosamente");
            mutate(`/api/training/participants/?course=${courseId}&enrollment_status=REQ`);
            // Also refresh students list
            mutate(`/api/training/participants/?course=${courseId}&enrollment_status=ENR`);
        } catch (error: any) {
            console.error("Error approving enrollment:", error);
            toast.error(error.response?.data?.error || "Error al aprobar la solicitud");
        } finally {
            setIsProcessing(null);
        }
    };

    // Reject enrollment request
    const handleReject = async (participantId: number) => {
        setIsProcessing(participantId);
        try {
            await apiClient.post(`/api/training/courses/${courseId}/reject_enrollment/`, {
                participant_id: participantId
            });
            toast.success("Solicitud rechazada");
            mutate(`/api/training/participants/?course=${courseId}&enrollment_status=REQ`);
        } catch (error: any) {
            console.error("Error rejecting enrollment:", error);
            toast.error(error.response?.data?.error || "Error al rechazar la solicitud");
        } finally {
            setIsProcessing(null);
        }
    };

    // Pending Requests Configuration
    const pendingFields: CatalogField[] = [];
    const pendingColumns: ColumnDef<any>[] = [
        { accessorKey: "person_name", header: "Nombre", cell: ({ row }) => row.getValue("person_name") },
        { accessorKey: "person_id_document", header: "Cédula", cell: ({ row }) => row.original.person_id_document || "S/C" },
        {
            accessorKey: "created_at",
            header: "Fecha Solicitud",
            cell: ({ row }) => {
                const date = row.original.created_at ? new Date(row.original.created_at) : null;
                return date ? date.toLocaleDateString('es-ES') : "-";
            }
        },
    ];

    return (
        <div className="space-y-4">
            <CatalogCRUD
                title="Solicitudes de Inscripción"
                apiUrl={`/api/training/participants/?course=${courseId}&enrollment_status=REQ`}
                fields={pendingFields}
                columns={pendingColumns}
                disableCreate={true}
                disableEdit={true}
                disableDelete={true}
                disablePagination={true} // Show all requests
                extraActions={(item) => (
                    <div className="flex gap-2 justify-end">
                        <Button
                            size="sm"
                            variant="ghost"
                            className="text-green-600 hover:text-green-700 hover:bg-green-50"
                            onClick={() => handleApprove(item.id)}
                            disabled={isProcessing === item.id}
                        >
                            {isProcessing === item.id ? (
                                <Loader2 className="h-4 w-4 animate-spin" />
                            ) : (
                                <Check className="h-4 w-4" />
                            )}
                            <span className="sr-only">Aprobar</span>
                        </Button>
                        <Button
                            size="sm"
                            variant="ghost"
                            className="text-destructive hover:text-destructive hover:bg-destructive/10"
                            onClick={() => handleReject(item.id)}
                            disabled={isProcessing === item.id}
                        >
                            {isProcessing === item.id ? (
                                <Loader2 className="h-4 w-4 animate-spin" />
                            ) : (
                                <X className="h-4 w-4" />
                            )}
                            <span className="sr-only">Rechazar</span>
                        </Button>
                    </div>
                )}
            />

        </div>
    );
}
</file>

<file path="frontend2/components/layout/dashboard-layout.tsx">
"use client";

import { useState } from "react";
import { Header } from "./header";
import { Sidebar } from "./sidebar";
import { cn } from "@/lib/utils";
import { useAuth } from "@/context/auth-context";
import { DynamicBreadcrumbs } from "./dynamic-breadcrumbs";

interface DashboardLayoutProps {
    children: React.ReactNode;
}

export function DashboardLayout({ children }: DashboardLayoutProps) {
    const [sidebarCollapsed, setSidebarCollapsed] = useState(true);
    const { user } = useAuth();

    const role = user?.is_staff ? "admin" : "employee";

    const toggleSidebar = () => {
        setSidebarCollapsed(!sidebarCollapsed);
    };

    return (
        <div className="min-h-screen bg-background">
            {/* Sidebar */}
            <div className="hidden md:block">
                <Sidebar collapsed={sidebarCollapsed} role={role} />
            </div>

            {/* Header */}
            <Header onToggleSidebar={toggleSidebar} collapsed={sidebarCollapsed} />

            {/* Main Content */}
            <main
                className={cn(
                    "pt-14 transition-all duration-300 ml-0",
                    sidebarCollapsed ? "md:ml-16" : "md:ml-64"
                )}
            >
                <div className="p-6">
                    <DynamicBreadcrumbs />
                    {children}
                </div>
            </main>
        </div>
    );
}
</file>

<file path="frontend2/components/layout/dynamic-breadcrumbs.tsx">
"use client";

import { usePathname } from "next/navigation";
import Link from "next/link";
import {
    Breadcrumb,
    BreadcrumbItem,
    BreadcrumbLink,
    BreadcrumbList,
    BreadcrumbPage,
    BreadcrumbSeparator,
} from "@/components/ui/breadcrumb";
import { Fragment } from "react";

const routeNameMap: Record<string, string> = {
    admin: "Administración",
    dashboard: "Dashboard",
    personnel: "Personal",
    employees: "Empleados",
    people: "Personas",
    organization: "Organización",
    departments: "Departamentos",
    "job-titles": "Títulos de Cargo",
    positions: "Posiciones",
    training: "Capacitación",
    courses: "Cursos",
    ats: "Reclutamiento",
    jobs: "Vacantes",
    candidates: "Candidatos",
    performance: "Evaluación",
    periods: "Periodos",
    config: "Configuración",
    general: "General",
    employment: "Empleo",
    talent: "Talento",
    employee: "Empleado",
    "personal-data": "Datos Personales",
    "job-data": "Datos del Puesto",
    compensation: "Compensación",
    "time-management": "Gestión del Tiempo",
    benefits: "Beneficios",
    "performance-goals": "Rendimiento y Metas",
    succession: "Sucesión",
    "learning-development": "Aprendizaje y Desarrollo",
    "talent-profile": "Perfil de Talento",
    // Catalogs
    countries: "Países",
    genders: "Géneros",
    "marital-statuses": "Estados Civiles",
    "address-types": "Tipos de Dirección",
    "phone-types": "Tipos de Teléfono",
    "phone-carriers": "Operadoras Telefónicas",
    "email-types": "Tipos de Email",
    banks: "Bancos",
    "bank-account-types": "Tipos de Cuenta Bancaria",
    "relationship-types": "Tipos de Relación",
    states: "Estados",
    "phone-carrier-codes": "Códigos de Operadora",
};

import { useBreadcrumb } from "@/context/breadcrumb-context";

export function DynamicBreadcrumbs() {
    const pathname = usePathname();
    const segments = pathname.split("/").filter((segment) => segment !== "");
    const { labels } = useBreadcrumb();

    // If we are at root, don't show breadcrumbs or show Home?
    // Usually dashboard is /admin/dashboard.

    return (
        <Breadcrumb className="mb-4">
            <BreadcrumbList>
                <BreadcrumbItem>
                    <BreadcrumbLink asChild>
                        <Link href="/">Inicio</Link>
                    </BreadcrumbLink>
                </BreadcrumbItem>

                {segments.length > 0 && <BreadcrumbSeparator />}

                {segments.map((segment, index) => {
                    const isLast = index === segments.length - 1;
                    const href = `/${segments.slice(0, index + 1).join("/")}`;
                    // Check context for override (try both with and without trailing slash), then map, then fallback
                    const name = labels[href] || labels[href + "/"] || routeNameMap[segment] || segment.charAt(0).toUpperCase() + segment.slice(1);

                    return (
                        <Fragment key={href}>
                            <BreadcrumbItem>
                                {isLast ? (
                                    <BreadcrumbPage>{name}</BreadcrumbPage>
                                ) : (
                                    <BreadcrumbLink asChild>
                                        <Link href={href}>{name}</Link>
                                    </BreadcrumbLink>
                                )}
                            </BreadcrumbItem>
                            {!isLast && <BreadcrumbSeparator />}
                        </Fragment>
                    );
                })}
            </BreadcrumbList>
        </Breadcrumb>
    );
}
</file>

<file path="frontend2/components/layout/header.tsx">
import { cn } from "@/lib/utils";
import { Menu } from "lucide-react";
import { CommandMenu } from "@/components/command-menu";
import { TaskSheet } from "@/components/task-sheet";
import { NotificationsSheet } from "@/components/notifications-sheet";
import { UserMenu } from "@/components/user-menu";
import { Sheet, SheetContent, SheetTrigger, SheetTitle, SheetDescription } from "@/components/ui/sheet";
import { SidebarContent } from "./sidebar";

interface HeaderProps {
    onToggleSidebar: () => void;
    collapsed: boolean;
}

export function Header({ onToggleSidebar, collapsed }: HeaderProps) {
    return (
        <header
            className={cn(
                "fixed top-0 right-0 h-14 bg-white border-b border-border transition-all duration-300 z-30 flex items-center justify-between px-4 shadow-sm",
                "left-0", // Mobile default
                collapsed ? "md:left-16" : "md:left-64" // Desktop overrides
            )}
        >
            {/* Left Section */}
            <div className="flex items-center gap-4">
                {/* Mobile Sidebar Trigger */}
                <Sheet>
                    <SheetTrigger asChild>
                        <button
                            className="md:hidden p-2 hover:bg-slate-100 rounded-lg transition-colors text-slate-600"
                            aria-label="Open sidebar"
                        >
                            <Menu className="w-5 h-5" />
                        </button>
                    </SheetTrigger>
                    <SheetContent side="left" className="p-0 w-64 border-r-0">
                        <SheetTitle className="sr-only">Navigation</SheetTitle>
                        <SheetDescription className="sr-only">Mobile navigation menu</SheetDescription>
                        <SidebarContent collapsed={false} />
                    </SheetContent>
                </Sheet>

                {/* Desktop Sidebar Toggle */}
                <button
                    onClick={onToggleSidebar}
                    className="hidden md:block p-2 hover:bg-slate-100 rounded-lg transition-colors text-slate-600"
                    aria-label="Toggle sidebar"
                >
                    <Menu className="w-5 h-5" />
                </button>
            </div>

            {/* Right Section */}
            <div className="ml-auto flex items-center gap-2">
                <div className="flex md:flex-1 gap-2 items-center justify-end">
                    <CommandMenu />
                    {/* <TaskSheet /> */}
                    <NotificationsSheet />
                    <UserMenu />
                </div>
            </div>
        </header>
    );
}
</file>

<file path="frontend2/components/personnel/PersonForm.tsx">
"use client";

import { useState, useEffect } from "react";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import * as z from "zod";
import { format } from "date-fns";
import { useRouter } from "next/navigation";
import { toast } from "sonner";
import useSWR from "swr";
import apiClient from "@/lib/api-client";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { FileUpload } from "@/components/ui/file-upload";
import { Combobox } from "@/components/ui/combobox";
import { DatePicker } from "@/components/ui/date-picker";
import { parseBackendDate } from "@/lib/utils";

const fetcher = (url: string) => apiClient.get(url).then(res => res.data.results || res.data);

const sanitizeCedulaNumber = (value: string): string => {
    let sanitized = value.replace(/[.,]/g, '');
    sanitized = sanitized.replace(/^0+/, '');
    return sanitized || '0';
};

const personSchema = z.object({
    first_name: z.string()
        .min(1, "El primer nombre es requerido")
        .regex(/^[a-zA-ZáéíóúÁÉÍÓÚñÑüÜ\s]+$/, "El nombre solo puede contener letras"),
    second_name: z.string().optional()
        .refine(val => !val || /^[a-zA-ZáéíóúÁÉÍÓÚñÑüÜ\s]+$/.test(val), "El segundo nombre solo puede contener letras"),
    paternal_surname: z.string()
        .min(1, "El apellido paterno es requerido")
        .regex(/^[a-zA-ZáéíóúÁÉÍÓÚñÑüÜ\s]+$/, "El apellido solo puede contener letras"),
    maternal_surname: z.string().optional()
        .refine(val => !val || /^[a-zA-ZáéíóúÁÉÍÓÚñÑüÜ\s]+$/.test(val), "El apellido materno solo puede contener letras"),
    gender: z.string().min(1, "El género es requerido").or(z.literal("")).refine(val => val !== "", "El género es requerido"),
    marital_status: z.string().optional().or(z.literal("")),
    birthdate: z.string()
        .min(1, "La fecha de nacimiento es requerida")
        .refine((val) => {
            const date = new Date(val);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return date <= today;
        }, "La fecha de nacimiento no puede ser futura"),
    country_of_birth: z.string().min(1, "El país de nacimiento es requerido").or(z.literal("")).refine(val => val !== "", "El país de nacimiento es requerido"),
    cedula_prefix: z.string().min(1, "El prefijo es requerido"),
    cedula_number: z.string()
        .min(1, "El número de cédula es requerido")
        .refine((val) => {
            const sanitized = sanitizeCedulaNumber(val);
            return /^\d+$/.test(sanitized);
        }, "El número de cédula solo puede contener dígitos")
        .refine((val) => {
            const sanitized = sanitizeCedulaNumber(val);
            return sanitized.length >= 1 && sanitized.length <= 8;
        }, "El número de cédula debe tener entre 1 y 8 dígitos"),
});

export type PersonFormData = z.infer<typeof personSchema>;

interface PersonFormProps {
    initialData?: any;
    isEditing?: boolean;
    personId?: string;
    onSuccess?: () => void;
}

export function PersonForm({ initialData, isEditing = false, personId, onSuccess }: PersonFormProps) {
    const router = useRouter();
    const [photoFile, setPhotoFile] = useState<File | null>(null);
    const [photoRemoved, setPhotoRemoved] = useState(false);
    const [isSubmitting, setIsSubmitting] = useState(false);

    const { data: genders } = useSWR("/api/core/genders/", fetcher);
    const { data: maritalStatuses } = useSWR("/api/core/marital-statuses/", fetcher);
    const { data: countries } = useSWR("/api/core/countries/", fetcher);

    // Prepare default values
    const defaultValues = {
        first_name: initialData?.first_name || "",
        second_name: initialData?.second_name || "",
        paternal_surname: initialData?.paternal_surname || "",
        maternal_surname: initialData?.maternal_surname || "",
        gender: initialData?.gender?.toString() || "",
        marital_status: initialData?.marital_status?.toString() || "",
        birthdate: initialData?.birthdate || "",
        country_of_birth: initialData?.country_of_birth?.toString() || "",
        cedula_prefix: initialData?.national_ids?.find((n: any) => n.category === 'CEDULA')?.document_type || "",
        cedula_number: initialData?.national_ids?.find((n: any) => n.category === 'CEDULA')?.number || "",
    };

    const { register, handleSubmit, formState: { errors }, setValue, watch, setError } = useForm<PersonFormData>({
        resolver: zodResolver(personSchema),
        defaultValues
    });

    const onSubmit = async (data: PersonFormData) => {
        setIsSubmitting(true);
        try {
            const formData = new FormData();

            // Append basic fields
            Object.entries(data).forEach(([key, value]) => {
                if (key !== 'cedula_prefix' && key !== 'cedula_number') {
                    if (value) formData.append(key, value);
                }
            });

            // Handle Cedula (only for create, or if we decide to allow editing cedula via this form)
            // For edit, we might need special handling if cedula changes are allowed
            if (!isEditing) {
                formData.append('cedula_prefix', data.cedula_prefix);
                formData.append('cedula_number', sanitizeCedulaNumber(data.cedula_number));
            } else {
                // If editing, we might want to update the cedula if it changed?
                // The backend serializer might not handle nested write for national_ids easily on update without custom logic.
                // For now, let's include them and see if backend handles it or if we need a separate endpoint.
                // Given the serializer structure, write_only fields might be ignored on update unless we override update()
                formData.append('cedula_prefix', data.cedula_prefix);
                formData.append('cedula_number', sanitizeCedulaNumber(data.cedula_number));
            }

            // Append photo if selected
            if (photoFile) {
                formData.append('photo', photoFile);
            } else if (photoRemoved && initialData?.photo) {
                formData.append('photo', 'DELETE');
            }

            if (isEditing && personId) {
                await apiClient.patch(`/api/core/persons/${personId}/`, formData, {
                    headers: { 'Content-Type': 'multipart/form-data' },
                });
                toast.success("Persona actualizada exitosamente");
            } else {
                await apiClient.post("/api/core/persons/", formData, {
                    headers: { 'Content-Type': 'multipart/form-data' },
                });
                toast.success("Persona creada exitosamente");
                router.push("/admin/personnel/people");
            }

            if (onSuccess) onSuccess();

        } catch (error: any) {
            console.error("Error submitting form:", error);
            if (error.response?.data) {
                const serverErrors = error.response.data;
                Object.keys(serverErrors).forEach((key) => {
                    if (key in defaultValues) {
                        setError(key as keyof PersonFormData, {
                            type: "server",
                            message: serverErrors[key][0] || serverErrors[key]
                        });
                    } else {
                        toast.error(`Error: ${serverErrors[key]}`);
                    }
                });
            } else {
                toast.error("Ocurrió un error al guardar la persona");
            }
        } finally {
            setIsSubmitting(false);
        }
    };

    return (
        <form onSubmit={handleSubmit(onSubmit)}>
            <Card>
                <CardHeader>
                    <CardTitle>{isEditing ? "Editar Información Personal" : "Información Personal"}</CardTitle>
                    <CardDescription>{isEditing ? "Actualiza los datos de la persona" : "Completa los datos de la persona"}</CardDescription>
                </CardHeader>
                <CardContent>
                    <div className="grid gap-4 md:grid-cols-2">
                        {/* Personal Info Fields */}
                        <div className="space-y-2">
                            <Label htmlFor="first_name" className={errors.first_name ? "text-destructive" : ""}>Primer Nombre *</Label>
                            <Input id="first_name" className={`text-sm ${errors.first_name ? "border-destructive" : ""}`} {...register("first_name")} />
                            {errors.first_name && (
                                <p className="text-sm text-destructive">{errors.first_name.message}</p>
                            )}
                        </div>

                        <div className="space-y-2">
                            <Label htmlFor="second_name" className={errors.second_name ? "text-destructive" : ""}>Segundo Nombre</Label>
                            <Input id="second_name" className={`text-sm ${errors.second_name ? "border-destructive" : ""}`} {...register("second_name")} />
                            {errors.second_name && (
                                <p className="text-sm text-destructive">{errors.second_name.message}</p>
                            )}
                        </div>

                        <div className="space-y-2">
                            <Label htmlFor="paternal_surname" className={errors.paternal_surname ? "text-destructive" : ""}>Apellido Paterno *</Label>
                            <Input id="paternal_surname" className={`text-sm ${errors.paternal_surname ? "border-destructive" : ""}`} {...register("paternal_surname")} />
                            {errors.paternal_surname && (
                                <p className="text-sm text-destructive">{errors.paternal_surname.message}</p>
                            )}
                        </div>

                        <div className="space-y-2">
                            <Label htmlFor="maternal_surname" className={errors.maternal_surname ? "text-destructive" : ""}>Apellido Materno</Label>
                            <Input id="maternal_surname" className={`text-sm ${errors.maternal_surname ? "border-destructive" : ""}`} {...register("maternal_surname")} />
                            {errors.maternal_surname && (
                                <p className="text-sm text-destructive">{errors.maternal_surname.message}</p>
                            )}
                        </div>

                        <div className="space-y-2">
                            <Label htmlFor="gender" className={errors.gender ? "text-destructive" : ""}>Género *</Label>
                            <Combobox
                                options={genders?.map((g: any) => ({ value: g.id.toString(), label: g.name })) || []}
                                value={watch("gender")}
                                onSelect={(value) => setValue("gender", value.toString())}
                                placeholder="Seleccionar género"
                                className={errors.gender ? "border-destructive" : ""}
                            />
                            {errors.gender && (
                                <p className="text-sm text-destructive">{errors.gender.message}</p>
                            )}
                        </div>

                        <div className="space-y-2">
                            <Label htmlFor="marital_status">Estado Civil</Label>
                            <Combobox
                                options={maritalStatuses?.map((ms: any) => ({ value: ms.id.toString(), label: ms.name })) || []}
                                value={watch("marital_status")}
                                onSelect={(value) => setValue("marital_status", value.toString())}
                                placeholder="Seleccionar estado civil"
                            />
                        </div>

                        <div className="space-y-2">
                            <Label>Fecha de Nacimiento *</Label>
                            <DatePicker
                                value={parseBackendDate(watch("birthdate"))}
                                onChange={(date) => {
                                    setValue("birthdate", date ? format(date, "yyyy-MM-dd") : "");
                                }}
                            />
                            {errors.birthdate && (
                                <p className="text-sm text-destructive">{errors.birthdate.message}</p>
                            )}
                        </div>

                        <div className="space-y-2">
                            <Label htmlFor="country_of_birth" className={errors.country_of_birth ? "text-destructive" : ""}>País de Nacimiento *</Label>
                            <Combobox
                                options={(countries?.results || (Array.isArray(countries) ? countries : []))?.map((c: any) => ({ value: c.id.toString(), label: c.name })) || []}
                                value={watch("country_of_birth")}
                                onSelect={(value) => setValue("country_of_birth", value.toString())}
                                placeholder="Seleccionar país"
                                className={errors.country_of_birth ? "border-destructive" : ""}
                            />
                            {errors.country_of_birth && (
                                <p className="text-sm text-destructive">{errors.country_of_birth.message}</p>
                            )}
                        </div>

                        <div className="space-y-2">
                            <Label className={errors.cedula_prefix || errors.cedula_number ? "text-destructive" : ""}>Cédula *</Label>
                            <div className="grid grid-cols-3 gap-2">
                                <div>
                                    <Select
                                        value={watch("cedula_prefix")}
                                        onValueChange={(value) => setValue("cedula_prefix", value)}
                                    >
                                        <SelectTrigger className={`w-full ${errors.cedula_prefix ? "border-destructive" : ""}`}>
                                            <SelectValue placeholder="-" />
                                        </SelectTrigger>
                                        <SelectContent>
                                            {["V", "E"].map((prefix) => (
                                                <SelectItem key={prefix} value={prefix}>
                                                    {prefix}
                                                </SelectItem>
                                            ))}
                                        </SelectContent>
                                    </Select>
                                    {errors.cedula_prefix && (
                                        <p className="text-sm text-destructive mt-1">{errors.cedula_prefix.message}</p>
                                    )}
                                </div>
                                <div className="col-span-2">
                                    <Input
                                        {...register("cedula_number")}
                                        placeholder="12345678"
                                        className={`text-sm ${errors.cedula_number ? "border-destructive" : ""}`}
                                    />
                                    {errors.cedula_number && (
                                        <p className="text-sm text-destructive mt-1">{errors.cedula_number.message}</p>
                                    )}
                                </div>
                            </div>
                        </div>

                        <div className="space-y-2 md:col-span-2">
                            <Label>Foto</Label>
                            <FileUpload
                                onFileSelect={(file) => {
                                    setPhotoFile(file);
                                    if (file) setPhotoRemoved(false);
                                }}
                                accept="image/*"
                                currentFile={photoFile}
                                initialPreviewUrl={initialData?.photo}
                                onRemove={() => setPhotoRemoved(true)}
                            />
                            <p className="text-xs text-muted-foreground">
                                Formatos permitidos: JPG, PNG. Máximo 5MB.
                            </p>
                        </div>
                    </div>

                    <div className="flex justify-end gap-4 mt-6">
                        <Button type="button" variant="outline" onClick={() => router.back()}>
                            Cancelar
                        </Button>
                        <Button type="submit" disabled={isSubmitting}>
                            {isSubmitting ? "Guardando..." : (isEditing ? "Actualizar" : "Crear Persona")}
                        </Button>
                    </div>
                </CardContent>
            </Card>
        </form>
    );
}
</file>

<file path="frontend2/components/ui/badge.tsx">
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const badgeVariants = cva(
  "inline-flex items-center justify-center rounded-full border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90",
        destructive:
          "border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground",
        "brand-secondary":
          "border-transparent bg-brand-secondary text-brand-secondary-foreground [a&]:hover:bg-brand-secondary/90",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

function Badge({
  className,
  variant,
  asChild = false,
  ...props
}: React.ComponentProps<"span"> &
  VariantProps<typeof badgeVariants> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : "span"

  return (
    <Comp
      data-slot="badge"
      className={cn(badgeVariants({ variant }), className)}
      {...props}
    />
  )
}

export { Badge, badgeVariants }
</file>

<file path="frontend2/components/ui/combobox.tsx">
"use client"

import * as React from "react"
import { Check, ChevronsUpDown } from "lucide-react"

import { cn } from "@/lib/utils"
import { Button } from "@/components/ui/button"
import {
    Command,
    CommandEmpty,
    CommandGroup,
    CommandInput,
    CommandItem,
    CommandList,
} from "@/components/ui/command"
import {
    Popover,
    PopoverContent,
    PopoverTrigger,
} from "@/components/ui/popover"

export interface ComboboxOption {
    value: string | number
    label: string
}

interface ComboboxProps {
    options: ComboboxOption[]
    value?: string | number
    onSelect: (value: string | number) => void
    placeholder?: string
    emptyText?: string
    className?: string
    disabled?: boolean
}

export function Combobox({
    options,
    value,
    onSelect,
    placeholder = "Seleccionar...",
    emptyText = "No se encontraron resultados.",
    className,
    disabled = false,
}: ComboboxProps) {
    const [open, setOpen] = React.useState(false)

    return (
        <Popover open={open} onOpenChange={setOpen}>
            <PopoverTrigger asChild>
                <Button
                    variant="outline"
                    role="combobox"
                    aria-expanded={open}
                    className={cn("w-full justify-between", className)}
                    disabled={disabled}
                >
                    <span className="truncate">
                        {value
                            ? options.find((option) => option.value === value)?.label
                            : placeholder}
                    </span>
                    <ChevronsUpDown className="ml-2 h-4 w-4 shrink-0 opacity-50" />
                </Button>
            </PopoverTrigger>
            <PopoverContent className="w-[--radix-popover-trigger-width] p-0" align="start">
                <Command>
                    <CommandInput placeholder={`Buscar...`} />
                    <CommandList>
                        <CommandEmpty>{emptyText}</CommandEmpty>
                        <CommandGroup>
                            {options.map((option) => (
                                <CommandItem
                                    key={option.value}
                                    value={option.label} // Use label for search filtering
                                    onSelect={() => {
                                        onSelect(option.value === value ? "" : option.value)
                                        setOpen(false)
                                    }}
                                >
                                    <Check
                                        className={cn(
                                            "mr-2 h-4 w-4",
                                            value === option.value ? "opacity-100" : "opacity-0"
                                        )}
                                    />
                                    {option.label}
                                </CommandItem>
                            ))}
                        </CommandGroup>
                    </CommandList>
                </Command>
            </PopoverContent>
        </Popover>
    )
}
</file>

<file path="frontend2/components/ui/date-picker.tsx">
"use client"

import * as React from "react"
import { CalendarIcon } from "lucide-react"
import { format } from "date-fns"
import { es } from "date-fns/locale"

import { Button } from "@/components/ui/button"
import { Calendar } from "@/components/ui/calendar"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import {
    Popover,
    PopoverContent,
    PopoverTrigger,
} from "@/components/ui/popover"

function formatDate(date: Date | undefined) {
    if (!date) {
        return ""
    }
    return format(date, "dd/MM/yyyy")
}

function isValidDate(date: Date | undefined) {
    if (!date) {
        return false
    }
    return !isNaN(date.getTime())
}

export interface DatePickerProps {
    value?: Date;
    onChange?: (date: Date | undefined) => void;
    placeholder?: string;
    className?: string;
}

export function DatePicker({ value, onChange, placeholder = "dd/mm/aaaa", className }: DatePickerProps) {
    const [open, setOpen] = React.useState(false)
    const [inputValue, setInputValue] = React.useState("")

    // Sync input value when prop value changes
    React.useEffect(() => {
        setInputValue(formatDate(value))
    }, [value])

    const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        let val = e.target.value

        // Allow only numbers and slashes
        val = val.replace(/[^0-9/]/g, '')

        // Auto-insert slashes
        if (val.length === 2 && inputValue.length === 1) {
            val += '/'
        } else if (val.length === 5 && inputValue.length === 4) {
            val += '/'
        }

        // Logic to cap values (Native-like behavior)
        const parts = val.split('/')

        // Cap Day > 31
        if (parts[0] && parseInt(parts[0]) > 31) {
            parts[0] = "31"
        }

        // Cap Month > 12
        if (parts[1] && parseInt(parts[1]) > 12) {
            parts[1] = "12"
        }

        // Cap Year > 2050
        if (parts[2] && parts[2].length === 4 && parseInt(parts[2]) > 2050) {
            parts[2] = "2050"
        }

        // Reconstruct value
        val = parts.join('/')

        // Limit length to 10 (DD/MM/YYYY)
        if (val.length > 10) {
            val = val.slice(0, 10)
        }

        setInputValue(val)

        // Try to parse the date from dd/MM/yyyy format
        if (val.length === 10) {
            const finalParts = val.split('/')
            if (finalParts.length === 3) {
                const day = parseInt(finalParts[0], 10)
                const month = parseInt(finalParts[1], 10) - 1
                const year = parseInt(finalParts[2], 10)

                const newDate = new Date(year, month, day)

                if (isValidDate(newDate) && newDate.getDate() === day && newDate.getMonth() === month && newDate.getFullYear() === year) {
                    onChange?.(newDate)
                } else {
                    onChange?.(undefined)
                }
            }
        } else if (val === "") {
            onChange?.(undefined)
        }
    }

    return (
        <div className={className}>
            <div className="relative flex gap-2">
                <Input
                    value={inputValue}
                    placeholder={placeholder}
                    className="bg-background text-sm pr-10"
                    onChange={handleInputChange}
                    onKeyDown={(e) => {
                        if (e.key === "ArrowDown") {
                            e.preventDefault()
                            setOpen(true)
                        }
                    }}
                />
                <Popover open={open} onOpenChange={setOpen}>
                    <PopoverTrigger asChild>
                        <Button
                            variant="ghost"
                            className="absolute top-1/2 right-2 size-6 -translate-y-1/2"
                        >
                            <CalendarIcon className="size-3.5" />
                            <span className="sr-only">Seleccionar fecha</span>
                        </Button>
                    </PopoverTrigger>
                    <PopoverContent
                        className="w-auto overflow-hidden p-0"
                        align="end"
                        alignOffset={-8}
                        sideOffset={10}
                    >
                        <div className="p-2 border-b">
                            <Button
                                variant="outline"
                                className="w-full"
                                size="sm"
                                onClick={() => {
                                    onChange?.(new Date())
                                    setOpen(false)
                                }}
                            >
                                Hoy
                            </Button>
                        </div>
                        <Calendar
                            mode="single"
                            selected={value}
                            captionLayout="dropdown"
                            // Default to today or selected date for month view
                            defaultMonth={value || new Date()}
                            onSelect={(date) => {
                                onChange?.(date)
                                setOpen(false)
                            }}
                            locale={es}
                        />
                    </PopoverContent>
                </Popover>
            </div>
        </div>
    )
}
</file>

<file path="frontend2/components/command-menu.tsx">
"use client"
import React, { useState } from "react";
import { Search } from "lucide-react"
import {
    CommandDialog,
    CommandEmpty,
    CommandGroup,
    CommandInput,
    CommandItem,
    CommandList,
    CommandSeparator,
} from "@/components/ui/command";
import { Kbd } from "@/components/ui/kbd"

import { commandSections } from "@/lib/command-menu-data"
import { Button } from "@/components/ui/button";

export function CommandMenu() {
    const [open, setOpen] = useState(false)
    return (
        <>
            <Button
                variant={"ghost"}
                size={"icon"}
                className="md:hidden"
                onClick={() => (setOpen(true))}
            >
                <Search className="size-4.5" />
            </Button>

            <Button
                variant="outline"
                onClick={() => (setOpen(true))}
                className="hidden w-90 justify-start text-slate-600 md:flex border-slate-200 bg-slate-50/50 hover:bg-slate-100 hover:text-slate-800"
            >
                <Search className="mr-2 h-4 w-4" />
                <span className="flex-1 text-left">Buscar</span>
            </Button>


            <CommandDialog open={open} onOpenChange={setOpen}>
                <CommandInput placeholder="Buscar" />
                <CommandList>
                    <CommandEmpty>Resultados no encontrados</CommandEmpty>
                    {commandSections.map((section, index) => (
                        <React.Fragment key={section.heading}>
                            {index > 0 && <CommandSeparator />}
                            <CommandGroup heading={section.heading}>
                                {section.items.map(item => {
                                    return (
                                        <CommandItem key={item.name} onSelect={() => setOpen(!open)}>
                                            <item.icon />
                                            <span>{item.name}</span>
                                        </CommandItem>
                                    )
                                })}
                            </CommandGroup>
                        </React.Fragment>
                    ))}
                </CommandList>
            </CommandDialog>
        </>
    );
}
</file>

<file path="frontend2/components/notifications-sheet.tsx">
import { Button } from "@/components/ui/button";
import {
    Sheet,
    SheetContent,
    SheetDescription,
    SheetHeader,
    SheetTitle,
    SheetTrigger,
} from "@/components/ui/sheet";
import { Bell, Check, Info, AlertTriangle, XCircle, CheckCircle2 } from "lucide-react";
import { cn } from "@/lib/utils";

const notifications = [
    {
        id: 1,
        title: "Solicitud aprobada",
        description: "Tu solicitud de vacaciones ha sido aprobada por RRHH.",
        time: "Hace 5 min",
        read: false,
        type: "success"
    },
    {
        id: 2,
        title: "Recordatorio de reunión",
        description: "Reunión de equipo en 15 minutos en la sala de conferencias.",
        time: "Hace 15 min",
        read: false,
        type: "info"
    },
    {
        id: 3,
        title: "Actualización del sistema",
        description: "El sistema estará en mantenimiento este sábado a las 10 PM.",
        time: "Hace 2 horas",
        read: true,
        type: "warning"
    },
    {
        id: 4,
        title: "Error en carga de archivo",
        description: "El archivo 'reporte_mensual.pdf' no se pudo procesar.",
        time: "Ayer",
        read: true,
        type: "error"
    }
];

export function NotificationsSheet() {
    return (
        <Sheet>
            <SheetTrigger asChild>
                <Button variant="ghost" size="icon" aria-label="Notificaciones" className="text-slate-600 hover:bg-slate-100 hover:text-slate-800 relative">
                    <Bell className="size-5" />
                    <span className="absolute top-2 right-2 size-2 bg-destructive rounded-full border-2 border-white" />
                </Button>
            </SheetTrigger>

            <SheetContent className="w-[400px] sm:w-[540px] flex flex-col h-full py-6 px-4">
                <SheetHeader className="pb-4 border-b border-border">
                    <div className="flex items-center justify-between">
                        <SheetTitle className="flex items-center gap-2 text-xl">
                            <Bell className="size-5 text-brand-primary" />
                            <span>Notificaciones</span>
                        </SheetTitle>
                        {/* <Button variant="ghost" size="sm" className="text-xs text-muted-foreground hover:text-brand-primary">
                            Marcar todo como leído
                        </Button> */}
                    </div>
                </SheetHeader>

                <div className="flex-1 overflow-y-auto">
                    <div className="space-y-1">
                        {notifications.map((notification) => (
                            <div
                                key={notification.id}
                                className={cn(
                                    "flex gap-4 p-4 rounded-xl transition-colors cursor-pointer",
                                    notification.read ? "hover:bg-muted/50" : "bg-brand-primary/5 hover:bg-brand-primary/10"
                                )}
                            >
                                <div className={cn(
                                    "mt-1 size-8 rounded-full flex items-center justify-center shrink-0",
                                    notification.type === "success" ? "bg-green-100 text-green-600" :
                                        notification.type === "warning" ? "bg-yellow-100 text-yellow-600" :
                                            notification.type === "error" ? "bg-red-100 text-red-600" :
                                                "bg-blue-100 text-blue-600"
                                )}>
                                    {notification.type === "success" && <CheckCircle2 className="size-4" />}
                                    {notification.type === "warning" && <AlertTriangle className="size-4" />}
                                    {notification.type === "error" && <XCircle className="size-4" />}
                                    {notification.type === "info" && <Info className="size-4" />}
                                </div>

                                <div className="flex-1 space-y-1">
                                    <div className="flex items-start --justify-between gap-2">
                                        <p className={cn("text-sm font-medium leading-none", !notification.read && "text-brand-primary")}>
                                            {notification.title}
                                        </p>
                                        <span className="text-xs text-muted-foreground shrink-0">
                                            {notification.time}
                                        </span>
                                    </div>
                                    <p className="text-sm text-muted-foreground line-clamp-2">
                                        {notification.description}
                                    </p>
                                </div>

                                {!notification.read && (
                                    <div className="mt-2 size-2 bg-brand-primary rounded-full shrink-0" />
                                )}
                            </div>
                        ))}
                    </div>
                </div>

                <div className="flex flex-col items-end">
                    <Button variant="ghost" size="sm" className="text-xs text-muted-foreground hover:text-brand-primary">
                        Marcar todo como leído
                    </Button>
                    <div className="w-full pt-4 mt-auto border-t border-border">
                        <Button variant="outline" className="w-full">
                            Ver historial completo
                        </Button>
                    </div>
                </div>
            </SheetContent>
        </Sheet>
    );
}
</file>

<file path="frontend2/components/user-menu.tsx">
'use client';

import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import {
    DropdownMenu,
    DropdownMenuContent,
    DropdownMenuItem,
    DropdownMenuLabel,
    DropdownMenuSeparator,
    DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { Button } from "@/components/ui/button";
import Link from "next/link";
import { LogOut, User, Settings } from "lucide-react";

import { useAuth } from "@/context/auth-context";

export function UserMenu() {
    const { user, logout } = useAuth();

    const displayName = user?.person
        ? `${user.person.first_name} ${user.person.paternal_surname}`
        : user?.username || "Usuario";

    const getInitials = () => {
        if (user?.person) {
            const first = user.person.first_name[0];
            const last = user.person.paternal_surname[0];
            return `${first}${last}`.toUpperCase();
        }
        return user?.username?.slice(0, 2).toUpperCase() || "U";
    };

    return (
        <DropdownMenu>
            <DropdownMenuTrigger asChild>
                <Button variant="ghost" className="relative size-10 rounded-full ring-2 ring-slate-200 hover:ring-slate-300 transition-all">
                    <Avatar>
                        <AvatarImage
                            src={user?.person?.photo || undefined}
                            alt={displayName}
                        />
                        <AvatarFallback className="bg-brand-primary/10 text-brand-primary font-medium">{getInitials()}</AvatarFallback>
                    </Avatar>
                </Button>
            </DropdownMenuTrigger>

            <DropdownMenuContent align="end" className="w-56">
                <DropdownMenuLabel className="font-normal">
                    <div className="flex flex-col space-y-1">
                        <p className="text-sm font-medium leading-none">{displayName}</p>
                        <p className="text-xs leading-none text-muted-foreground">
                            @{user?.username}
                        </p>
                    </div>
                </DropdownMenuLabel>
                <DropdownMenuSeparator />

                <DropdownMenuItem asChild>
                    <Link href="/profile" className="cursor-pointer w-full flex items-center">
                        <User className="mr-2 h-4 w-4" />
                        <span>Perfil</span>
                    </Link>
                </DropdownMenuItem>

                <DropdownMenuItem asChild>
                    <Link href="/settings" className="cursor-pointer w-full flex items-center">
                        <Settings className="mr-2 h-4 w-4" />
                        <span>Ajustes</span>
                    </Link>
                </DropdownMenuItem>

                <DropdownMenuSeparator />

                <DropdownMenuItem
                    onClick={logout}
                    className="text-red-600 focus:text-red-600 cursor-pointer"
                >
                    <LogOut className="mr-2 h-4 w-4" />
                    <span>Cerrar sesión</span>
                </DropdownMenuItem>
            </DropdownMenuContent>
        </DropdownMenu>
    );
}
</file>

<file path="frontend2/lib/utils.ts">
import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}

export function parseBackendDate(dateString: string | null | undefined): Date | undefined {
  if (!dateString) return undefined;
  // Dividimos manualmente: "2025-11-23" -> [2025, 11, 23]
  const [year, month, day] = dateString.split('-').map(Number);
  // Creamos la fecha local: Año, Mes (0-11), Día
  return new Date(year, month - 1, day);
}
</file>

<file path="frontend2/types/course.ts">
// TypeScript interfaces matching backend training models

// --- ENUMS (matching Django choices) ---

export enum CourseStatus {
    DRAFT = 'BOR',
    SCHEDULED = 'PRO',
    IN_PROGRESS = 'EJE',
    COMPLETED = 'FIN',
    CANCELLED = 'CAN',
}

export enum CourseModality {
    PRESENTIAL = 'PRE',
    VIRTUAL_SYNC = 'VIR',
    VIRTUAL_ASYNC = 'ASY',
    HYBRID = 'MIX',
}

// 🔧 REFACTOR: ParticipantRole removed - all participants are students now

export enum EnrollmentStatus {
    REQUESTED = 'REQ',
    ENROLLED = 'ENR',
    REJECTED = 'REJ',
}

export enum AcademicStatus {
    PENDING = 'PEN',
    COMPLETED = 'COM',  // 🆕 NEW
    PASSED = 'APR',
    FAILED = 'REP',
}

export enum AttendanceStatus {
    PRESENT = 'PRE',
    ABSENT = 'AUS',
    LATE = 'TAR',
    EXCUSED = 'JUS',
}

// --- DISPLAY NAME HELPERS (Spanish) ---

export const courseStatusDisplay: Record<CourseStatus, string> = {
    [CourseStatus.DRAFT]: 'Borrador',
    [CourseStatus.SCHEDULED]: 'Programado',
    [CourseStatus.IN_PROGRESS]: 'En Ejecución',
    [CourseStatus.COMPLETED]: 'Finalizado',
    [CourseStatus.CANCELLED]: 'Cancelado',
};

export const courseModalityDisplay: Record<CourseModality, string> = {
    [CourseModality.PRESENTIAL]: 'Presencial',
    [CourseModality.VIRTUAL_SYNC]: 'Virtual (En Vivo / Zoom)',
    [CourseModality.VIRTUAL_ASYNC]: 'Virtual (Autoaprendizaje)',
    [CourseModality.HYBRID]: 'Híbrido / Mixto',
};

export const enrollmentStatusDisplay: Record<EnrollmentStatus, string> = {
    [EnrollmentStatus.REQUESTED]: 'Solicitud Enviada',
    [EnrollmentStatus.ENROLLED]: 'Inscrito',
    [EnrollmentStatus.REJECTED]: 'Solicitud Rechazada',
};

export const academicStatusDisplay: Record<AcademicStatus, string> = {
    [AcademicStatus.PENDING]: 'En Curso',
    [AcademicStatus.COMPLETED]: 'Completado',  // 🆕 NEW
    [AcademicStatus.PASSED]: 'Aprobado',
    [AcademicStatus.FAILED]: 'Reprobado',
};

// --- INTERFACES ---

export interface CourseResource {
    id: number;
    name: string;
    resource_type: string;
    file?: string;
    file_url?: string; // 🆕 NEW: Added file_url
    url?: string;
    created_at: string;
}

export interface CourseSession {
    id: number;
    course_name?: string;
    topic: string;
    date: string;
    start_time: string;
    end_time: string;
}

// 🆕 NEW: Hierarchical Content Interfaces

export interface CourseLesson {
    id: number;
    module: number;
    module_name: string;
    title: string;
    content: string;
    order: number;
    duration_minutes: number;
    resources?: CourseResource[];
    course_id?: number;
    course_instructor_id?: number;
}

export interface CourseModule {
    id: number;
    course: number;
    name: string;
    description?: string;
    order: number;
    lessons: CourseLesson[];
    lesson_count: number;
}

export interface LessonProgress {
    id: number;
    enrollment: number;
    lesson: number;
    lesson_title?: string;
    person_name?: string;
    completed: boolean;
    completed_at?: string;
}

export interface CourseProgress {
    total_lessons: number;
    completed_lessons: number;
    progress_percentage: number;
    is_complete: boolean;
}

export interface ParticipantListItem {
    id: number;
    person_id: number;
    person_name: string;
    person_id_document?: string;
    // 🔧 REFACTOR: role removed - all participants are students
    enrollment_status: EnrollmentStatus;
    enrollment_status_name: string;
    academic_status: AcademicStatus;
    academic_status_name: string;
    grade?: number;
}

export interface CourseParticipant extends ParticipantListItem {
    course: number;
    person: number;
}

export interface Course {
    id: number;
    name: string;
    description?: string;
    cover_image?: string;
    start_date: string;
    end_date: string;
    modality: CourseModality;
    modality_display: string;
    max_participants: number;
    duration_hours: number;
    status: CourseStatus;
    status_name: string;
    enrolled_count: number;
    is_full: boolean;
    is_public: boolean;
    department?: number;
    created_at: string;
    updated_at: string;

    // 🔧 REFACTOR: Instructor ahora es un campo directo del curso
    instructor_id?: number;
    instructor_name?: string;
    instructor_id_document?: string;

    // 🆕 NEW: Grading logic
    requires_approval_to_complete: boolean;

    // Nested data (in detail view)
    students?: ParticipantListItem[]; // Solo estudiantes ahora
    resources?: CourseResource[];
    sessions?: CourseSession[];
    modules?: CourseModule[];  // 🆕 NEW: Hierarchical content
}

export interface AttendanceRecord {
    id: number;
    session: number;
    participant: number;
    person_name: string;
    status: AttendanceStatus;
    status_display: string;
    notes?: string;
}

// --- USER ENROLLMENT INFO (for CourseHeader logic) ---

export interface UserEnrollment {
    id?: number;
    enrollment_status?: EnrollmentStatus;
    academic_status?: AcademicStatus;
    // 🔧 REFACTOR: role removed
    grade?: number;
}
</file>

<file path="backend/accounts/serializers.py">
from rest_framework import serializers
from django.db import transaction
from django.contrib.auth.password_validation import validate_password as django_validate_password
from core.models import (
    Person, Gender, MaritalStatus, Country
)
# FIX: Importamos check_uniqueness para blindar el username contra Errores 500
from core.serializers import PersonSerializer, check_uniqueness
from .models import User
from dj_rest_auth.serializers import LoginSerializer
from django.utils.translation import gettext_lazy as _

class UserReadSerializer(serializers.ModelSerializer):
    person = PersonSerializer(read_only=True)
    class Meta:
        model = User
        fields = (
                'id',
                'username', 
                'is_staff', 
                'is_active', 
                'person'
            )

class EmployeeCreationSerializer(serializers.ModelSerializer):
    # Campos de Contraseña
    password = serializers.CharField(write_only=True, style={'input_type': 'password'})
    confirm_password = serializers.CharField(write_only=True, style={'input_type': 'password'})
    
    # Vincular Persona Existente
    person_id = serializers.PrimaryKeyRelatedField(
        queryset=Person.objects.all(), 
        source='person', 
        write_only=True, 
        required=False
    )
    
    # Crear Nueva Persona (Campos planos que mapearemos manualmente)
    first_name = serializers.CharField(max_length=100, write_only=True, required=False)
    second_name = serializers.CharField(max_length=100, write_only=True, required=False)
    paternal_surname = serializers.CharField(max_length=100, write_only=True, required=False)
    maternal_surname = serializers.CharField(max_length=100, write_only=True, required=False)
    birthdate = serializers.DateField(write_only=True, required=False)
    
    # FKs para nueva persona
    gender_id = serializers.PrimaryKeyRelatedField(
        queryset=Gender.objects.all(), write_only=True, required=False, source='gender'
    )
    marital_status_id = serializers.PrimaryKeyRelatedField(
        queryset=MaritalStatus.objects.all(), write_only=True, required=False, source='marital_status'
    )
    country_of_birth_id = serializers.PrimaryKeyRelatedField(
        queryset=Country.objects.all(), write_only=True, required=False, source='country_of_birth'
    )
    photo = serializers.ImageField(write_only=True, required=False)

    # Salida
    person = PersonSerializer(read_only=True)

    class Meta:
        model = User
        fields = (
            'id', 
            'username', 
            'password', 
            'confirm_password', 
            'person',
            
            # Inputs
            'person_id',
            'first_name', 'second_name', 'paternal_surname', 'maternal_surname',
            'birthdate', 'salutation_id', 'gender_id', 
            'marital_status_id', 'country_of_birth_id', 'photo'
        )

    def validate_username(self, value):
        """Normaliza el usuario a minúsculas y verifica unicidad."""
        cleaned = value.strip().lower()
        
        # FIX: Usamos check_uniqueness para asegurar que el valor normalizado no exista ya.
        return check_uniqueness(User, 'username', cleaned, self.instance, "Este nombre de usuario ya está registrado.")

    def validate(self, data):
        # 1. Validación de Contraseñas Coincidentes
        if data.get('password') != data.get('confirm_password'):
            raise serializers.ValidationError({"confirm_password": "Las contraseñas no coinciden."})

        # 2. Validación de Complejidad de Contraseña (Django Standard)
        if 'password' in data:
            try:
                django_validate_password(data['password'])
            except Exception as e:
                raise serializers.ValidationError({"password": list(e.messages)})

        # 3. Lógica de Persona (Existente vs Nueva)
        PERSON_WRITE_FIELDS = [
            'first_name', 'second_name', 'paternal_surname', 'maternal_surname',
            'birthdate', 'salutation', 'gender', 'marital_status',
            'country_of_birth', 'photo'
        ]
        
        # Detectar qué campos de "Nueva Persona" vienen en la data
        new_person_data = {k: v for k, v in data.items() if k in PERSON_WRITE_FIELDS}
        has_new_person_data = bool(new_person_data)
        has_person_id = 'person' in data # 'person' es el source de 'person_id'

        # Regla: O vinculas o creas, no ambas.
        if has_person_id and has_new_person_data:
            raise serializers.ValidationError(
                "No puede proveer 'person_id' y datos de nueva persona a la vez."
            )

        # Regla: Debes hacer al menos una cosa.
        if not has_person_id and not has_new_person_data:
             raise serializers.ValidationError(
                 "Debe proveer 'person_id' (para vincular existente) o datos para crear una nueva persona."
             )

        # Regla: Si creas nueva, mínimos requeridos.
        if has_new_person_data:
            if not ('first_name' in data and 'paternal_surname' in data):
                raise serializers.ValidationError("Para crear una nueva persona, 'first_name' y 'paternal_surname' son obligatorios.")

            # --- BLINDAJE CORE ---
            # Validamos usando PersonSerializer para aplicar las reglas de core
            person_validator = PersonSerializer(data=new_person_data)
            if not person_validator.is_valid():
                raise serializers.ValidationError(person_validator.errors)

        # Regla: Si vinculas, que no tenga usuario ya.
        if has_person_id:
            person = data['person']
            if hasattr(person, 'user_account'): 
                 raise serializers.ValidationError(
                     f"La persona '{person}' ya tiene un usuario asignado ({person.user_account.username})."
                 )
            
        return data

    @transaction.atomic
    def create(self, validated_data):
        validated_data.pop('confirm_password')
        
        PERSON_FIELDS = [
            'first_name', 'second_name', 'paternal_surname', 'maternal_surname',
            'birthdate', 'salutation', 'gender', 'marital_status',
            'country_of_birth', 'photo'
        ]
        
        new_person = None
        
        if 'person' in validated_data:
            new_person = validated_data.pop('person')
            for field in PERSON_FIELDS:
                validated_data.pop(field, None)
        else:
            person_data = {}
            for field in PERSON_FIELDS:
                if field in validated_data:
                    person_data[field] = validated_data.pop(field)
            
            # Creamos la persona (Ya validada en validate())
            new_person = Person.objects.create(**person_data)
        
        # Crear Usuario
        password = validated_data.pop('password')
        new_user = User.objects.create_user(
            password=password,
            person=new_person,
            **validated_data
        )
        
        return new_user

class CustomUserDetailsSerializer(serializers.ModelSerializer):
    """
    Serializer para ver detalles del usuario logueado.
    """
    person = PersonSerializer(read_only=True)

    class Meta:
        model = User
        fields = ('pk', 'username', 'is_staff', 'person')

class CustomLoginSerializer(LoginSerializer):
    def validate(self, attrs):
        try:
            return super().validate(attrs)
        except serializers.ValidationError:
            # Capturamos cualquier error de validación (incluyendo credenciales inválidas)
            # y lanzamos nuestro mensaje personalizado.
            msg = _('Usuario o contraseña incorrectos. Por favor verifique sus datos e intente nuevamente.')
            raise serializers.ValidationError(msg)
</file>

<file path="backend/config/urls.py">
from django.contrib import admin
from django.urls import path, include
from django.conf import settings
from django.conf.urls.static import static

urlpatterns = [
    path('admin/', admin.site.urls),
    path('api/auth/', include('dj_rest_auth.urls')),
    path('api/accounts/', include('accounts.urls')),
    path('api/core/', include('core.urls')),
    path('api/organization/', include('organization.urls')),
    path('api/employment/', include('employment.urls')),
    path('api/talent/', include('talent.urls')),
    path('api/training/', include('training.urls')),
    path('api/performance/', include('performance.urls')),
    path('api/ats/', include('ats.urls')),  # ATS: incluye /public y admin
]

if settings.DEBUG:
    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)
</file>

<file path="backend/employment/admin.py">
from django.contrib import admin
from .models import Employment, EmploymentStatusLog, EmploymentDepartmentRole

# Registrar los modelos en el admin de Django
admin.site.register(Employment)
admin.site.register(EmploymentStatusLog)
admin.site.register(EmploymentDepartmentRole)
</file>

<file path="backend/employment/urls.py">
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .views import EmploymentViewSet, EmploymentStatusLogViewSet, EmploymentDepartmentRoleViewSet, PersonDepartmentRoleViewSet

router = DefaultRouter()
# Removemos las rutas de catálogos viejos (roles, employment-types, employment-statuses)
# Solo mantenemos employments y logs
router.register(r'employments', EmploymentViewSet, basename='employment')
router.register(r'status-logs', EmploymentStatusLogViewSet, basename='status-log')
router.register(r'department-roles', EmploymentDepartmentRoleViewSet,basename='department-role')
router.register(r'person-department-roles', PersonDepartmentRoleViewSet, basename='person-department-role')

urlpatterns = [
    path('', include(router.urls)),
]
</file>

<file path="backend/organization/management/commands/__init__.py">
# Empty __init__.py file for commands package
</file>

<file path="backend/organization/management/__init__.py">
# Empty __init__.py file for Python package
</file>

<file path="backend/organization/admin.py">
from django.contrib import admin
from . import models

admin.site.register(models.Department)
admin.site.register(models.JobTitle)
admin.site.register(models.Position)
admin.site.register(models.PositionRequirement)
admin.site.register(models.PositionFunction)
</file>

<file path="backend/training/admin.py">
from django.contrib import admin
from . import models
from django.db.models import Count

# --- 1. INLINES (Tablas anidadas dentro del formulario del Curso) ---

class ParticipantInline(admin.TabularInline):
    """🔧 REFACTOR: Ahora solo gestiona estudiantes, no instructores."""
    model = models.CourseParticipant
    extra = 1
    raw_id_fields = ('person',) 
    readonly_fields = ('get_person_name',) 
    fields = ('person', 'get_person_name', 'enrollment_status', 'academic_status', 'grade')
    
    def get_person_name(self, obj):
        return str(obj.person)
    get_person_name.short_description = 'Nombre de la Persona'


class SessionInline(admin.TabularInline):
    """Permite gestionar el horario y temas del curso."""
    model = models.CourseSession
    extra = 1
    fields = ('topic', 'date', 'start_time', 'end_time')
    ordering = ('date', 'start_time')


class ResourceInline(admin.TabularInline):
    """Permite gestionar los materiales de apoyo."""
    model = models.CourseResource
    extra = 1
    fields = ('name', 'resource_type', 'file', 'url')


# --- 2. MODEL ADMINS PRINCIPALES ---

@admin.register(models.Course)
class CourseAdmin(admin.ModelAdmin):
    """Admin para el modelo principal Course."""
    
    # Campos a mostrar en la lista de cursos
    list_display = (
        'name', 
        'instructor',  # 🔧 REFACTOR: Nuevo campo directo
        'get_modality_display', 
        'status', 
        'start_date', 
        'end_date', 
        'max_participants', 
        'enrolled_count',
        'is_full'
    )
    
    # Campos para filtrar la lista
    list_filter = ('status', 'modality', 'start_date')
    
    # Campos para búsqueda rápida
    search_fields = ('name', 'description')
    
    # 🔧 REFACTOR: Ahora el instructor es editable directamente
    raw_id_fields = ('instructor',)
    
    # Campos de solo lectura
    readonly_fields = ('enrolled_count', 'is_full') 

    # Agregamos las secciones inlines al formulario de edición
    inlines = [ParticipantInline, SessionInline, ResourceInline]
class AttendanceRecordAdmin(admin.ModelAdmin):
    """Admin para auditar registros de asistencia."""
    list_display = ('session', 'participant_person', 'status', 'notes')
    list_filter = ('status', 'session__course')
    search_fields = ('participant__person__first_name', 'session__topic')

    def participant_person(self, obj):
        return str(obj.participant.person)
    participant_person.short_description = 'Participante'
    
    
# --- 3. REGISTRO DE MODELOS RESTANTES ---
# (Modelos que no necesitan Inlines ni personalización compleja)

# 🆕 NEW: Register hierarchical content models
@admin.register(models.CourseModule)
class CourseModuleAdmin(admin.ModelAdmin):
    """Admin para módulos del curso."""
    list_display = ('course', 'name', 'order')
    list_filter = ('course',)
    search_fields = ('name', 'description')
    ordering = ('course', 'order')


@admin.register(models.CourseLesson)
class CourseLessonAdmin(admin.ModelAdmin):
    """Admin para lecciones individuales."""
    list_display = ('module', 'title', 'order', 'duration_minutes')
    list_filter = ('module__course',)
    search_fields = ('title', 'content')
    ordering = ('module', 'order')


@admin.register(models.LessonProgress)
class LessonProgressAdmin(admin.ModelAdmin):
    """Admin para el progreso de lecciones por estudiante."""
    list_display = ('enrollment', 'lesson', 'completed', 'completed_at')
    list_filter = ('completed', 'lesson__module__course')
    search_fields = ('enrollment__person__first_name', 'lesson__title')
    readonly_fields = ('completed_at',)


admin.site.register(models.CourseSession)
admin.site.register(models.CourseResource)
</file>

<file path="backend/.gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts
# db.sqlite3

/media
</file>

<file path="backend/pyproject.toml">
[project]
name = "backend"
version = "0.1.0"
description = "Add your description here"
readme = "README.md"
requires-python = ">=3.13"
dependencies = [
    "cairosvg>=2.8.2",
    "dj-rest-auth>=7.0.1",
    "django>=5.2.8",
    "django-allauth>=65.13.0",
    "django-cors-headers>=4.9.0",
    "django-environ>=0.12.0",
    "django-filter>=25.2",
    "django-simple-history>=3.10.1",
    "djangorestframework>=3.16.1",
    "djangorestframework-simplejwt>=5.5.1",
    "networkx>=3.6",
    "pillow>=12.0.0",
    "python-dateutil>=2.9.0.post0",
    "requests>=2.32.5",
    "svgwrite>=1.4.3",
]
</file>

<file path="frontend2/app/(main)/admin/config/talent/[slug]/page.tsx">
"use client";

import { CatalogCRUD, CatalogField } from "@/components/catalogs/catalog-crud";
import { ColumnDef } from "@tanstack/react-table";
import { notFound } from "next/navigation";
import { use } from "react";
import { Briefcase, GraduationCap, BookOpen, Languages, BarChart } from "lucide-react";

interface CatalogConfig {
    title: string;
    apiUrl: string;
    fields: CatalogField[];
    columns: ColumnDef<any>[];
    searchKey?: string;
    icon?: React.ElementType;
    singularName?: string;
}

const simpleNameColumns: ColumnDef<any>[] = [
    {
        accessorKey: "name",
        header: "Nombre",
        cell: ({ row }) => <div className="truncate">{row.getValue("name")}</div>
    },
];

const simpleNameFields: CatalogField[] = [
    {
        name: "name",
        label: "Nombre",
        type: "text",
        required: true,
    },
];

const catalogs: Record<string, CatalogConfig> = {
    "business-functions": {
        title: "Funciones de Negocio",
        singularName: "Función de Negocio",
        icon: Briefcase,
        apiUrl: "/api/talent/business-functions/",
        fields: simpleNameFields,
        columns: simpleNameColumns,
        searchKey: "name",
    },
    "education-levels": {
        title: "Niveles Educativos",
        singularName: "Nivel Educativo",
        icon: GraduationCap,
        apiUrl: "/api/talent/education-levels/",
        fields: simpleNameFields,
        columns: simpleNameColumns,
        searchKey: "name",
    },
    "fields-of-study": {
        title: "Campos de Estudio",
        singularName: "Campo de Estudio",
        icon: BookOpen,
        apiUrl: "/api/talent/fields-of-study/",
        fields: [
            {
                name: "education_level",
                label: "Nivel Educativo",
                type: "select",
                required: true,
                optionsUrl: "/api/talent/education-levels/",
                optionLabelKey: "name",
                optionValueKey: "id",
            },
            {
                name: "name",
                label: "Nombre",
                type: "text",
                required: true,
            },
        ],
        columns: [
            {
                accessorKey: "name",
                header: "Campo de Estudio",
                cell: ({ row }) => <div className="truncate">{row.getValue("name")}</div>
            },
            {
                accessorKey: "education_level_name",
                header: "Nivel Educativo",
                cell: ({ row }) => <div className="truncate">{row.getValue("education_level_name") || "Sin nivel"}</div>
            },
        ],
        searchKey: "name",
    },
    languages: {
        title: "Idiomas",
        singularName: "Idioma",
        icon: Languages,
        apiUrl: "/api/talent/languages/",
        fields: simpleNameFields,
        columns: simpleNameColumns,
        searchKey: "name",
    },
    proficiencies: {
        title: "Niveles de Dominio de Idioma",
        singularName: "Nivel de Dominio",
        icon: BarChart,
        apiUrl: "/api/talent/language-proficiencies/",
        fields: simpleNameFields,
        columns: simpleNameColumns,
        searchKey: "name",
    },
};

export default function TalentDynamicCatalogPage({ params }: { params: Promise<{ slug: string }> }) {
    const { slug } = use(params);
    const config = catalogs[slug];

    if (!config) {
        notFound();
    }

    return (
        <CatalogCRUD
            title={config.title}
            icon={config.icon}
            apiUrl={config.apiUrl}
            fields={config.fields}
            columns={config.columns}
            searchKey={config.searchKey}
            singularName={config.singularName}
        />
    );
}
</file>

<file path="frontend2/app/(main)/admin/organization/[slug]/page.tsx">
"use client";

import { CatalogCRUD, CatalogField } from "@/components/catalogs/catalog-crud";
import { ColumnDef } from "@tanstack/react-table";
import { notFound } from "next/navigation";
import { use } from "react";
import Link from "next/link";
import { Button } from "@/components/ui/button";
import { Eye } from "lucide-react";
import { DropdownMenuItem } from "@/components/ui/dropdown-menu";

interface CatalogConfig {
    title: string;
    apiUrl: string;
    fields: CatalogField[];
    columns: ColumnDef<any>[];
    searchKey?: string;
    searchOptions?: { label: string; value: string }[];
    extraActions?: (item: any) => React.ReactNode;
    singularName?: string;
}

const simpleNameColumns: ColumnDef<any>[] = [
    {
        accessorKey: "name",
        header: "Nombre",
        cell: ({ row }) => <div className="truncate">{row.getValue("name")}</div>
    },
];

const simpleNameFields: CatalogField[] = [
    {
        name: "name",
        label: "Nombre",
        type: "text",
        required: true,
    },
];

const configs: Record<string, CatalogConfig> = {
    departments: {
        title: "Departamentos",
        singularName: "Departamento",
        apiUrl: "/api/organization/departments/",
        fields: [
            { name: "name", label: "Nombre", type: "text", required: true },
            {
                name: "parent",
                label: "Departamento Padre",
                type: "select",
                required: false,
                optionsUrl: "/api/organization/departments/",
                optionLabelKey: "name",
                optionValueKey: "id"
            },
        ],
        columns: [
            { accessorKey: "name", header: "Nombre", cell: ({ row }) => <div className="truncate">{row.getValue("name")}</div> },
            { accessorKey: "parent.name", header: "Padre", cell: ({ row }) => <div className="truncate">{row.original.parent?.name || "-"}</div> },
        ],
        searchKey: "name",
        searchOptions: [
            { label: "Nombre", value: "name" }
        ]
    },
    "job-titles": {
        title: "Títulos de Cargo",
        singularName: "Título de Cargo",
        apiUrl: "/api/organization/job-titles/",
        fields: simpleNameFields,
        columns: simpleNameColumns,
        searchKey: "name",
        searchOptions: [
            { label: "Nombre", value: "name" }
        ]
    },
    positions: {
        title: "Posiciones",
        singularName: "Posición",
        apiUrl: "/api/organization/positions/",
        fields: [
            { name: "job_title", label: "Cargo", type: "select", required: true, optionsUrl: "/api/organization/job-titles/", optionLabelKey: "name", optionValueKey: "id" },
            { name: "department", label: "Departamento", type: "select", required: true, optionsUrl: "/api/organization/departments/", optionLabelKey: "name", optionValueKey: "id" },
            { name: "manager_positions", label: "Jefes Inmediatos", type: "select", required: false, optionsUrl: "/api/organization/positions/?is_manager=true", optionLabelKey: "full_name", optionValueKey: "id" },
            { name: "vacancies", label: "Vacantes", type: "number", required: true },
            { name: "is_manager", label: "Es Gerencial", type: "checkbox", required: false },
        ],
        columns: [
            { accessorKey: "job_title_name", header: "Cargo", cell: ({ row }) => <div className="truncate">{row.original.job_title_name}</div> },
            { accessorKey: "department_name", header: "Departamento", cell: ({ row }) => <div className="truncate">{row.getValue("department_name")}</div> },
            { accessorKey: "active_employees_count", header: "Ocupados", cell: ({ row }) => <div className="text-center">{row.getValue("active_employees_count")}</div> },
            { accessorKey: "vacancies", header: "Vacantes", cell: ({ row }) => <div className="text-center">{row.getValue("vacancies")}</div> },
        ],
        searchKey: "job_title__name",
        searchOptions: [
            { label: "Cargo", value: "job_title__name" },
            { label: "Departamento", value: "department__name" }
        ],
        extraActions: (item) => (
            <DropdownMenuItem asChild>
                <Link href={`/admin/organization/positions/${item.id}`} className="cursor-pointer w-full flex items-center">
                    <Eye className="mr-2 h-4 w-4" />
                    Ver Detalle
                </Link>
            </DropdownMenuItem>
        )
    },
    "person-department-roles": {
        title: "Roles Jerárquicos",
        singularName: "Rol Jerárquico",
        apiUrl: "/api/employment/person-department-roles/",
        fields: [
            {
                name: "person",
                label: "Persona",
                type: "select",
                required: true,
                optionsUrl: "/api/core/persons/",
                optionLabelKey: "full_name",
                optionValueKey: "id"
            },
            {
                name: "department",
                label: "Departamento",
                type: "select",
                required: true,
                optionsUrl: "/api/organization/departments/",
                optionLabelKey: "name",
                optionValueKey: "id"
            },
            {
                name: "hierarchical_role",
                label: "Rol Jerárquico",
                type: "select",
                required: true,
                options: [
                    { label: "Gerente", value: "MGR" },
                    { label: "Empleado", value: "EMP" }
                ]
            },
            {
                name: "start_date",
                label: "Fecha de Inicio",
                type: "date",
                required: true
            },
            {
                name: "end_date",
                label: "Fecha de Fin",
                type: "date",
                required: false
            },
            {
                name: "notes",
                label: "Notas",
                type: "textarea",
                required: false
            }
        ],
        columns: [
            { accessorKey: "person_name", header: "Persona", cell: ({ row }) => <div className="truncate">{row.original.person_name}</div> },
            { accessorKey: "department_name", header: "Departamento", cell: ({ row }) => <div className="truncate">{row.original.department_name}</div> },
            { accessorKey: "hierarchical_role_display", header: "Rol", cell: ({ row }) => <div className="truncate">{row.original.hierarchical_role_display}</div> },
            { accessorKey: "start_date", header: "Inicio", cell: ({ row }) => <div className="truncate">{row.getValue("start_date")}</div> },
            { accessorKey: "is_current", header: "Vigente", cell: ({ row }) => <div className="truncate">{row.original.is_current ? "Sí" : "No"}</div> },
        ],
        searchKey: "person_name",
        searchOptions: [
            { label: "Persona", value: "person__first_name" }, // Assuming person has first_name, or use full_name if supported
            { label: "Departamento", value: "department__name" }
        ]
    },
};

export default function OrganizationDynamicCatalogPage({ params }: { params: Promise<{ slug: string }> }) {
    const { slug } = use(params);
    const config = configs[slug];

    if (!config) {
        notFound();
    }

    return (
        <div className="h-full flex-1 flex-col space-y-8 p-8 md:flex">
            <CatalogCRUD
                title={config.title}
                apiUrl={config.apiUrl}
                fields={config.fields}
                columns={config.columns}
                searchKey={config.searchKey}
                searchOptions={config.searchOptions}
                extraActions={config.extraActions}
                singularName={config.singularName}
            />
        </div>
    );
}
</file>

<file path="frontend2/app/(main)/admin/personnel/employees/[id]/page.tsx">
"use client";

import { useState, use, useEffect } from "react";
import useSWR, { mutate } from "swr";
import { useRouter, usePathname } from "next/navigation";
import Link from "next/link";
import { ArrowLeft, User, Contact, FileText, Users, Mail, Phone, MapPin, CreditCard, Globe, Pencil, GraduationCap, Link as LinkIcon, Briefcase, Calendar, History, Lock, UserPlus, UserCheck, Ban, UserMinus, AlertTriangle } from "lucide-react";
import { EmploymentForm } from "@/components/personnel/EmploymentForm";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Skeleton } from "@/components/ui/skeleton";
import { Badge } from "@/components/ui/badge";
import apiClient from "@/lib/api-client";
import { useBreadcrumb } from "@/context/breadcrumb-context";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import {
    Dialog,
    DialogContent,
    DialogDescription,
    DialogFooter,
    DialogHeader,
    DialogTitle,
    DialogTrigger,
} from "@/components/ui/dialog";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { toast } from "sonner";
import { DatePicker } from "@/components/ui/date-picker";
import { Switch } from "@/components/ui/switch";
import { Combobox } from "@/components/ui/combobox";

const fetcher = (url: string) => apiClient.get(url).then((res) => res.data);

// Exit reason choices from backend
const EXIT_REASONS = [
    { value: 'REN', label: 'Renuncia Voluntaria' },
    { value: 'DES', label: 'Despido / Cese' },
    { value: 'FIN', label: 'Fin de Contrato (Tiempo Cumplido)' },
    { value: 'JUB', label: 'Jubilación' },
    { value: 'FAL', label: 'Fallecimiento' },
    { value: 'OTR', label: 'Otro Motivo' },
];

export default function EmployeeDetailPage({ params }: { params: Promise<{ id: string }> }) {
    const { id } = use(params);
    const router = useRouter();
    const pathname = usePathname();
    const { setLabel } = useBreadcrumb();
    const [isEditing, setIsEditing] = useState(false);
    const { data: employment, error, isLoading } = useSWR(`/api/employment/employments/${id}/`, fetcher);

    useEffect(() => {
        if (employment) {
            const normalizedPath = pathname.endsWith('/') ? pathname.slice(0, -1) : pathname;
            setLabel(normalizedPath, employment.person_full_name);
        }
    }, [employment, pathname, setLabel]);

    if (isLoading) return <EmployeeDetailSkeleton />;
    if (error || !employment) return <EmployeeError router={router} />;

    const getStatusVariant = (status: string) => {
        if (status === "ACT") return "default";
        if (status === "TER") return "destructive";
        return "secondary";
    };

    return (
        <div className="flex flex-col h-full space-y-6 p-8">
            {/* Header */}
            <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 border-b pb-6">
                <div className="flex flex-col sm:flex-row items-center gap-4">
                    <Avatar className="h-16 w-16 border-2 border-primary/10">
                        {employment.person_photo && (
                            <AvatarImage src={employment.person_photo} alt={employment.person_full_name} />
                        )}
                        <AvatarFallback className="text-xl">
                            {employment.person_full_name.split(' ').map((n: string) => n[0]).join('').substring(0, 2)}
                        </AvatarFallback>
                    </Avatar>
                    <div className="flex flex-col items-center sm:items-start">
                        <Link href={`/admin/personnel/people/${employment.person}`} className="hover:underline">
                            <h1 className="text-2xl font-bold tracking-tight">{employment.person_full_name}</h1>
                        </Link>
                        <div className="flex items-center text-muted-foreground mt-1 gap-2">
                            <Badge variant={getStatusVariant(employment.current_status) as any}>
                                {employment.current_status_display.charAt(0).toUpperCase() + employment.current_status_display.slice(1).toLowerCase()}
                            </Badge>
                            <span className="text-sm">• {employment.role_display}</span>
                        </div>
                    </div>
                </div>
                <div className="flex gap-2 justify-center">
                    {!isEditing && (
                        <Button onClick={() => setIsEditing(true)}>
                            <Pencil className="mr-2 size-4" />
                            Editar
                        </Button>
                    )}
                    <Button variant="outline" onClick={() => isEditing ? setIsEditing(false) : router.back()}>
                        <ArrowLeft className="size-4" />
                        {isEditing ? "Cancelar" : null}
                    </Button>
                </div>
            </div>

            {isEditing ? (
                <EmploymentForm
                    initialData={{
                        ...employment,
                        department: employment.department_id // Pass department ID for pre-filling
                    }}
                    isEditing={true}
                    employmentId={id}
                    onSuccess={() => {
                        setIsEditing(false);
                        mutate(`/api/employment/employments/${id}/`);
                    }}
                />
            ) : (
                /* Content - Single View (No Tabs) */
                <div className="grid gap-6 md:grid-cols-2">

                    {/* Row 1: User Account (Spans 2 columns) */}
                    <Card className="md:col-span-2">
                        <CardHeader>
                            <div className="flex items-center gap-2">
                                <Lock className="h-5 w-5 text-primary" />
                                <CardTitle className="text-lg">Acceso al Sistema</CardTitle>
                            </div>
                            <CardDescription>Gestión de credenciales.</CardDescription>
                        </CardHeader>
                        <CardContent className="space-y-4">
                            {employment.user_account_details ? (
                                <div className="flex flex-col gap-4">
                                    <div className="flex items-center justify-between p-3 border rounded-lg bg-muted/20">
                                        <div>
                                            <p className="text-xs font-bold text-muted-foreground uppercase tracking-wider">Usuario</p>
                                            <p className="text-lg font-bold">{employment.user_account_details.username}</p>
                                        </div>
                                        {employment.user_account_details.is_active ? (
                                            <Badge variant="outline" className="text-green-600 border-green-200 bg-green-50 gap-1">
                                                <UserCheck className="h-3 w-3" />
                                                Activo
                                            </Badge>
                                        ) : (
                                            <Badge variant="outline" className="text-red-600 border-red-200 bg-red-50 gap-1">
                                                <Ban className="h-3 w-3" />
                                                Inactivo
                                            </Badge>
                                        )}
                                    </div>
                                    <div className="flex flex-col gap-2">
                                        <ResetPasswordDialog
                                            personId={employment.person}
                                            username={employment.user_account_details.username}
                                            trigger={
                                                <Button variant="outline" className="w-full">
                                                    <Pencil className="mr-2 h-4 w-4" />
                                                    Administrar Cuenta
                                                </Button>
                                            }
                                        />
                                        {employment.user_account_details.is_active ? (
                                            <DeactivateUserDialog
                                                personId={employment.person}
                                                username={employment.user_account_details.username}
                                                onSuccess={() => mutate(`/api/employment/employments/${id}/`)}
                                                trigger={
                                                    <Button variant="destructive" className="w-full">
                                                        <Ban className="mr-2 h-4 w-4" />
                                                        Desactivar Cuenta
                                                    </Button>
                                                }
                                            />
                                        ) : (
                                            <ActivateUserDialog
                                                personId={employment.person}
                                                username={employment.user_account_details.username}
                                                onSuccess={() => mutate(`/api/employment/employments/${id}/`)}
                                                trigger={
                                                    <Button className="w-full bg-green-600 hover:bg-green-700">
                                                        <UserCheck className="mr-2 h-4 w-4" />
                                                        Activar Cuenta
                                                    </Button>
                                                }
                                            />
                                        )}
                                    </div>
                                </div>
                            ) : (
                                <div className="flex flex-col gap-4">
                                    <div className="p-4 border border-dashed rounded-lg text-center text-muted-foreground text-sm">
                                        Este empleado no tiene acceso al sistema.
                                    </div>
                                    <CreateUserDialog
                                        personId={employment.person}
                                        onSuccess={() => mutate(`/api/employment/employments/${id}/`)}
                                        trigger={
                                            <Button className="w-full">
                                                <UserPlus className="mr-2 h-4 w-4" />
                                                Crear Cuenta
                                            </Button>
                                        }
                                    />
                                </div>
                            )}
                        </CardContent>
                    </Card>

                    {/* Row 2, Col 1: Position Info */}
                    <Card>
                        <CardHeader>
                            <CardTitle className="text-lg flex items-center gap-2">
                                <Briefcase className="h-5 w-5 text-primary" />
                                Información del Cargo
                            </CardTitle>
                        </CardHeader>
                        <CardContent className="space-y-4">
                            <InfoRow label="Cargo" value={employment.position_full_name} />
                            <InfoRow label="Departamento" value={employment.department_name} />
                            <InfoRow label="Tipo de Empleo" value={employment.employment_type_display} />

                            {employment.supervisor_info ? (
                                <div className="pt-2 mt-2">
                                    <p className="text-sm font-medium text-muted-foreground mb-1">Supervisor Inmediato</p>
                                    <div className="flex items-center gap-2">
                                        <UserCheck className="h-4 w-4 text-muted-foreground" />

                                        <span className="text-sm font-medium">{employment.supervisor_info.name.charAt(0).toUpperCase() + employment.supervisor_info.name.slice(1).toLowerCase()}</span>
                                        <span className="text-xs text-muted-foreground">({employment.supervisor_info.position})</span>
                                    </div>
                                </div>
                            ) : (
                                <InfoRow label="Supervisor" value="No asignado" />
                            )}
                        </CardContent>
                    </Card>

                    {/* Row 2-3, Col 2: Status History (Spans 2 rows) */}
                    <Card className="md:row-span-2 h-full">
                        <CardHeader>
                            <CardTitle className="text-lg flex items-center gap-2">
                                <History className="h-5 w-5 text-primary" />
                                Historial de Estatus
                            </CardTitle>
                        </CardHeader>
                        <CardContent>
                            <div className="relative border-l border-muted ml-2 space-y-6">
                                {employment.status_logs && employment.status_logs.length > 0 ? (
                                    employment.status_logs.map((log: any, index: number) => (
                                        <div key={log.id} className="ml-4 relative">
                                            <div className={`absolute -left-[21px] top-1 h-3 w-3 rounded-full border-2 border-background ${index === 0 ? 'bg-primary' : 'bg-muted-foreground'}`} />
                                            <div className="flex flex-col">
                                                <span className="font-medium text-sm">{log.status_name}</span>
                                                <span className="text-xs text-muted-foreground">{log.start_date} {log.end_date ? ` - ${log.end_date}` : '(Actual)'}</span>
                                                {log.comments && <p className="text-xs text-muted-foreground mt-1 italic">"{log.comments}"</p>}
                                            </div>
                                        </div>
                                    ))
                                ) : (
                                    <p className="text-sm text-muted-foreground ml-4">No hay historial disponible.</p>
                                )}
                            </div>
                        </CardContent>
                    </Card>

                    {/* Row 3, Col 1: Contract Dates */}
                    <Card>
                        <CardHeader>
                            <CardTitle className="text-lg flex items-center gap-2">
                                <Calendar className="h-5 w-5 text-primary" />
                                Fechas del Contrato
                            </CardTitle>
                        </CardHeader>
                        <CardContent className="space-y-4">
                            <InfoRow label="Fecha de Contratación" value={employment.hire_date} />
                            <InfoRow label="Fecha de Finalización" value={employment.end_date || "Indefinido"} />

                            {!employment.end_date && (
                                <TerminateContractDialog
                                    employmentId={id}
                                    onSuccess={() => mutate(`/api/employment/employments/${id}/`)}
                                    trigger={
                                        <Button variant="destructive" className="w-full mt-2">
                                            <UserMinus className="mr-2 h-4 w-4" />
                                            Finalizar Contrato
                                        </Button>
                                    }
                                />
                            )}
                        </CardContent>
                    </Card>
                </div>
            )}
        </div>
    );
}


function InfoRow({ label, value }: { label: string, value: string | null | undefined }) {
    return (
        <div className="flex justify-between border-b pb-2 last:border-0 last:pb-0">
            <span className="text-sm font-medium text-muted-foreground">{label}</span>
            <span className="text-sm font-medium text-right">{value || "-"}</span>
        </div>
    );
}

function EmployeeDetailSkeleton() {
    return (
        <div className="space-y-6 p-6">
            <div className="flex items-center gap-4">
                <Skeleton className="h-16 w-16 rounded-full" />
                <div className="space-y-2">
                    <Skeleton className="h-8 w-64" />
                    <Skeleton className="h-4 w-48" />
                </div>
            </div>
            <div className="grid gap-6 md:grid-cols-2">
                <Skeleton className="h-[300px] w-full" />
                <Skeleton className="h-[300px] w-full" />
            </div>
        </div>
    );
}


function EmployeeError({ router }: { router: any }) {
    return (
        <div className="flex flex-col items-center justify-center h-full p-8 text-center">
            <h2 className="text-2xl font-bold text-destructive mb-2">Error</h2>
            <p className="text-muted-foreground mb-4">No se pudo cargar la información del empleado.</p>
            <Button onClick={() => router.back()}>Volver</Button>
        </div>
    );
}

function CreateUserDialog({ personId, onSuccess, trigger }: { personId: number, onSuccess: (username: string) => void, trigger: React.ReactNode }) {
    const [open, setOpen] = useState(false);
    const [isLoading, setIsLoading] = useState(false);

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        setIsLoading(true);
        try {
            const res = await apiClient.post(`/api/core/persons/${personId}/create-user-account/`, {});
            toast.success(`Usuario creado: ${res.data.username}`);
            onSuccess(res.data.username);
            setOpen(false);
        } catch (error: any) {
            toast.error(error.response?.data?.error || "Error al crear usuario");
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <Dialog open={open} onOpenChange={setOpen}>
            <DialogTrigger asChild>
                {trigger}
            </DialogTrigger>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle>Crear Cuenta de Usuario</DialogTitle>
                    <DialogDescription asChild>
                        <div className="space-y-3 pt-2">
                            <div>Se creará una cuenta de usuario para 1 empleado activo que actualmente no tiene cuenta.</div>

                            <div className="bg-muted/50 p-3 rounded-md space-y-2 text-sm">
                                <div><strong>Usuario:</strong> Se generará automáticamente basado en el nombre y cédula</div>
                                <div><strong>Contraseña inicial:</strong> Número de cédula (el empleado podrá cambiarla después)</div>
                            </div>

                            <div className="text-xs text-muted-foreground">
                                Esta acción no se puede deshacer, pero la cuenta puede ser desactivada posteriormente.
                            </div>
                        </div>
                    </DialogDescription>
                </DialogHeader>
                <form onSubmit={handleSubmit}>
                    <DialogFooter>
                        <Button variant="outline" type="button" onClick={() => setOpen(false)}>
                            Cancelar
                        </Button>
                        <Button type="submit" disabled={isLoading}>
                            {isLoading ? "Creando..." : "Crear Cuenta"}
                        </Button>
                    </DialogFooter>
                </form>
            </DialogContent>
        </Dialog>
    );
}

function ResetPasswordDialog({ personId, username, trigger }: { personId: number, username: string, trigger: React.ReactNode }) {
    const [open, setOpen] = useState(false);
    const [password, setPassword] = useState("");
    const [confirmPassword, setConfirmPassword] = useState("");
    const [isLoading, setIsLoading] = useState(false);

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();

        if (password !== confirmPassword) {
            toast.error("Las contraseñas no coinciden");
            return;
        }

        setIsLoading(true);
        try {
            await apiClient.post(`/api/core/persons/${personId}/reset-password/`, { password });
            toast.success("Contraseña actualizada exitosamente");
            setOpen(false);
            setPassword("");
            setConfirmPassword("");
        } catch (error: any) {
            toast.error(error.response?.data?.error || "Error al actualizar contraseña");
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <Dialog open={open} onOpenChange={setOpen}>
            <DialogTrigger asChild>
                {trigger}
            </DialogTrigger>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle>Cambiar Contraseña</DialogTitle>
                    <DialogDescription>
                        Ingrese una nueva contraseña para el usuario <strong>{username}</strong>.
                    </DialogDescription>
                </DialogHeader>
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div className="space-y-2">
                        <Label htmlFor="new-password">Nueva Contraseña</Label>
                        <Input
                            id="new-password"
                            type="password"
                            value={password}
                            onChange={(e) => setPassword(e.target.value)}
                            required
                        />
                    </div>
                    <div className="space-y-2">
                        <Label htmlFor="confirm-password">Confirmar Contraseña</Label>
                        <Input
                            id="confirm-password"
                            type="password"
                            value={confirmPassword}
                            onChange={(e) => setConfirmPassword(e.target.value)}
                            required
                        />
                    </div>
                    <DialogFooter>
                        <Button type="submit" disabled={isLoading}>
                            {isLoading ? "Actualizando..." : "Actualizar"}
                        </Button>
                    </DialogFooter>
                </form>
            </DialogContent>
        </Dialog>
    );
}

function DeactivateUserDialog({ personId, username, onSuccess, trigger }: { personId: number, username: string, onSuccess: () => void, trigger: React.ReactNode }) {
    const [open, setOpen] = useState(false);
    const [isLoading, setIsLoading] = useState(false);

    const handleDeactivate = async () => {
        setIsLoading(true);
        try {
            await apiClient.post(`/api/core/persons/${personId}/deactivate-user/`);
            toast.success(`Usuario ${username} desactivado.`);
            onSuccess();
            setOpen(false);
        } catch (error: any) {
            toast.error(error.response?.data?.error || "Error al desactivar usuario");
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <Dialog open={open} onOpenChange={setOpen}>
            <DialogTrigger asChild>
                {trigger}
            </DialogTrigger>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle className="flex items-center gap-2 text-destructive">
                        <AlertTriangle className="h-5 w-5" />
                        Desactivar Usuario
                    </DialogTitle>
                    <DialogDescription>
                        ¿Está seguro que desea desactivar el usuario <strong>{username}</strong>?
                        El empleado no podrá acceder al sistema, pero su contrato permanecerá activo.
                    </DialogDescription>
                </DialogHeader>
                <DialogFooter className="gap-2 sm:gap-0">
                    <Button variant="outline" onClick={() => setOpen(false)}>Cancelar</Button>
                    <Button variant="destructive" onClick={handleDeactivate} disabled={isLoading}>
                        {isLoading ? "Desactivando..." : "Desactivar Cuenta"}
                    </Button>
                </DialogFooter>
            </DialogContent>
        </Dialog>
    );
}

function ActivateUserDialog({ personId, username, onSuccess, trigger }: { personId: number, username: string, onSuccess: () => void, trigger: React.ReactNode }) {
    const [open, setOpen] = useState(false);
    const [isLoading, setIsLoading] = useState(false);

    const handleActivate = async () => {
        setIsLoading(true);
        try {
            await apiClient.post(`/api/core/persons/${personId}/activate-user/`);
            toast.success(`Usuario ${username} activado.`);
            onSuccess();
            setOpen(false);
        } catch (error: any) {
            toast.error(error.response?.data?.error || "Error al activar usuario");
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <Dialog open={open} onOpenChange={setOpen}>
            <DialogTrigger asChild>
                {trigger}
            </DialogTrigger>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle className="flex items-center gap-2 text-green-600">
                        <UserCheck className="h-5 w-5" />
                        Activar Usuario
                    </DialogTitle>
                    <DialogDescription>
                        ¿Está seguro que desea activar el usuario <strong>{username}</strong>?
                        El empleado podrá acceder nuevamente al sistema.
                    </DialogDescription>
                </DialogHeader>
                <DialogFooter className="gap-2 sm:gap-0">
                    <Button variant="outline" onClick={() => setOpen(false)}>Cancelar</Button>
                    <Button className="bg-green-600 hover:bg-green-700" onClick={handleActivate} disabled={isLoading}>
                        {isLoading ? "Activando..." : "Activar Cuenta"}
                    </Button>
                </DialogFooter>
            </DialogContent>
        </Dialog>
    );
}

function TerminateContractDialog({ employmentId, onSuccess, trigger }: { employmentId: string, onSuccess: () => void, trigger: React.ReactNode }) {
    const [open, setOpen] = useState(false);
    const [isLoading, setIsLoading] = useState(false);
    const [endDate, setEndDate] = useState<Date | undefined>(undefined);
    const [reason, setReason] = useState<string>("");
    const [notes, setNotes] = useState("");
    const [deactivateUser, setDeactivateUser] = useState(true);

    const handleTerminate = async (e: React.FormEvent) => {
        e.preventDefault();

        if (!endDate || !reason) {
            toast.error("Por favor complete todos los campos requeridos");
            return;
        }

        setIsLoading(true);
        try {
            await apiClient.post(`/api/employment/employments/${employmentId}/terminate/`, {
                end_date: endDate.toISOString().split('T')[0], // Format as YYYY-MM-DD
                exit_reason: reason,
                exit_notes: notes,
                deactivate_user: deactivateUser
            });
            toast.success("Contrato finalizado exitosamente.");
            onSuccess();
            setOpen(false);
        } catch (error: any) {
            toast.error(error.response?.data?.error || "Error al finalizar contrato");
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <Dialog open={open} onOpenChange={setOpen}>
            <DialogTrigger asChild>
                {trigger}
            </DialogTrigger>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle className="flex items-center gap-2 text-destructive">
                        <UserMinus className="h-5 w-5" />
                        Finalizar Contrato
                    </DialogTitle>
                </DialogHeader>
                <form onSubmit={handleTerminate} className="space-y-4">
                    <div className="space-y-2">
                        <Label htmlFor="end-date">Fecha de Finalización</Label>
                        <DatePicker
                            value={endDate}
                            onChange={setEndDate}
                            placeholder="dd/mm/aaaa"
                        />
                    </div>
                    <div className="space-y-2">
                        <Label htmlFor="reason">Motivo de Salida</Label>
                        <Combobox
                            options={EXIT_REASONS}
                            value={reason}
                            onSelect={(val) => setReason(val as string)}
                            placeholder="Seleccione motivo..."
                            emptyText="No se encontraron motivos."
                        />
                    </div>
                    <div className="space-y-2">
                        <Label htmlFor="notes">Notas Adicionales</Label>
                        <Input
                            id="notes"
                            value={notes}
                            onChange={(e) => setNotes(e.target.value)}
                            placeholder="Detalles adicionales..."
                        />
                    </div>
                    <div className="flex items-center justify-between space-x-2 pt-2 border-t">
                        <Label htmlFor="deactivate" className="font-normal flex-1">
                            Desactivar usuario del sistema automáticamente
                        </Label>
                        <Switch
                            id="deactivate"
                            checked={deactivateUser}
                            onCheckedChange={setDeactivateUser}
                        />
                    </div>
                    <DialogFooter>
                        <Button variant="outline" type="button" onClick={() => setOpen(false)}>Cancelar</Button>
                        <Button variant="destructive" type="submit" disabled={isLoading}>
                            {isLoading ? "Procesando..." : "Finalizar Contrato"}
                        </Button>
                    </DialogFooter>
                </form>
            </DialogContent>
        </Dialog>
    );
}
</file>

<file path="frontend2/app/(main)/admin/personnel/employees/page.tsx">
"use client";

import { useState, useEffect } from "react";
import { CatalogCRUD, CatalogField } from "@/components/catalogs/catalog-crud";
import { ColumnDef } from "@tanstack/react-table";
import { DropdownMenuItem } from "@/components/ui/dropdown-menu";
import { Eye, Users, Plus, UserPlus } from "lucide-react";
import Link from "next/link";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { cn } from "@/lib/utils";
import apiClient from "@/lib/api-client";
import { toast } from "sonner";
import {
    AlertDialog,
    AlertDialogAction,
    AlertDialogCancel,
    AlertDialogContent,
    AlertDialogDescription,
    AlertDialogFooter,
    AlertDialogHeader,
    AlertDialogTitle,
} from "@/components/ui/alert-dialog";

export default function EmployeesPage() {
    const [hasPendingAccounts, setHasPendingAccounts] = useState(false);
    const [pendingCount, setPendingCount] = useState(0);
    const [isCreating, setIsCreating] = useState(false);
    const [showConfirmDialog, setShowConfirmDialog] = useState(false);
    const [refreshKey, setRefreshKey] = useState(0);

    // Check for pending accounts on mount
    useEffect(() => {
        checkPendingAccounts();
    }, [refreshKey]);

    const checkPendingAccounts = async () => {
        try {
            const response = await apiClient.get("/api/accounts/users/check_pending_accounts/");
            setHasPendingAccounts(response.data.has_pending);
            setPendingCount(response.data.count);
        } catch (error) {
            console.error("Error checking pending accounts:", error);
        }
    };

    const handleBulkCreate = async () => {
        setIsCreating(true);
        try {
            const response = await apiClient.post("/api/accounts/users/bulk_create_employee_accounts/");

            const { created_count, error_count, errors } = response.data;

            if (created_count > 0) {
                toast.success(`${created_count} cuenta(s) creada(s) exitosamente`);
            }

            if (error_count > 0) {
                toast.warning(`${error_count} error(es) al crear cuentas`, {
                    description: errors.slice(0, 3).map((e: any) =>
                        `${e.person_name}: ${e.error}`
                    ).join("\n")
                });
            }

            // Refresh the check
            setRefreshKey(prev => prev + 1);
            setShowConfirmDialog(false);
        } catch (error: any) {
            console.error("Error creating accounts:", error);
            toast.error("Error al crear cuentas", {
                description: error.response?.data?.detail || "Ocurrió un error inesperado"
            });
        } finally {
            setIsCreating(false);
        }
    };

    const fields: CatalogField[] = [
        {
            name: "person",
            label: "Persona",
            type: "select",
            required: true,
            optionsUrl: "/api/core/persons/",
            optionLabelKey: "full_name",
            optionValueKey: "id"
        },
        {
            name: "position",
            label: "Posición",
            type: "select",
            required: true,
            optionsUrl: "/api/organization/positions/",
            optionLabelKey: "job_title_name", // Assuming this field exists in Position serializer or adjust
            optionValueKey: "id"
        },
        {
            name: "role",
            label: "Rol",
            type: "select",
            required: true,
            options: [
                { label: "Empleado", value: "EMP" },
                { label: "Contratista", value: "CTR" },
                { label: "Pasante", value: "INT" }
            ]
        },
        {
            name: "employment_type",
            label: "Tipo de Empleo",
            type: "select",
            required: true,
            options: [
                { label: "Permanente", value: "PER" },
                { label: "Temporal", value: "TMP" },
                { label: "Medio Tiempo", value: "PRT" }
            ]
        },
        {
            name: "current_status",
            label: "Estatus",
            type: "select",
            required: true,
            options: [
                { label: "Activo", value: "ACT" },
                { label: "Permiso", value: "LEA" },
                { label: "Suspendido", value: "SUS" },
                { label: "Terminado", value: "TER" }
            ]
        },
        { name: "hire_date", label: "Fecha de Contratación", type: "date", required: true },
        { name: "end_date", label: "Fecha de Finalización", type: "date", required: false },
    ];

    const columns: ColumnDef<any>[] = [
        {
            accessorKey: "person_full_name",
            header: "Empleado",
            cell: ({ row }) => <div className="font-medium">{row.getValue("person_full_name")}</div>
        },
        {
            accessorKey: "person_document",
            header: "Cédula",
            cell: ({ row }) => <div className="truncate">{row.getValue("person_document")}</div>
        },
        {
            accessorKey: "position_full_name",
            header: "Cargo",
            cell: ({ row }) => <div className="truncate max-w-[200px]">{row.getValue("position_full_name")}</div>
        },
        {
            accessorKey: "department_name",
            header: "Departamento",
            cell: ({ row }) => <div className="truncate max-w-[150px]">{row.getValue("department_name")}</div>
        },
        {
            accessorKey: "current_status_display",
            header: "Estatus",
            cell: ({ row }) => {
                const status = row.original.current_status;
                const label = row.getValue("current_status_display") as string;

                let variant = "secondary";
                if (status === "ACT") variant = "default"; // Reverted to default (primary) as requested
                if (status === "TER") variant = "destructive";
                if (status === "LEA" || status === "SUS") variant = "outline";

                return <Badge variant={variant as any}>{label}</Badge>;
            }
        },
        {
            accessorKey: "hire_date",
            header: "Fecha Ingreso",
            cell: ({ row }) => <div className="truncate">{row.getValue("hire_date")}</div>
        },
    ];

    return (
        <div className="h-full flex-1 flex-col space-y-8 p-8 md:flex">
            <CatalogCRUD
                title="Empleados"
                icon={Users}
                apiUrl="/api/employment/employments/"
                fields={fields}
                columns={columns}
                searchKey="person_name" // Backend filter might need adjustment if it doesn't support this directly
                searchOptions={[
                    { label: "Nombre", value: "person__first_name" }, // Adjust based on backend filter
                    { label: "Cargo", value: "position__job_title__name" }
                ]}
                disableCreate={true}
                disableEdit={true}
                customToolbarActions={
                    <div className="flex flex-col sm:flex-row w-full gap-2">
                        {hasPendingAccounts && (
                            <Button
                                variant="secondary"
                                onClick={() => setShowConfirmDialog(true)}
                                disabled={isCreating}
                            >
                                <UserPlus className="mr-2 h-4 w-4" />
                                Crear Cuentas ({pendingCount})
                            </Button>
                        )}
                        <Button asChild variant="outline">
                            <Link href="/admin/personnel/employees/new">
                                <Plus className="h-4 w-4" />
                                Nuevo Empleado
                            </Link>
                        </Button>
                    </div>
                }
                extraActions={(item) => (
                    <DropdownMenuItem asChild>
                        <Link href={`/admin/personnel/employees/${item.id}`} className="cursor-pointer w-full flex items-center">
                            <Eye className="mr-2 h-4 w-4" />
                            Ver Detalle
                        </Link>
                    </DropdownMenuItem>
                )}
            />

            <AlertDialog open={showConfirmDialog} onOpenChange={setShowConfirmDialog}>
                <AlertDialogContent>
                    <AlertDialogHeader>
                        <AlertDialogTitle>Crear Cuentas de Empleados</AlertDialogTitle>
                        <AlertDialogDescription asChild>
                            <div className="space-y-2">
                                <p>Se crearán cuentas de usuario para <strong>{pendingCount}</strong> empleado(s) activo(s) que actualmente no tienen cuenta.</p>
                                <p className="text-sm"><strong>Usuario:</strong> Se generará automáticamente basado en el nombre y cédula</p>
                                <p className="text-sm"><strong>Contraseña inicial:</strong> Número de cédula (los empleados podrán cambiarla después)</p>
                                <p className="text-sm text-muted-foreground mt-2">Esta acción no se puede deshacer, pero las cuentas pueden ser desactivadas posteriormente.</p>
                            </div>
                        </AlertDialogDescription>
                    </AlertDialogHeader>
                    <AlertDialogFooter>
                        <AlertDialogCancel disabled={isCreating}>Cancelar</AlertDialogCancel>
                        <AlertDialogAction onClick={handleBulkCreate} disabled={isCreating}>
                            {isCreating ? "Creando..." : "Confirmar"}
                        </AlertDialogAction>
                    </AlertDialogFooter>
                </AlertDialogContent>
            </AlertDialog>
        </div>
    );
}
</file>

<file path="frontend2/components/personnel/EmploymentForm.tsx">
"use client";

import { useState } from "react";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import * as z from "zod";
import { format } from "date-fns";
import { useRouter } from "next/navigation";
import { toast } from "sonner";
import useSWR from "swr";
import apiClient from "@/lib/api-client";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Combobox } from "@/components/ui/combobox";
import { DatePicker } from "@/components/ui/date-picker";
import { parseBackendDate } from "@/lib/utils";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { Switch } from "@/components/ui/switch";
import { User, FileText, Mail } from "lucide-react";

const fetcher = (url: string) => apiClient.get(url).then(res => res.data.results || res.data);

const employmentSchema = z.object({
    person: z.string().min(1, "La persona es requerida"),
    position: z.string().min(1, "La posición es requerida"),
    role: z.string().min(1, "El rol es requerido"),
    employment_type: z.string().min(1, "El tipo de empleo es requerido"),
    current_status: z.string().min(1, "El estatus es requerido"),
    hire_date: z.string().min(1, "La fecha de contratación es requerida"),
    end_date: z.string().optional().nullable(),
    phone_carrier_code: z.string().optional(),
    phone_subscriber_number: z.string().optional(),
}).superRefine((data, ctx) => {
    if (data.employment_type !== "FIJ" && !data.end_date) {
        ctx.addIssue({
            code: z.ZodIssueCode.custom,
            message: "La fecha de finalización es requerida para este tipo de empleo",
            path: ["end_date"],
        });
    }
    // Validate phone: if subscriber number is provided, carrier code is required
    if (data.phone_subscriber_number && !data.phone_carrier_code) {
        ctx.addIssue({
            code: z.ZodIssueCode.custom,
            message: "Debe seleccionar una operadora",
            path: ["phone_carrier_code"],
        });
    }
});

export type EmploymentFormData = z.infer<typeof employmentSchema>;

interface EmploymentFormProps {
    initialData?: any;
    isEditing?: boolean;
    employmentId?: string;
    onSuccess?: () => void;
}

export function EmploymentForm({ initialData, isEditing = false, employmentId, onSuccess }: EmploymentFormProps) {
    const router = useRouter();
    const [isSubmitting, setIsSubmitting] = useState(false);
    const [includePhone, setIncludePhone] = useState(false);

    const { data: persons } = useSWR("/api/core/persons/?page_size=1000", fetcher);
    const { data: departments } = useSWR("/api/organization/departments/?page_size=1000", fetcher);
    const { data: phoneCarrierCodes } = useSWR("/api/core/phone-carrier-codes/?page_size=1000", fetcher);

    const [selectedDepartment, setSelectedDepartment] = useState<string>(initialData?.department?.toString() || "");

    const { data: positions } = useSWR(
        selectedDepartment
            ? `/api/organization/positions/?department=${selectedDepartment}&page_size=1000`
            : null,
        fetcher
    );

    // Prepare default values
    const defaultValues = {
        person: initialData?.person?.toString() || "",
        position: initialData?.position?.toString() || "",
        role: initialData?.role || "EMP",
        employment_type: initialData?.employment_type || "FIJ",
        current_status: initialData?.current_status || "ACT",
        hire_date: initialData?.hire_date || "",
        end_date: initialData?.end_date || null,
        phone_carrier_code: "",
        phone_subscriber_number: "",
    };

    const { handleSubmit, formState: { errors }, setValue, watch, setError } = useForm<EmploymentFormData>({
        resolver: zodResolver(employmentSchema),
        defaultValues
    });

    const selectedPersonId = watch("person");

    // Fetch full person details when selected
    const { data: fullPerson } = useSWR(
        selectedPersonId ? `/api/core/persons/${selectedPersonId}/` : null,
        fetcher
    );

    // Use fullPerson for display if available, otherwise fallback to list item (though list item might be incomplete)
    const selectedPerson = fullPerson || persons?.find((p: any) => p.id.toString() === selectedPersonId);

    const onSubmit = async (data: EmploymentFormData) => {
        setIsSubmitting(true);
        try {
            if (isEditing && employmentId) {
                await apiClient.patch(`/api/employment/employments/${employmentId}/`, data);
                toast.success("Empleado actualizado exitosamente");
            } else {
                // Validate phone BEFORE creating employment if phone toggle is enabled
                if (includePhone && data.phone_carrier_code && data.phone_subscriber_number) {
                    // Check if person already has a primary phone
                    const existingPhones = await apiClient.get(`/api/core/person-phones/?person=${data.person}&is_primary=true`);
                    const hasPrimaryPhone = existingPhones.data.results?.length > 0 || existingPhones.data.length > 0;

                    // Validate phone creation first (will throw error if invalid)
                    await apiClient.post("/api/core/person-phones/", {
                        person: data.person,
                        phone_type: 1,
                        carrier_code: data.phone_carrier_code,
                        subscriber_number: data.phone_subscriber_number,
                        is_primary: !hasPrimaryPhone,
                    });
                }

                // Only create employment if phone validation passed (or no phone)
                await apiClient.post("/api/employment/employments/", data);
                toast.success("Empleado creado exitosamente");
                router.push("/admin/personnel/employees");
            }

            if (onSuccess) onSuccess();

        } catch (error: any) {
            console.error("Error submitting form:", error);
            if (error.response?.data) {
                const serverErrors = error.response.data;

                // Handle phone-specific errors
                if (serverErrors.carrier_code) {
                    setError("phone_carrier_code", {
                        type: "server",
                        message: Array.isArray(serverErrors.carrier_code)
                            ? serverErrors.carrier_code[0]
                            : serverErrors.carrier_code
                    });
                }
                if (serverErrors.subscriber_number) {
                    setError("phone_subscriber_number", {
                        type: "server",
                        message: Array.isArray(serverErrors.subscriber_number)
                            ? serverErrors.subscriber_number[0]
                            : serverErrors.subscriber_number
                    });
                }

                // Handle other field errors
                Object.keys(serverErrors).forEach((key) => {
                    if (key in defaultValues) {
                        setError(key as keyof EmploymentFormData, {
                            type: "server",
                            message: serverErrors[key][0] || serverErrors[key]
                        });
                    } else if (key !== 'carrier_code' && key !== 'subscriber_number') {
                        // Only show toast for non-field errors (not already handled above)
                        toast.error(`Error: ${serverErrors[key]}`);
                    }
                });
            } else {
                toast.error("Ocurrió un error al guardar el empleado");
            }
        } finally {
            setIsSubmitting(false);
        }
    };

    return (
        <form onSubmit={handleSubmit(onSubmit)}>
            <Card>
                <CardHeader>
                    <CardTitle>{isEditing ? "Editar Empleado" : "Nuevo Empleado"}</CardTitle>
                    <CardDescription>{isEditing ? "Actualiza los datos del empleado" : "Registra un nuevo empleado"}</CardDescription>
                </CardHeader>
                <CardContent>
                    <div className="grid gap-4 md:grid-cols-2">

                        <div className="space-y-2 md:col-span-2">
                            <Label htmlFor="person" className={errors.person ? "text-destructive" : ""}>Persona *</Label>
                            <Combobox
                                options={persons?.map((p: any) => ({ value: p.id.toString(), label: p.hiring_search || p.full_name })) || []}
                                value={watch("person")}
                                onSelect={(value) => setValue("person", value.toString())}
                                placeholder="Buscar por nombre o cédula..."
                                className={errors.person ? "border-destructive" : ""}
                                disabled={isEditing} // Usually person shouldn't change on edit
                            />
                            {errors.person && (
                                <p className="text-sm text-destructive">{errors.person.message}</p>
                            )}
                        </div>

                        {selectedPerson && (
                            <div className="md:col-span-2 mb-4">
                                <Card>
                                    <CardHeader><CardTitle className="text-lg">Información Personal</CardTitle></CardHeader>
                                    <CardContent>
                                        <div className="grid gap-4 md:grid-cols-2">
                                            <InfoRow label="Primer Nombre" value={selectedPerson.first_name} />
                                            <InfoRow label="Segundo Nombre" value={selectedPerson.second_name} />
                                            <InfoRow label="Apellido Paterno" value={selectedPerson.paternal_surname} />
                                            <InfoRow label="Apellido Materno" value={selectedPerson.maternal_surname} />
                                            <InfoRow label="Fecha de Nacimiento" value={selectedPerson.birthdate} />
                                            <InfoRow label="País de Nacimiento" value={selectedPerson.country_of_birth_name} />
                                            <InfoRow label="Género" value={selectedPerson.gender_name} />
                                            <InfoRow label="Estado Civil" value={selectedPerson.marital_status_name} />
                                        </div>
                                    </CardContent>
                                </Card>
                            </div>
                        )}

                        <div className="space-y-2">
                            <Label>Departamento</Label>
                            <Combobox
                                options={departments?.map((d: any) => ({ value: d.id.toString(), label: d.name })) || []}
                                value={selectedDepartment}
                                onSelect={(value) => {
                                    setSelectedDepartment(value.toString());
                                    setValue("position", ""); // Reset position when department changes
                                }}
                                placeholder="Filtrar por departamento..."
                            />
                        </div>

                        <div className="space-y-2">
                            <Label htmlFor="position" className={errors.position ? "text-destructive" : ""}>Posición *</Label>
                            <Combobox
                                options={positions?.map((p: any) => ({ value: p.id.toString(), label: p.job_title_name || `Posición ${p.id}` })) || []}
                                value={watch("position")}
                                onSelect={(value) => setValue("position", value.toString())}
                                placeholder="Seleccionar posición"
                                className={errors.position ? "border-destructive" : ""}
                            />
                            {errors.position && (
                                <p className="text-sm text-destructive">{errors.position.message}</p>
                            )}
                        </div>

                        <div className="space-y-2">
                            <Label htmlFor="role" className={errors.role ? "text-destructive" : ""}>Rol *</Label>
                            <Combobox
                                options={[
                                    { value: "EMP", label: "Empleado" },
                                    { value: "MGR", label: "Manager" }
                                ]}
                                value={watch("role")}
                                onSelect={(value) => setValue("role", value.toString())}
                                placeholder="Seleccionar rol"
                                className={errors.role ? "border-destructive" : ""}
                            />
                            {errors.role && (
                                <p className="text-sm text-destructive">{errors.role.message}</p>
                            )}
                        </div>

                        <div className="space-y-2">
                            <Label htmlFor="current_status" className={errors.current_status ? "text-destructive" : ""}>Estatus *</Label>
                            <Combobox
                                options={[
                                    { value: "ACT", label: "Activo" },
                                    { value: "SUS", label: "Suspendido" },
                                    { value: "PER", label: "De Permiso" },
                                    { value: "REP", label: "Reposo" },
                                    { value: "FIN", label: "Finalizado" },
                                    { value: "REN", label: "Renuncia" },
                                    { value: "DES", label: "Despido" },
                                    { value: "ANU", label: "Anulado" }
                                ]}
                                value={watch("current_status")}
                                onSelect={(value) => setValue("current_status", value.toString())}
                                placeholder="Seleccionar estatus"
                                className={errors.current_status ? "border-destructive" : ""}
                            />
                            {errors.current_status && (
                                <p className="text-sm text-destructive">{errors.current_status.message}</p>
                            )}
                        </div>

                        <div className="space-y-2">
                            <Label htmlFor="employment_type" className={errors.employment_type ? "text-destructive" : ""}>Tipo de Empleo *</Label>
                            <Combobox
                                options={[
                                    { value: "FIJ", label: "Fijo" },
                                    { value: "TMP", label: "Temporal" },
                                    { value: "PAS", label: "Pasantía" }
                                ]}
                                value={watch("employment_type")}
                                onSelect={(value) => setValue("employment_type", value.toString())}
                                placeholder="Seleccionar tipo"
                                className={errors.employment_type ? "border-destructive" : ""}
                            />
                            {errors.employment_type && (
                                <p className="text-sm text-destructive">{errors.employment_type.message}</p>
                            )}
                        </div>

                        <div className="space-y-2">
                            <Label>Fecha de Contratación *</Label>
                            <DatePicker
                                value={parseBackendDate(watch("hire_date"))}
                                onChange={(date) => {
                                    setValue("hire_date", date ? format(date, "yyyy-MM-dd") : "");
                                }}
                            />
                            {errors.hire_date && (
                                <p className="text-sm text-destructive">{errors.hire_date.message}</p>
                            )}
                        </div>

                        {watch("employment_type") !== "FIJ" && (
                            <div className="space-y-2">
                                <Label className={errors.end_date ? "text-destructive" : ""}>Fecha de Finalización *</Label>
                                <DatePicker
                                    value={parseBackendDate(watch("end_date") || "")}
                                    onChange={(date) => {
                                        setValue("end_date", date ? format(date, "yyyy-MM-dd") : null);
                                    }}
                                />
                                {errors.end_date && (
                                    <p className="text-sm text-destructive">{errors.end_date.message}</p>
                                )}
                            </div>
                        )}

                        {/* Optional Phone Section - Only for new employees */}
                        {!isEditing && selectedPerson && (
                            <>
                                <div className="md:col-span-2 mt-4 border-t pt-4">
                                    <div className="flex items-center justify-between mb-3">
                                        <h3 className="text-sm font-semibold text-muted-foreground">Información de Contacto (Opcional)</h3>
                                        <div className="flex items-center space-x-2">
                                            <Switch
                                                checked={includePhone}
                                                onCheckedChange={setIncludePhone}
                                                id="include-phone"
                                            />
                                            <Label htmlFor="include-phone" className="text-sm font-normal cursor-pointer">
                                                Agregar teléfono
                                            </Label>
                                        </div>
                                    </div>
                                </div>

                                {includePhone && (
                                    <>
                                        <div className="space-y-2">
                                            <Label htmlFor="phone_carrier_code" className={errors.phone_carrier_code ? "text-destructive" : ""}>
                                                Operadora
                                            </Label>
                                            <Combobox
                                                options={phoneCarrierCodes?.map((cc: any) => ({
                                                    value: cc.id.toString(),
                                                    label: `${cc.code} - ${cc.carrier_name}`
                                                })) || []}
                                                value={watch("phone_carrier_code")}
                                                onSelect={(value) => setValue("phone_carrier_code", value.toString())}
                                                placeholder="Seleccionar operadora"
                                                className={errors.phone_carrier_code ? "border-destructive" : ""}
                                            />
                                            {errors.phone_carrier_code && (
                                                <p className="text-sm text-destructive">{errors.phone_carrier_code.message}</p>
                                            )}
                                        </div>

                                        <div className="space-y-2">
                                            <Label htmlFor="phone_subscriber_number" className={errors.phone_subscriber_number ? "text-destructive" : ""}>
                                                Número de Teléfono
                                            </Label>
                                            <Input
                                                type="text"
                                                placeholder="7 dígitos"
                                                value={watch("phone_subscriber_number")}
                                                onChange={(e) => {
                                                    // Only allow numbers and max 7 digits
                                                    const value = e.target.value.replace(/\D/g, '').slice(0, 7);
                                                    setValue("phone_subscriber_number", value);
                                                }}
                                                className={errors.phone_subscriber_number ? "border-destructive" : ""}
                                                maxLength={7}
                                            />
                                            {errors.phone_subscriber_number && (
                                                <p className="text-sm text-destructive">{errors.phone_subscriber_number.message}</p>
                                            )}
                                        </div>
                                    </>
                                )}
                            </>
                        )}

                    </div>

                    <div className="flex justify-end gap-4 mt-6">
                        <Button type="button" variant="outline" onClick={() => router.back()}>
                            Cancelar
                        </Button>
                        <Button type="submit" disabled={isSubmitting}>
                            {isSubmitting ? "Guardando..." : (isEditing ? "Actualizar" : "Crear Empleado")}
                        </Button>
                    </div>
                </CardContent>
            </Card>
        </form>
    );
}

function InfoRow({ label, value }: { label: string, value: string | null | undefined }) {
    return (
        <div className="flex justify-between border-b pb-2 last:pb-0">
            <span className="text-sm font-medium text-muted-foreground">{label}</span>
            <span className="text-sm text-right">{value || "-"}</span>
        </div>
    );
}
</file>

<file path="frontend2/components/ui/action-menu.tsx">
"use client";

import { Button } from "@/components/ui/button";
import {
    DropdownMenu,
    DropdownMenuContent,
    DropdownMenuItem,
    DropdownMenuLabel,
    DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { MoreHorizontal, Pencil, Trash2 } from "lucide-react";

interface ActionMenuProps {
    onEdit?: () => void;
    onDelete?: () => void;
    editLabel?: string;
    deleteLabel?: string;
}

export function ActionMenu({
    onEdit,
    onDelete,
    editLabel = "Editar",
    deleteLabel = "Eliminar",
    children,
}: ActionMenuProps & { children?: React.ReactNode }) {
    return (
        <DropdownMenu>
            <DropdownMenuTrigger asChild>
                <Button variant="ghost" className="h-8 w-8 p-0">
                    <span className="sr-only">Abrir menú</span>
                    <MoreHorizontal className="h-4 w-4" />
                </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="end">
                <DropdownMenuLabel>Acciones</DropdownMenuLabel>
                {children}
                {onEdit && (
                    <DropdownMenuItem onClick={onEdit}>
                        <Pencil className="mr-2 h-4 w-4" />
                        {editLabel}
                    </DropdownMenuItem>
                )}
                {onDelete && (
                    <DropdownMenuItem onClick={onDelete} className="text-red-600 focus:text-red-600">
                        <Trash2 className="mr-2 h-4 w-4" />
                        {deleteLabel}
                    </DropdownMenuItem>
                )}
            </DropdownMenuContent>
        </DropdownMenu>
    );
}
</file>

<file path="frontend2/next.config.ts">
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  trailingSlash: true,
  images: {
    remotePatterns: [
      {
        protocol: 'http',
        hostname: '127.0.0.1',
        port: '8000',
      },
      {
        protocol: 'http',
        hostname: 'localhost',
        port: '8000',
      },
    ],
    // Disable optimization for development (allows private IPs)
    unoptimized: process.env.NODE_ENV === 'development',
  },
  async rewrites() {
    return [
      {
        source: "/api/:path*",
        destination: "http://127.0.0.1:8000/api/:path*",
      },
    ];
  },
};

export default nextConfig;
</file>

<file path="backend/core/admin.py">
from django.contrib import admin
from . import models

# Register your models here.
# --- Catálogos ---
admin.site.register(models.Gender)
admin.site.register(models.MaritalStatus)
admin.site.register(models.Country)
admin.site.register(models.State)

# --- Discapacidad ---
admin.site.register(models.DisabilityGroup)
admin.site.register(models.DisabilityType)
admin.site.register(models.DisabilityStatus)

# --- Contacto y Bancos ---
admin.site.register(models.AddressType)
admin.site.register(models.EmailType)
admin.site.register(models.PhoneType)
admin.site.register(models.PhoneCarrier)
admin.site.register(models.PhoneCarrierCode)
admin.site.register(models.Bank)
admin.site.register(models.BankAccountType)
admin.site.register(models.RelationshipType)

# --- PERSONA Y DETALLES ---

class NationalIdInline(admin.TabularInline):
    model = models.NationalId
    extra = 0

class DependentInline(admin.TabularInline):
    model = models.Dependent
    extra = 0

class EmergencyContactInline(admin.TabularInline):
    model = models.EmergencyContact
    extra = 0

@admin.register(models.Person)
class PersonAdmin(admin.ModelAdmin):
    list_display = ('first_name', 'paternal_surname', 'birthdate', 'gender')
    search_fields = ('first_name', 'paternal_surname')
    # Agregamos inlines para ver todo junto en el admin
    inlines = [NationalIdInline, DependentInline, EmergencyContactInline]

# Registros individuales (por si se necesitan ver aparte)
admin.site.register(models.NationalId)
admin.site.register(models.Dependent)
admin.site.register(models.EmergencyContact)
admin.site.register(models.PersonDisabilityVE)
admin.site.register(models.Address)
admin.site.register(models.PersonEmail)
admin.site.register(models.PersonPhone)
admin.site.register(models.PersonBankAccount)
admin.site.register(models.PersonDocument)
admin.site.register(models.PersonNationality)
</file>

<file path="backend/core/urls.py">
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from . import views

router = DefaultRouter()
router.register(r'persons', views.PersonViewSet, basename='person')

# Catálogos
router.register(r'genders', views.GenderViewSet)
router.register(r'marital-statuses', views.MaritalStatusViewSet)
router.register(r'countries', views.CountryViewSet)
router.register(r'disability-groups', views.DisabilityGroupViewSet)
router.register(r'disability-types', views.DisabilityTypeViewSet)
router.register(r'disability-statuses', views.DisabilityStatusViewSet)
router.register(r'address-types', views.AddressTypeViewSet)
router.register(r'email-types', views.EmailTypeViewSet)
router.register(r'phone-types', views.PhoneTypeViewSet)
router.register(r'phone-carriers', views.PhoneCarrierViewSet)
router.register(r'banks', views.BankViewSet)
router.register(r'bank-account-types', views.BankAccountTypeViewSet)
router.register(r'relationship-types', views.RelationshipTypeViewSet)
router.register(r'states', views.StateViewSet)
router.register(r'phone-carrier-codes', views.PhoneCarrierCodeViewSet)

# Datos de Persona
router.register(r'person-disabilities', views.PersonDisabilityVEViewSet)
router.register(r'addresses', views.AddressViewSet)
router.register(r'national-ids', views.NationalIdViewSet, basename='national-id')
router.register(r'person-emails', views.PersonEmailViewSet)
router.register(r'person-phones', views.PersonPhoneViewSet)
router.register(r'person-bank-accounts', views.PersonBankAccountViewSet)
router.register(r'person-documents', views.PersonDocumentViewSet)
router.register(r'person-nationalities', views.PersonNationalityViewSet)

# Rutas Satélites
router.register(r'dependents', views.DependentViewSet)
router.register(r'emergency-contacts', views.EmergencyContactViewSet)

urlpatterns = [
    path('', include(router.urls)),
]
</file>

<file path="backend/employment/views.py">
from datetime import timedelta
from django.utils import timezone
from django.db import transaction
from django.db.models import Count
from rest_framework import viewsets, permissions, status
from rest_framework.decorators import action
from rest_framework.response import Response
from .models import (
    Employment, EmploymentStatusLog, EmploymentDepartmentRole, PersonDepartmentRole,
    is_active_status, EmploymentStatusChoices
)
from .serializers import (
    EmploymentSerializer, EmployeeListSerializer, EmploymentStatusLogSerializer,
    EmploymentDepartmentRoleSerializer, PersonDepartmentRoleSerializer,
    EmployeePositionDataSerializer # Nuevo serializer
)
from core.filters import UnaccentSearchFilter

class EmploymentViewSet(viewsets.ModelViewSet):
    queryset = Employment.objects.all()
    serializer_class = EmploymentSerializer
    permission_classes = [permissions.IsAuthenticated] # Cambiado a IsAuthenticated para que my_org_chart funcione para empleados normales

    def get_queryset(self):
        """
        Optimización vital para cargar relaciones en una sola consulta.
        """
        queryset = self.queryset
        
        # Si es listado o detalle, optimizamos
        if self.action in ['list', 'retrieve', 'update', 'partial_update']:
            queryset = queryset.select_related(
                'person', 
                'position', 
                'position__department',
                'person__user_account' # Para saber si tiene usuario
            )
        
        # Si NO es admin, solo debería ver su propio contrato (excepto en my_org_chart que tiene su lógica propia)
        # Pero como el frontend de Admin Panel usa este endpoint para listar todo,
        # mantenemos el acceso total para staff, y restringido para otros si fuera necesario.
        # Por ahora, asumimos que el panel de /admin/personnel solo lo ven admins.
        
        return queryset

    def get_serializer_class(self):
        if self.action == 'list': 
            return EmployeeListSerializer
        return EmploymentSerializer

    # --- ACCIÓN 1: TERMINAR CONTRATO ---
    @action(detail=True, methods=['post'])
    def terminate(self, request, pk=None):
        # Solo admins pueden terminar contratos
        if not request.user.is_staff:
            return Response({"error": "No autorizado."}, status=status.HTTP_403_FORBIDDEN)

        employment = self.get_object()
        
        end_date = request.data.get('end_date')
        exit_reason = request.data.get('exit_reason')
        exit_notes = request.data.get('exit_notes')
        deactivate_user = request.data.get('deactivate_user', True)

        if not end_date or not exit_reason:
            return Response({"error": "Fecha y motivo obligatorios."}, status=400)

        try:
            with transaction.atomic():
                # Buscar estatus de cierre - ahora es un valor de Choice
                # Usamos 'FIN' que corresponde a 'Finalizado' en EmploymentStatusChoices
                closed_status = EmploymentStatusChoices.TERMINATED

                # Actualizar
                employment.end_date = end_date
                employment.current_status = closed_status 
                employment.exit_reason = exit_reason
                employment.exit_notes = exit_notes
                employment.save() 

                # Desactivar usuario
                if deactivate_user and hasattr(employment.person, 'user_account') and employment.person.user_account:
                    user = employment.person.user_account
                    user.is_active = False
                    user.save()

            return Response(self.get_serializer(employment).data)
        except Exception as e:
            return Response({"error": str(e)}, status=500)
        
    # --- ACCIÓN 2: DASHBOARD (KPIs) ---
    @action(detail=False, methods=['get'])
    def dashboard_stats(self, request):
        # Solo admins ven el dashboard global
        if not request.user.is_staff:
            return Response({"error": "No autorizado."}, status=status.HTTP_403_FORBIDDEN)

        today = timezone.now().date()
        start_of_month = today.replace(day=1)
        
        # Filtrar empleados activos usando helper function
        all_employments = Employment.objects.all()
        active_qs = [e for e in all_employments if is_active_status(e.current_status)]

        # KPIs
        total_active = len(active_qs)
        new_hires = len([e for e in active_qs if e.hire_date >= start_of_month])
        
        # Exits
        inactive_qs = [e for e in all_employments if not is_active_status(e.current_status)]
        exits = len([e for e in inactive_qs if e.end_date and e.end_date >= start_of_month])
        
        pending_users = len([e for e in active_qs if not hasattr(e.person, 'user_account') or not e.person.user_account])

        # Deptos (usando queryset normal porque necesitamos aggregation)
        active_ids = [e.id for e in active_qs]
        dept_stats = Employment.objects.filter(id__in=active_ids).values('position__department__name') \
            .annotate(count=Count('id')).order_by('-count')[:5]

        # Vencimientos (con cédula)
        next_month = today + timedelta(days=30)
        expiring_list = []
        for emp in active_qs:
            if emp.end_date and today <= emp.end_date <= next_month:
                doc = emp.person.national_ids.filter(is_primary=True).first()
                doc_str = f"{doc.document_type}-{doc.number}" if doc else "S/D"
                
                expiring_list.append({
                    "id": emp.id,
                    "person_name": f"{emp.person.first_name} {emp.person.paternal_surname}",
                    "person_document": doc_str,
                    "end_date": emp.end_date
                })

        return Response({
            "headcount": total_active,
            "new_hires": new_hires,
            "exits": exits,
            "pending_users": pending_users,
            "department_distribution": list(dept_stats),
            "expiring_soon": expiring_list
        })

    # --- ACCIÓN 3: MI ORGANIGRAMA (Para el empleado) ---
    @action(detail=False, methods=['get'])
    def my_org_chart(self, request):
        """
        Devuelve jefe, compañeros y subordinados del usuario logueado.
        """
        user = request.user
        if not hasattr(user, 'person'):
            return Response({"error": "Sin perfil de empleado"}, status=404)

        # Mi empleo activo
        my_jobs = Employment.objects.filter(
            person=user.person
        ).select_related('position__department', 'position__manager_position')
        
        my_job = None
        for job in my_jobs:
            if is_active_status(job.current_status):
                my_job = job
                break

        if not my_job:
            return Response({"error": "No tienes contrato activo."}, status=404)

        data = {
            "me": {
                "name": str(user.person),
                "position": my_job.position.name,
                "department": my_job.position.department.name if my_job.position.department else "Sin Depto",
                "photo": user.person.photo.url if user.person.photo else None
            },
            "boss": None,
            "peers": [],
            "subordinates": []
        }

        # Jefe
        boss_pos = my_job.position.manager_position
        if boss_pos:
            boss_employments = Employment.objects.filter(
                position=boss_pos
            ).select_related('person')
            
            boss_employment = None
            for emp in boss_employments:
                if is_active_status(emp.current_status):
                    boss_employment = emp
                    break
            
            if boss_employment:
                data["boss"] = {
                    "name": str(boss_employment.person),
                    "position": boss_pos.name,
                    "photo": boss_employment.person.photo.url if boss_employment.person.photo else None
                }
            else:
                 data["boss"] = {"name": "VACANTE", "position": boss_pos.name, "photo": None}

        # Compañeros (Mismo Depto)
        if my_job.position.department:
            all_peers = Employment.objects.filter(
                position__department=my_job.position.department
            ).exclude(id=my_job.id).select_related('person', 'position')[:20]  # Traemos más para filtrar

            peers = [p for p in all_peers if is_active_status(p.current_status)][:10]

            data["peers"] = [{
                "name": str(p.person),
                "position": p.position.name,
                "photo": p.person.photo.url if p.person.photo else None
            } for p in peers]

        # Subordinados (Si soy jefe)
        all_subordinates = Employment.objects.filter(
            position__manager_position=my_job.position
        ).select_related('person', 'position')

        subordinates = [s for s in all_subordinates if is_active_status(s.current_status)]

        data["subordinates"] = [{
            "name": str(s.person),
            "position": s.position.name,
            "photo": s.person.photo.url if s.person.photo else None
        } for s in subordinates]

        return Response(data)
    
    @action(detail=False, methods=['get'])
    def my_departments(self, request):
        user = request.user
        if not hasattr(user, 'person'):
            return Response([])

        my_employments = Employment.objects.filter(
            person=user.person
        ).select_related('position', 'position__department', 'position__job_title')
        
        # Filtrar solo activos
        active_employments = [e for e in my_employments if is_active_status(e.current_status)]

        departments_map = {}

        for emp in active_employments:
            dept = emp.position.department
            dept_id = dept.id if dept else 0
            dept_name = dept.name if dept else "Sin Departamento Asignado"
            dept_desc = getattr(dept, 'description', 'Área general.') if dept else "Posición fuera de estructura."

            # Determinamos el nombre del cargo de forma segura
            pos_name = emp.position.name
            
            # Si pos_name es None, intentamos usar el Job Title o un fallback
            if not pos_name:
                if emp.position.job_title:
                    pos_name = emp.position.job_title.name
                else:
                    pos_name = "Cargo Sin Nombre"

            if dept_id in departments_map:
                if pos_name not in departments_map[dept_id]['positions_list']:
                    departments_map[dept_id]['positions_list'].append(pos_name)
            else:
                departments_map[dept_id] = {
                    "dept_id": dept_id,
                    "dept_name": dept_name,
                    "dept_description": dept_desc,
                    "start_date": emp.hire_date,
                    "positions_list": [pos_name] 
                }

        final_data = []
        for item in departments_map.values():
            # Ahora positions_list garantiza tener solo strings
            item['my_position'] = " / ".join(item['positions_list'])
            del item['positions_list']
            final_data.append(item)

        return Response(final_data)

    # --- ACCIÓN 4: DATOS DEL PUESTO (MY POSITION DATA) ---
    @action(detail=False, methods=['get'])
    def my_position_data(self, request):
        """
        Retorna los empleos activos del usuario con detalle de posición (Objetivo, Funciones).
        Usado en la página "Datos del Puesto".
        """
        user = request.user
        if not hasattr(user, 'person'):
            return Response([])

        # Buscar empleos activos asociados a la persona
        my_employments = Employment.objects.filter(
            person=user.person
        ).select_related(
            'position', 
            'position__department', 
            'position__job_title'
        ).prefetch_related(
            'position__functions',  # Para el serializer
            'position__manager_positions'  # Para supervisor info (ManyToMany)
        )
        
        # Filtrar solo activos usando helper
        active_employments = [e for e in my_employments if is_active_status(e.current_status)]
        
        serializer = EmployeePositionDataSerializer(active_employments, many=True, context={'request': request})
        return Response(serializer.data)


# Viewset para logs
class EmploymentStatusLogViewSet(viewsets.ModelViewSet):
    queryset = EmploymentStatusLog.objects.all()
    serializer_class = EmploymentStatusLogSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]


# --- VIEWSET PARA ROLES JERÁRQUICOS EN DEPARTAMENTO ---

class EmploymentDepartmentRoleViewSet(viewsets.ModelViewSet):
    """
    ViewSet para gestionar los roles jerárquicos de empleados en departamentos.
    
    Permite:
    - Crear/editar roles (Gerente/Empleado) para empleados en departamentos específicos
    - Consultar histórico de roles
    - Filtrar por empleado, departamento, rol, etc.
    """
    queryset = EmploymentDepartmentRole.objects.all()
    serializer_class = EmploymentDepartmentRoleSerializer
    permission_classes = [permissions.IsAdminUser]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['employment__person__first_name', 'employment__person__last_name', 'department__name']
    
    def get_queryset(self):
        """
        Optimiza las consultas y permite filtrar por parámetros
        """
        queryset = self.queryset.select_related(
            'employment',
            'employment__person',
            'department'
        ).order_by('-start_date')
        
        # Filtros opcionales
        employment_id = self.request.query_params.get('employment', None)
        department_id = self.request.query_params.get('department', None)
        is_current = self.request.query_params.get('is_current', None)
        hierarchical_role = self.request.query_params.get('hierarchical_role', None)
        
        if employment_id:
            queryset = queryset.filter(employment_id=employment_id)
        
        if department_id:
            queryset = queryset.filter(department_id=department_id)
        
        if is_current == 'true':
            queryset = queryset.filter(end_date__isnull=True)
        elif is_current == 'false':
            queryset = queryset.filter(end_date__isnull=False)
        
        if hierarchical_role:
            queryset = queryset.filter(hierarchical_role=hierarchical_role)
        
        return queryset
    
    @action(detail=False, methods=['get'])
    def current_managers(self, request):
        """
        Retorna todos los gerentes actuales (roles activos con hierarchical_role='MGR')
        """
        current_managers = self.get_queryset().filter(
            hierarchical_role='MGR',
            end_date__isnull=True
        )
        serializer = self.get_serializer(current_managers, many=True)
        return Response(serializer.data)


# --- VIEWSET PARA ROLES JERÁRQUICOS POR PERSONA (MATRIZ) ---

class PersonDepartmentRoleViewSet(viewsets.ModelViewSet):
    """
    ViewSet para gestionar los roles jerárquicos de personas en departamentos.
    Soporta organizaciones matriciales.
    """
    queryset = PersonDepartmentRole.objects.all()
    serializer_class = PersonDepartmentRoleSerializer
    permission_classes = [permissions.IsAdminUser]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['person__first_name', 'person__last_name', 'department__name']
    
    def get_queryset(self):
        queryset = self.queryset.select_related(
            'person',
            'department'
        ).order_by('-start_date')
        
        # Filtros opcionales
        person_id = self.request.query_params.get('person', None)
        department_id = self.request.query_params.get('department', None)
        is_current = self.request.query_params.get('is_current', None)
        hierarchical_role = self.request.query_params.get('hierarchical_role', None)
        
        if person_id:
            queryset = queryset.filter(person_id=person_id)
        
        if department_id:
            queryset = queryset.filter(department_id=department_id)
        
        if is_current == 'true':
            queryset = queryset.filter(end_date__isnull=True)
        elif is_current == 'false':
            queryset = queryset.filter(end_date__isnull=False)
        
        if hierarchical_role:
            queryset = queryset.filter(hierarchical_role=hierarchical_role)
        
        return queryset
    
    @action(detail=False, methods=['get'])
    def current_managers(self, request):
        """
        Retorna todos los gerentes actuales (roles activos con hierarchical_role='MGR')
        """
        current_managers = self.get_queryset().filter(
            hierarchical_role='MGR',
            end_date__isnull=True
        )
        serializer = self.get_serializer(current_managers, many=True)
        return Response(serializer.data)
</file>

<file path="backend/organization/management/commands/load_org_data.py">
"""
Management command to load organization data from organization-manual.md
"""
import re
from pathlib import Path
from django.core.management.base import BaseCommand
from django.db import transaction
from organization.models import (
    Department, JobTitle, Position, 
    PositionRequirement, PositionFunction
)


class Command(BaseCommand):
    help = 'Load organization structure from organization-manual.md'

    def handle(self, *args, **options):
        # Path to manual (relative to project root)
        manual_path = Path(__file__).resolve().parent.parent.parent.parent.parent / 'organization-manual.md'
        
        if not manual_path.exists():
            self.stdout.write(self.style.ERROR(f'Manual not found at {manual_path}'))
            return
        
        self.stdout.write(self.style.SUCCESS(f'Reading manual from {manual_path}'))
        
        # Read manual
        with open(manual_path, 'r', encoding='utf-8') as f:
            content = f.read()
        
        # Parse and load data
        with transaction.atomic():
            self._load_departments()
            self._load_jobtitles()
            self._load_positions_with_details(content)
        
        self.stdout.write(self.style.SUCCESS('Successfully loaded organization data!'))

    def _load_departments(self):
        """Create departments with hierarchy"""
        self.stdout.write('Creating departments...')
        
        # Clear existing (careful in production!)
        Department.objects.all().delete()
        
        # Create root departments
        direccion = Department.objects.create(id=1, name="Dirección", parent=None)
        subdirección = Department.objects.create(id=2, name="Subdirección Académica", parent=direccion)
        
        # Create coordinaciones under subdirección
        Department.objects.create(id=3, name="Coordinación de Control de Estudios y Evaluación", parent=subdirección)
        Department.objects.create(id=4, name="Coordinación Administrativa", parent=direccion)
        Department.objects.create(id=5, name="Coordinación de Pasantías", parent=subdirección)
        Department.objects.create(id=6, name="Coordinación de Informática", parent=subdirección)
        Department.objects.create(id=7, name="Coordinación de Preescolar", parent=subdirección)
        Department.objects.create(id=8, name="Coordinación de Investigación, Extensión y Postgrado", parent=subdirección)
        Department.objects.create(id=9, name="Biblioteca", parent=subdirección)
        
        self.stdout.write(self.style.SUCCESS(f'  Created {Department.objects.count()} departments'))

    def _load_jobtitles(self):
        """Create simplified job titles"""
        self.stdout.write('Creating job titles...')
        
        JobTitle.objects.all().delete()
        
        titles = [
            "Director", "Subdirector", "Coordinador", "Jefe",
            "Asesor", "Secretaria", "Recepcionista", "Asistente",
            "Personal de Mantenimiento", "Personal de Limpieza", "Auxiliar"
        ]
        
        for i, title in enumerate(titles, 1):
            JobTitle.objects.create(id=i, name=title)
        
        self.stdout.write(self.style.SUCCESS(f'  Created {JobTitle.objects.count()} job titles'))

    def _load_positions_with_details(self, content):
        """Parse manual and create positions with requirements and functions"""
        self.stdout.write('Parsing manual and creating positions...')
        
        Position.objects.all().delete()
        PositionRequirement.objects.all().delete()
        PositionFunction.objects.all().delete()
        
        # Mapping from manual section titles to (department_id, jobtitle_id, vacancies, manager_id_ref)
        # manager_id_ref is the ID of the position this position reports to (or None)
        # IDs are assigned sequentially starting from 1 based on this list order.
        positions_to_create = [
            # Dirección (ID 1)
            ("Director", 1, 1, 1, None),
            # ID 2
            ("Asesor de Prensa", 1, 5, 1, 1), # Reports to Director
            # ID 3
            ("Secretaria", 1, 6, 2, 1),  # Reports to Director. Increased vacancies to 2
            # ID 4
            ("Recepcionista", 1, 7, 1, 1), # Reports to Director
            
            # Subdirección Académica (ID 5)
            ("Subdirector Académico", 2, 2, 1, 1), # Reports to Director
            # ID 6
            ("Asistente a la Subdirección Académica", 2, 8, 1, 5), # Reports to Subdirector
            
            # Control de Estudios (ID 7)
            ("Coordinador de Control de Estudios y Evaluación", 3, 3, 1, 5), # Reports to Subdirector
            # ID 8
            ("Asistente de Control de Estudios y Evaluación", 3, 8, 2, 7), # Reports to Coord. Control Estudios. Vacancies: 2
            # ID 9
            ("Secretaria", 3, 6, 1, 7),  # Reports to Coord. Control Estudios
            
            # Coordinación Administrativa (ID 10)
            ("Coordinador Administrativo", 4, 3, 1, 1), # Reports to Director (Administrative arm)
            # ID 11
            ("Asistente de la Coordinador Administrativa", 4, 8, 1, 10), # Reports to Coord. Admin
            # ID 12
            ("Personal de Mantenimiento", 4, 9, 4, 10), # Reports to Coord. Admin. Vacancies: 4
            # ID 13
            ("Personal de Limpieza", 4, 10, 5, 10), # Reports to Coord. Admin. Vacancies: 5
            
            # Pasantías (ID 14)
            ("Coordinador de Pasantías", 5, 3, 1, 5), # Reports to Subdirector
            # ID 15
            ("Asistente de la Coordinación de Pasantías", 5, 8, 1, 14), # Reports to Coord. Pasantías
            
            # Informática (ID 16)
            ("Coordinador de Informática", 6, 3, 1, 5), # Reports to Subdirector
            # ID 17
            ("Asistente del Laboratorio de Informática", 6, 8, 2, 16), # Reports to Coord. Informática. Vacancies: 2
            
            # Preescolar (ID 18)
            ("Coordinador de Preescolar", 7, 3, 1, 5), # Reports to Subdirector
            # ID 19
            ("Asistente", 7, 8, 3, 18),  # Asistente de Preescolar. Vacancies: 3
            
            # Investigación (ID 20)
            ("Coordinador de Investigación, Extensión y Post grado", 8, 3, 1, 5), # Reports to Subdirector
            
            # Biblioteca (ID 21)
            ("Jefe de Biblioteca", 9, 4, 1, 5), # Reports to Subdirector
            # ID 22
            ("Asistente de Biblioteca", 9, 8, 1, 21), # Reports to Jefe Biblioteca
            # ID 23
            ("Auxiliar de Biblioteca", 9, 11, 2, 21), # Reports to Jefe Biblioteca. Vacancies: 2
        ]
        
        # Split content by cargo sections
        cargo_pattern = r'#### Título del Cargo:(.+?)(?=#### Título del Cargo:|###|$)'
        cargos = re.findall(cargo_pattern, content, re.DOTALL)
        
        # We'll match cargos to our positions list by title
        position_counter = 1
        used_cargos = []
        
        # Store manager assignments to apply after creation
        manager_assignments = {} # position_id -> manager_id
        
        for title, dept_id, jt_id, vac, manager_id in positions_to_create:
            # Find matching cargo in manual (not yet used)
            cargo_text = None
            for i, cargo in enumerate(cargos):
                if i in used_cargos:
                    continue
                # Extract title from cargo
                lines = cargo.strip().split('\n')
                if not lines:
                    continue
                cargo_title = lines[0].strip()
                
                # Match title
                if cargo_title == title or (title == "Asistente" and "Asistente" in cargo_title and "Preescolar" in cargo):
                    cargo_text = cargo
                    used_cargos.append(i)
                    break
            
            if not cargo_text:
                self.stdout.write(self.style.WARNING(f'  Skipping: {title} (not found in manual)'))
                # Still increment counter to keep IDs consistent with our list
                position_counter += 1
                continue
            
            # Extract objective
            objective = self._extract_section(cargo_text, "**Objetivo General:**")
            
            # Extract requirements
            requirements = self._extract_list(cargo_text, "**Requisitos:**")
            
            # Extract functions
            functions = self._extract_list(cargo_text, "**Funciones:**")
            
            # Determine if managerial
            is_manager = any(role in title for role in ["Director", "Subdirector", "Coordinador", "Jefe", "Gerente", "Presidente"])

            # Create position
            position = Position.objects.create(
                id=position_counter,
                department_id=dept_id,
                job_title_id=jt_id,
                vacancies=vac,
                objective=objective or f"Objetivo del cargo {title}",
                is_manager=is_manager
            )
            
            # Store manager assignment
            if manager_id:
                manager_assignments[position.id] = manager_id
            
            # Create requirements
            for req in requirements:
                PositionRequirement.objects.create(
                    position=position,
                    description=req
                )
            
            # Create functions
            for i, func in enumerate(functions, 1):
                PositionFunction.objects.create(
                    position=position,
                    description=func,
                    order=i
                )
            
            self.stdout.write(f'  Created: {title} (ID: {position.id}, Vacancies: {vac})')
            position_counter += 1
            
        # Apply manager assignments
        self.stdout.write('Assigning managers...')
        for pos_id, manager_id in manager_assignments.items():
            try:
                position = Position.objects.get(id=pos_id)
                manager = Position.objects.get(id=manager_id)
                position.manager_positions.add(manager)
            except Position.DoesNotExist:
                self.stdout.write(self.style.WARNING(f'  Could not assign manager {manager_id} to position {pos_id}: Position not found'))

        self.stdout.write(self.style.SUCCESS(
            f'  Created {Position.objects.count()} positions, '
            f'{PositionRequirement.objects.count()} requirements, '
            f'{PositionFunction.objects.count()} functions'
        ))

    def _extract_section(self, text, marker):
        """Extract text between marker and next **header**"""
        pattern = rf'{re.escape(marker)}\s*\n\n(.+?)(?=\n\n\*\*|$)'
        match = re.search(pattern, text, re.DOTALL)
        if match:
            return match.group(1).strip()
        return ""

    def _extract_list(self, text, marker):
        """Extract bulleted list items after marker"""
        pattern = rf'{re.escape(marker)}\s*\n\n((?:- .+\n?)+)'
        match = re.search(pattern, text)
        if match:
            items = match.group(1).strip().split('\n')
            return [item.lstrip('- ').strip() for item in items if item.strip()]
        return []
</file>

<file path="backend/organization/urls.py">
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .views import DepartmentViewSet, JobTitleViewSet, PositionViewSet, PositionRequirementViewSet, PositionFunctionViewSet

router = DefaultRouter()
router.register(r'departments', DepartmentViewSet, basename='department')
router.register(r'job-titles', JobTitleViewSet, basename='jobtitle')
router.register(r'positions', PositionViewSet, basename='position')

urlpatterns = [
    path('', include(router.urls)),
    # Rutas anidadas para requerimientos y funciones (objectives eliminado)
    path('positions/<int:position_pk>/requirements/', PositionRequirementViewSet.as_view({'get': 'list', 'post': 'create'}), name='position-requirements-list'),
    path('positions/<int:position_pk>/requirements/<int:pk>/', PositionRequirementViewSet.as_view({'get': 'retrieve', 'patch': 'partial_update', 'delete': 'destroy'}), name='position-requirements-detail'),
    path('positions/<int:position_pk>/functions/', PositionFunctionViewSet.as_view({'get': 'list', 'post': 'create'}), name='position-functions-list'),
    path('positions/<int:position_pk>/functions/<int:pk>/', PositionFunctionViewSet.as_view({'get': 'retrieve', 'patch': 'partial_update', 'delete': 'destroy'}), name='position-functions-detail'),
]
</file>

<file path="backend/talent/models.py">
from django.db import models
from core.models import Person

# Mensajes de error estándar
UNIQUE_ERR_MSG = {'unique': "Ya existe un registro con este nombre."}

class BusinessFunction(models.Model):
    name = models.CharField(
        max_length=100, 
        unique=True, 
        help_text="Ej: Human Resources, Finance, IT",
        error_messages=UNIQUE_ERR_MSG
    )
    description = models.TextField(blank=True, null=True)
    def __str__(self): return self.name

class EducationLevel(models.Model):
    name = models.CharField(
        max_length=100, 
        unique=True, 
        help_text="Ej: Ingeniería, Maestría, Bachillerato",
        error_messages=UNIQUE_ERR_MSG
    )
    def __str__(self): return self.name

class FieldOfStudy(models.Model):
    education_level = models.ForeignKey(
        EducationLevel, 
        on_delete=models.CASCADE, 
        related_name='fields_of_study',
        null=True,  # Permitir NULL para registros existentes
        blank=True,
        help_text="Nivel educativo al que pertenece este campo de estudio"
    )
    name = models.CharField(
        max_length=100, 
        help_text="Ej: Software, Recursos Humanos, Diseño Gráfico",
        error_messages=UNIQUE_ERR_MSG
    )
    
    class Meta:
        unique_together = ('education_level', 'name')
    
    def __str__(self): 
        if self.education_level:
            return f"{self.name} ({self.education_level.name})"
        return self.name

# --- Modelos Transaccionales ---

class PersonSpecialAssignment(models.Model):
    person = models.ForeignKey(Person, on_delete=models.CASCADE, related_name='special_assignments')
    project_name = models.CharField(max_length=255)
    description = models.TextField(blank=True, null=True)
    start_date = models.DateField()
    end_date = models.DateField(null=True, blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self): return self.project_name

class PersonFunctionalExperience(models.Model):
    person = models.ForeignKey(Person, on_delete=models.CASCADE, related_name='functional_experiences')
    function = models.ForeignKey(BusinessFunction, on_delete=models.SET_NULL, null=True)
    start_date = models.DateField()
    end_date = models.DateField(null=True, blank=True, help_text="NULL si es actual")
    comments = models.TextField(blank=True, null=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self): return f"{self.person} - {self.function}"

class PersonCertification(models.Model):
    person = models.ForeignKey(Person, on_delete=models.CASCADE, related_name='certifications')
    name = models.CharField(max_length=255)
    description = models.TextField(blank=True, null=True)
    institution = models.CharField(max_length=255)
    effective_date = models.DateField()
    expiration_date = models.DateField(null=True, blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    def __str__(self): return self.name

class CertificationDocument(models.Model):
    certification = models.ForeignKey(PersonCertification, on_delete=models.CASCADE, related_name='documents')
    file = models.FileField(upload_to='documents/certification/', blank=True, null=True)
    description = models.CharField(max_length=255, blank=True, null=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    def __str__(self): return self.description or "Documento de Certificación"

class PersonEducation(models.Model):
    person = models.ForeignKey(Person, on_delete=models.CASCADE, related_name='education_history')
    school_name = models.CharField(max_length=255)
    level = models.ForeignKey(EducationLevel, on_delete=models.SET_NULL, null=True)
    field_of_study = models.ForeignKey(FieldOfStudy, on_delete=models.SET_NULL, null=True)
    start_date = models.DateField()
    end_date = models.DateField(null=True, blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self): return f"{self.school_name} - {self.level}"

class PersonVolunteerExperience(models.Model):
    person = models.ForeignKey(Person, on_delete=models.CASCADE, related_name='volunteer_experiences')
    organization_name = models.CharField(max_length=255)
    role = models.CharField(max_length=255)
    start_date = models.DateField()
    end_date = models.DateField(null=True, blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    def __str__(self): return f"{self.organization_name} ({self.role})"

class PersonAward(models.Model):
    person = models.ForeignKey(Person, on_delete=models.CASCADE, related_name='awards')
    name = models.CharField(max_length=255)
    description = models.TextField(blank=True, null=True)
    institution = models.CharField(max_length=255, blank=True, null=True)
    issue_date = models.DateField()
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self): return self.name

class PersonMembership(models.Model):
    person = models.ForeignKey(Person, on_delete=models.CASCADE, related_name='memberships')
    organization_name = models.CharField(max_length=255)
    role = models.CharField(max_length=255, blank=True, null=True)
    start_date = models.DateField()
    end_date = models.DateField(null=True, blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    def __str__(self): return self.organization_name

class Language(models.Model):
    name = models.CharField(max_length=100, unique=True, error_messages=UNIQUE_ERR_MSG)
    def __str__(self): return self.name

class LanguageProficiency(models.Model):
    name = models.CharField(max_length=50, unique=True, error_messages=UNIQUE_ERR_MSG)
    def __str__(self): return self.name

class PersonLanguage(models.Model):
    person = models.ForeignKey(Person, on_delete=models.CASCADE, related_name="languages")
    language = models.ForeignKey(Language, on_delete=models.CASCADE)
    speaking_proficiency = models.ForeignKey(LanguageProficiency, on_delete=models.SET_NULL, null=True, blank=True, related_name="speaking")
    reading_proficiency = models.ForeignKey(LanguageProficiency, on_delete=models.SET_NULL, null=True, blank=True, related_name="reading")
    writing_proficiency = models.ForeignKey(LanguageProficiency, on_delete=models.SET_NULL, null=True, blank=True, related_name="writing")

    class Meta:
        constraints = [
            models.UniqueConstraint(
                fields=['person', 'language'],
                name='unique_person_language',
                violation_error_message="Esta persona ya tiene registrado este idioma."
            )
        ]

    def __str__(self): return f"{self.person} - {self.language}"
</file>

<file path="backend/training/models.py">
from django.db import models
from django.core.exceptions import ValidationError
from core.models import Person

class Course(models.Model):
    class Status(models.TextChoices):
        DRAFT = 'BOR', 'Borrador'
        SCHEDULED = 'PRO', 'Programado'
        IN_PROGRESS = 'EJE', 'En Ejecución'
        COMPLETED = 'FIN', 'Finalizado'
        CANCELLED = 'CAN', 'Cancelado'

    # NUEVO: Modalidad
    class Modality(models.TextChoices):
        PRESENTIAL = 'PRE', 'Presencial'
        VIRTUAL_SYNC = 'VIR', 'Virtual (En Vivo / Zoom)'
        VIRTUAL_ASYNC = 'ASY', 'Virtual (Autoaprendizaje)'
        HYBRID = 'MIX', 'Híbrido / Mixto'

    name = models.CharField(max_length=200, verbose_name="Nombre del Curso")
    description = models.TextField(blank=True, null=True)

    cover_image = models.ImageField(
        upload_to='courses/covers/', 
        null=True, 
        blank=True,
        verbose_name="Imagen de Portada"
    )
    
    start_date = models.DateField(verbose_name="Fecha Inicio")
    end_date = models.DateField(verbose_name="Fecha Fin")
    
    # NUEVO: Modalidad y Cupo
    modality = models.CharField(max_length=3, choices=Modality.choices, default=Modality.PRESENTIAL)
    max_participants = models.PositiveIntegerField(
        default=20, 
        verbose_name="Cupo Máximo",
        help_text="Límite de estudiantes permitidos."
    )
    
    duration_hours = models.PositiveIntegerField(default=0)
    status = models.CharField(max_length=3, choices=Status.choices, default=Status.DRAFT)
    
    # 🔧 REFACTOR: Instructor es ahora un campo directo del curso
    instructor = models.ForeignKey(
        Person,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='courses_taught',
        verbose_name="Instructor"
    )
    
    # Privacy/Visibility settings
    is_public = models.BooleanField(
        default=True,
        verbose_name="Curso Público",
        help_text="Si es público, todos pueden ver el curso. Si es privado, solo el departamento asignado."
    )
    department = models.ForeignKey(
        'organization.Department',
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='courses',
        verbose_name="Departamento",
        help_text="Departamento al que pertenece este curso (solo si es privado)"
    )
    
    # 🆕 NEW: Grading Logic
    requires_approval_to_complete = models.BooleanField(
        default=False,
        verbose_name="Requiere Aprobación Manual",
        help_text="Si es True, el instructor debe asignar nota manualmente. Si es False, se completa automáticamente al terminar todas las lecciones."
    )
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self): return self.name
    
    @property
    def enrolled_count(self):
        # 🔧 REFACTOR: Ahora solo contamos estudiantes inscritos (todos los participants son estudiantes)
        return self.participants.filter(enrollment_status='ENR').count()

    @property
    def is_full(self):
        return self.enrolled_count >= self.max_participants


class CourseResource(models.Model):
    """Materiales de apoyo (PDFs, Videos, Links)."""
    
    class Type(models.TextChoices):
        FILE = 'FIL', 'Archivo (PDF/Doc/Img)'
        LINK = 'URL', 'Enlace Externo / Video'

    course = models.ForeignKey(Course, on_delete=models.CASCADE, related_name='resources')
    # 🆕 NEW: Link resource to a specific lesson (optional, can be course-level)
    lesson = models.ForeignKey('CourseLesson', on_delete=models.CASCADE, related_name='resources', null=True, blank=True)
    name = models.CharField(max_length=200, verbose_name="Título del Recurso")
    resource_type = models.CharField(max_length=3, choices=Type.choices, default=Type.FILE)
    
    # Puede ser uno U otro
    file = models.FileField(upload_to='training/resources/', null=True, blank=True)
    url = models.URLField(null=True, blank=True, help_text="Youtube, Drive, Zoom, etc.")
    
    created_at = models.DateTimeField(auto_now_add=True)

    def __str__(self): return self.name


class CourseSession(models.Model):
    """
    Cada una de las clases o sesiones del curso.
    Necesario para tomar asistencia por día en cursos Presenciales/Híbridos.
    """
    course = models.ForeignKey(Course, on_delete=models.CASCADE, related_name='sessions')
    topic = models.CharField(max_length=200, verbose_name="Tema / Título de la Sesión")
    date = models.DateField(verbose_name="Fecha de la sesión")
    start_time = models.TimeField(verbose_name="Hora Inicio")
    end_time = models.TimeField(verbose_name="Hora Fin")
    
    class Meta:
        ordering = ['date', 'start_time']

    def __str__(self): return f"{self.course.name} - {self.topic} ({self.date})"


# 🆕 NEW: Hierarchical Content Models
class CourseModule(models.Model):
    """
    Módulos del curso para organizar el contenido de forma jerárquica.
    Cada módulo contiene múltiples lecciones.
    """
    course = models.ForeignKey(Course, on_delete=models.CASCADE, related_name='modules')
    name = models.CharField(max_length=200, verbose_name="Nombre del Módulo")
    description = models.TextField(blank=True, null=True, verbose_name="Descripción")
    order = models.PositiveIntegerField(default=0, verbose_name="Orden")
    
    class Meta:
        ordering = ['order']
        unique_together = ['course', 'order']
        verbose_name = "Módulo del Curso"
        verbose_name_plural = "Módulos del Curso"
    
    def __str__(self): return f"{self.course.name} - {self.name}"


class CourseLesson(models.Model):
    """
    Lecciones individuales dentro de un módulo.
    Contiene el contenido educativo real.
    """
    module = models.ForeignKey(CourseModule, on_delete=models.CASCADE, related_name='lessons')
    title = models.CharField(max_length=200, verbose_name="Título de la Lección")
    content = models.TextField(verbose_name="Contenido", help_text="Contenido en formato de texto enriquecido", blank=True, null=True)
    # 🔧 REFACTOR: Resources (files/urls) are now in CourseResource model linked to this lesson
    order = models.PositiveIntegerField(default=0, verbose_name="Orden")
    duration_minutes = models.PositiveIntegerField(default=0, verbose_name="Duración (minutos)")
    
    class Meta:
        ordering = ['order']
        unique_together = ['module', 'order']
        verbose_name = "Lección"
        verbose_name_plural = "Lecciones"
    
    def __str__(self): return f"{self.module.name} - {self.title}"


class CourseParticipant(models.Model):
    """
    🔧 REFACTOR: CourseParticipant ahora solo almacena ESTUDIANTES.
    Los instructores se asignan directamente en Course.instructor.
    
    ⚠️ PENDING RENAME: Este modelo será renombrado a 'Enrollment' en una migración posterior.
    """
    
    class EnrollmentStatus(models.TextChoices):
        REQUESTED = 'REQ', 'Solicitud Enviada'
        ENROLLED = 'ENR', 'Inscrito'
        REJECTED = 'REJ', 'Solicitud Rechazada'

    class AcademicStatus(models.TextChoices):
        PENDING = 'PEN', 'En Curso'
        COMPLETED = 'COM', 'Completado'
        PASSED = 'APR', 'Aprobado'
        FAILED = 'REP', 'Reprobado'

    course = models.ForeignKey(Course, on_delete=models.CASCADE, related_name='participants')
    person = models.ForeignKey(Person, on_delete=models.CASCADE, related_name='training_courses')
    
    # Campos de estado (solo para estudiantes)
    enrollment_status = models.CharField(
        max_length=3, 
        choices=EnrollmentStatus.choices, 
        default=EnrollmentStatus.REQUESTED,
        verbose_name="Estado de Inscripción"
    )
    academic_status = models.CharField(
        max_length=3, 
        choices=AcademicStatus.choices, 
        default=AcademicStatus.PENDING,
        verbose_name="Estado Académico"
    )
    
    grade = models.DecimalField(max_digits=5, decimal_places=2, null=True, blank=True)
    created_at = models.DateTimeField(auto_now_add=True, verbose_name="Fecha de Solicitud")
    
    class Meta:
        unique_together = ('course', 'person')

    def __str__(self): return f"{self.person} en {self.course}"


# 🆕 NEW: Lesson Progress Tracking
class LessonProgress(models.Model):
    """
    Rastrea el progreso de cada estudiante en cada lección.
    Se usa para calcular el porcentaje de completitud y determinar si el curso está completo.
    """
    enrollment = models.ForeignKey(
        CourseParticipant,  # Will reference 'Enrollment' after rename
        on_delete=models.CASCADE,
        related_name='lesson_progress'
    )
    lesson = models.ForeignKey(CourseLesson, on_delete=models.CASCADE, related_name='progress_records')
    completed = models.BooleanField(default=False, verbose_name="Completada")
    completed_at = models.DateTimeField(null=True, blank=True, verbose_name="Fecha de Completitud")
    
    class Meta:
        unique_together = ['enrollment', 'lesson']
        verbose_name = "Progreso de Lección"
        verbose_name_plural = "Progreso de Lecciones"
    
    def __str__(self): 
        return f"{self.enrollment.person} - {self.lesson.title} ({'✓' if self.completed else '✗'})"


class AttendanceRecord(models.Model):
    """Registro de asistencia: Cruce entre Sesión y Participante."""
    
    class Status(models.TextChoices):
        PRESENT = 'PRE', 'Presente'
        ABSENT = 'AUS', 'Ausente'
        LATE = 'TAR', 'Tardanza'
        EXCUSED = 'JUS', 'Justificado'

    session = models.ForeignKey(CourseSession, on_delete=models.CASCADE, related_name='attendance_records')
    participant = models.ForeignKey(CourseParticipant, on_delete=models.CASCADE, related_name='attendance_history')
    
    status = models.CharField(max_length=3, choices=Status.choices, default=Status.ABSENT)
    notes = models.CharField(max_length=255, blank=True, null=True)
    
    class Meta:
        unique_together = ('session', 'participant') # Solo una asistencia por persona por sesión

    def __str__(self): return f"{self.participant.person} - {self.session} : {self.get_status_display()}"
</file>

<file path="backend/training/views.py">
from rest_framework import viewsets, permissions, status
from rest_framework.decorators import action
from rest_framework.response import Response
from .models import (
    Course, CourseResource, CourseSession, CourseParticipant, AttendanceRecord,
    CourseModule, CourseLesson, LessonProgress  # 🆕 NEW
)
from .serializers import (
    CourseSerializer, CourseResourceSerializer, CourseSessionSerializer, 
    CourseParticipantSerializer, AttendanceRecordSerializer, ParticipantListSerializer,
    CourseModuleSerializer, CourseLessonSerializer, LessonProgressSerializer  # 🆕 NEW
)
from django.db.models import Q
from .permissions import IsInstructorOrAdmin
from . import services  # 🆕 NEW: Import business logic services

class CourseViewSet(viewsets.ModelViewSet):
    serializer_class = CourseSerializer
    permission_classes = [permissions.IsAuthenticated, IsInstructorOrAdmin]

    def get_queryset(self):
        queryset = Course.objects.all().order_by('-start_date')
        user = self.request.user
        
        # 1. Admin ve todo
        if user.is_staff:
            return queryset
            
        # 2. Empleados (Lógica Híbrida con Privacy)
        if hasattr(user, 'person'):
            person = user.person
            # Obtener el departamento del empleo activo (ACT, SUS, PER, REP)
            active_employment = person.employments.filter(
                current_status__in=['ACT', 'SUS', 'PER', 'REP']
            ).first()
            
            user_department = active_employment.position.department if active_employment and active_employment.position else None
            
            return queryset.filter(
                # CONDICIÓN A: Soy participante (Instructor o Estudiante)
                Q(participants__person=person) |
                
                # CONDICIÓN B: El curso está abierto y es público
                Q(
                    status__in=[Course.Status.SCHEDULED, Course.Status.IN_PROGRESS],
                    is_public=True
                ) |
                
                # CONDICIÓN C: El curso es privado pero soy del mismo departamento
                Q(
                    status__in=[Course.Status.SCHEDULED, Course.Status.IN_PROGRESS],
                    is_public=False,
                    department=user_department
                ) if user_department else Q(pk__in=[])  # Si no tiene department, no aplica
            ).distinct()
            
        return Course.objects.none()

    @action(detail=True, methods=['post'], permission_classes=[permissions.IsAuthenticated])
    def request_enrollment(self, request, pk=None):
        """
        Permite a un estudiante solicitar inscripción en un curso.
        Crea un registro CourseParticipant con enrollment_status=REQUESTED.
        🔧 REFACTOR: Todos los participants son estudiantes ahora.
        """
        course = self.get_object()
        user = request.user

        if not hasattr(user, 'person'):
            return Response(
                {'error': 'Usuario sin perfil de persona asociado.'},
                status=400
            )

        # Verificar si ya existe una inscripción
        existing = CourseParticipant.objects.filter(
            course=course,
            person=user.person
        ).first()

        if existing:
            return Response(
                {'error': f'Ya tienes una solicitud/inscripción en este curso (Estado: {existing.get_enrollment_status_display()}).'},
                status=400
            )

        # Crear la solicitud
        participant = CourseParticipant.objects.create(
            course=course,
            person=user.person,
            enrollment_status=CourseParticipant.EnrollmentStatus.REQUESTED
        )

        serializer = CourseParticipantSerializer(participant)
        return Response(serializer.data, status=201)

    @action(detail=True, methods=['post'])
    def approve_enrollment(self, request, pk=None):
        """
        Permite a Admin o Instructor aprobar una solicitud de inscripción.
        Cambia enrollment_status de REQUESTED a ENROLLED.
        🔧 REFACTOR: Usa course.instructor en lugar de role.
        """
        course = self.get_object()
        user = request.user

        # Verificar permisos: Admin o Instructor del curso
        if not user.is_staff:
            # 🔧 REFACTOR: Verificar si es el instructor del curso
            if not (hasattr(user, 'person') and course.instructor == user.person):
                return Response(
                    {'error': 'No tienes permiso para aprobar inscripciones en este curso.'},
                    status=403
                )

        participant_id = request.data.get('participant_id')
        try:
            participant = CourseParticipant.objects.get(id=participant_id, course=course)
        except CourseParticipant.DoesNotExist:
            return Response({'error': 'Participante no encontrado.'}, status=404)

        if participant.enrollment_status != CourseParticipant.EnrollmentStatus.REQUESTED:
            return Response(
                {'error': 'Solo se pueden aprobar solicitudes con estado "Solicitud Enviada".'},
                status=400
            )

        participant.enrollment_status = CourseParticipant.EnrollmentStatus.ENROLLED
        participant.save()

        serializer = CourseParticipantSerializer(participant)
        return Response(serializer.data)

    @action(detail=True, methods=['post'])
    def reject_enrollment(self, request, pk=None):
        """
        Permite a Admin o Instructor rechazar una solicitud de inscripción.
        Cambia enrollment_status de REQUESTED a REJECTED.
        🔧 REFACTOR: Usa course.instructor en lugar de role.
        """
        course = self.get_object()
        user = request.user

        # Verificar permisos: Admin o Instructor del curso
        if not user.is_staff:
            # 🔧 REFACTOR: Verificar si es el instructor del curso
            if not (hasattr(user, 'person') and course.instructor == user.person):
                return Response(
                    {'error': 'No tienes permiso para rechazar inscripciones en este curso.'},
                    status=403
                )

        participant_id = request.data.get('participant_id')
        try:
            participant = CourseParticipant.objects.get(id=participant_id, course=course)
        except CourseParticipant.DoesNotExist:
            return Response({'error': 'Participante no encontrado.'}, status=404)

        if participant.enrollment_status != CourseParticipant.EnrollmentStatus.REQUESTED:
            return Response(
                {'error': 'Solo se pueden rechazar solicitudes con estado "Solicitud Enviada".'},
                status=400
            )

        participant.enrollment_status = CourseParticipant.EnrollmentStatus.REJECTED
        participant.save()

        serializer = CourseParticipantSerializer(participant)
        return Response(serializer.data)

    @action(detail=True, methods=['get'], permission_classes=[permissions.IsAuthenticated])
    def my_enrollment(self, request, pk=None):
        """
        Retorna el estado de inscripción del usuario actual en este curso.
        Si no existe inscripción, retorna 404.
        """
        course = self.get_object()
        user = request.user

        if not hasattr(user, 'person'):
            return Response({'error': 'Usuario sin perfil de persona asociado.'}, status=400)

        try:
            participant = CourseParticipant.objects.get(
                course=course,
                person=user.person
            )
            serializer = CourseParticipantSerializer(participant)
            return Response(serializer.data)
        except CourseParticipant.DoesNotExist:
            # 🔧 FIX: Si es el instructor, retornamos un estado especial 200 OK
            if course.instructor == user.person:
                return Response({
                    'id': 0, # Dummy ID
                    'enrollment_status': 'ENR', # Treat as enrolled
                    'is_instructor': True
                })
            
            return Response({'error': 'No hay inscripción para este usuario.'}, status=404)

class CourseResourceViewSet(viewsets.ModelViewSet):
    serializer_class = CourseResourceSerializer
    permission_classes = [permissions.IsAuthenticated, IsInstructorOrAdmin]

    def get_queryset(self):
        queryset = CourseResource.objects.all()
        user = self.request.user

        # Filtro de Seguridad
        if hasattr(user, 'person') and not user.is_staff:
            # SOLO si estoy INSCRITO (ENR) o soy INSTRUCTOR
            # 🔧 REFACTOR: Verificar instructor con course.instructor
            queryset = queryset.filter(
                Q(course__participants__person=user.person, course__participants__enrollment_status='ENR') | 
                Q(course__instructor=user.person)
            ).distinct()

        # 👇 FILTRO ESPECÍFICO (Crucial) 👇
        course_id = self.request.query_params.get('course')
        if course_id:
            queryset = queryset.filter(course_id=course_id)

        return queryset

class CourseSessionViewSet(viewsets.ModelViewSet):
    serializer_class = CourseSessionSerializer
    permission_classes = [permissions.IsAuthenticated, IsInstructorOrAdmin]

    def get_queryset(self):
        queryset = CourseSession.objects.all()
        user = self.request.user

        if user.is_staff:
            return queryset

        if hasattr(user, 'person'):
            # SOLO si estoy INSCRITO (ENR) o soy INSTRUCTOR
            # 🔧 REFACTOR: Verificar instructor con course.instructor
            return queryset.filter(
                Q(course__participants__person=user.person, course__participants__enrollment_status='ENR') |
                Q(course__instructor=user.person)
            ).distinct()
        
        # Agregamos el filtro por curso específico también aquí por seguridad
        course_id = self.request.query_params.get('course')
        if course_id:
            queryset = queryset.filter(course_id=course_id)

        return CourseSession.objects.none()

    @action(detail=True, methods=['get'])
    def attendance(self, request, pk=None):
        session = self.get_object()
        records = session.attendance_records.select_related('participant__person').all()
        serializer = AttendanceRecordSerializer(records, many=True)
        return Response(serializer.data)

class CourseParticipantViewSet(viewsets.ModelViewSet):
    queryset = CourseParticipant.objects.all()
    serializer_class = CourseParticipantSerializer
    permission_classes = [permissions.IsAuthenticated, IsInstructorOrAdmin]

    def get_serializer_class(self):
        """Use ParticipantListSerializer for list/retrieve to include person_id_document"""
        if self.action in ['list', 'retrieve']:
            return ParticipantListSerializer
        return CourseParticipantSerializer

    def get_queryset(self):
        # OPTIMIZACIÓN: Cargar la persona junto con el participante
        queryset = CourseParticipant.objects.select_related('person')
        
        # Filtro por curso
        course_id = self.request.query_params.get('course')
        if course_id:
            queryset = queryset.filter(course_id=course_id)
        
        # 🔧 REFACTOR: Filtrado solo por enrollment_status (ya no hay role)
        enrollment_status = self.request.query_params.get('enrollment_status')
        
        if enrollment_status:
            queryset = queryset.filter(enrollment_status=enrollment_status)

        # Filtro por persona (Fix: para que el frontend pueda filtrar mis inscripciones)
        person_id = self.request.query_params.get('person')
        if person_id:
            queryset = queryset.filter(person_id=person_id)
            
        return queryset

class AttendanceRecordViewSet(viewsets.ModelViewSet):
    serializer_class = AttendanceRecordSerializer
    # Usamos el permiso para evitar que alumnos editen (solo instructores/admin editan)
    permission_classes = [permissions.IsAuthenticated, IsInstructorOrAdmin]

    def get_queryset(self):
        # Optimizamos para cargar Sesión y Persona de un solo golpe
        queryset = AttendanceRecord.objects.select_related(
            'session__course', 
            'participant__person'
        ).all()
        
        user = self.request.user

        # 1. Admin ve todo
        if user.is_staff:
            return queryset

        if hasattr(user, 'person'):
            # 2. Lógica Híbrida (Instructor vs Estudiante)
            # 🔧 REFACTOR: Verificar instructor con course.instructor
            return queryset.filter(
                # CASO A: Soy el INSTRUCTOR del curso al que pertenece la sesión
                Q(session__course__instructor=user.person) |
                
                # CASO B: El registro es MÍO (Soy el estudiante evaluado)
                Q(participant__person=user.person)
            ).distinct()

        return AttendanceRecord.objects.none()


# 🆕 NEW: HIERARCHICAL CONTENT VIEWSETS

class CourseModuleViewSet(viewsets.ModelViewSet):
    """ViewSet para módulos del curso."""
    serializer_class = CourseModuleSerializer
    permission_classes = [permissions.IsAuthenticated]

    def get_queryset(self):
        queryset = CourseModule.objects.select_related('course').prefetch_related('lessons').all()
        
        # Filter by course if provided
        course_id = self.request.query_params.get('course')
        if course_id:
            queryset = queryset.filter(course_id=course_id)
        
        return queryset.order_by('order')
    
    def get_permissions(self):
        """Only instructors and admins can create/update/delete modules."""
        if self.action in ['create', 'update', 'partial_update', 'destroy']:
            return [permissions.IsAuthenticated(), IsInstructorOrAdmin()]
        return [permissions.IsAuthenticated()]


class CourseLessonViewSet(viewsets.ModelViewSet):
    """ViewSet para lecciones del curso."""
    serializer_class = CourseLessonSerializer
    permission_classes = [permissions.IsAuthenticated]

    def get_queryset(self):
        queryset = CourseLesson.objects.select_related('module__course').all()
        
        # Filter by module if provided
        module_id = self.request.query_params.get('module')
        if module_id:
            queryset = queryset.filter(module_id=module_id)
        
        # Filter by course if provided
        course_id = self.request.query_params.get('course')
        if course_id:
            queryset = queryset.filter(module__course_id=course_id)
        
        return queryset.order_by('module__order', 'order')
    
    def get_permissions(self):
        """Only instructors and admins can create/update/delete lessons."""
        if self.action in ['create', 'update', 'partial_update', 'destroy']:
            return [permissions.IsAuthenticated(), IsInstructorOrAdmin()]
        return [permissions.IsAuthenticated()]


class LessonProgressViewSet(viewsets.ModelViewSet):
    """ViewSet para el progreso de lecciones por estudiante."""
    serializer_class = LessonProgressSerializer
    permission_classes = [permissions.IsAuthenticated]
    pagination_class = None  # Disable pagination for simpler frontend handling

    def get_queryset(self):
        queryset = LessonProgress.objects.select_related(
            'enrollment__person', 
            'lesson__module__course'
        ).all()
        
        user = self.request.user
        
        # Admins see all
        if user.is_staff:
            return queryset
        
        if hasattr(user, 'person'):
            # Filter by enrollment (my progress)
            enrollment_id = self.request.query_params.get('enrollment')
            if enrollment_id:
                queryset = queryset.filter(enrollment_id=enrollment_id)
            
            # Filter by lesson
            lesson_id = self.request.query_params.get('lesson')
            if lesson_id:
                queryset = queryset.filter(lesson_id=lesson_id)
            
            # Students can only see their own progress
            # Instructors can see progress for their courses
            return queryset.filter(
                Q(enrollment__person=user.person) |  # My progress
                Q(lesson__module__course__instructor=user.person)  # I'm the instructor
            ).distinct()
        
        return LessonProgress.objects.none()
    
    @action(detail=False, methods=['post'], permission_classes=[permissions.IsAuthenticated])
    def mark_complete(self, request):
        """
        Mark a lesson as complete for the current user.
        Automatically checks if course is completed.
        """
        user = request.user
        
        if not hasattr(user, 'person'):
            return Response(
                {'error': 'Usuario sin perfil de persona asociado.'},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        lesson_id = request.data.get('lesson_id')
        
        if not lesson_id:
            return Response(
                {'error': 'lesson_id es requerido'},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        try:
            lesson = CourseLesson.objects.get(id=lesson_id)
        except CourseLesson.DoesNotExist:
            return Response(
                {'error': 'Lección no encontrada'},
                status=status.HTTP_404_NOT_FOUND
            )
        
        # Get user's enrollment for this course
        try:
            enrollment = CourseParticipant.objects.get(
                person=user.person,
                course=lesson.module.course,
                enrollment_status=CourseParticipant.EnrollmentStatus.ENROLLED
            )
        except CourseParticipant.DoesNotExist:
            return Response(
                {'error': 'No estás inscrito en este curso'},
                status=status.HTTP_403_FORBIDDEN
            )
        
        # Use service to mark as complete and check completion
        result = services.mark_lesson_as_complete(enrollment.id, lesson_id)
        
        if 'error' in result:
            return Response(
                {'error': result['error']},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        # Serialize the lesson progress
        serializer = LessonProgressSerializer(result['lesson_progress'])
        
        return Response({
            'lesson_progress': serializer.data,
            'completion_status': result['completion_check']
        }, status=status.HTTP_200_OK)


# 🆕 NEW: ADDITIONAL ACTIONS FOR COURSE PARTICIPANT

# Add these as a mixin or directly to CourseParticipantViewSet
# For now, I'll add them as standalone actions that can be added to the viewset

class CourseParticipantViewSet(viewsets.ModelViewSet):
    """
    ViewSet for managing course participants (students).
    🔧 REFACTOR: Now only manages students, not instructors.
    """
    serializer_class = CourseParticipantSerializer
    permission_classes = [permissions.IsAuthenticated]

    def get_serializer_class(self):
        """Use ParticipantListSerializer for list/retrieve to include person_id_document"""
        if self.action in ['list', 'retrieve']:
            return ParticipantListSerializer
        return CourseParticipantSerializer

    def get_queryset(self):
        # OPTIMIZACIÓN: Cargar la persona junto con el participante
        queryset = CourseParticipant.objects.select_related('person')
        
        # Filtro por curso
        course_id = self.request.query_params.get('course')
        if course_id:
            queryset = queryset.filter(course_id=course_id)
        
        # 🔧 REFACTOR: Filtrado solo por enrollment_status (ya no hay role)
        enrollment_status = self.request.query_params.get('enrollment_status')
        
        if enrollment_status:
            queryset = queryset.filter(enrollment_status=enrollment_status)

        # Filtro por persona (Fix: para que el frontend pueda filtrar mis inscripciones)
        person_id = self.request.query_params.get('person')
        if person_id:
            queryset = queryset.filter(person_id=person_id)
            
        return queryset
    
    @action(detail=True, methods=['post'], permission_classes=[permissions.IsAuthenticated, IsInstructorOrAdmin])
    def assign_grade(self, request, pk=None):
        """
        🆕 NEW: Assign final grade to a student and mark as completed.
        Only available for instructors and admins.
        """
        participant = self.get_object()
        user = request.user
        
        # Verify permissions: Admin or Instructor of the course
        if not user.is_staff:
            if not (hasattr(user, 'person') and participant.course.instructor == user.person):
                return Response(
                    {'error': 'No tienes permiso para asignar notas en este curso.'},
                    status=status.HTTP_403_FORBIDDEN
                )
        
        grade = request.data.get('final_grade')
        
        if grade is None:
            return Response(
                {'error': 'final_grade es requerido'},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        try:
            grade = float(grade)
            if grade < 0 or grade > 20:
                return Response(
                    {'error': 'La nota debe estar entre 0 y 20'},
                    status=status.HTTP_400_BAD_REQUEST
                )
        except (ValueError, TypeError):
            return Response(
                {'error': 'final_grade debe ser un número válido'},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        # Assign grade and mark as completed
        participant.grade = grade
        participant.academic_status = CourseParticipant.AcademicStatus.COMPLETED
        participant.save()
        
        serializer = CourseParticipantSerializer(participant)
        return Response({
            'message': 'Nota asignada exitosamente',
            'participant': serializer.data
        }, status=status.HTTP_200_OK)
    
    @action(detail=False, methods=['get'], permission_classes=[permissions.IsAuthenticated])
    def my_progress(self, request):
        """
        🆕 NEW: Get progress for the current user in a specific course.
        """
        user = request.user
        
        if not hasattr(user, 'person'):
            return Response(
                {'error': 'Usuario sin perfil de persona asociado.'},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        course_id = request.query_params.get('course_id')
        if not course_id:
            return Response(
                {'error': 'course_id es requerido'},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        try:
            enrollment = CourseParticipant.objects.get(
                person=user.person,
                course_id=course_id
            )
        except CourseParticipant.DoesNotExist:
            return Response(
                {'error': 'No estás inscrito en este curso'},
                status=status.HTTP_404_NOT_FOUND
            )
        
        progress = services.calculate_course_progress(enrollment.id)
        
        return Response({
            'enrollment_id': enrollment.id,
            'enrollment_status': enrollment.enrollment_status,
            'academic_status': enrollment.academic_status,
            'grade': enrollment.grade,
            **progress
        }, status=status.HTTP_200_OK)

    
    @action(detail=True, methods=['post'], permission_classes=[permissions.IsAuthenticated, IsInstructorOrAdmin])
    def assign_grade(self, request, pk=None):
        """
        Assign final grade to a student and mark as completed.
        Only available for instructors and admins.
        """
        participant = self.get_object()
        user = request.user
        
        # Verify permissions: Admin or Instructor of the course
        if not user.is_staff:
            if not (hasattr(user, 'person') and participant.course.instructor == user.person):
                return Response(
                    {'error': 'No tienes permiso para asignar notas en este curso.'},
                    status=status.HTTP_403_FORBIDDEN
                )
        
        grade = request.data.get('final_grade')
        
        if grade is None:
            return Response(
                {'error': 'final_grade es requerido'},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        try:
            grade = float(grade)
            if grade < 0 or grade > 20:
                return Response(
                    {'error': 'La nota debe estar entre 0 y 20'},
                    status=status.HTTP_400_BAD_REQUEST
                )
        except (ValueError, TypeError):
            return Response(
                {'error': 'final_grade debe ser un número válido'},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        # Assign grade and mark as completed
        participant.grade = grade
        participant.academic_status = CourseParticipant.AcademicStatus.COMPLETED
        participant.save()
        
        serializer = CourseParticipantSerializer(participant)
        return Response({
            'message': 'Nota asignada exitosamente',
            'participant': serializer.data
        }, status=status.HTTP_200_OK)
    
    @action(detail=False, methods=['get'], permission_classes=[permissions.IsAuthenticated])
    def my_progress(self, request):
        """Get progress for the current user in a specific course."""
        user = request.user
        
        if not hasattr(user, 'person'):
            return Response(
                {'error': 'Usuario sin perfil de persona asociado.'},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        course_id = request.query_params.get('course_id')
        if not course_id:
            return Response(
                {'error': 'course_id es requerido'},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        try:
            enrollment = CourseParticipant.objects.get(
                person=user.person,
                course_id=course_id
            )
        except CourseParticipant.DoesNotExist:
            return Response(
                {'error': 'No estás inscrito en este curso'},
                status=status.HTTP_404_NOT_FOUND
            )
        
        progress = services.calculate_course_progress(enrollment.id)
        
        return Response({
            'enrollment_id': enrollment.id,
            'enrollment_status': enrollment.enrollment_status,
            'academic_status': enrollment.academic_status,
            'grade': enrollment.grade,
            **progress
        }, status=status.HTTP_200_OK)
</file>

<file path="frontend2/app/(main)/admin/config/general/[slug]/page.tsx">
"use client";

import { CatalogCRUD, CatalogField } from "@/components/catalogs/catalog-crud";
import { ColumnDef } from "@tanstack/react-table";
import { notFound } from "next/navigation";
import { use } from "react";
import { Globe, Users, Heart, MapPin, Phone, Smartphone, Mail, Building2, CreditCard, Link, Map } from "lucide-react";

interface CatalogConfig {
    title: string;
    apiUrl: string;
    fields: CatalogField[];
    columns: ColumnDef<any>[];
    searchKey?: string;
    searchOptions?: { label: string; value: string }[];
    icon?: React.ElementType;
    singularName?: string;
}

const simpleNameColumns: ColumnDef<any>[] = [
    {
        accessorKey: "name",
        header: "Nombre",
        cell: ({ row }) => <div className="truncate">{row.getValue("name")}</div>
    },
];

const simpleNameFields: CatalogField[] = [
    {
        name: "name",
        label: "Nombre",
        type: "text",
        required: true,
    },
];

const catalogs: Record<string, CatalogConfig> = {
    countries: {
        title: "Países",
        singularName: "País",
        icon: Globe,
        apiUrl: "/api/core/countries/",
        fields: [
            { name: "name", label: "Nombre", type: "text", required: true },
            { name: "iso_2", label: "Código ISO", type: "text", required: true },
        ],
        columns: [
            { accessorKey: "name", header: "Nombre", cell: ({ row }) => <div className="truncate">{row.getValue("name")}</div> },
            { accessorKey: "iso_2", header: "ISO", cell: ({ row }) => <div className="max-w-[50px] truncate">{row.getValue("iso_2")}</div> },
        ],
        searchKey: "name",
        searchOptions: [
            { label: "Nombre", value: "name" },
            { label: "Código ISO", value: "iso_2" }
        ]
    },
    genders: {
        title: "Géneros",
        singularName: "Género",
        icon: Users,
        apiUrl: "/api/core/genders/",
        fields: simpleNameFields,
        columns: simpleNameColumns,
        searchKey: "name",
    },
    "marital-statuses": {
        title: "Estados Civiles",
        singularName: "Estado Civil",
        icon: Heart,
        apiUrl: "/api/core/marital-statuses/",
        fields: simpleNameFields,
        columns: simpleNameColumns,
        searchKey: "name",
    },
    "address-types": {
        title: "Tipos de Dirección",
        singularName: "Tipo de Dirección",
        icon: MapPin,
        apiUrl: "/api/core/address-types/",
        fields: simpleNameFields,
        columns: simpleNameColumns,
        searchKey: "name",
    },
    "phone-types": {
        title: "Tipos de Teléfono",
        singularName: "Tipo de Teléfono",
        icon: Phone,
        apiUrl: "/api/core/phone-types/",
        fields: simpleNameFields,
        columns: simpleNameColumns,
        searchKey: "name",
    },
    "phone-carriers": {
        title: "Operadoras Telefónicas",
        singularName: "Operadora Telefónica",
        icon: Smartphone,
        apiUrl: "/api/core/phone-carriers/",
        fields: simpleNameFields,
        columns: simpleNameColumns,
        searchKey: "name",
    },
    "email-types": {
        title: "Tipos de Email",
        singularName: "Tipo de Email",
        icon: Mail,
        apiUrl: "/api/core/email-types/",
        fields: simpleNameFields,
        columns: simpleNameColumns,
        searchKey: "name",
    },
    banks: {
        title: "Bancos",
        singularName: "Banco",
        icon: Building2,
        apiUrl: "/api/core/banks/",
        fields: [
            { name: "name", label: "Nombre", type: "text", required: true },
            { name: "code", label: "Código", type: "text", required: true },
        ],
        columns: [
            { accessorKey: "name", header: "Nombre", cell: ({ row }) => <div className="truncate">{row.getValue("name")}</div> },
            { accessorKey: "code", header: "Código", cell: ({ row }) => <div className="max-w-[100px] truncate">{row.getValue("code")}</div> },
        ],
        searchKey: "name",
        searchOptions: [
            { label: "Nombre", value: "name" },
            { label: "Código", value: "code" }
        ]
    },
    "bank-account-types": {
        title: "Tipos de Cuenta Bancaria",
        singularName: "Tipo de Cuenta Bancaria",
        icon: CreditCard,
        apiUrl: "/api/core/bank-account-types/",
        fields: simpleNameFields,
        columns: simpleNameColumns,
        searchKey: "name",
    },
    "relationship-types": {
        title: "Tipos de Relación",
        singularName: "Tipo de Relación",
        icon: Link,
        apiUrl: "/api/core/relationship-types/",
        fields: simpleNameFields,
        columns: simpleNameColumns,
        searchKey: "name",
    },
    states: {
        title: "Estados",
        singularName: "Estado",
        icon: Map,
        apiUrl: "/api/core/states/",
        fields: [
            { name: "name", label: "Nombre", type: "text", required: true },
            {
                name: "country",
                label: "País",
                type: "select",
                required: true,
                optionsUrl: "/api/core/countries/",
                optionLabelKey: "name",
                optionValueKey: "id"
            },
        ],
        columns: [
            { accessorKey: "name", header: "Nombre", cell: ({ row }) => <div className="truncate">{row.getValue("name")}</div> },
            { accessorKey: "country.name", header: "País", cell: ({ row }) => <div className="truncate">{row.original.country?.name}</div> },
        ],
        searchKey: "name",
        searchOptions: [
            { label: "Nombre", value: "name" },
            { label: "País", value: "country__name" }
        ]
    },
    "phone-carrier-codes": {
        title: "Códigos de Operadora",
        singularName: "Código de Operadora",
        icon: Smartphone,
        apiUrl: "/api/core/phone-carrier-codes/",
        fields: [
            { name: "code", label: "Código", type: "text", required: true },
            {
                name: "carrier",
                label: "Operadora",
                type: "select",
                required: true,
                optionsUrl: "/api/core/phone-carriers/",
                optionLabelKey: "name",
                optionValueKey: "id"
            },
        ],
        columns: [
            { accessorKey: "code", header: "Código", cell: ({ row }) => <div className="truncate">{row.getValue("code")}</div> },
            { accessorKey: "carrier.name", header: "Operadora", cell: ({ row }) => <div className="truncate">{row.original.carrier?.name}</div> },
        ],
        searchKey: "code",
        searchOptions: [
            { label: "Código", value: "code" },
            { label: "Operadora", value: "carrier__name" }
        ]
    },
};

export default function DynamicCatalogPage({ params }: { params: Promise<{ slug: string }> }) {
    const { slug } = use(params);
    const config = catalogs[slug];

    if (!config) {
        notFound();
    }

    return (
        <CatalogCRUD
            title={config.title}
            icon={config.icon}
            apiUrl={config.apiUrl}
            fields={config.fields}
            columns={config.columns}
            searchKey={config.searchKey}
            searchOptions={config.searchOptions}
            singularName={config.singularName}
        />
    );
}
</file>

<file path="frontend2/app/(main)/admin/personnel/people/[id]/page.tsx">
"use client";

import { useState, use, useEffect } from "react";
import useSWR, { useSWRConfig } from "swr";
import { useRouter, usePathname } from "next/navigation";
import { ArrowLeft, User, Contact, FileText, Users, Mail, Phone, MapPin, CreditCard, Globe, Pencil, GraduationCap, Link as LinkIcon, Upload, Download, Trash2 } from "lucide-react";
import { Badge } from "@/components/ui/badge";
import { Star } from "lucide-react";
import { Button } from "@/components/ui/button";
import { PersonForm } from "@/components/personnel/PersonForm";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Skeleton } from "@/components/ui/skeleton";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { CatalogCRUD, CatalogField } from "@/components/catalogs/catalog-crud";
import { ColumnDef } from "@tanstack/react-table";
import apiClient from "@/lib/api-client";
import { toast } from "sonner";
import { useBreadcrumb } from "@/context/breadcrumb-context";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import {
    AlertDialog,
    AlertDialogAction,
    AlertDialogCancel,
    AlertDialogContent,
    AlertDialogDescription,
    AlertDialogFooter,
    AlertDialogHeader,
    AlertDialogTitle,
    AlertDialogTrigger,
} from "@/components/ui/alert-dialog";

const fetcher = (url: string) => apiClient.get(url).then((res) => res.data);

export default function PersonDetailPage({ params }: { params: Promise<{ id: string }> }) {
    const { id } = use(params);
    const router = useRouter();
    const pathname = usePathname();
    const { setLabel } = useBreadcrumb();
    const { mutate } = useSWRConfig();
    const [isEditing, setIsEditing] = useState(false);
    const [isUploadingCV, setIsUploadingCV] = useState(false);
    const { data: person, error, isLoading } = useSWR(`/api/core/persons/${id}/`, fetcher);
    const { data: countries } = useSWR("/api/core/countries/", fetcher);
    const countriesList = countries?.results || (Array.isArray(countries) ? countries : []);
    const venezuelaId = countriesList.find((c: any) => c.iso_2 === "VE")?.id;

    const handleCVUpload = async (event: React.ChangeEvent<HTMLInputElement>) => {
        const file = event.target.files?.[0];
        if (!file) return;

        // Validate file type
        const allowedTypes = ['application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'application/msword'];
        if (!allowedTypes.includes(file.type)) {
            toast.error("Solo se permiten archivos PDF o DOCX");
            return;
        }

        setIsUploadingCV(true);
        try {
            const formData = new FormData();
            formData.append('cv_file', file);

            await apiClient.patch(`/api/core/persons/${id}/`, formData, {
                headers: {
                    'Content-Type': 'multipart/form-data',
                }
            });
            toast.success("CV subido exitosamente");
            mutate(`/api/core/persons/${id}/`);
        } catch (error) {
            console.error("Error uploading CV:", error);
            toast.error("Error al subir el CV");
        } finally {
            setIsUploadingCV(false);
        }
    };

    const handleCVDelete = async () => {
        try {
            await apiClient.patch(`/api/core/persons/${id}/`, { cv_file: null });
            toast.success("CV eliminado exitosamente");
            mutate(`/api/core/persons/${id}/`);
        } catch (error) {
            console.error("Error deleting CV:", error);
            toast.error("Error al eliminar el CV");
        }
    };

    useEffect(() => {
        if (person) {
            const normalizedPath = pathname.endsWith('/') ? pathname.slice(0, -1) : pathname;
            setLabel(normalizedPath, person.full_name);
        }
    }, [person, pathname, setLabel]);

    if (isLoading) return <PersonDetailSkeleton />;
    if (error || !person) return <PersonError router={router} />;

    // --- CONFIGURACIÓN DE CATÁLOGOS ANIDADOS ---

    // 1. Emails
    const emailFields: CatalogField[] = [
        { name: "person", label: "Persona", type: "hidden", defaultValue: id },
        { name: "email_type", label: "Tipo", type: "select", required: true, optionsUrl: "/api/core/email-types/", optionLabelKey: "name", optionValueKey: "id" },
        { name: "email_address", label: "Email", type: "email", required: true },
        { name: "is_primary", label: "Principal", type: "checkbox" },
    ];
    const emailColumns: ColumnDef<any>[] = [
        { accessorKey: "email_type_name", header: "Tipo", cell: ({ row }) => row.getValue("email_type_name") },
        { accessorKey: "email_address", header: "Email", cell: ({ row }) => row.getValue("email_address") },
        {
            accessorKey: "is_primary",
            header: "Principal",
            cell: ({ row }) => row.original.is_primary ? (
                <Badge className="bg-[var(--brand-tertiary)] hover:bg-[var(--brand-tertiary)]/90 text-white gap-1">
                    <Star className="size-3 fill-current" /> Principal
                </Badge>
            ) : (
                <Badge variant="secondary">Secundario</Badge>
            )
        },
    ];

    // 2. Teléfonos
    const phoneFields: CatalogField[] = [
        { name: "person", label: "Persona", type: "hidden", defaultValue: id },
        { name: "phone_type", label: "Tipo", type: "select", required: true, optionsUrl: "/api/core/phone-types/", optionLabelKey: "name", optionValueKey: "id" },
        { name: "carrier_code", label: "Operadora", type: "select", required: true, optionsUrl: "/api/core/phone-carrier-codes/", optionLabelKey: "code", optionValueKey: "id" },
        { name: "subscriber_number", label: "Número", type: "number", required: true },
        { name: "is_primary", label: "Principal", type: "checkbox" },
    ];
    const phoneColumns: ColumnDef<any>[] = [
        { accessorKey: "phone_type_name", header: "Tipo", cell: ({ row }) => row.getValue("phone_type_name") },
        { accessorKey: "full_number", header: "Número", cell: ({ row }) => row.original.full_number },
        {
            accessorKey: "is_primary",
            header: "Principal",
            cell: ({ row }) => row.original.is_primary ? (
                <Badge className="bg-[var(--brand-tertiary)] hover:bg-[var(--brand-tertiary)]/90 text-white gap-1">
                    <Star className="size-3 fill-current" /> Principal
                </Badge>
            ) : (
                <Badge variant="secondary">Secundario</Badge>
            )
        },
    ];



    // 3. Direcciones
    const addressFields: CatalogField[] = [
        { name: "person", label: "Persona", type: "hidden", defaultValue: id },
        { name: "address_type", label: "Tipo", type: "select", required: true, optionsUrl: "/api/core/address-types/", optionLabelKey: "name", optionValueKey: "id" },
        { name: "country", label: "País", type: "hidden", defaultValue: venezuelaId },
        { name: "state", label: "Estado", type: "select", required: true, optionsUrl: "/api/core/states/", optionLabelKey: "name", optionValueKey: "id" },
        { name: "city", label: "Ciudad", type: "text", required: true },
        { name: "street_name_and_number", label: "Calle/Avenida", type: "text", required: true },
    ];
    const addressColumns: ColumnDef<any>[] = [
        { accessorKey: "address_type_name", header: "Tipo", cell: ({ row }) => row.getValue("address_type_name") },
        { accessorKey: "state_name", header: "Estado", cell: ({ row }) => row.getValue("state_name") },
        { accessorKey: "city", header: "Ciudad", cell: ({ row }) => row.getValue("city") },
        { accessorKey: "street_name_and_number", header: "Calle/Avenida", cell: ({ row }) => row.getValue("street_name_and_number") },
    ];

    // 4. Documentos de Identidad
    const docFields: CatalogField[] = [
        { name: "person", label: "Persona", type: "hidden", defaultValue: id },
        {
            name: "category",
            label: "Categoría",
            type: "select",
            required: true,
            options: [
                { label: "Cédula", value: "CEDULA" },
                { label: "RIF", value: "RIF" },
                { label: "Pasaporte", value: "PASSPORT" }
            ]
        },
        {
            name: "document_type",
            label: "Prefijo",
            type: "select",
            required: true,
            options: [
                { label: "V - Venezolano", value: "V" },
                { label: "E - Extranjero", value: "E" },
                { label: "J - Jurídico", value: "J" },
                { label: "G - Gubernamental", value: "G" },
                { label: "P - Pasaporte", value: "P" }
            ]
        },
        { name: "number", label: "Número", type: "text", required: true },
        { name: "is_primary", label: "Principal", type: "checkbox" },
    ];
    const nationalIdColumns: ColumnDef<any>[] = [
        { accessorKey: "category_display", header: "Categoría", cell: ({ row }) => row.getValue("category_display") },
        { accessorKey: "full_document", header: "Documento", cell: ({ row }) => row.original.full_document },
        {
            accessorKey: "is_primary",
            header: "Principal",
            cell: ({ row }) => row.original.is_primary ? (
                <Badge className="bg-[var(--brand-tertiary)] hover:bg-[var(--brand-tertiary)]/90 text-white gap-1">
                    <Star className="size-3 fill-current" /> Principal
                </Badge>
            ) : (
                <Badge variant="secondary">Secundario</Badge>
            )
        },
    ];

    // 4b. Cuentas Bancarias
    const bankFields: CatalogField[] = [
        { name: "person", label: "Persona", type: "hidden", defaultValue: id },
        {
            name: "bank",
            label: "Banco",
            type: "select",
            required: true,
            optionsUrl: "/api/core/banks/",
            optionLabelKey: "display_name",
            optionValueKey: "id",
            onChange: (value, form, options) => {
                const selectedBank = options?.find((opt: any) => opt.id.toString() === value);
                if (selectedBank) {
                    form.setValue("account_number", selectedBank.code);
                }
            }
        },
        { name: "bank_account_type", label: "Tipo de Cuenta", type: "select", required: true, optionsUrl: "/api/core/bank-account-types/", optionLabelKey: "name", optionValueKey: "id" },
        { name: "account_number", label: "Número de Cuenta", type: "text", required: true, showCharCount: true, lockPrefixLength: 4 },
        { name: "is_primary", label: "Principal", type: "checkbox" },
    ];
    const bankColumns: ColumnDef<any>[] = [
        { accessorKey: "bank_name", header: "Banco", cell: ({ row }) => row.getValue("bank_name") },
        { accessorKey: "bank_account_type_name", header: "Tipo", cell: ({ row }) => row.getValue("bank_account_type_name") },
        { accessorKey: "account_number", header: "Número", cell: ({ row }) => row.getValue("account_number") },
        {
            accessorKey: "is_primary",
            header: "Principal",
            cell: ({ row }) => row.original.is_primary ? (
                <Badge className="bg-[var(--brand-tertiary)] hover:bg-[var(--brand-tertiary)]/90 text-white gap-1">
                    <Star className="size-3 fill-current" /> Principal
                </Badge>
            ) : (
                <Badge variant="secondary">Secundario</Badge>
            )
        },
    ];

    // 5. Dependientes
    const dependentFields: CatalogField[] = [
        { name: "person", label: "Persona", type: "hidden", defaultValue: id },
        { name: "first_name", label: "Primer Nombre", type: "text", required: true },
        { name: "paternal_surname", label: "Apellido Paterno", type: "text", required: true },
        { name: "relationship", label: "Parentesco", type: "select", required: true, optionsUrl: "/api/core/relationship-types/", optionLabelKey: "name", optionValueKey: "id" },
        { name: "birthdate", label: "Fecha de Nacimiento", type: "date", required: true },
        { name: "gender", label: "Género", type: "select", required: false, optionsUrl: "/api/core/genders/", optionLabelKey: "name", optionValueKey: "id" },
    ];
    const dependentColumns: ColumnDef<any>[] = [
        { accessorKey: "first_name", header: "Nombre", cell: ({ row }) => `${row.original.first_name} ${row.original.paternal_surname}` },
        { accessorKey: "relationship_name", header: "Parentesco", cell: ({ row }) => row.getValue("relationship_name") },
        { accessorKey: "birthdate", header: "Fecha Nacimiento", cell: ({ row }) => row.getValue("birthdate") },
    ];

    // 6. Contactos de Emergencia
    const emergencyFields: CatalogField[] = [
        { name: "person", label: "Persona", type: "hidden", defaultValue: id },
        { name: "first_name", label: "Primer Nombre", type: "text", required: true },
        { name: "paternal_surname", label: "Apellido Paterno", type: "text", required: true },
        { name: "relationship", label: "Parentesco", type: "select", required: true, optionsUrl: "/api/core/relationship-types/", optionLabelKey: "name", optionValueKey: "id" },
        { name: "phone_carrier_code", label: "Operadora", type: "select", required: true, optionsUrl: "/api/core/phone-carrier-codes/", optionLabelKey: "code", optionValueKey: "id" },
        { name: "phone_number", label: "Teléfono", type: "text", required: true },
        { name: "is_primary", label: "Principal", type: "checkbox" },
    ];
    const emergencyColumns: ColumnDef<any>[] = [
        { accessorKey: "first_name", header: "Nombre", cell: ({ row }) => `${row.original.first_name} ${row.original.paternal_surname}` },
        { accessorKey: "relationship_name", header: "Parentesco", cell: ({ row }) => row.getValue("relationship_name") },
        { accessorKey: "phone_number", header: "Teléfono", cell: ({ row }) => row.original.phone_number }, // Adjust if carrier code needed
    ];

    // 7. Formación Académica (Education)
    const educationFields: CatalogField[] = [
        { name: "person", label: "Persona", type: "hidden", defaultValue: id },
        {
            name: "level",
            label: "Nivel",
            type: "select",
            required: true,
            optionsUrl: "/api/talent/education-levels/",
            optionLabelKey: "name",
            optionValueKey: "id",
            onChange: (value, form) => {
                // Reset field_of_study when level changes
                form.setValue("field_of_study", "");
            }
        },
        {
            name: "field_of_study",
            label: "Campo de Estudio",
            type: "select",
            required: true,
            optionsUrl: "/api/talent/fields-of-study/",
            optionLabelKey: "name",
            optionValueKey: "id",
            dependsOn: "level",
            dependsOnFilterParam: "education_level",
            // This will be dynamically filtered based on the selected level
        },
        { name: "school_name", label: "Institución", type: "text", required: true },
        { name: "start_date", label: "Fecha Inicio", type: "date", required: true },
        { name: "end_date", label: "Fecha Fin", type: "date" },
        { name: "is_current", label: "Cursando Actualmente", type: "checkbox" },
    ];
    const educationColumns: ColumnDef<any>[] = [
        { accessorKey: "level_name", header: "Nivel", cell: ({ row }) => row.getValue("level_name") },
        { accessorKey: "field_of_study_name", header: "Campo", cell: ({ row }) => row.getValue("field_of_study_name") },
        { accessorKey: "school_name", header: "Institución", cell: ({ row }) => row.getValue("school_name") },
        { accessorKey: "start_date", header: "Inicio", cell: ({ row }) => row.getValue("start_date") },
    ];

    // 8. Certificaciones
    const certificationFields: CatalogField[] = [
        { name: "person", label: "Persona", type: "hidden", defaultValue: id },
        { name: "name", label: "Nombre", type: "text", required: true },
        { name: "institution", label: "Institución", type: "text", required: true },
        { name: "effective_date", label: "Fecha Emisión", type: "date", required: true },
        { name: "expiration_date", label: "Fecha Expiración", type: "date" },
        { name: "credential_id", label: "ID Credencial", type: "text" },
        { name: "url", label: "URL", type: "text" },
    ];
    const certificationColumns: ColumnDef<any>[] = [
        { accessorKey: "name", header: "Nombre", cell: ({ row }) => row.getValue("name") },
        { accessorKey: "institution", header: "Institución", cell: ({ row }) => row.getValue("institution") },
        { accessorKey: "effective_date", header: "Emisión", cell: ({ row }) => row.getValue("effective_date") },
    ];

    // 9. Idiomas
    const languageFields: CatalogField[] = [
        { name: "person", label: "Persona", type: "hidden", defaultValue: id },
        { name: "language", label: "Idioma", type: "select", required: true, optionsUrl: "/api/talent/languages/", optionLabelKey: "name", optionValueKey: "id" },
        { name: "speaking_proficiency", label: "Habla", type: "select", required: true, optionsUrl: "/api/talent/language-proficiencies/", optionLabelKey: "name", optionValueKey: "id" },
        { name: "reading_proficiency", label: "Lectura", type: "select", required: true, optionsUrl: "/api/talent/language-proficiencies/", optionLabelKey: "name", optionValueKey: "id" },
        { name: "writing_proficiency", label: "Escritura", type: "select", required: true, optionsUrl: "/api/talent/language-proficiencies/", optionLabelKey: "name", optionValueKey: "id" },
    ];
    const languageColumns: ColumnDef<any>[] = [
        { accessorKey: "language_name", header: "Idioma", cell: ({ row }) => row.getValue("language_name") },
        { accessorKey: "speaking_proficiency_name", header: "Habla", cell: ({ row }) => row.getValue("speaking_proficiency_name") },
        { accessorKey: "reading_proficiency_name", header: "Lectura", cell: ({ row }) => row.getValue("reading_proficiency_name") },
        { accessorKey: "writing_proficiency_name", header: "Escritura", cell: ({ row }) => row.getValue("writing_proficiency_name") },
    ];


    return (
        <div className="flex flex-col h-full space-y-6 p-8">
            {/* Header */}
            <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 border-b pb-6">
                <div className="flex flex-col sm:flex-row items-center gap-4">
                    <Avatar className="h-16 w-16 border-2 border-primary/10">
                        <AvatarImage src={person.photo} alt={person.full_name} />
                        <AvatarFallback className="text-xl"><User /></AvatarFallback>
                    </Avatar>
                    <div className="flex flex-col items-center sm:items-start">
                        <h1 className="text-2xl font-bold tracking-tight">{person.full_name}</h1>
                        <div className="flex items-center text-muted-foreground mt-1 gap-4 text-sm">
                            <span className="flex items-center"><FileText className="h-3 w-3 mr-2" /> {person.primary_document || "Sin documento"}</span>
                            <span className="flex items-center"><Mail className="h-3 w-3 mr-2" /> {person.primary_email || "Sin email"}</span>
                        </div>
                    </div>
                </div>
                <div className="flex gap-2 justify-center">
                    {!isEditing && (
                        <Button onClick={() => setIsEditing(true)}>
                            <Pencil className="size-4" />
                            Editar
                        </Button>
                    )}
                    <Button variant="outline" onClick={() => isEditing ? setIsEditing(false) : router.back()}>
                        <ArrowLeft className="size-4" />
                    </Button>
                </div>
            </div>

            {isEditing ? (
                <PersonForm
                    initialData={person}
                    isEditing={true}
                    personId={id}
                    onSuccess={() => {
                        setIsEditing(false);
                        mutate(`/api/core/persons/${id}/`);
                    }}
                />
            ) : (
                <Tabs defaultValue="general" className="flex-1 flex flex-col">
                    <TabsList className="w-full flex flex-col min-[24rem]:grid min-[24rem]:grid-cols-2 md:grid-cols-3 lg:grid-cols-6 h-auto p-1 bg-muted/50 gap-1">
                        <TabsTrigger
                            value="general"
                            className="data-[state=active]:bg-primary data-[state=active]:text-primary-foreground py-3 transition-all duration-300 w-full"
                        >
                            <User className="mr-1 size-4" />
                            <p className="truncate">General</p>
                        </TabsTrigger>
                        <TabsTrigger
                            value="credentials"
                            className="data-[state=active]:bg-primary data-[state=active]:text-primary-foreground py-3 transition-all duration-300 w-full"
                        >
                            <CreditCard className="mr-1 size-4" />
                            <p className="truncate">Credenciales</p>
                        </TabsTrigger>
                        <TabsTrigger
                            value="contact"
                            className="data-[state=active]:bg-primary data-[state=active]:text-primary-foreground py-3 transition-all duration-300 w-full"
                        >
                            <Phone className="mr-1 size-4" />
                            <p className="truncate">Contacto</p>
                        </TabsTrigger>
                        <TabsTrigger
                            value="location"
                            className="data-[state=active]:bg-primary data-[state=active]:text-primary-foreground py-3 transition-all duration-300 w-full"
                        >
                            <MapPin className="mr-1 size-4" />
                            <p className="truncate">Ubicación</p>
                        </TabsTrigger>
                        <TabsTrigger
                            value="links"
                            className="data-[state=active]:bg-primary data-[state=active]:text-primary-foreground py-3 transition-all duration-300 w-full"
                        >
                            <LinkIcon className="mr-1 size-4" />
                            <p className="truncate">Vínculos</p>
                        </TabsTrigger>
                        <TabsTrigger
                            value="talent"
                            className="data-[state=active]:bg-primary data-[state=active]:text-primary-foreground py-3 transition-all duration-300 w-full"
                        >
                            <GraduationCap className="mr-1 size-4" />
                            <p className="truncate">Talento</p>
                        </TabsTrigger>
                    </TabsList >

                    <div className="flex-1 mt-6">
                        {/* --- 1. GENERAL INFO --- */}
                        <TabsContent value="general" className="m-0 space-y-6">
                            <Card>
                                <CardHeader><CardTitle className="text-lg">Información Personal</CardTitle></CardHeader>
                                <CardContent className="grid gap-4 md:grid-cols-2">
                                    <InfoRow label="Primer Nombre" value={person.first_name} />
                                    <InfoRow label="Segundo Nombre" value={person.second_name} />
                                    <InfoRow label="Apellido Paterno" value={person.paternal_surname} />
                                    <InfoRow label="Apellido Materno" value={person.maternal_surname} />
                                    <InfoRow label="Fecha de Nacimiento" value={person.birthdate} />
                                    <InfoRow label="País de Nacimiento" value={person.country_of_birth_name} />
                                    <InfoRow label="Género" value={person.gender_name} />
                                    <InfoRow label="Estado Civil" value={person.marital_status_name} />
                                </CardContent>
                            </Card>
                        </TabsContent>

                        {/* --- 2. CREDENCIALES (Identidad + Bancos) --- */}
                        <TabsContent value="credentials" className="m-0 space-y-8">
                            <div className="space-y-4">
                                <CatalogCRUD
                                    title="Documentos de Identidad"
                                    icon={FileText}
                                    apiUrl={`/api/core/national-ids/?person=${id}`}
                                    fields={docFields}
                                    columns={nationalIdColumns}
                                    disablePagination={true}
                                />
                            </div>
                            <div className="space-y-4">
                                <CatalogCRUD
                                    title="Cuentas Bancarias"
                                    icon={CreditCard}
                                    apiUrl={`/api/core/person-bank-accounts/?person=${id}`}
                                    fields={bankFields}
                                    columns={bankColumns}
                                    searchKey="account_number"
                                    disablePagination={true}
                                />
                            </div>
                        </TabsContent>

                        {/* --- 3. CONTACTO --- */}
                        <TabsContent value="contact" className="m-0 space-y-8">
                            <div className="grid gap-8 grid-cols-1">
                                <div className="space-y-4">
                                    <CatalogCRUD
                                        title="Correos Electrónicos"
                                        icon={Mail}
                                        apiUrl={`/api/core/person-emails/?person=${id}`}
                                        fields={emailFields}
                                        columns={emailColumns}
                                        searchKey="email_address"
                                        disablePagination={true}
                                    />
                                </div>
                                <div className="space-y-4">
                                    <CatalogCRUD
                                        title="Teléfonos"
                                        icon={Phone}
                                        apiUrl={`/api/core/person-phones/?person=${id}`}
                                        fields={phoneFields}
                                        columns={phoneColumns}
                                        searchKey="subscriber_number"
                                        disablePagination={true}
                                    />
                                </div>
                            </div>
                        </TabsContent>

                        {/* --- 4. UBICACIÓN --- */}
                        <TabsContent value="location" className="m-0 space-y-8">
                            <div className="space-y-4">
                                <CatalogCRUD
                                    title="Direcciones"
                                    icon={MapPin}
                                    apiUrl={`/api/core/addresses/?person=${id}`}
                                    fields={addressFields}
                                    columns={addressColumns}
                                    searchKey="city"
                                    disablePagination={true}
                                />
                            </div>
                        </TabsContent>

                        {/* --- 5. VÍNCULOS --- */}
                        <TabsContent value="links" className="m-0 space-y-8">
                            <div className="space-y-4">
                                <CatalogCRUD
                                    title="Dependientes"
                                    icon={Users}
                                    apiUrl={`/api/core/dependents/?person=${id}`}
                                    fields={dependentFields}
                                    columns={dependentColumns}
                                    searchKey="first_name"
                                    disablePagination={true}
                                />
                            </div>
                            <div className="space-y-4">
                                <CatalogCRUD
                                    title="Contactos de Emergencia"
                                    icon={Users}
                                    apiUrl={`/api/core/emergency-contacts/?person=${id}`}
                                    fields={emergencyFields}
                                    columns={emergencyColumns}
                                    searchKey="first_name"
                                    disablePagination={true}
                                />
                            </div>
                        </TabsContent>

                        {/* --- 6. TALENTO --- */}
                        <TabsContent value="talent" className="m-0 space-y-8">
                            {/* CV Section - First */}
                            <div className="space-y-4">
                                <div className="flex items-center justify-between">
                                    <div className="flex items-center gap-2">
                                        <FileText className="size-5 text-primary" />
                                        <h3 className="text-lg font-semibold">Curriculum</h3>
                                    </div>
                                </div>

                                {person.cv_file ? (
                                    <div className="flex items-center justify-between p-4 border rounded-lg bg-card">
                                        <div className="flex items-center gap-3">
                                            <FileText className="size-6 text-muted-foreground" />
                                            <div>
                                                <p className="font-medium">CV Actual</p>
                                                <p className="text-sm text-muted-foreground">
                                                    {person.cv_file.split('/').pop()}
                                                </p>
                                            </div>
                                        </div>
                                        <div className="flex gap-2">
                                            <Button
                                                variant="outline"
                                                size="sm"
                                                onClick={() => window.open(person.cv_file, '_blank')}
                                            >
                                                <Download className="size-4 mr-2" />
                                                Descargar
                                            </Button>

                                            <AlertDialog>
                                                <AlertDialogTrigger asChild>
                                                    <Button
                                                        variant="outline"
                                                        size="sm"
                                                        disabled={isUploadingCV}
                                                    >
                                                        <Upload className="size-4 mr-2" />
                                                        {isUploadingCV ? "Subiendo..." : "Reemplazar"}
                                                    </Button>
                                                </AlertDialogTrigger>
                                                <AlertDialogContent>
                                                    <AlertDialogHeader>
                                                        <AlertDialogTitle>¿Estás seguro?</AlertDialogTitle>
                                                        <AlertDialogDescription>
                                                            Esto reemplazará el archivo CV actual. Esta acción no se puede deshacer.
                                                        </AlertDialogDescription>
                                                    </AlertDialogHeader>
                                                    <AlertDialogFooter>
                                                        <AlertDialogCancel>Cancelar</AlertDialogCancel>
                                                        <AlertDialogAction onClick={() => document.getElementById('cv-upload')?.click()}>
                                                            Continuar
                                                        </AlertDialogAction>
                                                    </AlertDialogFooter>
                                                </AlertDialogContent>
                                            </AlertDialog>

                                            <AlertDialog>
                                                <AlertDialogTrigger asChild>
                                                    <Button variant="destructive" size="sm">
                                                        <Trash2 className="size-4" />
                                                    </Button>
                                                </AlertDialogTrigger>
                                                <AlertDialogContent>
                                                    <AlertDialogHeader>
                                                        <AlertDialogTitle>¿Estás seguro?</AlertDialogTitle>
                                                        <AlertDialogDescription>
                                                            Esto eliminará permanentemente el archivo CV. Esta acción no se puede deshacer.
                                                        </AlertDialogDescription>
                                                    </AlertDialogHeader>
                                                    <AlertDialogFooter>
                                                        <AlertDialogCancel>Cancelar</AlertDialogCancel>
                                                        <AlertDialogAction onClick={handleCVDelete} className="bg-destructive text-white hover:bg-destructive/90">
                                                            Eliminar
                                                        </AlertDialogAction>
                                                    </AlertDialogFooter>
                                                </AlertDialogContent>
                                            </AlertDialog>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="flex flex-col items-center justify-center p-8 border-2 border-dashed rounded-lg bg-card">
                                        <Upload className="size-12 text-muted-foreground mb-4" />
                                        <p className="text-sm text-muted-foreground mb-4">
                                            No hay CV cargado. Sube un archivo PDF o DOCX.
                                        </p>
                                        <Button
                                            onClick={() => document.getElementById('cv-upload')?.click()}
                                            disabled={isUploadingCV}
                                        >
                                            <Upload className="size-4 mr-2" />
                                            {isUploadingCV ? "Subiendo..." : "Subir CV"}
                                        </Button>
                                    </div>
                                )}
                                <input
                                    id="cv-upload"
                                    type="file"
                                    accept=".pdf,.doc,.docx"
                                    onChange={handleCVUpload}
                                    className="hidden"
                                />
                            </div>

                            <div className="space-y-4">
                                <CatalogCRUD
                                    title="Formación Académica"
                                    icon={GraduationCap}
                                    apiUrl={`/api/talent/education/?person=${id}`}
                                    fields={educationFields}
                                    columns={educationColumns}
                                    searchKey="school_name"
                                    disablePagination={true}
                                />
                            </div>
                            <div className="space-y-4">
                                <CatalogCRUD
                                    title="Certificaciones y Cursos"
                                    icon={FileText}
                                    apiUrl={`/api/talent/certifications/?person=${id}`}
                                    fields={certificationFields}
                                    columns={certificationColumns}
                                    searchKey="name"
                                    disablePagination={true}
                                />
                            </div>
                            <div className="space-y-4">
                                <CatalogCRUD
                                    title="Idiomas"
                                    icon={Globe}
                                    apiUrl={`/api/talent/person-languages/?person=${id}`}
                                    fields={languageFields}
                                    columns={languageColumns}
                                    searchKey="language_name"
                                    disablePagination={true}
                                />
                            </div>
                        </TabsContent>
                    </div>
                </Tabs>
            )}
        </div>
    );
}

function InfoRow({ label, value }: { label: string, value: string | null | undefined }) {
    return (
        <div className="flex justify-between border-b pb-2 last:pb-0">
            <span className="text-sm font-medium text-muted-foreground">{label}</span>
            <span className="text-sm">{value || "-"}</span>
        </div>
    );
}

function PersonDetailSkeleton() {
    return (
        <div className="space-y-6 p-6">
            <div className="flex items-center gap-4">
                <Skeleton className="h-16 w-16 rounded-full" />
                <div className="space-y-2">
                    <Skeleton className="h-8 w-64" />
                    <Skeleton className="h-4 w-48" />
                </div>
            </div>
            <Skeleton className="h-10 w-full" />
            <div className="grid gap-6 md:grid-cols-2">
                <Skeleton className="h-[300px] w-full" />
                <Skeleton className="h-[300px] w-full" />
            </div>
        </div>
    );
}

function PersonError({ router }: { router: any }) {
    return (
        <div className="flex flex-col items-center justify-center h-full p-8 text-center">
            <h2 className="text-2xl font-bold text-destructive mb-2">Error</h2>
            <p className="text-muted-foreground mb-4">No se pudo cargar la información de la persona.</p>
            <Button onClick={() => router.back()}>Volver</Button>
        </div>
    );
}
</file>

<file path="backend/config/settings.py">
from pathlib import Path
from datetime import timedelta
import os
import environ

# Initialise environ
env = environ.Env()
environ.Env.read_env()

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent

# Take environment variables from .env file
environ.Env.read_env(os.path.join(BASE_DIR, '.env'))


# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/5.2/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = 'django-insecure-(lq13ma@==7x+84n_65_*7*d3=3j#%w107y@h@91*g(fpq6n$!'

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True

ALLOWED_HOSTS = []


# Application definition

DJANGO_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sites', # Requerido por dj-rest-auth
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
]

THIRD_PARTY_APPS = [
    'rest_framework',
    # 'rest_framework.authtoken',
    'dj_rest_auth',
    'rest_framework_simplejwt',
    'allauth',
    'allauth.account',
    # 'dj_rest_auth.registration',
    'corsheaders',
    'simple_history',
]

PROJECT_APPS = [
    'core',
    'accounts',
    'organization',
    'employment',
    'talent',
    'training',
    'performance',
    'ats',
]

INSTALLED_APPS = DJANGO_APPS + THIRD_PARTY_APPS + PROJECT_APPS

MIDDLEWARE = [
    "corsheaders.middleware.CorsMiddleware",
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
    "allauth.account.middleware.AccountMiddleware",
    'simple_history.middleware.HistoryRequestMiddleware',
]

ROOT_URLCONF = 'config.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'config.wsgi.application'


# Database
# https://docs.djangoproject.com/en/5.2/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}


# Password validation
# https://docs.djangoproject.com/en/5.2/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]


# Internationalization
# https://docs.djangoproject.com/en/5.2/topics/i18n/

LANGUAGE_CODE = 'es-ve'

TIME_ZONE = 'America/Caracas'

# USE_I18N = True

# USE_TZ = True


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/5.2/howto/static-files/

STATIC_URL = 'static/'

# Default primary key field type
# https://docs.djangoproject.com/en/5.2/ref/settings/#default-auto-field

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

AUTH_USER_MODEL = 'accounts.User'

AUTHENTICATION_BACKENDS = (
    'django.contrib.auth.backends.ModelBackend',
    'allauth.account.auth_backends.AuthenticationBackend',
)

SITE_ID = 1

CORS_ALLOWED_ORIGINS = [
    "http://localhost:3000",
    "http://127.0.0.1:3000",
    "http://localhost:3001",
    "http://127.0.0.1:3001",
]

CORS_ALLOW_CREDENTIALS = True

# --- CONFIGURACIÓN CRÍTICA PARA PAGINACIÓN ---
REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': (
        'rest_framework_simplejwt.authentication.JWTAuthentication',
    ),
    
    # Habilita la paginación
    'DEFAULT_PAGINATION_CLASS': 'core.pagination.CustomPagination',
    
    # Tamaño por defecto sincronizado con el Frontend
    'PAGE_SIZE': 10,
    
    # Filtros Globales
    'DEFAULT_FILTER_BACKENDS': (
        'django_filters.rest_framework.DjangoFilterBackend',
        'core.filters.UnaccentSearchFilter',
        'rest_framework.filters.OrderingFilter',
    ),
}

REST_AUTH = {
    'USE_JWT': True,
    'TOKEN_MODEL': None,
    'SESSION_LOGIN': False,
    'JWT_AUTH_COOKIE': None, 
    'JWT_AUTH_REFRESH_COOKIE': 'refresh-token', 
    'JWT_AUTH_REFRESH_COOKIE_PATH': '/api/auth/token/refresh/',
    'JWT_AUTH_HTTPONLY': True,
    'JWT_AUTH_SAMESITE': 'Lax',
    'JWT_AUTH_SECURE': False, # True en producción
    'USER_DETAILS_SERIALIZER': 'accounts.serializers.CustomUserDetailsSerializer',
    'LOGIN_SERIALIZER': 'accounts.serializers.CustomLoginSerializer',
}

SIMPLE_JWT = {
    'ACCESS_TOKEN_LIFETIME': timedelta(minutes=300),
    'REFRESH_TOKEN_LIFETIME': timedelta(days=7),
    'ROTATE_REFRESH_TOKENS': False, # Genera un nuevo refresh token cada vez que se usa
    'BLACKLIST_AFTER_ROTATION': False,
}

ACCOUNT_EMAIL_VERIFICATION = 'none'
ACCOUNT_USER_MODEL_EMAIL_FIELD = None
ACCOUNT_LOGIN_METHODS = ('username',)

MEDIA_URL = '/media/'

MEDIA_ROOT = BASE_DIR / 'media'

# Email Configuration
# Email Configuration
EMAIL_BACKEND = 'django.core.mail.backends.smtp.EmailBackend'
EMAIL_HOST = os.environ.get('EMAIL_HOST', 'smtp.gmail.com')
EMAIL_PORT = int(os.environ.get('EMAIL_PORT', 587))
EMAIL_USE_TLS = os.environ.get('EMAIL_USE_TLS', 'True') == 'True'
EMAIL_HOST_USER = os.environ.get('EMAIL_HOST_USER', '')
EMAIL_HOST_PASSWORD = os.environ.get('EMAIL_HOST_PASSWORD', '')
DEFAULT_FROM_EMAIL = os.environ.get('DEFAULT_FROM_EMAIL', 'noreply@iutirla.edu.ve')
</file>

<file path="backend/employment/models.py">
from django.db import models
from django.core.exceptions import ValidationError
from django.utils import timezone
from django.utils.translation import gettext_lazy as _
from simple_history.models import HistoricalRecords

# Importaciones de otras apps
from core.models import Person
from organization.models import Position

# Configuración de mensajes de error
UNIQUE_ERR_MSG = {'unique': "Ya existe un registro con este nombre."}

# --- 1. CHOICES (Reemplazan los modelos de catálogo) ---

class RoleChoices(models.TextChoices):
    EMPLOYEE = 'EMP', 'Empleado'
    MANAGER = 'MGR', 'Manager'

class EmploymentTypeChoices(models.TextChoices):
    PERMANENT = 'FIJ', 'Fijo'
    TEMPORARY = 'TMP', 'Temporal'
    INTERNSHIP = 'PAS', 'Pasantía'

class EmploymentStatusChoices(models.TextChoices):
    ACTIVE = 'ACT', 'Activo'
    SUSPENDED = 'SUS', 'Suspendido'
    LEAVE = 'PER', 'De Permiso'
    REST = 'REP', 'Reposo'
    TERMINATED = 'FIN', 'Finalizado'
    RESIGNATION = 'REN', 'Renuncia'
    DISMISSAL = 'DES', 'Despido'
    CANCELLED = 'ANU', 'Anulado'

class HierarchicalRoleChoices(models.TextChoices):
    """Rol jerárquico dentro de un departamento"""
    MANAGER = 'MGR', 'Gerente'
    EMPLOYEE = 'EMP', 'Empleado'


def is_active_status(status_value):
    """
    Determina si un estatus representa una vinculación activa.
    Esto reemplaza el campo is_active_relationship del modelo anterior.
    """
    return status_value in [
        EmploymentStatusChoices.ACTIVE,
        EmploymentStatusChoices.SUSPENDED,
        EmploymentStatusChoices.LEAVE,
        EmploymentStatusChoices.REST,
    ]


# --- 2. MODELO PRINCIPAL (CONTRATO) ---

class Employment(models.Model):
    class ExitReason(models.TextChoices):
        RESIGNATION = 'REN', 'Renuncia Voluntaria'
        DISMISSAL = 'DES', 'Despido / Cese'
        END_CONTRACT = 'FIN', 'Fin de Contrato (Tiempo Cumplido)'
        RETIREMENT = 'JUB', 'Jubilación'
        DEATH = 'FAL', 'Fallecimiento'
        OTHER = 'OTR', 'Otro Motivo'

    # 1. EL DATO DURO (Para Estadísticas)
    exit_reason = models.CharField(
        max_length=3,
        choices=ExitReason.choices,
        null=True, blank=True,
        verbose_name="Motivo de Salida"
    )
    
    # 2. EL DATO BLANDO (Para Contexto)
    exit_notes = models.TextField(
        null=True, blank=True,
        verbose_name="Observaciones",
        help_text="Detalle o carta de renuncia."
    )

    person = models.ForeignKey(
        Person, 
        on_delete=models.CASCADE, 
        related_name='employments',
        verbose_name="Colaborador"
    )
    
    position = models.ForeignKey(
        Position, 
        on_delete=models.PROTECT, 
        related_name='employments',
        verbose_name="Cargo / Posición"
    )

    # CAMPOS CON CHOICES
    role = models.CharField(
        max_length=3,
        choices=RoleChoices.choices,
        default=RoleChoices.EMPLOYEE,
        verbose_name="Rol Funcional"
    )
    
    employment_type = models.CharField(
        max_length=3,
        choices=EmploymentTypeChoices.choices,
        default=EmploymentTypeChoices.PERMANENT,
        verbose_name="Tipo de Contrato"
    )
    
    current_status = models.CharField(
        max_length=3,
        choices=EmploymentStatusChoices.choices,
        default=EmploymentStatusChoices.ACTIVE,
        verbose_name="Estatus Actual"
    )
    
    hire_date = models.DateField(verbose_name="Fecha de Contratación")
    
    end_date = models.DateField(
        null=True, 
        blank=True, 
        help_text="Fecha de fin de contrato (para 'Tiempo Determinado' o 'Prueba')"
    )
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    # Historial de cambios
    history = HistoricalRecords()

    # Lógica interna para detectar cambios
    __original_status = None

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        # Guardamos el valor del estatus original
        self.__original_status = self.current_status

    class Meta:
        verbose_name = "Expediente Laboral"
        ordering = ['-hire_date']

    def __str__(self):
        return f"{self.person} - {self.position}"

    def clean(self):
        # 1. Validar Fechas
        if self.end_date and self.hire_date and self.end_date < self.hire_date:
            raise ValidationError({'end_date': "La fecha de egreso no puede ser anterior a la fecha de ingreso."})

        # 2. VALIDACIÓN DE INTEGRIDAD (Usando is_active_status helper)
        
        # Si el estatus que intentamos guardar se considera "Activo/Vigente"...
        if self.current_status and is_active_status(self.current_status):
            
            # Buscamos conflictos: otros contratos activos del mismo empleado en la misma posición
            duplicates = Employment.objects.filter(
                person=self.person,
                position=self.position,
            ).exclude(pk=self.pk)  # Nos excluimos a nosotros mismos si estamos editando
            
            # Filtrar solo los que tienen estatus activo
            duplicates = [e for e in duplicates if is_active_status(e.current_status)]

            if duplicates:
                conflict = duplicates[0]
                raise ValidationError({
                    'current_status': f"Conflicto: {self.person} ya tiene un contrato vigente ({conflict.get_current_status_display()}) en el cargo '{self.position}'. Debe finalizar el anterior primero."
                })

    def save(self, *args, **kwargs):
        self.full_clean()
        
        # 2. LÓGICA DE FECHA DE FIN AUTOMÁTICA (Lo nuevo)
        if self.current_status:
            # Si el estatus NO es vigente (es finalizado/renuncia)...
            if not is_active_status(self.current_status):
                # ... y el usuario no puso fecha...
                if not self.end_date:
                    self.end_date = timezone.now().date() # ¡Asignamos HOY!
            
            # (Opcional) Si reactivas al empleado, limpiamos la fecha de fin

        # 3. DETECCIÓN DE CAMBIOS (Tu código original)
        is_created = self.pk is None
        
        # Verificamos si el valor del estatus cambió respecto al original cargado en __init__
        # Como current_status ahora es CharField, comparamos valores directamente
        original_status = getattr(self, '_Employment__original_status', None) 
        status_changed = self.current_status != self.__original_status

        # 4. DECREMENTO AUTOMÁTICO DE VACANTES (NUEVO)
        # Si es un nuevo contrato y el estatus es activo (ocupa silla)
        if is_created and is_active_status(self.current_status):
            # Bloqueamos la posición para evitar condiciones de carrera
            # Nota: select_for_update() requiere estar dentro de una transacción.
            # Como save() puede llamarse fuera, usamos F() expressions o asumimos transacción externa.
            # Para mayor seguridad y simplicidad aquí, usamos lógica directa, pero lo ideal es que
            # la vista/servicio envuelva esto en transaction.atomic()
            
            if self.position.vacancies > 0:
                self.position.vacancies -= 1
                self.position.save()
            # Si es 0, técnicamente no debería haber pasado la validación del serializer/clean,
            # pero por seguridad no restamos más allá de 0.

        # 5. GUARDADO REAL EN BASE DE DATOS
        super().save(*args, **kwargs)
        
        # 6. CREACIÓN DEL LOG (Tu código original)
        # Se hace DESPUÉS del super().save() para asegurar que tenemos un ID válido
        if is_created or status_changed:
            self._create_status_log(is_created)
            # Actualizamos el estado original en memoria para futuras ediciones en esta misma instancia
            self.__original_status = self.current_status

    def delete(self, *args, **kwargs):
        # 1. RESTITUCIÓN DE VACANTES
        # Si el contrato que se borra estaba ocupando plaza (activo), devolvemos la vacante.
        if is_active_status(self.current_status):
            self.position.vacancies += 1
            self.position.save()
            
        super().delete(*args, **kwargs)

    def _create_status_log(self, is_created):
        # 1. CASO: NUEVO INGRESO
        if is_created:
            reason_text = "Ingreso inicial / Contratación"
        
        # 2. CASO: FINALIZACIÓN DE CONTRATO (Salida)
        # Verificamos si el estatus actual indica cierre (usando helper function)
        elif self.current_status and not is_active_status(self.current_status):
            # Construimos el mensaje con los datos de salida que acabamos de guardar
            parts = []
            
            # A. Agregamos la categoría (ej. "Renuncia Voluntaria")
            if self.exit_reason:
                # get_FOO_display() es un método mágico de Django para obtener el texto del Choice
                parts.append(self.get_exit_reason_display())
            
            # B. Agregamos la nota específica si existe
            if self.exit_notes:
                parts.append(f"({self.exit_notes})")
            
            # Unimos todo. Si no hay nada, ponemos un default.
            reason_text = " ".join(parts) if parts else "Finalización de contrato (Sin motivo especificado)"

        # 3. CASO: CAMBIO ADMINISTRATIVO (Ej. Activo -> Suspendido, o Prueba -> Fijo)
        else:
            reason_text = "Cambio de estatus administrativo / Actualización"

        # --- GUARDAR EL LOG ---
        EmploymentStatusLog.objects.create(
            employment=self,
            status=self.current_status,
            start_date=timezone.now().date(), # O self.end_date si prefieres la fecha del evento
            reason=reason_text # <--- Aquí guardamos el texto calculado
        )
        
class EmploymentStatusLog(models.Model):
    employment = models.ForeignKey(
        Employment, 
        on_delete=models.CASCADE, 
        related_name='status_logs'
    )
    # Ahora es CharField porque usamos Choices
    status = models.CharField(
        max_length=3,
        choices=EmploymentStatusChoices.choices,
        verbose_name="Estatus"
    )
    start_date = models.DateField(
        default=timezone.now,
        help_text="Fecha de inicio de este estatus"
    )
    reason = models.TextField(blank=True, null=True)
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = "Historial de Estatus"
        ordering = ['-created_at']

    def __str__(self):
        return f"{self.employment} - {self.get_status_display()} desde {self.start_date}"



# --- 4. ROL JERÁRQUICO EN DEPARTAMENTO ---

class EmploymentDepartmentRole(models.Model):
    """
    Define el rol jerárquico de un empleado en un departamento específico
    durante su contrato activo.
    
    Esto permite:
    - Que un empleado sea gerente de un departamento
    - Histórico de cambios de rol jerárquico
    - Roles temporales (con fecha de inicio y fin)
    - Roles matriciales (un empleado puede tener roles en múltiples departamentos)
    """
    employment = models.ForeignKey(
        Employment,
        on_delete=models.CASCADE,
        related_name='department_roles',
        verbose_name="Contrato",
        help_text="Contrato al que pertenece este rol jerárquico"
    )
    department = models.ForeignKey(
        'organization.Department',
        on_delete=models.CASCADE,
        related_name='employment_roles',
        verbose_name="Departamento",
        help_text="Departamento en el que ejerce este rol"
    )
    hierarchical_role = models.CharField(
        max_length=3,
        choices=HierarchicalRoleChoices.choices,
        default=HierarchicalRoleChoices.EMPLOYEE,
        verbose_name="Rol Jerárquico",
        help_text="Rol dentro del departamento (Gerente o Empleado)"
    )
    start_date = models.DateField(
        default=timezone.now,
        verbose_name="Fecha de Inicio",
        help_text="Inicio del rol jerárquico en este departamento"
    )
    end_date = models.DateField(
        null=True,
        blank=True,
        verbose_name="Fecha de Fin",
        help_text="Fin del rol jerárquico (NULL si es actual)"
    )
    notes = models.TextField(
        blank=True,
        null=True,
        verbose_name="Notas",
        help_text="Observaciones sobre la asignación del rol"
    )
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    # Historial de cambios
    history = HistoricalRecords()

    class Meta:
        verbose_name = "Rol Jerárquico en Departamento"
        verbose_name_plural = "Roles Jerárquicos en Departamentos"
        unique_together = ('employment', 'department', 'start_date')
        ordering = ['-start_date']

    def __str__(self):
        role_display = self.get_hierarchical_role_display()
        return f"{self.employment.person} - {role_display} de {self.department.name}"

    def clean(self):
        """Validaciones personalizadas"""
        super().clean()
        
        # Validar que el departamento del employment coincide con el department del rol
        # Validar que el departamento del employment coincide con el department del rol - REMOVED for Matrix Support
        # if self.employment.position and self.employment.position.department != self.department:
        #     raise ValidationError({
        #         'department': f'El departamento debe coincidir con el departamento de la posición del empleado ({self.employment.position.department.name})'
        #     })
        
        # Validar que end_date sea posterior a start_date
        if self.end_date and self.end_date < self.start_date:
            raise ValidationError({
                'end_date': 'La fecha de fin debe ser posterior a la fecha de inicio'
            })

    @property
    def is_current(self):
        """Verifica si el rol está actualmente vigente"""
        return self.end_date is None or self.end_date >= timezone.now().date()


# --- 5. ROL JERÁRQUICO POR PERSONA EN DEPARTAMENTO (MATRIZ) ---

class PersonDepartmentRole(models.Model):
    """
    Define el rol jerárquico de una persona en un departamento específico,
    independientemente de su contrato de trabajo.
    
    Este modelo permite organizaciones matriciales donde una persona puede
    tener un rol jerárquico en un departamento diferente al de su posición formal.
    
    Ventajas sobre EmploymentDepartmentRole:
    - Más flexible: Permite roles cruzados entre departamentos
    - Más simple: Vinculación directa Person→Department
    - Soporta matriz: Una persona en IT puede ser gerente de Finanzas
    """
    person = models.ForeignKey(
        'core.Person',
        on_delete=models.CASCADE,
        related_name='department_roles',
        verbose_name="Persona",
        help_text="Persona que ejerce este rol jerárquico"
    )
    department = models.ForeignKey(
        'organization.Department',
        on_delete=models.CASCADE,
        related_name='person_roles',
        verbose_name="Departamento",
        help_text="Departamento en el que ejerce este rol"
    )
    hierarchical_role = models.CharField(
        max_length=3,
        choices=HierarchicalRoleChoices.choices,
        default=HierarchicalRoleChoices.EMPLOYEE,
        verbose_name="Rol Jerárquico",
        help_text="Rol dentro del departamento (Gerente o Empleado)"
    )
    start_date = models.DateField(
        default=timezone.now,
        verbose_name="Fecha de Inicio",
        help_text="Inicio del rol jerárquico en este departamento"
    )
    end_date = models.DateField(
        null=True,
        blank=True,
        verbose_name="Fecha de Fin",
        help_text="Fin del rol jerárquico (NULL si es actual)"
    )
    notes = models.TextField(
        blank=True,
        null=True,
        verbose_name="Notas",
        help_text="Observaciones sobre la asignación del rol"
    )
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    # Historial de cambios
    history = HistoricalRecords()

    class Meta:
        verbose_name = "Rol Jerárquico por Persona"
        verbose_name_plural = "Roles Jerárquicos por Persona"
        unique_together = ('person', 'department', 'start_date')
        ordering = ['-start_date']

    def __str__(self):
        role_display = self.get_hierarchical_role_display()
        return f"{self.person.full_name} - {role_display} de {self.department.name}"

    def clean(self):
        """Validaciones personalizadas"""
        super().clean()
        
        # Validar que end_date sea posterior a start_date
        if self.end_date and self.end_date < self.start_date:
            raise ValidationError({
                'end_date': 'La fecha de fin debe ser posterior a la fecha de inicio'
            })

    @property
    def is_current(self):
        """Verifica si el rol está actualmente vigente"""
        return self.end_date is None or self.end_date >= timezone.now().date()
</file>

<file path="backend/organization/models.py">
from django.db import models
from simple_history.models import HistoricalRecords

class Department(models.Model):
    name = models.CharField(max_length=100, unique=True)
    parent = models.ForeignKey('self', on_delete=models.SET_NULL, null=True, blank=True, related_name='subdepartments')
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    # Historial de cambios
    history = HistoricalRecords()

    def __str__(self):
        return self.name

class JobTitle(models.Model):
    name = models.CharField(max_length=100, unique=True)
    # description field removed
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    # Historial de cambios
    history = HistoricalRecords()

    def __str__(self):
        return self.name

class Position(models.Model):
    department = models.ForeignKey(Department, on_delete=models.SET_NULL, null=True)
    job_title = models.ForeignKey(JobTitle, on_delete=models.SET_NULL, null=True)
    vacancies = models.PositiveIntegerField(default=1, help_text="Número de vacantes disponibles")
    
    # Objetivo del cargo (antes era un modelo separado)
    objective = models.TextField(
        blank=True, 
        null=True,
        help_text="Objetivo general del cargo",
        verbose_name="Objetivo"
    )
    
    # Reportes Matriciales: Una posición puede reportar a múltiples jefes
    manager_positions = models.ManyToManyField(
        'self',
        symmetrical=False,
        blank=True,
        related_name='direct_reports',
        help_text="Posiciones a las que reporta directamente (Jefes Inmediatos)."
    )

    is_manager = models.BooleanField(
        default=False,
        verbose_name="Es Gerencial",
        help_text="Indica si esta posición tiene responsabilidades gerenciales."
    )
    
    # name field removed
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    # Historial de cambios
    history = HistoricalRecords()

    class Meta:
        unique_together = ('department', 'job_title')

    @property
    def title(self):
        """Nombre legible del cargo"""
        return f"{self.job_title.name} - {self.department.name}" if self.job_title and self.department else "Posición sin título"

    def __str__(self):
        if not self.job_title or not self.department:
            return "Posición incompleta"
        return f"{self.job_title.name} - {self.department.name}"


class PositionRequirement(models.Model):
    position = models.ForeignKey(Position, on_delete=models.CASCADE, related_name='requirements')
    description = models.TextField(help_text="Un requisito de la posición")
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    def __str__(self): return self.description[:50]

class PositionFunction(models.Model):
    """Funciones y responsabilidades de un cargo"""
    position = models.ForeignKey(
        Position, 
        on_delete=models.CASCADE, 
        related_name='functions',
        help_text="Posición a la que pertenece esta función"
    )
    description = models.TextField(help_text="Descripción de la función o responsabilidad")
    order = models.PositiveIntegerField(
        default=0, 
        help_text="Orden de visualización (menor primero)"
    )
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        ordering = ['order', 'id']
        verbose_name = "Función de Cargo"
        verbose_name_plural = "Funciones de Cargos"
        
    def __str__(self):
        return f"{self.position} - Función #{self.order + 1}"
</file>

<file path="backend/organization/serializers.py">
from rest_framework import serializers
from core.serializers import check_uniqueness, title_case_cleaner, validate_alphanumeric_with_spaces
from .models import Department, JobTitle, Position, PositionRequirement, PositionFunction

# Serializers simples para detalles
class PositionRequirementSerializer(serializers.ModelSerializer):
    class Meta: model = PositionRequirement; fields = '__all__'

class PositionFunctionSerializer(serializers.ModelSerializer):
    class Meta: 
        model = PositionFunction
        fields = '__all__'

class DepartmentSerializer(serializers.ModelSerializer):
    # Campo extra para mostrar el nombre del padre
    parent_name = serializers.CharField(source='parent.name', read_only=True)

    class Meta:
        model = Department
        fields = '__all__'
    
    def to_representation(self, instance):
        """Customize the output to include nested parent object"""
        data = super().to_representation(instance)
        if instance.parent:
            data['parent'] = {'id': instance.parent.id, 'name': instance.parent.name}
        return data

    def validate_name(self, value): 
        cleaned = title_case_cleaner(validate_alphanumeric_with_spaces(value, 'Nombre'))
        return check_uniqueness(Department, 'name', cleaned, self.instance, "Ya existe un departamento con este nombre.")

    def validate(self, data):
        parent = data.get('parent')
        if self.instance and parent and parent.id == self.instance.id:
            raise serializers.ValidationError({
                "parent": "Un departamento no puede ser su propio departamento padre (referencia circular)."
            })
        return data

class JobTitleSerializer(serializers.ModelSerializer):
    class Meta:
        model = JobTitle
        fields = '__all__'
    
    def validate_name(self, value): 
        cleaned = title_case_cleaner(validate_alphanumeric_with_spaces(value, 'Nombre'))
        return check_uniqueness(JobTitle, 'name', cleaned, self.instance, "Ya existe un cargo con este nombre.")

class PositionSerializer(serializers.ModelSerializer):
    # --- CAMPOS DE LECTURA PARA LA TABLA ---
    # Usamos source='relation.name' porque department y job_title tienen campo 'name'
    department_name = serializers.CharField(source='department.name', read_only=True)
    job_title_name = serializers.CharField(source='job_title.name', read_only=True)
    
    # Campos para múltiples jefes (M2M)
    manager_positions_names = serializers.SerializerMethodField()
    reports_to_names_display = serializers.SerializerMethodField()
    manager_positions_data = serializers.SerializerMethodField()
    
    # Campo para el select (Combo box)
    full_name = serializers.SerializerMethodField()

    # Detalles anidados
    requirements = PositionRequirementSerializer(many=True, read_only=True)
    functions = PositionFunctionSerializer(many=True, read_only=True)
    
    # Campo calculado para empleados activos
    active_employees_count = serializers.SerializerMethodField()

    class Meta:
        model = Position
        fields = '__all__'
        # Deshabilitar validación automática de unique_together
        validators = []

    def get_full_name(self, obj):
        return str(obj)
    
    def get_active_employees_count(self, obj):
        """Devuelve el número de empleados activos en esta posición."""
        from employment.models import Employment, is_active_status
        # Actualizado para usar is_active_status
        all_emps = Employment.objects.filter(position=obj)
        return sum(1 for e in all_emps if is_active_status(e.current_status))

    def get_manager_positions_names(self, obj):
        """Devuelve una lista con los nombres de los cargos de los jefes."""
        return [
            str(manager)
            for manager in obj.manager_positions.all() 
        ]

    def get_reports_to_names_display(self, obj):
        """Devuelve un string separado por comas con los nombres de los cargos de los jefes."""
        names = self.get_manager_positions_names(obj)
        return ", ".join(names) if names else "-"

    def get_manager_positions_data(self, obj):
        """Devuelve información completa de los jefes para detección de cross-department."""
        return [
            {
                'id': manager.id,
                'job_title_name': manager.job_title.name if manager.job_title else None,
                'department_id': manager.department.id if manager.department else None,
            }
            for manager in obj.manager_positions.all()
        ]


    def to_internal_value(self, data):
        if hasattr(data, 'copy'):
            data = data.copy()
        
        # Manejar manager_positions: si viene como valor único, convertir a lista
        if 'manager_positions' in data:
            value = data['manager_positions']
            if not isinstance(value, list):
                # If value is an empty string, treat it as an empty list
                if value == "":
                    data['manager_positions'] = []
                elif value:
                    data['manager_positions'] = [value]
                else:
                    data['manager_positions'] = []
        
        return super().to_internal_value(data)

    def validate(self, data):
        # Importar aquí para evitar import circular
        from core.serializers import validate_unique_together
        
        # Usar helper genérico para unique_together
        return validate_unique_together(
            self, data, Position, ('department', 'job_title'),
            error_template='Ya existe una posición con este cargo en {department}.'
        )
</file>

<file path="backend/talent/serializers.py">
from rest_framework import serializers
from django.utils import timezone
from datetime import date
from core.serializers import check_uniqueness, title_case_cleaner, validate_text_with_spaces, validate_min_length

from .models import (
    PersonSpecialAssignment, BusinessFunction, PersonFunctionalExperience,
    PersonCertification, CertificationDocument, EducationLevel, FieldOfStudy,
    PersonEducation, PersonVolunteerExperience, PersonAward, PersonMembership,
    Language, LanguageProficiency, PersonLanguage
)

def validate_date_range(data, start_field='start_date', end_field='end_date'):
    """Valida que la fecha de fin no sea anterior a la de inicio."""
    start = data.get(start_field)
    end = data.get(end_field)
    
    if start and end and end < start:
        raise serializers.ValidationError({
            end_field: "La fecha de finalización no puede ser anterior a la fecha de inicio."
        })
    return data

# --- Serializers de Catálogo ---

class BusinessFunctionSerializer(serializers.ModelSerializer):
    class Meta: model = BusinessFunction; fields = '__all__'
    def validate_name(self, value):
        cleaned = title_case_cleaner(validate_text_with_spaces(value, 'Nombre'))
        validate_min_length(cleaned, 2)
        return cleaned

class EducationLevelSerializer(serializers.ModelSerializer):
    class Meta: model = EducationLevel; fields = '__all__'
    def validate_name(self, value):
        cleaned = title_case_cleaner(validate_text_with_spaces(value, 'Nombre'))
        validate_min_length(cleaned, 2)
        return cleaned

class FieldOfStudySerializer(serializers.ModelSerializer):
    education_level_name = serializers.CharField(source='education_level.name', read_only=True)
    
    class Meta: 
        model = FieldOfStudy
        fields = '__all__'
    def validate_name(self, value):
        cleaned = title_case_cleaner(validate_text_with_spaces(value, 'Nombre'))
        validate_min_length(cleaned, 2)
        return cleaned

# --- Serializers Transaccionales ---

class PersonSpecialAssignmentSerializer(serializers.ModelSerializer):
    class Meta:
        model = PersonSpecialAssignment
        fields = '__all__'
    
    def validate_project_name(self, value): return title_case_cleaner(value)
    
    def validate(self, data):
        return validate_date_range(data)

class PersonFunctionalExperienceSerializer(serializers.ModelSerializer):
    class Meta:
        model = PersonFunctionalExperience
        fields = '__all__'

    def validate(self, data):
        return validate_date_range(data)

class PersonCertificationSerializer(serializers.ModelSerializer):
    class Meta:
        model = PersonCertification
        fields = '__all__'

    def validate_name(self, value): return title_case_cleaner(value)
    def validate_institution(self, value): return title_case_cleaner(value)

    def validate(self, data):
        # Validamos 'effective_date' vs 'expiration_date'
        return validate_date_range(data, start_field='effective_date', end_field='expiration_date')

class CertificationDocumentSerializer(serializers.ModelSerializer):
    class Meta:
        model = CertificationDocument
        fields = '__all__'

class PersonEducationSerializer(serializers.ModelSerializer):
    level_name = serializers.CharField(source='level.name', read_only=True)
    field_of_study_name = serializers.CharField(source='field_of_study.name', read_only=True)
    class Meta:
        model = PersonEducation
        fields = '__all__'

    def validate_school_name(self, value): return title_case_cleaner(value)

    def validate(self, data):
        return validate_date_range(data)

class PersonVolunteerExperienceSerializer(serializers.ModelSerializer):
    class Meta:
        model = PersonVolunteerExperience
        fields = '__all__'

    def validate_organization_name(self, value): return title_case_cleaner(value)
    def validate_role(self, value): return title_case_cleaner(value)

    def validate(self, data):
        return validate_date_range(data)

class PersonAwardSerializer(serializers.ModelSerializer):
    class Meta:
        model = PersonAward
        fields = '__all__'

    def validate_name(self, value): return title_case_cleaner(value)
    def validate_institution(self, value): return title_case_cleaner(value)

    def validate_issue_date(self, value):
        if value > date.today():
            raise serializers.ValidationError("La fecha de obtención del premio no puede ser futura.")
        return value

class PersonMembershipSerializer(serializers.ModelSerializer):
    class Meta:
        model = PersonMembership
        fields = '__all__'

    def validate_organization_name(self, value): return title_case_cleaner(value)
    def validate_role(self, value): return title_case_cleaner(value)

    def validate(self, data):
        return validate_date_range(data)

class LanguageProficiencySerializer(serializers.ModelSerializer):
    class Meta: model = LanguageProficiency; fields = '__all__'
    def validate_name(self, value):
        cleaned = title_case_cleaner(validate_text_with_spaces(value, 'Nombre'))
        validate_min_length(cleaned, 2)
        return check_uniqueness(LanguageProficiency, 'name', cleaned, self.instance)

class LanguageSerializer(serializers.ModelSerializer):
    class Meta: model = Language; fields = '__all__'
    def validate_name(self, value):
        cleaned = title_case_cleaner(validate_text_with_spaces(value, 'Nombre'))
        validate_min_length(cleaned, 2)
        return check_uniqueness(Language, 'name', cleaned, self.instance)

class PersonLanguageSerializer(serializers.ModelSerializer):
    language_name = serializers.CharField(source='language.name', read_only=True)
    
    speaking_proficiency_name = serializers.CharField(source='speaking_proficiency.name', read_only=True)
    reading_proficiency_name = serializers.CharField(source='reading_proficiency.name', read_only=True)
    writing_proficiency_name = serializers.CharField(source='writing_proficiency.name', read_only=True)
    class Meta:
        model = PersonLanguage
        fields = '__all__'
        validators = [
            serializers.UniqueTogetherValidator(
                queryset=PersonLanguage.objects.all(),
                fields=['person', 'language'],
                message='Esta persona ya tiene registrado este idioma.'
            )
        ]
</file>

<file path="backend/talent/views.py">
from rest_framework import viewsets, permissions
from django_filters.rest_framework import DjangoFilterBackend
from .models import (
    PersonSpecialAssignment, BusinessFunction, PersonFunctionalExperience,
    PersonCertification, CertificationDocument, EducationLevel, FieldOfStudy,
    PersonEducation, PersonVolunteerExperience, PersonAward, PersonMembership,
    Language, LanguageProficiency,PersonLanguage
)
from .serializers import (
    PersonSpecialAssignmentSerializer, BusinessFunctionSerializer, PersonFunctionalExperienceSerializer,
    PersonCertificationSerializer, CertificationDocumentSerializer, EducationLevelSerializer, FieldOfStudySerializer,
    PersonEducationSerializer, PersonVolunteerExperienceSerializer, PersonAwardSerializer, PersonMembershipSerializer,
    LanguageSerializer, LanguageProficiencySerializer, PersonLanguageSerializer
)
from core.filters import UnaccentSearchFilter

class PersonSpecialAssignmentViewSet(viewsets.ModelViewSet):
    queryset = PersonSpecialAssignment.objects.all()
    serializer_class = PersonSpecialAssignmentSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]

    def get_queryset(self):
        queryset = PersonSpecialAssignment.objects.all()
        person_id = self.request.query_params.get('person')
        if person_id:
            queryset = queryset.filter(person=person_id)
        return queryset

class BusinessFunctionViewSet(viewsets.ModelViewSet):
    queryset = BusinessFunction.objects.all()
    serializer_class = BusinessFunctionSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['name__unaccent']

class PersonFunctionalExperienceViewSet(viewsets.ModelViewSet):
    queryset = PersonFunctionalExperience.objects.all()
    serializer_class = PersonFunctionalExperienceSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]

    def get_queryset(self):
        queryset = PersonFunctionalExperience.objects.all()
        person_id = self.request.query_params.get('person')
        if person_id:
            queryset = queryset.filter(person=person_id)
        return queryset

class PersonCertificationViewSet(viewsets.ModelViewSet):
    serializer_class = PersonCertificationSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]

    def get_queryset(self):
        queryset = PersonCertification.objects.all()
        
        # --- FILTRO CRÍTICO ---
        person_id = self.request.query_params.get('person')
        if person_id:
            queryset = queryset.filter(person_id=person_id)
            
        return queryset

class CertificationDocumentViewSet(viewsets.ModelViewSet):
    queryset = CertificationDocument.objects.all()
    serializer_class = CertificationDocumentSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]

class EducationLevelViewSet(viewsets.ModelViewSet):
    queryset = EducationLevel.objects.all()
    serializer_class = EducationLevelSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['name__unaccent']

class FieldOfStudyViewSet(viewsets.ModelViewSet):
    queryset = FieldOfStudy.objects.all()
    serializer_class = FieldOfStudySerializer
    filterset_fields = ['education_level']
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    filter_backends = [DjangoFilterBackend, UnaccentSearchFilter]
    search_fields = ['name__unaccent']

class PersonEducationViewSet(viewsets.ModelViewSet):
    serializer_class = PersonEducationSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]

    def get_queryset(self):
        # Optimizamos la consulta trayendo los nombres de Nivel y Campo
        queryset = PersonEducation.objects.select_related('level', 'field_of_study')
        
        # --- FILTRO CRÍTICO ---
        # Obtenemos el ID de la persona desde la URL (?person=1)
        person_id = self.request.query_params.get('person')
        if person_id:
            queryset = queryset.filter(person_id=person_id)
            
        return queryset

class PersonVolunteerExperienceViewSet(viewsets.ModelViewSet):
    queryset = PersonVolunteerExperience.objects.all()
    serializer_class = PersonVolunteerExperienceSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]

    def get_queryset(self):
        queryset = PersonVolunteerExperience.objects.all()
        person_id = self.request.query_params.get('person')
        if person_id:
            queryset = queryset.filter(person=person_id)
        return queryset

class PersonAwardViewSet(viewsets.ModelViewSet):
    queryset = PersonAward.objects.all()
    serializer_class = PersonAwardSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]

    def get_queryset(self):
        queryset = PersonAward.objects.all()
        person_id = self.request.query_params.get('person')
        if person_id:
            queryset = queryset.filter(person=person_id)
        return queryset

class PersonMembershipViewSet(viewsets.ModelViewSet):
    queryset = PersonMembership.objects.all()
    serializer_class = PersonMembershipSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]

    def get_queryset(self):
        queryset = PersonMembership.objects.all()
        person_id = self.request.query_params.get('person')
        if person_id:
            queryset = queryset.filter(person=person_id)
        return queryset

class LanguageViewSet(viewsets.ModelViewSet):
    queryset = Language.objects.all()
    serializer_class = LanguageSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['name__unaccent']

class LanguageProficiencyViewSet(viewsets.ModelViewSet):
    queryset = LanguageProficiency.objects.all()
    serializer_class = LanguageProficiencySerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['name__unaccent']

class PersonLanguageViewSet(viewsets.ModelViewSet):
    serializer_class = PersonLanguageSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]

    def get_queryset(self):
        # Optimizamos la consulta trayendo los nombres de los idiomas y niveles
        queryset = PersonLanguage.objects.select_related(
            'language', 
            'speaking_proficiency', 
            'reading_proficiency', 
            'writing_proficiency'
        )
        
        # --- FILTRO CRÍTICO ---
        person_id = self.request.query_params.get('person')
        if person_id:
            queryset = queryset.filter(person_id=person_id)
            
        return queryset
</file>

<file path="backend/training/serializers.py">
from rest_framework import serializers
from django.db import transaction
from django.core.exceptions import ValidationError
from core.models import Person
# --- IMPORTAMOS LAS UTILIDADES NECESARIAS ---
from core.serializers import ( 
    title_case_cleaner, 
    sentence_case_cleaner, 
    check_uniqueness,
    validate_text_with_spaces,
    validate_min_length
)
from .models import (
    Course, CourseResource, CourseSession, CourseParticipant, AttendanceRecord,
    CourseModule, CourseLesson, LessonProgress  # 🆕 NEW: Hierarchical models
)

# --- SERIALIZERS DE AYUDA Y AUDITORÍA ---
class AttendanceRecordSerializer(serializers.ModelSerializer):
    person_name = serializers.CharField(source='participant.person.__str__', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)
    
    class Meta: 
        model = AttendanceRecord
        fields = '__all__'

class ParticipantListSerializer(serializers.ModelSerializer):
    person_name = serializers.CharField(source='person.__str__', read_only=True)
    person_id = serializers.IntegerField(source='person.id', read_only=True)
    enrollment_status_name = serializers.CharField(source='get_enrollment_status_display', read_only=True)
    academic_status_name = serializers.CharField(source='get_academic_status_display', read_only=True)

    person_id_document = serializers.SerializerMethodField()

    class Meta:
        model = CourseParticipant
        fields = ['id', 'person_id', 'person_name', 'person_id_document', 'enrollment_status', 'enrollment_status_name', 'academic_status', 'academic_status_name', 'grade', 'created_at', 'course']

    def get_person_id_document(self, obj):
        primary_id = obj.person.national_ids.filter(is_primary=True).first()
        if primary_id:
            return f"{primary_id.document_type}-{primary_id.number}"
        return "S/C"


# --- 1. RECURSOS (Con Limpieza y Validación) ---
class CourseResourceSerializer(serializers.ModelSerializer):
    file_url = serializers.FileField(source='file', read_only=True)
    
    class Meta: 
        model = CourseResource
        fields = '__all__'
        extra_kwargs = {
            'course': {'required': False}, # Optional if linked to lesson
        }
        
    def validate_name(self, value):
        # Limpieza y validación de nombre (Título)
        cleaned_value = title_case_cleaner(validate_text_with_spaces(value, 'Nombre'))
        validate_min_length(cleaned_value, 2)
        
        # Validación de unicidad GLOBAL para Recursos (Evita dos PDF con el mismo nombre)
        return check_uniqueness(self.Meta.model, 'name', cleaned_value, self.instance, 
                                error_msg="Ya existe un recurso con este nombre en el sistema.")

    def validate(self, data):
        # Lógica para asegurar que SÓLO se sube un archivo O un link, no ambos.
        file = data.get('file')
        url = data.get('url')
        
        if data.get('resource_type') == 'FIL' and not file and not url:
            raise serializers.ValidationError({"file": "Debe subir un archivo o URL para este tipo."})
            
        if data.get('resource_type') == 'URL' and not url and not file:
            raise serializers.ValidationError({"url": "Debe proporcionar una URL."})
            
        if file and url:
             raise serializers.ValidationError("Un recurso no puede ser archivo y URL al mismo tiempo.")
             
        return data


# --- 2. SESIONES (Con Limpieza y Validación por Curso y Fecha) ---
class CourseSessionSerializer(serializers.ModelSerializer):
    course_name = serializers.CharField(source='course.name', read_only=True)
    
    class Meta: 
        model = CourseSession
        fields = '__all__'

    def validate_topic(self, value):
        # Limpieza de topic (título de sesión)
        return title_case_cleaner(value)

    def validate(self, data):
        topic = data.get('topic')
        course = data.get('course')
        date = data.get('date')
        
        # Validación de unicidad del tema DENTRO del curso y fecha
        # No pueden existir dos sesiones en el mismo curso con el mismo tema el mismo día
        qs = CourseSession.objects.filter(topic__iexact=topic, course=course, date=date)
        if self.instance:
            qs = qs.exclude(pk=self.instance.pk)
        if qs.exists():
            raise serializers.ValidationError({"topic": f"Ya existe una sesión sobre '{topic}' programada para esta fecha y curso."})
            
        return data


# --- 🆕 NEW: HIERARCHICAL CONTENT SERIALIZERS ---

class CourseLessonSerializer(serializers.ModelSerializer):
    """Serializer para lecciones individuales."""
    module_name = serializers.CharField(source='module.name', read_only=True)
    resources = CourseResourceSerializer(many=True, read_only=True)
    
    # 🆕 NEW: Course details for permission checks
    course_id = serializers.IntegerField(source='module.course.id', read_only=True)
    course_instructor_id = serializers.IntegerField(source='module.course.instructor.id', read_only=True)

    class Meta:
        model = CourseLesson
        fields = ['id', 'module', 'module_name', 'title', 'content', 'order', 'duration_minutes', 'resources', 'course_id', 'course_instructor_id']
        read_only_fields = ['id', 'module_name', 'course_id', 'course_instructor_id']
    
    def validate_title(self, value):
        """Limpieza de título de lección."""
        return title_case_cleaner(validate_text_with_spaces(value, 'Título'))
    
    def validate(self, data):
        """Validar que no haya lecciones duplicadas en el mismo módulo con el mismo orden."""
        module = data.get('module')
        order = data.get('order')
        
        qs = CourseLesson.objects.filter(module=module, order=order)
        if self.instance:
            qs = qs.exclude(pk=self.instance.pk)
        
        if qs.exists():
            raise serializers.ValidationError({
                "order": f"Ya existe una lección con el orden {order} en este módulo."
            })
        
        return data


class CourseModuleSerializer(serializers.ModelSerializer):
    """Serializer para módulos del curso con lecciones anidadas."""
    lessons = CourseLessonSerializer(many=True, read_only=True)
    lesson_count = serializers.SerializerMethodField()
    
    class Meta:
        model = CourseModule
        fields = ['id', 'course', 'name', 'description', 'order', 'lessons', 'lesson_count']
    
    def get_lesson_count(self, obj):
        return obj.lessons.count()
    
    def validate_name(self, value):
        """Limpieza de nombre de módulo."""
        return title_case_cleaner(validate_text_with_spaces(value, 'Nombre'))
    
    def validate(self, data):
        """Validar que no haya módulos duplicados en el mismo curso con el mismo orden."""
        course = data.get('course')
        order = data.get('order')
        
        qs = CourseModule.objects.filter(course=course, order=order)
        if self.instance:
            qs = qs.exclude(pk=self.instance.pk)
        
        if qs.exists():
            raise serializers.ValidationError({
                "order": f"Ya existe un módulo con el orden {order} en este curso."
            })
        
        return data


class LessonProgressSerializer(serializers.ModelSerializer):
    """Serializer para el progreso de lecciones por estudiante."""
    lesson_title = serializers.CharField(source='lesson.title', read_only=True)
    person_name = serializers.CharField(source='enrollment.person.__str__', read_only=True)
    
    class Meta:
        model = LessonProgress
        fields = ['id', 'enrollment', 'lesson', 'lesson_title', 'person_name', 'completed', 'completed_at']
        read_only_fields = ['completed_at']
    
    def validate(self, data):
        """Validar que no haya duplicados de progreso para la misma lección y enrollment."""
        enrollment = data.get('enrollment')
        lesson = data.get('lesson')
        
        qs = LessonProgress.objects.filter(enrollment=enrollment, lesson=lesson)
        if self.instance:
            qs = qs.exclude(pk=self.instance.pk)
        
        if qs.exists():
            raise serializers.ValidationError({
                "lesson": "Ya existe un registro de progreso para esta lección y estudiante."
            })
        
        return data


# --- 3. PARTICIPANTES (Lógica de Cupo y Unicidad de Persona/Curso) ---
# training/serializers.py

class CourseParticipantSerializer(serializers.ModelSerializer):
    person_name = serializers.CharField(source='person.__str__', read_only=True)
    person_id = serializers.IntegerField(source='person.id', read_only=True)
    enrollment_status_name = serializers.CharField(source='get_enrollment_status_display', read_only=True)
    academic_status_name = serializers.CharField(source='get_academic_status_display', read_only=True)
    
    class Meta:
        model = CourseParticipant
        fields = '__all__'
        
        # 🖊 IMPORTANTE: Esto apaga la validación automática de "Conjunto Único"
        # Nos permite manejar la unicidad manualmente en el método validate()
        validators = [] 

    @transaction.atomic
    def validate(self, data):
        """🔧 REFACTOR: Validación simplificada solo para ESTUDIANTES."""
        
        # Recuperamos la instancia (si existe, es una EDICIÓN)
        instance = self.instance
        
        # Obtenemos los datos finales (ya sea del payload o de la base de datos)
        course = data.get('course', getattr(instance, 'course', None))
        person = data.get('person', getattr(instance, 'person', None))

        # -----------------------------------------------------
        # CASO 1: CREACIÓN (NUEVA INSCRIPCIÓN)
        # -----------------------------------------------------
        if not instance:
            
            # A. Validación Manual de Duplicados
            if CourseParticipant.objects.filter(course=course, person=person).exists():
                raise serializers.ValidationError({
                    "person": f"La persona '{person}' ya está registrada en este curso."
                })

            # B. Reglas de Negocio para Estudiantes NUEVOS
            # El curso debe estar en una fase que permita inscripciones
            if course.status not in [Course.Status.SCHEDULED, Course.Status.IN_PROGRESS]:
                 raise serializers.ValidationError({
                    "course": f"No se pueden inscribir nuevos estudiantes. El curso está '{course.get_status_display()}'."
                 })

            # El curso no debe estar lleno
            if course.is_full:
                raise serializers.ValidationError({
                    "course": f"Cupo lleno ({course.max_participants} máx). No se admiten más inscripciones."
                })

        # -----------------------------------------------------
        # CASO 2: EDICIÓN (EVALUACIÓN / CAMBIOS)
        # -----------------------------------------------------
        if instance:
            # Aquí SOLO validamos cosas que tengan sentido al editar.
            # NO validamos cupo ni estado del curso (porque ya están dentro).
            
            grade = data.get('grade')
            if grade is not None and (grade < 0 or grade > 20):
                 raise serializers.ValidationError({"grade": "La nota debe estar entre 0 y 20."})

        return data


# --- 4. CURSO (PRINCIPAL) ---
class CourseSerializer(serializers.ModelSerializer):
    
    # 🖊 CAMBIO CRÍTICO: De IntegerField a SerializerMethodField
    enrolled_count = serializers.SerializerMethodField() 
    
    is_full = serializers.BooleanField(read_only=True)
    modality_display = serializers.CharField(source='get_modality_display', read_only=True)
    status_name = serializers.CharField(source='get_status_display', read_only=True)
    
    # 🔧 REFACTOR: Instructor como campo editable + campos de solo lectura para display
    instructor = serializers.PrimaryKeyRelatedField(
        queryset=Person.objects.all(),
        required=False,
        allow_null=True
    )
    instructor_id = serializers.IntegerField(source='instructor.id', read_only=True, allow_null=True)
    instructor_name = serializers.CharField(source='instructor.__str__', read_only=True, allow_null=True)
    instructor_id_document = serializers.SerializerMethodField()
    
    # Anidaciones (para la vista de detalle)
    resources = CourseResourceSerializer(many=True, read_only=True)
    sessions = CourseSessionSerializer(many=True, read_only=True)
    modules = CourseModuleSerializer(many=True, read_only=True)  # 🆕 NEW: Hierarchical content
    
    # SerializerMethodField (Solo estudiantes ahora)
    students = serializers.SerializerMethodField()

    class Meta:
        model = Course
        fields = '__all__'
    
    # --- MÉTODO PARA CALCULAR EL CUPO OFICIAL ---
    def get_enrolled_count(self, obj):
        """
        Calcula el número de estudiantes que ocupan un cupo oficialmente (Inscrito).
        🔧 REFACTOR: Todos los participants son estudiantes ahora.
        """
        return obj.participants.filter(
            enrollment_status=CourseParticipant.EnrollmentStatus.ENROLLED
        ).count()
    
    # 🖊 INTEGRACIÓN DE LIMPIEZA Y UNICIDAD EN EL MODELO PRINCIPAL 🖊
    def validate_name(self, value):
        cleaned_value = title_case_cleaner(validate_text_with_spaces(value, 'Nombre'))
        validate_min_length(cleaned_value, 2)
        return check_uniqueness(Course, 'name', cleaned_value, self.instance, error_msg="Ya existe un curso con este nombre.")

    def validate_description(self, value):
        return sentence_case_cleaner(value)

    def validate(self, data):
        """
        Validación: Para cursos privados con departamento,
        max_participants debe ser >= número de empleados activos del departamento.
        """
        is_public = data.get('is_public', getattr(self.instance, 'is_public', True))
        department = data.get('department', getattr(self.instance, 'department', None))
        max_participants = data.get('max_participants', getattr(self.instance, 'max_participants', 20))
        
        # Solo validamos si es un curso privado con departamento asignado
        if not is_public and department:
            from employment.models import Employment
            
            # Contar empleados activos únicos del departamento
            active_person_ids = Employment.objects.filter(
                current_status__in=['ACT', 'SUS', 'PER', 'REP'],
                position__department=department
            ).values_list('person_id', flat=True).distinct()
            
            active_employees_count = len(set(active_person_ids))
            
            if max_participants < active_employees_count:
                raise serializers.ValidationError({
                    'max_participants': f'El cupo máximo ({max_participants}) no puede ser menor que el número de empleados activos del departamento ({active_employees_count}).'
                })
        
        return data
    
    @transaction.atomic
    def create(self, validated_data):
        """
        Crea el curso y, si es privado con departamento,
        auto-inscribe a todos los empleados activos del departamento.
        """
        course = super().create(validated_data)
        
        # Auto-inscripción para cursos privados con departamento
        if not course.is_public and course.department:
            from employment.models import Employment
            
            # Obtener personas únicas con contratos activos en el departamento
            active_person_ids = Employment.objects.filter(
                current_status__in=['ACT', 'SUS', 'PER', 'REP'],
                position__department=course.department
            ).values_list('person_id', flat=True).distinct()
            
            # Obtener las personas únicas
            unique_person_ids = set(active_person_ids)
            
            # Crear participantes (auto-inscritos)
            participants_to_create = []
            for person_id in unique_person_ids:
                # Verificar que no exista ya (defensa)
                if not CourseParticipant.objects.filter(course=course, person_id=person_id).exists():
                    participants_to_create.append(
                        CourseParticipant(
                            course=course,
                            person_id=person_id,
                            enrollment_status=CourseParticipant.EnrollmentStatus.ENROLLED
                        )
                    )
            
            # Bulk create para eficiencia
            if participants_to_create:
                CourseParticipant.objects.bulk_create(participants_to_create)
        
        return course
    
    def save(self, **kwargs):
        if 'name' in self.validated_data:
            self.validated_data['name'] = title_case_cleaner(self.validated_data['name'])
        if 'description' in self.validated_data:
            self.validated_data['description'] = sentence_case_cleaner(self.validated_data['description'])
        return super().save(**kwargs)

    def get_students(self, obj):
        # 🔧 REFACTOR: Todos los participants son estudiantes ahora
        qs = obj.participants.select_related('person')
        return ParticipantListSerializer(qs, many=True).data

    def get_instructor_id_document(self, obj):
        if not obj.instructor:
            return None
        primary_id = obj.instructor.national_ids.filter(is_primary=True).first()
        if primary_id:
            return f"{primary_id.document_type}-{primary_id.number}"
        return "S/C"
</file>

<file path="frontend2/components/layout/sidebar.tsx">
"use client";

import { useState } from "react";
import Link from "next/link";
import { usePathname } from "next/navigation";
import {
    LayoutDashboard,
    Users,
    Network,
    GraduationCap,
    Briefcase,
    ClipboardCheck,
    Settings,
    ChevronRight,
    ChevronDown,
    Circle,
    ContactRound,
    Building2,
    Calculator,
    Clock,
    PiggyBank,
    Gauge,
    TrendingUpDown,
    BookOpenText,
    ClipboardList,
    BookOpen,
    Crown,
    User,
    IdCard,
} from "lucide-react";
import { cn } from "@/lib/utils";
import { IutirlaLogo } from "../iutirla-logo";

interface SidebarProps {
    collapsed: boolean;
    role?: "admin" | "employee";
}

// Interfaz recursiva para soportar múltiples niveles de anidamiento
interface MenuItem {
    label: string;
    icon: React.ElementType;
    href?: string;
    adminOnly?: boolean;
    badge?: {
        text: string;
        variant: "primary" | "secondary" | "tertiary";
    };
    children?: MenuItem[];
}

// Menú unificado - Administrador primero si es admin
const menuItems: MenuItem[] = [
    // Opciones de administrador (solo visibles para admins) - PRIMERO
    {
        label: "Administrador",
        icon: Crown,
        adminOnly: true,
        children: [
            { label: "Dashboard", href: "/admin/dashboard", icon: LayoutDashboard },
            {
                label: "Personal",
                icon: Users,
                children: [
                    { label: "Empleados", href: "/admin/personnel/employees", icon: Circle },
                    { label: "Todas las personas", href: "/admin/personnel/people", icon: Circle },
                ],
            },
            { label: "Organización", href: "/admin/organization", icon: Network },
            {
                label: "Capacitación",
                href: "/admin/training",
                icon: GraduationCap,
            },
            {
                label: "Reclutamiento",
                icon: Briefcase,
                children: [
                    { label: "Vacantes", href: "/admin/ats/jobs", icon: Circle },
                    { label: "Candidatos", href: "/admin/ats/candidates", icon: Circle },
                ],
            },
            {
                label: "Evaluación",
                icon: Gauge,
                children: [
                    { label: "Períodos", href: "/admin/performance/periods", icon: Circle },
                    { label: "Competencias", href: "/admin/performance/competencies", icon: Circle },
                ],
            },
            {
                label: "Configuración",
                icon: Settings,
                children: [
                    { label: "Generales", href: "/admin/config/general", icon: Circle },
                    { label: "Talento", href: "/admin/config/talent", icon: Circle },
                ],
            },
        ],
    },
    // Opciones de empleado (visibles para todos)
    {
        label: "Mi Expediente",
        icon: IdCard,
        children: [
            { label: "Perfil de Talento", href: "/employee/talent-profile", icon: Circle },
            { label: "Datos Personales", href: "/employee/personal-data", icon: Circle },
            { label: "Datos del Puesto", href: "/employee/job-data", icon: Circle },
        ],
    },
    { label: "Organigrama", href: "/org-chart", icon: Network },
    {
        label: "Mi Desempeño",
        href: "/performance",
        icon: Gauge,
    },
    {
        label: "Departamentos",
        href: "/departments",
        icon: Users,
    },
    {
        label: "Capacitación",
        href: "/training",
        icon: BookOpen,
    },
];

export function SidebarContent({ collapsed, role = "admin" }: { collapsed: boolean; role?: "admin" | "employee" }) {
    const [expandedItems, setExpandedItems] = useState<string[]>(["Personal"]);
    const pathname = usePathname();
    const isAdmin = role === "admin";

    // Filtrar items según rol: si es admin muestra todo, si no solo los que no son adminOnly
    const filteredMenuItems = menuItems.filter(item => isAdmin || !item.adminOnly);

    const toggleItem = (label: string) => {
        setExpandedItems(prev =>
            prev.includes(label)
                ? prev.filter(item => item !== label)
                : [...prev, label]
        );
    };

    const getBadgeClasses = (variant: "primary" | "secondary" | "tertiary") => {
        switch (variant) {
            case "primary":
                return "bg-brand-primary text-brand-primary-foreground";
            case "secondary":
                return "bg-brand-secondary text-brand-secondary-foreground";
            case "tertiary":
                return "bg-brand-tertiary text-brand-tertiary-foreground";
        }
    };

    const isActive = (href: string) => pathname === href || pathname?.startsWith(href + "/");

    // Función recursiva para verificar si algún hijo está activo
    const isChildActive = (children: MenuItem[]): boolean => {
        return children.some(child => {
            if (child.href && isActive(child.href)) return true;
            if (child.children) return isChildActive(child.children);
            return false;
        });
    };

    return (
        <div className="flex flex-col h-full">
            {/* Sidebar Header (Brand) */}
            <div className="h-14 flex items-center border-b border-border shrink-0 overflow-hidden transition-all duration-300">
                <div className="flex items-center h-full w-full transition-all duration-300">
                    <IutirlaLogo collapsed={collapsed} />
                </div>
            </div>

            {/* Navigation */}
            <nav className={cn("overflow-y-auto overflow-x-hidden flex-1 my-2")}>
                <ul className="space-y-1">
                    {filteredMenuItems.map((item, index) => {
                        const isExpanded = expandedItems.includes(item.label);
                        const hasChildren = item.children && item.children.length > 0;
                        const isLink = !hasChildren && item.href;

                        // Determine active states
                        const isItemActive = isLink && item.href ? isActive(item.href) : false;
                        const isParentActive = hasChildren && item.children ? isChildActive(item.children) : false;

                        const ItemContent = (
                            <>
                                <div className={cn(
                                    "w-12 flex items-center justify-center shrink-0 transition-colors self-stretch",
                                    isItemActive ? "text-white" : (isParentActive ? "text-brand-primary" : "text-muted-foreground")
                                )}>
                                    <item.icon className="size-5" />
                                </div>

                                {!collapsed && (
                                    <div className="flex-1 flex items-center min-w-0 pr-3 py-2.5">
                                        <span className={cn(
                                            "flex-1 text-sm text-left font-medium truncate",
                                            isItemActive ? "text-white" : (isParentActive ? "text-brand-primary" : "text-foreground")
                                        )}>
                                            {item.label}
                                        </span>

                                        {item.badge && (
                                            <span className={cn(
                                                "px-2 py-0.5 rounded-full text-[10px] font-bold ml-2",
                                                getBadgeClasses(item.badge.variant)
                                            )}>
                                                {item.badge.text}
                                            </span>
                                        )}

                                        {hasChildren && (
                                            <div className={cn(
                                                "ml-2",
                                                isParentActive ? "text-brand-primary" : "text-muted-foreground"
                                            )}>
                                                {isExpanded ? (
                                                    <ChevronDown className="size-4" />
                                                ) : (
                                                    <ChevronRight className="size-4" />
                                                )}
                                            </div>
                                        )}
                                    </div>
                                )}

                                {/* Tooltip for collapsed state */}
                                {collapsed && (
                                    <div className="absolute left-full ml-2 px-3 py-2 bg-card border border-border rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all whitespace-nowrap z-50 top-0">
                                        <span className="text-sm text-foreground font-medium">
                                            {item.label}
                                        </span>
                                        {item.badge && (
                                            <span className={cn(
                                                "ml-2 px-2 py-0.5 rounded-full text-[10px] font-bold",
                                                getBadgeClasses(item.badge.variant)
                                            )}>
                                                {item.badge.text}
                                            </span>
                                        )}
                                    </div>
                                )}
                            </>
                        );

                        const itemClasses = cn(
                            "flex items-center transition-colors relative group min-h-[44px] mx-2 rounded-lg w-[calc(100%-16px)] cursor-pointer",
                            isItemActive
                                ? "bg-brand-primary hover:bg-brand-primary/90"
                                : (isParentActive
                                    ? "bg-brand-primary/10 hover:bg-brand-primary/20"
                                    : "hover:bg-accent"),
                            isExpanded && hasChildren && !isParentActive && "bg-muted"
                        );

                        return (
                            <li key={index}>
                                {/* Parent Item */}
                                {isLink ? (
                                    <Link href={item.href!} className={itemClasses} title={collapsed ? item.label : undefined}>
                                        {ItemContent}
                                    </Link>
                                ) : (
                                    <button
                                        onClick={() => hasChildren && toggleItem(item.label)}
                                        className={itemClasses}
                                        title={collapsed ? item.label : undefined}
                                    >
                                        {ItemContent}
                                    </button>
                                )}

                                {/* Children Items */}
                                {hasChildren && isExpanded && (
                                    <ul className="mt-1 space-y-1">
                                        {item.children?.map((child, childIndex) => {
                                            const childHasChildren = child.children && child.children.length > 0;
                                            const isChildLink = !childHasChildren && child.href;
                                            const isChildItemActive = isChildLink && child.href ? isActive(child.href) : false;
                                            const isChildExpanded = expandedItems.includes(child.label);
                                            const isChildParentActive = childHasChildren && child.children ? isChildActive(child.children) : false;

                                            const childClasses = cn(
                                                "flex items-center transition-colors relative group min-h-[44px] mx-2 rounded-lg w-[calc(100%-16px)] cursor-pointer",
                                                isChildItemActive
                                                    ? "bg-brand-primary hover:bg-brand-primary/90"
                                                    : isChildParentActive
                                                        ? "bg-brand-primary/10 hover:bg-brand-primary/20"
                                                        : "hover:bg-accent",
                                                isChildExpanded && childHasChildren && !isChildParentActive && "bg-muted"
                                            );

                                            return (
                                                <li key={childIndex}>
                                                    {isChildLink ? (
                                                        <Link href={child.href!} className={childClasses}>
                                                            <div className={cn(
                                                                "w-12 flex items-center justify-center shrink-0 transition-colors self-stretch",
                                                                isChildItemActive ? "text-white" : "text-muted-foreground"
                                                            )}>
                                                                <child.icon className="size-5" />
                                                            </div>
                                                            {!collapsed && (
                                                                <span className={cn(
                                                                    "flex-1 text-sm text-left font-medium truncate",
                                                                    isChildItemActive ? "text-white" : "text-foreground"
                                                                )}>
                                                                    {child.label}
                                                                </span>
                                                            )}
                                                        </Link>
                                                    ) : (
                                                        <>
                                                            <button
                                                                onClick={() => toggleItem(child.label)}
                                                                className={childClasses}
                                                            >
                                                                <div className={cn(
                                                                    "w-12 flex items-center justify-center shrink-0 transition-colors self-stretch",
                                                                    isChildParentActive ? "text-brand-primary" : "text-muted-foreground"
                                                                )}>
                                                                    <child.icon className="size-5" />
                                                                </div>
                                                                {!collapsed && (
                                                                    <div className="flex-1 flex items-center min-w-0 pr-3 py-2">
                                                                        <span className={cn(
                                                                            "flex-1 text-sm text-left font-medium truncate",
                                                                            isChildParentActive ? "text-brand-primary" : "text-foreground"
                                                                        )}>
                                                                            {child.label}
                                                                        </span>
                                                                        <div className={cn(
                                                                            "ml-2",
                                                                            isChildParentActive ? "text-brand-primary" : "text-muted-foreground"
                                                                        )}>
                                                                            {isChildExpanded ? (
                                                                                <ChevronDown className="size-4" />
                                                                            ) : (
                                                                                <ChevronRight className="size-4" />
                                                                            )}
                                                                        </div>
                                                                    </div>
                                                                )}
                                                            </button>

                                                            {/* Tercer nivel de hijos */}
                                                            {childHasChildren && isChildExpanded && (
                                                                <ul className="mt-1 space-y-1">
                                                                    {child.children?.map((grandChild, grandChildIndex) => {
                                                                        const isGrandChildActive = grandChild.href ? isActive(grandChild.href) : false;

                                                                        return (
                                                                            <li key={grandChildIndex}>
                                                                                <Link
                                                                                    href={grandChild.href || "#"}
                                                                                    className={cn(
                                                                                        "flex items-center transition-colors relative group min-h-[44px] mx-2 rounded-lg w-[calc(100%-16px)]",
                                                                                        isGrandChildActive
                                                                                            ? "bg-brand-primary hover:bg-brand-primary/90"
                                                                                            : "hover:bg-accent"
                                                                                    )}
                                                                                >
                                                                                    <div className={cn(
                                                                                        "w-12 flex items-center justify-center shrink-0 transition-colors self-stretch",
                                                                                        isGrandChildActive ? "text-white" : "text-muted-foreground"
                                                                                    )}>
                                                                                        <grandChild.icon className="size-5" />
                                                                                    </div>
                                                                                    {!collapsed && (
                                                                                        <span className={cn(
                                                                                            "flex-1 text-sm text-left font-medium truncate",
                                                                                            isGrandChildActive ? "text-white" : "text-foreground"
                                                                                        )}>
                                                                                            {grandChild.label}
                                                                                        </span>
                                                                                    )}
                                                                                </Link>
                                                                            </li>
                                                                        );
                                                                    })}
                                                                </ul>
                                                            )}
                                                        </>
                                                    )}
                                                </li>
                                            );
                                        })}
                                    </ul>
                                )}
                            </li>
                        );
                    })}
                </ul>
            </nav>
        </div>
    );
}

export function Sidebar({ collapsed, role = "admin" }: SidebarProps) {
    const [isHovered, setIsHovered] = useState(false);
    const isEffectiveCollapsed = collapsed && !isHovered;

    return (
        <aside
            className={cn(
                "fixed left-0 top-0 h-screen bg-card border-r border-border transition-all duration-300 z-40 overflow-hidden flex flex-col shadow-[6px_0_15px_-4px_rgba(0,0,0,0.15)]",
                isEffectiveCollapsed ? "w-16" : "w-64"
            )}
            onMouseEnter={() => setIsHovered(true)}
            onMouseLeave={() => setIsHovered(false)}
        >
            <SidebarContent collapsed={isEffectiveCollapsed} role={role} />
        </aside>
    );
}
</file>

<file path="backend/employment/serializers.py">
from rest_framework import serializers
from django.db.models import Q
from django.utils import timezone
from django.db import transaction
from core.serializers import check_uniqueness, title_case_cleaner, validate_text_with_spaces, validate_min_length
# Importamos utilidades y modelos necesarios de las apps correctas:
from organization.models import Position 
from .models import (
    Employment, EmploymentStatusLog, EmploymentDepartmentRole, PersonDepartmentRole,
    is_active_status, EmploymentStatusChoices, HierarchicalRoleChoices
)

# --- Serializer de Status Log ---

class EmploymentStatusLogSerializer(serializers.ModelSerializer):
    # Muestra el nombre del estatus en lugar del código
    status_name = serializers.CharField(source='get_status_display', read_only=True)
    
    class Meta:
        model = EmploymentStatusLog
        fields = '__all__'

    def validate(self, data):
        start_date = data.get('start_date')
        end_date = data.get('end_date')
        if start_date and end_date and end_date < start_date:
            raise serializers.ValidationError({
                "end_date": "La fecha de fin del estatus no puede ser anterior a la fecha de inicio."
            })
        return data

# --- SERIALIZADOR DE ESCRITURA Y LECTURA ÚNICA (Employment) ---

class EmploymentSerializer(serializers.ModelSerializer):
    person_full_name = serializers.SerializerMethodField()
    person_document = serializers.SerializerMethodField()
    user_account_details = serializers.SerializerMethodField()
    status_logs = EmploymentStatusLogSerializer(many=True, read_only=True)
    supervisor_info = serializers.SerializerMethodField()
    
    # Para mostrar el nombre del estatus en lectura
    current_status_display = serializers.CharField(source='get_current_status_display', read_only=True)
    role_display = serializers.CharField(source='get_role_display', read_only=True)
    employment_type_display = serializers.CharField(source='get_employment_type_display', read_only=True)
    
    position_full_name = serializers.SerializerMethodField()
    department_name = serializers.SerializerMethodField()
    position_full_name = serializers.SerializerMethodField()
    department_name = serializers.SerializerMethodField()
    department_id = serializers.SerializerMethodField()
    person_photo = serializers.SerializerMethodField()

    class Meta:
        model = Employment
        fields = '__all__' 

    def validate(self, data):
        # 1. RECUPERACIÓN DE DATOS (Para Create y Update)
        hire_date = data.get('hire_date')
        end_date = data.get('end_date')
        
        # Recuperamos los objetos completos (DRF convierte los IDs en Objetos aquí)
        person = data.get('person') or (self.instance.person if self.instance else None)
        position = data.get('position') or (self.instance.position if self.instance else None)
        current_status = data.get('current_status') or (self.instance.current_status if self.instance else None)
        
        if self.instance:
            hire_date = hire_date or self.instance.hire_date

        # 2. VALIDACIONES DE FECHA (Mantenidas)
        if end_date and hire_date and end_date < hire_date:
            raise serializers.ValidationError({"end_date": "La fecha de finalización no puede ser anterior a la fecha de contratación."})
        
        if person and person.birthdate and hire_date:
             if hire_date < person.birthdate:
                raise serializers.ValidationError({"hire_date": "La fecha de contratación no puede ser anterior a la fecha de nacimiento."})

        # ---------------------------------------------------------------------
        # 3. NUEVA VALIDACIÓN: INTEGRIDAD DE CONTRATO (NO DUPLICAR ACTIVOS)
        # ---------------------------------------------------------------------
        # Si tenemos estatus y este estatus "ocupa silla" (es activo/vigente)...
        if person and position and current_status and is_active_status(current_status):
            
            # Buscamos si hay OTROS contratos vigentes para esta misma persona y cargo
            all_employments = Employment.objects.filter(
                person=person,
                position=position,
            )
            
            # Si estamos editando, nos excluimos a nosotros mismos de la búsqueda
            if self.instance:
                all_employments = all_employments.exclude(pk=self.instance.pk)

            # Filtrar solo los activos usando helper function
            duplicates = [e for e in all_employments if is_active_status(e.current_status)]

            if duplicates:
                # Obtenemos el estatus del conflicto para ser específicos en el mensaje
                conflict_status = duplicates[0].get_current_status_display()
                raise serializers.ValidationError({
                    "current_status": f"Esta persona ya tiene un contrato vigente ({conflict_status}) en este cargo. Debe finalizar el anterior antes de activar este."
                })

        # ---------------------------------------------------------------------
        # 4. CONTROL DE VACANTES (Optimizado con is_active_status)
        # ---------------------------------------------------------------------
        # Solo validamos si cambiamos de posición o es nuevo registro
        if position and (not self.instance or self.instance.position != position):
            
            position_obj = position # Ya es el objeto Position gracias a DRF
            
            # Contamos cuántos empleados están ocupando esa posición (usando la bandera booleana)
            all_position_employments = Employment.objects.filter(position=position_obj)
            
            # Nota: No necesitamos restar 1 manualmente si usamos exclude(pk) correctamente
            if self.instance:
                all_position_employments = all_position_employments.exclude(pk=self.instance.pk)
            
            # Contamos solo los activos
            current_occupancy = sum(1 for e in all_position_employments if is_active_status(e.current_status))
            max_vacancies = position_obj.vacancies
            
            if current_occupancy >= max_vacancies:
                raise serializers.ValidationError({
                    'position': f'La posición "{str(position_obj)}" está completa ({current_occupancy}/{max_vacancies}). No hay vacantes disponibles.'
                })
        
        return data

    def get_person_full_name(self, obj):
        return str(obj.person) if obj.person else "Desconocido"

    def get_person_document(self, obj):
        if obj.person:
            doc = obj.person.national_ids.filter(is_primary=True).first()
            if doc:
                return f"{doc.document_type}-{doc.number}"
        return "Sin Documento"

    def get_user_account_details(self, obj):
        if obj.person and hasattr(obj.person, 'user_account'):
            user = obj.person.user_account
            return {
                'id': user.id,
                'username': user.username,
                'is_active': user.is_active,
                'is_staff': user.is_staff
            }
        return None

    def get_supervisor_info(self, obj):
        if not obj.position:
            return None

        # Support for ManyToMany manager_positions
        boss_positions = obj.position.manager_positions.all()
        
        if not boss_positions.exists():
            return None

        # Iterate through all boss positions to find an active boss
        for boss_position in boss_positions:
            boss_employments = boss_position.employments.all()
            
            for emp in boss_employments:
                if is_active_status(emp.current_status):
                    return {
                        "id": emp.person.id,
                        "name": str(emp.person),
                        "position": boss_position.title
                    }
        
        # If boss positions exist but no one is active
        first_boss_pos = boss_positions.first()
        return {
            "id": None,
            "name": "VACANTE",
            "position": first_boss_pos.title if first_boss_pos else "Sin Jefe"
        }

    def get_position_full_name(self, obj):
        """Resuelve el nombre del cargo (Position)."""
        if obj.position and obj.position.job_title:
            return obj.position.job_title.name
        return str(obj.position) if obj.position else "Sin Cargo Asignado"

    def get_department_name(self, obj):
        """Resuelve el nombre del Departamento a través de la Posición."""
        if obj.position and obj.position.department:
            return obj.position.department.name
        return "N/A"

    def get_department_id(self, obj):
        """Resuelve el ID del Departamento a través de la Posición."""
        if obj.position and obj.position.department:
            return obj.position.department.id
        return None

    def get_person_photo(self, obj):
        """Retorna la URL de la foto de la persona si existe."""
        if obj.person and obj.person.photo:
            request = self.context.get('request')
            if request:
                return request.build_absolute_uri(obj.person.photo.url)
            return obj.person.photo.url
        return None


# --- SERIALIZADOR DE ROLES JERÁRQUICOS EN DEPARTAMENTO ---

class EmploymentDepartmentRoleSerializer(serializers.ModelSerializer):
    # Campos de lectura para mostrar información detallada
    employment_person_name = serializers.CharField(source='employment.person.full_name', read_only=True)
    department_name = serializers.CharField(source='department.name', read_only=True)
    hierarchical_role_display = serializers.CharField(source='get_hierarchical_role_display', read_only=True)
    is_current = serializers.BooleanField(read_only=True)
    
    class Meta:
        model = EmploymentDepartmentRole
        fields = '__all__'
    
    def validate(self, data):
        """Validaciones personalizadas"""
        employment = data.get('employment')
        department = data.get('department')
        start_date = data.get('start_date')
        end_date = data.get('end_date')
        hierarchical_role = data.get('hierarchical_role')
        
        # 1. Validar que el departamento coincide con el del employment
        # 1. Validar que el departamento coincide con el del employment - REMOVED for Matrix Support
        # if employment and department:
        #     if employment.position and employment.position.department != department:
        #         raise serializers.ValidationError({
        #             'department': f'El departamento debe coincidir con el departamento de la posición del empleado ({employment.position.department.name})'
        #         })
        
        # 2. Validar que end_date sea posterior a start_date
        if start_date and end_date and end_date < start_date:
            raise serializers.ValidationError({
                'end_date': 'La fecha de fin debe ser posterior a la fecha de inicio'
            })
        
        # 3. Validar que no exista otro rol activo para el mismo employment y department
        if employment and department:
            # Obtener el ID de la instancia actual (en caso de UPDATE)
            instance_pk = self.instance.pk if self.instance else None
            
            # Buscar roles activos (sin end_date o con end_date futuro)
            existing_active_roles = EmploymentDepartmentRole.objects.filter(
                employment=employment,
                department=department,
                end_date__isnull=True
            ).exclude(pk=instance_pk)
            
            if existing_active_roles.exists():
                raise serializers.ValidationError({
                    'employment': 'Ya existe un rol jerárquico activo para este empleado en este departamento'
                })
        
        # 4. VALIDACIÓN DE UNICIDAD ACTIVA PARA GERENTES
        # Solo se aplica si el rol es Gerente (MGR)
        if hierarchical_role == HierarchicalRoleChoices.MANAGER and department:
            instance_pk = self.instance.pk if self.instance else None
            today = timezone.now().date()
            
            # Buscar otros gerentes activos en el mismo departamento
            # Un rol está activo si: end_date es NULL O end_date >= hoy
            existing_active_manager = EmploymentDepartmentRole.objects.filter(
                department=department,
                hierarchical_role=HierarchicalRoleChoices.MANAGER
            ).filter(
                Q(end_date__isnull=True) | Q(end_date__gte=today)
            ).exclude(pk=instance_pk).select_related('employment__person').first()
            
            if existing_active_manager:
                conflict_person_name = existing_active_manager.employment.person.full_name
                department_name = department.name
                raise serializers.ValidationError({
                    'hierarchical_role': f'El Departamento {department_name} ya tiene un Gerente activo ({conflict_person_name}). Finalice el rol anterior antes de asignar uno nuevo.'
                })
        
        return data
    

    @transaction.atomic
    def create(self, validated_data):
        # 🚨 ¡CAMBIO CLAVE! 🚨
        # No hacemos nada con el status aquí. El modelo Employment se encarga de:
        # 1. Guardar el registro.
        # 2. Llamar a su save() (que a su vez llama a full_clean()).
        # 3. Llamar a _create_status_log() automáticamente.
        
        employment = super().create(validated_data)
        
        # Nota: Si tu frontend envía el 'end_date' a NULL, el estatus por defecto 'Activo' 
        # y el log se crean.
        
        return employment
    
    def get_user_account_details(self, obj):
        """
        Retorna detalles básicos del usuario si existe.
        """
        if obj.person and hasattr(obj.person, 'user_account'):
            user = obj.person.user_account
            return {
                'id': user.id,
                'username': user.username,
                'is_active': user.is_active,
                'is_staff': user.is_staff
            }
        return None
    
    def get_person_full_name(self, obj):
        return str(obj.person) if obj.person else "Desconocido"

    def get_person_document(self, obj):
        """
        Busca el documento principal (Cédula) de la persona asociada.
        """
        if obj.person:
            # Usamos la relación inversa 'national_ids' definida en core.models
            doc = obj.person.national_ids.filter(is_primary=True).first()
            if doc:
                return f"{doc.document_type}-{doc.number}"
        return "Sin Documento"
    
    def get_supervisor_info(self, obj):
        """
        Retorna el nombre y cargo del jefe inmediato.
        Lógica: Mi Cargo -> Cargo Jefe -> Persona Activa en Cargo Jefe
        """
        # 1. Validar que tenga posición y esa posición tenga un jefe definido
        
        if not obj.position or not obj.position.manager_position:
            return None

        boss_position = obj.position.manager_position

        # 2. Buscar quién ocupa la posición del jefe HOY (Activo y Vigente)
        boss_employments = boss_position.employments.all()
        
        # Filtrar manualmente usando helper function
        active_boss = None
        for emp in boss_employments:
            if is_active_status(emp.current_status):
                active_boss = emp
                break

        if active_boss:
            return {
                "id": active_boss.person.id,
                "name": str(active_boss.person),
                "position": boss_position.name
            }
        
        # Existe el cargo de jefe (ej. Gerente), pero nadie lo ocupa (Vacante)
        return {
            "id": None,
            "name": "VACANTE",
            "position": boss_position.name
        }

# --- SERIALIZADOR DE LISTADO (Ajustado) ---

class EmployeeListSerializer(serializers.ModelSerializer):
    
    person_full_name = serializers.SerializerMethodField()
    person_document = serializers.SerializerMethodField()
    position_full_name = serializers.SerializerMethodField()
    department_name = serializers.SerializerMethodField()
    
    # Mostrar el display name en lugar del código
    current_status_display = serializers.CharField(source='get_current_status_display', read_only=True)
    role_display = serializers.CharField(source='get_role_display', read_only=True)
    employment_type_display = serializers.CharField(source='get_employment_type_display', read_only=True)

    class Meta:
        model = Employment
        fields = '__all__' 

    # --- MÉTODOS CORREGIDOS ---
    
    def get_person_full_name(self, obj):
        """Resuelve el nombre completo de core.Person."""
        # Se asegura de que si la persona existe, usa su __str__ (nombre y apellido)
        return str(obj.person) if obj.person else "Persona Desconocida"

    def get_person_document(self, obj):
        """
        Busca el documento principal (Cédula) de la persona asociada.
        """
        if obj.person:
            # Usamos la relación inversa 'national_ids' definida en core.models
            doc = obj.person.national_ids.filter(is_primary=True).first()
            if doc:
                return f"{doc.document_type}-{doc.number}"
        return "Sin Documento"

    def get_position_full_name(self, obj):
        """Resuelve el nombre del cargo (Position)."""
        # Usa solo el nombre del JobTitle como se solicitó
        if obj.position and obj.position.job_title:
            return obj.position.job_title.name
        return str(obj.position) if obj.position else "Sin Cargo Asignado"

    def get_department_name(self, obj):
        """Resuelve el nombre del Departamento a través de la Posición."""
        # Maneja la cadena de nulos: si no hay position O no hay department, retorna "N/A".
        if obj.position and obj.position.department:
            return obj.position.department.name
        return "N/A"


# --- SERIALIZADOR ESPECIALIZADO PARA DATOS DEL PUESTO (MY POSITION DATA) ---

class EmployeePositionDataSerializer(EmploymentSerializer):
    """
    Serializador extendido para la vista "Datos del Puesto" del empleado.
    Incluye detalles adicionales de la posición como Objetivo y Funciones.
    """
    position_objective = serializers.SerializerMethodField()
    position_functions = serializers.SerializerMethodField()
    
    class Meta:
        model = Employment
        fields = '__all__'  # Inherit all fields from parent, SerializerMethodFields are auto-added

    def get_position_objective(self, obj):
        if obj.position:
            return obj.position.objective
        return None

    def get_position_functions(self, obj):
        if obj.position:
            functions = obj.position.functions.all().order_by('order')
            return [f.description for f in functions]
        return []

# --- SERIALIZADOR DE ROLES JERÁRQUICOS POR PERSONA (MATRIZ) ---


class PersonDepartmentRoleSerializer(serializers.ModelSerializer):
    """
    Serializer para roles jerárquicos por persona en departamentos.
    Soporta organizaciones matriciales.
    """
    # Campos de lectura para mostrar información detallada
    person_name = serializers.CharField(source='person.full_name', read_only=True)
    department_name = serializers.CharField(source='department.name', read_only=True)
    hierarchical_role_display = serializers.CharField(source='get_hierarchical_role_display', read_only=True)
    is_current = serializers.BooleanField(read_only=True)
    
    class Meta:
        model = PersonDepartmentRole
        fields = '__all__'
    
    def validate(self, data):
        """
        Validaciones personalizadas:
        A) Unicidad de rol activo por persona+departamento
        B) Unicidad de gerente activo por departamento
        """
        person = data.get('person')
        department = data.get('department')
        start_date = data.get('start_date')
        end_date = data.get('end_date')
        hierarchical_role = data.get('hierarchical_role')
        
        instance_pk = self.instance.pk if self.instance else None
        today = timezone.now().date()
        
        # Validación básica: end_date posterior a start_date
        if start_date and end_date and end_date < start_date:
            raise serializers.ValidationError({
                'end_date': 'La fecha de fin debe ser posterior a la fecha de inicio'
            })
        
        # VALIDACIÓN A: Unicidad de rol activo por persona+departamento
        # Una persona solo puede tener UN rol activo en un departamento a la vez
        if person and department:
            existing_active_role = PersonDepartmentRole.objects.filter(
                person=person,
                department=department
            ).filter(
                Q(end_date__isnull=True) | Q(end_date__gte=today)
            ).exclude(pk=instance_pk).first()
            
            if existing_active_role:
                # NOTA: Esta validación permite la creación porque el método create()
                # auto-finalizará el rol anterior, pero advertimos al usuario
                pass  # La validación está deshabilitada para permitir auto-finalization
        
        # VALIDACIÓN B: Unicidad de gerente activo por departamento
        # Solo puede haber UN gerente activo por departamento
        if hierarchical_role == HierarchicalRoleChoices.MANAGER and department:
            existing_active_manager = PersonDepartmentRole.objects.filter(
                department=department,
                hierarchical_role=HierarchicalRoleChoices.MANAGER
            ).filter(
                Q(end_date__isnull=True) | Q(end_date__gte=today)
            ).exclude(pk=instance_pk).select_related('person').first()
            
            if existing_active_manager:
                conflict_person_name = existing_active_manager.person.full_name
                department_name = department.name
                raise serializers.ValidationError({
                    'hierarchical_role': f'El Departamento {department_name} ya tiene un Gerente activo ({conflict_person_name}). Finalice el rol anterior antes de asignar uno nuevo.'
                })
        
        return data
    
    @transaction.atomic
    def create(self, validated_data):
        """
        Lógica de auto-finalización de roles anteriores.
        
        Antes de crear un nuevo rol, busca cualquier rol activo para la
        misma persona+departamento y lo finaliza automáticamente estableciendo
        su end_date al día anterior del start_date del nuevo rol.
        """
        person = validated_data.get('person')
        department = validated_data.get('department')
        new_start_date = validated_data.get('start_date')
        
        # Buscar rol activo anterior para la misma persona+departamento
        existing_active_role = PersonDepartmentRole.objects.filter(
            person=person,
            department=department,
            end_date__isnull=True  # Solo los roles actualmente sin fin
        ).first()
        
        if existing_active_role:
            # Auto-finalizar el rol anterior estableciendo end_date al día anterior
            from datetime import timedelta
            existing_active_role.end_date = new_start_date - timedelta(days=1)
            existing_active_role.save()
        
        # Crear el nuevo rol
        new_role = PersonDepartmentRole.objects.create(**validated_data)
        return new_role
</file>

<file path="backend/organization/views.py">
from rest_framework import viewsets, permissions
from rest_framework.decorators import action
from rest_framework.response import Response
from django.db.models import Q
from .models import Department, JobTitle, Position, PositionRequirement, PositionFunction
from .serializers import DepartmentSerializer, JobTitleSerializer, PositionSerializer, PositionRequirementSerializer, PositionFunctionSerializer

from core.filters import UnaccentSearchFilter

class DepartmentViewSet(viewsets.ModelViewSet):
    queryset = Department.objects.all()
    serializer_class = DepartmentSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['name']
    
    @action(detail=False, methods=['get'], permission_classes=[permissions.IsAuthenticated])
    def my_departments(self, request):
        """
        Returns departments where the authenticated user has active employment.
        """
        from employment.models import Employment, is_active_status
        
        # Get user's active employments
        # User -> Person relationship uses related_name='user_account'
        active_employments = Employment.objects.filter(
            person__user_account=request.user
        ).select_related('position__department', 'position__job_title', 'person')
        
        # Filter only active employments
        active_employments = [emp for emp in active_employments if is_active_status(emp.current_status)]
        
        # Extract unique departments
        departments_data = []
        seen_dept_ids = set()
        
        for emp in active_employments:
            if emp.position and emp.position.department:
                dept = emp.position.department
                if dept.id not in seen_dept_ids:
                    seen_dept_ids.add(dept.id)
                    
                    # Find manager of this department
                    manager_info = None
                    # Look for positions marked as manager in this department
                    manager_positions = Position.objects.filter(
                        department=dept,
                        is_manager=True
                    ).select_related('job_title')
                    
                    for manager_pos in manager_positions:
                        # Find who currently occupies this manager position
                        manager_emps = Employment.objects.filter(
                            position=manager_pos
                        ).select_related('person')
                        
                        for manager_emp in manager_emps:
                            if is_active_status(manager_emp.current_status):
                                manager_info = {
                                    'name': str(manager_emp.person),
                                    'position': str(manager_pos)
                                }
                                break
                        if manager_info:
                            break
                    
                    departments_data.append({
                        'id': dept.id,
                        'name': dept.name,
                        'manager': manager_info,
                        'user_position': str(emp.position),
                    })
        
        return Response(departments_data)
    
        return Response(departments_data)
    
    @action(detail=False, methods=['get'], permission_classes=[permissions.IsAuthenticated])
    def institutional_chart(self, request):
        """
        Returns all departments for the organization chart with manager position and person info.
        """
        from employment.models import Employment, is_active_status
        
        departments = Department.objects.all()
        departments_data = []
        
        for dept in departments:
            # Serialize basic department data
            dept_serializer = DepartmentSerializer(dept)
            dept_data = dept_serializer.data
            
            # Find manager position for this department (show even if vacant)
            manager_position = None
            manager_info = None
            manager_pos = Position.objects.filter(
                department=dept,
                is_manager=True
            ).select_related('job_title').first()
            
            if manager_pos and manager_pos.job_title:
                manager_position = manager_pos.job_title.name
                
                # Find who currently occupies this position
                manager_emp = Employment.objects.filter(
                    position=manager_pos
                ).select_related('person').first()
                
                if manager_emp and is_active_status(manager_emp.current_status):
                    # Get absolute photo URL
                    photo_url = None
                    if manager_emp.person.photo:
                        photo_url = request.build_absolute_uri(manager_emp.person.photo.url)
                    
                    manager_info = {
                        'id': manager_emp.person.id,
                        'name': str(manager_emp.person),
                        'photo': photo_url,
                    }
            
            dept_data['manager_position'] = manager_position
            dept_data['manager_info'] = manager_info
            departments_data.append(dept_data)
        
        return Response(departments_data)
    
    @action(detail=False, methods=['post'], permission_classes=[permissions.IsAuthenticated], url_path='export-institutional-chart')
    def export_institutional_chart(self, request):
        """
        Exports provided SVG content to PDF or returns SVG for the institutional org chart.
        POST body: { "format": "svg" | "pdf", "svg_content": "<svg>..." }
        """
        from django.http import HttpResponse
        
        export_format = request.data.get('format', 'pdf')
        svg_content = request.data.get('svg_content', '')
        
        if not svg_content:
            return Response({'error': 'SVG content is required'}, status=400)
            
        if export_format == 'svg':
            response = HttpResponse(svg_content, content_type='image/svg+xml')
            response['Content-Disposition'] = 'attachment; filename="organigrama-institucional.svg"'
            return response
        else:  # pdf
            import cairosvg
            # Convert SVG to PDF
            pdf_bytes = cairosvg.svg2pdf(bytestring=svg_content.encode('utf-8'))
            
            response = HttpResponse(pdf_bytes, content_type='application/pdf')
            response['Content-Disposition'] = 'attachment; filename="organigrama-institucional.pdf"'
            return response

    @action(detail=True, methods=['get'], permission_classes=[permissions.IsAuthenticated], url_path='detail')
    def department_detail(self, request, pk=None):
        """
        Returns detailed department info including all positions and their current occupants.
        """
        from employment.models import Employment, is_active_status
        
        department = self.get_object()
        
        # Get all positions in this department
        positions = Position.objects.filter(
            department=department
        ).select_related('job_title').prefetch_related('manager_positions__job_title')
        
        positions_data = []
        manager_info = None
        
        for position in positions:
            # Get current occupants
            employments = Employment.objects.filter(
                position=position
            ).select_related('person').prefetch_related('person__emails')
            
            occupants = []
            for emp in employments:
                if is_active_status(emp.current_status):
                    # Get primary email
                    primary_email = emp.person.emails.filter(is_primary=True).first()
                    email = primary_email.email_address if primary_email else None
                    
                    # Get absolute photo URL
                    photo_url = None
                    if emp.person.photo:
                        photo_url = request.build_absolute_uri(emp.person.photo.url)
                    
                    occupants.append({
                        'id': emp.person.id,
                        'name': str(emp.person),
                        'email': email,
                        'photo': photo_url,
                        'hire_date': emp.hire_date,
                        'is_current_user': emp.person.user_account == request.user if emp.person.user_account else False
                    })
                    
                    # Track manager
                    if position.is_manager and not manager_info:
                        manager_info = {
                            'name': str(emp.person),
                            'position': position.job_title.name
                        }
            
            positions_data.append({
                'id': position.id,
                'name': position.job_title.name, # Solo el nombre del cargo
                'is_manager': position.is_manager,
                'vacancies': position.vacancies,
                'occupants': occupants,
                'manager_positions': [{'id': mp.id, 'name': mp.job_title.name} for mp in position.manager_positions.all()] # IDs y nombres para el organigrama
            })
        
        return Response({
            'id': department.id,
            'name': department.name,
            'manager': manager_info,
            'positions': positions_data
        })
    
    @action(detail=True, methods=['post'], permission_classes=[permissions.IsAuthenticated], url_path='export-org-chart')
    def export_org_chart(self, request, pk=None):
        """
        Exports provided SVG content to PDF or returns SVG.
        POST body: { "format": "svg" | "pdf", "svg_content": "<svg>..." }
        """
        from django.http import HttpResponse
        
        department = self.get_object()
        export_format = request.data.get('format', 'pdf')
        svg_content = request.data.get('svg_content', '')
        
        if not svg_content:
            return Response({'error': 'SVG content is required'}, status=400)
            
        if export_format == 'svg':
            response = HttpResponse(svg_content, content_type='image/svg+xml')
            response['Content-Disposition'] = f'attachment; filename="organigrama-{department.name}.svg"'
            return response
        else:  # pdf
            import cairosvg
            # Convert SVG to PDF
            pdf_bytes = cairosvg.svg2pdf(bytestring=svg_content.encode('utf-8'))
            
            response = HttpResponse(pdf_bytes, content_type='application/pdf')
            response['Content-Disposition'] = f'attachment; filename="organigrama-{department.name}.pdf"'
            return response

class JobTitleViewSet(viewsets.ModelViewSet):
    queryset = JobTitle.objects.all()
    serializer_class = JobTitleSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['name']

from django_filters.rest_framework import DjangoFilterBackend

class PositionViewSet(viewsets.ModelViewSet):
    queryset = Position.objects.all().select_related('department', 'job_title').prefetch_related('manager_positions', 'manager_positions__job_title', 'manager_positions__department')
    serializer_class = PositionSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    filter_backends = [DjangoFilterBackend, UnaccentSearchFilter]
    filterset_fields = ['department', 'is_manager']
    search_fields = ['job_title__name', 'department__name']

class PositionRequirementViewSet(viewsets.ModelViewSet):
    serializer_class = PositionRequirementSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    
    def get_queryset(self):
        position_id = self.kwargs.get('position_pk')
        if position_id:
            return PositionRequirement.objects.filter(position_id=position_id)
        return PositionRequirement.objects.all()
    
    def perform_create(self, serializer):
        position_id = self.kwargs.get('position_pk')
        serializer.save(position_id=position_id)

class PositionFunctionViewSet(viewsets.ModelViewSet):
    serializer_class = PositionFunctionSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    filter_backends = [DjangoFilterBackend]
    filterset_fields = ['position']
    
    def get_queryset(self):
        position_id = self.kwargs.get('position_pk')
        if position_id:
            return PositionFunction.objects.filter(position_id=position_id)
        return PositionFunction.objects.all()
    
    def perform_create(self, serializer):
        position_id = self.kwargs.get('position_pk')
        serializer.save(position_id=position_id)
</file>

<file path="frontend2/components/catalogs/data-table.tsx">
"use client"

import {
    ColumnDef,
    flexRender,
    getCoreRowModel,
    useReactTable,
    SortingState,
    getSortedRowModel,
    ColumnFiltersState,
    getFilteredRowModel,
    PaginationState,
    OnChangeFn,
} from "@tanstack/react-table"

import {
    Table,
    TableBody,
    TableCell,
    TableHead,
    TableHeader,
    TableRow,
} from "@/components/ui/table"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { useState, useEffect } from "react"
import { ChevronLeft, ChevronRight, ChevronsLeft, ChevronsRight } from "lucide-react"
import {
    Select,
    SelectContent,
    SelectItem,
    SelectTrigger,
    SelectValue,
} from "@/components/ui/select"

interface DataTableProps<TData, TValue> {
    columns: ColumnDef<TData, TValue>[]
    data: TData[]
    searchOptions?: { label: string; value: string }[]
    onSearchOptionChange?: (value: string) => void
    currentSearchOption?: string
    searchKey?: string
    rowCount?: number
    pagination?: PaginationState
    onPaginationChange?: OnChangeFn<PaginationState>
    onSearch?: (value: string) => void
    disablePagination?: boolean
}

export function DataTable<TData, TValue>({
    columns,
    data,
    searchKey,
    searchOptions,
    onSearchOptionChange,
    currentSearchOption,
    rowCount,
    pagination,
    onPaginationChange,
    onSearch,
    disablePagination,
}: DataTableProps<TData, TValue>) {
    const [sorting, setSorting] = useState<SortingState>([])
    const [columnFilters, setColumnFilters] = useState<ColumnFiltersState>([])
    const [searchValue, setSearchValue] = useState("")
    const [internalPagination, setInternalPagination] = useState<PaginationState>({
        pageIndex: 0,
        pageSize: 10,
    })

    const table = useReactTable({
        data,
        columns,
        getCoreRowModel: getCoreRowModel(),
        manualPagination: !!pagination, // Only manual if pagination prop is provided
        pageCount: rowCount && pagination ? Math.ceil(rowCount / pagination.pageSize) : -1,
        onSortingChange: setSorting,
        getSortedRowModel: getSortedRowModel(),
        onColumnFiltersChange: setColumnFilters,
        getFilteredRowModel: getFilteredRowModel(),
        onPaginationChange: onPaginationChange || setInternalPagination,
        state: {
            sorting,
            columnFilters,
            pagination: pagination || internalPagination,
        },
    })

    useEffect(() => {
        const timeoutId = setTimeout(() => {
            if (onSearch) {
                onSearch(searchValue)
            }
        }, 500)
        return () => clearTimeout(timeoutId)
    }, [searchValue, onSearch])

    return (
        <div className="flex flex-col gap-6">
            <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                {searchKey && (
                    <Input
                        placeholder="Buscar..."
                        value={searchValue}
                        onChange={(event) => setSearchValue(event.target.value)}
                        className="sm:max-w-sm w-full text-sm"
                    />
                )}
                {searchOptions && searchOptions.length > 0 && (
                    <Select
                        value={currentSearchOption}
                        onValueChange={(value) => onSearchOptionChange && onSearchOptionChange(value)}
                    >
                        <SelectTrigger className="w-full sm:w-[180px]">
                            <SelectValue placeholder="Buscar por..." />
                        </SelectTrigger>
                        <SelectContent>
                            {searchOptions.map((option) => (
                                <SelectItem key={option.value} value={option.value}>
                                    {option.label}
                                </SelectItem>
                            ))}
                        </SelectContent>
                    </Select>
                )}
            </div>
            <div className="rounded-md border overflow-hidden">
                <Table>
                    <TableHeader>
                        {table.getHeaderGroups().map((headerGroup) => (
                            <TableRow key={headerGroup.id} className="bg-primary hover:bg-primary">
                                {headerGroup.headers.map((header) => {
                                    return (
                                        <TableHead key={header.id} className="text-primary-foreground font-bold">
                                            {header.isPlaceholder
                                                ? null
                                                : flexRender(
                                                    header.column.columnDef.header,
                                                    header.getContext()
                                                )}
                                        </TableHead>
                                    )
                                })}
                            </TableRow>
                        ))}
                    </TableHeader>
                    <TableBody>
                        {table.getRowModel().rows?.length ? (
                            table.getRowModel().rows.map((row) => (
                                <TableRow
                                    key={row.id}
                                    data-state={row.getIsSelected() && "selected"}
                                >
                                    {row.getVisibleCells().map((cell) => (
                                        <TableCell key={cell.id}>
                                            {flexRender(cell.column.columnDef.cell, cell.getContext())}
                                        </TableCell>
                                    ))}
                                </TableRow>
                            ))
                        ) : (
                            <TableRow>
                                <TableCell colSpan={columns.length} className="h-24 text-center">
                                    No hay resultados.
                                </TableCell>
                            </TableRow>
                        )}
                    </TableBody>
                </Table>
            </div>
            {!disablePagination && table.getPageCount() > 1 && (
                <div className="flex items-center justify-between gap-2">
                    <div className="flex-1 text-sm font-medium">
                        Página {table.getState().pagination.pageIndex + 1} de{" "}
                        {table.getPageCount()}
                    </div>
                    <div className="flex items-center gap-4">
                        <div className="hidden items-center space-x-2 sm:flex">
                            <p className="text-sm font-medium">Filas por página</p>
                            <Select
                                value={`${table.getState().pagination.pageSize}`}
                                onValueChange={(value) => {
                                    table.setPageSize(Number(value))
                                }}
                            >
                                <SelectTrigger className="h-8 w-[70px]">
                                    <SelectValue placeholder={table.getState().pagination.pageSize} />
                                </SelectTrigger>
                                <SelectContent side="top">
                                    {[10, 20, 30, 40, 50].map((pageSize) => (
                                        <SelectItem key={pageSize} value={`${pageSize}`}>
                                            {pageSize}
                                        </SelectItem>
                                    ))}
                                </SelectContent>
                            </Select>
                        </div>
                        <div className="flex items-center justify-end gap-2">
                            <Button
                                variant="outline"
                                className="hidden h-8 w-8 p-0 lg:flex"
                                onClick={() => table.setPageIndex(0)}
                                disabled={!table.getCanPreviousPage()}
                            >
                                <span className="sr-only">Ir a la primera página</span>
                                <ChevronsLeft className="h-4 w-4" />
                            </Button>
                            <Button
                                variant="outline"
                                className="h-8 w-8 p-0"
                                onClick={() => table.previousPage()}
                                disabled={!table.getCanPreviousPage()}
                            >
                                <span className="sr-only">Ir a la página anterior</span>
                                <ChevronLeft className="h-4 w-4" />
                            </Button>
                            <Button
                                variant="outline"
                                className="h-8 w-8 p-0"
                                onClick={() => table.nextPage()}
                                disabled={!table.getCanNextPage()}
                            >
                                <span className="sr-only">Ir a la página siguiente</span>
                                <ChevronRight className="h-4 w-4" />
                            </Button>
                            <Button
                                variant="outline"
                                className="hidden h-8 w-8 p-0 lg:flex"
                                onClick={() => table.setPageIndex(table.getPageCount() - 1)}
                                disabled={!table.getCanNextPage()}
                            >
                                <span className="sr-only">Ir a la última página</span>
                                <ChevronsRight className="h-4 w-4" />
                            </Button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    )
}
</file>

<file path="frontend2/package.json">
{
  "name": "frontend2",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "@dnd-kit/core": "^6.3.1",
    "@dnd-kit/sortable": "^10.0.0",
    "@dnd-kit/utilities": "^3.2.2",
    "@heroicons/react": "^2.2.0",
    "@hookform/resolvers": "^5.2.2",
    "@radix-ui/react-accordion": "^1.2.12",
    "@radix-ui/react-alert-dialog": "^1.1.15",
    "@radix-ui/react-avatar": "^1.1.11",
    "@radix-ui/react-dialog": "^1.1.15",
    "@radix-ui/react-dropdown-menu": "^2.1.16",
    "@radix-ui/react-label": "^2.1.8",
    "@radix-ui/react-popover": "^1.1.15",
    "@radix-ui/react-progress": "^1.1.8",
    "@radix-ui/react-select": "^2.2.6",
    "@radix-ui/react-separator": "^1.1.8",
    "@radix-ui/react-slot": "^1.2.4",
    "@radix-ui/react-switch": "^1.2.6",
    "@radix-ui/react-tabs": "^1.1.13",
    "@tanstack/react-table": "^8.21.3",
    "axios": "^1.13.2",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "cmdk": "^1.1.1",
    "dagre": "^0.8.5",
    "date-fns": "^4.1.0",
    "embla-carousel-react": "^8.6.0",
    "html-to-image": "^1.11.13",
    "jspdf": "^3.0.4",
    "lucide-react": "^0.555.0",
    "next": "16.0.5",
    "next-themes": "^0.4.6",
    "react": "19.2.0",
    "react-day-picker": "^9.11.3",
    "react-dom": "19.2.0",
    "react-hook-form": "^7.67.0",
    "reactflow": "^11.11.4",
    "recharts": "^2.15.4",
    "sonner": "^2.0.7",
    "svg2pdf.js": "^2.6.0",
    "swr": "^2.3.7",
    "tailwind-merge": "^3.4.0",
    "zod": "^4.1.13"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/dagre": "^0.7.53",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "eslint": "^9",
    "eslint-config-next": "16.0.5",
    "tailwindcss": "^4",
    "tw-animate-css": "^1.4.0",
    "typescript": "^5"
  }
}
</file>

<file path="backend/core/models.py">
from django.db import models
from simple_history.models import HistoricalRecords

# Configuración base para mensajes de error
UNIQUE_ERR_MSG = {'unique': "Ya existe un registro con este nombre."}
ISO_UNIQUE_ERR_MSG = {'unique': "Ya existe un registro con este código ISO."}
CODE_UNIQUE_ERR_MSG = {'unique': "Ya existe un registro con este código."}
EMAIL_UNIQUE_ERR_MSG = {'unique': "Este correo electrónico ya está registrado."}

# --- CATÁLOGOS BÁSICOS ---
class Gender(models.Model):
    name = models.CharField(max_length=50, unique=True, error_messages=UNIQUE_ERR_MSG)
    def __str__(self): return self.name

class MaritalStatus(models.Model):
    name = models.CharField(max_length=50, unique=True, error_messages=UNIQUE_ERR_MSG)
    def __str__(self): return self.name

class Country(models.Model):
    name = models.CharField(max_length=100, unique=True, error_messages=UNIQUE_ERR_MSG)
    iso_2 = models.CharField(max_length=2, help_text="Ej: US, VE.", unique=True, error_messages=ISO_UNIQUE_ERR_MSG)
    def __str__(self): return self.name

class DisabilityGroup(models.Model):
    name = models.CharField(max_length=100, unique=True, error_messages=UNIQUE_ERR_MSG)
    def __str__(self): return self.name

class DisabilityType(models.Model):
    name = models.CharField(max_length=100, unique=True, error_messages=UNIQUE_ERR_MSG)
    def __str__(self): return self.name

class DisabilityStatus(models.Model):
    name = models.CharField(max_length=50, unique=True, error_messages=UNIQUE_ERR_MSG)
    def __str__(self): return self.name

class AddressType(models.Model):
    name = models.CharField(max_length=50, unique=True, error_messages=UNIQUE_ERR_MSG)
    def __str__(self): return self.name

class EmailType(models.Model):
    name = models.CharField(max_length=50, unique=True, error_messages=UNIQUE_ERR_MSG)
    def __str__(self): return self.name

class PhoneType(models.Model):
    name = models.CharField(max_length=50, unique=True, error_messages=UNIQUE_ERR_MSG)
    def __str__(self): return self.name

class PhoneCarrier(models.Model):
    name = models.CharField(max_length=50, unique=True, error_messages=UNIQUE_ERR_MSG)
    def __str__(self): return self.name

class Bank(models.Model):
    name = models.CharField(max_length=100, unique=True, error_messages=UNIQUE_ERR_MSG)
    code = models.CharField(max_length=4, unique=True, error_messages=CODE_UNIQUE_ERR_MSG)
    def __str__(self): return f"{self.name} ({self.code})"

class BankAccountType(models.Model):
    name = models.CharField(max_length=50, unique=True, error_messages=UNIQUE_ERR_MSG)
    def __str__(self): return self.name

class RelationshipType(models.Model):
    name = models.CharField(max_length=50, unique=True, error_messages=UNIQUE_ERR_MSG)
    def __str__(self): return self.name

# --- MODELOS RELACIONALES ---

class State(models.Model):
    name = models.CharField(max_length=100)
    country = models.ForeignKey(Country, on_delete=models.CASCADE)
    class Meta: unique_together = ('country', 'name')
    def __str__(self): return f"{self.name}, {self.country.name}"

class PhoneCarrierCode(models.Model):
    carrier = models.ForeignKey(PhoneCarrier, on_delete=models.CASCADE)
    code = models.CharField(max_length=4)
    class Meta: unique_together = ('carrier', 'code')
    def __str__(self): return f"{self.code} ({self.carrier})"

class Person(models.Model):
    first_name = models.CharField(max_length=100)
    second_name = models.CharField(max_length=100, blank=True, null=True)
    paternal_surname = models.CharField(max_length=100)
    maternal_surname = models.CharField(max_length=100, blank=True, null=True)
    gender = models.ForeignKey(Gender, on_delete=models.PROTECT, null=True, blank=True)
    marital_status = models.ForeignKey(MaritalStatus, on_delete=models.SET_NULL, null=True, blank=True)
    birthdate = models.DateField(null=True, blank=True)
    country_of_birth = models.ForeignKey(Country, on_delete=models.SET_NULL, null=True, blank=True)
    photo = models.ImageField(upload_to='photos/person/', null=True, blank=True)
    cv_file = models.FileField(upload_to='cv/person/', null=True, blank=True, help_text="Curriculum Vitae (PDF, DOCX)")
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    # Historial de cambios
    history = HistoricalRecords()
    
    def __str__(self): return f"{self.first_name} {self.paternal_surname}"

# --- IDENTIFICACIÓN VENEZOLANA ROBUSTA ---
class NationalId(models.Model):
    # ... (campos igual que antes) ...
    CATEGORY_CHOICES = [
        ('CEDULA', 'Cédula de Identidad'),
        ('RIF', 'RIF'),
        ('PASSPORT', 'Pasaporte'),
    ]

    PREFIX_CHOICES = [
        ('V', 'V - Venezolano / Persona Natural'),
        ('E', 'E - Extranjero / Persona Natural'),
        ('J', 'J - Jurídico'),
        ('G', 'G - Gubernamental'),
        ('P', 'P - Pasaporte'),
    ]

    person = models.ForeignKey(Person, on_delete=models.CASCADE, related_name="national_ids")
    
    category = models.CharField(max_length=10, choices=CATEGORY_CHOICES, default='CEDULA')
    document_type = models.CharField(max_length=1, choices=PREFIX_CHOICES, default='V', verbose_name="Prefijo")
    number = models.CharField(max_length=20, help_text="Solo números.")
    
    is_primary = models.BooleanField(default=False)
    file = models.FileField(upload_to='documents/national_id/', blank=True, null=True)

    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        unique_together = [
            # REGLA 1: Nadie más puede tener este documento en el sistema
            ('document_type', 'number'),
            
            # REGLA 2: Esta persona solo puede tener UNO de cada categoría
            ('person', 'category'),
        ]

    def save(self, *args, **kwargs):
        # La cédula siempre es el documento principal
        if self.category == 'CEDULA':
            self.is_primary = True
        super().save(*args, **kwargs)

    def __str__(self):
        return f"{self.get_category_display()}: {self.document_type}-{self.number}"

# --- DETALLES DE PERSONA ---

class PersonDisabilityVE(models.Model):
    person = models.OneToOneField(Person, on_delete=models.CASCADE, primary_key=True)
    date_learned = models.DateField(null=True, blank=True)
    disability_group = models.ForeignKey(DisabilityGroup, on_delete=models.SET_NULL, null=True, blank=True)
    disability_degree = models.CharField(max_length=50, blank=True, null=True)
    disability_type = models.ForeignKey(DisabilityType, on_delete=models.SET_NULL, null=True, blank=True)
    issuing_authority = models.CharField(max_length=100, blank=True, null=True)
    reference_number = models.CharField(max_length=50, blank=True, null=True)
    disability_status = models.ForeignKey(DisabilityStatus, on_delete=models.SET_NULL, null=True, blank=True)
    date_of_determination = models.DateField(null=True, blank=True)

class Address(models.Model):
    person = models.ForeignKey(Person, on_delete=models.CASCADE, related_name="addresses")
    address_type = models.ForeignKey(AddressType, on_delete=models.SET_NULL, null=True)
    country = models.ForeignKey(Country, on_delete=models.SET_NULL, null=True)
    state = models.ForeignKey(State, on_delete=models.SET_NULL, null=True)
    city = models.CharField(max_length=100)
    postal_code = models.CharField(max_length=20, blank=True, null=True)
    street_name_and_number = models.CharField(max_length=255)
    extra_address_line = models.CharField(max_length=255, blank=True, null=True)
    house_number = models.CharField(max_length=50, blank=True, null=True)
    apartment = models.CharField(max_length=50, blank=True, null=True)
    street_2 = models.CharField(max_length=255, blank=True, null=True)

class PersonEmail(models.Model):
    person = models.ForeignKey(Person, on_delete=models.CASCADE, related_name="emails")
    email_type = models.ForeignKey(EmailType, on_delete=models.SET_NULL, null=True)
    email_address = models.EmailField(unique=True, error_messages=EMAIL_UNIQUE_ERR_MSG) 
    is_primary = models.BooleanField(default=False)
    
    def __str__(self): 
        return self.email_address

class PersonPhone(models.Model):
    person = models.ForeignKey(Person, on_delete=models.CASCADE, related_name="phones")
    phone_type = models.ForeignKey(PhoneType, on_delete=models.SET_NULL, null=True)
    carrier_code = models.ForeignKey(PhoneCarrierCode, on_delete=models.SET_NULL, null=True)
    subscriber_number = models.CharField(max_length=10)
    is_primary = models.BooleanField(default=False)
    
    def __str__(self): return f"{self.carrier_code.code}-{self.subscriber_number}"
    
    class Meta:
        constraints = [
            models.UniqueConstraint(
                fields=['carrier_code', 'subscriber_number'],
                name="phone_unique",
                violation_error_message="Este número de teléfono ya se encuentra registrado.",
            ),
            models.UniqueConstraint(
                fields=['person'],
                condition=models.Q(is_primary=True),
                name='one_primary_phone_per_person',
                violation_error_message="La persona ya tiene un teléfono principal registrado.",
            ),
        ]

class PersonBankAccount(models.Model):
    person = models.ForeignKey(Person, on_delete=models.CASCADE, related_name="bank_accounts")
    bank = models.ForeignKey(Bank, on_delete=models.SET_NULL, null=True)
    bank_account_type = models.ForeignKey(BankAccountType, on_delete=models.SET_NULL, null=True)
    account_number = models.CharField(max_length=20, unique=True, error_messages={'unique': "Este número de cuenta ya está registrado."})
    is_primary = models.BooleanField(default=False)

class PersonDocument(models.Model):
    person = models.ForeignKey(Person, on_delete=models.CASCADE, related_name="documents")
    file = models.FileField(upload_to='documents/person/', blank=True, null=True)
    description = models.CharField(max_length=255, blank=True, null=True)

class PersonNationality(models.Model):
    person = models.ForeignKey(Person, on_delete=models.CASCADE, related_name="nationalities")
    country = models.ForeignKey(Country, on_delete=models.CASCADE)
    class Meta: unique_together = ('person', 'country')

# --- SATÉLITES ---
class Dependent(models.Model):
    person = models.ForeignKey(Person, on_delete=models.CASCADE, related_name="dependents")
    first_name = models.CharField(max_length=100)
    second_name = models.CharField(max_length=100, blank=True, null=True)
    paternal_surname = models.CharField(max_length=100)
    maternal_surname = models.CharField(max_length=100, blank=True, null=True)
    relationship = models.ForeignKey(RelationshipType, on_delete=models.SET_NULL, null=True)
    birthdate = models.DateField()
    gender = models.ForeignKey(Gender, on_delete=models.SET_NULL, null=True, blank=True)
    class Meta: unique_together = ('person', 'first_name', 'paternal_surname')

class EmergencyContact(models.Model):
    person = models.ForeignKey(Person, on_delete=models.CASCADE, related_name="emergency_contacts")
    first_name = models.CharField(max_length=100)
    second_name = models.CharField(max_length=100, blank=True, null=True)
    paternal_surname = models.CharField(max_length=100)
    maternal_surname = models.CharField(max_length=100, blank=True, null=True)
    relationship = models.ForeignKey(RelationshipType, on_delete=models.SET_NULL, null=True)
    phone_carrier_code = models.ForeignKey(PhoneCarrierCode, on_delete=models.SET_NULL, null=True)
    phone_number = models.CharField(max_length=10)
    is_primary = models.BooleanField(default=False)
</file>

<file path="frontend2/components/catalogs/catalog-crud.tsx">
"use client";

import { useState, useEffect, useMemo, useCallback } from "react";
import { TableSkeleton } from "@/components/skeletons/table-skeleton";
import { DataTable } from "./data-table";
import { Button } from "@/components/ui/button";
import { Plus, Pencil, Trash2, Loader2, AlertCircle } from "lucide-react";
import {
    Dialog,
    DialogContent,
    DialogDescription,
    DialogFooter,
    DialogHeader,
    DialogTitle,
    DialogTrigger,
} from "@/components/ui/dialog";
import {
    AlertDialog,
    AlertDialogAction,
    AlertDialogCancel,
    AlertDialogContent,
    AlertDialogDescription,
    AlertDialogFooter,
    AlertDialogHeader,
    AlertDialogTitle,
} from "@/components/ui/alert-dialog";
import { ActionMenu } from "@/components/ui/action-menu";
import { Combobox } from "@/components/ui/combobox";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import apiClient from "@/lib/api-client";
import { toast } from "sonner";
import { ColumnDef } from "@tanstack/react-table";
import { zodResolver } from "@hookform/resolvers/zod";
import { useForm } from "react-hook-form";
import { z } from "zod";
import {
    Form,
    FormControl,
    FormField,
    FormItem,
    FormLabel,
    FormMessage,
} from "@/components/ui/form";
import { Switch } from "@/components/ui/switch";
import { Alert, AlertDescription, AlertTitle } from "@/components/ui/alert";
import { Textarea } from "@/components/ui/textarea";
import { DatePicker } from "@/components/ui/date-picker";
import { format, parseISO } from "date-fns";

// Helper component for dependent selects
function DependentSelect({
    field,
    formField,
    form,
    fieldOptions,
    setFieldOptions,
    allFields
}: {
    field: CatalogField;
    formField: any;
    form: any;
    fieldOptions: Record<string, any[]>;
    setFieldOptions: React.Dispatch<React.SetStateAction<Record<string, any[]>>>;
    allFields: CatalogField[];
}) {
    const [isLoadingOptions, setIsLoadingOptions] = useState(false);

    // Get the value of the field this field depends on
    const dependsOnValue = field.dependsOn ? form.watch(field.dependsOn) : null;

    // Fetch options when dependsOn value changes
    useEffect(() => {
        if (field.dependsOn && dependsOnValue && field.optionsUrl) {
            const fetchDependentOptions = async () => {
                setIsLoadingOptions(true);
                try {
                    const filterParam = field.dependsOnFilterParam || field.dependsOn;
                    const params: Record<string, any> = {
                        page_size: 1000
                    };
                    if (filterParam) {
                        params[filterParam] = dependsOnValue;
                    }
                    const response = await apiClient.get(field.optionsUrl!, { params });
                    setFieldOptions(prev => ({
                        ...prev,
                        [field.name]: response.data.results || response.data
                    }));
                } catch (error) {
                    console.error(`Error fetching dependent options for ${field.name}:`, error);
                } finally {
                    setIsLoadingOptions(false);
                }
            };
            fetchDependentOptions();
        } else if (field.dependsOn && !dependsOnValue) {
            // Clear options if parent field is not selected
            setFieldOptions(prev => ({
                ...prev,
                [field.name]: []
            }));
        }
    }, [dependsOnValue, field.dependsOn, field.dependsOnFilterParam, field.name, field.optionsUrl]);

    const options = field.options
        ? field.options
        : (fieldOptions[field.name]?.map((option) => ({
            value: option[field.optionValueKey || "id"].toString(),
            label: option[field.optionLabelKey || "name"],
        })) || []);

    return (
        <Combobox
            options={options}
            value={formField.value?.toString() || ""}
            onSelect={(value) => {
                formField.onChange(value);
                if (field.onChange) {
                    const opts = field.options || fieldOptions[field.name];
                    field.onChange(value, form, opts);
                }
            }}
            placeholder={
                field.dependsOn && !dependsOnValue
                    ? `Primero seleccione ${allFields.find((f: CatalogField) => f.name === field.dependsOn)?.label || 'el campo anterior'}`
                    : isLoadingOptions
                        ? "Cargando opciones..."
                        : "Seleccione una opción"
            }
            emptyText="No se encontraron resultados."
            disabled={field.dependsOn ? !dependsOnValue : false}
        />
    );
}


export interface CatalogField {
    name: string;
    label: string;
    type: "text" | "number" | "email" | "select" | "checkbox" | "textarea" | "date" | "hidden";
    required?: boolean;
    optionsUrl?: string; // API endpoint to fetch options
    options?: { label: string; value: string }[]; // Static options
    optionLabelKey?: string; // Key to display (default: name)
    optionValueKey?: string; // Key for value (default: id)
    defaultValue?: any; // Default value for the field
    onChange?: (value: any, form: any, options?: any[]) => void; // Callback for value change
    showCharCount?: boolean; // Show character counter for text fields
    lockPrefixLength?: number; // Lock the first N characters from being deleted/modified
    dependsOn?: string; // Name of the field this field depends on for filtering options
    dependsOnFilterParam?: string; // Query parameter name to use when filtering (defaults to dependsOn value)
}

interface CatalogCRUDProps {
    title: React.ReactNode | string;
    apiUrl: string;
    fields: CatalogField[];
    columns: ColumnDef<any>[];
    searchKey?: string;
    searchOptions?: { label: string; value: string }[];
    extraActions?: (item: any) => React.ReactNode;
    disableCreate?: boolean;
    disableEdit?: boolean;
    customToolbarActions?: React.ReactNode;
    disablePagination?: boolean;
    disableDelete?: boolean;
    icon?: React.ElementType;
    refreshKey?: number; // Prop to trigger refresh from parent
    singularName?: string; // Singular name for the entity (e.g. "Employee", "Candidate")
}

export function CatalogCRUD({ title, apiUrl, fields, columns, searchKey, searchOptions, extraActions, disableCreate, disableEdit, disableDelete, customToolbarActions, disablePagination, icon: Icon, refreshKey, singularName }: CatalogCRUDProps) {
    const [data, setData] = useState<any[]>([]);
    const [isLoading, setIsLoading] = useState(true);
    const [isDialogOpen, setIsDialogOpen] = useState(false);
    const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false);
    const [isEditConfirmDialogOpen, setIsEditConfirmDialogOpen] = useState(false);
    const [currentItem, setCurrentItem] = useState<any | null>(null);
    const [isSaving, setIsSaving] = useState(false);
    const [fieldOptions, setFieldOptions] = useState<Record<string, any[]>>({});
    const [serverError, setServerError] = useState<string | string[] | null>(null);
    const [pendingFormData, setPendingFormData] = useState<any>(null);

    const [pagination, setPagination] = useState({
        pageIndex: 0,
        pageSize: 10,
    });
    const [rowCount, setRowCount] = useState(0);
    const [searchTerm, setSearchTerm] = useState("");
    // Default to first option if available, otherwise empty
    const [currentSearchOption, setCurrentSearchOption] = useState(searchOptions?.[0]?.value || "");

    // Dynamic Zod Schema Generation
    const formSchema = useMemo(() => {
        const shape: Record<string, z.ZodTypeAny> = {};
        fields.forEach((field) => {
            let fieldSchema;
            if (field.type === "number") {
                fieldSchema = z.coerce.number();
                if (field.required) {
                    fieldSchema = fieldSchema.min(1, { message: `${field.label} es requerido` });
                }
            } else if (field.type === "checkbox") {
                // Handle boolean or empty string (which can happen if default is "")
                fieldSchema = z.union([z.boolean(), z.literal("")]).transform((val) => val === "" ? false : val).default(false);
            } else if (field.type === "hidden") {
                // Hidden fields can be anything, usually string or number
                fieldSchema = z.any();
            } else {
                fieldSchema = z.string();
                if (field.required) {
                    fieldSchema = fieldSchema.min(1, { message: `${field.label} es requerido` });
                }
            }

            if (!field.required && field.type !== "checkbox" && field.type !== "hidden") {
                fieldSchema = fieldSchema.optional();
            }
            shape[field.name] = fieldSchema;
        });
        return z.object(shape);
    }, [fields]);

    type FormValues = z.infer<typeof formSchema>;

    const form = useForm<FormValues>({
        resolver: zodResolver(formSchema),
        defaultValues: {},
    });

    // Fetch Data
    const fetchData = async () => {
        // setIsLoading(true); // Removed to prevent unmounting DataTable on updates
        try {
            const params: any = {
                page: pagination.pageIndex + 1,
                page_size: pagination.pageSize,
            };
            if (searchTerm) {
                params.search = searchTerm;
                if (currentSearchOption) {
                    params.search_field = currentSearchOption;
                }
            }
            const response = await apiClient.get(apiUrl, { params });

            if (response.data.results) {
                setData(response.data.results);
                setRowCount(response.data.count);
            } else {
                // Fallback for non-paginated responses
                setData(response.data);
                setRowCount(response.data.length);
            }
        } catch (error) {
            // console.error("Error fetching data:", error);
            toast.error("Error al cargar los datos.");
        } finally {
            setIsLoading(false);
        }
    };

    // Fetch Options for Select Fields
    const fetchOptions = async () => {
        const options: Record<string, any[]> = {};
        for (const field of fields) {
            if (field.type === "select" && field.optionsUrl && !field.dependsOn) {
                // Only fetch options for fields that don't depend on other fields
                // Dependent fields will fetch their options dynamically when the parent field changes
                try {
                    const response = await apiClient.get(field.optionsUrl, { params: { page_size: 1000 } });
                    options[field.name] = response.data.results || response.data;
                } catch (error) {
                    // console.error(`Error fetching options for ${field.name}:`, error);
                }
            }
        }
        setFieldOptions(options);
    };

    useEffect(() => {
        fetchData();
        fetchOptions();
    }, [apiUrl, pagination.pageIndex, pagination.pageSize, searchTerm, currentSearchOption, refreshKey]); // Added refreshKey dependency

    const handleSearch = useCallback((term: string) => {
        setSearchTerm(term);
        setPagination(prev => ({ ...prev, pageIndex: 0 })); // Reset to first page on search
    }, []);

    // Open Create Dialog
    const handleCreate = () => {
        setCurrentItem(null);
        setServerError(null);
        form.reset({});
        // Reset default values based on fields
        const defaults: any = {};
        fields.forEach(f => {
            if (f.defaultValue !== undefined) {
                defaults[f.name] = f.defaultValue;
            } else if (f.type === "checkbox") {
                defaults[f.name] = false;
            } else {
                defaults[f.name] = "";
            }
        });
        form.reset(defaults);
        setIsDialogOpen(true);
    };

    // Open Edit Dialog
    const handleEdit = (item: any) => {
        setCurrentItem(item);
        setServerError(null);
        // For selects, we might need to map objects to IDs if the API returns objects
        const formattedItem = { ...item };
        fields.forEach(field => {
            const value = item[field.name];
            if (field.type === "select" && value !== null && typeof value === 'object') {
                if (Array.isArray(value)) {
                    // Si es un array (M2M), tomamos el primer elemento si existe
                    // Esto asume selección única para este campo en el frontend
                    if (value.length > 0) {
                        const firstItem = value[0];
                        if (typeof firstItem === 'object' && firstItem.id) {
                            formattedItem[field.name] = firstItem.id.toString();
                        } else if (firstItem && typeof firstItem !== 'object') {
                            formattedItem[field.name] = firstItem.toString();
                        }
                    } else {
                        formattedItem[field.name] = "";
                    }
                } else if (value.id) {
                    // Objeto único con ID
                    formattedItem[field.name] = value.id.toString();
                }
            } else if (field.type === "checkbox") {
                formattedItem[field.name] = value;
            } else if (value !== undefined && value !== null) {
                formattedItem[field.name] = value.toString();
            }
        });
        form.reset(formattedItem);
        setIsDialogOpen(true);
    };

    // Open Delete Dialog
    const handleDeleteClick = (item: any) => {
        setCurrentItem(item);
        setIsDeleteDialogOpen(true);
    };

    // Submit Form (Create/Update)
    const onSubmit = async (values: FormValues) => {
        // If editing, show confirmation dialog first
        if (currentItem) {
            setPendingFormData(values);
            setIsEditConfirmDialogOpen(true);
            return;
        }

        // Sanitize values: ensure checkboxes are booleans
        const sanitizedValues = { ...values };
        fields.forEach(f => {
            if (f.type === "checkbox") {
                sanitizedValues[f.name] = !!values[f.name];
            }
        });

        // If creating, submit directly
        await submitForm(sanitizedValues);
    };

    // Actual submission function
    const submitForm = async (values: FormValues) => {
        setIsSaving(true);
        setServerError(null);
        setIsEditConfirmDialogOpen(false);
        // Transform empty strings to null for select fields (nullable foreign keys)
        const transformedValues = { ...values };
        fields.forEach(field => {
            if (field.type === "select" && !field.required && transformedValues[field.name] === "") {
                transformedValues[field.name] = null;
            }
        });

        try {
            if (currentItem) {
                // Update - strip query params from apiUrl before adding ID
                const baseUrl = apiUrl.split('?')[0];
                await apiClient.patch(`${baseUrl}${currentItem.id}/`, transformedValues);
                toast.success("Registro actualizado correctamente.");
            } else {
                // Create
                await apiClient.post(apiUrl, transformedValues);
                toast.success("Registro creado correctamente.");
            }
            setIsDialogOpen(false);
            fetchData();
        } catch (error: any) {
            // console.error("Error saving data:", error);
            if (error.response) {
                const data = error.response.data;
                const generalErrors: string[] = [];

                if (error.response.status === 400) {
                    // Field validation errors
                    if (data.non_field_errors) {
                        generalErrors.push(...data.non_field_errors);
                    }
                    if (data.detail) {
                        generalErrors.push(data.detail);
                    }

                    // Handle field errors
                    Object.keys(data).forEach((key) => {
                        if (key !== 'non_field_errors' && key !== 'detail') {
                            const msg = Array.isArray(data[key]) ? data[key][0] : data[key];

                            // Check if key exists in fields
                            if (fields.some(f => f.name === key)) {
                                const lowerMsg = String(msg).toLowerCase();
                                const isUniquenessError = lowerMsg.includes("existe") || lowerMsg.includes("registrado");

                                if (isUniquenessError) {
                                    // Uniqueness error: Global alert + Red border (empty message)
                                    form.setError(key, {
                                        type: "manual",
                                        message: "",
                                    });
                                    generalErrors.push(`${msg}`);
                                } else {
                                    // Standard validation error: Text below field
                                    form.setError(key, {
                                        type: "manual",
                                        message: msg,
                                    });
                                }
                            } else {
                                // If error is for a field not in the form, show as general error
                                // Also check if it's a non_field_error disguised as a field error (e.g. unique_together on hidden fields)
                                generalErrors.push(`${key}: ${msg}`);
                            }
                        }
                    });

                    // If we have field errors, we don't need to show a general error unless there are non_field_errors
                    // But if the user wants consistency, maybe we should always show field errors below the field.
                    // The issue is likely that some backend errors are not keyed to the field name.

                    if (generalErrors.length > 0) {
                        setServerError(generalErrors);
                    }
                } else {
                    setServerError(data.detail || "Ocurrió un error al guardar el registro.");
                }
            } else {
                setServerError("Error de conexión. Verifique su internet.");
            }
            toast.error("Error al guardar el registro.");
        } finally {
            setIsSaving(false);
        }
    };

    // Confirm Delete
    const handleConfirmDelete = async () => {
        if (!currentItem) return;
        try {
            // Strip query params from apiUrl before adding ID
            const baseUrl = apiUrl.split('?')[0];
            await apiClient.delete(`${baseUrl}${currentItem.id}/`);
            toast.success("Registro eliminado correctamente.");
            setIsDeleteDialogOpen(false);
            fetchData();
        } catch (error) {
            // console.error("Error deleting data:", error);
            toast.error("Error al eliminar el registro.");
        }
    };

    // Add Actions Column
    const tableColumns: ColumnDef<any>[] = [
        ...columns,
        {
            id: "actions",
            cell: ({ row }) => {
                const item = row.original;
                return (
                    <div className="text-right">
                        <ActionMenu
                            onEdit={disableEdit ? undefined : () => handleEdit(item)}
                            onDelete={disableDelete ? undefined : () => handleDeleteClick(item)}
                        >
                            {extraActions && extraActions(item)}
                        </ActionMenu>
                    </div>
                );
            },
        },
    ];

    return (
        <div className="space-y-4">
            <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                {title ? (
                    <h2 className="text-xl font-bold tracking-tight flex items-center">
                        {Icon && <Icon className="mr-2 size-6 text-primary" />}
                        {title}
                    </h2>
                ) : <div></div>}
                <div className="flex gap-2">
                    {disableCreate ? customToolbarActions : (
                        <Button onClick={handleCreate} variant="outline">
                            <Plus className="h-4 w-4" />
                            {singularName ? `Nuevo ${singularName}` : "Nuevo"}
                        </Button>
                    )}
                </div>
            </div>

            {isLoading ? (
                <TableSkeleton columnCount={tableColumns.length} />
            ) : data.length === 0 && !searchTerm ? (
                <div className="flex flex-col items-center justify-center p-12 text-center border rounded-lg">
                    {Icon ? (
                        <Icon className="h-16 w-16 text-muted-foreground mb-4" />
                    ) : (
                        <Plus className="h-16 w-16 text-muted-foreground mb-4" />
                    )}
                    <h3 className="text-lg font-semibold mb-2">No hay registros creados</h3>
                    <p className="text-muted-foreground mb-4">
                        Crea tu primer registro para comenzar
                    </p>
                    {!disableCreate && (
                        <Button onClick={handleCreate}>
                            <Plus className="mr-2 h-4 w-4" />
                            Crear Primer Registro
                        </Button>
                    )}
                </div>
            ) : (
                <DataTable
                    columns={tableColumns}
                    data={data}
                    searchKey={searchKey}
                    searchOptions={searchOptions}
                    currentSearchOption={currentSearchOption}
                    onSearchOptionChange={setCurrentSearchOption}
                    rowCount={rowCount}
                    pagination={pagination}
                    onPaginationChange={setPagination}
                    onSearch={searchKey ? setSearchTerm : undefined}
                    disablePagination={disablePagination}
                />
            )}
            <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>
                <DialogContent className="sm:max-w-[425px] max-h-[90vh] flex flex-col">
                    <DialogHeader>
                        <DialogTitle>{currentItem ? "Editar Registro" : "Nuevo Registro"}</DialogTitle>
                        <DialogDescription>
                            Complete el formulario para {currentItem ? "actualizar" : "crear"} el registro.
                        </DialogDescription>
                    </DialogHeader>

                    <div className="flex-1 overflow-y-auto px-1 py-2">
                        {serverError && (
                            <Alert variant="destructive" className="mb-4">
                                <AlertCircle className="h-4 w-4" />
                                <AlertTitle>Error</AlertTitle>
                                <AlertDescription>
                                    {Array.isArray(serverError) ? (
                                        serverError.length > 1 ? (
                                            <ul className="list-disc list-inside">
                                                {serverError.map((err, index) => (
                                                    <li key={index}>{err}</li>
                                                ))}
                                            </ul>
                                        ) : (
                                            serverError[0]
                                        )
                                    ) : (
                                        serverError
                                    )}
                                </AlertDescription>
                            </Alert>
                        )}

                        <Form {...form}>
                            <form id="catalog-form" onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
                                {fields.map((field) => (
                                    <FormField
                                        key={field.name}
                                        control={form.control}
                                        name={field.name}
                                        render={({ field: formField }) => (
                                            <FormItem className={field.type === "hidden" ? "hidden" : ""}>
                                                {field.type !== "hidden" && <FormLabel>{field.label}</FormLabel>}
                                                <FormControl>
                                                    {field.type === "select" ? (
                                                        <DependentSelect
                                                            field={field}
                                                            formField={formField}
                                                            form={form}
                                                            fieldOptions={fieldOptions}
                                                            setFieldOptions={setFieldOptions}
                                                            allFields={fields}
                                                        />
                                                    ) : field.type === "checkbox" ? (
                                                        <div className="flex items-center space-x-2">
                                                            <Switch
                                                                checked={!!formField.value}
                                                                onCheckedChange={formField.onChange}
                                                            />
                                                            <Label>{field.label}</Label>
                                                        </div>
                                                    ) : field.type === "textarea" ? (
                                                        <Textarea
                                                            placeholder={field.label}
                                                            {...formField}
                                                            value={(formField.value as string) ?? ""}
                                                        />
                                                    ) : field.type === "date" ? (
                                                        <DatePicker
                                                            value={
                                                                formField.value && typeof formField.value === 'string'
                                                                    ? parseISO(formField.value)
                                                                    : (formField.value instanceof Date ? formField.value : undefined)
                                                            }
                                                            onChange={(date) => {
                                                                formField.onChange(date ? format(date, "yyyy-MM-dd") : "");
                                                            }}
                                                            placeholder={field.label}
                                                        />
                                                    ) : field.type === "hidden" ? (
                                                        <input type="hidden" {...formField} value={(formField.value as string | number) ?? ""} />
                                                    ) : (
                                                        <div>
                                                            <Input
                                                                type={field.type}
                                                                placeholder={field.label}
                                                                {...formField}
                                                                value={(formField.value as string | number) ?? ""}
                                                                onChange={(e) => {
                                                                    const newValue = e.target.value;
                                                                    const currentValue = String(formField.value ?? "");

                                                                    // If lockPrefixLength is set, ensure the prefix is preserved
                                                                    if (field.lockPrefixLength && currentValue.length >= field.lockPrefixLength) {
                                                                        const lockedPrefix = currentValue.substring(0, field.lockPrefixLength);

                                                                        // If the new value is shorter than the locked prefix or doesn't start with it, restore the prefix
                                                                        if (newValue.length < field.lockPrefixLength || !newValue.startsWith(lockedPrefix)) {
                                                                            // Keep the locked prefix and append the rest of the new value
                                                                            const userInput = newValue.substring(field.lockPrefixLength);
                                                                            formField.onChange(lockedPrefix + userInput);
                                                                            return;
                                                                        }
                                                                    }

                                                                    formField.onChange(newValue);
                                                                }}
                                                            />
                                                            {field.showCharCount && (field.type === "text" || field.type === "email") && (
                                                                <div className="text-xs text-muted-foreground mt-1 text-right">
                                                                    {String(formField.value ?? "").length} caracteres
                                                                </div>
                                                            )}
                                                        </div>
                                                    )}
                                                </FormControl>
                                                <FormMessage />
                                            </FormItem>
                                        )}
                                    />
                                ))}
                            </form>
                        </Form>
                    </div>
                    <DialogFooter>
                        <Button type="button" variant="outline" onClick={() => setIsDialogOpen(false)}>
                            Cancelar
                        </Button>
                        <Button type="submit" form="catalog-form" disabled={isSaving}>
                            {isSaving && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                            Guardar
                        </Button>
                    </DialogFooter>
                </DialogContent>
            </Dialog>

            {/* Edit Confirmation Dialog */}
            <AlertDialog open={isEditConfirmDialogOpen} onOpenChange={setIsEditConfirmDialogOpen}>
                <AlertDialogContent>
                    <AlertDialogHeader>
                        <AlertDialogTitle>¿Está seguro de realizar los cambios?</AlertDialogTitle>
                        <AlertDialogDescription>
                            Se actualizará el registro con los nuevos datos ingresados.
                        </AlertDialogDescription>
                    </AlertDialogHeader>
                    <AlertDialogFooter>
                        <AlertDialogCancel>Cancelar</AlertDialogCancel>
                        <AlertDialogAction
                            onClick={() => pendingFormData && submitForm(pendingFormData)}
                            disabled={isSaving}
                        >
                            {isSaving && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                            Confirmar
                        </AlertDialogAction>
                    </AlertDialogFooter>
                </AlertDialogContent>
            </AlertDialog>

            {/* Delete Confirmation Dialog */}
            <AlertDialog open={isDeleteDialogOpen} onOpenChange={setIsDeleteDialogOpen}>
                <AlertDialogContent>
                    <AlertDialogHeader>
                        <AlertDialogTitle>¿Está seguro?</AlertDialogTitle>
                        <AlertDialogDescription>
                            Esta acción no se puede deshacer. Esto eliminará permanentemente el registro.
                        </AlertDialogDescription>
                    </AlertDialogHeader>
                    <AlertDialogFooter>
                        <AlertDialogCancel>Cancelar</AlertDialogCancel>
                        <AlertDialogAction onClick={handleConfirmDelete} className="bg-destructive text-white hover:bg-destructive/90">
                            Eliminar
                        </AlertDialogAction>
                    </AlertDialogFooter>
                </AlertDialogContent>
            </AlertDialog>
        </div>
    );
}
</file>

<file path="backend/core/serializers.py">
from rest_framework import serializers
from rest_framework.validators import UniqueTogetherValidator
from datetime import date
import re 

from .models import (
    Person, Gender, MaritalStatus, Country, 
    DisabilityGroup, DisabilityType, DisabilityStatus,
    PersonDisabilityVE, AddressType, State, Address, 
    NationalId, EmailType, PersonEmail, PhoneType, PhoneCarrier, 
    PhoneCarrierCode, PersonPhone, Bank, BankAccountType, PersonBankAccount, 
    PersonDocument, RelationshipType, PersonNationality, 
    Dependent, EmergencyContact
)

# --- FUNCIONES DE UTILIDAD ---
def title_case_cleaner(value):
    if not value: return ""
    EXCLUSIONS = {'de', 'del', 'la', 'las', 'el', 'los', 'y', 'o', 'en', 'a', 'por', 'con', 'para', 'sin', 'so', 'sobre'}
    ROMAN_NUMERALS = {'i', 'ii', 'iii', 'iv', 'v', 'vi', 'vii', 'viii', 'ix', 'x', 'xi', 'xii', 'xiii', 'xiv', 'xv'}
    
    words = value.strip().lower().split()
    if not words: return ""
    
    processed_words = []
    
    # Primera palabra siempre capitalizada (o mayúscula si es romano)
    first_word = words[0]
    if first_word in ROMAN_NUMERALS:
        processed_words.append(first_word.upper())
    else:
        processed_words.append(first_word.capitalize())

    for word in words[1:]:
        if word in ROMAN_NUMERALS:
            processed_words.append(word.upper())
        elif word in EXCLUSIONS:
            processed_words.append(word)
        else:
            processed_words.append(word.capitalize())
            
    return " ".join(processed_words)

def sentence_case_cleaner(value):
    return value.strip().capitalize()

def validate_only_letters(value, field_name):
    if not value:
        return value
    if not re.fullmatch(r"^[a-zA-ZáéíóúÁÉÍÓÚüÜñÑ]+$", value):
        raise serializers.ValidationError("Este campo solo puede contener letras.")
    return value

def validate_text_with_spaces(value, field_name):
    """
    Valida que el valor solo contenga letras, espacios y tildes (sin números ni signos especiales).
    Usado para nombres de países, estados, tipos de catálogos, etc.
    """
    if not value:
        return value
    if not re.fullmatch(r"^[a-zA-ZáéíóúÁÉÍÓÚüÜñÑ\s]+$", value):
        raise serializers.ValidationError("Este campo solo puede contener letras.")
    return value

def validate_letters_only_no_spaces(value, field_name):
    """
    Valida que el valor solo contenga letras sin espacios ni tildes (para códigos ISO).
    """
    if not value:
        return value
    if not re.fullmatch(r"^[a-zA-Z]+$", value):
        raise serializers.ValidationError("Este campo solo puede contener letras.")
    return value

def validate_numeric_only(value, field_name):
    """
    Valida que el valor solo contenga números.
    Usado para códigos de banco, etc.
    """
    if not value:
        return value
    if not re.fullmatch(r"^[0-9]+$", value):
        raise serializers.ValidationError("Este campo solo puede contener números.")
    return value

def validate_alphanumeric_with_spaces(value, field_name):
    """
    Valida que el valor solo contenga letras, números, espacios y tildes.
    Usado para nombres de catálogos organizacionales (bancos, departamentos, carriers, etc.)
    """
    if not value:
        return value
    if not re.fullmatch(r"^[a-zA-Z0-9áéíóúÁÉÍÓÚüÜñÑ\s]+$", value):
        raise serializers.ValidationError("Este campo solo puede contener letras y números.")
    return value

def validate_min_length(value, min_len):
    """
    Valida que el valor tenga al menos min_len caracteres.
    """
    if not value:
        return value
    if len(value.strip()) < min_len:
        raise serializers.ValidationError(f"Este campo debe tener al menos {min_len} caracteres.")
    return value

def validate_exact_length(value, exact_len):
    """
    Valida que el valor tenga exactamente exact_len caracteres.
    """
    if not value:
        return value
    if len(value.strip()) != exact_len:
        raise serializers.ValidationError(f"Este campo debe tener exactamente {exact_len} caracteres.")
    return value

def validate_single_primary(serializer_instance, validated_data, model, primary_field_name):
    is_primary = validated_data.get('is_primary', getattr(serializer_instance.instance, 'is_primary', False))
    person = validated_data.get('person')

    if is_primary:
        queryset = model.objects.filter(person=person, is_primary=True)
        if serializer_instance.instance:
            queryset = queryset.exclude(pk=serializer_instance.instance.pk)

        if queryset.exists():
            raise serializers.ValidationError({
                'is_primary': f"Ya existe un registro principal."
            })
    return validated_data

def validate_unique_together(serializer_instance, validated_data, model, field_names, error_template=None):
    """
    Función genérica para validar unique_together con mensajes amigables.
    Los errores se retornan como non_field_errors para mostrarse en el Alert superior.
    
    Args:
        serializer_instance: La instancia del serializer (self)
        validated_data: Los datos validados
        model: El modelo a validar
        field_names: Tupla de nombres de campos que forman el unique_together (ej: ('country', 'name'))
        error_template: Template del mensaje de error. Si no se proporciona, se genera automáticamente.
                       Puede usar {field_name} como placeholders.
    
    Ejemplo de uso:
        validate_unique_together(self, data, State, ('country', 'name'), 
                                error_template='Ya existe un estado con este nombre en {country}.')
    """
    # Obtener valores de los campos
    field_values = {}
    for field_name in field_names:
        value = validated_data.get(field_name)
        if value is not None:
            field_values[field_name] = value
    
    # Si no tenemos todos los valores, no validar
    if len(field_values) != len(field_names):
        return validated_data
    
    # Construir el queryset
    filter_kwargs = {}
    for field_name, value in field_values.items():
        # Para campos de texto, usar case-insensitive
        if isinstance(value, str):
            filter_kwargs[f'{field_name}__iexact'] = value
        else:
            filter_kwargs[field_name] = value
    
    queryset = model.objects.filter(**filter_kwargs)
    if serializer_instance.instance:
        queryset = queryset.exclude(pk=serializer_instance.instance.pk)
    
    if queryset.exists():
        # Generar el mensaje de error
        if error_template:
            # Reemplazar placeholders con valores reales
            error_msg = error_template
            for field_name, value in field_values.items():
                # Si el valor tiene un atributo name (es un objeto), usarlo
                if hasattr(value, 'name'):
                    error_msg = error_msg.replace(f'{{{field_name}}}', value.name)
                else:
                    error_msg = error_msg.replace(f'{{{field_name}}}', str(value))
        else:
            # Mensaje genérico automático
            error_msg = "Ya existe un registro con esta combinación de valores."
        
        # Retornar como non_field_errors para que aparezca en el Alert superior
        raise serializers.ValidationError({
            'non_field_errors': [error_msg]
        })
    
    return validated_data

def check_uniqueness(model, field_name, value, instance=None, error_msg="Ya existe un registro con este valor."):
    filter_kwargs = {f"{field_name}__iexact": value}
    qs = model.objects.filter(**filter_kwargs)
    if instance:
        qs = qs.exclude(pk=instance.pk)
    if qs.exists():
        raise serializers.ValidationError(error_msg)
    return value

class AddressSerializer(serializers.ModelSerializer):
    # Campos para lectura
    address_type_name = serializers.CharField(source='address_type.name', read_only=True)
    country_name = serializers.CharField(source='country.name', read_only=True)
    state_name = serializers.CharField(source='state.name', read_only=True)

    class Meta: model = Address; fields = '__all__'
    
    def validate(self, data):
        if data.get('state') and data.get('country') and data['state'].country != data['country']:
            raise serializers.ValidationError({"state": "El estado no pertenece al país."})
        return data

    def validate_city(self, value):
        return title_case_cleaner(validate_text_with_spaces(value, 'Ciudad'))

    def validate_street_name_and_number(self, value):
        return title_case_cleaner(value)
    
class EmergencyContactSerializer(serializers.ModelSerializer):
    relationship_name = serializers.SerializerMethodField()
    phone_country_code = serializers.SerializerMethodField()
    phone_carrier_code = serializers.SerializerMethodField()
    
    class Meta: 
        model = EmergencyContact
        fields = '__all__'
    
    def get_relationship_name(self, obj):
        return obj.relationship.name if obj.relationship else None
    
    def get_phone_country_code(self, obj):
        # Venezuela solamente, prefijo fijo +58
        return "+58" if obj.phone_carrier_code else None
    
    def get_phone_carrier_code(self, obj):
        return obj.phone_carrier_code.code if obj.phone_carrier_code else None
    
    def validate_phone_number(self, value):
        if not value.isdigit(): raise serializers.ValidationError("Este campo solo puede contener números.")
        return value
    def validate(self, data): return validate_single_primary(self, data, EmergencyContact, "Contacto")
    def validate_first_name(self, value): return title_case_cleaner(validate_only_letters(value, "Nombre"))
    def validate_second_name(self, value): return title_case_cleaner(validate_only_letters(value, "Segundo Nombre")) if value else value
    def validate_paternal_surname(self, value): return title_case_cleaner(validate_only_letters(value, "Apellido Paterno"))
    def validate_maternal_surname(self, value): return title_case_cleaner(validate_only_letters(value, "Apellido Materno")) if value else value

# --- Serializers de Catálogo ---
class GenderSerializer(serializers.ModelSerializer):
    class Meta: model = Gender; fields = '__all__'
    def validate_name(self, value): 
        cleaned = title_case_cleaner(validate_text_with_spaces(value, 'Nombre'))
        validate_min_length(cleaned, 2)
        return check_uniqueness(Gender, 'name', cleaned, self.instance)
class MaritalStatusSerializer(serializers.ModelSerializer):
    class Meta: model = MaritalStatus; fields = '__all__'
    def validate_name(self, value): 
        cleaned = title_case_cleaner(validate_text_with_spaces(value, 'Nombre'))
        validate_min_length(cleaned, 2)
        return check_uniqueness(MaritalStatus, 'name', cleaned, self.instance)
class CountrySerializer(serializers.ModelSerializer):
    class Meta: model = Country; fields = '__all__'
    def validate_name(self, value): 
        cleaned = title_case_cleaner(validate_text_with_spaces(value, 'Nombre'))
        validate_min_length(cleaned, 2)
        
        # Validación explícita de unicidad
        qs = Country.objects.filter(name__iexact=cleaned)
        if self.instance:
            qs = qs.exclude(pk=self.instance.pk)
        
        if qs.exists():
            raise serializers.ValidationError("Ya existe un país con este nombre.")
            
        return cleaned
    def validate_iso_2(self, value): 
        validated = validate_letters_only_no_spaces(value, 'Código ISO')
        validate_exact_length(validated, 2)
        return check_uniqueness(Country, 'iso_2', validated.strip().upper(), self.instance)

class DisabilityGroupSerializer(serializers.ModelSerializer):
    class Meta: model = DisabilityGroup; fields = '__all__'
    def validate_name(self, value): 
        cleaned = title_case_cleaner(validate_text_with_spaces(value, 'Nombre'))
        validate_min_length(cleaned, 2)
        return check_uniqueness(DisabilityGroup, 'name', cleaned, self.instance)
class DisabilityTypeSerializer(serializers.ModelSerializer):
    class Meta: model = DisabilityType; fields = '__all__'
    def validate_name(self, value): 
        cleaned = title_case_cleaner(validate_text_with_spaces(value, 'Nombre'))
        validate_min_length(cleaned, 2)
        return check_uniqueness(DisabilityType, 'name', cleaned, self.instance)
class DisabilityStatusSerializer(serializers.ModelSerializer):
    class Meta: model = DisabilityStatus; fields = '__all__'
    def validate_name(self, value): 
        cleaned = sentence_case_cleaner(validate_text_with_spaces(value, 'Nombre'))
        validate_min_length(cleaned, 2)
        return check_uniqueness(DisabilityStatus, 'name', cleaned, self.instance)
class AddressTypeSerializer(serializers.ModelSerializer):
    class Meta: model = AddressType; fields = '__all__'
    def validate_name(self, value): 
        cleaned = title_case_cleaner(validate_text_with_spaces(value, 'Nombre'))
        validate_min_length(cleaned, 2)
        return check_uniqueness(AddressType, 'name', cleaned, self.instance)
class EmailTypeSerializer(serializers.ModelSerializer):
    class Meta: model = EmailType; fields = '__all__'
    def validate_name(self, value): 
        cleaned = title_case_cleaner(validate_text_with_spaces(value, 'Nombre'))
        validate_min_length(cleaned, 2)
        return check_uniqueness(EmailType, 'name', cleaned, self.instance)
class PhoneTypeSerializer(serializers.ModelSerializer):
    class Meta: model = PhoneType; fields = '__all__'
    def validate_name(self, value): 
        cleaned = title_case_cleaner(validate_text_with_spaces(value, 'Nombre'))
        validate_min_length(cleaned, 2)
        return check_uniqueness(PhoneType, 'name', cleaned, self.instance)
class PhoneCarrierSerializer(serializers.ModelSerializer):
    class Meta: model = PhoneCarrier; fields = '__all__'
    def validate_name(self, value): 
        cleaned = title_case_cleaner(validate_alphanumeric_with_spaces(value, 'Nombre'))
        validate_min_length(cleaned, 2)
        return check_uniqueness(PhoneCarrier, 'name', cleaned, self.instance)
class BankSerializer(serializers.ModelSerializer):
    display_name = serializers.SerializerMethodField()

    class Meta: 
        model = Bank
        fields = ['id', 'name', 'code', 'display_name']

    def get_display_name(self, obj):
        return f"{obj.code} - {obj.name}"

    def validate_name(self, value): 
        cleaned = title_case_cleaner(validate_alphanumeric_with_spaces(value, 'Nombre'))
        validate_min_length(cleaned, 2)
        return check_uniqueness(Bank, 'name', cleaned, self.instance)
    def validate_code(self, value): 
        validated = validate_numeric_only(value, 'Código')
        validate_exact_length(validated, 4)
        return check_uniqueness(Bank, 'code', validated.strip(), self.instance)
class BankAccountTypeSerializer(serializers.ModelSerializer):
    class Meta: model = BankAccountType; fields = '__all__'
    def validate_name(self, value): 
        cleaned = title_case_cleaner(validate_text_with_spaces(value, 'Nombre'))
        validate_min_length(cleaned, 2)
        return check_uniqueness(BankAccountType, 'name', cleaned, self.instance)
class RelationshipTypeSerializer(serializers.ModelSerializer):
    class Meta: model = RelationshipType; fields = '__all__'
    def validate_name(self, value): 
        cleaned = title_case_cleaner(validate_text_with_spaces(value, 'Nombre'))
        validate_min_length(cleaned, 2)
        return check_uniqueness(RelationshipType, 'name', cleaned, self.instance)
class StateSerializer(serializers.ModelSerializer):
    country_name = serializers.CharField(source='country.name', read_only=True)
    
    class Meta:
        model = State
        fields = '__all__'
        # Deshabilitar validación automática de unique_together para manejarla manualmente
        validators = []
    
    def to_representation(self, instance):
        ret = super().to_representation(instance)
        if instance.country:
            ret['country'] = {'id': instance.country.id, 'name': instance.country.name}
        return ret
    
    def validate_name(self, value):
        cleaned = title_case_cleaner(validate_text_with_spaces(value, 'Nombre'))
        validate_min_length(cleaned, 2)
        return cleaned
    
    def validate(self, data):
        # Usar helper genérico para unique_together
        return validate_unique_together(
            self, data, State, ('country', 'name'),
            error_template='Ya existe un estado con este nombre en {country}.'
        )
class PhoneCarrierCodeSerializer(serializers.ModelSerializer):
    carrier_name = serializers.CharField(source='carrier.name', read_only=True)
    
    class Meta:
        model = PhoneCarrierCode
        fields = '__all__'
        # Deshabilitar validación automática de unique_together
        validators = []
    
    def to_representation(self, instance):
        ret = super().to_representation(instance)
        if instance.carrier:
            ret['carrier'] = {'id': instance.carrier.id, 'name': instance.carrier.name}
        return ret
    
    def validate_code(self, value):
        value = value.strip()
        
        # Normalización: Si tiene 3 dígitos, agregar '0' al inicio
        if len(value) == 3 and value.isdigit():
            value = '0' + value
        
        # Validar que solo contenga números
        if not value.isdigit():
            raise serializers.ValidationError("Este campo solo puede contener números.")
        
        # Validar longitud exacta de 4 caracteres
        if len(value) != 4:
            raise serializers.ValidationError("Este campo debe tener exactamente 4 dígitos.")
        
        # Validar que comience con '0'
        if not value.startswith('0'):
            raise serializers.ValidationError("El código debe comenzar con '0'.")
        
        return value
    
    def validate(self, data):
        # Validación manual de unique_together con mensaje personalizado
        return validate_unique_together(
            self, data, PhoneCarrierCode, ('carrier', 'code'),
            error_template='Ya existe este código para la operadora {carrier}.'
        )

# --- SERIALIZERS PRINCIPALES ---

class NationalIdSerializer(serializers.ModelSerializer):
    category_display = serializers.CharField(source='get_category_display', read_only=True)
    document_type_name = serializers.CharField(source='get_category_display', read_only=True) # Alias para frontend
    prefix = serializers.CharField(source='document_type', read_only=True) # V, E, J...
    full_document = serializers.SerializerMethodField()

    class Meta: 
        model = NationalId
        fields = '__all__'
        validators = []
    
    def get_full_document(self, obj): return f"{obj.document_type}-{obj.number}"
    
    def validate_number(self, value):
        if not value.strip().isdigit(): raise serializers.ValidationError("Este campo solo puede contener números.")
        return value.strip()
        
    def validate(self, data):
        # Validar UniqueTogether manualmente para asociar errores a campos específicos
        document_type = data.get('document_type', getattr(self.instance, 'document_type', None))
        number = data.get('number', getattr(self.instance, 'number', None))
        person = data.get('person', getattr(self.instance, 'person', None))
        category = data.get('category', getattr(self.instance, 'category', None))
        
        # 1. Validar documento único (tipo + número)
        if document_type and number:
            queryset = NationalId.objects.filter(document_type=document_type, number=number)
            if self.instance: queryset = queryset.exclude(pk=self.instance.pk)
            if queryset.exists():
                raise serializers.ValidationError({'number': "Este documento ya está registrado en el sistema."})

        # 2. Validar categoría única por persona (persona + categoría)
        if person and category:
            queryset = NationalId.objects.filter(person=person, category=category)
            if self.instance: queryset = queryset.exclude(pk=self.instance.pk)
            if queryset.exists():
                raise serializers.ValidationError({'category': "Esta persona ya tiene un documento de esta categoría registrado."})

        # La cédula siempre es primaria (se establece en el modelo)
        # Solo validamos is_primary para otros documentos (RIF, Pasaporte)
        
        # Si es una cédula, no validamos is_primary porque se establece automáticamente
        if category == 'CEDULA':
            return data
            
        # Para otros documentos, validamos que no exista otro documento primario
        return validate_single_primary(self, data, NationalId, "ID Nacional")


class PersonEmailSerializer(serializers.ModelSerializer):
    email_type_name = serializers.CharField(source='email_type.name', read_only=True)

    class Meta: 
        model = PersonEmail
        fields = '__all__'
        extra_kwargs = {
            'email_address': {
                'error_messages': {
                    'unique': 'Este email ya se encuentra registrado.'
                }
            }
        }
    
    def validate_email_address(self, value):
        return value.strip().lower() 
    
    def validate(self, data):
        is_primary = data.get('is_primary', getattr(self.instance, 'is_primary', False))
        person = data.get('person')
        if is_primary:
            queryset = PersonEmail.objects.filter(person=person, is_primary=True)
            if self.instance: queryset = queryset.exclude(pk=self.instance.pk)
            if queryset.exists():
                raise serializers.ValidationError({'is_primary': "Ya existe un correo principal."}) 
        return data


class PersonPhoneSerializer(serializers.ModelSerializer):
    phone_type_name = serializers.CharField(source='phone_type.name', read_only=True)
    carrier_code_val = serializers.CharField(source='carrier_code.code', read_only=True) # Ej: 0414
    full_number = serializers.SerializerMethodField()

    class Meta: 
        model = PersonPhone; 
        fields = '__all__'
        validators = [
            UniqueTogetherValidator(
                queryset=PersonPhone.objects.all(),
                fields=['carrier_code', 'subscriber_number'],
                message="Este número de teléfono ya se encuentra registrado."
            )
        ]
    
    def get_full_number(self, obj):
        # Formato solicitado: 0424-8167536
        if obj.carrier_code:
            return f"{obj.carrier_code.code}-{obj.subscriber_number}"
        return obj.subscriber_number

    def validate_subscriber_number(self, value):
        value = value.strip()
        if not value.isdigit():
            raise serializers.ValidationError("Este campo solo puede contener números.")
        if len(value) != 7:
            raise serializers.ValidationError("Este campo debe tener exactamente 7 dígitos.")
        return value

    def validate(self, data):
        is_primary = data.get('is_primary', getattr(self.instance, 'is_primary', False))
        person = data.get('person')
        if is_primary:
            queryset = PersonPhone.objects.filter(person=person, is_primary=True)
            if self.instance: queryset = queryset.exclude(pk=self.instance.pk)
            if queryset.exists():
                raise serializers.ValidationError({'is_primary': "Ya existe un teléfono principal."})
        return data
    
class PersonBankAccountSerializer(serializers.ModelSerializer):
    bank_name = serializers.CharField(source='bank.name', read_only=True)
    bank_code = serializers.CharField(source='bank.code', read_only=True)
    bank_account_type_name = serializers.CharField(source='bank_account_type.name', read_only=True)

    class Meta: model = PersonBankAccount; fields = '__all__'
    def validate_account_number(self, value):
        if not value.isdigit() or len(value) != 20: raise serializers.ValidationError("Este campo debe tener 20 dígitos.")
        return value
    def validate(self, data): 
        # 1. Validar unicidad de cuenta principal
        data = validate_single_primary(self, data, PersonBankAccount, "Cuenta Bancaria")
        
        # 2. Validar que el número de cuenta corresponda al banco seleccionado
        bank = data.get('bank')
        account_number = data.get('account_number')
        
        # Si estamos actualizando y no se enviaron estos campos, obtenerlos de la instancia
        if not bank and self.instance:
            bank = self.instance.bank
        if not account_number and self.instance:
            account_number = self.instance.account_number
            
        if bank and account_number:
            if not account_number.startswith(bank.code):
                raise serializers.ValidationError({
                    "account_number": f"El número de cuenta debe comenzar con el código del banco ({bank.code})."
                })
                
        return data



class DependentSerializer(serializers.ModelSerializer):
    relationship_name = serializers.SerializerMethodField()
    gender_name = serializers.CharField(source='gender.name', read_only=True)
    
    class Meta: 
        model = Dependent
        fields = '__all__'
    
    validators = [UniqueTogetherValidator(queryset=Dependent.objects.all(), fields=['person', 'first_name', 'paternal_surname'])]
    
    def get_relationship_name(self, obj):
        return obj.relationship.name if obj.relationship else None
    
    def validate_birthdate(self, value):
        if value > date.today(): raise serializers.ValidationError("No se permiten fechas futuras.")
        return value
    def validate_first_name(self, value): return title_case_cleaner(validate_only_letters(value, "Nombre"))
    def validate_second_name(self, value): return title_case_cleaner(validate_only_letters(value, "Segundo Nombre")) if value else value
    def validate_paternal_surname(self, value): return title_case_cleaner(validate_only_letters(value, "Apellido Paterno"))
    def validate_maternal_surname(self, value): return title_case_cleaner(validate_only_letters(value, "Apellido Materno")) if value else value


class PersonListSerializer(serializers.ModelSerializer):
    full_name = serializers.SerializerMethodField()
    primary_document = serializers.SerializerMethodField()
    primary_email = serializers.SerializerMethodField()
    primary_phone = serializers.SerializerMethodField()
    hiring_search = serializers.SerializerMethodField()

    class Meta:
        model = Person
        fields = ['id', 'photo', 'full_name', 'primary_document', 'primary_email', 'primary_phone', 'hiring_search']
    
    def get_full_name(self, obj): return f"{obj.first_name} {obj.paternal_surname}".strip()
    
    def get_primary_document(self, obj):
        doc = obj.national_ids.filter(is_primary=True).first()
        return f"{doc.document_type}-{doc.number}" if doc else "-"
    
    def get_primary_email(self, obj):
        e = obj.emails.filter(is_primary=True).first()
        return e.email_address if e else "-"
    
    def get_primary_phone(self, obj):
        p = obj.phones.filter(is_primary=True).first()
        if not p:
            return "-"
        if p.carrier_code:
            return f"{p.carrier_code.code}-{p.subscriber_number}"
        return p.subscriber_number
        
    def get_hiring_search(self, obj):
        doc = obj.national_ids.filter(is_primary=True).first()
        doc_str = f"{doc.document_type}-{doc.number}" if doc else "Sin Cédula"
        return doc_str

class PersonSerializer(serializers.ModelSerializer):
    full_name = serializers.SerializerMethodField()
    primary_document = serializers.SerializerMethodField()
    primary_email = serializers.SerializerMethodField()
    primary_phone = serializers.SerializerMethodField()
    photo = serializers.FileField(required=False, allow_null=True)
    gender_name = serializers.CharField(source='gender.name', read_only=True)
    country_of_birth_name = serializers.CharField(source='country_of_birth.name', read_only=True)
    hiring_search = serializers.SerializerMethodField()
    
    # Campos para crear cédula durante la creación de persona
    cedula_prefix = serializers.CharField(write_only=True, required=False, allow_blank=True)
    cedula_number = serializers.CharField(write_only=True, required=False, allow_blank=True)
    
    addresses = AddressSerializer(many=True, read_only=True)
    phones = PersonPhoneSerializer(many=True, read_only=True)
    emails = PersonEmailSerializer(many=True, read_only=True)
    national_ids = NationalIdSerializer(many=True, read_only=True)
    emergency_contacts = EmergencyContactSerializer(many=True, read_only=True)
    bank_accounts = PersonBankAccountSerializer(many=True, read_only=True)
    dependents = DependentSerializer(many=True, read_only=True)

    class Meta: model = Person; fields = '__all__'
    
    def to_representation(self, instance):
        """Override to add talent-related nested fields dynamically to avoid circular import"""
        ret = super().to_representation(instance)
        
        # Import talent serializers here to avoid circular dependency
        from talent.serializers import (
            PersonEducationSerializer,
            PersonCertificationSerializer,
            PersonLanguageSerializer
        )
        
        # Add talent-related nested data using correct related_names
        ret['educations'] = PersonEducationSerializer(instance.education_history.all(), many=True).data
        ret['certifications'] = PersonCertificationSerializer(instance.certifications.all(), many=True).data
        ret['languages'] = PersonLanguageSerializer(instance.languages.all(), many=True).data
        
        return ret
    
    def to_internal_value(self, data):
        # Only copy if no files are present (files can't be deepcopied)
        if hasattr(data, 'copy') and not hasattr(data, 'getlist'):
            # For regular dicts, we can copy
            if not any(hasattr(v, 'read') for v in data.values()):
                data = data.copy()
        if 'photo' in data and data['photo'] == 'DELETE': 
            data['photo'] = None
        if 'cv_file' in data and data['cv_file'] == 'DELETE':
            data['cv_file'] = None
        return super().to_internal_value(data)

    def validate_cedula_number(self, value):
        """Sanitize and validate cedula number"""
        if not value:
            return value
            
        # Eliminar puntos y comas (separadores de miles)
        sanitized = value.replace('.', '').replace(',', '')
        
        # Verificar que solo contenga dígitos
        if not sanitized.isdigit():
            raise serializers.ValidationError("El número de cédula solo puede contener dígitos.")
        
        # Remover ceros a la izquierda
        sanitized = sanitized.lstrip('0') or '0'
        
        # Verificar longitud (1-8 dígitos)
        if len(sanitized) > 8:
            raise serializers.ValidationError("El número de cédula no puede tener más de 8 dígitos.")
        
        return sanitized

    def validate_cedula_prefix(self, value):
        """Validate that cedula prefix is only V or E"""
        if value and value not in ['V', 'E']:
            raise serializers.ValidationError("El prefijo de cédula debe ser V (Venezolano) o E (Extranjero).")
        return value

    def validate(self, data):
        # Validar prefijo de cédula
        if 'cedula_prefix' in data and data['cedula_prefix']:
            data['cedula_prefix'] = self.validate_cedula_prefix(data['cedula_prefix'])
        
        # Sanitizar cédula si está presente
        if 'cedula_number' in data and data['cedula_number']:
            data['cedula_number'] = self.validate_cedula_number(data['cedula_number'])
        
        # Validar unicidad de cédula si se proporciona
        cedula_prefix = data.get('cedula_prefix')
        cedula_number = data.get('cedula_number')
        
        if cedula_prefix and cedula_number:
            # Verificar si ya existe un NationalId con ese prefijo y número
            qs = NationalId.objects.filter(document_type=cedula_prefix, number=cedula_number)
            
            # Si estamos editando, excluir los documentos de la persona actual
            if self.instance:
                qs = qs.exclude(person=self.instance)
                
            if qs.exists():
                raise serializers.ValidationError({
                    "cedula_number": f"Ya existe una persona con la cédula {cedula_prefix}-{cedula_number}."
                })
        
        return data

    def validate_birthdate(self, value):
        if value and value > date.today(): raise serializers.ValidationError("No se permiten fechas futuras.")
        return value
    def validate_first_name(self, value): return title_case_cleaner(validate_only_letters(value, "Primer Nombre"))
    def validate_second_name(self, value): return title_case_cleaner(validate_only_letters(value, "Segundo Nombre")) if value else value
    def validate_paternal_surname(self, value): return title_case_cleaner(validate_only_letters(value, "Apellido Paterno"))
    def validate_maternal_surname(self, value): return title_case_cleaner(validate_only_letters(value, "Apellido Materno")) if value else value

    def get_full_name(self, obj):
        """Devuelve el nombre completo usando el __str__ del modelo"""
        return str(obj)

    def get_primary_document(self, obj):
        """Busca el documento marcado como principal"""
        # Usamos el related_name='national_ids' definido en el modelo
        doc = obj.national_ids.filter(is_primary=True).first()
        return f"{doc.document_type}-{doc.number}" if doc else None

    def get_primary_email(self, obj):
        """Busca el correo marcado como principal"""
        # Usamos el related_name='emails'
        email = obj.emails.filter(is_primary=True).first()
        return email.email_address if email else None

    def get_primary_phone(self, obj):
        """Busca el teléfono marcado como principal"""
        # Usamos el related_name='phones'
        phone = obj.phones.filter(is_primary=True).first()
        if not phone:
            return None
        # El __str__ del modelo PersonPhone también accede a carrier_code.code, así que manejamos el caso
        if phone.carrier_code:
            return str(phone)
        return phone.subscriber_number

    def get_hiring_search(self, obj):
        doc = obj.national_ids.filter(is_primary=True).first()
        doc_str = f"{doc.document_type}-{doc.number}" if doc else "Sin Cédula"
        return doc_str

    def create(self, validated_data):
        """Override create to handle cedula creation"""
        # Extract cedula data
        cedula_prefix = validated_data.pop('cedula_prefix', None)
        cedula_number = validated_data.pop('cedula_number', None)
        
        # Create person
        person = Person.objects.create(**validated_data)
        
        # Create NationalId if cedula data provided
        if cedula_prefix and cedula_number:
            from .models import NationalId
            NationalId.objects.create(
                person=person,
                category='CEDULA',
                document_type=cedula_prefix,
                number=cedula_number,
                is_primary=True
            )
        
        return person

    def update(self, instance, validated_data):
        """Override update to handle cedula updates"""
        # Extract cedula data
        cedula_prefix = validated_data.pop('cedula_prefix', None)
        cedula_number = validated_data.pop('cedula_number', None)
        
        # Update person fields
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()
        
        # Update NationalId if cedula data provided
        if cedula_prefix and cedula_number:
            from .models import NationalId
            # Buscar si ya tiene una cédula (categoría CEDULA)
            cedula = NationalId.objects.filter(person=instance, category='CEDULA').first()
            
            if cedula:
                # Actualizar existente
                cedula.document_type = cedula_prefix
                cedula.number = cedula_number
                cedula.save()
            else:
                # Crear nueva si no tenía
                NationalId.objects.create(
                    person=instance,
                    category='CEDULA',
                    document_type=cedula_prefix,
                    number=cedula_number,
                    is_primary=True
                )
        
        return instance

class PersonDisabilityVESerializer(serializers.ModelSerializer):
    class Meta: model = PersonDisabilityVE; fields = '__all__'
    def validate(self, data):
        if data.get('date_learned') and data.get('date_of_determination') and data['date_learned'] > data['date_of_determination']:
            raise serializers.ValidationError({"date_learned": "Las fechas son inconsistentes."})
        return data




class PersonDocumentSerializer(serializers.ModelSerializer):
    class Meta: model = PersonDocument; fields = '__all__'

class PersonNationalitySerializer(serializers.ModelSerializer):
    class Meta: model = PersonNationality; fields = '__all__'
</file>

<file path="backend/core/views.py">
from rest_framework import status
from rest_framework.response import Response
from rest_framework.decorators import action
from rest_framework import viewsets, permissions, filters
from .models import (
    Person, Gender, MaritalStatus, Country,
    DisabilityGroup, DisabilityType, DisabilityStatus,
    PersonDisabilityVE, AddressType, State, Address, 
    NationalId, EmailType, PersonEmail, PhoneType, PhoneCarrier, 
    PhoneCarrierCode, PersonPhone, Bank, BankAccountType, PersonBankAccount, 
    PersonDocument, RelationshipType, PersonNationality, 
    Dependent, EmergencyContact
)
from .serializers import (
    PersonSerializer, PersonListSerializer, GenderSerializer, MaritalStatusSerializer, 
    CountrySerializer,
    DisabilityGroupSerializer, DisabilityTypeSerializer, DisabilityStatusSerializer,
    PersonDisabilityVESerializer, AddressTypeSerializer, StateSerializer, 
    AddressSerializer, NationalIdSerializer, 
    EmailTypeSerializer, PersonEmailSerializer, PhoneTypeSerializer, 
    PhoneCarrierSerializer, PhoneCarrierCodeSerializer, PersonPhoneSerializer, 
    BankSerializer, BankAccountTypeSerializer, PersonBankAccountSerializer, 
    PersonDocumentSerializer, RelationshipTypeSerializer, 
    PersonNationalitySerializer,
    DependentSerializer, EmergencyContactSerializer
)
from .filters import UnaccentSearchFilter

class PersonViewSet(viewsets.ModelViewSet):
    queryset = Person.objects.all().order_by('-created_at')
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['first_name__unaccent', 'paternal_surname__unaccent', 'national_ids__number']

    def get_serializer_class(self):
        if self.action == 'list': return PersonListSerializer
        return PersonSerializer

    # FIX: Sobrescribimos get_queryset para permitir filtros avanzados
    def get_queryset(self):
        queryset = Person.objects.all().order_by('-created_at')
        
        # Filtro para el modal de contratación: Solo personas CON Cédula/ID
        if self.request.query_params.get('has_id') == 'true':
            queryset = queryset.filter(national_ids__isnull=False).distinct()
            
        return queryset

    @action(detail=True, methods=['post'], url_path='create-user-account')
    def create_user_account(self, request, pk=None):
        person = self.get_object()
        
        # 1. Validar si ya tiene usuario
        if hasattr(person, 'user_account') and person.user_account:
            return Response(
                {"error": "Esta persona ya tiene un usuario asignado."},
                status=status.HTTP_400_BAD_REQUEST
            )

        # 2. Obtener cédula (documento principal)
        primary_doc = person.national_ids.filter(is_primary=True).first()
        if not primary_doc:
             return Response(
                {"error": "La persona debe tener un documento de identidad principal (Cédula) para generar el usuario."},
                status=status.HTTP_400_BAD_REQUEST
            )
            
        # Extraer número de cédula limpio (sin puntos ni guiones)
        doc_number = primary_doc.number.replace('.', '').replace('-', '').strip()
        
        # 3. Generar Username: Primera Letra Nombre + Primer Apellido + Últimos 4 dígitos Cédula
        # Normalizamos para quitar acentos y caracteres especiales
        import unicodedata
        def normalize_text(text):
            return ''.join(c for c in unicodedata.normalize('NFD', text) if unicodedata.category(c) != 'Mn').lower()

        first_initial = normalize_text(person.first_name[0])
        surname = normalize_text(person.paternal_surname)
        last_4_digits = doc_number[-4:].zfill(4)
        
        base_username = f"{first_initial}{surname}{last_4_digits}"
        username = base_username
        
        # 4. Manejo de colisiones (aunque la fórmula es bastante única)
        from django.contrib.auth import get_user_model
        User = get_user_model()
        counter = 1
        while User.objects.filter(username=username).exists():
            username = f"{base_username}{counter}"
            counter += 1
            
        # 5. Crear Usuario usando la cédula como contraseña inicial
        try:
            user = User.objects.create_user(
                username=username,
                password=doc_number,  # Contraseña inicial = número de cédula
                person=person,
                is_active=True
            )
            return Response({
                "message": "Usuario creado exitosamente.",
                "username": username,
                "user_id": user.id
            }, status=status.HTTP_201_CREATED)
        except Exception as e:
            return Response(
                {"error": f"Error al crear usuario: {str(e)}"},
                status=status.HTTP_500_INTERNAL_SERVER_ERROR
            )

    @action(detail=True, methods=['post'], url_path='reset-password')
    def reset_password(self, request, pk=None):
        person = self.get_object()
        
        if not hasattr(person, 'user_account') or not person.user_account:
            return Response(
                {"error": "Esta persona no tiene un usuario asignado."},
                status=status.HTTP_400_BAD_REQUEST
            )
            
        password = request.data.get('password')
        if not password:
            return Response(
                {"error": "La contraseña es obligatoria."},
                status=status.HTTP_400_BAD_REQUEST
            )

        try:
            user = person.user_account
            user.set_password(password)
            user.save()
            return Response({
                "message": "Contraseña actualizada exitosamente."
            }, status=status.HTTP_200_OK)
        except Exception as e:
            return Response(
                {"error": f"Error al actualizar contraseña: {str(e)}"},
                status=status.HTTP_500_INTERNAL_SERVER_ERROR
            )

    @action(detail=True, methods=['post'], url_path='deactivate-user')
    def deactivate_user(self, request, pk=None):
        person = self.get_object()
        
        if not hasattr(person, 'user_account') or not person.user_account:
            return Response(
                {"error": "Esta persona no tiene un usuario asignado."},
                status=status.HTTP_400_BAD_REQUEST
            )
            
        try:
            user = person.user_account
            user.is_active = False
            user.save()
            return Response({
                "message": "Usuario desactivado exitosamente."
            }, status=status.HTTP_200_OK)
        except Exception as e:
            return Response(
                {"error": f"Error al desactivar usuario: {str(e)}"},
                status=status.HTTP_500_INTERNAL_SERVER_ERROR
            )

    @action(detail=True, methods=['post'], url_path='activate-user')
    def activate_user(self, request, pk=None):
        person = self.get_object()
        
        if not hasattr(person, 'user_account') or not person.user_account:
            return Response(
                {"error": "Esta persona no tiene un usuario asignado."},
                status=status.HTTP_400_BAD_REQUEST
            )
            
        try:
            user = person.user_account
            user.is_active = True
            user.save()
            return Response({
                "message": "Usuario activado exitosamente."
            }, status=status.HTTP_200_OK)
        except Exception as e:
            return Response(
                {"error": f"Error al activar usuario: {str(e)}"},
                status=status.HTTP_500_INTERNAL_SERVER_ERROR
            )

class NationalIdViewSet(viewsets.ModelViewSet):
    serializer_class = NationalIdSerializer
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['number', 'person__first_name__unaccent', 'person__paternal_surname__unaccent']
    
    def get_queryset(self):
        queryset = NationalId.objects.all()
        person_id = self.request.query_params.get('person')
        if person_id:
            queryset = queryset.filter(person=person_id)
        return queryset

# ... (Resto de ViewSets de Catálogos igual) ...
class GenderViewSet(viewsets.ModelViewSet):
    queryset = Gender.objects.all()
    serializer_class = GenderSerializer
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['name']
class MaritalStatusViewSet(viewsets.ModelViewSet):
    queryset = MaritalStatus.objects.all()
    serializer_class = MaritalStatusSerializer
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['name']
class CountryViewSet(viewsets.ModelViewSet):
    queryset = Country.objects.all().order_by('name')
    serializer_class = CountrySerializer
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['name', 'iso_2']

class DisabilityGroupViewSet(viewsets.ModelViewSet):
    queryset = DisabilityGroup.objects.all()
    serializer_class = DisabilityGroupSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['name']
class DisabilityTypeViewSet(viewsets.ModelViewSet):
    queryset = DisabilityType.objects.all()
    serializer_class = DisabilityTypeSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['name']
class DisabilityStatusViewSet(viewsets.ModelViewSet):
    queryset = DisabilityStatus.objects.all()
    serializer_class = DisabilityStatusSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['name']
class AddressTypeViewSet(viewsets.ModelViewSet):
    queryset = AddressType.objects.all()
    serializer_class = AddressTypeSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['name']
class EmailTypeViewSet(viewsets.ModelViewSet):
    queryset = EmailType.objects.all()
    serializer_class = EmailTypeSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['name']
class PhoneTypeViewSet(viewsets.ModelViewSet):
    queryset = PhoneType.objects.all()
    serializer_class = PhoneTypeSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['name']
class PhoneCarrierViewSet(viewsets.ModelViewSet):
    queryset = PhoneCarrier.objects.all()
    serializer_class = PhoneCarrierSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['name']
class BankViewSet(viewsets.ModelViewSet):
    queryset = Bank.objects.all()
    serializer_class = BankSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['name', 'code']
class BankAccountTypeViewSet(viewsets.ModelViewSet):
    queryset = BankAccountType.objects.all()
    serializer_class = BankAccountTypeSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['name']
class RelationshipTypeViewSet(viewsets.ModelViewSet):
    queryset = RelationshipType.objects.all()
    serializer_class = RelationshipTypeSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['name']
class StateViewSet(viewsets.ModelViewSet):
    queryset = State.objects.all()
    serializer_class = StateSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['name', 'country__name']
class PhoneCarrierCodeViewSet(viewsets.ModelViewSet):
    queryset = PhoneCarrierCode.objects.all()
    serializer_class = PhoneCarrierCodeSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['code', 'carrier__name']

# --- ViewSets de Datos de Person ---
class PersonDisabilityVEViewSet(viewsets.ModelViewSet):
    queryset = PersonDisabilityVE.objects.all()
    serializer_class = PersonDisabilityVESerializer
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [filters.SearchFilter]
    search_fields = ['person__first_name', 'person__paternal_surname', 'disability_type__name', 'disability_status__name']

    def get_queryset(self):
        queryset = PersonDisabilityVE.objects.all()
        person_id = self.request.query_params.get('person')
        if person_id:
            queryset = queryset.filter(person=person_id)
        return queryset
class AddressViewSet(viewsets.ModelViewSet):
    queryset = Address.objects.all()
    serializer_class = AddressSerializer
    permission_classes = [permissions.IsAuthenticated]
    def get_queryset(self):
        queryset = Address.objects.all()
        person_id = self.request.query_params.get('person')
        if person_id:
            queryset = queryset.filter(person=person_id)
        return queryset
    
class PersonEmailViewSet(viewsets.ModelViewSet):
    queryset = PersonEmail.objects.all()
    serializer_class = PersonEmailSerializer
    permission_classes = [permissions.IsAuthenticated]
    def get_queryset(self):
        queryset = PersonEmail.objects.all()
        person_id = self.request.query_params.get('person')
        if person_id:
            queryset = queryset.filter(person=person_id)
        return queryset
class PersonPhoneViewSet(viewsets.ModelViewSet):
    queryset = PersonPhone.objects.all()
    serializer_class = PersonPhoneSerializer
    permission_classes = [permissions.IsAuthenticated]
    def get_queryset(self):
        queryset = PersonPhone.objects.all()
        person_id = self.request.query_params.get('person')
        if person_id:
            queryset = queryset.filter(person=person_id)
        return queryset
    
class PersonBankAccountViewSet(viewsets.ModelViewSet):
    queryset = PersonBankAccount.objects.all()
    serializer_class = PersonBankAccountSerializer
    permission_classes = [permissions.IsAuthenticated]

    def get_queryset(self):
        queryset = PersonBankAccount.objects.all()
        person_id = self.request.query_params.get('person')
        if person_id:
            queryset = queryset.filter(person=person_id)
        return queryset
class PersonDocumentViewSet(viewsets.ModelViewSet):
    queryset = PersonDocument.objects.all()
    serializer_class = PersonDocumentSerializer
    permission_classes = [permissions.IsAuthenticated]

    def get_queryset(self):
        queryset = PersonDocument.objects.all()
        person_id = self.request.query_params.get('person')
        if person_id:
            queryset = queryset.filter(person=person_id)
        return queryset
class PersonNationalityViewSet(viewsets.ModelViewSet):
    queryset = PersonNationality.objects.all()
    serializer_class = PersonNationalitySerializer
    permission_classes = [permissions.IsAuthenticated]

    def get_queryset(self):
        queryset = PersonNationality.objects.all()
        person_id = self.request.query_params.get('person')
        if person_id:
            queryset = queryset.filter(person=person_id)
        return queryset

# --- VIEWSETS SATÉLITES ---
class DependentViewSet(viewsets.ModelViewSet):
    queryset = Dependent.objects.all()
    serializer_class = DependentSerializer
    permission_classes = [permissions.IsAuthenticated]
    def get_queryset(self):
        queryset = Dependent.objects.all()
        person_id = self.request.query_params.get('person')
        if person_id:
            queryset = queryset.filter(person=person_id)
        return queryset

class EmergencyContactViewSet(viewsets.ModelViewSet):
    queryset = EmergencyContact.objects.all()
    serializer_class = EmergencyContactSerializer
    permission_classes = [permissions.IsAuthenticated]
    def get_queryset(self):
        queryset = EmergencyContact.objects.all()
        person_id = self.request.query_params.get('person')
        if person_id:
            queryset = queryset.filter(person=person_id)
        return queryset
</file>

</files>
