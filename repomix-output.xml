This file is a merged representation of a subset of the codebase, containing specifically included files and files not matching ignore patterns, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Only files matching these patterns are included: backend/**/*, frontend2/**/*
- Files matching these patterns are excluded: frontend/**, **/*.md, **/*.png, **/*.jpg, **/*.jpeg, **/*.gif, **/*.svg, **/*.ico, **/*.lock, **/package-lock.json, **/pnpm-lock.yaml, **/yarn.lock, **/__pycache__/**, **/*.pyc, **/.env, **/.venv, **/node_modules/**, **/.git/**, **/.idea/**, **/.vscode/**, **/fixtures/*.json, **/fixtures/*.json, **/*.sqlite3, backend/debug_*.py, backend/expand_*.py, backend/reproduce_*.py, backend/verify_*.py
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
backend/
  accounts/
    migrations/
      __init__.py
      0001_initial.py
    __init__.py
    admin.py
    apps.py
    models.py
    serializers.py
    tests.py
    urls.py
    views.py
  ats/
    migrations/
      __init__.py
      0001_initial.py
      0002_remove_jobposting_department_and_more.py
      0003_add_phone_area_code_fields.py
      0004_remove_candidate_experience_details_and_more.py
      0005_candidate_avatar.py
      0006_candidatelog.py
      0007_historicalcandidate_historicaljobposting.py
      0008_alter_candidate_phone_area_code_and_more.py
    __init__.py
    admin.py
    apps.py
    models.py
    serializers.py
    services.py
    signals.py
    tests.py
    urls.py
    utils.py
    views_options.py
    views.py
  config/
    __init__.py
    asgi.py
    settings.py
    urls.py
    wsgi.py
  core/
    migrations/
      __init__.py
      0001_initial.py
      0002_alter_personbankaccount_account_number.py
      0003_historicalperson.py
      0004_remove_phone_prefix.py
      0005_phonecarriercode_alter_phoneareacode_unique_together_and_more.py
      0006_delete_phoneareacode_and_more.py
      0007_refine_validations.py
      0008_remove_salutation.py
      0009_make_gender_birthdate_required.py
      0010_alter_historicalperson_birthdate.py
    __init__.py
    admin.py
    apps.py
    db_utils.py
    filters.py
    models.py
    pagination.py
    serializers.py
    tests.py
    urls.py
    views.py
  employment/
    migrations/
      __init__.py
      0001_initial.py
      0002_historicalemployment.py
      0003_add_choice_fields.py
      0004_migrate_data_to_choices.py
      0005_alter_employmentstatuslog_status_and_more.py
      0006_historicalemploymentdepartmentrole_and_more.py
      0007_historicalpersondepartmentrole_persondepartmentrole.py
    __init__.py
    admin.py
    apps.py
    models.py
    serializers.py
    tests.py
    urls.py
    views.py
  organization/
    management/
      commands/
        __init__.py
        load_org_data.py
      __init__.py
    migrations/
      __init__.py
      0001_initial.py
      0002_historicaldepartment_historicalposition.py
      0003_remove_jobtitle_description.py
      0004_remove_historicalposition_name_remove_position_name.py
      0005_alter_position_unique_together.py
      0006_remove_historicalposition_manager_position_and_more.py
      0007_alter_department_name_alter_department_parent_and_more.py
      0008_historicalposition_objective_position_objective_and_more.py
      0009_historicalposition_is_manager_position_is_manager.py
    __init__.py
    admin.py
    apps.py
    models.py
    serializers.py
    tests.py
    urls.py
    views.py
  performance/
    migrations/
      __init__.py
      0001_initial.py
      0002_alter_performancereview_options.py
    __init__.py
    admin.py
    apps.py
    models.py
    serializers.py
    tests.py
    urls.py
    views.py
  recruitment/
    migrations/
      __init__.py
    __init__.py
    admin.py
    apps.py
    models.py
    tests.py
    views.py
  talent/
    migrations/
      __init__.py
      0001_initial.py
      0002_remove_personlanguage_reading_proficiency_and_more.py
      0003_personlanguage_reading_proficiency.py
    __init__.py
    admin.py
    apps.py
    models.py
    serializers.py
    tests.py
    urls.py
    views.py
  training/
    migrations/
      __init__.py
      0001_initial.py
      0002_alter_courseparticipant_status.py
      0003_course_cover_image.py
      0004_alter_courseparticipant_status.py
      0005_alter_courseparticipant_status.py
      0006_courseparticipant_academic_status_and_more.py
      0007_auto_20251126_1037.py
      0008_remove_courseparticipant_status.py
    __init__.py
    admin.py
    apps.py
    models.py
    permissions.py
    serializers.py
    tests.py
    urls.py
    views.py
  .gitignore
  .python-version
  cleanup_positions.py
  create_ats_test_data.py
  create_education_data.py
  generate_complete_org_fixtures.py
  generate_org_fixtures.py
  manage.py
  migrate_manager_data.py
  pyproject.toml
  test_api.py
frontend2/
  app/
    (main)/
      admin/
        config/
          general/
            [slug]/
              loading.tsx
              page.tsx
            loading.tsx
            page.tsx
          talent/
            [slug]/
              page.tsx
            page.tsx
        dashboard/
          loading.tsx
          page.tsx
        organization/
          [slug]/
            page.tsx
          positions/
            [id]/
              page.tsx
          page.tsx
        personnel/
          employees/
            [id]/
              page.tsx
            new/
              page.tsx
            page.tsx
          people/
            [id]/
              page.tsx
            new/
              page.tsx
            page.tsx
      layout.tsx
      page.tsx
    (test)/
      datepicker/
        page.tsx
      generales/
        page.tsx
      generales-two/
        page.tsx
      guide/
        page.tsx
      test/
        page.tsx
    login/
      page.tsx
    globals.css
    layout.tsx
  components/
    catalogs/
      catalog-card.tsx
      catalog-crud.tsx
      data-table.tsx
    layout/
      dashboard-layout.tsx
      dynamic-breadcrumbs.tsx
      header.tsx
      sidebar.tsx
    personnel/
      EmploymentForm.tsx
      PersonForm.tsx
    skeletons/
      dashboard-skeleton.tsx
      general-catalog-skeleton.tsx
      specific-catalog-skeleton.tsx
      table-skeleton.tsx
    ui/
      action-menu.tsx
      alert-dialog.tsx
      alert.tsx
      avatar.tsx
      badge.tsx
      breadcrumb.tsx
      button.tsx
      calendar.tsx
      card.tsx
      combobox.tsx
      command.tsx
      date-picker.tsx
      dialog.tsx
      dropdown-menu.tsx
      field.tsx
      file-upload.tsx
      form.tsx
      input.tsx
      item.tsx
      kbd.tsx
      label.tsx
      popover.tsx
      select.tsx
      separator.tsx
      sheet.tsx
      skeleton.tsx
      sonner.tsx
      switch.tsx
      table.tsx
      tabs.tsx
      textarea.tsx
    auth-loading.tsx
    command-menu.tsx
    iutirla-logo.tsx
    login-form.tsx
    notifications-sheet.tsx
    protected-route.tsx
    providers.tsx
    task-sheet.tsx
    user-menu.tsx
  context/
    auth-context.tsx
    breadcrumb-context.tsx
  lib/
    api-client.ts
    command-menu-data.ts
    fonts.ts
    utils.ts
  public/
    images/
      course-placeholder.webp
      iutirla-porlamar.webp
      iutirla-porlamar2.webp
      logoiutirla.webp
  .gitignore
  components.json
  eslint.config.mjs
  next.config.ts
  package.json
  pnpm-workspace.yaml
  postcss.config.mjs
  tsconfig.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="frontend2/app/(main)/admin/personnel/employees/new/page.tsx">
"use client";

import { EmploymentForm } from "@/components/personnel/EmploymentForm";
import { Button } from "@/components/ui/button";
import { ArrowLeft } from "lucide-react";
import { useRouter } from "next/navigation";

export default function NewEmployeePage() {
    const router = useRouter();

    return (
        <div className="flex flex-col h-full space-y-6 p-8">
            <div className="flex items-center justify-between border-b pb-6">
                <div>
                    <h1 className="text-2xl font-bold tracking-tight">Nuevo Empleado</h1>
                    <p className="text-muted-foreground">Registra un nuevo empleado en el sistema</p>
                </div>
                <Button variant="outline" onClick={() => router.back()}>
                    <ArrowLeft className="mr-2 h-4 w-4" />
                    Volver
                </Button>
            </div>

            <EmploymentForm />
        </div>
    );
}
</file>

<file path="frontend2/components/personnel/EmploymentForm.tsx">
"use client";

import { useState } from "react";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import * as z from "zod";
import { format } from "date-fns";
import { useRouter } from "next/navigation";
import { toast } from "sonner";
import useSWR from "swr";
import apiClient from "@/lib/api-client";
import { Button } from "@/components/ui/button";
import { Label } from "@/components/ui/label";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Combobox } from "@/components/ui/combobox";
import { DatePicker } from "@/components/ui/date-picker";
import { parseBackendDate } from "@/lib/utils";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { User, FileText, Mail } from "lucide-react";

const fetcher = (url: string) => apiClient.get(url).then(res => res.data.results || res.data);

const employmentSchema = z.object({
    person: z.string().min(1, "La persona es requerida"),
    position: z.string().min(1, "La posición es requerida"),
    role: z.string().min(1, "El rol es requerido"),
    employment_type: z.string().min(1, "El tipo de empleo es requerido"),
    current_status: z.string().min(1, "El estatus es requerido"),
    hire_date: z.string().min(1, "La fecha de contratación es requerida"),
    end_date: z.string().optional().nullable(),
}).superRefine((data, ctx) => {
    if (data.employment_type !== "FIJ" && !data.end_date) {
        ctx.addIssue({
            code: z.ZodIssueCode.custom,
            message: "La fecha de finalización es requerida para este tipo de empleo",
            path: ["end_date"],
        });
    }
});

export type EmploymentFormData = z.infer<typeof employmentSchema>;

interface EmploymentFormProps {
    initialData?: any;
    isEditing?: boolean;
    employmentId?: string;
    onSuccess?: () => void;
}

export function EmploymentForm({ initialData, isEditing = false, employmentId, onSuccess }: EmploymentFormProps) {
    const router = useRouter();
    const [isSubmitting, setIsSubmitting] = useState(false);

    const { data: persons } = useSWR("/api/core/persons/?page_size=1000", fetcher);
    const { data: departments } = useSWR("/api/organization/departments/?page_size=1000", fetcher);

    const [selectedDepartment, setSelectedDepartment] = useState<string>("");

    const { data: positions } = useSWR(
        selectedDepartment
            ? `/api/organization/positions/?department=${selectedDepartment}&page_size=1000`
            : null,
        fetcher
    );

    // Prepare default values
    const defaultValues = {
        person: initialData?.person?.toString() || "",
        position: initialData?.position?.toString() || "",
        role: initialData?.role || "EMP",
        employment_type: initialData?.employment_type || "FIJ",
        current_status: initialData?.current_status || "ACT",
        hire_date: initialData?.hire_date || "",
        end_date: initialData?.end_date || null,
    };

    const { handleSubmit, formState: { errors }, setValue, watch, setError } = useForm<EmploymentFormData>({
        resolver: zodResolver(employmentSchema),
        defaultValues
    });

    const selectedPersonId = watch("person");

    // Fetch full person details when selected
    const { data: fullPerson } = useSWR(
        selectedPersonId ? `/api/core/persons/${selectedPersonId}/` : null,
        fetcher
    );

    // Use fullPerson for display if available, otherwise fallback to list item (though list item might be incomplete)
    const selectedPerson = fullPerson || persons?.find((p: any) => p.id.toString() === selectedPersonId);

    const onSubmit = async (data: EmploymentFormData) => {
        setIsSubmitting(true);
        try {
            if (isEditing && employmentId) {
                await apiClient.patch(`/api/employment/employments/${employmentId}/`, data);
                toast.success("Empleado actualizado exitosamente");
            } else {
                await apiClient.post("/api/employment/employments/", data);
                toast.success("Empleado creado exitosamente");
                router.push("/admin/personnel/employees");
            }

            if (onSuccess) onSuccess();

        } catch (error: any) {
            console.error("Error submitting form:", error);
            if (error.response?.data) {
                const serverErrors = error.response.data;
                Object.keys(serverErrors).forEach((key) => {
                    if (key in defaultValues) {
                        setError(key as keyof EmploymentFormData, {
                            type: "server",
                            message: serverErrors[key][0] || serverErrors[key]
                        });
                    } else {
                        toast.error(`Error: ${serverErrors[key]}`);
                    }
                });
            } else {
                toast.error("Ocurrió un error al guardar el empleado");
            }
        } finally {
            setIsSubmitting(false);
        }
    };

    return (
        <form onSubmit={handleSubmit(onSubmit)}>
            <Card>
                <CardHeader>
                    <CardTitle>{isEditing ? "Editar Empleado" : "Nuevo Empleado"}</CardTitle>
                    <CardDescription>{isEditing ? "Actualiza los datos del empleado" : "Registra un nuevo empleado"}</CardDescription>
                </CardHeader>
                <CardContent>
                    <div className="grid gap-4 md:grid-cols-2">

                        <div className="space-y-2 md:col-span-2">
                            <Label htmlFor="person" className={errors.person ? "text-destructive" : ""}>Persona *</Label>
                            <Combobox
                                options={persons?.map((p: any) => ({ value: p.id.toString(), label: p.hiring_search || p.full_name })) || []}
                                value={watch("person")}
                                onSelect={(value) => setValue("person", value)}
                                placeholder="Buscar por nombre o cédula..."
                                className={errors.person ? "border-destructive" : ""}
                                disabled={isEditing} // Usually person shouldn't change on edit
                            />
                            {errors.person && (
                                <p className="text-sm text-destructive">{errors.person.message}</p>
                            )}
                        </div>

                        {selectedPerson && (
                            <div className="md:col-span-2 mb-4">
                                <Card>
                                    <CardHeader><CardTitle className="text-lg">Información Personal</CardTitle></CardHeader>
                                    <CardContent>
                                        <div className="grid gap-4 md:grid-cols-2">
                                            <InfoRow label="Primer Nombre" value={selectedPerson.first_name} />
                                            <InfoRow label="Segundo Nombre" value={selectedPerson.second_name} />
                                            <InfoRow label="Apellido Paterno" value={selectedPerson.paternal_surname} />
                                            <InfoRow label="Apellido Materno" value={selectedPerson.maternal_surname} />
                                            <InfoRow label="Fecha de Nacimiento" value={selectedPerson.birthdate} />
                                            <InfoRow label="País de Nacimiento" value={selectedPerson.country_of_birth_name} />
                                            <InfoRow label="Género" value={selectedPerson.gender_name} />
                                            <InfoRow label="Estado Civil" value={selectedPerson.marital_status_name} />
                                        </div>
                                    </CardContent>
                                </Card>
                            </div>
                        )}

                        <div className="space-y-2">
                            <Label>Departamento</Label>
                            <Combobox
                                options={departments?.map((d: any) => ({ value: d.id.toString(), label: d.name })) || []}
                                value={selectedDepartment}
                                onSelect={(value) => {
                                    setSelectedDepartment(value);
                                    setValue("position", ""); // Reset position when department changes
                                }}
                                placeholder="Filtrar por departamento..."
                            />
                        </div>

                        <div className="space-y-2">
                            <Label htmlFor="position" className={errors.position ? "text-destructive" : ""}>Posición *</Label>
                            <Combobox
                                options={positions?.map((p: any) => ({ value: p.id.toString(), label: p.job_title_name || `Posición ${p.id}` })) || []}
                                value={watch("position")}
                                onSelect={(value) => setValue("position", value)}
                                placeholder="Seleccionar posición"
                                className={errors.position ? "border-destructive" : ""}
                            />
                            {errors.position && (
                                <p className="text-sm text-destructive">{errors.position.message}</p>
                            )}
                        </div>

                        <div className="space-y-2">
                            <Label htmlFor="role" className={errors.role ? "text-destructive" : ""}>Rol *</Label>
                            <Combobox
                                options={[
                                    { value: "EMP", label: "Empleado" },
                                    { value: "MGR", label: "Manager" }
                                ]}
                                value={watch("role")}
                                onSelect={(value) => setValue("role", value)}
                                placeholder="Seleccionar rol"
                                className={errors.role ? "border-destructive" : ""}
                            />
                            {errors.role && (
                                <p className="text-sm text-destructive">{errors.role.message}</p>
                            )}
                        </div>

                        <div className="space-y-2">
                            <Label htmlFor="current_status" className={errors.current_status ? "text-destructive" : ""}>Estatus *</Label>
                            <Combobox
                                options={[
                                    { value: "ACT", label: "Activo" },
                                    { value: "SUS", label: "Suspendido" },
                                    { value: "PER", label: "De Permiso" },
                                    { value: "REP", label: "Reposo" },
                                    { value: "FIN", label: "Finalizado" },
                                    { value: "REN", label: "Renuncia" },
                                    { value: "DES", label: "Despido" },
                                    { value: "ANU", label: "Anulado" }
                                ]}
                                value={watch("current_status")}
                                onSelect={(value) => setValue("current_status", value)}
                                placeholder="Seleccionar estatus"
                                className={errors.current_status ? "border-destructive" : ""}
                            />
                            {errors.current_status && (
                                <p className="text-sm text-destructive">{errors.current_status.message}</p>
                            )}
                        </div>

                        <div className="space-y-2">
                            <Label htmlFor="employment_type" className={errors.employment_type ? "text-destructive" : ""}>Tipo de Empleo *</Label>
                            <Combobox
                                options={[
                                    { value: "FIJ", label: "Fijo" },
                                    { value: "TMP", label: "Temporal" },
                                    { value: "PAS", label: "Pasantía" }
                                ]}
                                value={watch("employment_type")}
                                onSelect={(value) => setValue("employment_type", value)}
                                placeholder="Seleccionar tipo"
                                className={errors.employment_type ? "border-destructive" : ""}
                            />
                            {errors.employment_type && (
                                <p className="text-sm text-destructive">{errors.employment_type.message}</p>
                            )}
                        </div>

                        <div className="space-y-2">
                            <Label>Fecha de Contratación *</Label>
                            <DatePicker
                                value={parseBackendDate(watch("hire_date"))}
                                onChange={(date) => {
                                    setValue("hire_date", date ? format(date, "yyyy-MM-dd") : "");
                                }}
                            />
                            {errors.hire_date && (
                                <p className="text-sm text-destructive">{errors.hire_date.message}</p>
                            )}
                        </div>

                        {watch("employment_type") !== "FIJ" && (
                            <div className="space-y-2">
                                <Label className={errors.end_date ? "text-destructive" : ""}>Fecha de Finalización *</Label>
                                <DatePicker
                                    value={parseBackendDate(watch("end_date") || "")}
                                    onChange={(date) => {
                                        setValue("end_date", date ? format(date, "yyyy-MM-dd") : null);
                                    }}
                                />
                                {errors.end_date && (
                                    <p className="text-sm text-destructive">{errors.end_date.message}</p>
                                )}
                            </div>
                        )}

                    </div>

                    <div className="flex justify-end gap-4 mt-6">
                        <Button type="button" variant="outline" onClick={() => router.back()}>
                            Cancelar
                        </Button>
                        <Button type="submit" disabled={isSubmitting}>
                            {isSubmitting ? "Guardando..." : (isEditing ? "Actualizar" : "Crear Empleado")}
                        </Button>
                    </div>
                </CardContent>
            </Card>
        </form>
    );
}

function InfoRow({ label, value }: { label: string, value: string | null | undefined }) {
    return (
        <div className="flex justify-between border-b pb-2 last:pb-0">
            <span className="text-sm font-medium text-muted-foreground">{label}</span>
            <span className="text-sm text-right">{value || "-"}</span>
        </div>
    );
}
</file>

<file path="backend/accounts/admin.py">
from django.contrib import admin
from django.contrib.auth.admin import UserAdmin
from .models import User

class CustomUserAdmin(UserAdmin):
    model = User
    list_display = (
        'username',
        'person',
        'is_staff',
        'is_active'
        )
    search_fields = (
        'username', 
        'person__first_name', 
        'person__paternal_surname'
        )
    list_filter = (
        'is_staff',
        'is_active',
        'is_superuser'
        )
    fieldsets = (
        (
            None, 
            {
                'fields': (
                'username',
                'password'
                )
            }
        ),
        (
            'Personal info', 
            {
                'fields': (
                'person',
                )
            }
        ),
        (
            'Permissions', 
            {
                'fields': (
                    'is_active',
                    'is_staff', 
                    'is_superuser', 
                    'groups', 
                    'user_permissions'
                )
            }
            ),
        (
            'Important dates', 
            {
                'fields': (
                    'last_login', 
                    'created_at'
                )
            }
        ),
    )
    readonly_fields = (
        'last_login', 
        'created_at', 
        'updated_at'
        )

admin.site.register(User, CustomUserAdmin)
</file>

<file path="backend/accounts/apps.py">
from django.apps import AppConfig


class AccountsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'accounts'
</file>

<file path="backend/accounts/models.py">
from django.db import models
from django.contrib.auth.models import (
    AbstractBaseUser, BaseUserManager, PermissionsMixin
)
from core.models import Person

class UserManager(BaseUserManager):
    def create_user(self, username, password=None, **extra_fields):
        if not username:
            raise ValueError('El campo Username es obligatorio')
        
        # Normalización básica
        username = username.strip().lower()
        user = self.model(username=username, **extra_fields)
        user.set_password(password)
        user.save(using=self._db)
        return user

    def create_superuser(self, username, password=None, **extra_fields):
        extra_fields.setdefault('is_staff', True)
        extra_fields.setdefault('is_superuser', True)
        extra_fields.setdefault('is_active', True)

        if extra_fields.get('is_staff') is not True:
            raise ValueError('Superuser must have is_staff=True.')
        if extra_fields.get('is_superuser') is not True:
            raise ValueError('Superuser must have is_superuser=True.')
        extra_fields.setdefault('person', None) 
        
        return self.create_user(username, password, **extra_fields)

class User(AbstractBaseUser, PermissionsMixin):
    person = models.OneToOneField(
        Person, 
        on_delete=models.SET_NULL, 
        null=True, 
        blank=True,
        related_name='user_account' # Permite acceder desde Person: person.user_account
    )
    username = models.CharField(
        max_length=100, 
        unique=True,
        error_messages={
            'unique': "Este nombre de usuario ya está registrado.",
            'blank': "El nombre de usuario es obligatorio."
        }
    )
    is_active = models.BooleanField(default=True)
    is_staff = models.BooleanField(default=False)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    objects = UserManager()
    
    USERNAME_FIELD = 'username'
    REQUIRED_FIELDS = []

    def __str__(self):
        return self.username
</file>

<file path="backend/accounts/tests.py">
from django.test import TestCase

# Create your tests here.
</file>

<file path="backend/accounts/urls.py">
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .views import UserViewSet

router = DefaultRouter()
router.register(r'users', UserViewSet, basename='user')

urlpatterns = [
    path('', include(router.urls)),
]
</file>

<file path="backend/accounts/views.py">
from rest_framework import viewsets, permissions
from .models import User
from .serializers import UserReadSerializer, EmployeeCreationSerializer

class UserViewSet(viewsets.ModelViewSet):
    queryset = User.objects.all().select_related('person')
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]

    def get_serializer_class(self):
        if self.action == 'create':
            return EmployeeCreationSerializer
        return UserReadSerializer
</file>

<file path="backend/ats/migrations/0001_initial.py">
# Generated by Django 5.2.8 on 2025-11-26 23:39

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('organization', '0001_initial'),
    ]

    operations = [
        migrations.CreateModel(
            name='Candidate',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('first_name', models.CharField(max_length=100, verbose_name='Nombre')),
                ('last_name', models.CharField(max_length=100, verbose_name='Apellido')),
                ('email', models.EmailField(max_length=254, verbose_name='Correo Electrónico')),
                ('phone', models.CharField(max_length=20, verbose_name='Teléfono')),
                ('national_id', models.CharField(help_text='Documento de identidad', max_length=20, verbose_name='Cédula/ID Nacional')),
                ('cv_file', models.FileField(help_text='Archivo PDF del currículum', upload_to='candidates/cv/', verbose_name='Currículum (PDF)')),
                ('education_details', models.TextField(blank=True, help_text='Información educativa (JSON o texto)', null=True, verbose_name='Detalles de Educación')),
                ('experience_details', models.TextField(blank=True, help_text='Historial laboral (JSON o texto)', null=True, verbose_name='Detalles de Experiencia')),
                ('portfolio_url', models.URLField(blank=True, help_text='Enlace a portafolio o LinkedIn', null=True, verbose_name='URL de Portafolio')),
                ('stage', models.CharField(choices=[('NEW', 'Nuevo'), ('REV', 'En Revisión'), ('INT', 'Entrevista/Pruebas'), ('OFF', 'Oferta Enviada'), ('HIRED', 'Contratado'), ('REJ', 'Rechazado'), ('POOL', 'Banco de Elegibles')], default='NEW', max_length=5, verbose_name='Etapa')),
                ('notes', models.TextField(blank=True, help_text='Comentarios del reclutador sobre el candidato', null=True, verbose_name='Notas Internas')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
            ],
            options={
                'verbose_name': 'Candidato',
                'verbose_name_plural': 'Candidatos',
                'ordering': ['-created_at'],
            },
        ),
        migrations.CreateModel(
            name='CandidateEducation',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('school_name', models.CharField(max_length=255, verbose_name='Institución')),
                ('level_name', models.CharField(help_text='Ej: Ingeniería, Licenciatura, Maestría', max_length=100, verbose_name='Nivel Educativo')),
                ('field_name', models.CharField(help_text='Ej: Informática, Administración', max_length=100, verbose_name='Área de Estudio')),
                ('start_date', models.DateField(verbose_name='Fecha de Inicio')),
                ('end_date', models.DateField(blank=True, help_text='Dejar vacío si está en curso', null=True, verbose_name='Fecha de Finalización')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('candidate', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='education', to='ats.candidate', verbose_name='Candidato')),
            ],
            options={
                'verbose_name': 'Educación de Candidato',
                'verbose_name_plural': 'Educación de Candidatos',
                'ordering': ['-start_date'],
            },
        ),
        migrations.CreateModel(
            name='CandidateExperience',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('company_name', models.CharField(max_length=255, verbose_name='Empresa')),
                ('position_title', models.CharField(max_length=200, verbose_name='Cargo')),
                ('start_date', models.DateField(verbose_name='Fecha de Inicio')),
                ('end_date', models.DateField(blank=True, help_text='Dejar vacío si es actual', null=True, verbose_name='Fecha de Finalización')),
                ('description', models.TextField(blank=True, help_text='Responsabilidades y logros', null=True, verbose_name='Descripción')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('candidate', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='experience', to='ats.candidate', verbose_name='Candidato')),
            ],
            options={
                'verbose_name': 'Experiencia de Candidato',
                'verbose_name_plural': 'Experiencias de Candidatos',
                'ordering': ['-start_date'],
            },
        ),
        migrations.CreateModel(
            name='JobPosting',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('title', models.CharField(help_text='Ej: Desarrollador Frontend Senior', max_length=200, verbose_name='Título de la Vacante')),
                ('description', models.TextField(help_text='Descripción completa de la vacante', verbose_name='Descripción')),
                ('salary_range', models.CharField(blank=True, help_text='Ej: $800 - $1200 USD', max_length=100, null=True, verbose_name='Rango Salarial')),
                ('location', models.CharField(blank=True, help_text='Ej: Caracas, Venezuela / Remoto', max_length=200, null=True, verbose_name='Ubicación')),
                ('ask_education', models.BooleanField(default=False, help_text='¿El formulario debe pedir información educativa?', verbose_name='Solicitar Educación')),
                ('ask_experience', models.BooleanField(default=False, help_text='¿El formulario debe pedir experiencia laboral?', verbose_name='Solicitar Experiencia')),
                ('ask_portfolio', models.BooleanField(default=False, help_text='¿El formulario debe pedir URL de portafolio?', verbose_name='Solicitar Portafolio')),
                ('status', models.CharField(choices=[('DRAFT', 'Borrador'), ('PUBLISHED', 'Publicada'), ('CLOSED', 'Cerrada'), ('FROZEN', 'Congelada')], default='DRAFT', max_length=10, verbose_name='Estado')),
                ('published_date', models.DateField(blank=True, null=True, verbose_name='Fecha de Publicación')),
                ('closing_date', models.DateField(blank=True, null=True, verbose_name='Fecha de Cierre')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('department', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='organization.department', verbose_name='Departamento')),
                ('position', models.ForeignKey(help_text='Posición organizacional a la que corresponde', null=True, on_delete=django.db.models.deletion.SET_NULL, to='organization.position', verbose_name='Posición')),
            ],
            options={
                'verbose_name': 'Vacante',
                'verbose_name_plural': 'Vacantes',
                'ordering': ['-created_at'],
            },
        ),
        migrations.AddField(
            model_name='candidate',
            name='job_posting',
            field=models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='candidates', to='ats.jobposting', verbose_name='Vacante'),
        ),
        migrations.AlterUniqueTogether(
            name='candidate',
            unique_together={('job_posting', 'email')},
        ),
    ]
</file>

<file path="backend/ats/migrations/0002_remove_jobposting_department_and_more.py">
# Generated by Django 5.2.8 on 2025-11-27 03:05

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ('ats', '0001_initial'),
    ]

    operations = [
        migrations.RemoveField(
            model_name='jobposting',
            name='department',
        ),
        migrations.RemoveField(
            model_name='jobposting',
            name='salary_range',
        ),
    ]
</file>

<file path="backend/ats/migrations/0003_add_phone_area_code_fields.py">
# Generated by Django 5.2.8 on 2025-11-27 14:09

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('ats', '0002_remove_jobposting_department_and_more'),
        ('core', '0002_alter_personbankaccount_account_number'),
    ]

    operations = [
        migrations.AddField(
            model_name='candidate',
            name='phone_area_code',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.phoneareacode', verbose_name='Código de Área'),
        ),
        migrations.AddField(
            model_name='candidate',
            name='phone_subscriber',
            field=models.CharField(blank=True, max_length=10, null=True, verbose_name='Número de Suscriptor'),
        ),
        migrations.AlterField(
            model_name='candidate',
            name='phone',
            field=models.CharField(blank=True, max_length=20, null=True, verbose_name='Teléfono (Completo)'),
        ),
    ]
</file>

<file path="backend/ats/migrations/0004_remove_candidate_experience_details_and_more.py">
# Generated by Django 5.2.8 on 2025-11-27 15:16

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ('ats', '0003_add_phone_area_code_fields'),
    ]

    operations = [
        migrations.RemoveField(
            model_name='candidate',
            name='experience_details',
        ),
        migrations.RemoveField(
            model_name='candidate',
            name='portfolio_url',
        ),
        migrations.RemoveField(
            model_name='jobposting',
            name='ask_experience',
        ),
        migrations.RemoveField(
            model_name='jobposting',
            name='ask_portfolio',
        ),
        migrations.DeleteModel(
            name='CandidateExperience',
        ),
    ]
</file>

<file path="backend/ats/migrations/0005_candidate_avatar.py">
# Generated by Django 5.2.8 on 2025-11-27 16:43

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('ats', '0004_remove_candidate_experience_details_and_more'),
    ]

    operations = [
        migrations.AddField(
            model_name='candidate',
            name='avatar',
            field=models.ImageField(blank=True, null=True, upload_to='candidates/avatars/', verbose_name='Foto de Perfil'),
        ),
    ]
</file>

<file path="backend/ats/migrations/0006_candidatelog.py">
# Generated by Django 5.2.8 on 2025-11-27 17:16

import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('ats', '0005_candidate_avatar'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='CandidateLog',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('action', models.CharField(max_length=50, verbose_name='Acción')),
                ('details', models.TextField(blank=True, null=True, verbose_name='Detalles')),
                ('timestamp', models.DateTimeField(auto_now_add=True)),
                ('candidate', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='logs', to='ats.candidate', verbose_name='Candidato')),
                ('user', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL, verbose_name='Usuario')),
            ],
            options={
                'verbose_name': 'Registro de Actividad',
                'verbose_name_plural': 'Registros de Actividad',
                'ordering': ['-timestamp'],
            },
        ),
    ]
</file>

<file path="backend/ats/migrations/0007_historicalcandidate_historicaljobposting.py">
# Generated by Django 5.2.8 on 2025-11-27 20:56

import django.db.models.deletion
import simple_history.models
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('ats', '0006_candidatelog'),
        ('core', '0003_historicalperson'),
        ('organization', '0002_historicaldepartment_historicalposition'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='HistoricalCandidate',
            fields=[
                ('id', models.BigIntegerField(auto_created=True, blank=True, db_index=True, verbose_name='ID')),
                ('first_name', models.CharField(max_length=100, verbose_name='Nombre')),
                ('last_name', models.CharField(max_length=100, verbose_name='Apellido')),
                ('email', models.EmailField(max_length=254, verbose_name='Correo Electrónico')),
                ('phone_subscriber', models.CharField(blank=True, max_length=10, null=True, verbose_name='Número de Suscriptor')),
                ('phone', models.CharField(blank=True, max_length=20, null=True, verbose_name='Teléfono (Completo)')),
                ('national_id', models.CharField(help_text='Documento de identidad', max_length=20, verbose_name='Cédula/ID Nacional')),
                ('avatar', models.TextField(blank=True, max_length=100, null=True, verbose_name='Foto de Perfil')),
                ('cv_file', models.TextField(help_text='Archivo PDF del currículum', max_length=100, verbose_name='Currículum (PDF)')),
                ('education_details', models.TextField(blank=True, help_text='Información educativa (JSON o texto)', null=True, verbose_name='Detalles de Educación')),
                ('stage', models.CharField(choices=[('NEW', 'Nuevo'), ('REV', 'En Revisión'), ('INT', 'Entrevista/Pruebas'), ('OFF', 'Oferta Enviada'), ('HIRED', 'Contratado'), ('REJ', 'Rechazado'), ('POOL', 'Banco de Elegibles')], default='NEW', max_length=5, verbose_name='Etapa')),
                ('notes', models.TextField(blank=True, help_text='Comentarios del reclutador sobre el candidato', null=True, verbose_name='Notas Internas')),
                ('created_at', models.DateTimeField(blank=True, editable=False)),
                ('updated_at', models.DateTimeField(blank=True, editable=False)),
                ('history_id', models.AutoField(primary_key=True, serialize=False)),
                ('history_date', models.DateTimeField(db_index=True)),
                ('history_change_reason', models.CharField(max_length=100, null=True)),
                ('history_type', models.CharField(choices=[('+', 'Created'), ('~', 'Changed'), ('-', 'Deleted')], max_length=1)),
                ('history_user', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('job_posting', models.ForeignKey(blank=True, db_constraint=False, null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='ats.jobposting', verbose_name='Vacante')),
                ('phone_area_code', models.ForeignKey(blank=True, db_constraint=False, null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='core.phoneareacode', verbose_name='Código de Área')),
            ],
            options={
                'verbose_name': 'historical Candidato',
                'verbose_name_plural': 'historical Candidatos',
                'ordering': ('-history_date', '-history_id'),
                'get_latest_by': ('history_date', 'history_id'),
            },
            bases=(simple_history.models.HistoricalChanges, models.Model),
        ),
        migrations.CreateModel(
            name='HistoricalJobPosting',
            fields=[
                ('id', models.BigIntegerField(auto_created=True, blank=True, db_index=True, verbose_name='ID')),
                ('title', models.CharField(help_text='Ej: Desarrollador Frontend Senior', max_length=200, verbose_name='Título de la Vacante')),
                ('description', models.TextField(help_text='Descripción completa de la vacante', verbose_name='Descripción')),
                ('location', models.CharField(blank=True, help_text='Ej: Caracas, Venezuela / Remoto', max_length=200, null=True, verbose_name='Ubicación')),
                ('ask_education', models.BooleanField(default=False, help_text='¿El formulario debe pedir información educativa?', verbose_name='Solicitar Educación')),
                ('status', models.CharField(choices=[('DRAFT', 'Borrador'), ('PUBLISHED', 'Publicada'), ('CLOSED', 'Cerrada'), ('FROZEN', 'Congelada')], default='DRAFT', max_length=10, verbose_name='Estado')),
                ('published_date', models.DateField(blank=True, null=True, verbose_name='Fecha de Publicación')),
                ('closing_date', models.DateField(blank=True, null=True, verbose_name='Fecha de Cierre')),
                ('created_at', models.DateTimeField(blank=True, editable=False)),
                ('updated_at', models.DateTimeField(blank=True, editable=False)),
                ('history_id', models.AutoField(primary_key=True, serialize=False)),
                ('history_date', models.DateTimeField(db_index=True)),
                ('history_change_reason', models.CharField(max_length=100, null=True)),
                ('history_type', models.CharField(choices=[('+', 'Created'), ('~', 'Changed'), ('-', 'Deleted')], max_length=1)),
                ('history_user', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('position', models.ForeignKey(blank=True, db_constraint=False, help_text='Posición organizacional a la que corresponde', null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='organization.position', verbose_name='Posición')),
            ],
            options={
                'verbose_name': 'historical Vacante',
                'verbose_name_plural': 'historical Vacantes',
                'ordering': ('-history_date', '-history_id'),
                'get_latest_by': ('history_date', 'history_id'),
            },
            bases=(simple_history.models.HistoricalChanges, models.Model),
        ),
    ]
</file>

<file path="backend/ats/migrations/0008_alter_candidate_phone_area_code_and_more.py">
# Generated by Django 5.2.8 on 2025-11-29 20:48

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('ats', '0007_historicalcandidate_historicaljobposting'),
        ('core', '0005_phonecarriercode_alter_phoneareacode_unique_together_and_more'),
    ]

    operations = [
        migrations.AlterField(
            model_name='candidate',
            name='phone_area_code',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.phonecarriercode', verbose_name='Código de Área'),
        ),
        migrations.AlterField(
            model_name='historicalcandidate',
            name='phone_area_code',
            field=models.ForeignKey(blank=True, db_constraint=False, null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='core.phonecarriercode', verbose_name='Código de Área'),
        ),
    ]
</file>

<file path="backend/ats/admin.py">
from django.contrib import admin
from .models import JobPosting, Candidate, CandidateEducation


@admin.register(JobPosting)
class JobPostingAdmin(admin.ModelAdmin):
    list_display = ['title', 'position', 'status', 'published_date', 'closing_date', 'created_at']
    list_filter = ['status', 'ask_education']
    search_fields = ['title', 'description']
    date_hierarchy = 'created_at'
    
    fieldsets = (
        ('Información Básica', {
            'fields': ('title', 'description', 'position')
        }),
        ('Detalles de la Oferta', {
            'fields': ('location',)
        }),
        ('Configuración del Formulario', {
            'fields': ('ask_education',),
            'description': 'Define qué campos serán requeridos en el formulario público'
        }),
        ('Estado y Fechas', {
            'fields': ('status', 'published_date', 'closing_date')
        }),
    )


class CandidateEducationInline(admin.TabularInline):
    model = CandidateEducation
    extra = 0





@admin.register(Candidate)
class CandidateAdmin(admin.ModelAdmin):
    list_display = ['full_name', 'email', 'job_posting', 'stage', 'created_at']
    list_filter = ['stage', 'job_posting', 'created_at']
    search_fields = ['first_name', 'last_name', 'email', 'national_id']
    date_hierarchy = 'created_at'
    inlines = [CandidateEducationInline]
    
    fieldsets = (
        ('Vacante', {
            'fields': ('job_posting',)
        }),
        ('Información Personal', {
            'fields': ('first_name', 'last_name', 'email', 'phone', 'national_id')
        }),
        ('Documentación', {
            'fields': ('cv_file',)
        }),
        ('Información Adicional', {
            'fields': ('education_details',),
            'classes': ('collapse',)
        }),
        ('Pipeline', {
            'fields': ('stage', 'notes')
        }),
    )
    
    def full_name(self, obj):
        return f"{obj.first_name} {obj.last_name}"
    full_name.short_description = 'Nombre Completo'
</file>

<file path="backend/ats/apps.py">
from django.apps import AppConfig


class AtsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'ats'

    def ready(self):
        import ats.signals
</file>

<file path="backend/ats/models.py">
from django.db import models
from django.core.exceptions import ValidationError
from django.utils import timezone
from django.conf import settings
from simple_history.models import HistoricalRecords
from organization.models import Position, Department

# Mensajes de error estándar
UNIQUE_ERR_MSG = {'unique': "Ya existe un registro con este nombre."}


class JobPosting(models.Model):
    """Vacante publicable con configuración dinámica de formulario"""
    
    STATUS_CHOICES = [
        ('DRAFT', 'Borrador'),
        ('PUBLISHED', 'Publicada'),
        ('CLOSED', 'Cerrada'),
        ('FROZEN', 'Congelada'),
    ]
    
    # Información básica
    title = models.CharField(
        max_length=200,
        verbose_name="Título de la Vacante",
        help_text="Ej: Desarrollador Frontend Senior"
    )
    description = models.TextField(
        verbose_name="Descripción",
        help_text="Descripción completa de la vacante"
    )
    
    # Relaciones
    position = models.ForeignKey(
        Position,
        on_delete=models.SET_NULL,
        null=True,
        verbose_name="Posición",
        help_text="Posición organizacional a la que corresponde"
    )
    
    # Detalles de la oferta
    location = models.CharField(
        max_length=200,
        blank=True,
        null=True,
        verbose_name="Ubicación",
        help_text="Ej: Caracas, Venezuela / Remoto"
    )
    
    # Configuración dinámica del formulario público
    ask_education = models.BooleanField(
        default=False,
        verbose_name="Solicitar Educación",
        help_text="¿El formulario debe pedir información educativa?"
    )

    
    # Estado y fechas
    status = models.CharField(
        max_length=10,
        choices=STATUS_CHOICES,
        default='DRAFT',
        verbose_name="Estado"
    )
    published_date = models.DateField(
        null=True,
        blank=True,
        verbose_name="Fecha de Publicación"
    )
    closing_date = models.DateField(
        null=True,
        blank=True,
        verbose_name="Fecha de Cierre"
    )
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    # Historial de cambios
    history = HistoricalRecords()
    
    class Meta:
        verbose_name = "Vacante"
        verbose_name_plural = "Vacantes"
        ordering = ['-created_at']
    
    def __str__(self):
        return f"{self.title} ({self.get_status_display()})"
    
    def clean(self):
        """Validaciones personalizadas"""
        if self.status == 'PUBLISHED' and not self.published_date:
            self.published_date = timezone.now().date()
        
        if self.closing_date and self.published_date:
            if self.closing_date < self.published_date:
                raise ValidationError("La fecha de cierre no puede ser anterior a la de publicación")
    
    def save(self, *args, **kwargs):
        self.clean()
        super().save(*args, **kwargs)


class Candidate(models.Model):
    """Candidato temporal (no es empleado aún)"""
    
    STAGE_CHOICES = [
        ('NEW', 'Nuevo'),
        ('REV', 'En Revisión'),
        ('INT', 'Entrevista/Pruebas'),
        ('OFF', 'Oferta Enviada'),
        ('HIRED', 'Contratado'),
        ('REJ', 'Rechazado'),
        ('POOL', 'Banco de Elegibles'),
    ]
    
    # Relación con la vacante
    job_posting = models.ForeignKey(
        JobPosting,
        on_delete=models.CASCADE,
        related_name='candidates',
        verbose_name="Vacante"
    )
    
    # Datos personales básicos
    first_name = models.CharField(
        max_length=100,
        verbose_name="Nombre"
    )
    last_name = models.CharField(
        max_length=100,
        verbose_name="Apellido"
    )
    email = models.EmailField(
        verbose_name="Correo Electrónico"
    )
    
    # Teléfono - Nuevo formato (separado)
    phone_area_code = models.ForeignKey(
        'core.PhoneCarrierCode',
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        verbose_name="Código de Área"
    )
    phone_subscriber = models.CharField(
        max_length=10,
        blank=True,
        null=True,
        verbose_name="Número de Suscriptor"
    )
    
    # Teléfono - Formato antiguo (para retrocompatibilidad)
    phone = models.CharField(
        max_length=20,
        blank=True,
        null=True,
        verbose_name="Teléfono (Completo)"
    )
    
    national_id = models.CharField(
        max_length=20,
        verbose_name="Cédula/ID Nacional",
        help_text="Documento de identidad"
    )
    
    avatar = models.ImageField(
        upload_to='candidates/avatars/',
        null=True,
        blank=True,
        verbose_name="Foto de Perfil"
    )
    
    # CV obligatorio
    cv_file = models.FileField(
        upload_to='candidates/cv/',
        verbose_name="Currículum (PDF)",
        help_text="Archivo PDF del currículum"
    )
    
    # Campos dinámicos opcionales (según configuración de JobPosting)
    education_details = models.TextField(
        blank=True,
        null=True,
        verbose_name="Detalles de Educación",
        help_text="Información educativa (JSON o texto)"
    )
    
    # Pipeline (máquina de estados)
    stage = models.CharField(
        max_length=5,
        choices=STAGE_CHOICES,
        default='NEW',
        verbose_name="Etapa"
    )
    
    # Notas del reclutador
    notes = models.TextField(
        blank=True,
        null=True,
        verbose_name="Notas Internas",
        help_text="Comentarios del reclutador sobre el candidato"
    )
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    # Historial de cambios
    history = HistoricalRecords()
    
    class Meta:
        verbose_name = "Candidato"
        verbose_name_plural = "Candidatos"
        ordering = ['-created_at']
        # Evitar duplicados: misma persona aplicando a la misma vacante
        unique_together = [('job_posting', 'email')]
    
    def __str__(self):
        return f"{self.first_name} {self.last_name} - {self.job_posting.title}"

    def save(self, *args, **kwargs):
        # Auto-populate legacy phone field
        if self.phone_area_code and self.phone_subscriber:
            self.phone = f"{self.phone_area_code.code}-{self.phone_subscriber}"
        super().save(*args, **kwargs)


class CandidateEducation(models.Model):
    """Educación del candidato (se migrará a PersonEducation al contratar)"""
    
    candidate = models.ForeignKey(
        Candidate,
        on_delete=models.CASCADE,
        related_name='education',
        verbose_name="Candidato"
    )
    
    school_name = models.CharField(
        max_length=255,
        verbose_name="Institución"
    )
    level_name = models.CharField(
        max_length=100,
        verbose_name="Nivel Educativo",
        help_text="Ej: Ingeniería, Licenciatura, Maestría"
    )
    field_name = models.CharField(
        max_length=100,
        verbose_name="Área de Estudio",
        help_text="Ej: Informática, Administración"
    )
    start_date = models.DateField(
        verbose_name="Fecha de Inicio"
    )
    end_date = models.DateField(
        null=True,
        blank=True,
        verbose_name="Fecha de Finalización",
        help_text="Dejar vacío si está en curso"
    )
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        verbose_name = "Educación de Candidato"
        verbose_name_plural = "Educación de Candidatos"
        ordering = ['-start_date']
    
    def __str__(self):
        return f"{self.school_name} - {self.level_name}"


class CandidateLog(models.Model):
    """Registro de auditoría para cambios en candidatos"""
    
    candidate = models.ForeignKey(
        Candidate,
        on_delete=models.CASCADE,
        related_name='logs',
        verbose_name="Candidato"
    )
    user = models.ForeignKey(
        settings.AUTH_USER_MODEL,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        verbose_name="Usuario"
    )
    action = models.CharField(
        max_length=50,
        verbose_name="Acción"
    )
    details = models.TextField(
        blank=True,
        null=True,
        verbose_name="Detalles"
    )
    timestamp = models.DateTimeField(auto_now_add=True)
    
    class Meta:
        verbose_name = "Registro de Actividad"
        verbose_name_plural = "Registros de Actividad"
        ordering = ['-timestamp']
    
    def __str__(self):
        return f"{self.candidate} - {self.action} - {self.timestamp}"
</file>

<file path="backend/ats/serializers.py">
from rest_framework import serializers
from .models import JobPosting, Candidate, CandidateEducation, CandidateLog
from organization.models import Position, Department
from core.models import PhoneCarrierCode


# --- Serializers para Educación y Experiencia (Anidados) ---

class CandidateEducationSerializer(serializers.ModelSerializer):
    class Meta:
        model = CandidateEducation
        fields = ['id', 'school_name', 'level_name', 'field_name', 'start_date', 'end_date']





class PhoneCarrierCodeSerializer(serializers.ModelSerializer):
    class Meta:
        model = PhoneCarrierCode
        fields = ['id', 'code', 'carrier']


# --- Serializers para JobPosting ---

class JobPostingListSerializer(serializers.ModelSerializer):
    """Serializer para listar vacantes en el portal público (solo campos públicos)"""
    department_name = serializers.CharField(source='position.department.name', read_only=True)
    position_title = serializers.CharField(source='position.job_title.name', read_only=True, allow_null=True)
    candidates_count = serializers.SerializerMethodField()
    
    class Meta:
        model = JobPosting
        fields = [
            'id', 'title', 'location', 
            'department_name', 'position_title',
            'published_date', 'closing_date', 'candidates_count'
        ]
    
    def get_candidates_count(self, obj):
        return obj.candidates.count()


class JobPostingDetailSerializer(serializers.ModelSerializer):
    """Serializer detallado para ver una vacante específica (incluye configuración)"""
    department_name = serializers.CharField(source='position.department.name', read_only=True)
    position_title = serializers.CharField(source='position.job_title.name', read_only=True, allow_null=True)
    position_objectives = serializers.SerializerMethodField()
    position_requirements = serializers.SerializerMethodField()
    
    class Meta:
        model = JobPosting
        fields = [
            'id', 'title', 'description', 'location',
            'department_name',
            'position', 'position_title', 'position_objectives', 'position_requirements',
            'ask_education',
            'status', 'published_date', 'closing_date',
            'created_at', 'updated_at'
        ]
    
    def get_position_objectives(self, obj):
        if obj.position:
            return [o.description for o in obj.position.objectives.all()]
        return []
    
    def get_position_requirements(self, obj):
        if obj.position:
            return [r.description for r in obj.position.requirements.all()]
        return []


class JobPostingAdminSerializer(serializers.ModelSerializer):
    """Serializer para administración completa de vacantes"""
    candidates_count = serializers.SerializerMethodField()
    department_name = serializers.CharField(source='position.department.name', read_only=True)
    position_title = serializers.CharField(source='position.job_title.name', read_only=True, allow_null=True)
    
    class Meta:
        model = JobPosting
        fields = '__all__'
    
    def get_candidates_count(self, obj):
        return obj.candidates.count()

    def validate(self, data):
        """Validar que la posición tenga cupos disponibles y no haya vacantes duplicadas"""
        position = data.get('position')
        status = data.get('status', 'DRAFT')  # Obtener el estado que se está intentando guardar
        
        # Solo validamos si se está asignando una posición
        if position:
            # 1. Validar que no exista otra vacante PUBLISHED para la misma posición
            # Solo si intentamos publicar esta vacante
            if status == 'PUBLISHED':
                existing_posting = JobPosting.objects.filter(
                    position=position,
                    status='PUBLISHED'
                )
                if self.instance:
                    existing_posting = existing_posting.exclude(pk=self.instance.pk)
                
                if existing_posting.exists():
                    raise serializers.ValidationError({
                        "position": f"Ya existe una vacante publicada para la posición '{position.name or position.job_title.name}'. No se pueden publicar dos vacantes simultáneamente para la misma posición."
                    })

            # 2. Contar empleados activos en esta posición
            from employment.models import Employment
            
            active_employees_count = Employment.objects.filter(
                position=position,
                current_status__is_active_relationship=True
            ).count()
            
            # Verificar si hay vacantes disponibles
            # Cupos libres = Total Vacantes - Empleados Activos
            if active_employees_count >= position.vacancies:
                raise serializers.ValidationError({
                    "position": f"No se puede crear la vacante. La posición '{position.name or position.job_title.name}' ya está ocupada al 100% ({active_employees_count}/{position.vacancies} ocupados)."
                })
        
        # Validar título solo letras y espacios
        title = data.get('title')
        if title:
            import re
            if not re.match(r'^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$', title):
                raise serializers.ValidationError({"title": "El título solo puede contener letras y espacios."})

        return data


# --- Serializers para Candidate ---

class CandidateCreateSerializer(serializers.ModelSerializer):
    """Serializer para crear candidato desde el portal público (postulación)"""
    education = CandidateEducationSerializer(many=True, required=False)
    class Meta:
        model = Candidate
        fields = [
            'job_posting', 'first_name', 'last_name', 'email',
            'phone_area_code', 'phone_subscriber', 'phone',  # Ambos formatos
            'national_id', 'cv_file', 'avatar',
            'education'
        ]
        extra_kwargs = {
            'phone': {'required': False},  # Opcional, para retrocompatibilidad
            'phone_area_code': {'required': False},
            'phone_subscriber': {'required': False},
        }
    
    def validate_email(self, value):
        """Validar que el email no pertenezca a un empleado existente"""
        from core.models import PersonEmail
        
        if PersonEmail.objects.filter(email_address=value).exists():
            raise serializers.ValidationError(
                "Este correo electrónico ya está registrado en el sistema. "
                "Si ya trabajas en la institución, por favor contacta al departamento de RRHH."
            )
        return value
    
    def validate_national_id(self, value):
        """Validar que la cédula no pertenezca a un empleado existente"""
        from core.models import NationalId
        import re
        
        # El valor puede venir como "V-12345678" o solo "12345678"
        # Limpiar y parsear
        cleaned = value.strip().upper()
        
        # Intentar extraer tipo y número
        match = re.match(r'^([VEJGP])-?(\d+)$', cleaned)
        if match:
            doc_type = match.group(1)
            doc_number = match.group(2)
            
            # Verificar si ya existe en NationalId
            if NationalId.objects.filter(document_type=doc_type, number=doc_number).exists():
                raise serializers.ValidationError(
                    "Esta cédula ya está registrada en el sistema. "
                    "Si ya trabajas en la institución, por favor contacta al departamento de RRHH."
                )
        
        return value

    def to_internal_value(self, data):
        # Si data es un QueryDict (multipart), convertir a dict estándar
        # para evitar problemas al asignar listas de objetos (education)
        if hasattr(data, 'dict') or hasattr(data, '_mutable'):
            data_dict = {}
            for key, value in data.items():
                data_dict[key] = value
            data = data_dict
        
        # Parsear education si viene como JSON string
        if 'education' in data and isinstance(data['education'], str):
            import json
            try:
                data['education'] = json.loads(data['education'])
            except json.JSONDecodeError:
                data['education'] = []
            
        return super().to_internal_value(data)
    
    def validate(self, data):
        """Validación cruzada de teléfono y otros campos"""
        from core.models import PersonPhone
        

        
        # Validar que se proporcione teléfono (en algún formato)
        phone_area_code = data.get('phone_area_code')
        phone_subscriber = data.get('phone_subscriber')
        old_phone = data.get('phone')
        
        # Considerar que los campos pueden venir como strings vacíos
        if phone_area_code and phone_subscriber:
            has_new_format = True
        else:
            has_new_format = False
            
        has_old_format = bool(old_phone and old_phone.strip())
        
        if not (has_new_format or has_old_format):
            raise serializers.ValidationError({
                'phone': 'Debes proporcionar un número de teléfono.'
            })
        
        # Si se usa el nuevo formato, validar contra PersonPhone
        if has_new_format:
            if PersonPhone.objects.filter(carrier_code=phone_area_code, subscriber_number=phone_subscriber).exists():
                raise serializers.ValidationError({
                    'phone_subscriber': (
                        "Este número de teléfono ya está registrado en el sistema. "
                        "Si ya trabajas en la institución, por favor contacta al departamento de RRHH."
                    )
                })
        
        # Validación de email duplicado en misma vacante
        job_posting = data.get('job_posting')
        if job_posting and data.get('email'):
            existing = Candidate.objects.filter(
                job_posting=job_posting,
                email=data['email']
            )
            if existing.exists():
                raise serializers.ValidationError({
                    'email': 'Ya te has postulado a esta vacante con este correo electrónico.'
                })
        
        if job_posting:
            # Validar que se incluya educación si la vacante lo requiere
            if job_posting.ask_education:
                education = data.get('education', [])
                if not education or len(education) == 0:
                    raise serializers.ValidationError({
                        'education': 'Esta vacante requiere información educativa.'
                    })
        
        return data
    
    def create(self, validated_data):
        import json
        
        # Parsear education si viene como JSON string (desde FormData)
        education_data = validated_data.pop('education', [])
        if isinstance(education_data, str):
            try:
                education_data = json.loads(education_data)
            except json.JSONDecodeError:
                education_data = []
        
        # Crear el candidato
        candidate = Candidate.objects.create(**validated_data)
        
        # Crear educación
        for edu in education_data:
            CandidateEducation.objects.create(candidate=candidate, **edu)
        
        return candidate


class CandidateListSerializer(serializers.ModelSerializer):
    """Serializer para listar candidatos (vista administrativa)"""
    job_posting_title = serializers.CharField(source='job_posting.title', read_only=True)
    stage_display = serializers.CharField(source='get_stage_display', read_only=True)
    phone_area_code = PhoneCarrierCodeSerializer(read_only=True)
    
    class Meta:
        model = Candidate
        fields = [
            'id', 'first_name', 'last_name', 'email', 'phone',
            'job_posting', 'job_posting_title',
            'stage', 'stage_display',
            'created_at', 'updated_at', 'avatar',
            'national_id', 'phone_area_code', 'phone_subscriber'
        ]


class CandidateDetailSerializer(serializers.ModelSerializer):
    """Serializer detallado para administración de candidatos"""
    job_posting_title = serializers.CharField(source='job_posting.title', read_only=True)
    stage_display = serializers.CharField(source='get_stage_display', read_only=True)
    education = CandidateEducationSerializer(many=True, read_only=True)
    phone_area_code = PhoneCarrierCodeSerializer(read_only=True)
    cv_url = serializers.SerializerMethodField()
    
    class Meta:
        model = Candidate
        fields = '__all__'
    
    def get_cv_url(self, obj):
        if obj.cv_file:
            request = self.context.get('request')
            if request:
                return request.build_absolute_uri(obj.cv_file.url)
        return None


class CandidateStageUpdateSerializer(serializers.Serializer):
    """Serializer para cambiar la etapa de un candidato"""
    stage = serializers.ChoiceField(choices=Candidate.STAGE_CHOICES)
    notes = serializers.CharField(required=False, allow_blank=True)


class HireCandidateSerializer(serializers.Serializer):
    """Serializer para el proceso de contratación"""
    hire_date = serializers.DateField()
    role = serializers.IntegerField(help_text="ID del Role")
    employment_type = serializers.IntegerField(help_text="ID del EmploymentType")
    employment_status = serializers.IntegerField(help_text="ID del EmploymentStatus")
    salary = serializers.DecimalField(max_digits=10, decimal_places=2, required=False)
    notes = serializers.CharField(required=False, allow_blank=True)


class CandidateLogSerializer(serializers.ModelSerializer):
    """Serializer para el historial de cambios"""
    user_name = serializers.SerializerMethodField()
    
    class Meta:
        model = CandidateLog
        fields = ['id', 'user', 'user_name', 'action', 'details', 'timestamp']
        
    def get_user_name(self, obj):
        if obj.user:
            return f"{obj.user.first_name} {obj.user.last_name}".strip() or obj.user.username
        return "Sistema"
</file>

<file path="backend/ats/signals.py">
from django.db.models.signals import post_save
from django.dispatch import receiver
from organization.models import Position
from .models import JobPosting

@receiver(post_save, sender=Position)
def close_job_posting_if_filled(sender, instance, **kwargs):
    """
    Cierra automáticamente las vacantes publicadas si la posición se llena.
    """
    if instance.vacancies <= 0:
        # Buscar vacantes PUBLICADAS asociadas a esta posición
        active_postings = JobPosting.objects.filter(
            position=instance,
            status='PUBLISHED'
        )
        
        if active_postings.exists():
            # Cerrarlas
            active_postings.update(status='CLOSED')
            print(f"INFO: Se cerraron {active_postings.count()} publicaciones para la posición '{instance}' por falta de cupos.")
</file>

<file path="backend/ats/tests.py">
from django.test import TestCase

# Create your tests here.
</file>

<file path="backend/ats/urls.py">
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .views import (
    PublicJobPostingViewSet,
    PublicCandidateApplicationViewSet,
    JobPostingViewSet,
    CandidateViewSet
)
from .views_options import EducationOptionsViewSet, PhoneCarrierCodeOptionsViewSet

# Router para endpoints administrativos (renombrado de admin_router a router)
router = DefaultRouter()
router.register(r'jobs', JobPostingViewSet, basename='admin-jobs')
router.register(r'candidates', CandidateViewSet, basename='admin-candidates')

# Router para endpoints públicos
public_router = DefaultRouter()
public_router.register(r'jobs', PublicJobPostingViewSet, basename='public-jobs')
public_router.register(r'apply', PublicCandidateApplicationViewSet, basename='public-apply')
public_router.register(r'education-options', EducationOptionsViewSet, basename='public-education-options')
public_router.register(r'phone-codes', PhoneCarrierCodeOptionsViewSet, basename='public-phone-codes')

urlpatterns = [
    # Rutas públicas (sin autenticación)
    path('public/', include(public_router.urls)),

    # Rutas administrativas (con autenticación)
    path('', include(router.urls)),
]
</file>

<file path="backend/ats/utils.py">
from django.core.mail import EmailMultiAlternatives
from django.conf import settings
from email.mime.image import MIMEImage
import os

def send_status_change_email(candidate, new_stage):
    """
    Envía un correo electrónico al candidato notificando el cambio de estado.
    """
    subject = f"Actualización de tu aplicación: {candidate.job_posting.title}"
    
    # Mapeo de etapas a mensajes amigables
    stage_messages = {
        'REV': 'Tu aplicación ha sido revisada y hemos avanzado a la etapa de Revisión.',
        'INT': 'Nos gustaría invitarte a una entrevista para conocerte mejor.',
        'OFF': '¡Felicidades! Queremos hacerte una oferta formal para unirte a nuestro equipo.',
        'HIRED': '¡Bienvenido al equipo! Has sido contratado exitosamente.',
        'REJ': 'Gracias por tu interés en IUTIRLA. En esta ocasión hemos decidido avanzar con otros candidatos, pero mantendremos tu perfil en cuenta para futuras oportunidades.',
        'POOL': 'Has sido seleccionado para nuestro Banco de Elegibles. Te contactaremos cuando se abra una vacante que se ajuste a tu perfil.',
    }
    
    stage_message = stage_messages.get(new_stage, f"Tu aplicación ha cambiado al estado: {new_stage}")
    
    html_message = f"""
    <!DOCTYPE html>
    <html>
    <head>
        <style>
            body {{ font-family: 'Arial', sans-serif; line-height: 1.6; color: #333; }}
            .container {{ max-width: 600px; margin: 0 auto; padding: 20px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #ffffff; }}
            .header {{ text-align: center; padding-bottom: 20px; border-bottom: 2px solid #f0f0f0; margin-bottom: 20px; }}
            .logo {{ max-width: 150px; height: auto; }}
            .content {{ padding: 0 10px; }}
            .footer {{ margin-top: 30px; padding-top: 20px; border-top: 1px solid #f0f0f0; text-align: center; font-size: 12px; color: #888; }}
            .button {{ display: inline-block; padding: 10px 20px; background-color: #0056b3; color: #ffffff; text-decoration: none; border-radius: 5px; margin-top: 20px; }}
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <img src="cid:logoiutirla" alt="IUTIRLA Logo" class="logo">
            </div>
            <div class="content">
                <h2>Hola, {candidate.first_name}</h2>
                <p>{stage_message}</p>
                <p>Agradecemos tu interés en formar parte de nuestra institución.</p>
                <p>Si tienes alguna duda, por favor no dudes en contactarnos.</p>
            </div>
            <div class="footer">
                <p>&copy; {settings.DEFAULT_FROM_EMAIL.split('@')[1] if '@' in settings.DEFAULT_FROM_EMAIL else 'IUTIRLA'}. Todos los derechos reservados.</p>
                <p>Este es un correo automático, por favor no respondas a esta dirección.</p>
            </div>
        </div>
    </body>
    </html>
    """
    
    plain_message = f"""
    Hola {candidate.first_name},
    
    {stage_message}
    
    Saludos,
    Equipo de RRHH - IUTIRLA
    """
    
    recipient_list = [candidate.email]
    
    try:
        msg = EmailMultiAlternatives(
            subject,
            plain_message,
            settings.DEFAULT_FROM_EMAIL,
            recipient_list
        )
        msg.attach_alternative(html_message, "text/html")
        
        # Adjuntar logo
        # Ruta asumiendo estructura: backend/ats/utils.py -> backend/ -> ../frontend/public/logoiutirla.png
        # Ajustamos la ruta base para llegar al frontend
        base_dir = settings.BASE_DIR # backend/
        logo_path = os.path.join(base_dir.parent, 'frontend', 'public', 'logoiutirla.png')
        
        if os.path.exists(logo_path):
            with open(logo_path, 'rb') as f:
                logo_data = f.read()
                logo = MIMEImage(logo_data)
                logo.add_header('Content-ID', '<logoiutirla>')
                logo.add_header('Content-Disposition', 'inline', filename='logoiutirla.png')
                msg.attach(logo)
        else:
            print(f"Logo not found at {logo_path}")
            
        msg.send(fail_silently=False)
        return True
    except Exception as e:
        print(f"Error sending email to {candidate.email}: {e}")
        return False
</file>

<file path="backend/ats/views_options.py">
from rest_framework import viewsets
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.permissions import AllowAny

class EducationOptionsViewSet(viewsets.ViewSet):
    """
    ViewSet público para opciones de educación utilizadas en el formulario dinámico.
    """
    permission_classes = [AllowAny]
    
    def list(self, request):
        from talent.models import EducationLevel, FieldOfStudy
        
        levels = EducationLevel.objects.all().values('id', 'name')
        fields = FieldOfStudy.objects.all().values('id', 'name')
        
        return Response({
            'levels': list(levels),
            'fields': list(fields)
        })


class PhoneCarrierCodeOptionsViewSet(viewsets.ViewSet):
    """
    Opciones para códigos de operadora
    """
    permission_classes = [AllowAny]
    
    def list(self, request):
        from core.models import PhoneCarrierCode
        
        # Obtener todos los códigos ordenados
        carrier_codes = PhoneCarrierCode.objects.select_related('carrier').all().order_by('code')
        
        # Formatear para el frontend
        codes_list = []
        for code in carrier_codes:
            carrier_name = code.carrier.name if code.carrier else code.type
            codes_list.append({
                'id': code.id,
                'code': code.code,
                'carrier': carrier_name,
                'display': f"{code.code} ({carrier_name})"
            })
        
        return Response(codes_list)
</file>

<file path="backend/ats/views.py">
from rest_framework import viewsets, status
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.permissions import AllowAny, IsAuthenticated
from django.utils import timezone
from django.db.models import Q
from .models import JobPosting, Candidate, CandidateLog
from .serializers import (
    JobPostingListSerializer,
    JobPostingDetailSerializer,
    JobPostingAdminSerializer,
    CandidateCreateSerializer,
    CandidateListSerializer,
    CandidateDetailSerializer,
    CandidateStageUpdateSerializer,
    HireCandidateSerializer,
    CandidateLogSerializer
)
from .services import hire_candidate, move_finalists_to_pool
from .utils import send_status_change_email


# --- ViewSets Públicos (Sin Autenticación) ---

class PublicJobPostingViewSet(viewsets.ReadOnlyModelViewSet):
    """
    ViewSet público para listar vacantes activas.
    Solo muestra vacantes publicadas y no cerradas.
    """
    permission_classes = [AllowAny]
    serializer_class = JobPostingListSerializer
    
    def get_queryset(self):
        """Filtrar solo vacantes publicadas y activas"""
        today = timezone.now().date()
        return JobPosting.objects.filter(
            status='PUBLISHED',
            published_date__lte=today
        ).filter(
            Q(closing_date__gte=today) | Q(closing_date__isnull=True)
        )
    
    def retrieve(self, request, *args, **kwargs):
        """Devolver detalle completo de una vacante"""
        instance = self.get_object()
        serializer = JobPostingDetailSerializer(instance)
        return Response(serializer.data)


class PublicCandidateApplicationViewSet(viewsets.GenericViewSet):
    """
    ViewSet público para postulaciones.
    Solo permite crear (POST) candidatos.
    """
    permission_classes = [AllowAny]
    serializer_class = CandidateCreateSerializer
    
    def create(self, request, *args, **kwargs):
        """Crear una postulación (candidato)"""
        serializer = self.get_serializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        
        # Validar que la vacante esté publicada
        job_posting = serializer.validated_data.get('job_posting')
        if job_posting.status != 'PUBLISHED':
            return Response(
                {'error': 'Esta vacante no está disponible para postulaciones.'},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        candidate = serializer.save()
        
        return Response(
            {
                'message': '¡Postulación enviada exitosamente!',
                'candidate_id': candidate.id
            },
            status=status.HTTP_201_CREATED
        )


# --- ViewSets Administrativos (Con Autenticación) ---

class JobPostingViewSet(viewsets.ModelViewSet):
    """
    ViewSet administrativo para gestionar vacantes.
    CRUD completo de vacantes.
    """
    permission_classes = [IsAuthenticated]
    queryset = JobPosting.objects.all()
    
    def get_serializer_class(self):
        if self.action == 'list':
            return JobPostingListSerializer
        elif self.action == 'retrieve':
            return JobPostingDetailSerializer
        return JobPostingAdminSerializer
    
    @action(detail=True, methods=['post'])
    def publish(self, request, pk=None):
        """Publicar una vacante"""
        job_posting = self.get_object()
        
        # Preparar datos con el nuevo estado
        data = {
            'status': 'PUBLISHED',
            'position': job_posting.position.id if job_posting.position else None,
            'title': job_posting.title,
            'description': job_posting.description,
        }
        
        if not job_posting.published_date:
            data['published_date'] = timezone.now().date()
        
        # Validar usando el serializador (esto ejecutará validate())
        serializer = JobPostingAdminSerializer(job_posting, data=data, partial=True)
        serializer.is_valid(raise_exception=True)
        serializer.save()
        
        return Response(serializer.data)
    
    @action(detail=True, methods=['post'])
    def close(self, request, pk=None):
        """Cerrar una vacante"""
        job_posting = self.get_object()
        job_posting.status = 'CLOSED'
        
        # Si no tiene fecha de cierre, registrar la fecha actual
        if not job_posting.closing_date:
            job_posting.closing_date = timezone.now().date()
        
        job_posting.save()
        
        serializer = self.get_serializer(job_posting)
        return Response(serializer.data)


class CandidateViewSet(viewsets.ModelViewSet):
    """
    ViewSet administrativo para gestionar candidatos.
    Incluye acciones especiales para contratar y cambiar etapa.
    """
    permission_classes = [IsAuthenticated]
    permission_classes = [IsAuthenticated]
    queryset = Candidate.objects.select_related('job_posting').prefetch_related('education')
    
    def log_action(self, candidate, action, details=None):
        """Registrar una acción en el historial"""
        user = self.request.user if self.request and hasattr(self.request, 'user') and self.request.user.is_authenticated else None
        CandidateLog.objects.create(
            candidate=candidate,
            user=user,
            action=action,
            details=details
        )

    def perform_update(self, serializer):
        super().perform_update(serializer)
        self.log_action(serializer.instance, 'UPDATE', "Actualización de datos del candidato")

    def get_serializer_class(self):
        if self.action == 'list':
            return CandidateListSerializer
        return CandidateDetailSerializer
    
    def get_queryset(self):
        """Filtrar por parámetros de query"""
        queryset = super().get_queryset()
        
        # Filtrar por vacante
        job_posting_id = self.request.query_params.get('job_posting')
        if job_posting_id:
            queryset = queryset.filter(job_posting_id=job_posting_id)
        
        # Filtrar por etapa
        stage = self.request.query_params.get('stage')
        if stage:
            queryset = queryset.filter(stage=stage)
        
        return queryset
    
    @action(detail=True, methods=['post'], url_path='change-stage')
    def change_stage(self, request, pk=None):
        """Cambiar la etapa de un candidato"""
        candidate = self.get_object()
        serializer = CandidateStageUpdateSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        
        new_stage = serializer.validated_data['stage']
        notes = serializer.validated_data.get('notes', '')
        
        # Actualizar
        candidate.stage = new_stage
        if notes:
            candidate.notes = (candidate.notes or '') + f"\n[{new_stage}] {notes}"
        candidate.save()
        


        
        # Verificar que el cambio se guardó correctamente
        candidate.refresh_from_db()
        if candidate.stage == new_stage:
            # Enviar notificación por correo
            send_status_change_email(candidate, new_stage)
        
        # Registrar en historial
        self.log_action(candidate, 'STAGE_CHANGE', f"Cambio a etapa {new_stage}. Notas: {notes}")
        
        return Response(
            CandidateDetailSerializer(candidate, context={'request': request}).data
        )
    
    @action(detail=True, methods=['post'])
    def hire(self, request, pk=None):
        """
        Contratar un candidato.
        Ejecuta la transacción completa de contratación.
        """
        candidate = self.get_object()
        
        # Validar que el candidato esté en una etapa válida para contratar
        if candidate.stage not in ['OFF', 'INT']:
            return Response(
                {'error': 'El candidato debe estar en etapa de Oferta o Entrevista para ser contratado.'},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        serializer = HireCandidateSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        
        try:
            result = hire_candidate(candidate, serializer.validated_data)
            
            # Enviar notificación por correo (HIR = Hired)
            # Verificar primero
            candidate.refresh_from_db()
            if candidate.stage == 'HIRED':
                send_status_change_email(candidate, 'HIRED')
            
            # Registrar en historial
            self.log_action(candidate, 'HIRED', "Candidato contratado exitosamente")
            
            response_data = {
                'message': 'Candidato contratado exitosamente',
                'person_id': result['person'].id,
                'employment_id': result['employment'].id,
                'remaining_vacancies': result['remaining_vacancies'],
                'other_finalists': []
            }
            
            # Si hay otros finalistas, incluir información
            if result['other_finalists']:
                response_data['other_finalists'] = [
                    {
                        'id': c.id,
                        'name': f"{c.first_name} {c.last_name}",
                        'stage': c.get_stage_display()
                    }
                    for c in result['other_finalists']
                ]
                response_data['message'] += f". Hay {len(result['other_finalists'])} finalista(s) adicional(es)."
            
            return Response(response_data, status=status.HTTP_200_OK)
            
        except Exception as e:
            return Response(
                {'error': str(e)},
                status=status.HTTP_400_BAD_REQUEST
            )
    
    @action(detail=False, methods=['post'])
    def move_to_pool(self, request):
        """Mover candidatos al banco de elegibles"""
        candidate_ids = request.data.get('candidate_ids', [])
        
        if not candidate_ids:
            return Response(
                {'error': 'Debe proporcionar una lista de candidate_ids'},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        updated_count = move_finalists_to_pool(candidate_ids)
        
        return Response({
            'message': f'{updated_count} candidato(s) movido(s) al Banco de Elegibles',
            'updated_count': updated_count
        })

    @action(detail=True, methods=['get'])
    def logs(self, request, pk=None):
        """Obtener historial de cambios del candidato"""
        candidate = self.get_object()
        logs = candidate.logs.all()
        serializer = CandidateLogSerializer(logs, many=True)
        return Response(serializer.data)
</file>

<file path="backend/config/asgi.py">
"""
ASGI config for config project.

It exposes the ASGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/5.2/howto/deployment/asgi/
"""

import os

from django.core.asgi import get_asgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')

application = get_asgi_application()
</file>

<file path="backend/config/wsgi.py">
"""
WSGI config for config project.

It exposes the WSGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/5.2/howto/deployment/wsgi/
"""

import os

from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')

application = get_wsgi_application()
</file>

<file path="backend/core/migrations/0002_alter_personbankaccount_account_number.py">
# Generated by Django 5.2.8 on 2025-11-26 12:26

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('core', '0001_initial'),
    ]

    operations = [
        migrations.AlterField(
            model_name='personbankaccount',
            name='account_number',
            field=models.CharField(error_messages={'unique': 'Este número de cuenta ya está registrado.'}, max_length=20, unique=True),
        ),
    ]
</file>

<file path="backend/core/migrations/0003_historicalperson.py">
# Generated by Django 5.2.8 on 2025-11-27 20:56

import django.db.models.deletion
import simple_history.models
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('core', '0002_alter_personbankaccount_account_number'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='HistoricalPerson',
            fields=[
                ('id', models.BigIntegerField(auto_created=True, blank=True, db_index=True, verbose_name='ID')),
                ('first_name', models.CharField(max_length=100)),
                ('second_name', models.CharField(blank=True, max_length=100, null=True)),
                ('paternal_surname', models.CharField(max_length=100)),
                ('maternal_surname', models.CharField(blank=True, max_length=100, null=True)),
                ('birthdate', models.DateField(blank=True, null=True)),
                ('photo', models.TextField(blank=True, max_length=100, null=True)),
                ('created_at', models.DateTimeField(blank=True, editable=False)),
                ('updated_at', models.DateTimeField(blank=True, editable=False)),
                ('history_id', models.AutoField(primary_key=True, serialize=False)),
                ('history_date', models.DateTimeField(db_index=True)),
                ('history_change_reason', models.CharField(max_length=100, null=True)),
                ('history_type', models.CharField(choices=[('+', 'Created'), ('~', 'Changed'), ('-', 'Deleted')], max_length=1)),
                ('country_of_birth', models.ForeignKey(blank=True, db_constraint=False, null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='core.country')),
                ('gender', models.ForeignKey(blank=True, db_constraint=False, null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='core.gender')),
                ('history_user', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('marital_status', models.ForeignKey(blank=True, db_constraint=False, null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='core.maritalstatus')),
                ('salutation', models.ForeignKey(blank=True, db_constraint=False, null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='core.salutation')),
            ],
            options={
                'verbose_name': 'historical person',
                'verbose_name_plural': 'historical persons',
                'ordering': ('-history_date', '-history_id'),
                'get_latest_by': ('history_date', 'history_id'),
            },
            bases=(simple_history.models.HistoricalChanges, models.Model),
        ),
    ]
</file>

<file path="backend/core/migrations/0004_remove_phone_prefix.py">
# Generated by Django 5.2.8 on 2025-11-27 21:31

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ('core', '0003_historicalperson'),
    ]

    operations = [
        migrations.RemoveField(
            model_name='country',
            name='phone_prefix',
        ),
    ]
</file>

<file path="backend/core/migrations/0005_phonecarriercode_alter_phoneareacode_unique_together_and_more.py">
# Generated by Django 5.2.8 on 2025-11-29 20:48

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('core', '0004_remove_phone_prefix'),
    ]

    operations = [
        migrations.CreateModel(
            name='PhoneCarrierCode',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('code', models.CharField(max_length=5)),
            ],
        ),
        migrations.AlterUniqueTogether(
            name='phoneareacode',
            unique_together=None,
        ),
        # IMPORTANT: Remove constraint BEFORE removing fields it references
        migrations.RemoveConstraint(
            model_name='personphone',
            name='phone_unique',
        ),
        migrations.RemoveField(
            model_name='phoneareacode',
            name='carrier',
        ),
        migrations.RemoveField(
            model_name='phoneareacode',
            name='country',
        ),
        migrations.RemoveField(
            model_name='personphone',
            name='area_code',
        ),
        migrations.RemoveField(
            model_name='emergencycontact',
            name='phone_area_code',
        ),
        migrations.AddField(
            model_name='phonecarriercode',
            name='carrier',
            field=models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='core.phonecarrier'),
        ),
        migrations.AddField(
            model_name='emergencycontact',
            name='phone_carrier_code',
            field=models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.phonecarriercode'),
        ),
        migrations.AddField(
            model_name='personphone',
            name='carrier_code',
            field=models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.phonecarriercode'),
        ),
        migrations.AddConstraint(
            model_name='personphone',
            constraint=models.UniqueConstraint(fields=('carrier_code', 'subscriber_number'), name='phone_unique', violation_error_message='Este número de teléfono ya se encuentra registrado.'),
        ),
    ]
</file>

<file path="backend/core/migrations/0006_delete_phoneareacode_and_more.py">
# Generated by Django 5.2.8 on 2025-11-29 20:48

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ('ats', '0008_alter_candidate_phone_area_code_and_more'),
        ('core', '0005_phonecarriercode_alter_phoneareacode_unique_together_and_more'),
    ]

    operations = [
        migrations.DeleteModel(
            name='PhoneAreaCode',
        ),
        migrations.AlterUniqueTogether(
            name='phonecarriercode',
            unique_together={('carrier', 'code')},
        ),
    ]
</file>

<file path="backend/core/migrations/0007_refine_validations.py">
# Generated by Django 5.2.8 on 2025-11-30 13:20

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('core', '0006_delete_phoneareacode_and_more'),
    ]

    operations = [
        migrations.AlterField(
            model_name='phonecarriercode',
            name='code',
            field=models.CharField(max_length=4),
        ),
    ]
</file>

<file path="backend/core/migrations/0008_remove_salutation.py">
# Generated migration to remove Salutation model and salutation field from Person

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ('core', '0007_refine_validations'),
    ]

    operations = [
        migrations.RemoveField(
            model_name='person',
            name='salutation',
        ),
        migrations.RemoveField(
            model_name='historicalperson',
            name='salutation',
        ),
        migrations.DeleteModel(
            name='Salutation',
        ),
    ]
</file>

<file path="backend/core/migrations/0009_make_gender_birthdate_required.py">
# Generated migration to make gender and birthdate required fields

from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):

    dependencies = [
        ('core', '0008_remove_salutation'),
    ]

    operations = [
        # First, set default values for existing NULL records
        # This is a data migration step that should be done before altering the field
        migrations.RunSQL(
            # For gender: set to first available gender if NULL
            sql="""
                UPDATE core_person 
                SET gender_id = (SELECT id FROM core_gender LIMIT 1)
                WHERE gender_id IS NULL;
            """,
            reverse_sql=migrations.RunSQL.noop,
        ),
        migrations.RunSQL(
            # For birthdate: set to a default date (e.g., 1900-01-01) if NULL
            sql="""
                UPDATE core_person 
                SET birthdate = '1900-01-01'
                WHERE birthdate IS NULL;
            """,
            reverse_sql=migrations.RunSQL.noop,
        ),
        # Now alter the fields to be non-nullable
        migrations.AlterField(
            model_name='person',
            name='gender',
            field=models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, to='core.gender'),
        ),
        migrations.AlterField(
            model_name='person',
            name='birthdate',
            field=models.DateField(),
        ),
    ]
</file>

<file path="backend/core/migrations/0010_alter_historicalperson_birthdate.py">
# Generated by Django 5.2.8 on 2025-12-01 20:57

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('core', '0009_make_gender_birthdate_required'),
    ]

    operations = [
        migrations.AlterField(
            model_name='historicalperson',
            name='birthdate',
            field=models.DateField(),
        ),
    ]
</file>

<file path="backend/core/db_utils.py">
import unicodedata

def remove_accents(input_str):
    if input_str is None:
        return None
    if not isinstance(input_str, str):
        return str(input_str)
    
    # Normalize unicode characters to NFD (Decomposition)
    nfkd_form = unicodedata.normalize('NFD', input_str)
    
    # Filter out non-spacing mark characters (combining diacritics)
    return "".join([c for c in nfkd_form if not unicodedata.combining(c)])
</file>

<file path="backend/core/pagination.py">
from rest_framework.pagination import PageNumberPagination

class CustomPagination(PageNumberPagination):
    # page_size = 5
    page_size_query_param = 'page_size'
    max_page_size = 100
</file>

<file path="backend/core/tests.py">
from django.test import TestCase

# Create your tests here.
</file>

<file path="backend/employment/migrations/0002_historicalemployment.py">
# Generated by Django 5.2.8 on 2025-11-27 20:56

import django.db.models.deletion
import simple_history.models
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('core', '0003_historicalperson'),
        ('employment', '0001_initial'),
        ('organization', '0002_historicaldepartment_historicalposition'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='HistoricalEmployment',
            fields=[
                ('id', models.BigIntegerField(auto_created=True, blank=True, db_index=True, verbose_name='ID')),
                ('exit_reason', models.CharField(blank=True, choices=[('REN', 'Renuncia Voluntaria'), ('DES', 'Despido / Cese'), ('FIN', 'Fin de Contrato (Tiempo Cumplido)'), ('JUB', 'Jubilación'), ('FAL', 'Fallecimiento'), ('OTR', 'Otro Motivo')], max_length=3, null=True, verbose_name='Motivo de Salida')),
                ('exit_notes', models.TextField(blank=True, help_text='Detalle o carta de renuncia.', null=True, verbose_name='Observaciones')),
                ('hire_date', models.DateField(verbose_name='Fecha de Contratación')),
                ('end_date', models.DateField(blank=True, help_text="Fecha de fin de contrato (para 'Tiempo Determinado' o 'Prueba')", null=True)),
                ('created_at', models.DateTimeField(blank=True, editable=False)),
                ('updated_at', models.DateTimeField(blank=True, editable=False)),
                ('history_id', models.AutoField(primary_key=True, serialize=False)),
                ('history_date', models.DateTimeField(db_index=True)),
                ('history_change_reason', models.CharField(max_length=100, null=True)),
                ('history_type', models.CharField(choices=[('+', 'Created'), ('~', 'Changed'), ('-', 'Deleted')], max_length=1)),
                ('current_status', models.ForeignKey(blank=True, db_constraint=False, null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='employment.employmentstatus', verbose_name='Estatus Actual')),
                ('employment_type', models.ForeignKey(blank=True, db_constraint=False, null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='employment.employmenttype', verbose_name='Tipo de Contrato')),
                ('history_user', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('person', models.ForeignKey(blank=True, db_constraint=False, null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='core.person', verbose_name='Colaborador')),
                ('position', models.ForeignKey(blank=True, db_constraint=False, null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='organization.position', verbose_name='Cargo / Posición')),
                ('role', models.ForeignKey(blank=True, db_constraint=False, null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='employment.role', verbose_name='Rol Funcional')),
            ],
            options={
                'verbose_name': 'historical Expediente Laboral',
                'verbose_name_plural': 'historical Expediente Laborals',
                'ordering': ('-history_date', '-history_id'),
                'get_latest_by': ('history_date', 'history_id'),
            },
            bases=(simple_history.models.HistoricalChanges, models.Model),
        ),
    ]
</file>

<file path="backend/employment/migrations/0003_add_choice_fields.py">
# Generated by Django 5.2.8 on 2025-11-30 21:36

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('employment', '0002_historicalemployment'),
    ]

    operations = [
        migrations.AddField(
            model_name='employment',
            name='current_status_new',
            field=models.CharField(choices=[('ACT', 'Activo'), ('SUS', 'Suspendido'), ('PER', 'De Permiso'), ('REP', 'Reposo'), ('FIN', 'Finalizado'), ('REN', 'Renuncia'), ('DES', 'Despido'), ('ANU', 'Anulado')], max_length=3, null=True, verbose_name='Estatus Actual'),
        ),
        migrations.AddField(
            model_name='employment',
            name='employment_type_new',
            field=models.CharField(choices=[('FIJ', 'Fijo'), ('TMP', 'Temporal'), ('PAS', 'Pasantía')], max_length=3, null=True, verbose_name='Tipo de Contrato'),
        ),
        migrations.AddField(
            model_name='employment',
            name='role_new',
            field=models.CharField(choices=[('EMP', 'Empleado'), ('MGR', 'Manager')], max_length=3, null=True, verbose_name='Rol Funcional'),
        ),
        migrations.AddField(
            model_name='historicalemployment',
            name='current_status_new',
            field=models.CharField(choices=[('ACT', 'Activo'), ('SUS', 'Suspendido'), ('PER', 'De Permiso'), ('REP', 'Reposo'), ('FIN', 'Finalizado'), ('REN', 'Renuncia'), ('DES', 'Despido'), ('ANU', 'Anulado')], max_length=3, null=True, verbose_name='Estatus Actual'),
        ),
        migrations.AddField(
            model_name='historicalemployment',
            name='employment_type_new',
            field=models.CharField(choices=[('FIJ', 'Fijo'), ('TMP', 'Temporal'), ('PAS', 'Pasantía')], max_length=3, null=True, verbose_name='Tipo de Contrato'),
        ),
        migrations.AddField(
            model_name='historicalemployment',
            name='role_new',
            field=models.CharField(choices=[('EMP', 'Empleado'), ('MGR', 'Manager')], max_length=3, null=True, verbose_name='Rol Funcional'),
        ),
        migrations.AlterField(
            model_name='employment',
            name='current_status',
            field=models.ForeignKey(null=True, on_delete=django.db.models.deletion.PROTECT, related_name='active_employments', to='employment.employmentstatus', verbose_name='Estatus Actual (Old)'),
        ),
        migrations.AlterField(
            model_name='employment',
            name='employment_type',
            field=models.ForeignKey(null=True, on_delete=django.db.models.deletion.PROTECT, related_name='employments', to='employment.employmenttype', verbose_name='Tipo de Contrato (Old)'),
        ),
        migrations.AlterField(
            model_name='employment',
            name='role',
            field=models.ForeignKey(null=True, on_delete=django.db.models.deletion.PROTECT, related_name='employments', to='employment.role', verbose_name='Rol Funcional (Old)'),
        ),
        migrations.AlterField(
            model_name='historicalemployment',
            name='current_status',
            field=models.ForeignKey(blank=True, db_constraint=False, null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='employment.employmentstatus', verbose_name='Estatus Actual (Old)'),
        ),
        migrations.AlterField(
            model_name='historicalemployment',
            name='employment_type',
            field=models.ForeignKey(blank=True, db_constraint=False, null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='employment.employmenttype', verbose_name='Tipo de Contrato (Old)'),
        ),
        migrations.AlterField(
            model_name='historicalemployment',
            name='role',
            field=models.ForeignKey(blank=True, db_constraint=False, null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='employment.role', verbose_name='Rol Funcional (Old)'),
        ),
    ]
</file>

<file path="backend/employment/migrations/0004_migrate_data_to_choices.py">
# Generated by Django 5.2.8 on 2025-11-30 21:36

from django.db import migrations


def migrate_to_choices(apps, schema_editor):
    """
    Copia los datos de los ForeignKey a los nuevos campos CharField con choices.
    Mapea los nombres de los catálogos a los códigos de choices.
    """
    Employment = apps.get_model('employment', 'Employment')
    
    # Mapeos de nombre a código de choice
    role_map = {
        'Empleado': 'EMP',
        'Manager': 'MGR',
    }
    
    type_map = {
        'Fijo': 'FIJ',
        'Temporal': 'TMP',
        'Pasantía': 'PAS',
    }
    
    status_map = {
        'Activo': 'ACT',
        'Suspendido': 'SUS',
        'De Permiso': 'PER',
        'Reposo': 'REP',
        'Finalizado': 'FIN',
        'Renuncia': 'REN',
        'Despido': 'DES',
        'Anulado': 'ANU',
    }
    
    for employment in Employment.objects.all():
        # Migrar role
        if employment.role:
            employment.role_new = role_map.get(employment.role.name, 'EMP')
        
        # Migrar employment_type
        if employment.employment_type:
            employment.employment_type_new = type_map.get(employment.employment_type.name, 'FIJ')
        
        # Migrar current_status
        if employment.current_status:
            employment.current_status_new = status_map.get(employment.current_status.name, 'ACT')
        
        employment.save()


def reverse_migrate(apps, schema_editor):
    """
    Rollback: Copiar de vuelta los valores de choice a los FK.
    Esto solo funciona si los catálogos aún existen.
    """
    Employment = apps.get_model('employment', 'Employment')
    Role = apps.get_model('employment', 'Role')
    EmploymentType = apps.get_model('employment', 'EmploymentType')
    EmploymentStatus = apps.get_model('employment', 'EmploymentStatus')
    
    # Mapeos inversos de código a nombre
    role_reverse = {
        'EMP': 'Empleado',
        'MGR': 'Manager',
    }
    
    type_reverse = {
        'FIJ': 'Fijo',
        'TMP': 'Temporal',
        'PAS': 'Pasantía',
    }
    
    status_reverse = {
        'ACT': 'Activo',
        'SUS': 'Suspendido',
        'PER': 'De Permiso',
        'REP': 'Reposo',
        'FIN': 'Finalizado',
        'REN': 'Renuncia',
        'DES': 'Despido',
        'ANU': 'Anulado',
    }
    
    for employment in Employment.objects.all():
        # Restaurar role
        if employment.role_new:
            role_name = role_reverse.get(employment.role_new)
            if role_name:
                employment.role = Role.objects.filter(name=role_name).first()
        
        # Restaurar employment_type
        if employment.employment_type_new:
            type_name = type_reverse.get(employment.employment_type_new)
            if type_name:
                employment.employment_type = EmploymentType.objects.filter(name=type_name).first()
        
        # Restaurar current_status
        if employment.current_status_new:
            status_name = status_reverse.get(employment.current_status_new)
            if status_name:
                employment.current_status = EmploymentStatus.objects.filter(name=status_name).first()
        
        employment.save()


class Migration(migrations.Migration):

    dependencies = [
        ('employment', '0003_add_choice_fields'),
    ]

    operations = [
        migrations.RunPython(migrate_to_choices, reverse_migrate),
    ]
</file>

<file path="backend/employment/migrations/0005_alter_employmentstatuslog_status_and_more.py">
# Generated by Django 5.2.8 on 2025-11-30 23:16

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('employment', '0004_migrate_data_to_choices'),
    ]

    operations = [
        migrations.AlterField(
            model_name='employmentstatuslog',
            name='status',
            field=models.CharField(choices=[('ACT', 'Activo'), ('SUS', 'Suspendido'), ('PER', 'De Permiso'), ('REP', 'Reposo'), ('FIN', 'Finalizado'), ('REN', 'Renuncia'), ('DES', 'Despido'), ('ANU', 'Anulado')], max_length=3, verbose_name='Estatus'),
        ),
        migrations.AlterField(
            model_name='historicalemployment',
            name='current_status',
            field=models.CharField(choices=[('ACT', 'Activo'), ('SUS', 'Suspendido'), ('PER', 'De Permiso'), ('REP', 'Reposo'), ('FIN', 'Finalizado'), ('REN', 'Renuncia'), ('DES', 'Despido'), ('ANU', 'Anulado')], default='ACT', max_length=3, verbose_name='Estatus Actual'),
        ),
        migrations.AlterField(
            model_name='employment',
            name='current_status',
            field=models.CharField(choices=[('ACT', 'Activo'), ('SUS', 'Suspendido'), ('PER', 'De Permiso'), ('REP', 'Reposo'), ('FIN', 'Finalizado'), ('REN', 'Renuncia'), ('DES', 'Despido'), ('ANU', 'Anulado')], default='ACT', max_length=3, verbose_name='Estatus Actual'),
        ),
        migrations.AlterField(
            model_name='historicalemployment',
            name='employment_type',
            field=models.CharField(choices=[('FIJ', 'Fijo'), ('TMP', 'Temporal'), ('PAS', 'Pasantía')], default='FIJ', max_length=3, verbose_name='Tipo de Contrato'),
        ),
        migrations.AlterField(
            model_name='employment',
            name='employment_type',
            field=models.CharField(choices=[('FIJ', 'Fijo'), ('TMP', 'Temporal'), ('PAS', 'Pasantía')], default='FIJ', max_length=3, verbose_name='Tipo de Contrato'),
        ),
        migrations.AlterField(
            model_name='historicalemployment',
            name='role',
            field=models.CharField(choices=[('EMP', 'Empleado'), ('MGR', 'Manager')], default='EMP', max_length=3, verbose_name='Rol Funcional'),
        ),
        migrations.AlterField(
            model_name='employment',
            name='role',
            field=models.CharField(choices=[('EMP', 'Empleado'), ('MGR', 'Manager')], default='EMP', max_length=3, verbose_name='Rol Funcional'),
        ),
        migrations.RemoveField(
            model_name='employment',
            name='current_status_new',
        ),
        migrations.RemoveField(
            model_name='employment',
            name='employment_type_new',
        ),
        migrations.RemoveField(
            model_name='employment',
            name='role_new',
        ),
        migrations.RemoveField(
            model_name='historicalemployment',
            name='current_status_new',
        ),
        migrations.RemoveField(
            model_name='historicalemployment',
            name='employment_type_new',
        ),
        migrations.RemoveField(
            model_name='historicalemployment',
            name='role_new',
        ),
        migrations.DeleteModel(
            name='EmploymentStatus',
        ),
        migrations.DeleteModel(
            name='EmploymentType',
        ),
        migrations.DeleteModel(
            name='Role',
        ),
    ]
</file>

<file path="backend/employment/migrations/0006_historicalemploymentdepartmentrole_and_more.py">
# Generated by Django 5.2.8 on 2025-12-01 00:22

import django.db.models.deletion
import django.utils.timezone
import simple_history.models
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('employment', '0005_alter_employmentstatuslog_status_and_more'),
        ('organization', '0008_historicalposition_objective_position_objective_and_more'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='HistoricalEmploymentDepartmentRole',
            fields=[
                ('id', models.BigIntegerField(auto_created=True, blank=True, db_index=True, verbose_name='ID')),
                ('hierarchical_role', models.CharField(choices=[('MGR', 'Gerente'), ('EMP', 'Empleado')], default='EMP', help_text='Rol dentro del departamento (Gerente o Empleado)', max_length=3, verbose_name='Rol Jerárquico')),
                ('start_date', models.DateField(default=django.utils.timezone.now, help_text='Inicio del rol jerárquico en este departamento', verbose_name='Fecha de Inicio')),
                ('end_date', models.DateField(blank=True, help_text='Fin del rol jerárquico (NULL si es actual)', null=True, verbose_name='Fecha de Fin')),
                ('notes', models.TextField(blank=True, help_text='Observaciones sobre la asignación del rol', null=True, verbose_name='Notas')),
                ('created_at', models.DateTimeField(blank=True, editable=False)),
                ('updated_at', models.DateTimeField(blank=True, editable=False)),
                ('history_id', models.AutoField(primary_key=True, serialize=False)),
                ('history_date', models.DateTimeField(db_index=True)),
                ('history_change_reason', models.CharField(max_length=100, null=True)),
                ('history_type', models.CharField(choices=[('+', 'Created'), ('~', 'Changed'), ('-', 'Deleted')], max_length=1)),
                ('department', models.ForeignKey(blank=True, db_constraint=False, help_text='Departamento en el que ejerce este rol', null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='organization.department', verbose_name='Departamento')),
                ('employment', models.ForeignKey(blank=True, db_constraint=False, help_text='Contrato al que pertenece este rol jerárquico', null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='employment.employment', verbose_name='Contrato')),
                ('history_user', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'historical Rol Jerárquico en Departamento',
                'verbose_name_plural': 'historical Roles Jerárquicos en Departamentos',
                'ordering': ('-history_date', '-history_id'),
                'get_latest_by': ('history_date', 'history_id'),
            },
            bases=(simple_history.models.HistoricalChanges, models.Model),
        ),
        migrations.CreateModel(
            name='EmploymentDepartmentRole',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('hierarchical_role', models.CharField(choices=[('MGR', 'Gerente'), ('EMP', 'Empleado')], default='EMP', help_text='Rol dentro del departamento (Gerente o Empleado)', max_length=3, verbose_name='Rol Jerárquico')),
                ('start_date', models.DateField(default=django.utils.timezone.now, help_text='Inicio del rol jerárquico en este departamento', verbose_name='Fecha de Inicio')),
                ('end_date', models.DateField(blank=True, help_text='Fin del rol jerárquico (NULL si es actual)', null=True, verbose_name='Fecha de Fin')),
                ('notes', models.TextField(blank=True, help_text='Observaciones sobre la asignación del rol', null=True, verbose_name='Notas')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('department', models.ForeignKey(help_text='Departamento en el que ejerce este rol', on_delete=django.db.models.deletion.CASCADE, related_name='employment_roles', to='organization.department', verbose_name='Departamento')),
                ('employment', models.ForeignKey(help_text='Contrato al que pertenece este rol jerárquico', on_delete=django.db.models.deletion.CASCADE, related_name='department_roles', to='employment.employment', verbose_name='Contrato')),
            ],
            options={
                'verbose_name': 'Rol Jerárquico en Departamento',
                'verbose_name_plural': 'Roles Jerárquicos en Departamentos',
                'ordering': ['-start_date'],
                'unique_together': {('employment', 'department', 'start_date')},
            },
        ),
    ]
</file>

<file path="backend/employment/migrations/0007_historicalpersondepartmentrole_persondepartmentrole.py">
# Generated by Django 5.2.8 on 2025-12-01 00:47

import django.db.models.deletion
import django.utils.timezone
import simple_history.models
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('core', '0007_refine_validations'),
        ('employment', '0006_historicalemploymentdepartmentrole_and_more'),
        ('organization', '0008_historicalposition_objective_position_objective_and_more'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='HistoricalPersonDepartmentRole',
            fields=[
                ('id', models.BigIntegerField(auto_created=True, blank=True, db_index=True, verbose_name='ID')),
                ('hierarchical_role', models.CharField(choices=[('MGR', 'Gerente'), ('EMP', 'Empleado')], default='EMP', help_text='Rol dentro del departamento (Gerente o Empleado)', max_length=3, verbose_name='Rol Jerárquico')),
                ('start_date', models.DateField(default=django.utils.timezone.now, help_text='Inicio del rol jerárquico en este departamento', verbose_name='Fecha de Inicio')),
                ('end_date', models.DateField(blank=True, help_text='Fin del rol jerárquico (NULL si es actual)', null=True, verbose_name='Fecha de Fin')),
                ('notes', models.TextField(blank=True, help_text='Observaciones sobre la asignación del rol', null=True, verbose_name='Notas')),
                ('created_at', models.DateTimeField(blank=True, editable=False)),
                ('updated_at', models.DateTimeField(blank=True, editable=False)),
                ('history_id', models.AutoField(primary_key=True, serialize=False)),
                ('history_date', models.DateTimeField(db_index=True)),
                ('history_change_reason', models.CharField(max_length=100, null=True)),
                ('history_type', models.CharField(choices=[('+', 'Created'), ('~', 'Changed'), ('-', 'Deleted')], max_length=1)),
                ('department', models.ForeignKey(blank=True, db_constraint=False, help_text='Departamento en el que ejerce este rol', null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='organization.department', verbose_name='Departamento')),
                ('history_user', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('person', models.ForeignKey(blank=True, db_constraint=False, help_text='Persona que ejerce este rol jerárquico', null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='core.person', verbose_name='Persona')),
            ],
            options={
                'verbose_name': 'historical Rol Jerárquico por Persona',
                'verbose_name_plural': 'historical Roles Jerárquicos por Persona',
                'ordering': ('-history_date', '-history_id'),
                'get_latest_by': ('history_date', 'history_id'),
            },
            bases=(simple_history.models.HistoricalChanges, models.Model),
        ),
        migrations.CreateModel(
            name='PersonDepartmentRole',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('hierarchical_role', models.CharField(choices=[('MGR', 'Gerente'), ('EMP', 'Empleado')], default='EMP', help_text='Rol dentro del departamento (Gerente o Empleado)', max_length=3, verbose_name='Rol Jerárquico')),
                ('start_date', models.DateField(default=django.utils.timezone.now, help_text='Inicio del rol jerárquico en este departamento', verbose_name='Fecha de Inicio')),
                ('end_date', models.DateField(blank=True, help_text='Fin del rol jerárquico (NULL si es actual)', null=True, verbose_name='Fecha de Fin')),
                ('notes', models.TextField(blank=True, help_text='Observaciones sobre la asignación del rol', null=True, verbose_name='Notas')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('department', models.ForeignKey(help_text='Departamento en el que ejerce este rol', on_delete=django.db.models.deletion.CASCADE, related_name='person_roles', to='organization.department', verbose_name='Departamento')),
                ('person', models.ForeignKey(help_text='Persona que ejerce este rol jerárquico', on_delete=django.db.models.deletion.CASCADE, related_name='department_roles', to='core.person', verbose_name='Persona')),
            ],
            options={
                'verbose_name': 'Rol Jerárquico por Persona',
                'verbose_name_plural': 'Roles Jerárquicos por Persona',
                'ordering': ['-start_date'],
                'unique_together': {('person', 'department', 'start_date')},
            },
        ),
    ]
</file>

<file path="backend/employment/apps.py">
from django.apps import AppConfig


class EmploymentConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'employment'
</file>

<file path="backend/employment/tests.py">
from django.test import TestCase

# Create your tests here.
</file>

<file path="backend/organization/migrations/0002_historicaldepartment_historicalposition.py">
# Generated by Django 5.2.8 on 2025-11-27 20:56

import django.db.models.deletion
import simple_history.models
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('organization', '0001_initial'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='HistoricalDepartment',
            fields=[
                ('id', models.BigIntegerField(auto_created=True, blank=True, db_index=True, verbose_name='ID')),
                ('name', models.CharField(db_index=True, error_messages={'unique': 'Ya existe un registro con este nombre.'}, max_length=100)),
                ('created_at', models.DateTimeField(blank=True, editable=False)),
                ('updated_at', models.DateTimeField(blank=True, editable=False)),
                ('history_id', models.AutoField(primary_key=True, serialize=False)),
                ('history_date', models.DateTimeField(db_index=True)),
                ('history_change_reason', models.CharField(max_length=100, null=True)),
                ('history_type', models.CharField(choices=[('+', 'Created'), ('~', 'Changed'), ('-', 'Deleted')], max_length=1)),
                ('history_user', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('parent', models.ForeignKey(blank=True, db_constraint=False, help_text='Departamento superior al que reporta este departamento.', null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='organization.department')),
            ],
            options={
                'verbose_name': 'historical department',
                'verbose_name_plural': 'historical departments',
                'ordering': ('-history_date', '-history_id'),
                'get_latest_by': ('history_date', 'history_id'),
            },
            bases=(simple_history.models.HistoricalChanges, models.Model),
        ),
        migrations.CreateModel(
            name='HistoricalPosition',
            fields=[
                ('id', models.BigIntegerField(auto_created=True, blank=True, db_index=True, verbose_name='ID')),
                ('vacancies', models.PositiveIntegerField(default=1, help_text='Número de vacantes disponibles')),
                ('name', models.CharField(blank=True, help_text="Nombre descriptivo opcional, ej: 'Gerente de Finanzas (VE)'", max_length=100, null=True)),
                ('created_at', models.DateTimeField(blank=True, editable=False)),
                ('updated_at', models.DateTimeField(blank=True, editable=False)),
                ('history_id', models.AutoField(primary_key=True, serialize=False)),
                ('history_date', models.DateTimeField(db_index=True)),
                ('history_change_reason', models.CharField(max_length=100, null=True)),
                ('history_type', models.CharField(choices=[('+', 'Created'), ('~', 'Changed'), ('-', 'Deleted')], max_length=1)),
                ('department', models.ForeignKey(blank=True, db_constraint=False, null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='organization.department')),
                ('history_user', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
                ('job_title', models.ForeignKey(blank=True, db_constraint=False, null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='organization.jobtitle')),
                ('manager_position', models.ForeignKey(blank=True, db_constraint=False, help_text='Posición a la que reporta directamente (Jefe Inmediato).', null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='organization.position')),
            ],
            options={
                'verbose_name': 'historical position',
                'verbose_name_plural': 'historical positions',
                'ordering': ('-history_date', '-history_id'),
                'get_latest_by': ('history_date', 'history_id'),
            },
            bases=(simple_history.models.HistoricalChanges, models.Model),
        ),
    ]
</file>

<file path="backend/organization/migrations/0003_remove_jobtitle_description.py">
# Generated by Django 5.2.8 on 2025-11-27 22:23

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ('organization', '0002_historicaldepartment_historicalposition'),
    ]

    operations = [
        migrations.RemoveField(
            model_name='jobtitle',
            name='description',
        ),
    ]
</file>

<file path="backend/organization/migrations/0004_remove_historicalposition_name_remove_position_name.py">
# Generated by Django 5.2.8 on 2025-11-27 22:56

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ('organization', '0003_remove_jobtitle_description'),
    ]

    operations = [
        migrations.RemoveField(
            model_name='historicalposition',
            name='name',
        ),
        migrations.RemoveField(
            model_name='position',
            name='name',
        ),
    ]
</file>

<file path="backend/organization/migrations/0005_alter_position_unique_together.py">
# Generated by Django 5.2.8 on 2025-11-27 23:03

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ('organization', '0004_remove_historicalposition_name_remove_position_name'),
    ]

    operations = [
        migrations.AlterUniqueTogether(
            name='position',
            unique_together={('department', 'job_title')},
        ),
    ]
</file>

<file path="backend/organization/migrations/0006_remove_historicalposition_manager_position_and_more.py">
# Generated by Django 5.2.8 on 2025-11-28 00:51

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('organization', '0005_alter_position_unique_together'),
    ]

    operations = [
        migrations.RemoveField(
            model_name='historicalposition',
            name='manager_position',
        ),
        migrations.RemoveField(
            model_name='position',
            name='manager_position',
        ),
        migrations.AddField(
            model_name='position',
            name='manager_positions',
            field=models.ManyToManyField(blank=True, help_text='Posiciones a las que reporta directamente (Jefes Inmediatos).', related_name='direct_reports', to='organization.position'),
        ),
    ]
</file>

<file path="backend/organization/migrations/0007_alter_department_name_alter_department_parent_and_more.py">
# Generated by Django 5.2.8 on 2025-11-28 01:19

import django.db.models.deletion
import simple_history.models
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('organization', '0006_remove_historicalposition_manager_position_and_more'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.AlterField(
            model_name='department',
            name='name',
            field=models.CharField(max_length=100, unique=True),
        ),
        migrations.AlterField(
            model_name='department',
            name='parent',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='subdepartments', to='organization.department'),
        ),
        migrations.AlterField(
            model_name='historicaldepartment',
            name='name',
            field=models.CharField(db_index=True, max_length=100),
        ),
        migrations.AlterField(
            model_name='historicaldepartment',
            name='parent',
            field=models.ForeignKey(blank=True, db_constraint=False, null=True, on_delete=django.db.models.deletion.DO_NOTHING, related_name='+', to='organization.department'),
        ),
        migrations.AlterField(
            model_name='jobtitle',
            name='name',
            field=models.CharField(max_length=100, unique=True),
        ),
        migrations.CreateModel(
            name='HistoricalJobTitle',
            fields=[
                ('id', models.BigIntegerField(auto_created=True, blank=True, db_index=True, verbose_name='ID')),
                ('name', models.CharField(db_index=True, max_length=100)),
                ('created_at', models.DateTimeField(blank=True, editable=False)),
                ('updated_at', models.DateTimeField(blank=True, editable=False)),
                ('history_id', models.AutoField(primary_key=True, serialize=False)),
                ('history_date', models.DateTimeField(db_index=True)),
                ('history_change_reason', models.CharField(max_length=100, null=True)),
                ('history_type', models.CharField(choices=[('+', 'Created'), ('~', 'Changed'), ('-', 'Deleted')], max_length=1)),
                ('history_user', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='+', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'historical job title',
                'verbose_name_plural': 'historical job titles',
                'ordering': ('-history_date', '-history_id'),
                'get_latest_by': ('history_date', 'history_id'),
            },
            bases=(simple_history.models.HistoricalChanges, models.Model),
        ),
        migrations.CreateModel(
            name='PositionFunction',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('description', models.TextField(help_text='Descripción de la función o responsabilidad')),
                ('order', models.PositiveIntegerField(default=0, help_text='Orden de visualización (menor primero)')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('position', models.ForeignKey(help_text='Posición a la que pertenece esta función', on_delete=django.db.models.deletion.CASCADE, related_name='functions', to='organization.position')),
            ],
            options={
                'verbose_name': 'Función de Cargo',
                'verbose_name_plural': 'Funciones de Cargos',
                'ordering': ['order', 'id'],
            },
        ),
    ]
</file>

<file path="backend/organization/migrations/0008_historicalposition_objective_position_objective_and_more.py">
# Generated by Django 5.2.8 on 2025-11-30 23:30

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('organization', '0007_alter_department_name_alter_department_parent_and_more'),
    ]

    operations = [
        migrations.AddField(
            model_name='historicalposition',
            name='objective',
            field=models.TextField(blank=True, help_text='Objetivo general del cargo', null=True, verbose_name='Objetivo'),
        ),
        migrations.AddField(
            model_name='position',
            name='objective',
            field=models.TextField(blank=True, help_text='Objetivo general del cargo', null=True, verbose_name='Objetivo'),
        ),
        migrations.DeleteModel(
            name='PositionObjective',
        ),
    ]
</file>

<file path="backend/organization/migrations/0009_historicalposition_is_manager_position_is_manager.py">
# Generated by Django 5.2.8 on 2025-12-01 18:04

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('organization', '0008_historicalposition_objective_position_objective_and_more'),
    ]

    operations = [
        migrations.AddField(
            model_name='historicalposition',
            name='is_manager',
            field=models.BooleanField(default=False, help_text='Indica si esta posición tiene responsabilidades gerenciales.', verbose_name='Es Gerencial'),
        ),
        migrations.AddField(
            model_name='position',
            name='is_manager',
            field=models.BooleanField(default=False, help_text='Indica si esta posición tiene responsabilidades gerenciales.', verbose_name='Es Gerencial'),
        ),
    ]
</file>

<file path="backend/organization/apps.py">
from django.apps import AppConfig


class OrganizationConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'organization'
</file>

<file path="backend/organization/tests.py">
from django.test import TestCase

# Create your tests here.
</file>

<file path="backend/performance/migrations/0001_initial.py">
# Generated by Django 5.2.8 on 2025-11-25 06:08

import django.core.validators
import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('core', '0001_initial'),
        ('employment', '0001_initial'),
        ('organization', '0001_initial'),
    ]

    operations = [
        migrations.CreateModel(
            name='EvaluationPeriod',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=100, unique=True)),
                ('start_date', models.DateField(verbose_name='Inicio')),
                ('end_date', models.DateField(verbose_name='Cierre')),
                ('is_active', models.BooleanField(default=True, verbose_name='Activo')),
            ],
            options={
                'verbose_name': 'Periodo de Evaluación',
                'ordering': ['-start_date'],
            },
        ),
        migrations.CreateModel(
            name='Competency',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=100)),
                ('description', models.TextField(blank=True, null=True)),
                ('is_global', models.BooleanField(default=True, help_text='Si se marca, aplica a todos los empleados.', verbose_name='¿Es Global?')),
                ('job_titles', models.ManyToManyField(blank=True, related_name='specific_competencies', to='organization.jobtitle', verbose_name='Aplica a Cargos Específicos')),
            ],
            options={
                'verbose_name': 'Competencia / Criterio',
                'verbose_name_plural': 'Competencias',
            },
        ),
        migrations.CreateModel(
            name='PerformanceReview',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('final_score', models.DecimalField(blank=True, decimal_places=2, max_digits=4, null=True, verbose_name='Promedio Final')),
                ('status', models.CharField(choices=[('BOR', 'Borrador'), ('ENV', 'Enviada / Finalizada'), ('ACE', 'Aceptada por Empleado')], default='BOR', max_length=3)),
                ('feedback_manager', models.TextField(blank=True, verbose_name='Comentarios del Jefe')),
                ('feedback_employee', models.TextField(blank=True, verbose_name='Comentarios del Empleado')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('employment', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='reviews', to='employment.employment')),
                ('evaluator', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='reviews_given', to='core.person')),
                ('period', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, to='performance.evaluationperiod')),
            ],
            options={
                'verbose_name': 'Evaluación de Desempeño',
                'unique_together': {('period', 'employment')},
            },
        ),
        migrations.CreateModel(
            name='ReviewDetail',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('score', models.PositiveIntegerField(default=0, validators=[django.core.validators.MinValueValidator(0), django.core.validators.MaxValueValidator(5)], verbose_name='Puntaje (1-5)')),
                ('comment', models.TextField(blank=True, null=True, verbose_name='Observación')),
                ('competency', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, to='performance.competency')),
                ('review', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='details', to='performance.performancereview')),
            ],
            options={
                'unique_together': {('review', 'competency')},
            },
        ),
    ]
</file>

<file path="backend/performance/migrations/0002_alter_performancereview_options.py">
# Generated by Django 5.2.8 on 2025-11-25 06:12

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ('performance', '0001_initial'),
    ]

    operations = [
        migrations.AlterModelOptions(
            name='performancereview',
            options={'verbose_name': 'Evaluación de Desempeño', 'verbose_name_plural': 'Evaluaciones de Desempeño'},
        ),
    ]
</file>

<file path="backend/performance/admin.py">
from django.contrib import admin
from django.db.models import Count, DecimalField
from django.utils.html import format_html
from . import models

# --- 1. INLINE (Para ver las preguntas dentro de la boleta) ---

class ReviewDetailInline(admin.TabularInline):
    """Muestra las competencias evaluadas dentro del formulario de PerformanceReview."""
    model = models.ReviewDetail
    extra = 0
    raw_id_fields = ('competency',)
    fields = ('competency', 'score', 'comment')
    readonly_fields = ('competency',)
    min_num = 1 # Debe haber al menos una competencia si se crea manualmente


# --- 2. REGISTRO PRINCIPAL DE EVALUACIONES ---

@admin.register(models.PerformanceReview)
class PerformanceReviewAdmin(admin.ModelAdmin):
    list_display = (
        '__str__',
        'employee_name', # Método para mostrar el nombre
        'evaluator_name',
        'status',
        'final_score',
        'period',
        'created_at',
    )
    list_filter = ('status', 'period', 'evaluator')
    search_fields = ('employment__person__first_name', 'employment__person__paternal_surname', 'period__name')
    
    # Detalle de la boleta anidado
    inlines = [ReviewDetailInline]
    
    # Campos que son propiedades calculadas o navegadas
    readonly_fields = ('final_score', 'employee_name', 'evaluator_name')

    # Navegación a través de las relaciones (evita N+1 queries)
    list_select_related = ('employment__person', 'evaluator', 'period') 
    
    # Métodos para list_display (extraídos del Serializer para el Admin)
    def employee_name(self, obj):
        return str(obj.employment.person)
    employee_name.short_description = 'Empleado'

    def evaluator_name(self, obj):
        return str(obj.evaluator)
    evaluator_name.short_description = 'Evaluador'


# --- 3. CONFIGURACIÓN DE CATÁLOGOS ---

@admin.register(models.Competency)
class CompetencyAdmin(admin.ModelAdmin):
    """Configuración de las preguntas/criterios a evaluar."""
    list_display = ('name', 'is_global', 'description')
    list_filter = ('is_global',)
    search_fields = ('name',)
    
    # CLAVE: Permite seleccionar múltiples JobTitles para competencias específicas
    filter_horizontal = ('job_titles',) 
    
    # Los campos de Global y JobTitles solo se muestran si aplican
    fieldsets = (
        (None, {'fields': ('name', 'description')}),
        ('SEGMENTACIÓN', {
            'fields': ('is_global', 'job_titles'),
            'description': 'Si es global, aplica a todos. Si es específico, seleccione los cargos.',
        }),
    )

@admin.register(models.EvaluationPeriod)
class EvaluationPeriodAdmin(admin.ModelAdmin):
    """Admin para gestionar los ciclos y disparar la generación masiva."""
    list_display = ('name', 'start_date', 'end_date', 'is_active', 'review_count')
    list_filter = ('is_active', 'start_date')
    
    # Agrega un campo calculado de conteo de evaluaciones
    def get_queryset(self, request):
        queryset = super().get_queryset(request)
        # Anotamos cuántas revisiones se crearon para cada periodo
        return queryset.annotate(
            _review_count=Count('performance_review')
        )
    
    def review_count(self, obj):
        return obj._review_count
    review_count.short_description = 'Boletas Creadas'


# --- 4. REGISTRO DE DETALLES ---
@admin.register(models.ReviewDetail)
class ReviewDetailAdmin(admin.ModelAdmin):
    list_display = ('review', 'competency', 'score')
    list_filter = ('competency', 'review__period')
    search_fields = ('review__employment__person__first_name', 'competency__name')
    raw_id_fields = ('review', 'competency')
</file>

<file path="backend/performance/apps.py">
from django.apps import AppConfig


class PerformanceConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'performance'
</file>

<file path="backend/performance/models.py">
from django.db import models
from django.core.validators import MinValueValidator, MaxValueValidator
from core.models import Person
from employment.models import Employment
from organization.models import JobTitle # Importamos JobTitle para la relación

class EvaluationPeriod(models.Model):
    """Define el ciclo de evaluación (Ej: 'Evaluación 2025-I')"""
    name = models.CharField(max_length=100, unique=True)
    start_date = models.DateField(verbose_name="Inicio")
    end_date = models.DateField(verbose_name="Cierre")
    is_active = models.BooleanField(default=True, verbose_name="Activo")
    
    class Meta:
        verbose_name = "Periodo de Evaluación"
        ordering = ['-start_date']

    def __str__(self): return self.name

class Competency(models.Model):
    """
    Diccionario de criterios a evaluar.
    """
    name = models.CharField(max_length=100)
    description = models.TextField(blank=True, null=True)
    
    # LÓGICA DE SEGMENTACIÓN
    is_global = models.BooleanField(
        default=True, 
        verbose_name="¿Es Global?",
        help_text="Si se marca, aplica a todos los empleados."
    )
    
    # Relación con Títulos de Cargo (NO con Posiciones individuales)
    job_titles = models.ManyToManyField(
        JobTitle, 
        blank=True, 
        related_name='specific_competencies',
        verbose_name="Aplica a Cargos Específicos"
    )

    class Meta:
        verbose_name = "Competencia / Criterio"
        verbose_name_plural = "Competencias"

    def __str__(self): return self.name

class PerformanceReview(models.Model):
    """La boleta de evaluación de un CONTRATO específico."""
    
    class Status(models.TextChoices):
        DRAFT = 'BOR', 'Borrador'
        SUBMITTED = 'ENV', 'Enviada / Finalizada'
        ACKNOWLEDGED = 'ACE', 'Aceptada por Empleado'

    period = models.ForeignKey(EvaluationPeriod, on_delete=models.PROTECT)
    
    # Evaluamos al CONTRATO (Employment), para soportar pluriempleo
    employment = models.ForeignKey(
        Employment, 
        on_delete=models.CASCADE, 
        related_name='reviews'
    )
    
    # El evaluador es el JEFE en ese momento
    evaluator = models.ForeignKey(
        Person, 
        on_delete=models.PROTECT, 
        related_name='reviews_given'
    )
    
    final_score = models.DecimalField(
        max_digits=4, decimal_places=2, 
        null=True, blank=True, 
        verbose_name="Promedio Final"
    )
    
    status = models.CharField(max_length=3, choices=Status.choices, default=Status.DRAFT)
    
    feedback_manager = models.TextField(verbose_name="Comentarios del Jefe", blank=True)
    feedback_employee = models.TextField(verbose_name="Comentarios del Empleado", blank=True)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        # Un contrato solo puede ser evaluado una vez por periodo
        unique_together = ('period', 'employment') 
        verbose_name = "Evaluación de Desempeño"
        verbose_name_plural = "Evaluaciones de Desempeño"

    def __str__(self):
        return f"{self.employment.person} - {self.period}"
        
    def calculate_score(self):
        """Recalcula el promedio."""
        details = self.details.all()
        if not details.exists():
            self.final_score = 0
        else:
            total = sum([d.score for d in details])
            self.final_score = total / details.count()
        self.save()

class ReviewDetail(models.Model):
    """Cada pregunta y su respuesta."""
    review = models.ForeignKey(PerformanceReview, on_delete=models.CASCADE, related_name='details')
    competency = models.ForeignKey(Competency, on_delete=models.PROTECT)
    
    score = models.PositiveIntegerField(
        default=0,
        validators=[MinValueValidator(0), MaxValueValidator(5)],
        verbose_name="Puntaje (1-5)"
    )
    comment = models.TextField(blank=True, null=True, verbose_name="Observación")

    class Meta:
        unique_together = ('review', 'competency')

    def __str__(self):
        return f"{self.competency}: {self.score}"
</file>

<file path="backend/performance/serializers.py">
from rest_framework import serializers
from .models import EvaluationPeriod, Competency, PerformanceReview, ReviewDetail
from core.serializers import title_case_cleaner

class EvaluationPeriodSerializer(serializers.ModelSerializer):
    class Meta: model = EvaluationPeriod; fields = '__all__'

class CompetencySerializer(serializers.ModelSerializer):
    job_titles_names = serializers.StringRelatedField(many=True, source='job_titles', read_only=True)

    class Meta: 
        model = Competency
        fields = '__all__'
    
    def validate_name(self, value):
        return title_case_cleaner(value)

class ReviewDetailSerializer(serializers.ModelSerializer):
    competency_name = serializers.CharField(source='competency.name', read_only=True)
    competency_description = serializers.CharField(source='competency.description', read_only=True)
    
    class Meta: 
        model = ReviewDetail
        fields = ['id', 'competency', 'competency_name', 'competency_description', 'score', 'comment']

class PerformanceReviewSerializer(serializers.ModelSerializer):
    # Datos de lectura enriquecidos navegando las relaciones de Employment
    employee_name = serializers.CharField(source='employment.person.__str__', read_only=True)
    employee_person_id = serializers.IntegerField(source='employment.person.id', read_only=True) # ID para validar en frontend
    
    position_name = serializers.CharField(source='employment.position.__str__', read_only=True)
    department_name = serializers.CharField(source='employment.position.department.name', read_only=True)
    
    evaluator_name = serializers.CharField(source='evaluator.__str__', read_only=True)
    evaluator_id = serializers.IntegerField(source='evaluator.id', read_only=True) # ID para validar en frontend
    
    period_name = serializers.CharField(source='period.name', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)
    
    # Detalles (Preguntas) anidados
    details = ReviewDetailSerializer(many=True, read_only=True)

    class Meta:
        model = PerformanceReview
        fields = '__all__'
</file>

<file path="backend/performance/tests.py">
from django.test import TestCase

# Create your tests here.
</file>

<file path="backend/performance/urls.py">
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from . import views

router = DefaultRouter()
router.register(r'periods', views.EvaluationPeriodViewSet, basename='period')
router.register(r'competencies', views.CompetencyViewSet, basename='competency')
router.register(r'reviews', views.PerformanceReviewViewSet, basename='review')
router.register(r'details', views.ReviewDetailViewSet, basename='review-detail')

urlpatterns = [
    path('', include(router.urls)),
]
</file>

<file path="backend/performance/views.py">
from rest_framework import viewsets, permissions, status
from rest_framework.decorators import action
from rest_framework.response import Response
from django.db import transaction
from django.db.models import Q, Count, F
from .models import EvaluationPeriod, Competency, PerformanceReview, ReviewDetail
from .serializers import EvaluationPeriodSerializer, CompetencySerializer, PerformanceReviewSerializer, ReviewDetailSerializer
from employment.models import Employment

class EvaluationPeriodViewSet(viewsets.ModelViewSet):
    queryset = EvaluationPeriod.objects.all()
    serializer_class = EvaluationPeriodSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]

    @action(detail=True, methods=['post'])
    def generate_reviews(self, request, pk=None):
        """
        Genera masivamente las evaluaciones para todos los empleados activos.
        """
        period = self.get_object()
        count_created = 0
        
        # 1. Buscar contratos activos (ocupan silla)
        # Usamos el campo booleano de tu modelo EmploymentStatus
        active_employments = Employment.objects.filter(
            current_status__is_active_relationship=True
        ).select_related('position__manager_position', 'position__job_title', 'person')

        try:
            with transaction.atomic():
                for emp in active_employments:
                    # A. Determinar Jefe (Evaluador)
                    boss_pos = emp.position.manager_position
                    evaluator = None
                    
                    if boss_pos:
                        # Buscamos quién es el jefe activo hoy en esa posición superior
                        boss = Employment.objects.filter(
                            position=boss_pos, 
                            current_status__is_active_relationship=True
                        ).first()
                        if boss:
                            evaluator = boss.person
                    
                    # Si no tiene jefe asignado, no generamos.
                    if not evaluator:
                        continue 

                    # B. Crear Boleta
                    review, created = PerformanceReview.objects.get_or_create(
                        period=period,
                        employment=emp,
                        defaults={'evaluator': evaluator, 'status': 'BOR'}
                    )

                    if created:
                        count_created += 1
                        
                        # C. Asignar Competencias (Híbridas: Globales + Específicas del JobTitle)
                        comps = Competency.objects.filter(
                            Q(is_global=True) | 
                            Q(job_titles=emp.position.job_title)
                        ).distinct()
                        
                        details = [
                            ReviewDetail(review=review, competency=c, score=0)
                            for c in comps
                        ]
                        ReviewDetail.objects.bulk_create(details)

            return Response({"message": f"Proceso finalizado. Se generaron {count_created} evaluaciones nuevas."}, status=200)
        
        except Exception as e:
            return Response({"error": str(e)}, status=500)


class CompetencyViewSet(viewsets.ModelViewSet):
    queryset = Competency.objects.all()
    serializer_class = CompetencySerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]


class PerformanceReviewViewSet(viewsets.ModelViewSet):
    queryset = PerformanceReview.objects.all()
    serializer_class = PerformanceReviewSerializer
    permission_classes = [permissions.IsAuthenticated]

    def get_queryset(self):
        user = self.request.user
        queryset = PerformanceReview.objects.all()

        # 1. FILTRO DE SEGURIDAD BASE (Quién puede ver qué en general)
        if not user.is_staff:
            if hasattr(user, 'person'):
                queryset = queryset.filter(
                    Q(evaluator=user.person) |          # Soy el Jefe
                    Q(employment__person=user.person)   # Soy el Empleado
                )
            else:
                return PerformanceReview.objects.none()

        # 2. FILTRO DE ALCANCE (NUEVO - CRÍTICO PARA TU PROBLEMA)
        scope = self.request.query_params.get('scope')
        
        if scope == 'received':
            # CASO: "Mis Evaluaciones" (Soy el empleado)
            if hasattr(user, 'person'):
                queryset = queryset.filter(employment__person=user.person)
            else:
                return PerformanceReview.objects.none() # Admin sin persona no tiene evaluaciones propias
                
        elif scope == 'given':
            # CASO: "Mi Equipo" (Soy el jefe)
            if hasattr(user, 'person'):
                queryset = queryset.filter(evaluator=user.person)
        
        # 3. FILTRO POR DEPARTAMENTO (Existente)
        dept_id = self.request.query_params.get('department')
        if dept_id:
            if dept_id == '0':
                queryset = queryset.filter(employment__position__department__isnull=True)
            else:
                queryset = queryset.filter(employment__position__department_id=dept_id)

        return queryset.distinct()

    @action(detail=False, methods=['get'])
    def my_teams_summary(self, request):
        """
        Devuelve el resumen de equipos que el usuario supervisa, 
        basado en la JERARQUÍA y su ROL FUNCIONAL.
        """
        user = request.user
        
        if not hasattr(user, 'person'):
            return Response([])

        # Definimos los roles funcionales que otorgan permiso de supervisión
        # 🚨 IMPORTANTE: Estos nombres deben coincidir exactamente con los que has creado en la tabla 'Role'
        SUPERVISORY_ROLES = ['Manager', 'Supervisor', 'Gerente', 'Director'] 

        # 1. Identificar todas las POSICIONES activas que ocupa este usuario Y que tienen rol de JEFE
        user_manager_positions = Employment.objects.filter(
            person=user.person,
            current_status__is_active_relationship=True,
            # CRÍTICO: Filtramos por el nombre del rol (Employment.role.name)
            role__name__in=SUPERVISORY_ROLES 
        ).values_list('position_id', flat=True)

        
        # 2. Si el usuario no tiene ninguna posición activa de Manager, no ve equipos.
        # (Excepción: El Admin puede ver todo)
        if not user_manager_positions.exists() and not user.is_staff:
            return Response([])
        
        # 3. Definir el QuerySet Base
        if user.is_staff:
            # Si es admin, ve todas las evaluaciones generadas para monitoreo
            base_qs = PerformanceReview.objects.all()
        else:
            # Si es Gerente/Supervisor, solo ve las evaluaciones de subordinados que reportan a SUS posiciones
            # La evaluación del subordinado debe reportar a una de las sillas que yo ocupo
            base_qs = PerformanceReview.objects.filter(
                employment__position__manager_position__in=user_manager_positions,
                evaluator=user.person # Filtro de seguridad adicional: solo si me asignaron como evaluador
            )
        
        # 4. Agrupar y contar (El proceso de agrupamiento sigue igual)
        teams = base_qs.values(
            dept_id=F('employment__position__department__id'),
            dept_name=F('employment__position__department__name')
        ).annotate(
            total=Count('id'),
            pending=Count('id', filter=Q(status='BOR'))
        ).order_by('dept_name')

        return Response(list(teams))

class ReviewDetailViewSet(viewsets.ModelViewSet):
    queryset = ReviewDetail.objects.all()
    serializer_class = ReviewDetailSerializer
    permission_classes = [permissions.IsAuthenticated]
    
    def update(self, request, *args, **kwargs):
        response = super().update(request, *args, **kwargs)
        # Recalcular promedio del padre al guardar un detalle
        self.get_object().review.calculate_score()
        return response
</file>

<file path="backend/recruitment/admin.py">
from django.contrib import admin

# Register your models here.
</file>

<file path="backend/recruitment/apps.py">
from django.apps import AppConfig


class RecruitmentConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'recruitment'
</file>

<file path="backend/recruitment/models.py">
from django.db import models

# Create your models here.
</file>

<file path="backend/recruitment/tests.py">
from django.test import TestCase

# Create your tests here.
</file>

<file path="backend/recruitment/views.py">
from django.shortcuts import render

# Create your views here.
</file>

<file path="backend/talent/migrations/0002_remove_personlanguage_reading_proficiency_and_more.py">
# Generated by Django 5.2.8 on 2025-12-01 20:57

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('core', '0010_alter_historicalperson_birthdate'),
        ('talent', '0001_initial'),
    ]

    operations = [
        migrations.RemoveField(
            model_name='personlanguage',
            name='reading_proficiency',
        ),
        migrations.AddConstraint(
            model_name='personlanguage',
            constraint=models.UniqueConstraint(fields=('person', 'language'), name='unique_person_language', violation_error_message='Esta persona ya tiene registrado este idioma.'),
        ),
    ]
</file>

<file path="backend/talent/migrations/0003_personlanguage_reading_proficiency.py">
# Generated by Django 5.2.8 on 2025-12-01 21:01

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('talent', '0002_remove_personlanguage_reading_proficiency_and_more'),
    ]

    operations = [
        migrations.AddField(
            model_name='personlanguage',
            name='reading_proficiency',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='reading', to='talent.languageproficiency'),
        ),
    ]
</file>

<file path="backend/talent/apps.py">
from django.apps import AppConfig


class TalentConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'talent'
</file>

<file path="backend/talent/tests.py">
from django.test import TestCase

# Create your tests here.
</file>

<file path="backend/training/migrations/0001_initial.py">
# Generated by Django 5.2.8 on 2025-11-24 13:12

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('core', '0001_initial'),
    ]

    operations = [
        migrations.CreateModel(
            name='Course',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=200, verbose_name='Nombre del Curso')),
                ('description', models.TextField(blank=True, null=True)),
                ('start_date', models.DateField(verbose_name='Fecha Inicio')),
                ('end_date', models.DateField(verbose_name='Fecha Fin')),
                ('modality', models.CharField(choices=[('PRE', 'Presencial'), ('VIR', 'Virtual (En Vivo / Zoom)'), ('ASY', 'Virtual (Autoaprendizaje)'), ('MIX', 'Híbrido / Mixto')], default='PRE', max_length=3)),
                ('max_participants', models.PositiveIntegerField(default=20, help_text='Límite de estudiantes permitidos.', verbose_name='Cupo Máximo')),
                ('duration_hours', models.PositiveIntegerField(default=0)),
                ('status', models.CharField(choices=[('BOR', 'Borrador'), ('PRO', 'Programado'), ('EJE', 'En Ejecución'), ('FIN', 'Finalizado'), ('CAN', 'Cancelado')], default='BOR', max_length=3)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
            ],
        ),
        migrations.CreateModel(
            name='CourseParticipant',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('role', models.CharField(choices=[('INS', 'Instructor'), ('EST', 'Estudiante')], default='EST', max_length=3)),
                ('status', models.CharField(choices=[('PEN', 'Pendiente'), ('APR', 'Aprobado'), ('REP', 'Reprobado'), ('RET', 'Retirado')], default='PEN', max_length=3)),
                ('grade', models.DecimalField(blank=True, decimal_places=2, max_digits=5, null=True)),
                ('course', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='participants', to='training.course')),
                ('person', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='training_courses', to='core.person')),
            ],
            options={
                'unique_together': {('course', 'person')},
            },
        ),
        migrations.CreateModel(
            name='CourseResource',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=200, verbose_name='Título del Recurso')),
                ('resource_type', models.CharField(choices=[('FIL', 'Archivo (PDF/Doc/Img)'), ('URL', 'Enlace Externo / Video')], default='FIL', max_length=3)),
                ('file', models.FileField(blank=True, null=True, upload_to='training/resources/')),
                ('url', models.URLField(blank=True, help_text='Youtube, Drive, Zoom, etc.', null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('course', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='resources', to='training.course')),
            ],
        ),
        migrations.CreateModel(
            name='CourseSession',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('topic', models.CharField(max_length=200, verbose_name='Tema / Título de la Sesión')),
                ('date', models.DateField(verbose_name='Fecha de la sesión')),
                ('start_time', models.TimeField(verbose_name='Hora Inicio')),
                ('end_time', models.TimeField(verbose_name='Hora Fin')),
                ('course', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='sessions', to='training.course')),
            ],
            options={
                'ordering': ['date', 'start_time'],
            },
        ),
        migrations.CreateModel(
            name='AttendanceRecord',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('status', models.CharField(choices=[('PRE', 'Presente'), ('AUS', 'Ausente'), ('TAR', 'Tardanza'), ('JUS', 'Justificado')], default='AUS', max_length=3)),
                ('notes', models.CharField(blank=True, max_length=255, null=True)),
                ('participant', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='attendance_history', to='training.courseparticipant')),
                ('session', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='attendance_records', to='training.coursesession')),
            ],
            options={
                'unique_together': {('session', 'participant')},
            },
        ),
    ]
</file>

<file path="backend/training/migrations/0002_alter_courseparticipant_status.py">
# Generated by Django 5.2.8 on 2025-11-24 19:28

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('training', '0001_initial'),
    ]

    operations = [
        migrations.AlterField(
            model_name='courseparticipant',
            name='status',
            field=models.CharField(choices=[('PEN', 'Pendiente'), ('APR', 'Aprobado'), ('REP', 'Reprobado'), ('INS', 'Inscrito'), ('RET', 'Retirado')], default='PEN', max_length=3),
        ),
    ]
</file>

<file path="backend/training/migrations/0003_course_cover_image.py">
# Generated by Django 5.2.8 on 2025-11-24 20:24

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('training', '0002_alter_courseparticipant_status'),
    ]

    operations = [
        migrations.AddField(
            model_name='course',
            name='cover_image',
            field=models.ImageField(blank=True, null=True, upload_to='courses/covers/', verbose_name='Imagen de Portada'),
        ),
    ]
</file>

<file path="backend/training/migrations/0004_alter_courseparticipant_status.py">
# Generated by Django 5.2.8 on 2025-11-25 00:07

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('training', '0003_course_cover_image'),
    ]

    operations = [
        migrations.AlterField(
            model_name='courseparticipant',
            name='status',
            field=models.CharField(choices=[('SOL', 'Solicitud Enviada'), ('PEN', 'Pendiente'), ('APR', 'Aprobado'), ('REP', 'Reprobado'), ('INS', 'Inscrito'), ('RET', 'Retirado')], default='PEN', max_length=3),
        ),
    ]
</file>

<file path="backend/training/migrations/0005_alter_courseparticipant_status.py">
# Generated by Django 5.2.8 on 2025-11-25 01:01

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('training', '0004_alter_courseparticipant_status'),
    ]

    operations = [
        migrations.AlterField(
            model_name='courseparticipant',
            name='status',
            field=models.CharField(choices=[('SOL', 'Solicitud Enviada'), ('PEN', 'Pendiente'), ('APR', 'Aprobado'), ('REP', 'Reprobado'), ('INS', 'Inscrito'), ('RET', 'Retirado'), ('REJ', 'Solicitud Rechazada')], default='PEN', max_length=3),
        ),
    ]
</file>

<file path="backend/training/migrations/0006_courseparticipant_academic_status_and_more.py">
# Generated by Django 5.2.8 on 2025-11-26 14:37

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('training', '0005_alter_courseparticipant_status'),
    ]

    operations = [
        migrations.AddField(
            model_name='courseparticipant',
            name='academic_status',
            field=models.CharField(choices=[('NEV', 'No Evaluado / N/A'), ('PEN', 'En Curso / Pendiente'), ('APR', 'Aprobado'), ('REP', 'Reprobado')], default='NEV', max_length=3, verbose_name='Estado Académico'),
        ),
        migrations.AddField(
            model_name='courseparticipant',
            name='enrollment_status',
            field=models.CharField(choices=[('REQ', 'Solicitud Enviada'), ('ENR', 'Inscrito / Matriculado'), ('REJ', 'Solicitud Rechazada'), ('DRP', 'Retirado')], default='REQ', max_length=3, verbose_name='Estado de Inscripción'),
        ),
        migrations.AlterField(
            model_name='courseparticipant',
            name='status',
            field=models.CharField(choices=[('SOL', 'Solicitud Enviada'), ('PEN', 'Pendiente'), ('APR', 'Aprobado'), ('REP', 'Reprobado'), ('INS', 'Inscrito'), ('RET', 'Retirado'), ('REJ', 'Solicitud Rechazada')], default='PEN', max_length=3, null=True),
        ),
    ]
</file>

<file path="backend/training/migrations/0007_auto_20251126_1037.py">
from django.db import migrations

def migrate_status(apps, schema_editor):
    CourseParticipant = apps.get_model('training', 'CourseParticipant')
    for participant in CourseParticipant.objects.all():
        old_status = participant.status
        
        # Mapeo: 'SOL' -> ('REQ', 'NEV')
        if old_status == 'SOL':
            participant.enrollment_status = 'REQ'
            participant.academic_status = 'NEV'
        # Mapeo: 'INS' -> ('ENR', 'PEN')
        elif old_status == 'INS':
            participant.enrollment_status = 'ENR'
            participant.academic_status = 'PEN'
        # Mapeo: 'PEN' -> ('ENR', 'PEN')
        elif old_status == 'PEN':
            participant.enrollment_status = 'ENR'
            participant.academic_status = 'PEN'
        # Mapeo: 'APR' -> ('ENR', 'APR')
        elif old_status == 'APR':
            participant.enrollment_status = 'ENR'
            participant.academic_status = 'APR'
        # Mapeo: 'REP' -> ('ENR', 'REP')
        elif old_status == 'REP':
            participant.enrollment_status = 'ENR'
            participant.academic_status = 'REP'
        # Mapeo: 'REJ' -> ('REJ', 'NEV')
        elif old_status == 'REJ':
            participant.enrollment_status = 'REJ'
            participant.academic_status = 'NEV'
        # Mapeo: 'RET' -> ('DRP', 'NEV')
        elif old_status == 'RET':
            participant.enrollment_status = 'DRP'
            participant.academic_status = 'NEV'
            
        participant.save()

class Migration(migrations.Migration):

    dependencies = [
        ('training', '0006_courseparticipant_academic_status_and_more'),
    ]

    operations = [
        migrations.RunPython(migrate_status),
    ]
</file>

<file path="backend/training/migrations/0008_remove_courseparticipant_status.py">
# Generated by Django 5.2.8 on 2025-11-26 14:42

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ('training', '0007_auto_20251126_1037'),
    ]

    operations = [
        migrations.RemoveField(
            model_name='courseparticipant',
            name='status',
        ),
    ]
</file>

<file path="backend/training/apps.py">
from django.apps import AppConfig


class TrainingConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'training'
</file>

<file path="backend/training/permissions.py">
from rest_framework import permissions

class IsInstructorOrAdmin(permissions.BasePermission):

    def has_object_permission(self, request, view, obj):
        # --- REGLA 1: PODER SUPREMO DEL ADMIN ---
        if request.user.is_staff or request.user.is_superuser:
            return True

        # --- REGLA 2: PROTECCIÓN CONTRA BORRADO ---
        # Nadie más que el admin puede eliminar registros
        if request.method == 'DELETE':
            return False

        # --- LÓGICA DE NAVEGACIÓN AL CURSO ---
        course = None
        
        # Caso A: El objeto es el Curso mismo
        if hasattr(obj, 'participants'): 
            course = obj
        # Caso B: El objeto es directo del curso (Resource, Session, Participant)
        elif hasattr(obj, 'course'):
            course = obj.course
        # Caso C: El objeto es nieto (AttendanceRecord -> Session -> Course)
        elif hasattr(obj, 'session'):
            course = obj.session.course

        # Si no se pudo determinar el curso o usuario sin perfil, denegar.
        if not course or not hasattr(request.user, 'person'):
            return False

        # --- REGLA 3: PERMISOS DEL INSTRUCTOR ---
        # Acceso total (menos borrar) sobre SU curso
        is_instructor = course.participants.filter(
            person=request.user.person,
            role='INS'
        ).exists()

        if is_instructor:
            return True

        # --- REGLA 4: PERMISOS DEL ESTUDIANTE INSCRITO ---
        # Solo lectura sobre SU curso
        is_student = course.participants.filter(
            person=request.user.person,
            role='EST'
        ).exists()

        if is_student:
            if request.method in permissions.SAFE_METHODS:
                return True

        # --- REGLA 5: PERMISOS DE CATÁLOGO (USUARIO GENERAL) ---
        # Si no es ni instructor ni estudiante, pero el curso es PÚBLICO,
        # permitimos ver los detalles para que pueda decidir inscribirse.
        if request.method in permissions.SAFE_METHODS: # Solo GET/OPTIONS
            # Verificamos si el estatus es 'PRO' (Programado) o 'EJE' (En Ejecución)
            if course.status in ['PRO', 'EJE']:
                return True

        return False
</file>

<file path="backend/training/tests.py">
from django.test import TestCase

# Create your tests here.
</file>

<file path="backend/training/urls.py">
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from . import views

router = DefaultRouter()

# 1. Cursos (Gestión principal)
router.register(r'courses', views.CourseViewSet, basename='course')

# 2. Recursos (Archivos y Links)
router.register(r'resources', views.CourseResourceViewSet, basename='course-resource')

# 3. Sesiones (Clases individuales para asistencia)
router.register(r'sessions', views.CourseSessionViewSet, basename='course-session')

# 4. Participantes (Inscripciones de alumnos e instructores)
router.register(r'participants', views.CourseParticipantViewSet, basename='course-participant')

# 5. Asistencia (Registros puntuales)
router.register(r'attendance', views.AttendanceRecordViewSet, basename='attendance-record')

urlpatterns = [
    path('', include(router.urls)),
]
</file>

<file path="backend/.python-version">
3.13
</file>

<file path="backend/cleanup_positions.py">
import os
import django
from django.db.models import Count

os.environ.setdefault("DJANGO_SETTINGS_MODULE", "config.settings")
django.setup()

from organization.models import Position
from employment.models import Employment

def clean_duplicates():
    print("Searching for duplicate positions...")
    duplicates = Position.objects.values('department', 'job_title').annotate(
        count=Count('id')
    ).filter(count__gt=1)

    for dup in duplicates:
        dept_id = dup['department']
        job_id = dup['job_title']
        
        positions = Position.objects.filter(department_id=dept_id, job_title_id=job_id).order_by('created_at')
        
        # Keep the first one, delete the rest
        primary = positions.first()
        others = positions[1:]
        
        print(f"Found {len(others) + 1} duplicates for Dept {dept_id} / Job {job_id}. Keeping ID {primary.id}.")
        
        for pos in others:
            print(f"  - Merging Position {pos.id} into {primary.id}...")
            
            # Reassign Employments
            Employment.objects.filter(position=pos).update(position=primary)
            
            # Reassign Direct Reports (Manager Position)
            Position.objects.filter(manager_position=pos).update(manager_position=primary)
            
            # Delete the duplicate
            pos.delete()
            print(f"  - Position {pos.id} deleted.")

    print("Cleanup complete.")

if __name__ == "__main__":
    clean_duplicates()
</file>

<file path="backend/create_ats_test_data.py">
"""
Script para crear datos de prueba del módulo ATS
"""
import os
import django
from datetime import date, timedelta

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')
django.setup()

from organization.models import Department, JobTitle, Position
from ats.models import JobPosting

# Limpiar datos anteriores de ATS
print("Limpiando datos anteriores...")
JobPosting.objects.all().delete()

# Crear departamentos si no existen
print("Creando departamentos...")
it_dept, _ = Department.objects.get_or_create(name="Tecnología e Informática")
rrhh_dept, _ = Department.objects.get_or_create(name="Recursos Humanos")
admin_dept, _ = Department.objects.get_or_create(name="Administración")

# Crear job titles
print("Creando job titles...")
dev_title, _ = JobTitle.objects.get_or_create(
    name="Desarrollador Full Stack",
    defaults={'description': 'Desarrollador de software con experiencia en frontend y backend'}
)
hr_title, _ = JobTitle.objects.get_or_create(
    name="Analista de RRHH",
    defaults={'description': 'Analista de recursos humanos'}
)
admin_title, _ = JobTitle.objects.get_or_create(
    name="Asistente Administrativo",
    defaults={'description': 'Asistente en tareas administrativas'}
)

# Crear posiciones
print("Creando posiciones...")
dev_position, _ = Position.objects.get_or_create(
    department=it_dept,
    job_title=dev_title,
    defaults={'vacancies': 2}
)
hr_position, _ = Position.objects.get_or_create(
    department=rrhh_dept,
    job_title=hr_title,
    defaults={'vacancies': 1}
)
admin_position, _ = Position.objects.get_or_create(
    department=admin_dept,
    job_title=admin_title,
    defaults={'vacancies': 1}
)

# Crear vacantes publicadas
print("Creando vacantes...")

# Vacante 1: Desarrollador (pide educación, experiencia y portafolio)
job1 = JobPosting.objects.create(
    title="Desarrollador Full Stack Senior",
    description="""Buscamos un desarrollador full stack con sólida experiencia en tecnologías modernas.

Responsabilidades:
- Diseñar y desarrollar aplicaciones web escalables
- Colaborar con el equipo en la arquitectura de soluciones
- Mantener y optimizar sistemas existentes
- Participar en code reviews y mentoría

Ofrecemos:
- Ambiente de trabajo dinámico e innovador
- Oportunidades de crecimiento profesional
- Capacitación continua en nuevas tecnologías
- Beneficios competitivos""",
    position=dev_position,
    department=it_dept,
    salary_range="$1,200 - $2,000 USD",
    location="Caracas / Remoto",
    ask_education=True,
    ask_experience=True,
    ask_portfolio=True,
    status='PUBLISHED',
    published_date=date.today(),
    closing_date=date.today() + timedelta(days=30)
)

# Vacante 2: Analista RRHH (pide educación, NO experiencia, NO portafolio)
job2 = JobPosting.objects.create(
    title="Analista de Recursos Humanos Junior",
    description="""Estamos en búsqueda de un Analista de RRHH para unirse a nuestro equipo.

Responsabilidades:
- Apoyar en procesos de reclutamiento y selección
- Gestionar expedientes de personal
- Coordinar capacitaciones y desarrollo
- Participar en evaluaciones de desempeño

Requisitos:
- Título universitario en RRHH, Psicología o afines
- Excelentes habilidades de comunicación
- Capacidad de trabajo en equipo
- Manejo de MS Office

Ofrecemos:
- Oportunidad de aprender y crecer
- Ambiente laboral positivo
- Beneficios de ley y adicionales""",
    position=hr_position,
    department=rrhh_dept,
    salary_range="$800 - $1,000 USD",
    location="Caracas",
    ask_education=True,
    ask_experience=False,
    ask_portfolio=False,
    status='PUBLISHED',
    published_date=date.today(),
    closing_date=date.today() + timedelta(days=45)
)

# Vacante 3: Asistente Administrativo (NO pide educación, NO experiencia, NO portafolio)
job3 = JobPosting.objects.create(
    title="Asistente Administrativo",
    description="""Necesitamos un Asistente Administrativo organizado y proactivo.

Responsabilidades:
- Gestión de documentos y archivo
- Atención telefónica y recepción
- Apoyo en tareas administrativas generales
- Coordinación de reuniones y eventos

Requisitos:
- Bachiller o estudiante universitario
- Experiencia deseable pero no excluyente
- Manejo de herramientas ofimáticas
- Excelente actitud de servicio

Ofrecemos:
- Estabilidad laboral
- Horario flexible
- Ambiente de trabajo agradable""",
    position=admin_position,
    department=admin_dept,
    salary_range="$500 - $700 USD",
    location="Caracas",
    ask_education=False,
    ask_experience=False,
    ask_portfolio=False,
    status='PUBLISHED',
    published_date=date.today(),
    closing_date=date.today() + timedelta(days=60)
)

# Agregar objetivos y requisitos a las posiciones
print("Agregando objetivos y requisitos...")

# Objetivos para Desarrollador
dev_position.objectives.get_or_create(description="Desarrollar software de alta calidad que cumpla con los estándares de la industria")
dev_position.objectives.get_or_create(description="Innovar en la implementación de nuevas tecnologías")
dev_position.objectives.get_or_create(description="Colaborar efectivamente con equipos multidisciplinarios")

dev_position.requirements.get_or_create(description="Experiencia mínima de 3 años en desarrollo web")
dev_position.requirements.get_or_create(description="Dominio de JavaScript/TypeScript y frameworks modernos (React, Next.js)")
dev_position.requirements.get_or_create(description="Experiencia con Python/Django o Node.js")
dev_position.requirements.get_or_create(description="Conocimientos de bases de datos SQL y NoSQL")
dev_position.requirements.get_or_create(description="Inglés técnico nivel intermedio")

# Objetivos para Analista RRHH
hr_position.objectives.get_or_create(description="Atraer y retener el mejor talento para la organización")
hr_position.objectives.get_or_create(description="Mantener la satisfacción y desarrollo del personal")

hr_position.requirements.get_or_create(description="Título universitario en carreras afines")
hr_position.requirements.get_or_create(description="Habilidades de comunicación efectiva")
hr_position.requirements.get_or_create(description="Capacidad de análisis y organización")

# Objetivos para Asistente
admin_position.objectives.get_or_create(description="Garantizar el funcionamiento eficiente de las operaciones administrativas")
admin_position.requirements.get_or_create(description="Bachiller completo")
admin_position.requirements.get_or_create(description="Manejo básico de computadoras")

print("\n✅ Datos de prueba creados exitosamente!")
print(f"\nVacantes creadas:")
print(f"1. {job1.title} - {job1.department.name}")
print(f"   Pide: Educación✓ Experiencia✓ Portafolio✓")
print(f"2. {job2.title} - {job2.department.name}")
print(f"   Pide: Educación✓ Experiencia✗ Portafolio✗")
print(f"3. {job3.title} - {job3.department.name}")
print(f"   Pide: Educación✗ Experiencia✗ Portafolio✗")
print(f"\n👉 Accede a http://localhost:3000/ para ver el portal público")
</file>

<file path="backend/create_education_data.py">
"""
Script para crear datos de prueba de Educación (Niveles y Áreas)
"""
import os
import django

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')
django.setup()

from talent.models import EducationLevel, FieldOfStudy

print("Creando niveles educativos...")
levels = [
    "Bachillerato",
    "Técnico Superior Universitario",
    "Licenciatura",
    "Ingeniería",
    "Maestría",
    "Doctorado"
]

for name in levels:
    EducationLevel.objects.get_or_create(name=name)
    print(f"- {name}")

print("\nCreando áreas de estudio...")
fields = [
    "Informática y Sistemas",
    "Recursos Humanos",
    "Administración de Empresas",
    "Contaduría Pública",
    "Educación",
    "Diseño Gráfico",
    "Psicología Industrial"
]

for name in fields:
    FieldOfStudy.objects.get_or_create(name=name)
    print(f"- {name}")

print("\n✅ Datos de educación creados exitosamente!")
</file>

<file path="backend/generate_complete_org_fixtures.py">
#!/usr/bin/env python3
"""
SCRIPT COMPLETO para generar initial_data.json con TODOS los datos del manual
"""
import json

data = []

# ===== DEPARTMENTS =====
departments_data = [
    (1, "Dirección", None),
    (2, "Subdirección Académica", 1),
    (3, "Coordinación de Control de Estudios y Evaluación", 2),
    (4, "Coordinación Administrativa", 1),
    (5, "Coordinación de Pasant

ías", 2),
    (6, "Coordinación de Informática", 2),
    (7, "Coordinación de Preescolar", 2),
    (8, "Coordinación de Investigación, Extensión y Postgrado", 2),
    (9, "Biblioteca", 2),
]

for pk, name, parent in departments_data:
    data.append({"model": "organization.department", "pk": pk, "fields": {"name": name, "parent": parent}})

# ===== JOB TITLES =====
jobtitles_data = [
    (1, "Director"), (2, "Subdirector"), (3, "Coordinador"), (4, "Jefe"),
    (5, "Asesor"), (6, "Secretaria"), (7, "Recepcionista"), (8, "Asistente"),
    (9, "Personal de Mantenimiento"), (10, "Personal de Limpieza"), (11, "Auxiliar"),
]

for pk, name in jobt

itles_data:
    data.append({"model": "organization.jobtitle", "pk": pk, "fields": {"name": name}})

# ===== POSITIONS =====
# Shortened objectives for brevity
positions_data = [
    (1, 1, 1, 1, "Planificar, organizar, dirigir y controlar todas las actividades que se realizan en la Extensión desde el punto de vista administrativo y académico. A través del liderazgo, la supervisión y delegación de funciones, se responsabiliza por la buena marcha de la Institución dentro del marco de la misión, visión, valores, políticas, objetivos y planes establecidos por la Dirección Nacional, asegurándose de que éstos sean ejecutados."),
    (2, 1, 5, 1, "Gestionar la imagen institucional y la comunicación externa del Instituto, estableciendo vínculos efectivos con los medios de comunicación y organismos públicos o privados para promover la oferta académica y las actividades de la extensión."),
    (3, 1, 6, 1, "Brindar apoyo administrativo y secretarial de alto nivel a la Dirección, gestionando la agenda, la correspondencia y la atención al público, garantizando la confidencialidad y fluidez de la información en el despacho del Director."),
    (4, 1, 7, 1, "Atender a los visitantes que acuden a la Extensión a solicitar información y operar la central telefónica para recibir y efectuar las llamadas que le sean solicitadas."),
   (5, 2, 2, 1, "Prestar ayuda, apoyo y respaldo a la Jefatura de la Extensión, con el objeto de aportar su contribución, supervisando conjuntamente con el Jefe de la Extensión el desarrollo de las actividades que en las áreas académico-administrativo, deben realizarse para así mantener un mejor desenvolvimiento de la ejecución de todas las actividades de la Institución."),
    (6, 2, 8, 1, "Asistir a la Subdirección Académica en la gestión operativa y administrativa de los procesos docentes, manteniendo actualizados los registros del personal, horarios y programación académica para garantizar el flujo eficiente de la información."),
    (7, 3, 3, 1, "Planificar, organizar, coordinar y controlar las actividades de la Coordinación de Control de Estudios y Evaluación, desarrollando el programa de seguimiento de los estudiantes y profesores, para el registro de la documentación que deba procesarse a fin de garantizar el fiel cumplimiento de los objetivos de esta área."),
    (8, 3, 8, 1, "Ejecutar los procesos operativos de inscripción, registro y control de notas, así como brindar soporte técnico en la emisión de documentos académicos, asegurando la integridad de los datos de los estudiantes."),
    (9, 3, 6, 1, "Atender directamente las solicitudes de los estudiantes y docentes en taquilla, organizando los expedientes y archivos físicos de notas, garantizando un servicio eficiente y ordenado en el departamento."),
    (10, 4, 3, 1, "Planificar, coordinar, supervisar y evaluar las actividades administrativas de la Extensión, conducir y verificar los procedimientos administrativos vigentes así como los Registros Contables que se realizan en esta unidad, administrar las nóminas académicas y administrativas y ejecutar los pagos correspondientes a proveedores, para así lograr el buen funcionamiento administrativo de la Institución."),
    (11, 4, 8, 1, "Apoyar en la ejecución de los procesos administrativos contables, gestionando pagos de servicios, suministros y atención a requerimientos logísticos de los departamentos, asegurando el soporte necesario para la operatividad de la extensión."),
    (12, 4, 9, 2, "Garantizar la operatividad de la infraestructura física y el mobiliario de la Institución, realizando reparaciones menores y mantenimiento preventivo a las instalaciones y equipos para asegurar un ambiente funcional."),
    (13, 4, 10, 3, "Mantener en óptimas condiciones de higiene y aseo todas las áreas de la Institución, asegurando un ambiente limpio y agradable para el desarrollo de las actividades académicas y administrativas."),
    (14, 5, 3, 1, "Planificar, coordinar, supervisar, evaluar y controlar la ejecución de los programas de Pasantías y Trabajo Especial de Grado, a través del cumplimiento de los procedimientos vigentes que permitan realizar su seguimiento y evaluación."),
    (15, 5, 8, 1, "Apoyar en la gestión administrativa y logística de la Coordinación, sirviendo de enlace entre los estudiantes, tutores y la coordinación, facilitando el procesamiento de documentos y la atención a los requerimientos del proceso de pasantías."),
    (16, 6, 3, 1, "Bajo supervisión de la Jefatura de la Extensión administra en detalle las funciones relativas al área de la Coordinación de Informática, vigilando el cumplimiento de los programas establecidos y asignados a su gestión. Presta apoyo y atención al profesorado de esta área y es responsable del buen funcionamiento del Laboratorio de Informática."),
    (17, 6, 8, 1, "Coordinar y dirigir las actividades académicas de los estudiantes dentro del Laboratorio, prestando apoyo a los docentes y a la coordinación de las Carreras correspondientes, así como velar por el mantenimiento preventivo de los equipos."),
    (18, 7, 3, 1, "Bajo supervisión de la Jefatura de la Extensión, coordina y dirige las actividades y programas establecidos para el área de Educación Preescolar, orientando su cumplimiento por parte del personal docente y organizando con el alumno lo relativo a las prácticas de la especialidad."),
    (19, 7, 8, 1, "Asistir administrativamente a la Coordinación de Preescolar, apoyando en la organización de archivos, atención al público y gestión de los procesos de prácticas profesion

ales, asegurando la continuidad operativa en ausencia del Coordinador."),
    (20, 8, 3, 1, "Promover, planificar y coordinar el desarrollo de la investigación científica, las actividades de extensión cultural y deportiva, y los estudios de postgrado, vinculando a la institución con su entorno y fomentando la formación continua de la comunidad Iutirlista."),
    (21, 9, 4, 1, "Administrar, coordinar y supervisar los servicios bibliotecarios de la Institución, garantizando la organización, actualización y conservación del acervo bibliográfico, así como la prestación de un servicio eficiente a la comunidad universitaria."),
    (22, 9, 8, 1, "Atender a los estudiantes, personal docente y administrativo, para suministrarles la bibliografía que soliciten en la realización de investigaciones que favorezcan el proceso de enseñanza-aprendizaje, apoyando en la catalogación y control del material."),
    (23, 9, 11, 2, "Apoyar en las labores operativas de la biblioteca, encargándose del préstamo, devolución, ordenamiento de textos y atención primaria al usuario, contribuyendo al mantenimiento del orden y la conservación del material."),
]

for pk, dept, jt, vac, obj in positions_data:
    data.append({"model": "organization.position", "pk": pk, "fields": {"department": dept, "job_title": jt, "vacancies": vac, "objective": obj}})

print(f"Generated {len(data)} base entries (depts+jobs+positions)")

# Export to JSON
with open('organization/fixtures/initial_data.json', 'w', encoding='utf-8') as f:
    json.dump(data, f, ensure_ascii=False, indent=2)

print(f"Saved to organization/fixtures/initial_data.json ({len(data)} entries)")
print("NOTE: Requirements and Functions need to be added manually or via expanded script")
</file>

<file path="backend/generate_org_fixtures.py">
#!/usr/bin/env python3
"""
Script para generar initial_data.json completo con requirements y functions
"""
import json

# Base data
data = []

# Departments
departments_data = [
    (1, "Dirección", None),
    (2, "Subdirección Académica", 1),
    (3, "Coordinación de Control de Estudios y Evaluación", 2),
    (4, "Coordinación Administrativa", 1),
    (5, "Coordinación de Pasantías", 2),
    (6, "Coordinación de Informática", 2),
    (7, "Coordinación de Preescolar", 2),
    (8, "Coordinación de Investigación, Extensión y Postgrado", 2),
    (9, "Biblioteca", 2),
]

for pk, name, parent in departments_data:
    data.append({
        "model": "organization.department",
        "pk": pk,
        "fields": {"name": name, "parent": parent}
    })

# JobTitles
jobtitles_data = [
    (1, "Director"), (2, "Subdirector"), (3, "Coordinador"), (4, "Jefe"),
    (5, "Asesor"), (6, "Secretaria"), (7, "Recepcionista"), (8, "Asistente"),
    (9, "Personal de Mantenimiento"), (10, "Personal de Limpieza"), (11, "Auxiliar"),
]

for pk, name in jobtitles_data:
    data.append({
        "model": "organization.jobtitle",
        "pk": pk,
        "fields": {"name": name}
    })

# Positions with objectives
positions_data = [
    # (pk, dept, jobtitle, vacancies, objective)
    (1, 1, 1, 1, "Planificar, organizar, dirigir y controlar todas las actividades que se realizan en la Extensión desde el punto de vista administrativo y académico."),
    (2, 1, 5, 1, "Gestionar la imagen institucional y la comunicación externa del Instituto."),
    (3, 1, 6, 1, "Brindar apoyo administrativo y secretarial de alto nivel a la Dirección."),
    (4, 1, 7, 1, "Atender a los visitantes que acuden a la Extensión a solicitar información."),
    (5, 2, 2, 1, "Prestar ayuda, apoyo y respaldo a la Jefatura de la Extensión."),
    (6, 2, 8, 1, "Asistir a la Subdirección Académica en la gestión operativa."),
    (7, 3, 3, 1, "Planificar, organizar, coordinar y controlar las actividades de Control de Estudios."),
    (8, 3, 8, 1, "Ejecutar los procesos operativos de inscripción y registro."),
    (9, 3, 6, 1, "Atender solicitudes de estudiantes y docentes en taquilla."),
    (10, 4, 3, 1, "Planificar, coordinar y supervisar las actividades administrativas."),
    (11, 4, 8, 1, "Apoyar en la ejecución de procesos administrativos contables."),
    (12, 4, 9, 2, "Garantizar la operatividad de la infraestructura física."),
    (13, 4, 10, 3, "Mantener en óptimas condiciones de higiene todas las áreas."),
    (14, 5, 3, 1, "Planificar y coordinar la ejecución del programa de Pasantías."),
    (15, 5, 8, 1, "Apoyar en la gestión administrativa de la Coordinación de Pasantías."),
    (16, 6, 3, 1, "Administrar las funciones del área de Coordinación de Informática."),
    (17, 6, 8, 1, "Coordinar las actividades académicas en el Laboratorio de Informática."),
    (18, 7, 3, 1, "Coordinar las actividades del área de Educación Preescolar."),
    (19, 7, 8, 1, "Asistir administrativamente a la Coordinación de Preescolar."),
    (20, 8, 3, 1, "Promover el desarrollo de la investigación científica y extensión."),
    (21, 9, 4, 1, "Administrar y supervisar los servicios bibliotecarios."),
    (22, 9, 8, 1, "Atender a estudiantes y personal para suministrar bibliografía."),
    (23, 9, 11, 2, "Apoyar en las labores operativas de la biblioteca."),
]

for pk, dept, jt, vac, obj in positions_data:
    data.append({
        "model": "organization.position",
        "pk": pk,
        "fields": {
            "department": dept,
            "job_title": jt,
            "vacancies": vac,
            "objective": obj
        }
    })

# Requirements y Functions
req_pk = 1
func_pk = 1

# Director (Position 1)
director_reqs = [
    "Profesional Universitario.",
    "Cinco años de experiencia en cargos similares.",
    "Ser miembro activo del personal ordinario de un Instituto venezolano.",
]
for req in director_reqs:
    data.append({
        "model": "organization.positionrequirement",
        "pk": req_pk,
        "fields": {"position": 1, "description": req}
    })
    req_pk += 1

director_funcs = [
    "Planificar, Dirigir, Coordinar y Supervisar las actividades académicas y administrativas.",
    "Formular recomendaciones ante la Directiva Nacional.",
    "Programar las necesidades de Recursos Humanos, Físicos y Materiales.",
    "Cumplir y hacer cumplir todo lo concerniente al funcionamiento óptimo de la sede.",
    "Convocar y Presidir al Consejo Directivo de la extensión.",
    "Presentar ante la Dirección Nacional un informe semestral.",
    "Imponer las sanciones correspondientes al personal.",
    "Velar por el cumplimiento de las disposiciones de la Dirección Nacional.",
    "Velar por el orden y la disciplina dentro del Instituto.",
    "Estudiar y Recomendar medidas para mejorar el funcionamiento integral.",
    "Controlar las actividades de docencia y administrativas.",
    "Dirigir la reunión de profesores al inicio de cada periodo académico.",
    "Cualquier otra actividad asignada por la Dirección.",
]
for i, func in enumerate(director_funcs, 1):
    data.append({
        "model": "organization.positionfunction",
        "pk": func_pk,
        "fields": {"position": 1, "description": func, "order": i}
    })
    func_pk += 1

# Asesor de Prensa (Position 2)
asesor_reqs = [
    "Licenciado en Comunicación Social, Periodismo o Relaciones Públicas.",
    "Mínimo dos (2) años de experiencia en manejo de medios.",
    "Excelente redacción y oratoria.",
]
for req in asesor_reqs:
    data.append({
        "model": "organization.positionrequirement",
        "pk": req_pk,
        "fields": {"position": 2, "description": req}
    })
    req_pk += 1

asesor_funcs = [
    "Asesorar sobre las relaciones Institucionales que debe mantener el Iutirla.",
    "Mantener relaciones con Gremios, Instituciones u Organismos.",
    "Efectuar campañas publicitarias tendientes a captar nuevos estudiantes.",
    "Planificar y Coordinar ruedas de Prensa, Radio y T.V.",
    "Apoyar, Promocionar y Participar activamente en los eventos organizados.",
    "Redactar las notas de prensa que requiere la Institución.",
    "Cualquier otra actividad asignada por el Director.",
]
for i, func in enumerate(asesor_funcs, 1):
    data.append({
        "model": "organization.positionfunction",
        "pk": func_pk,
        "fields": {"position": 2, "description": func, "order": i}
    })
    func_pk += 1

# Continuar con el resto de posiciones...
# Por brevedad, agrego algunas más representativas

# Secretaria de Dirección (Position 3)
sec_dir_reqs = [
    "T.S.U. en Secretariado, Administración o carrera afín.",
    "Mínimo tres (3) años de experiencia en cargos de asistencia a la dirección.",
    "Manejo avanzado de herramientas ofimáticas.",
]
for req in sec_dir_reqs:
    data.append({
        "model": "organization.positionrequirement",
        "pk": req_pk,
        "fields": {"position": 3, "description": req}
    })
    req_pk += 1

sec_dir_funcs = [
    "Asistir junto con el Director a todas las reuniones.",
    "Redactar y elaborar todas las correspondencias de la Dirección.",
    "Atender de manera rápida y eficiente a las personas en general.",
    "Revisar todas las correspondencias recibidas.",
    "Velar por el perfecto orden y mantenimiento de los bienes muebles.",
    "Distribuir a los Departamentos las comunicaciones.",
    "Tipear los informes semestrales.",
    "Atender las llamadas telefónicas.",
    "Llevar la agenda del Director.",
    "Auxiliar a cualquier Departamento que lo necesite.",
    "Cualquier otra asignada por el director.",
]
for i, func in enumerate(sec_dir_funcs, 1):
    data.append({
        "model": "organization.positionfunction",
        "pk": func_pk,
        "fields": {"position": 3, "description": func, "order": i}
    })
    func_pk += 1

# Output JSON
output_path = 'organization/fixtures/initial_data.json'
with open(output_path, 'w', encoding='utf-8') as f:
    json.dump(data, f, ensure_ascii=False, indent=2)

print(f"Generated {len(data)} total entries")
print(f"File saved to: {output_path}")
print(f"- Departments: 9")
print(f"- JobTitles: 11")
print(f"- Positions: 23")
print(f"- Requirements: {req_pk - 1}")
print(f"- Functions: {func_pk - 1}")
</file>

<file path="backend/manage.py">
#!/usr/bin/env python
"""Django's command-line utility for administrative tasks."""
import os
import sys


def main():
    """Run administrative tasks."""
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')
    try:
        from django.core.management import execute_from_command_line
    except ImportError as exc:
        raise ImportError(
            "Couldn't import Django. Are you sure it's installed and "
            "available on your PYTHONPATH environment variable? Did you "
            "forget to activate a virtual environment?"
        ) from exc
    execute_from_command_line(sys.argv)


if __name__ == '__main__':
    main()
</file>

<file path="backend/migrate_manager_data.py">
"""
Data migration to preserve manager_position data before schema change.
This script moves existing single manager to the new many-to-many relationship.
"""
import os
import django

os.environ.setdefault("DJANGO_SETTINGS_MODULE", "config.settings")
django.setup()

from organization.models import Position

def migrate_manager_data():
    """Migrate old manager_position data to new manager_positions M2M field"""
    print("Starting migration of manager_position data...")
    
    # First, let's check if the old field still exists by querying raw
    from django.db import connection
    with connection.cursor() as cursor:
        cursor.execute("PRAGMA table_info(organization_position)")
        columns = [row[1] for row in cursor.fetchall()]
        
        if 'manager_position_id' not in columns:
            print("manager_position_id field not found - migration may have already run")
            return
    
    # Query positions with old manager_position field
    with connection.cursor() as cursor:
        cursor.execute("""
            SELECT id, manager_position_id 
            FROM organization_position 
            WHERE manager_position_id IS NOT NULL
        """)
        positions_with_managers = cursor.fetchall()
    
    print(f"Found {len(positions_with_managers)} positions with managers")
    
    # For each position, add the manager to the new M2M field
    migrated = 0
    for pos_id, manager_id in positions_with_managers:
        try:
            position = Position.objects.get(id=pos_id)
            manager = Position.objects.get(id=manager_id)
            position.manager_positions.add(manager)
            migrated += 1
            print(f"  Migrated: Position {pos_id} → Manager {manager_id}")
        except Position.DoesNotExist:
            print(f"  Skipped: Position or manager not found (pos={pos_id}, manager={manager_id})")
        except Exception as e:
            print(f"  Error migrating position {pos_id}: {e}")
    
    print(f"\nMigration complete: {migrated}/{len(positions_with_managers)} positions migrated")

if __name__ == "__main__":
    migrate_manager_data()
</file>

<file path="backend/test_api.py">
import requests

# CONFIGURACIÓN
BASE_URL = "http://127.0.0.1:8000/api"
LOGIN_URL = f"{BASE_URL}/auth/login/" 
TARGET_URL = f"{BASE_URL}/core/national-ids/"

# CREDENCIALES
USERNAME = "admin" 
PASSWORD = "123" # <--- ¡TU PASSWORD!

# ID de la persona a la que vamos a "torturar" con las pruebas
PERSON_ID = 1 

def test_duplicate_id():
    session = requests.Session()
    print(f"🔵 1. Login con {USERNAME}...")
    
    # --- LOGIN ---
    login_resp = session.post(LOGIN_URL, json={"username": USERNAME, "password": PASSWORD})
    if login_resp.status_code != 200:
        print(f"❌ Error Login: {login_resp.text}")
        return

    token = login_resp.json().get('access') or login_resp.json().get('key')
    headers = {"Authorization": f"Bearer {token}"}
    print("✅ Login exitoso.\n")

    # --- LIMPIEZA PREVIA (Borrar cédulas viejas de esta persona) ---
    print("🧹 Limpiando datos anteriores...")
    existing = requests.get(f"{TARGET_URL}?person={PERSON_ID}", headers=headers).json()
    results = existing.get('results', existing) if isinstance(existing, dict) else existing
    
    for item in results:
        requests.delete(f"{TARGET_URL}{item['id']}/", headers=headers)
    print("✨ Persona limpia (0 documentos).\n")

    # --- INTENTO 1: PRIMERA CÉDULA (Debe funcionar) ---
    print("🔵 2. Creando Cédula #1 (V-111111)...")
    data1 = {
        "person": PERSON_ID,
        "category": "CEDULA",
        "document_type": "V",
        "number": "111111",
        "is_primary": "true"
    }
    # Usamos 'data' para simular multipart/form-data (como el frontend)
    resp1 = requests.post(TARGET_URL, data=data1, headers=headers)
    
    if resp1.status_code == 201:
        print("✅ Éxito: Primera cédula creada.")
    else:
        print(f"❌ Error inesperado en la primera: {resp1.text}")
        return

    # --- INTENTO 2: SEGUNDA CÉDULA (Debe fallar) ---
    print("\n🔵 3. Intentando crear Cédula #2 (V-222222) para la MISMA persona...")
    print("   (Debe fallar porque una persona no puede tener dos documentos categoría 'CEDULA')")
    
    data2 = {
        "person": PERSON_ID,
        "category": "CEDULA", # Misma categoría
        "document_type": "V",
        "number": "222222",   # Diferente número, pero eso no importa
        "is_primary": "false"
    }
    
    resp2 = requests.post(TARGET_URL, data=data2, headers=headers)

    print(f"Status Code: {resp2.status_code}")
    print(f"Respuesta: {resp2.text}")

    # --- VERIFICACIÓN ---
    if resp2.status_code == 400:
        # Buscamos el mensaje de error global (non_field_errors)
        if "ya tiene un documento de esta categoría" in resp2.text:
            print("\n🏆 ¡PRUEBA SUPERADA! El sistema bloqueó la segunda cédula correctamente.")
        else:
            print("\n⚠️ Alerta: Dio error 400 pero con un mensaje diferente al esperado.")
    else:
        print(f"\n❌ FALLÓ. El sistema permitió crearla (Code {resp2.status_code}). ¡Revisa unique_together!")

if __name__ == "__main__":
    test_duplicate_id()
</file>

<file path="frontend2/app/(main)/admin/config/general/[slug]/loading.tsx">
import { SpecificCatalogSkeleton } from "@/components/skeletons/specific-catalog-skeleton";

export default function SpecificCatalogLoading() {
    return <SpecificCatalogSkeleton />;
}
</file>

<file path="frontend2/app/(main)/admin/config/general/loading.tsx">
import { GeneralCatalogSkeleton } from "@/components/skeletons/general-catalog-skeleton";

export default function GeneralConfigLoading() {
    return <GeneralCatalogSkeleton />;
}
</file>

<file path="frontend2/app/(main)/admin/config/talent/[slug]/page.tsx">
"use client";

import { CatalogCRUD, CatalogField } from "@/components/catalogs/catalog-crud";
import { ColumnDef } from "@tanstack/react-table";
import { notFound } from "next/navigation";
import { use } from "react";
import { Briefcase, GraduationCap, BookOpen, Languages, BarChart } from "lucide-react";

interface CatalogConfig {
    title: string;
    apiUrl: string;
    fields: CatalogField[];
    columns: ColumnDef<any>[];
    searchKey?: string;
    icon?: React.ElementType;
}

const simpleNameColumns: ColumnDef<any>[] = [
    {
        accessorKey: "name",
        header: "Nombre",
        cell: ({ row }) => <div className="truncate">{row.getValue("name")}</div>
    },
];

const simpleNameFields: CatalogField[] = [
    {
        name: "name",
        label: "Nombre",
        type: "text",
        required: true,
    },
];

const catalogs: Record<string, CatalogConfig> = {
    "business-functions": {
        title: "Funciones de Negocio",
        icon: Briefcase,
        apiUrl: "/api/talent/business-functions/",
        fields: simpleNameFields,
        columns: simpleNameColumns,
        searchKey: "name",
    },
    "education-levels": {
        title: "Niveles Educativos",
        icon: GraduationCap,
        apiUrl: "/api/talent/education-levels/",
        fields: simpleNameFields,
        columns: simpleNameColumns,
        searchKey: "name",
    },
    "fields-of-study": {
        title: "Campos de Estudio",
        icon: BookOpen,
        apiUrl: "/api/talent/fields-of-study/",
        fields: simpleNameFields,
        columns: simpleNameColumns,
        searchKey: "name",
    },
    languages: {
        title: "Idiomas",
        icon: Languages,
        apiUrl: "/api/talent/languages/",
        fields: simpleNameFields,
        columns: simpleNameColumns,
        searchKey: "name",
    },
    proficiencies: {
        title: "Niveles de Dominio de Idioma",
        icon: BarChart,
        apiUrl: "/api/talent/language-proficiencies/",
        fields: simpleNameFields,
        columns: simpleNameColumns,
        searchKey: "name",
    },
};

export default function TalentDynamicCatalogPage({ params }: { params: Promise<{ slug: string }> }) {
    const { slug } = use(params);
    const config = catalogs[slug];

    if (!config) {
        notFound();
    }

    return (
        <CatalogCRUD
            title={config.title}
            icon={config.icon}
            apiUrl={config.apiUrl}
            fields={config.fields}
            columns={config.columns}
            searchKey={config.searchKey}
        />
    );
}
</file>

<file path="frontend2/app/(main)/admin/config/talent/page.tsx">
"use client";

import { CatalogCard } from "@/components/catalogs/catalog-card";
import { Input } from "@/components/ui/input";
import {
    Briefcase,
    GraduationCap,
    BookOpen,
    Languages,
    BarChart,
    Search,
} from "lucide-react";
import { useState } from "react";

const catalogs = [
    {
        title: "Funciones de Negocio",
        description: "Áreas funcionales y de negocio",
        icon: Briefcase,
        href: "/admin/config/talent/business-functions",
        gradient: "from-blue-900 via-blue-700 to-blue-500",
        iconColor: "text-blue-200/90"
    },
    {
        title: "Niveles Educativos",
        description: "Grados académicos y niveles de instrucción",
        icon: GraduationCap,
        href: "/admin/config/talent/education-levels",
        gradient: "from-emerald-900 via-emerald-700 to-emerald-500",
        iconColor: "text-emerald-200/90"
    },
    {
        title: "Campos de Estudio",
        description: "Áreas de conocimiento y especialidades",
        icon: BookOpen,
        href: "/admin/config/talent/fields-of-study",
        gradient: "from-purple-900 via-purple-700 to-purple-500",
        iconColor: "text-purple-200/90"
    },
    {
        title: "Idiomas",
        description: "Catálogo de idiomas",
        icon: Languages,
        href: "/admin/config/talent/languages",
        gradient: "from-pink-900 via-pink-700 to-pink-500",
        iconColor: "text-pink-200/90"
    },
    {
        title: "Niveles de Dominio",
        description: "Niveles de competencia lingüística (Básico, Intermedio, Avanzado)",
        icon: BarChart,
        href: "/admin/config/talent/proficiencies",
        gradient: "from-orange-900 via-orange-700 to-orange-500",
        iconColor: "text-orange-200/90"
    },
];

export default function TalentConfigPage() {
    const [searchQuery, setSearchQuery] = useState("");

    const normalizeText = (text: string) =>
        text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();

    const filteredCatalogs = catalogs.filter(catalog =>
        normalizeText(catalog.title).includes(normalizeText(searchQuery)) ||
        normalizeText(catalog.description).includes(normalizeText(searchQuery))
    );

    return (
        <div className="space-y-6">
            <div className="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                <div>
                    <h1 className="text-3xl font-bold text-foreground">Catálogos de Talento</h1>
                    <p className="text-muted-foreground">
                        Configuración de catálogos relacionados con habilidades y formación
                    </p>
                </div>
                <div className="relative w-full md:w-72">
                    <Search className="absolute left-2 top-2.5 h-4 w-4 text-muted-foreground" />
                    <Input
                        placeholder="Buscar catálogos..."
                        className="pl-8"
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                    />
                </div>
            </div>

            <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                {filteredCatalogs.map((catalog) => (
                    <CatalogCard
                        key={catalog.href}
                        {...catalog}
                    />
                ))}
            </div>
        </div>
    );
}
</file>

<file path="frontend2/app/(main)/admin/dashboard/loading.tsx">
import { DashboardSkeleton } from "@/components/skeletons/dashboard-skeleton";

export default function DashboardLoading() {
    return <DashboardSkeleton />;
}
</file>

<file path="frontend2/app/(main)/admin/dashboard/page.tsx">
import { DashboardLayout } from "@/components/layout/dashboard-layout";
import {
    Users,
    TrendingUp,
    Calendar,
    DollarSign,
    ArrowUpRight,
    ArrowDownRight
} from "lucide-react";

export default async function DashboardPage() {
    const stats = [
        {
            title: "Total Empleados",
            value: "248",
            change: "+12%",
            isPositive: true,
            icon: <Users className="w-6 h-6" />,
            color: "brand-primary"
        },
        {
            title: "Estudiantes Activos",
            value: "1,842",
            change: "+5%",
            isPositive: true,
            icon: <TrendingUp className="w-6 h-6" />,
            color: "brand-secondary"
        },
        {
            title: "Eventos Este Mes",
            value: "24",
            change: "-3%",
            isPositive: false,
            icon: <Calendar className="w-6 h-6" />,
            color: "brand-tertiary"
        },
        {
            title: "Presupuesto",
            value: "$45.2K",
            change: "+18%",
            isPositive: true,
            icon: <DollarSign className="w-6 h-6" />,
            color: "brand-primary"
        }
    ];

    return (
        <>
            {/* Page Header */}
            <div className="mb-6">
                <h1 className="text-3xl font-bold text-foreground mb-2">
                    Dashboard
                </h1>
                <p className="text-muted-foreground">
                    Bienvenido al sistema de gestión IUTIRLA
                </p>
            </div>

            {/* Stats Grid */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                {stats.map((stat, index) => (
                    <div
                        key={index}
                        className="bg-card border border-border rounded-lg p-6 hover:shadow-lg transition-shadow"
                    >
                        <div className="flex items-center justify-between mb-4">
                            <div className={`w-12 h-12 bg-${stat.color}/10 rounded-lg flex items-center justify-center`}>
                                <div className={`text-${stat.color}`}>
                                    {stat.icon}
                                </div>
                            </div>
                            <div className={`flex items-center gap-1 text-sm font-semibold ${stat.isPositive ? 'text-brand-secondary' : 'text-destructive'
                                }`}>
                                {stat.isPositive ? (
                                    <ArrowUpRight className="w-4 h-4" />
                                ) : (
                                    <ArrowDownRight className="w-4 h-4" />
                                )}
                                {stat.change}
                            </div>
                        </div>
                        <h3 className="text-2xl font-bold text-foreground mb-1">
                            {stat.value}
                        </h3>
                        <p className="text-sm text-muted-foreground">
                            {stat.title}
                        </p>
                    </div>
                ))}
            </div>

            {/* Content Grid */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {/* Recent Activity */}
                <div className="bg-card border border-border rounded-lg p-6">
                    <h2 className="text-xl font-bold text-foreground mb-4">
                        Actividad Reciente
                    </h2>
                    <div className="space-y-4">
                        {[
                            {
                                action: "Nuevo empleado registrado",
                                person: "Juan Pérez",
                                time: "Hace 5 minutos",
                                color: "brand-primary"
                            },
                            {
                                action: "Proyecto completado",
                                person: "María González",
                                time: "Hace 1 hora",
                                color: "brand-secondary"
                            },
                            {
                                action: "Reunión programada",
                                person: "Carlos Rodríguez",
                                time: "Hace 2 horas",
                                color: "brand-tertiary"
                            },
                            {
                                action: "Documento subido",
                                person: "Ana Martínez",
                                time: "Hace 3 horas",
                                color: "brand-primary"
                            }
                        ].map((activity, index) => (
                            <div key={index} className="flex items-start gap-3 pb-4 border-b border-border last:border-b-0 last:pb-0">
                                <div className={`w-2 h-2 bg-${activity.color} rounded-full mt-2 shrink-0`}></div>
                                <div className="flex-1 min-w-0">
                                    <p className="text-sm text-foreground font-medium">
                                        {activity.action}
                                    </p>
                                    <p className="text-sm text-muted-foreground">
                                        {activity.person} • {activity.time}
                                    </p>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>

                {/* Quick Actions */}
                <div className="bg-card border border-border rounded-lg p-6">
                    <h2 className="text-xl font-bold text-foreground mb-4">
                        Acciones Rápidas
                    </h2>
                    <div className="grid grid-cols-2 gap-4">
                        {[
                            { label: "Nuevo Empleado", color: "brand-primary" },
                            { label: "Nuevo Estudiante", color: "brand-secondary" },
                            { label: "Crear Evento", color: "brand-tertiary" },
                            { label: "Generar Reporte", color: "brand-primary" }
                        ].map((action, index) => (
                            <button
                                key={index}
                                className={`bg-${action.color} text-${action.color}-foreground p-4 rounded-lg font-semibold text-sm hover:opacity-90 transition-opacity`}
                            >
                                {action.label}
                            </button>
                        ))}
                    </div>

                    {/* Upcoming Events */}
                    <div className="mt-6">
                        <h3 className="text-lg font-semibold text-foreground mb-3">
                            Próximos Eventos
                        </h3>
                        <div className="space-y-3">
                            {[
                                { title: "Reunión de Departamento", date: "Mañana, 10:00 AM" },
                                { title: "Entrevista de Candidato", date: "Pasado mañana, 2:00 PM" },
                                { title: "Capacitación Personal", date: "Viernes, 9:00 AM" }
                            ].map((event, index) => (
                                <div key={index} className="flex items-center justify-between p-3 bg-muted rounded-lg">
                                    <div>
                                        <p className="text-sm font-medium text-foreground">
                                            {event.title}
                                        </p>
                                        <p className="text-xs text-muted-foreground">
                                            {event.date}
                                        </p>
                                    </div>
                                    <Calendar className="w-4 h-4 text-brand-primary" />
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            </div>

            {/* Additional Info Section */}
            <div className="mt-6 bg-card border border-border rounded-lg p-6">
                <div className="flex items-start gap-4">
                    <div className="w-12 h-12 bg-brand-primary/10 rounded-lg flex items-center justify-center shrink-0">
                        <TrendingUp className="w-6 h-6 text-brand-primary" />
                    </div>
                    <div>
                        <h3 className="text-lg font-semibold text-foreground mb-2">
                            Sistema de Gestión IUTIRLA
                        </h3>
                        <p className="text-sm text-muted-foreground mb-4">
                            Este es un dashboard de ejemplo que muestra la implementación del sidebar y header basados  en AdminLTE 3,
                            adaptados con los colores oficiales de IUTIRLA del Manual de Organización.
                        </p>
                        <div className="flex flex-wrap gap-2">
                            <span className="px-3 py-1 bg-brand-primary/10 text-brand-primary text-xs font-semibold rounded-full">
                                Primary: #F213A4
                            </span>
                            <span className="px-3 py-1 bg-brand-secondary/10 text-brand-secondary text-xs font-semibold rounded-full">
                                Secondary: #15BF0F
                            </span>
                            <span className="px-3 py-1 bg-brand-tertiary/10 text-brand-tertiary text-xs font-semibold rounded-full">
                                Tertiary: #F29F05
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </>
    );
}
</file>

<file path="frontend2/app/(main)/admin/organization/page.tsx">
"use client";

import { CatalogCard } from "@/components/catalogs/catalog-card";
import { Input } from "@/components/ui/input";
import {
    Building2,
    Briefcase,
    Network,
    Search,
} from "lucide-react";
import { useState } from "react";

const catalogs = [
    {
        title: "Departamentos",
        description: "Gestión de departamentos y unidades organizativas",
        icon: Building2,
        href: "/admin/organization/departments",
        gradient: "from-blue-900 via-blue-700 to-blue-500",
        iconColor: "text-blue-200/90"
    },
    {
        title: "Títulos de Cargo",
        description: "Catálogo de títulos y denominaciones de cargo",
        icon: Briefcase,
        href: "/admin/organization/job-titles",
        gradient: "from-emerald-900 via-emerald-700 to-emerald-500",
        iconColor: "text-emerald-200/90"
    },
    {
        title: "Posiciones",
        description: "Gestión de posiciones y estructura organizativa",
        icon: Network,
        href: "/admin/organization/positions",
        gradient: "from-purple-900 via-purple-700 to-purple-500",
        iconColor: "text-purple-200/90"
    },
];

export default function OrganizationConfigPage() {
    const [searchQuery, setSearchQuery] = useState("");

    const normalizeText = (text: string) =>
        text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();

    const filteredCatalogs = catalogs.filter(catalog =>
        normalizeText(catalog.title).includes(normalizeText(searchQuery)) ||
        normalizeText(catalog.description).includes(normalizeText(searchQuery))
    );

    return (
        <div className="space-y-6">
            <div className="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                <div>
                    <h1 className="text-3xl font-bold text-foreground">Organización</h1>
                    <p className="text-muted-foreground">
                        Gestión de la estructura organizativa
                    </p>
                </div>
                <div className="relative w-full md:w-72">
                    <Search className="absolute left-2 top-2.5 h-4 w-4 text-muted-foreground" />
                    <Input
                        placeholder="Buscar catálogos..."
                        className="pl-8"
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                    />
                </div>
            </div>

            <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                {filteredCatalogs.map((catalog) => (
                    <CatalogCard
                        key={catalog.href}
                        {...catalog}
                    />
                ))}
            </div>
        </div>
    );
}
</file>

<file path="frontend2/app/(main)/admin/personnel/employees/[id]/page.tsx">
"use client";

import { useState, use, useEffect } from "react";
import useSWR, { mutate } from "swr";
import { useRouter, usePathname } from "next/navigation";
import { ArrowLeft, User, Contact, FileText, Users, Mail, Phone, MapPin, CreditCard, Globe, Pencil, GraduationCap, Link as LinkIcon, Briefcase, Calendar, History, Lock, UserPlus, UserCheck, Ban, UserMinus, AlertTriangle } from "lucide-react";
import { EmploymentForm } from "@/components/personnel/EmploymentForm";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Skeleton } from "@/components/ui/skeleton";
import { Badge } from "@/components/ui/badge";
import apiClient from "@/lib/api-client";
import { useBreadcrumb } from "@/context/breadcrumb-context";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import {
    Dialog,
    DialogContent,
    DialogDescription,
    DialogFooter,
    DialogHeader,
    DialogTitle,
    DialogTrigger,
} from "@/components/ui/dialog";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { toast } from "sonner";

const fetcher = (url: string) => apiClient.get(url).then((res) => res.data);

export default function EmployeeDetailPage({ params }: { params: Promise<{ id: string }> }) {
    const { id } = use(params);
    const router = useRouter();
    const pathname = usePathname();
    const { setLabel } = useBreadcrumb();
    const [isEditing, setIsEditing] = useState(false);
    const { data: employment, error, isLoading } = useSWR(`/api/employment/employments/${id}/`, fetcher);

    useEffect(() => {
        if (employment) {
            const normalizedPath = pathname.endsWith('/') ? pathname.slice(0, -1) : pathname;
            setLabel(normalizedPath, employment.person_full_name);
        }
    }, [employment, pathname, setLabel]);

    if (isLoading) return <EmployeeDetailSkeleton />;
    if (error || !employment) return <EmployeeError router={router} />;

    const getStatusVariant = (status: string) => {
        if (status === "ACT") return "default";
        if (status === "TER") return "destructive";
        return "secondary";
    };

    return (
        <div className="flex flex-col h-full space-y-6 p-8">
            {/* Header */}
            <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 border-b pb-6">
                <div className="flex flex-col sm:flex-row items-center gap-4">
                    <Avatar className="h-16 w-16 border-2 border-primary/10">
                        {/* Assuming person object is nested or we fetch it separately, but serializer gives names. 
                            For now, we use initials if no photo available in this serializer */}
                        <AvatarFallback className="text-xl">
                            {employment.person_full_name.split(' ').map((n: string) => n[0]).join('').substring(0, 2)}
                        </AvatarFallback>
                    </Avatar>
                    <div className="flex flex-col items-center sm:items-start">
                        <h1 className="text-2xl font-bold tracking-tight">{employment.person_full_name}</h1>
                        <div className="flex items-center text-muted-foreground mt-1 gap-2">
                            <Badge variant={getStatusVariant(employment.current_status) as any}>
                                {employment.current_status_display.charAt(0).toUpperCase() + employment.current_status_display.slice(1).toLowerCase()}
                            </Badge>
                            <span className="text-sm">• {employment.role_display}</span>
                        </div>
                    </div>
                </div>
                <div className="flex gap-2 justify-center">
                    {!isEditing && (
                        <Button onClick={() => setIsEditing(true)}>
                            <Pencil className="mr-2 size-4" />
                            Editar
                        </Button>
                    )}
                    <Button variant="outline" onClick={() => isEditing ? setIsEditing(false) : router.back()}>
                        <ArrowLeft className="size-4" />
                        {isEditing ? "Cancelar" : null}
                    </Button>
                </div>
            </div>

            {isEditing ? (
                <EmploymentForm
                    initialData={employment}
                    isEditing={true}
                    employmentId={id}
                    onSuccess={() => {
                        setIsEditing(false);
                        mutate(`/api/employment/employments/${id}/`);
                    }}
                />
            ) : (
                /* Content - Single View (No Tabs) */
                <div className="grid gap-6 md:grid-cols-2">

                    {/* Row 1: User Account (Spans 2 columns) */}
                    <Card className="md:col-span-2">
                        <CardHeader>
                            <div className="flex items-center gap-2">
                                <Lock className="h-5 w-5 text-primary" />
                                <CardTitle className="text-lg">Acceso al Sistema</CardTitle>
                            </div>
                            <CardDescription>Gestión de credenciales.</CardDescription>
                        </CardHeader>
                        <CardContent className="space-y-4">
                            {employment.user_account_details ? (
                                <div className="flex flex-col gap-4">
                                    <div className="flex items-center justify-between p-3 border rounded-lg bg-muted/20">
                                        <div>
                                            <p className="text-xs font-bold text-muted-foreground uppercase tracking-wider">Usuario</p>
                                            <p className="text-lg font-bold">{employment.user_account_details.username}</p>
                                        </div>
                                        <Badge variant="outline" className="text-green-600 border-green-200 bg-green-50 gap-1">
                                            <UserCheck className="h-3 w-3" />
                                            Activo
                                        </Badge>
                                    </div>
                                    <div className="flex flex-col gap-2">
                                        <ResetPasswordDialog
                                            personId={employment.person}
                                            username={employment.user_account_details.username}
                                            trigger={
                                                <Button variant="outline" className="w-full">
                                                    <Pencil className="mr-2 h-4 w-4" />
                                                    Administrar Cuenta
                                                </Button>
                                            }
                                        />
                                        <DeactivateUserDialog
                                            personId={employment.person}
                                            username={employment.user_account_details.username}
                                            onSuccess={() => mutate(`/api/employment/employments/${id}/`)}
                                            trigger={
                                                <Button variant="destructive" className="w-full">
                                                    <Ban className="mr-2 h-4 w-4" />
                                                    Desactivar Cuenta
                                                </Button>
                                            }
                                        />
                                    </div>
                                </div>
                            ) : (
                                <div className="flex flex-col gap-4">
                                    <div className="p-4 border border-dashed rounded-lg text-center text-muted-foreground text-sm">
                                        Este empleado no tiene acceso al sistema.
                                    </div>
                                    <CreateUserDialog
                                        personId={employment.person}
                                        onSuccess={() => mutate(`/api/employment/employments/${id}/`)}
                                        trigger={
                                            <Button className="w-full">
                                                <UserPlus className="mr-2 h-4 w-4" />
                                                Crear Cuenta
                                            </Button>
                                        }
                                    />
                                </div>
                            )}
                        </CardContent>
                    </Card>

                    {/* Row 2, Col 1: Position Info */}
                    <Card>
                        <CardHeader>
                            <CardTitle className="text-lg flex items-center gap-2">
                                <Briefcase className="h-5 w-5 text-primary" />
                                Información del Cargo
                            </CardTitle>
                        </CardHeader>
                        <CardContent className="space-y-4">
                            <InfoRow label="Cargo" value={employment.position_full_name} />
                            <InfoRow label="Departamento" value={employment.department_name} />
                            <InfoRow label="Tipo de Empleo" value={employment.employment_type_display} />

                            {employment.supervisor_info ? (
                                <div className="pt-2 mt-2">
                                    <p className="text-sm font-medium text-muted-foreground mb-1">Supervisor Inmediato</p>
                                    <div className="flex items-center gap-2">
                                        <UserCheck className="h-4 w-4 text-muted-foreground" />

                                        <span className="text-sm font-medium">{employment.supervisor_info.name.charAt(0).toUpperCase() + employment.supervisor_info.name.slice(1).toLowerCase()}</span>
                                        <span className="text-xs text-muted-foreground">({employment.supervisor_info.position})</span>
                                    </div>
                                </div>
                            ) : (
                                <InfoRow label="Supervisor" value="No asignado" />
                            )}
                        </CardContent>
                    </Card>

                    {/* Row 2-3, Col 2: Status History (Spans 2 rows) */}
                    <Card className="md:row-span-2 h-full">
                        <CardHeader>
                            <CardTitle className="text-lg flex items-center gap-2">
                                <History className="h-5 w-5 text-primary" />
                                Historial de Estatus
                            </CardTitle>
                        </CardHeader>
                        <CardContent>
                            <div className="relative border-l border-muted ml-2 space-y-6">
                                {employment.status_logs && employment.status_logs.length > 0 ? (
                                    employment.status_logs.map((log: any, index: number) => (
                                        <div key={log.id} className="ml-4 relative">
                                            <div className={`absolute -left-[21px] top-1 h-3 w-3 rounded-full border-2 border-background ${index === 0 ? 'bg-primary' : 'bg-muted-foreground'}`} />
                                            <div className="flex flex-col">
                                                <span className="font-medium text-sm">{log.status_name}</span>
                                                <span className="text-xs text-muted-foreground">{log.start_date} {log.end_date ? ` - ${log.end_date}` : '(Actual)'}</span>
                                                {log.comments && <p className="text-xs text-muted-foreground mt-1 italic">"{log.comments}"</p>}
                                            </div>
                                        </div>
                                    ))
                                ) : (
                                    <p className="text-sm text-muted-foreground ml-4">No hay historial disponible.</p>
                                )}
                            </div>
                        </CardContent>
                    </Card>

                    {/* Row 3, Col 1: Contract Dates */}
                    <Card>
                        <CardHeader>
                            <CardTitle className="text-lg flex items-center gap-2">
                                <Calendar className="h-5 w-5 text-primary" />
                                Fechas del Contrato
                            </CardTitle>
                        </CardHeader>
                        <CardContent className="space-y-4">
                            <InfoRow label="Fecha de Contratación" value={employment.hire_date} />
                            <InfoRow label="Fecha de Finalización" value={employment.end_date || "Indefinido"} />

                            {!employment.end_date && (
                                <TerminateContractDialog
                                    employmentId={id}
                                    onSuccess={() => mutate(`/api/employment/employments/${id}/`)}
                                    trigger={
                                        <Button variant="destructive" className="w-full mt-2">
                                            <UserMinus className="mr-2 h-4 w-4" />
                                            Finalizar Contrato
                                        </Button>
                                    }
                                />
                            )}
                        </CardContent>
                    </Card>
                </div>
            )}
        </div>
    );
}


function InfoRow({ label, value }: { label: string, value: string | null | undefined }) {
    return (
        <div className="flex justify-between border-b pb-2 last:border-0 last:pb-0">
            <span className="text-sm font-medium text-muted-foreground">{label}</span>
            <span className="text-sm font-medium text-right">{value || "-"}</span>
        </div>
    );
}

function EmployeeDetailSkeleton() {
    return (
        <div className="space-y-6 p-6">
            <div className="flex items-center gap-4">
                <Skeleton className="h-16 w-16 rounded-full" />
                <div className="space-y-2">
                    <Skeleton className="h-8 w-64" />
                    <Skeleton className="h-4 w-48" />
                </div>
            </div>
            <div className="grid gap-6 md:grid-cols-2">
                <Skeleton className="h-[300px] w-full" />
                <Skeleton className="h-[300px] w-full" />
            </div>
        </div>
    );
}


function EmployeeError({ router }: { router: any }) {
    return (
        <div className="flex flex-col items-center justify-center h-full p-8 text-center">
            <h2 className="text-2xl font-bold text-destructive mb-2">Error</h2>
            <p className="text-muted-foreground mb-4">No se pudo cargar la información del empleado.</p>
            <Button onClick={() => router.back()}>Volver</Button>
        </div>
    );
}

function CreateUserDialog({ personId, onSuccess, trigger }: { personId: number, onSuccess: (username: string) => void, trigger: React.ReactNode }) {
    const [open, setOpen] = useState(false);
    const [password, setPassword] = useState("");
    const [isLoading, setIsLoading] = useState(false);

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        setIsLoading(true);
        try {
            const res = await apiClient.post(`/api/core/persons/${personId}/create-user-account/`, { password });
            toast.success(`Usuario creado: ${res.data.username}`);
            onSuccess(res.data.username);
            setOpen(false);
        } catch (error: any) {
            toast.error(error.response?.data?.error || "Error al crear usuario");
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <Dialog open={open} onOpenChange={setOpen}>
            <DialogTrigger asChild>
                {trigger}
            </DialogTrigger>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle>Crear Usuario</DialogTitle>
                    <DialogDescription>
                        Ingrese una contraseña para el nuevo usuario. El nombre de usuario se generará automáticamente.
                    </DialogDescription>
                </DialogHeader>
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div className="space-y-2">
                        <Label htmlFor="password">Contraseña</Label>
                        <Input
                            id="password"
                            type="password"
                            value={password}
                            onChange={(e) => setPassword(e.target.value)}
                            required
                        />
                    </div>
                    <DialogFooter>
                        <Button type="submit" disabled={isLoading}>
                            {isLoading ? "Creando..." : "Crear"}
                        </Button>
                    </DialogFooter>
                </form>
            </DialogContent>
        </Dialog>
    );
}

function ResetPasswordDialog({ personId, username, trigger }: { personId: number, username: string, trigger: React.ReactNode }) {
    const [open, setOpen] = useState(false);
    const [password, setPassword] = useState("");
    const [confirmPassword, setConfirmPassword] = useState("");
    const [isLoading, setIsLoading] = useState(false);

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();

        if (password !== confirmPassword) {
            toast.error("Las contraseñas no coinciden");
            return;
        }

        setIsLoading(true);
        try {
            await apiClient.post(`/api/core/persons/${personId}/reset-password/`, { password });
            toast.success("Contraseña actualizada exitosamente");
            setOpen(false);
            setPassword("");
            setConfirmPassword("");
        } catch (error: any) {
            toast.error(error.response?.data?.error || "Error al actualizar contraseña");
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <Dialog open={open} onOpenChange={setOpen}>
            <DialogTrigger asChild>
                {trigger}
            </DialogTrigger>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle>Cambiar Contraseña</DialogTitle>
                    <DialogDescription>
                        Ingrese una nueva contraseña para el usuario <strong>{username}</strong>.
                    </DialogDescription>
                </DialogHeader>
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div className="space-y-2">
                        <Label htmlFor="new-password">Nueva Contraseña</Label>
                        <Input
                            id="new-password"
                            type="password"
                            value={password}
                            onChange={(e) => setPassword(e.target.value)}
                            required
                        />
                    </div>
                    <div className="space-y-2">
                        <Label htmlFor="confirm-password">Confirmar Contraseña</Label>
                        <Input
                            id="confirm-password"
                            type="password"
                            value={confirmPassword}
                            onChange={(e) => setConfirmPassword(e.target.value)}
                            required
                        />
                    </div>
                    <DialogFooter>
                        <Button type="submit" disabled={isLoading}>
                            {isLoading ? "Actualizando..." : "Actualizar"}
                        </Button>
                    </DialogFooter>
                </form>
            </DialogContent>
        </Dialog>
    );
}

function DeactivateUserDialog({ personId, username, onSuccess, trigger }: { personId: number, username: string, onSuccess: () => void, trigger: React.ReactNode }) {
    const [open, setOpen] = useState(false);
    const [isLoading, setIsLoading] = useState(false);

    const handleDeactivate = async () => {
        setIsLoading(true);
        try {
            await apiClient.post(`/api/core/persons/${personId}/deactivate-user/`);
            toast.success(`Usuario ${username} desactivado.`);
            onSuccess();
            setOpen(false);
        } catch (error: any) {
            toast.error(error.response?.data?.error || "Error al desactivar usuario");
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <Dialog open={open} onOpenChange={setOpen}>
            <DialogTrigger asChild>
                {trigger}
            </DialogTrigger>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle className="flex items-center gap-2 text-destructive">
                        <AlertTriangle className="h-5 w-5" />
                        Desactivar Usuario
                    </DialogTitle>
                    <DialogDescription>
                        ¿Está seguro que desea desactivar el usuario <strong>{username}</strong>?
                        El empleado no podrá acceder al sistema, pero su contrato permanecerá activo.
                    </DialogDescription>
                </DialogHeader>
                <DialogFooter className="gap-2 sm:gap-0">
                    <Button variant="outline" onClick={() => setOpen(false)}>Cancelar</Button>
                    <Button variant="destructive" onClick={handleDeactivate} disabled={isLoading}>
                        {isLoading ? "Desactivando..." : "Desactivar Cuenta"}
                    </Button>
                </DialogFooter>
            </DialogContent>
        </Dialog>
    );
}

function TerminateContractDialog({ employmentId, onSuccess, trigger }: { employmentId: string, onSuccess: () => void, trigger: React.ReactNode }) {
    const [open, setOpen] = useState(false);
    const [isLoading, setIsLoading] = useState(false);
    const [endDate, setEndDate] = useState("");
    const [reason, setReason] = useState("");
    const [notes, setNotes] = useState("");
    const [deactivateUser, setDeactivateUser] = useState(true);

    const handleTerminate = async (e: React.FormEvent) => {
        e.preventDefault();
        setIsLoading(true);
        try {
            await apiClient.post(`/api/employment/employments/${employmentId}/terminate/`, {
                end_date: endDate,
                exit_reason: reason,
                exit_notes: notes,
                deactivate_user: deactivateUser
            });
            toast.success("Contrato finalizado exitosamente.");
            onSuccess();
            setOpen(false);
        } catch (error: any) {
            toast.error(error.response?.data?.error || "Error al finalizar contrato");
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <Dialog open={open} onOpenChange={setOpen}>
            <DialogTrigger asChild>
                {trigger}
            </DialogTrigger>
            <DialogContent>
                <DialogHeader>
                    <DialogTitle className="flex items-center gap-2 text-destructive">
                        <UserMinus className="h-5 w-5" />
                        Finalizar Contrato
                    </DialogTitle>
                    <DialogDescription>
                        Esta acción finalizará el contrato actual y registrará la salida del empleado.
                    </DialogDescription>
                </DialogHeader>
                <form onSubmit={handleTerminate} className="space-y-4">
                    <div className="space-y-2">
                        <Label htmlFor="end-date">Fecha de Finalización</Label>
                        <Input
                            id="end-date"
                            type="date"
                            value={endDate}
                            onChange={(e) => setEndDate(e.target.value)}
                            required
                        />
                    </div>
                    <div className="space-y-2">
                        <Label htmlFor="reason">Motivo de Salida</Label>
                        <Input
                            id="reason"
                            value={reason}
                            onChange={(e) => setReason(e.target.value)}
                            placeholder="Ej. Renuncia voluntaria, Despido..."
                            required
                        />
                    </div>
                    <div className="space-y-2">
                        <Label htmlFor="notes">Notas Adicionales</Label>
                        <Input
                            id="notes"
                            value={notes}
                            onChange={(e) => setNotes(e.target.value)}
                            placeholder="Detalles adicionales..."
                        />
                    </div>
                    <div className="flex items-center space-x-2 pt-2">
                        <input
                            type="checkbox"
                            id="deactivate"
                            className="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary"
                            checked={deactivateUser}
                            onChange={(e) => setDeactivateUser(e.target.checked)}
                        />
                        <Label htmlFor="deactivate" className="font-normal">
                            Desactivar usuario del sistema automáticamente
                        </Label>
                    </div>
                    <DialogFooter>
                        <Button variant="outline" type="button" onClick={() => setOpen(false)}>Cancelar</Button>
                        <Button variant="destructive" type="submit" disabled={isLoading}>
                            {isLoading ? "Procesando..." : "Finalizar Contrato"}
                        </Button>
                    </DialogFooter>
                </form>
            </DialogContent>
        </Dialog>
    );
}
</file>

<file path="frontend2/app/(main)/admin/personnel/employees/page.tsx">
"use client";

import { CatalogCRUD, CatalogField } from "@/components/catalogs/catalog-crud";
import { ColumnDef } from "@tanstack/react-table";
import { DropdownMenuItem } from "@/components/ui/dropdown-menu";
import { Eye, Users, Plus } from "lucide-react";
import Link from "next/link";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { cn } from "@/lib/utils";

export default function EmployeesPage() {
    const fields: CatalogField[] = [
        {
            name: "person",
            label: "Persona",
            type: "select",
            required: true,
            optionsUrl: "/api/core/persons/",
            optionLabelKey: "full_name",
            optionValueKey: "id"
        },
        {
            name: "position",
            label: "Posición",
            type: "select",
            required: true,
            optionsUrl: "/api/organization/positions/",
            optionLabelKey: "job_title_name", // Assuming this field exists in Position serializer or adjust
            optionValueKey: "id"
        },
        {
            name: "role",
            label: "Rol",
            type: "select",
            required: true,
            options: [
                { label: "Empleado", value: "EMP" },
                { label: "Contratista", value: "CTR" },
                { label: "Pasante", value: "INT" }
            ]
        },
        {
            name: "employment_type",
            label: "Tipo de Empleo",
            type: "select",
            required: true,
            options: [
                { label: "Permanente", value: "PER" },
                { label: "Temporal", value: "TMP" },
                { label: "Medio Tiempo", value: "PRT" }
            ]
        },
        {
            name: "current_status",
            label: "Estatus",
            type: "select",
            required: true,
            options: [
                { label: "Activo", value: "ACT" },
                { label: "Permiso", value: "LEA" },
                { label: "Suspendido", value: "SUS" },
                { label: "Terminado", value: "TER" }
            ]
        },
        { name: "hire_date", label: "Fecha de Contratación", type: "date", required: true },
        { name: "end_date", label: "Fecha de Finalización", type: "date", required: false },
    ];

    const columns: ColumnDef<any>[] = [
        {
            accessorKey: "person_full_name",
            header: "Empleado",
            cell: ({ row }) => <div className="font-medium">{row.getValue("person_full_name")}</div>
        },
        {
            accessorKey: "person_document",
            header: "Cédula",
            cell: ({ row }) => <div className="truncate">{row.getValue("person_document")}</div>
        },
        {
            accessorKey: "position_full_name",
            header: "Cargo",
            cell: ({ row }) => <div className="truncate max-w-[200px]">{row.getValue("position_full_name")}</div>
        },
        {
            accessorKey: "department_name",
            header: "Departamento",
            cell: ({ row }) => <div className="truncate max-w-[150px]">{row.getValue("department_name")}</div>
        },
        {
            accessorKey: "current_status_display",
            header: "Estatus",
            cell: ({ row }) => {
                const status = row.original.current_status;
                const label = row.getValue("current_status_display") as string;

                let variant = "secondary";
                if (status === "ACT") variant = "default"; // Reverted to default (primary) as requested
                if (status === "TER") variant = "destructive";
                if (status === "LEA" || status === "SUS") variant = "outline";

                return <Badge variant={variant as any}>{label}</Badge>;
            }
        },
        {
            accessorKey: "hire_date",
            header: "Fecha Ingreso",
            cell: ({ row }) => <div className="truncate">{row.getValue("hire_date")}</div>
        },
    ];

    return (
        <div className="h-full flex-1 flex-col space-y-8 p-8 md:flex">
            <CatalogCRUD
                title="Empleados"
                icon={Users}
                apiUrl="/api/employment/employments/"
                fields={fields}
                columns={columns}
                searchKey="person_name" // Backend filter might need adjustment if it doesn't support this directly
                searchOptions={[
                    { label: "Nombre", value: "person__first_name" }, // Adjust based on backend filter
                    { label: "Cargo", value: "position__job_title__name" }
                ]}
                disableCreate={true}
                disableEdit={true}
                customToolbarActions={
                    <Button asChild>
                        <Link href="/admin/personnel/employees/new">
                            <Plus className="mr-2 h-4 w-4" />
                            Nuevo Empleado
                        </Link>
                    </Button>
                }
                extraActions={(item) => (
                    <DropdownMenuItem asChild>
                        <Link href={`/admin/personnel/employees/${item.id}`} className="cursor-pointer w-full flex items-center">
                            <Eye className="mr-2 h-4 w-4" />
                            Ver Detalle
                        </Link>
                    </DropdownMenuItem>
                )}
            />
        </div>
    );
}
</file>

<file path="frontend2/app/(main)/admin/personnel/people/[id]/page.tsx">
"use client";

import { useState, use, useEffect } from "react";
import useSWR, { useSWRConfig } from "swr";
import { useRouter, usePathname } from "next/navigation";
import { ArrowLeft, User, Contact, FileText, Users, Mail, Phone, MapPin, CreditCard, Globe, Pencil, GraduationCap, Link as LinkIcon } from "lucide-react";
import { Badge } from "@/components/ui/badge";
import { Star } from "lucide-react";
import { Button } from "@/components/ui/button";
import { PersonForm } from "@/components/personnel/PersonForm";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Skeleton } from "@/components/ui/skeleton";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { CatalogCRUD, CatalogField } from "@/components/catalogs/catalog-crud";
import { ColumnDef } from "@tanstack/react-table";
import apiClient from "@/lib/api-client";
import { useBreadcrumb } from "@/context/breadcrumb-context";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";

const fetcher = (url: string) => apiClient.get(url).then((res) => res.data);

export default function PersonDetailPage({ params }: { params: Promise<{ id: string }> }) {
    const { id } = use(params);
    const router = useRouter();
    const pathname = usePathname();
    const { setLabel } = useBreadcrumb();
    const { mutate } = useSWRConfig();
    const [isEditing, setIsEditing] = useState(false);
    const { data: person, error, isLoading } = useSWR(`/api/core/persons/${id}/`, fetcher);
    const { data: countries } = useSWR("/api/core/countries/", fetcher);
    const countriesList = countries?.results || (Array.isArray(countries) ? countries : []);
    const venezuelaId = countriesList.find((c: any) => c.iso_2 === "VE")?.id;

    useEffect(() => {
        if (person) {
            const normalizedPath = pathname.endsWith('/') ? pathname.slice(0, -1) : pathname;
            setLabel(normalizedPath, person.full_name);
        }
    }, [person, pathname, setLabel]);

    if (isLoading) return <PersonDetailSkeleton />;
    if (error || !person) return <PersonError router={router} />;

    // --- CONFIGURACIÓN DE CATÁLOGOS ANIDADOS ---

    // 1. Emails
    const emailFields: CatalogField[] = [
        { name: "person", label: "Persona", type: "hidden", defaultValue: id },
        { name: "email_type", label: "Tipo", type: "select", required: true, optionsUrl: "/api/core/email-types/", optionLabelKey: "name", optionValueKey: "id" },
        { name: "email_address", label: "Email", type: "email", required: true },
        { name: "is_primary", label: "Principal", type: "checkbox" },
    ];
    const emailColumns: ColumnDef<any>[] = [
        { accessorKey: "email_type_name", header: "Tipo", cell: ({ row }) => row.getValue("email_type_name") },
        { accessorKey: "email_address", header: "Email", cell: ({ row }) => row.getValue("email_address") },
        {
            accessorKey: "is_primary",
            header: "Principal",
            cell: ({ row }) => row.original.is_primary ? (
                <Badge className="bg-[var(--brand-tertiary)] hover:bg-[var(--brand-tertiary)]/90 text-white gap-1">
                    <Star className="size-3 fill-current" /> Principal
                </Badge>
            ) : (
                <Badge variant="secondary">Secundario</Badge>
            )
        },
    ];

    // 2. Teléfonos
    const phoneFields: CatalogField[] = [
        { name: "person", label: "Persona", type: "hidden", defaultValue: id },
        { name: "phone_type", label: "Tipo", type: "select", required: true, optionsUrl: "/api/core/phone-types/", optionLabelKey: "name", optionValueKey: "id" },
        { name: "carrier_code", label: "Operadora", type: "select", required: true, optionsUrl: "/api/core/phone-carrier-codes/", optionLabelKey: "code", optionValueKey: "id" },
        { name: "subscriber_number", label: "Número", type: "number", required: true },
        { name: "is_primary", label: "Principal", type: "checkbox" },
    ];
    const phoneColumns: ColumnDef<any>[] = [
        { accessorKey: "phone_type_name", header: "Tipo", cell: ({ row }) => row.getValue("phone_type_name") },
        { accessorKey: "full_number", header: "Número", cell: ({ row }) => row.original.full_number },
        {
            accessorKey: "is_primary",
            header: "Principal",
            cell: ({ row }) => row.original.is_primary ? (
                <Badge className="bg-[var(--brand-tertiary)] hover:bg-[var(--brand-tertiary)]/90 text-white gap-1">
                    <Star className="size-3 fill-current" /> Principal
                </Badge>
            ) : (
                <Badge variant="secondary">Secundario</Badge>
            )
        },
    ];



    // 3. Direcciones
    const addressFields: CatalogField[] = [
        { name: "person", label: "Persona", type: "hidden", defaultValue: id },
        { name: "address_type", label: "Tipo", type: "select", required: true, optionsUrl: "/api/core/address-types/", optionLabelKey: "name", optionValueKey: "id" },
        { name: "country", label: "País", type: "hidden", defaultValue: venezuelaId },
        { name: "state", label: "Estado", type: "select", required: true, optionsUrl: "/api/core/states/", optionLabelKey: "name", optionValueKey: "id" },
        { name: "city", label: "Ciudad", type: "text", required: true },
        { name: "street_name_and_number", label: "Calle/Avenida", type: "text", required: true },
    ];
    const addressColumns: ColumnDef<any>[] = [
        { accessorKey: "address_type_name", header: "Tipo", cell: ({ row }) => row.getValue("address_type_name") },
        { accessorKey: "state_name", header: "Estado", cell: ({ row }) => row.getValue("state_name") },
        { accessorKey: "city", header: "Ciudad", cell: ({ row }) => row.getValue("city") },
        { accessorKey: "street_name_and_number", header: "Calle/Avenida", cell: ({ row }) => row.getValue("street_name_and_number") },
    ];

    // 4. Documentos de Identidad
    const docFields: CatalogField[] = [
        { name: "person", label: "Persona", type: "hidden", defaultValue: id },
        {
            name: "category",
            label: "Categoría",
            type: "select",
            required: true,
            options: [
                { label: "Cédula", value: "CEDULA" },
                { label: "RIF", value: "RIF" },
                { label: "Pasaporte", value: "PASSPORT" }
            ]
        },
        {
            name: "document_type",
            label: "Prefijo",
            type: "select",
            required: true,
            options: [
                { label: "V - Venezolano", value: "V" },
                { label: "E - Extranjero", value: "E" },
                { label: "J - Jurídico", value: "J" },
                { label: "G - Gubernamental", value: "G" },
                { label: "P - Pasaporte", value: "P" }
            ]
        },
        { name: "number", label: "Número", type: "text", required: true },
        { name: "is_primary", label: "Principal", type: "checkbox" },
    ];
    const nationalIdColumns: ColumnDef<any>[] = [
        { accessorKey: "category_display", header: "Categoría", cell: ({ row }) => row.getValue("category_display") },
        { accessorKey: "full_document", header: "Documento", cell: ({ row }) => row.original.full_document },
        {
            accessorKey: "is_primary",
            header: "Principal",
            cell: ({ row }) => row.original.is_primary ? (
                <Badge className="bg-[var(--brand-tertiary)] hover:bg-[var(--brand-tertiary)]/90 text-white gap-1">
                    <Star className="size-3 fill-current" /> Principal
                </Badge>
            ) : (
                <Badge variant="secondary">Secundario</Badge>
            )
        },
    ];

    // 4b. Cuentas Bancarias
    const bankFields: CatalogField[] = [
        { name: "person", label: "Persona", type: "hidden", defaultValue: id },
        {
            name: "bank",
            label: "Banco",
            type: "select",
            required: true,
            optionsUrl: "/api/core/banks/",
            optionLabelKey: "display_name",
            optionValueKey: "id",
            onChange: (value, form, options) => {
                const selectedBank = options?.find((opt: any) => opt.id.toString() === value);
                if (selectedBank) {
                    form.setValue("account_number", selectedBank.code);
                }
            }
        },
        { name: "bank_account_type", label: "Tipo de Cuenta", type: "select", required: true, optionsUrl: "/api/core/bank-account-types/", optionLabelKey: "name", optionValueKey: "id" },
        { name: "account_number", label: "Número de Cuenta", type: "text", required: true },
        { name: "is_primary", label: "Principal", type: "checkbox" },
    ];
    const bankColumns: ColumnDef<any>[] = [
        { accessorKey: "bank_name", header: "Banco", cell: ({ row }) => row.getValue("bank_name") },
        { accessorKey: "bank_account_type_name", header: "Tipo", cell: ({ row }) => row.getValue("bank_account_type_name") },
        { accessorKey: "account_number", header: "Número", cell: ({ row }) => row.getValue("account_number") },
        {
            accessorKey: "is_primary",
            header: "Principal",
            cell: ({ row }) => row.original.is_primary ? (
                <Badge className="bg-[var(--brand-tertiary)] hover:bg-[var(--brand-tertiary)]/90 text-white gap-1">
                    <Star className="size-3 fill-current" /> Principal
                </Badge>
            ) : (
                <Badge variant="secondary">Secundario</Badge>
            )
        },
    ];

    // 5. Dependientes
    const dependentFields: CatalogField[] = [
        { name: "person", label: "Persona", type: "hidden", defaultValue: id },
        { name: "first_name", label: "Primer Nombre", type: "text", required: true },
        { name: "paternal_surname", label: "Apellido Paterno", type: "text", required: true },
        { name: "relationship", label: "Parentesco", type: "select", required: true, optionsUrl: "/api/core/relationship-types/", optionLabelKey: "name", optionValueKey: "id" },
        { name: "birthdate", label: "Fecha de Nacimiento", type: "date", required: true },
        { name: "gender", label: "Género", type: "select", required: false, optionsUrl: "/api/core/genders/", optionLabelKey: "name", optionValueKey: "id" },
    ];
    const dependentColumns: ColumnDef<any>[] = [
        { accessorKey: "first_name", header: "Nombre", cell: ({ row }) => `${row.original.first_name} ${row.original.paternal_surname}` },
        { accessorKey: "relationship_name", header: "Parentesco", cell: ({ row }) => row.getValue("relationship_name") },
        { accessorKey: "birthdate", header: "Fecha Nacimiento", cell: ({ row }) => row.getValue("birthdate") },
    ];

    // 6. Contactos de Emergencia
    const emergencyFields: CatalogField[] = [
        { name: "person", label: "Persona", type: "hidden", defaultValue: id },
        { name: "first_name", label: "Primer Nombre", type: "text", required: true },
        { name: "paternal_surname", label: "Apellido Paterno", type: "text", required: true },
        { name: "relationship", label: "Parentesco", type: "select", required: true, optionsUrl: "/api/core/relationship-types/", optionLabelKey: "name", optionValueKey: "id" },
        { name: "phone_carrier_code", label: "Operadora", type: "select", required: true, optionsUrl: "/api/core/phone-carrier-codes/", optionLabelKey: "code", optionValueKey: "id" },
        { name: "phone_number", label: "Teléfono", type: "text", required: true },
        { name: "is_primary", label: "Principal", type: "checkbox" },
    ];
    const emergencyColumns: ColumnDef<any>[] = [
        { accessorKey: "first_name", header: "Nombre", cell: ({ row }) => `${row.original.first_name} ${row.original.paternal_surname}` },
        { accessorKey: "relationship_name", header: "Parentesco", cell: ({ row }) => row.getValue("relationship_name") },
        { accessorKey: "phone_number", header: "Teléfono", cell: ({ row }) => row.original.phone_number }, // Adjust if carrier code needed
    ];

    // 7. Formación Académica (Education)
    const educationFields: CatalogField[] = [
        { name: "person", label: "Persona", type: "hidden", defaultValue: id },
        { name: "level", label: "Nivel", type: "select", required: true, optionsUrl: "/api/talent/education-levels/", optionLabelKey: "name", optionValueKey: "id" },
        { name: "field_of_study", label: "Campo de Estudio", type: "select", required: true, optionsUrl: "/api/talent/fields-of-study/", optionLabelKey: "name", optionValueKey: "id" },
        { name: "school_name", label: "Institución", type: "text", required: true },
        { name: "start_date", label: "Fecha Inicio", type: "date", required: true },
        { name: "end_date", label: "Fecha Fin", type: "date" },
        { name: "is_current", label: "Cursando Actualmente", type: "checkbox" },
    ];
    const educationColumns: ColumnDef<any>[] = [
        { accessorKey: "level_name", header: "Nivel", cell: ({ row }) => row.getValue("level_name") },
        { accessorKey: "field_of_study_name", header: "Campo", cell: ({ row }) => row.getValue("field_of_study_name") },
        { accessorKey: "school_name", header: "Institución", cell: ({ row }) => row.getValue("school_name") },
        { accessorKey: "start_date", header: "Inicio", cell: ({ row }) => row.getValue("start_date") },
    ];

    // 8. Certificaciones
    const certificationFields: CatalogField[] = [
        { name: "person", label: "Persona", type: "hidden", defaultValue: id },
        { name: "name", label: "Nombre", type: "text", required: true },
        { name: "institution", label: "Institución", type: "text", required: true },
        { name: "effective_date", label: "Fecha Emisión", type: "date", required: true },
        { name: "expiration_date", label: "Fecha Expiración", type: "date" },
        { name: "credential_id", label: "ID Credencial", type: "text" },
        { name: "url", label: "URL", type: "text" },
    ];
    const certificationColumns: ColumnDef<any>[] = [
        { accessorKey: "name", header: "Nombre", cell: ({ row }) => row.getValue("name") },
        { accessorKey: "institution", header: "Institución", cell: ({ row }) => row.getValue("institution") },
        { accessorKey: "effective_date", header: "Emisión", cell: ({ row }) => row.getValue("effective_date") },
    ];

    // 9. Idiomas
    const languageFields: CatalogField[] = [
        { name: "person", label: "Persona", type: "hidden", defaultValue: id },
        { name: "language", label: "Idioma", type: "select", required: true, optionsUrl: "/api/talent/languages/", optionLabelKey: "name", optionValueKey: "id" },
        { name: "speaking_proficiency", label: "Habla", type: "select", required: true, optionsUrl: "/api/talent/language-proficiencies/", optionLabelKey: "name", optionValueKey: "id" },
        { name: "reading_proficiency", label: "Lectura", type: "select", required: true, optionsUrl: "/api/talent/language-proficiencies/", optionLabelKey: "name", optionValueKey: "id" },
        { name: "writing_proficiency", label: "Escritura", type: "select", required: true, optionsUrl: "/api/talent/language-proficiencies/", optionLabelKey: "name", optionValueKey: "id" },
    ];
    const languageColumns: ColumnDef<any>[] = [
        { accessorKey: "language_name", header: "Idioma", cell: ({ row }) => row.getValue("language_name") },
        { accessorKey: "speaking_proficiency_name", header: "Habla", cell: ({ row }) => row.getValue("speaking_proficiency_name") },
        { accessorKey: "reading_proficiency_name", header: "Lectura", cell: ({ row }) => row.getValue("reading_proficiency_name") },
        { accessorKey: "writing_proficiency_name", header: "Escritura", cell: ({ row }) => row.getValue("writing_proficiency_name") },
    ];


    return (
        <div className="flex flex-col h-full space-y-6 p-8">
            {/* Header */}
            <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 border-b pb-6">
                <div className="flex flex-col sm:flex-row items-center gap-4">
                    <Avatar className="h-16 w-16 border-2 border-primary/10">
                        <AvatarImage src={person.photo} alt={person.full_name} />
                        <AvatarFallback className="text-xl"><User /></AvatarFallback>
                    </Avatar>
                    <div className="flex flex-col items-center sm:items-start">
                        <h1 className="text-2xl font-bold tracking-tight">{person.full_name}</h1>
                        <div className="flex items-center text-muted-foreground mt-1 gap-4 text-sm">
                            <span className="flex items-center"><FileText className="h-3 w-3 mr-2" /> {person.primary_document || "Sin documento"}</span>
                            <span className="flex items-center"><Mail className="h-3 w-3 mr-2" /> {person.primary_email || "Sin email"}</span>
                        </div>
                    </div>
                </div>
                <div className="flex gap-2 justify-center">
                    {!isEditing && (
                        <Button onClick={() => setIsEditing(true)}>
                            <Pencil className="size-4" />
                            Editar
                        </Button>
                    )}
                    <Button variant="outline" onClick={() => isEditing ? setIsEditing(false) : router.back()}>
                        <ArrowLeft className="size-4" />
                    </Button>
                </div>
            </div>

            {isEditing ? (
                <PersonForm
                    initialData={person}
                    isEditing={true}
                    personId={id}
                    onSuccess={() => {
                        setIsEditing(false);
                        mutate(`/api/core/persons/${id}/`);
                    }}
                />
            ) : (
                <Tabs defaultValue="general" className="flex-1 flex flex-col">
                    <TabsList className="w-full flex flex-col min-[24rem]:grid min-[24rem]:grid-cols-2 md:grid-cols-3 lg:grid-cols-6 h-auto p-1 bg-muted/50 gap-1">
                        <TabsTrigger
                            value="general"
                            className="data-[state=active]:bg-primary data-[state=active]:text-primary-foreground py-3 transition-all duration-300 w-full"
                        >
                            <User className="mr-1 size-4" />
                            <p className="truncate">General</p>
                        </TabsTrigger>
                        <TabsTrigger
                            value="credentials"
                            className="data-[state=active]:bg-primary data-[state=active]:text-primary-foreground py-3 transition-all duration-300 w-full"
                        >
                            <CreditCard className="mr-1 size-4" />
                            <p className="truncate">Credenciales</p>
                        </TabsTrigger>
                        <TabsTrigger
                            value="contact"
                            className="data-[state=active]:bg-primary data-[state=active]:text-primary-foreground py-3 transition-all duration-300 w-full"
                        >
                            <Phone className="mr-1 size-4" />
                            <p className="truncate">Contacto</p>
                        </TabsTrigger>
                        <TabsTrigger
                            value="location"
                            className="data-[state=active]:bg-primary data-[state=active]:text-primary-foreground py-3 transition-all duration-300 w-full"
                        >
                            <MapPin className="mr-1 size-4" />
                            <p className="truncate">Ubicación</p>
                        </TabsTrigger>
                        <TabsTrigger
                            value="links"
                            className="data-[state=active]:bg-primary data-[state=active]:text-primary-foreground py-3 transition-all duration-300 w-full"
                        >
                            <LinkIcon className="mr-1 size-4" />
                            <p className="truncate">Vínculos</p>
                        </TabsTrigger>
                        <TabsTrigger
                            value="talent"
                            className="data-[state=active]:bg-primary data-[state=active]:text-primary-foreground py-3 transition-all duration-300 w-full"
                        >
                            <GraduationCap className="mr-1 size-4" />
                            <p className="truncate">Talento</p>
                        </TabsTrigger>
                    </TabsList >

                    <div className="flex-1 mt-6">
                        {/* --- 1. GENERAL INFO --- */}
                        <TabsContent value="general" className="m-0 space-y-6">
                            <Card>
                                <CardHeader><CardTitle className="text-lg">Información Personal</CardTitle></CardHeader>
                                <CardContent className="grid gap-4 md:grid-cols-2">
                                    <InfoRow label="Primer Nombre" value={person.first_name} />
                                    <InfoRow label="Segundo Nombre" value={person.second_name} />
                                    <InfoRow label="Apellido Paterno" value={person.paternal_surname} />
                                    <InfoRow label="Apellido Materno" value={person.maternal_surname} />
                                    <InfoRow label="Fecha de Nacimiento" value={person.birthdate} />
                                    <InfoRow label="País de Nacimiento" value={person.country_of_birth_name} />
                                    <InfoRow label="Género" value={person.gender_name} />
                                    <InfoRow label="Estado Civil" value={person.marital_status_name} />
                                </CardContent>
                            </Card>
                        </TabsContent>

                        {/* --- 2. CREDENCIALES (Identidad + Bancos) --- */}
                        <TabsContent value="credentials" className="m-0 space-y-8">
                            <div className="space-y-4">
                                <CatalogCRUD
                                    title="Documentos de Identidad"
                                    icon={FileText}
                                    apiUrl={`/api/core/national-ids/?person=${id}`}
                                    fields={docFields}
                                    columns={nationalIdColumns}
                                    disablePagination={true}
                                />
                            </div>
                            <div className="space-y-4">
                                <CatalogCRUD
                                    title="Cuentas Bancarias"
                                    icon={CreditCard}
                                    apiUrl="/api/core/person-bank-accounts/"
                                    fields={bankFields}
                                    columns={bankColumns}
                                    searchKey="account_number"
                                    disablePagination={true}
                                />
                            </div>
                        </TabsContent>

                        {/* --- 3. CONTACTO --- */}
                        <TabsContent value="contact" className="m-0 space-y-8">
                            <div className="grid gap-8 grid-cols-1">
                                <div className="space-y-4">
                                    <CatalogCRUD
                                        title="Correos Electrónicos"
                                        icon={Mail}
                                        apiUrl="/api/core/person-emails/"
                                        fields={emailFields}
                                        columns={emailColumns}
                                        searchKey="email_address"
                                        disablePagination={true}
                                    />
                                </div>
                                <div className="space-y-4">
                                    <CatalogCRUD
                                        title="Teléfonos"
                                        icon={Phone}
                                        apiUrl="/api/core/person-phones/"
                                        fields={phoneFields}
                                        columns={phoneColumns}
                                        searchKey="subscriber_number"
                                        disablePagination={true}
                                    />
                                </div>
                            </div>
                        </TabsContent>

                        {/* --- 4. UBICACIÓN --- */}
                        <TabsContent value="location" className="m-0 space-y-8">
                            <div className="space-y-4">
                                <CatalogCRUD
                                    title="Direcciones"
                                    icon={MapPin}
                                    apiUrl="/api/core/addresses/"
                                    fields={addressFields}
                                    columns={addressColumns}
                                    searchKey="city"
                                    disablePagination={true}
                                />
                            </div>
                        </TabsContent>

                        {/* --- 5. VÍNCULOS --- */}
                        <TabsContent value="links" className="m-0 space-y-8">
                            <div className="space-y-4">
                                <CatalogCRUD
                                    title="Dependientes"
                                    icon={Users}
                                    apiUrl="/api/core/dependents/"
                                    fields={dependentFields}
                                    columns={dependentColumns}
                                    searchKey="first_name"
                                    disablePagination={true}
                                />
                            </div>
                            <div className="space-y-4">
                                <CatalogCRUD
                                    title="Contactos de Emergencia"
                                    icon={Users}
                                    apiUrl="/api/core/emergency-contacts/"
                                    fields={emergencyFields}
                                    columns={emergencyColumns}
                                    searchKey="first_name"
                                    disablePagination={true}
                                />
                            </div>
                        </TabsContent>

                        {/* --- 6. TALENTO --- */}
                        <TabsContent value="talent" className="m-0 space-y-8">
                            <div className="space-y-4">
                                <CatalogCRUD
                                    title="Formación Académica"
                                    icon={GraduationCap}
                                    apiUrl="/api/talent/education/"
                                    fields={educationFields}
                                    columns={educationColumns}
                                    searchKey="school_name"
                                    disablePagination={true}
                                />
                            </div>
                            <div className="space-y-4">
                                <CatalogCRUD
                                    title="Certificaciones y Cursos"
                                    icon={FileText}
                                    apiUrl="/api/talent/certifications/"
                                    fields={certificationFields}
                                    columns={certificationColumns}
                                    searchKey="name"
                                    disablePagination={true}
                                />
                            </div>
                            <div className="space-y-4">
                                <CatalogCRUD
                                    title="Idiomas"
                                    icon={Globe}
                                    apiUrl="/api/talent/person-languages/"
                                    fields={languageFields}
                                    columns={languageColumns}
                                    searchKey="language_name"
                                    disablePagination={true}
                                />
                            </div>
                        </TabsContent>
                    </div>
                </Tabs>
            )}
        </div>
    );
}

function InfoRow({ label, value }: { label: string, value: string | null | undefined }) {
    return (
        <div className="flex justify-between border-b pb-2 last:pb-0">
            <span className="text-sm font-medium text-muted-foreground">{label}</span>
            <span className="text-sm">{value || "-"}</span>
        </div>
    );
}

function PersonDetailSkeleton() {
    return (
        <div className="space-y-6 p-6">
            <div className="flex items-center gap-4">
                <Skeleton className="h-16 w-16 rounded-full" />
                <div className="space-y-2">
                    <Skeleton className="h-8 w-64" />
                    <Skeleton className="h-4 w-48" />
                </div>
            </div>
            <Skeleton className="h-10 w-full" />
            <div className="grid gap-6 md:grid-cols-2">
                <Skeleton className="h-[300px] w-full" />
                <Skeleton className="h-[300px] w-full" />
            </div>
        </div>
    );
}

function PersonError({ router }: { router: any }) {
    return (
        <div className="flex flex-col items-center justify-center h-full p-8 text-center">
            <h2 className="text-2xl font-bold text-destructive mb-2">Error</h2>
            <p className="text-muted-foreground mb-4">No se pudo cargar la información de la persona.</p>
            <Button onClick={() => router.back()}>Volver</Button>
        </div>
    );
}
</file>

<file path="frontend2/app/(main)/admin/personnel/people/new/page.tsx">
"use client";

import { ArrowLeft } from "lucide-react";
import Link from "next/link";
import { Button } from "@/components/ui/button";
import { PersonForm } from "@/components/personnel/PersonForm";

export default function NewPersonPage() {
    return (
        <div className="flex flex-col h-full space-y-6 p-8">
            <div className="flex items-center justify-between border-b pb-6">
                <h1 className="text-2xl font-bold tracking-tight">Nueva Persona</h1>
                <Button variant="outline" asChild>
                    <Link href="/admin/personnel/people">
                        <ArrowLeft className="mr-2 h-4 w-4" />
                        Volver
                    </Link>
                </Button>
            </div>

            <PersonForm />
        </div>
    );
}
</file>

<file path="frontend2/app/(main)/admin/personnel/people/page.tsx">
"use client";

import { CatalogCRUD, CatalogField } from "@/components/catalogs/catalog-crud";
import { ColumnDef } from "@tanstack/react-table";
import { DropdownMenuItem } from "@/components/ui/dropdown-menu";
import { Button } from "@/components/ui/button";
import { Eye, User, Plus, Users } from "lucide-react";
import Link from "next/link";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";

export default function PeoplePage() {
    const fields: CatalogField[] = [
        { name: "first_name", label: "Primer Nombre", type: "text", required: true },
        { name: "second_name", label: "Segundo Nombre", type: "text", required: false },
        { name: "paternal_surname", label: "Apellido Paterno", type: "text", required: true },
        { name: "maternal_surname", label: "Apellido Materno", type: "text", required: false },
        {
            name: "gender",
            label: "Género",
            type: "select",
            required: true,
            optionsUrl: "/api/core/genders/",
            optionLabelKey: "name",
            optionValueKey: "id"
        },
        {
            name: "marital_status",
            label: "Estado Civil",
            type: "select",
            required: false,
            optionsUrl: "/api/core/marital-statuses/",
            optionLabelKey: "name",
            optionValueKey: "id"
        },
        { name: "birthdate", label: "Fecha de Nacimiento", type: "date", required: true },
        {
            name: "cedula_prefix",
            label: "Prefijo Cédula",
            type: "select",
            required: false,
            options: [
                { value: "V", label: "V" },
                { value: "E", label: "E" }
            ]
        },
        { name: "cedula_number", label: "Número Cédula", type: "text", required: false },
        {
            name: "country_of_birth",
            label: "País de Nacimiento",
            type: "select",
            required: false,
            optionsUrl: "/api/core/countries/",
            optionLabelKey: "name",
            optionValueKey: "id"
        },
    ];

    const columns: ColumnDef<any>[] = [
        {
            accessorKey: "photo",
            header: "",
            cell: ({ row }) => (
                <Avatar className="h-9 w-9">
                    <AvatarImage src={row.getValue("photo")} alt={row.original.full_name} />
                    <AvatarFallback><User className="h-4 w-4" /></AvatarFallback>
                </Avatar>
            ),
            enableSorting: false,
            size: 50,
        },
        {
            accessorKey: "full_name",
            header: "Nombre Completo",
            cell: ({ row }) => <div className="font-medium">{row.getValue("full_name")}</div>
        },
        {
            accessorKey: "primary_document",
            header: "Cédula",
            cell: ({ row }) => <div className="truncate">{row.getValue("primary_document")}</div>
        },
        {
            accessorKey: "primary_email",
            header: "Email",
            cell: ({ row }) => <div className="truncate">{row.getValue("primary_email")}</div>
        },
        {
            accessorKey: "primary_phone",
            header: "Teléfono",
            cell: ({ row }) => <div className="truncate">{row.getValue("primary_phone")}</div>
        },
    ];

    return (
        <div className="h-full flex-1 flex-col space-y-8 p-8 md:flex">
            <CatalogCRUD
                title="Personas"
                icon={Users}
                apiUrl="/api/core/persons/"
                fields={fields}
                columns={columns}
                searchKey="search"
                searchOptions={[
                    { label: "Nombre", value: "search" }
                ]}
                disableCreate={true}
                disableEdit={true}
                customToolbarActions={
                    <Button asChild>
                        <Link href="/admin/personnel/people/new">
                            <Plus className="mr-2 h-4 w-4" />
                            Nueva Persona
                        </Link>
                    </Button>
                }
                extraActions={(item) => (
                    <DropdownMenuItem asChild>
                        <Link href={`/admin/personnel/people/${item.id}`} className="cursor-pointer w-full flex items-center">
                            <Eye className="mr-2 h-4 w-4" />
                            Ver Detalle
                        </Link>
                    </DropdownMenuItem>
                )}
            />
        </div>
    );
}
</file>

<file path="frontend2/app/(main)/page.tsx">
export default function HomePage() {
    return (
        <h1>
            Page
        </h1>
    );
}
</file>

<file path="frontend2/app/(test)/datepicker/page.tsx">
import { DatePicker } from "@/components/ui/date-picker"

export default function DatePickerPage() {
    return (
        <div className="flex h-screen w-full items-center justify-center">
            <div className="space-y-4">
                <h1 className="text-2xl font-bold">Date Picker</h1>
                <DatePicker />
                <input type="date" />
            </div>
        </div>
    )
}
</file>

<file path="frontend2/app/(test)/generales/page.tsx">
"use client";

import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import {
    Globe2,
    Map,
    Users,
    HeartHandshake,
    MapPin,
    Phone,
    Cpu,
    Mail,
    Landmark,
    Wallet,
    Share2,
    Search,
    Hash,
} from "lucide-react";
import Link from "next/link";
import { useState } from "react";

const catalogs = [
    {
        title: "Países",
        description: "Gestión de países para direcciones y nacionalidades",
        icon: Globe2,
        href: "/admin/config/general/countries",
        color: "text-blue-500",
        bg: "bg-blue-500/10"
    },
    {
        title: "Estados",
        description: "Gestión de estados y provincias por país",
        icon: Map,
        href: "/admin/config/general/states",
        color: "text-emerald-500",
        bg: "bg-emerald-500/10"
    },
    {
        title: "Géneros",
        description: "Catálogo de géneros e identidades",
        icon: Users,
        href: "/admin/config/general/genders",
        color: "text-purple-500",
        bg: "bg-purple-500/10"
    },
    {
        title: "Estado Civil",
        description: "Tipos de estado civil",
        icon: HeartHandshake,
        href: "/admin/config/general/marital-statuses",
        color: "text-pink-500",
        bg: "bg-pink-500/10"
    },
    {
        title: "Tipos de Dirección",
        description: "Clasificación de direcciones (Casa, Trabajo, etc.)",
        icon: MapPin,
        href: "/admin/config/general/address-types",
        color: "text-orange-500",
        bg: "bg-orange-500/10"
    },
    {
        title: "Tipos de Teléfono",
        description: "Clasificación de teléfonos (Móvil, Fijo, etc.)",
        icon: Phone,
        href: "/admin/config/general/phone-types",
        color: "text-cyan-500",
        bg: "bg-cyan-500/10"
    },
    {
        title: "Operadoras",
        description: "Operadoras de telefonía móvil y fija",
        icon: Cpu,
        href: "/admin/config/general/phone-carriers",
        color: "text-indigo-500",
        bg: "bg-indigo-500/10"
    },
    {
        title: "Tipos de Email",
        description: "Clasificación de correos (Personal, Corporativo)",
        icon: Mail,
        href: "/admin/config/general/email-types",
        color: "text-red-500",
        bg: "bg-red-500/10"
    },
    {
        title: "Bancos",
        description: "Instituciones bancarias y financieras",
        icon: Landmark,
        href: "/admin/config/general/banks",
        color: "text-green-500",
        bg: "bg-green-500/10"
    },
    {
        title: "Tipos de Cuenta",
        description: "Tipos de cuenta bancaria (Ahorro, Corriente)",
        icon: Wallet,
        href: "/admin/config/general/bank-account-types",
        color: "text-yellow-500",
        bg: "bg-yellow-500/10"
    },
    {
        title: "Tipos de Relación",
        description: "Parentescos y tipos de relación familiar",
        icon: Share2,
        href: "/admin/config/general/relationship-types",
        color: "text-rose-500",
        bg: "bg-rose-500/10"
    },
    {
        title: "Códigos de Operadora",
        description: "Códigos de área por operadora telefónica",
        icon: Hash,
        href: "/admin/config/general/phone-carrier-codes",
        color: "text-blue-600",
        bg: "bg-blue-600/10"
    }
];

export default function GeneralConfigPage() {
    const [searchQuery, setSearchQuery] = useState("");

    const filteredCatalogs = catalogs.filter(catalog =>
        catalog.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
        catalog.description.toLowerCase().includes(searchQuery.toLowerCase())
    );

    return (
        <div className="space-y-6">
            <div className="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                <div>
                    <h1 className="text-3xl font-bold text-foreground">Catálogos Generales</h1>
                    <p className="text-muted-foreground">
                        Configuración de catálogos base del sistema
                    </p>
                </div>
                <div className="relative w-full md:w-72">
                    <Search className="absolute left-2 top-2.5 h-4 w-4 text-muted-foreground" />
                    <Input
                        placeholder="Buscar catálogos..."
                        className="pl-8"
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                    />
                </div>
            </div>

            <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                {filteredCatalogs.map((catalog) => (
                    <Link key={catalog.href} href={catalog.href}>
                        <Card className="h-full hover:bg-accent/50 transition-colors cursor-pointer border-border">
                            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                                <CardTitle className="text-sm font-medium">
                                    {catalog.title}
                                </CardTitle>
                                <div className={`p-2 rounded-full ${catalog.bg}`}>
                                    <catalog.icon className={`h-4 w-4 ${catalog.color}`} />
                                </div>
                            </CardHeader>
                            <CardContent>
                                <CardDescription className="line-clamp-2">
                                    {catalog.description}
                                </CardDescription>
                            </CardContent>
                        </Card>
                    </Link>
                ))}
            </div>
        </div>
    );
}
</file>

<file path="frontend2/app/(test)/generales-two/page.tsx">
"use client";

import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import {
    Globe2,
    Map,
    Users,
    HeartHandshake,
    MapPin,
    Phone,
    Cpu,
    Mail,
    Landmark,
    Wallet,
    Share2,
    Search,
    Hash,
} from "lucide-react";
import Link from "next/link";
import { useState } from "react";

const catalogs = [
    {
        title: "Países",
        description: "Gestión de países para direcciones y nacionalidades",
        icon: Globe2,
        href: "/admin/config/general/countries",
    },
    {
        title: "Estados",
        description: "Gestión de estados y provincias por país",
        icon: Map,
        href: "/admin/config/general/states",
    },
    {
        title: "Géneros",
        description: "Catálogo de géneros e identidades",
        icon: Users,
        href: "/admin/config/general/genders",
    },
    {
        title: "Estado Civil",
        description: "Tipos de estado civil",
        icon: HeartHandshake,
        href: "/admin/config/general/marital-statuses",
    },
    {
        title: "Tipos de Dirección",
        description: "Clasificación de direcciones (Casa, Trabajo, etc.)",
        icon: MapPin,
        href: "/admin/config/general/address-types",
    },
    {
        title: "Tipos de Teléfono",
        description: "Clasificación de teléfonos (Móvil, Fijo, etc.)",
        icon: Phone,
        href: "/admin/config/general/phone-types",
    },
    {
        title: "Operadoras",
        description: "Operadoras de telefonía móvil y fija",
        icon: Cpu,
        href: "/admin/config/general/phone-carriers",
    },
    {
        title: "Tipos de Email",
        description: "Clasificación de correos (Personal, Corporativo)",
        icon: Mail,
        href: "/admin/config/general/email-types",
    },
    {
        title: "Bancos",
        description: "Instituciones bancarias y financieras",
        icon: Landmark,
        href: "/admin/config/general/banks",
    },
    {
        title: "Tipos de Cuenta",
        description: "Tipos de cuenta bancaria (Ahorro, Corriente)",
        icon: Wallet,
        href: "/admin/config/general/bank-account-types",
    },
    {
        title: "Tipos de Relación",
        description: "Parentescos y tipos de relación familiar",
        icon: Share2,
        href: "/admin/config/general/relationship-types",
    },
    {
        title: "Códigos de Operadora",
        description: "Códigos de área por operadora telefónica",
        icon: Hash,
        href: "/admin/config/general/phone-carrier-codes",
    }
];

export default function GeneralConfigPage() {
    const [searchQuery, setSearchQuery] = useState("");

    const normalizeText = (text: string) =>
        text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();

    const filteredCatalogs = catalogs.filter(catalog =>
        normalizeText(catalog.title).includes(normalizeText(searchQuery)) ||
        normalizeText(catalog.description).includes(normalizeText(searchQuery))
    );

    return (
        <div className="space-y-6">
            <div className="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                <div>
                    <h1 className="text-3xl font-bold text-foreground">Catálogos Generales</h1>
                    <p className="text-muted-foreground">
                        Configuración de catálogos base del sistema
                    </p>
                </div>
                <div className="relative w-full md:w-72">
                    <Search className="absolute left-2 top-2.5 h-4 w-4 text-muted-foreground" />
                    <Input
                        placeholder="Buscar catálogos..."
                        className="pl-8"
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                    />
                </div>
            </div>

            <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                {filteredCatalogs.map((catalog) => (
                    <Link key={catalog.href} href={catalog.href}>
                        <Card className="relative h-[140px] flex flex-col p-5 overflow-hidden bg-primary hover:scale-105 hover:contrast-125 hover:shadow-xl transition-all duration-300 ease-out group cursor-pointer text-primary-foreground border-0">
                            <div className="h-full relative z-10 flex flex-col justify-between gap-1">
                                <CardHeader className="p-0 space-y-0">
                                    <CardTitle className="mr-20 text-xl font-bold leading-tight">
                                        {catalog.title}
                                    </CardTitle>
                                </CardHeader>
                                <CardContent className="p-0">
                                    <CardDescription className="mr-26 text-primary-foreground/90 text-sm font-medium line-clamp-2">
                                        {catalog.description}
                                    </CardDescription>
                                </CardContent>
                            </div>

                            <catalog.icon
                                strokeWidth={1.5}
                                className="absolute -right-6 -bottom-6 size-32 text-chart-1 -rotate-6 group-hover:rotate-6 group-hover:text-white group-hover:scale-110 transition-all duration-300 ease-in-out"
                            />
                        </Card>
                    </Link>
                ))}
            </div>
        </div>
    );
}
</file>

<file path="frontend2/app/(test)/guide/page.tsx">
import React from 'react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Separator } from '@/components/ui/separator';

export default function ColorGuidePage() {
    const colors = [
        {
            name: 'Primary (Magenta)',
            hex: '#F213A4',
            variable: '--brand-primary',
            class: 'bg-brand-primary',
            textClass: 'text-brand-primary',
            description: 'Color principal de la marca. Usado para acciones principales, botones primarios y elementos destacados.',
        },
        {
            name: 'Secondary (Verde)',
            hex: '#15BF0F',
            variable: '--brand-secondary',
            class: 'bg-brand-secondary',
            textClass: 'text-brand-secondary',
            description: 'Color secundario. Usado para acciones de éxito, confirmación o elementos complementarios.',
        },
        {
            name: 'Tertiary (Naranja)',
            hex: '#FEC821',
            variable: '--brand-tertiary',
            class: 'bg-brand-tertiary',
            textClass: 'text-brand-tertiary',
            description: 'Color terciario. Usado para advertencias, destacados especiales o notas importantes.',
        },
        {
            name: 'Black',
            hex: '#000000',
            variable: '--brand-black',
            class: 'bg-brand-black',
            textClass: 'text-brand-black',
            description: 'Negro puro de la marca.',
        },
        {
            name: 'White',
            hex: '#FFFFFF',
            variable: '--brand-white',
            class: 'bg-brand-white',
            textClass: 'text-brand-white',
            description: 'Blanco puro de la marca.',
        },
    ];

    return (
        <div className="container mx-auto py-10 space-y-8">
            <div className="space-y-2">
                <h1 className="text-3xl font-bold tracking-tight">Guía de Colores IUTIRLA</h1>
                <p className="text-muted-foreground">
                    Referencia visual y técnica de los colores oficiales de la institución para el desarrollo frontend.
                </p>
            </div>

            <Separator />

            <section className="space-y-4">
                <h2 className="text-2xl font-semibold">Paleta de Colores Oficial</h2>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {colors.map((color) => (
                        <Card key={color.name} className="overflow-hidden">
                            <div
                                className="h-32 w-full transition-all hover:opacity-90"
                                style={{ backgroundColor: color.hex }}
                            />
                            <CardHeader>
                                <CardTitle className="flex items-center justify-between">
                                    <span>{color.name}</span>
                                </CardTitle>
                                <CardDescription className="font-mono text-xs">
                                    {color.hex}
                                </CardDescription>
                            </CardHeader>
                            <CardContent className="space-y-4">
                                <p className="text-sm text-muted-foreground">
                                    {color.description}
                                </p>
                                <div className="space-y-2 text-xs font-mono bg-muted p-3 rounded-md">
                                    <div className="flex justify-between">
                                        <span className="text-muted-foreground">Variable:</span>
                                        <span>{color.variable}</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="text-muted-foreground">Clase BG:</span>
                                        <span>{color.class}</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="text-muted-foreground">Clase Texto:</span>
                                        <span>{color.textClass}</span>
                                    </div>
                                </div>
                            </CardContent>
                        </Card>
                    ))}
                </div>
            </section>

            <Separator />

            <section className="space-y-6">
                <h2 className="text-2xl font-semibold">Ejemplos de Uso</h2>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <Card>
                        <CardHeader>
                            <CardTitle>Botones y Elementos UI</CardTitle>
                            <CardDescription>Cómo se aplican los colores en componentes comunes.</CardDescription>
                        </CardHeader>
                        <CardContent className="space-y-4">
                            <div className="flex flex-wrap gap-4">
                                <Button className="bg-[#F213A4] hover:bg-[#F213A4]/90">
                                    Primary Button
                                </Button>
                                <Button className="bg-[#15BF0F] hover:bg-[#15BF0F]/90 text-white">
                                    Secondary Button
                                </Button>
                                <Button className="bg-[#FEC821] hover:bg-[#FEC821]/90 text-black">
                                    Tertiary Button
                                </Button>
                            </div>

                            <div className="flex flex-wrap gap-4 mt-4">
                                <Badge className="bg-[#F213A4] hover:bg-[#F213A4]/90">Primary Badge</Badge>
                                <Badge className="bg-[#15BF0F] hover:bg-[#15BF0F]/90">Secondary Badge</Badge>
                                <Badge className="bg-[#FEC821] hover:bg-[#FEC821]/90 text-black">Tertiary Badge</Badge>
                            </div>
                        </CardContent>
                    </Card>

                    <Card>
                        <CardHeader>
                            <CardTitle>Tipografía y Fondos</CardTitle>
                            <CardDescription>Ejemplos de contraste y legibilidad.</CardDescription>
                        </CardHeader>
                        <CardContent className="space-y-4">
                            <div className="p-4 rounded-lg border" style={{ borderColor: '#F213A4' }}>
                                <h3 className="font-bold" style={{ color: '#F213A4' }}>Texto Primario</h3>
                                <p className="text-sm text-muted-foreground">
                                    Este contenedor tiene un borde primario y título primario.
                                </p>
                            </div>

                            <div className="p-4 rounded-lg bg-[#15BF0F]/10 border" style={{ borderColor: '#15BF0F' }}>
                                <h3 className="font-bold" style={{ color: '#15BF0F' }}>Texto Secundario</h3>
                                <p className="text-sm text-muted-foreground">
                                    Fondo con opacidad y texto secundario.
                                </p>
                            </div>

                            <div className="p-4 rounded-lg bg-[#FEC821]/10 border" style={{ borderColor: '#FEC821' }}>
                                <h3 className="font-bold" style={{ color: '#FEC821' }}>Texto Terciario</h3>
                                <p className="text-sm text-muted-foreground">
                                    Fondo con opacidad y texto terciario.
                                </p>
                            </div>
                        </CardContent>
                    </Card>
                </div>
            </section>

            <Separator />

            <section className="space-y-4">
                <h2 className="text-2xl font-semibold">Notas de Implementación</h2>
                <div className="prose dark:prose-invert max-w-none">
                    <ul className="list-disc pl-6 space-y-2">
                        <li>
                            El color <strong>Primary</strong> (#F213A4) se usa automáticamente en componentes shadcn con <code>variant="default"</code>.
                        </li>
                        <li>
                            Los colores <strong>Secondary</strong> (#15BF0F) y <strong>Tertiary</strong> (#FEC821) deben aplicarse explícitamente usando clases de utilidad o estilos en línea.
                        </li>
                        <li>
                            <strong>Importante:</strong> Las variables <code>--secondary</code> y <code>--accent</code> de shadcn son grises neutrales, NO los colores de la marca. Usa <code>--brand-secondary</code> para el verde oficial.
                        </li>
                        <li>
                            Para gráficos (Charts), se deben especificar los colores manualmente usando el array de colores de la marca.
                        </li>
                    </ul>
                </div>
            </section>
        </div>
    );
}
</file>

<file path="frontend2/app/(test)/test/page.tsx">
import { Card, CardHeader, CardContent } from "@/components/ui/card";
import { Globe2 } from "lucide-react";

export default function CountryCard() {
    return (
        <div className="h-screen w-full flex items-center justify-center">
            <Card className="relative w-[395px] h-[140px] flex flex-col justify-between p-5 overflow-hidden bg-linear-to-br from-blue-900 via-blue-700 to-blue-500 hover:scale-105 hover:contrast-125 hover:shadow-xl transition-all duration-300 ease-out group cursor-pointer text-white">

                <CardHeader className="p-0 text-2xl font-bold mb-1">
                    Paises
                </CardHeader>
                <CardContent className="p-0 text-sm font-medium mr-26">
                    Gestión de países para direcciones y funcionalidades
                </CardContent>

                <Globe2
                    strokeWidth={1}
                    className="absolute -right-6 -bottom-6 size-32 text-blue-200/90 group-hover:text-white/80 rotate-0 group-hover:-rotate-6 group-hover:scale-110 transition-all duration-300 ease-in-out" />
            </Card>
        </div>
    );
}
</file>

<file path="frontend2/app/login/page.tsx">
import { LoginForm } from "@/components/login-form"
import { IutirlaLogo } from "@/components/iutirla-logo"

export default function LoginPage() {
  return (
    <div className="grid min-h-svh lg:grid-cols-2">
      <div className="flex flex-col gap-4 p-6 md:p-10 justify-center lg:justify-normal">
        <div className="flex justify-center gap-2 lg:justify-start">
          <IutirlaLogo />
        </div>
        <div className="flex items-center justify-center lg:flex-1">
          <div className="w-full max-w-xs">
            <LoginForm />
          </div>
        </div>
      </div>
      <div className="bg-muted relative hidden lg:block">
        <img
          src="/images/iutirla-porlamar.webp"
          alt="Imagen IUTIRLA porlamar"
          className="absolute inset-0 h-full w-full object-cover dark:brightness-[0.2] dark:grayscale"
        />
      </div>
    </div>
  )
}
</file>

<file path="frontend2/app/globals.css">
@import "tailwindcss";
@import "tw-animate-css";

@custom-variant dark (&:is(.dark *));

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
  --color-sidebar-ring: var(--sidebar-ring);
  --color-sidebar-border: var(--sidebar-border);
  --color-sidebar-accent-foreground: var(--sidebar-accent-foreground);
  --color-sidebar-accent: var(--sidebar-accent);
  --color-sidebar-primary-foreground: var(--sidebar-primary-foreground);
  --color-sidebar-primary: var(--sidebar-primary);
  --color-sidebar-foreground: var(--sidebar-foreground);
  --color-sidebar: var(--sidebar);
  --color-chart-5: var(--chart-5);
  --color-chart-4: var(--chart-4);
  --color-chart-3: var(--chart-3);
  --color-chart-2: var(--chart-2);
  --color-chart-1: var(--chart-1);
  --color-ring: var(--ring);
  --color-input: var(--input);
  --color-border: var(--border);
  --color-destructive: var(--destructive);
  --color-accent-foreground: var(--accent-foreground);
  --color-accent: var(--accent);
  --color-muted-foreground: var(--muted-foreground);
  --color-muted: var(--muted);
  --color-secondary-foreground: var(--secondary-foreground);
  --color-secondary: var(--secondary);
  --color-primary-foreground: var(--primary-foreground);
  --color-primary: var(--primary);
  --color-popover-foreground: var(--popover-foreground);
  --color-popover: var(--popover);
  --color-card-foreground: var(--card-foreground);
  --color-card: var(--card);
  --radius-sm: calc(var(--radius) - 4px);
  --radius-md: calc(var(--radius) - 2px);
  --radius-lg: var(--radius);
  --radius-xl: calc(var(--radius) + 4px);

  --header-height: 64px;
  --sidebar-height: 64px;
  --sidebar-width: 72px;
  --font-montserrat: var(--font-montserrat);

  /* IUTIRLA Brand Colors */
  --color-brand-primary: var(--brand-primary);
  --color-brand-primary-foreground: var(--brand-primary-foreground);
  --color-brand-secondary: var(--brand-secondary);
  --color-brand-secondary-foreground: var(--brand-secondary-foreground);
  --color-brand-tertiary: var(--brand-tertiary);
  --color-brand-tertiary-foreground: var(--brand-tertiary-foreground);
}

/* @media (prefers-color-scheme: dark) {
  :root {
    --background: #0a0a0a;
    --foreground: #ededed;
  }
} */

:root {
  /* IUTIRLA Brand Colors */
  --brand-primary: oklch(0.57 0.27 338);
  --brand-primary-foreground: oklch(1 0 0);
  --brand-secondary: oklch(0.68 0.23 142);
  --brand-secondary-foreground: oklch(0.1 0 0);
  --brand-tertiary: oklch(0.73 0.16 70);
  --brand-tertiary-foreground: oklch(0.1 0 0);

  --radius: 0.65rem;
  --background: oklch(1 0 0);
  --foreground: oklch(0.141 0.005 285.823);
  --card: oklch(1 0 0);
  --card-foreground: oklch(0.141 0.005 285.823);
  --popover: oklch(1 0 0);
  --popover-foreground: oklch(0.141 0.005 285.823);

  /* Primary adapted to Brand Primary */
  --primary: var(--brand-primary);
  --primary-foreground: var(--brand-primary-foreground);

  /* Secondary kept neutral from snippet */
  --secondary: oklch(0.967 0.001 286.375);
  --secondary-foreground: oklch(0.21 0.006 285.885);

  --muted: oklch(0.967 0.001 286.375);
  --muted-foreground: oklch(0.552 0.016 285.938);
  --accent: oklch(0.967 0.001 286.375);
  --accent-foreground: oklch(0.21 0.006 285.885);
  --destructive: oklch(0.577 0.245 27.325);
  --border: oklch(0.92 0.004 286.32);
  --input: oklch(0.92 0.004 286.32);
  --ring: var(--brand-primary);

  /* Charts adapted to Brand Primary (Hue 338) */
  --chart-1: oklch(0.811 0.111 338);
  --chart-2: oklch(0.606 0.25 338);
  --chart-3: oklch(0.57 0.27 338);
  /* Primary */
  --chart-4: oklch(0.491 0.27 338);
  --chart-5: oklch(0.432 0.232 338);

  --sidebar: oklch(0.985 0 0);
  --sidebar-foreground: oklch(0.141 0.005 285.823);
  --sidebar-primary: var(--brand-primary);
  --sidebar-primary-foreground: var(--brand-primary-foreground);
  --sidebar-accent: oklch(0.967 0.001 286.375);
  --sidebar-accent-foreground: oklch(0.21 0.006 285.885);
  --sidebar-border: oklch(0.92 0.004 286.32);
  --sidebar-ring: var(--brand-primary);
}

.dark {
  /* IUTIRLA Brand Colors - Dark Mode */
  --brand-primary: oklch(0.60 0.27 338);
  --brand-secondary: oklch(0.65 0.23 142);
  --brand-tertiary: oklch(0.70 0.16 70);

  --background: oklch(0.141 0.005 285.823);
  --foreground: oklch(0.985 0 0);
  --card: oklch(0.21 0.006 285.885);
  --card-foreground: oklch(0.985 0 0);
  --popover: oklch(0.21 0.006 285.885);
  --popover-foreground: oklch(0.985 0 0);

  /* Primary adapted */
  --primary: var(--brand-primary);
  --primary-foreground: var(--brand-primary-foreground);

  /* Secondary kept neutral */
  --secondary: oklch(0.274 0.006 286.033);
  --secondary-foreground: oklch(0.985 0 0);

  --muted: oklch(0.274 0.006 286.033);
  --muted-foreground: oklch(0.705 0.015 286.067);
  --accent: oklch(0.274 0.006 286.033);
  --accent-foreground: oklch(0.985 0 0);
  --destructive: oklch(0.704 0.191 22.216);
  --border: oklch(1 0 0 / 10%);
  --input: oklch(1 0 0 / 15%);
  --ring: var(--brand-primary);

  /* Charts adapted */
  --chart-1: oklch(0.811 0.111 338);
  --chart-2: oklch(0.606 0.25 338);
  --chart-3: oklch(0.57 0.27 338);
  --chart-4: oklch(0.491 0.27 338);
  --chart-5: oklch(0.432 0.232 338);

  --sidebar: oklch(0.21 0.006 285.885);
  --sidebar-foreground: oklch(0.985 0 0);
  --sidebar-primary: var(--brand-primary);
  --sidebar-primary-foreground: var(--brand-primary-foreground);
  --sidebar-accent: oklch(0.274 0.006 286.033);
  --sidebar-accent-foreground: oklch(0.985 0 0);
  --sidebar-border: oklch(1 0 0 / 10%);
  --sidebar-ring: var(--brand-primary);
}

@layer base {
  * {
    @apply border-border outline-ring/50;
  }

  body {
    @apply bg-background text-foreground;
  }
}
</file>

<file path="frontend2/app/layout.tsx">
import "./globals.css";
import { Providers } from "@/components/providers";

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="es">
      <body>
        <Providers>
          {children}
        </Providers>
      </body>
    </html>
  );
}
</file>

<file path="frontend2/components/catalogs/catalog-card.tsx">
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { LucideIcon } from "lucide-react";
import Link from "next/link";

interface CatalogCardProps {
    title: string;
    description: string;
    icon: LucideIcon;
    href: string;
    gradient: string;
    iconColor: string;
}

export function CatalogCard({
    title,
    description,
    icon: Icon,
    href,
    gradient,
    iconColor,
}: CatalogCardProps) {
    return (
        <Link href={href}>
            <Card className={`relative h-[140px] flex flex-col p-5 overflow-hidden bg-linear-to-br ${gradient} hover:scale-105 hover:contrast-125 hover:shadow-xl transition-all duration-300 ease-out group cursor-pointer text-white border-0`}>
                <div className="h-full relative z-10 flex flex-col justify-between gap-1">
                    <CardHeader className="p-0 space-y-0">
                        <CardTitle className="mr-20 text-xl font-bold leading-tight">
                            {title}
                        </CardTitle>
                    </CardHeader>
                    <CardContent className="p-0">
                        <CardDescription className="mr-26 text-white/90 text-sm font-medium line-clamp-2">
                            {description}
                        </CardDescription>
                    </CardContent>
                </div>

                <Icon
                    strokeWidth={1.5}
                    className={`absolute -right-6 -bottom-6 size-32 ${iconColor} -rotate-6 group-hover:rotate-6 group-hover:text-white group-hover:scale-110 transition-all duration-300 ease-in-out`}
                />
            </Card>
        </Link>
    );
}
</file>

<file path="frontend2/components/layout/dashboard-layout.tsx">
"use client";

import { useState } from "react";
import { Header } from "./header";
import { Sidebar } from "./sidebar";
import { cn } from "@/lib/utils";
import { useAuth } from "@/context/auth-context";
import { DynamicBreadcrumbs } from "./dynamic-breadcrumbs";

interface DashboardLayoutProps {
    children: React.ReactNode;
}

export function DashboardLayout({ children }: DashboardLayoutProps) {
    const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
    const { user } = useAuth();

    const role = user?.is_staff ? "admin" : "employee";

    const toggleSidebar = () => {
        setSidebarCollapsed(!sidebarCollapsed);
    };

    return (
        <div className="min-h-screen bg-background">
            {/* Sidebar */}
            <div className="hidden md:block">
                <Sidebar collapsed={sidebarCollapsed} role={role} />
            </div>

            {/* Header */}
            <Header onToggleSidebar={toggleSidebar} collapsed={sidebarCollapsed} />

            {/* Main Content */}
            <main
                className={cn(
                    "pt-14 transition-all duration-300 ml-0",
                    sidebarCollapsed ? "md:ml-16" : "md:ml-64"
                )}
            >
                <div className="p-6">
                    <DynamicBreadcrumbs />
                    {children}
                </div>
            </main>
        </div>
    );
}
</file>

<file path="frontend2/components/layout/header.tsx">
import { cn } from "@/lib/utils";
import { Menu } from "lucide-react";
import { CommandMenu } from "@/components/command-menu";
import { TaskSheet } from "@/components/task-sheet";
import { NotificationsSheet } from "@/components/notifications-sheet";
import { UserMenu } from "@/components/user-menu";
import { Sheet, SheetContent, SheetTrigger, SheetTitle, SheetDescription } from "@/components/ui/sheet";
import { SidebarContent } from "./sidebar";

interface HeaderProps {
    onToggleSidebar: () => void;
    collapsed: boolean;
}

export function Header({ onToggleSidebar, collapsed }: HeaderProps) {
    return (
        <header
            className={cn(
                "fixed top-0 right-0 h-14 bg-primary text-primary-foreground border-b border-primary-foreground/10 transition-all duration-300 z-30 flex items-center justify-between px-4 shadow-md",
                "left-0", // Mobile default
                collapsed ? "md:left-16" : "md:left-64" // Desktop overrides
            )}
        >
            {/* Left Section */}
            <div className="flex items-center gap-4">
                {/* Mobile Sidebar Trigger */}
                <Sheet>
                    <SheetTrigger asChild>
                        <button
                            className="md:hidden p-2 hover:bg-primary-foreground/10 rounded-lg transition-colors text-primary-foreground"
                            aria-label="Open sidebar"
                        >
                            <Menu className="w-5 h-5" />
                        </button>
                    </SheetTrigger>
                    <SheetContent side="left" className="p-0 w-64 border-r-0">
                        <SheetTitle className="sr-only">Navigation</SheetTitle>
                        <SheetDescription className="sr-only">Mobile navigation menu</SheetDescription>
                        <SidebarContent collapsed={false} />
                    </SheetContent>
                </Sheet>

                {/* Desktop Sidebar Toggle */}
                <button
                    onClick={onToggleSidebar}
                    className="hidden md:block p-2 hover:bg-primary-foreground/10 rounded-lg transition-colors text-primary-foreground"
                    aria-label="Toggle sidebar"
                >
                    <Menu className="w-5 h-5" />
                </button>
            </div>

            {/* Right Section */}
            <div className="ml-auto flex items-center gap-2">
                <div className="flex md:flex-1 gap-2 items-center justify-end">
                    <CommandMenu />
                    <TaskSheet />
                    <NotificationsSheet />
                    <UserMenu />
                </div>
            </div>
        </header>
    );
}
</file>

<file path="frontend2/components/personnel/PersonForm.tsx">
"use client";

import { useState, useEffect } from "react";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import * as z from "zod";
import { format } from "date-fns";
import { useRouter } from "next/navigation";
import { toast } from "sonner";
import useSWR from "swr";
import apiClient from "@/lib/api-client";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { FileUpload } from "@/components/ui/file-upload";
import { Combobox } from "@/components/ui/combobox";
import { DatePicker } from "@/components/ui/date-picker";
import { parseBackendDate } from "@/lib/utils";

const fetcher = (url: string) => apiClient.get(url).then(res => res.data.results || res.data);

const sanitizeCedulaNumber = (value: string): string => {
    let sanitized = value.replace(/[.,]/g, '');
    sanitized = sanitized.replace(/^0+/, '');
    return sanitized || '0';
};

const personSchema = z.object({
    first_name: z.string()
        .min(1, "El primer nombre es requerido")
        .regex(/^[a-zA-ZáéíóúÁÉÍÓÚñÑüÜ\s]+$/, "El nombre solo puede contener letras"),
    second_name: z.string().optional()
        .refine(val => !val || /^[a-zA-ZáéíóúÁÉÍÓÚñÑüÜ\s]+$/.test(val), "El segundo nombre solo puede contener letras"),
    paternal_surname: z.string()
        .min(1, "El apellido paterno es requerido")
        .regex(/^[a-zA-ZáéíóúÁÉÍÓÚñÑüÜ\s]+$/, "El apellido solo puede contener letras"),
    maternal_surname: z.string().optional()
        .refine(val => !val || /^[a-zA-ZáéíóúÁÉÍÓÚñÑüÜ\s]+$/.test(val), "El apellido materno solo puede contener letras"),
    gender: z.string().min(1, "El género es requerido").or(z.literal("")).refine(val => val !== "", "El género es requerido"),
    marital_status: z.string().optional().or(z.literal("")),
    birthdate: z.string()
        .min(1, "La fecha de nacimiento es requerida")
        .refine((val) => {
            const date = new Date(val);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return date <= today;
        }, "La fecha de nacimiento no puede ser futura"),
    country_of_birth: z.string().min(1, "El país de nacimiento es requerido").or(z.literal("")).refine(val => val !== "", "El país de nacimiento es requerido"),
    cedula_prefix: z.string().min(1, "El prefijo es requerido"),
    cedula_number: z.string()
        .min(1, "El número de cédula es requerido")
        .refine((val) => {
            const sanitized = sanitizeCedulaNumber(val);
            return /^\d+$/.test(sanitized);
        }, "El número de cédula solo puede contener dígitos")
        .refine((val) => {
            const sanitized = sanitizeCedulaNumber(val);
            return sanitized.length >= 1 && sanitized.length <= 8;
        }, "El número de cédula debe tener entre 1 y 8 dígitos"),
});

export type PersonFormData = z.infer<typeof personSchema>;

interface PersonFormProps {
    initialData?: any;
    isEditing?: boolean;
    personId?: string;
    onSuccess?: () => void;
}

export function PersonForm({ initialData, isEditing = false, personId, onSuccess }: PersonFormProps) {
    const router = useRouter();
    const [photoFile, setPhotoFile] = useState<File | null>(null);
    const [photoRemoved, setPhotoRemoved] = useState(false);
    const [isSubmitting, setIsSubmitting] = useState(false);

    const { data: genders } = useSWR("/api/core/genders/", fetcher);
    const { data: maritalStatuses } = useSWR("/api/core/marital-statuses/", fetcher);
    const { data: countries } = useSWR("/api/core/countries/", fetcher);

    // Prepare default values
    const defaultValues = {
        first_name: initialData?.first_name || "",
        second_name: initialData?.second_name || "",
        paternal_surname: initialData?.paternal_surname || "",
        maternal_surname: initialData?.maternal_surname || "",
        gender: initialData?.gender?.toString() || "",
        marital_status: initialData?.marital_status?.toString() || "",
        birthdate: initialData?.birthdate || "",
        country_of_birth: initialData?.country_of_birth?.toString() || "",
        cedula_prefix: initialData?.national_ids?.find((n: any) => n.category === 'CEDULA')?.document_type || "",
        cedula_number: initialData?.national_ids?.find((n: any) => n.category === 'CEDULA')?.number || "",
    };

    const { register, handleSubmit, formState: { errors }, setValue, watch, setError } = useForm<PersonFormData>({
        resolver: zodResolver(personSchema),
        defaultValues
    });

    const onSubmit = async (data: PersonFormData) => {
        setIsSubmitting(true);
        try {
            const formData = new FormData();

            // Append basic fields
            Object.entries(data).forEach(([key, value]) => {
                if (key !== 'cedula_prefix' && key !== 'cedula_number') {
                    if (value) formData.append(key, value);
                }
            });

            // Handle Cedula (only for create, or if we decide to allow editing cedula via this form)
            // For edit, we might need special handling if cedula changes are allowed
            if (!isEditing) {
                formData.append('cedula_prefix', data.cedula_prefix);
                formData.append('cedula_number', sanitizeCedulaNumber(data.cedula_number));
            } else {
                // If editing, we might want to update the cedula if it changed?
                // The backend serializer might not handle nested write for national_ids easily on update without custom logic.
                // For now, let's include them and see if backend handles it or if we need a separate endpoint.
                // Given the serializer structure, write_only fields might be ignored on update unless we override update()
                formData.append('cedula_prefix', data.cedula_prefix);
                formData.append('cedula_number', sanitizeCedulaNumber(data.cedula_number));
            }

            // Append photo if selected
            if (photoFile) {
                formData.append('photo', photoFile);
            } else if (photoRemoved && initialData?.photo) {
                formData.append('photo', 'DELETE');
            }

            if (isEditing && personId) {
                await apiClient.patch(`/api/core/persons/${personId}/`, formData, {
                    headers: { 'Content-Type': 'multipart/form-data' },
                });
                toast.success("Persona actualizada exitosamente");
            } else {
                await apiClient.post("/api/core/persons/", formData, {
                    headers: { 'Content-Type': 'multipart/form-data' },
                });
                toast.success("Persona creada exitosamente");
                router.push("/admin/personnel/people");
            }

            if (onSuccess) onSuccess();

        } catch (error: any) {
            console.error("Error submitting form:", error);
            if (error.response?.data) {
                const serverErrors = error.response.data;
                Object.keys(serverErrors).forEach((key) => {
                    if (key in defaultValues) {
                        setError(key as keyof PersonFormData, {
                            type: "server",
                            message: serverErrors[key][0] || serverErrors[key]
                        });
                    } else {
                        toast.error(`Error: ${serverErrors[key]}`);
                    }
                });
            } else {
                toast.error("Ocurrió un error al guardar la persona");
            }
        } finally {
            setIsSubmitting(false);
        }
    };

    return (
        <form onSubmit={handleSubmit(onSubmit)}>
            <Card>
                <CardHeader>
                    <CardTitle>{isEditing ? "Editar Información Personal" : "Información Personal"}</CardTitle>
                    <CardDescription>{isEditing ? "Actualiza los datos de la persona" : "Completa los datos de la persona"}</CardDescription>
                </CardHeader>
                <CardContent>
                    <div className="grid gap-4 md:grid-cols-2">
                        {/* Personal Info Fields */}
                        <div className="space-y-2">
                            <Label htmlFor="first_name" className={errors.first_name ? "text-destructive" : ""}>Primer Nombre *</Label>
                            <Input id="first_name" className={`text-sm ${errors.first_name ? "border-destructive" : ""}`} {...register("first_name")} />
                            {errors.first_name && (
                                <p className="text-sm text-destructive">{errors.first_name.message}</p>
                            )}
                        </div>

                        <div className="space-y-2">
                            <Label htmlFor="second_name" className={errors.second_name ? "text-destructive" : ""}>Segundo Nombre</Label>
                            <Input id="second_name" className={`text-sm ${errors.second_name ? "border-destructive" : ""}`} {...register("second_name")} />
                            {errors.second_name && (
                                <p className="text-sm text-destructive">{errors.second_name.message}</p>
                            )}
                        </div>

                        <div className="space-y-2">
                            <Label htmlFor="paternal_surname" className={errors.paternal_surname ? "text-destructive" : ""}>Apellido Paterno *</Label>
                            <Input id="paternal_surname" className={`text-sm ${errors.paternal_surname ? "border-destructive" : ""}`} {...register("paternal_surname")} />
                            {errors.paternal_surname && (
                                <p className="text-sm text-destructive">{errors.paternal_surname.message}</p>
                            )}
                        </div>

                        <div className="space-y-2">
                            <Label htmlFor="maternal_surname" className={errors.maternal_surname ? "text-destructive" : ""}>Apellido Materno</Label>
                            <Input id="maternal_surname" className={`text-sm ${errors.maternal_surname ? "border-destructive" : ""}`} {...register("maternal_surname")} />
                            {errors.maternal_surname && (
                                <p className="text-sm text-destructive">{errors.maternal_surname.message}</p>
                            )}
                        </div>

                        <div className="space-y-2">
                            <Label htmlFor="gender" className={errors.gender ? "text-destructive" : ""}>Género *</Label>
                            <Combobox
                                options={genders?.map((g: any) => ({ value: g.id.toString(), label: g.name })) || []}
                                value={watch("gender")}
                                onSelect={(value) => setValue("gender", value)}
                                placeholder="Seleccionar género"
                                className={errors.gender ? "border-destructive" : ""}
                            />
                            {errors.gender && (
                                <p className="text-sm text-destructive">{errors.gender.message}</p>
                            )}
                        </div>

                        <div className="space-y-2">
                            <Label htmlFor="marital_status">Estado Civil</Label>
                            <Combobox
                                options={maritalStatuses?.map((ms: any) => ({ value: ms.id.toString(), label: ms.name })) || []}
                                value={watch("marital_status")}
                                onSelect={(value) => setValue("marital_status", value)}
                                placeholder="Seleccionar estado civil"
                            />
                        </div>

                        <div className="space-y-2">
                            <Label>Fecha de Nacimiento *</Label>
                            <DatePicker
                                value={parseBackendDate(watch("birthdate"))}
                                onChange={(date) => {
                                    setValue("birthdate", date ? format(date, "yyyy-MM-dd") : "");
                                }}
                            />
                            {errors.birthdate && (
                                <p className="text-sm text-destructive">{errors.birthdate.message}</p>
                            )}
                        </div>

                        <div className="space-y-2">
                            <Label htmlFor="country_of_birth" className={errors.country_of_birth ? "text-destructive" : ""}>País de Nacimiento *</Label>
                            <Combobox
                                options={(countries?.results || (Array.isArray(countries) ? countries : []))?.map((c: any) => ({ value: c.id.toString(), label: c.name })) || []}
                                value={watch("country_of_birth")}
                                onSelect={(value) => setValue("country_of_birth", value)}
                                placeholder="Seleccionar país"
                                className={errors.country_of_birth ? "border-destructive" : ""}
                            />
                            {errors.country_of_birth && (
                                <p className="text-sm text-destructive">{errors.country_of_birth.message}</p>
                            )}
                        </div>

                        <div className="space-y-2">
                            <Label className={errors.cedula_prefix || errors.cedula_number ? "text-destructive" : ""}>Cédula *</Label>
                            <div className="grid grid-cols-3 gap-2">
                                <div>
                                    <Select
                                        value={watch("cedula_prefix")}
                                        onValueChange={(value) => setValue("cedula_prefix", value)}
                                    >
                                        <SelectTrigger className={`w-full ${errors.cedula_prefix ? "border-destructive" : ""}`}>
                                            <SelectValue placeholder="-" />
                                        </SelectTrigger>
                                        <SelectContent>
                                            {["V", "E"].map((prefix) => (
                                                <SelectItem key={prefix} value={prefix}>
                                                    {prefix}
                                                </SelectItem>
                                            ))}
                                        </SelectContent>
                                    </Select>
                                    {errors.cedula_prefix && (
                                        <p className="text-sm text-destructive mt-1">{errors.cedula_prefix.message}</p>
                                    )}
                                </div>
                                <div className="col-span-2">
                                    <Input
                                        {...register("cedula_number")}
                                        placeholder="12345678"
                                        className={`text-sm ${errors.cedula_number ? "border-destructive" : ""}`}
                                    />
                                    {errors.cedula_number && (
                                        <p className="text-sm text-destructive mt-1">{errors.cedula_number.message}</p>
                                    )}
                                </div>
                            </div>
                        </div>

                        <div className="space-y-2 md:col-span-2">
                            <Label>Foto</Label>
                            <FileUpload
                                onFileSelect={(file) => {
                                    setPhotoFile(file);
                                    if (file) setPhotoRemoved(false);
                                }}
                                accept="image/*"
                                currentFile={photoFile}
                                initialPreviewUrl={initialData?.photo}
                                onRemove={() => setPhotoRemoved(true)}
                            />
                            <p className="text-xs text-muted-foreground">
                                Formatos permitidos: JPG, PNG. Máximo 5MB.
                            </p>
                        </div>
                    </div>

                    <div className="flex justify-end gap-4 mt-6">
                        <Button type="button" variant="outline" onClick={() => router.back()}>
                            Cancelar
                        </Button>
                        <Button type="submit" disabled={isSubmitting}>
                            {isSubmitting ? "Guardando..." : (isEditing ? "Actualizar" : "Crear Persona")}
                        </Button>
                    </div>
                </CardContent>
            </Card>
        </form>
    );
}
</file>

<file path="frontend2/components/skeletons/dashboard-skeleton.tsx">
import { Skeleton } from "@/components/ui/skeleton";
import { cn } from "@/lib/utils";
import { ChevronRight } from "lucide-react";

export function DashboardSkeleton({ showBreadcrumbs = false, className }: { showBreadcrumbs?: boolean, className?: string }) {
    return (
        <div className={cn("flex-1", className)}>
            {/* Breadcrumb Skeleton */}
            {showBreadcrumbs && (
                <div className="flex items-center gap-2 mb-4">
                    <Skeleton className="h-5 w-16" />
                    <ChevronRight className="h-4 w-4 text-muted-foreground" />
                    <Skeleton className="h-5 w-24" />
                </div>
            )}

            {/* Header Skeleton */}
            <div className="space-y-2 mb-6">
                <Skeleton className="h-9 w-64" />
                <Skeleton className="h-6 w-96" />
            </div>
            <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-4 mb-6">
                {Array.from({ length: 4 }).map((_, i) => (
                    <Skeleton key={i} className="h-32 rounded-xl" />
                ))}
            </div>
            <div className="grid gap-6 grid-cols-1 lg:grid-cols-2">
                <Skeleton className="h-[300px] rounded-xl" />
                <Skeleton className="h-[300px] rounded-xl" />
            </div>
        </div>
    );
}
</file>

<file path="frontend2/components/skeletons/general-catalog-skeleton.tsx">
import { Skeleton } from "@/components/ui/skeleton";

import { cn } from "@/lib/utils";
import { ChevronRight } from "lucide-react";

export function GeneralCatalogSkeleton({ showBreadcrumbs = false, className }: { showBreadcrumbs?: boolean, className?: string }) {
    return (
        <div className={cn("", className)}>
            {/* Breadcrumb Skeleton */}
            {showBreadcrumbs && (
                <div className="flex items-center gap-2 mb-4">
                    <Skeleton className="h-5 w-16" />
                    <ChevronRight className="h-4 w-4 text-muted-foreground" />
                    <Skeleton className="h-5 w-24" />
                    <ChevronRight className="h-4 w-4 text-muted-foreground" />
                    <Skeleton className="h-5 w-32" />
                </div>
            )}

            <div className="flex flex-col gap-4 md:flex-row md:items-center md:justify-between mb-6">
                <div className="space-y-2">
                    <Skeleton className="h-9 w-64" />
                    <Skeleton className="h-6 w-96" />
                </div>
                <Skeleton className="h-10 w-full md:w-72" />
            </div>

            <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                {Array.from({ length: 9 }).map((_, i) => (
                    <Skeleton key={i} className="h-[140px] w-full rounded-xl" />
                ))}
            </div>
        </div>
    );
}
</file>

<file path="frontend2/components/skeletons/specific-catalog-skeleton.tsx">
import { Skeleton } from "@/components/ui/skeleton";
import { TableSkeleton } from "@/components/skeletons/table-skeleton";
import { ChevronRight } from "lucide-react";
import { cn } from "@/lib/utils";

export function SpecificCatalogSkeleton({ showBreadcrumbs = false, className }: { showBreadcrumbs?: boolean, className?: string }) {
    return (
        <div className={cn("space-y-6", className)}>
            {/* Breadcrumb Skeleton */}
            {showBreadcrumbs && (
                <div className="flex items-center gap-2 mb-4">
                    <Skeleton className="h-5 w-16" />
                    <ChevronRight className="h-4 w-4 text-muted-foreground" />
                    <Skeleton className="h-5 w-24" />
                    <ChevronRight className="h-4 w-4 text-muted-foreground" />
                    <Skeleton className="h-5 w-32" />
                </div>
            )}

            <div className="flex items-center justify-between">
                <Skeleton className="h-9 w-48" /> {/* Title */}
                <Skeleton className="h-10 w-24" /> {/* New Button */}
            </div>

            <TableSkeleton columnCount={3} rowCount={5} />
        </div>
    )
}
</file>

<file path="frontend2/components/skeletons/table-skeleton.tsx">
import { Skeleton } from "@/components/ui/skeleton";


interface TableSkeletonProps {
    columnCount: number;
    rowCount?: number;
}

export function TableSkeleton({ columnCount, rowCount = 5, withSearch = true }: TableSkeletonProps & { withSearch?: boolean }) {
    return (
        <div className="space-y-4">
            {withSearch && (
                <div className="flex items-center">
                    <Skeleton className="h-10 w-full max-w-sm" />
                </div>
            )}
            <div className="space-y-3">
                {/* Header */}
                <div className="flex items-center justify-between px-4 py-3 border rounded-md bg-muted/10">
                    {Array.from({ length: columnCount }).map((_, i) => (
                        <Skeleton key={i} className="h-4 w-24" />
                    ))}
                </div>

                {/* Rows */}
                <div className="space-y-2">
                    {Array.from({ length: rowCount }).map((_, i) => (
                        <div key={i} className="flex items-center justify-between px-4 py-3 border rounded-md">
                            {Array.from({ length: columnCount }).map((_, j) => (
                                <Skeleton key={j} className="h-4 w-24" />
                            ))}
                        </div>
                    ))}
                </div>
            </div>
        </div>
    );
}
</file>

<file path="frontend2/components/ui/alert-dialog.tsx">
"use client"

import * as React from "react"
import * as AlertDialogPrimitive from "@radix-ui/react-alert-dialog"

import { cn } from "@/lib/utils"
import { buttonVariants } from "@/components/ui/button"

function AlertDialog({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Root>) {
  return <AlertDialogPrimitive.Root data-slot="alert-dialog" {...props} />
}

function AlertDialogTrigger({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Trigger>) {
  return (
    <AlertDialogPrimitive.Trigger data-slot="alert-dialog-trigger" {...props} />
  )
}

function AlertDialogPortal({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Portal>) {
  return (
    <AlertDialogPrimitive.Portal data-slot="alert-dialog-portal" {...props} />
  )
}

function AlertDialogOverlay({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Overlay>) {
  return (
    <AlertDialogPrimitive.Overlay
      data-slot="alert-dialog-overlay"
      className={cn(
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50",
        className
      )}
      {...props}
    />
  )
}

function AlertDialogContent({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Content>) {
  return (
    <AlertDialogPortal>
      <AlertDialogOverlay />
      <AlertDialogPrimitive.Content
        data-slot="alert-dialog-content"
        className={cn(
          "bg-background data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200 sm:max-w-lg",
          className
        )}
        {...props}
      />
    </AlertDialogPortal>
  )
}

function AlertDialogHeader({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-dialog-header"
      className={cn("flex flex-col gap-2 text-center sm:text-left", className)}
      {...props}
    />
  )
}

function AlertDialogFooter({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-dialog-footer"
      className={cn(
        "flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",
        className
      )}
      {...props}
    />
  )
}

function AlertDialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Title>) {
  return (
    <AlertDialogPrimitive.Title
      data-slot="alert-dialog-title"
      className={cn("text-lg font-semibold", className)}
      {...props}
    />
  )
}

function AlertDialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Description>) {
  return (
    <AlertDialogPrimitive.Description
      data-slot="alert-dialog-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

function AlertDialogAction({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Action>) {
  return (
    <AlertDialogPrimitive.Action
      className={cn(buttonVariants(), className)}
      {...props}
    />
  )
}

function AlertDialogCancel({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Cancel>) {
  return (
    <AlertDialogPrimitive.Cancel
      className={cn(buttonVariants({ variant: "outline" }), className)}
      {...props}
    />
  )
}

export {
  AlertDialog,
  AlertDialogPortal,
  AlertDialogOverlay,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogFooter,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogAction,
  AlertDialogCancel,
}
</file>

<file path="frontend2/components/ui/alert.tsx">
import * as React from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const alertVariants = cva(
  "relative w-full rounded-lg border px-4 py-3 text-sm grid has-[>svg]:grid-cols-[calc(var(--spacing)*4)_1fr] grid-cols-[0_1fr] has-[>svg]:gap-x-3 gap-y-0.5 items-start [&>svg]:size-4 [&>svg]:translate-y-0.5 [&>svg]:text-current",
  {
    variants: {
      variant: {
        default: "bg-card text-card-foreground",
        destructive:
          "text-destructive bg-card [&>svg]:text-current *:data-[slot=alert-description]:text-destructive/90",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

function Alert({
  className,
  variant,
  ...props
}: React.ComponentProps<"div"> & VariantProps<typeof alertVariants>) {
  return (
    <div
      data-slot="alert"
      role="alert"
      className={cn(alertVariants({ variant }), className)}
      {...props}
    />
  )
}

function AlertTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-title"
      className={cn(
        "col-start-2 line-clamp-1 min-h-4 font-medium tracking-tight",
        className
      )}
      {...props}
    />
  )
}

function AlertDescription({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-description"
      className={cn(
        "text-muted-foreground col-start-2 grid justify-items-start gap-1 text-sm [&_p]:leading-relaxed",
        className
      )}
      {...props}
    />
  )
}

export { Alert, AlertTitle, AlertDescription }
</file>

<file path="frontend2/components/ui/avatar.tsx">
"use client"

import * as React from "react"
import * as AvatarPrimitive from "@radix-ui/react-avatar"

import { cn } from "@/lib/utils"

function Avatar({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Root>) {
  return (
    <AvatarPrimitive.Root
      data-slot="avatar"
      className={cn(
        "relative flex size-8 shrink-0 overflow-hidden rounded-full",
        className
      )}
      {...props}
    />
  )
}

function AvatarImage({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Image>) {
  return (
    <AvatarPrimitive.Image
      data-slot="avatar-image"
      className={cn("aspect-square size-full", className)}
      {...props}
    />
  )
}

function AvatarFallback({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Fallback>) {
  return (
    <AvatarPrimitive.Fallback
      data-slot="avatar-fallback"
      className={cn(
        "bg-muted flex size-full items-center justify-center rounded-full",
        className
      )}
      {...props}
    />
  )
}

export { Avatar, AvatarImage, AvatarFallback }
</file>

<file path="frontend2/components/ui/badge.tsx">
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const badgeVariants = cva(
  "inline-flex items-center justify-center rounded-full border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90",
        destructive:
          "border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground",
        "brand-secondary":
          "border-transparent bg-brand-secondary text-brand-secondary-foreground [a&]:hover:bg-brand-secondary/90",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

function Badge({
  className,
  variant,
  asChild = false,
  ...props
}: React.ComponentProps<"span"> &
  VariantProps<typeof badgeVariants> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : "span"

  return (
    <Comp
      data-slot="badge"
      className={cn(badgeVariants({ variant }), className)}
      {...props}
    />
  )
}

export { Badge, badgeVariants }
</file>

<file path="frontend2/components/ui/breadcrumb.tsx">
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { ChevronRight, MoreHorizontal } from "lucide-react"

import { cn } from "@/lib/utils"

function Breadcrumb({ ...props }: React.ComponentProps<"nav">) {
  return <nav aria-label="breadcrumb" data-slot="breadcrumb" {...props} />
}

function BreadcrumbList({ className, ...props }: React.ComponentProps<"ol">) {
  return (
    <ol
      data-slot="breadcrumb-list"
      className={cn(
        "text-muted-foreground flex flex-wrap items-center gap-1.5 text-sm break-words sm:gap-2.5",
        className
      )}
      {...props}
    />
  )
}

function BreadcrumbItem({ className, ...props }: React.ComponentProps<"li">) {
  return (
    <li
      data-slot="breadcrumb-item"
      className={cn("inline-flex items-center gap-1.5", className)}
      {...props}
    />
  )
}

function BreadcrumbLink({
  asChild,
  className,
  ...props
}: React.ComponentProps<"a"> & {
  asChild?: boolean
}) {
  const Comp = asChild ? Slot : "a"

  return (
    <Comp
      data-slot="breadcrumb-link"
      className={cn("hover:text-foreground transition-colors", className)}
      {...props}
    />
  )
}

function BreadcrumbPage({ className, ...props }: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="breadcrumb-page"
      role="link"
      aria-disabled="true"
      aria-current="page"
      className={cn("text-foreground font-normal", className)}
      {...props}
    />
  )
}

function BreadcrumbSeparator({
  children,
  className,
  ...props
}: React.ComponentProps<"li">) {
  return (
    <li
      data-slot="breadcrumb-separator"
      role="presentation"
      aria-hidden="true"
      className={cn("[&>svg]:size-3.5", className)}
      {...props}
    >
      {children ?? <ChevronRight />}
    </li>
  )
}

function BreadcrumbEllipsis({
  className,
  ...props
}: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="breadcrumb-ellipsis"
      role="presentation"
      aria-hidden="true"
      className={cn("flex size-9 items-center justify-center", className)}
      {...props}
    >
      <MoreHorizontal className="size-4" />
      <span className="sr-only">More</span>
    </span>
  )
}

export {
  Breadcrumb,
  BreadcrumbList,
  BreadcrumbItem,
  BreadcrumbLink,
  BreadcrumbPage,
  BreadcrumbSeparator,
  BreadcrumbEllipsis,
}
</file>

<file path="frontend2/components/ui/button.tsx">
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
  {
    variants: {
      variant: {
        default: "bg-primary text-primary-foreground hover:bg-primary/90",
        destructive:
          "bg-destructive text-white hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",
        secondary:
          "bg-secondary text-secondary-foreground hover:bg-secondary/80",
        ghost:
          "hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-9 px-4 py-2 has-[>svg]:px-3",
        sm: "h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",
        lg: "h-10 rounded-md px-6 has-[>svg]:px-4",
        icon: "size-9",
        "icon-sm": "size-8",
        "icon-lg": "size-10",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

function Button({
  className,
  variant,
  size,
  asChild = false,
  ...props
}: React.ComponentProps<"button"> &
  VariantProps<typeof buttonVariants> & {
    asChild?: boolean
  }) {
  const Comp = asChild ? Slot : "button"

  return (
    <Comp
      data-slot="button"
      className={cn(buttonVariants({ variant, size, className }))}
      {...props}
    />
  )
}

export { Button, buttonVariants }
</file>

<file path="frontend2/components/ui/calendar.tsx">
"use client"

import * as React from "react"
import {
  ChevronDownIcon,
  ChevronLeftIcon,
  ChevronRightIcon,
} from "lucide-react"
import { DayButton, DayPicker, getDefaultClassNames } from "react-day-picker"

import { cn } from "@/lib/utils"
import { Button, buttonVariants } from "@/components/ui/button"

function Calendar({
  className,
  classNames,
  showOutsideDays = true,
  captionLayout = "label",
  buttonVariant = "ghost",
  formatters,
  components,
  ...props
}: React.ComponentProps<typeof DayPicker> & {
  buttonVariant?: React.ComponentProps<typeof Button>["variant"]
}) {
  const defaultClassNames = getDefaultClassNames()

  return (
    <DayPicker
      showOutsideDays={showOutsideDays}
      className={cn(
        "bg-background group/calendar p-3 [--cell-size:--spacing(8)] [[data-slot=card-content]_&]:bg-transparent [[data-slot=popover-content]_&]:bg-transparent",
        String.raw`rtl:**:[.rdp-button\_next>svg]:rotate-180`,
        String.raw`rtl:**:[.rdp-button\_previous>svg]:rotate-180`,
        className
      )}
      captionLayout={captionLayout}
      formatters={{
        formatMonthDropdown: (date) =>
          date.toLocaleString("default", { month: "short" }),
        ...formatters,
      }}
      classNames={{
        root: cn("w-fit", defaultClassNames.root),
        months: cn(
          "flex gap-4 flex-col md:flex-row relative",
          defaultClassNames.months
        ),
        month: cn("flex flex-col w-full gap-4", defaultClassNames.month),
        nav: cn(
          "flex items-center gap-1 w-full absolute top-0 inset-x-0 justify-between",
          defaultClassNames.nav
        ),
        button_previous: cn(
          buttonVariants({ variant: buttonVariant }),
          "size-(--cell-size) aria-disabled:opacity-50 p-0 select-none",
          defaultClassNames.button_previous
        ),
        button_next: cn(
          buttonVariants({ variant: buttonVariant }),
          "size-(--cell-size) aria-disabled:opacity-50 p-0 select-none",
          defaultClassNames.button_next
        ),
        month_caption: cn(
          "flex items-center justify-center h-(--cell-size) w-full px-(--cell-size)",
          defaultClassNames.month_caption
        ),
        dropdowns: cn(
          "w-full flex items-center text-sm font-medium justify-center h-(--cell-size) gap-1.5",
          defaultClassNames.dropdowns
        ),
        dropdown_root: cn(
          "relative has-focus:border-ring border border-input shadow-xs has-focus:ring-ring/50 has-focus:ring-[3px] rounded-md",
          defaultClassNames.dropdown_root
        ),
        dropdown: cn(
          "absolute bg-popover inset-0 opacity-0",
          defaultClassNames.dropdown
        ),
        caption_label: cn(
          "select-none font-medium",
          captionLayout === "label"
            ? "text-sm"
            : "rounded-md pl-2 pr-1 flex items-center gap-1 text-sm h-8 [&>svg]:text-muted-foreground [&>svg]:size-3.5",
          defaultClassNames.caption_label
        ),
        table: "w-full border-collapse",
        weekdays: cn("flex", defaultClassNames.weekdays),
        weekday: cn(
          "text-muted-foreground rounded-md flex-1 font-normal text-[0.8rem] select-none",
          defaultClassNames.weekday
        ),
        week: cn("flex w-full mt-2", defaultClassNames.week),
        week_number_header: cn(
          "select-none w-(--cell-size)",
          defaultClassNames.week_number_header
        ),
        week_number: cn(
          "text-[0.8rem] select-none text-muted-foreground",
          defaultClassNames.week_number
        ),
        day: cn(
          "relative w-full h-full p-0 text-center [&:last-child[data-selected=true]_button]:rounded-r-md group/day aspect-square select-none",
          props.showWeekNumber
            ? "[&:nth-child(2)[data-selected=true]_button]:rounded-l-md"
            : "[&:first-child[data-selected=true]_button]:rounded-l-md",
          defaultClassNames.day
        ),
        range_start: cn(
          "rounded-l-md bg-accent",
          defaultClassNames.range_start
        ),
        range_middle: cn("rounded-none", defaultClassNames.range_middle),
        range_end: cn("rounded-r-md bg-accent", defaultClassNames.range_end),
        today: cn(
          "bg-accent text-accent-foreground rounded-md data-[selected=true]:rounded-none",
          defaultClassNames.today
        ),
        outside: cn(
          "text-muted-foreground aria-selected:text-muted-foreground",
          defaultClassNames.outside
        ),
        disabled: cn(
          "text-muted-foreground opacity-50",
          defaultClassNames.disabled
        ),
        hidden: cn("invisible", defaultClassNames.hidden),
        ...classNames,
      }}
      components={{
        Root: ({ className, rootRef, ...props }) => {
          return (
            <div
              data-slot="calendar"
              ref={rootRef}
              className={cn(className)}
              {...props}
            />
          )
        },
        Chevron: ({ className, orientation, ...props }) => {
          if (orientation === "left") {
            return (
              <ChevronLeftIcon className={cn("size-4", className)} {...props} />
            )
          }

          if (orientation === "right") {
            return (
              <ChevronRightIcon
                className={cn("size-4", className)}
                {...props}
              />
            )
          }

          return (
            <ChevronDownIcon className={cn("size-4", className)} {...props} />
          )
        },
        DayButton: CalendarDayButton,
        WeekNumber: ({ children, ...props }) => {
          return (
            <td {...props}>
              <div className="flex size-(--cell-size) items-center justify-center text-center">
                {children}
              </div>
            </td>
          )
        },
        ...components,
      }}
      {...props}
    />
  )
}

function CalendarDayButton({
  className,
  day,
  modifiers,
  ...props
}: React.ComponentProps<typeof DayButton>) {
  const defaultClassNames = getDefaultClassNames()

  const ref = React.useRef<HTMLButtonElement>(null)
  React.useEffect(() => {
    if (modifiers.focused) ref.current?.focus()
  }, [modifiers.focused])

  return (
    <Button
      ref={ref}
      variant="ghost"
      size="icon"
      data-day={day.date.toLocaleDateString()}
      data-selected-single={
        modifiers.selected &&
        !modifiers.range_start &&
        !modifiers.range_end &&
        !modifiers.range_middle
      }
      data-range-start={modifiers.range_start}
      data-range-end={modifiers.range_end}
      data-range-middle={modifiers.range_middle}
      className={cn(
        "data-[selected-single=true]:bg-primary data-[selected-single=true]:text-primary-foreground data-[range-middle=true]:bg-accent data-[range-middle=true]:text-accent-foreground data-[range-start=true]:bg-primary data-[range-start=true]:text-primary-foreground data-[range-end=true]:bg-primary data-[range-end=true]:text-primary-foreground group-data-[focused=true]/day:border-ring group-data-[focused=true]/day:ring-ring/50 dark:hover:text-accent-foreground flex aspect-square size-auto w-full min-w-(--cell-size) flex-col gap-1 leading-none font-normal group-data-[focused=true]/day:relative group-data-[focused=true]/day:z-10 group-data-[focused=true]/day:ring-[3px] data-[range-end=true]:rounded-md data-[range-end=true]:rounded-r-md data-[range-middle=true]:rounded-none data-[range-start=true]:rounded-md data-[range-start=true]:rounded-l-md [&>span]:text-xs [&>span]:opacity-70",
        defaultClassNames.day,
        className
      )}
      {...props}
    />
  )
}

export { Calendar, CalendarDayButton }
</file>

<file path="frontend2/components/ui/card.tsx">
import * as React from "react"

import { cn } from "@/lib/utils"

function Card({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card"
      className={cn(
        "bg-card text-card-foreground flex flex-col gap-6 rounded-xl border py-6 shadow-sm",
        className
      )}
      {...props}
    />
  )
}

function CardHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-header"
      className={cn(
        "@container/card-header grid auto-rows-min grid-rows-[auto_auto] items-start gap-2 px-6 has-data-[slot=card-action]:grid-cols-[1fr_auto] [.border-b]:pb-6",
        className
      )}
      {...props}
    />
  )
}

function CardTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-title"
      className={cn("leading-none font-semibold", className)}
      {...props}
    />
  )
}

function CardDescription({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

function CardAction({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-action"
      className={cn(
        "col-start-2 row-span-2 row-start-1 self-start justify-self-end",
        className
      )}
      {...props}
    />
  )
}

function CardContent({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-content"
      className={cn("px-6", className)}
      {...props}
    />
  )
}

function CardFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-footer"
      className={cn("flex items-center px-6 [.border-t]:pt-6", className)}
      {...props}
    />
  )
}

export {
  Card,
  CardHeader,
  CardFooter,
  CardTitle,
  CardAction,
  CardDescription,
  CardContent,
}
</file>

<file path="frontend2/components/ui/combobox.tsx">
"use client"

import * as React from "react"
import { Check, ChevronsUpDown } from "lucide-react"

import { cn } from "@/lib/utils"
import { Button } from "@/components/ui/button"
import {
    Command,
    CommandEmpty,
    CommandGroup,
    CommandInput,
    CommandItem,
    CommandList,
} from "@/components/ui/command"
import {
    Popover,
    PopoverContent,
    PopoverTrigger,
} from "@/components/ui/popover"

export interface ComboboxOption {
    value: string
    label: string
}

interface ComboboxProps {
    options: ComboboxOption[]
    value?: string
    onSelect: (value: string) => void
    placeholder?: string
    emptyText?: string
    className?: string
    disabled?: boolean
}

export function Combobox({
    options,
    value,
    onSelect,
    placeholder = "Seleccionar...",
    emptyText = "No se encontraron resultados.",
    className,
    disabled = false,
}: ComboboxProps) {
    const [open, setOpen] = React.useState(false)

    return (
        <Popover open={open} onOpenChange={setOpen}>
            <PopoverTrigger asChild>
                <Button
                    variant="outline"
                    role="combobox"
                    aria-expanded={open}
                    className={cn("w-full justify-between", className)}
                    disabled={disabled}
                >
                    <span className="truncate">
                        {value
                            ? options.find((option) => option.value === value)?.label
                            : placeholder}
                    </span>
                    <ChevronsUpDown className="ml-2 h-4 w-4 shrink-0 opacity-50" />
                </Button>
            </PopoverTrigger>
            <PopoverContent className="w-[--radix-popover-trigger-width] p-0" align="start">
                <Command>
                    <CommandInput placeholder={`Buscar...`} />
                    <CommandList>
                        <CommandEmpty>{emptyText}</CommandEmpty>
                        <CommandGroup>
                            {options.map((option) => (
                                <CommandItem
                                    key={option.value}
                                    value={option.label} // Use label for search filtering
                                    onSelect={() => {
                                        onSelect(option.value === value ? "" : option.value)
                                        setOpen(false)
                                    }}
                                >
                                    <Check
                                        className={cn(
                                            "mr-2 h-4 w-4",
                                            value === option.value ? "opacity-100" : "opacity-0"
                                        )}
                                    />
                                    {option.label}
                                </CommandItem>
                            ))}
                        </CommandGroup>
                    </CommandList>
                </Command>
            </PopoverContent>
        </Popover>
    )
}
</file>

<file path="frontend2/components/ui/command.tsx">
"use client"

import * as React from "react"
import { Command as CommandPrimitive } from "cmdk"
import { SearchIcon } from "lucide-react"

import { cn } from "@/lib/utils"
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog"

function Command({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive>) {
  return (
    <CommandPrimitive
      data-slot="command"
      className={cn(
        "bg-popover text-popover-foreground flex h-full w-full flex-col overflow-hidden rounded-md",
        className
      )}
      {...props}
    />
  )
}

function CommandDialog({
  title = "Command Palette",
  description = "Search for a command to run...",
  children,
  className,
  showCloseButton = true,
  ...props
}: React.ComponentProps<typeof Dialog> & {
  title?: string
  description?: string
  className?: string
  showCloseButton?: boolean
}) {
  return (
    <Dialog {...props}>
      <DialogHeader className="sr-only">
        <DialogTitle>{title}</DialogTitle>
        <DialogDescription>{description}</DialogDescription>
      </DialogHeader>
      <DialogContent
        className={cn("overflow-hidden p-0", className)}
        showCloseButton={showCloseButton}
      >
        <Command className="[&_[cmdk-group-heading]]:text-muted-foreground **:data-[slot=command-input-wrapper]:h-12 [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group]]:px-2 [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5">
          {children}
        </Command>
      </DialogContent>
    </Dialog>
  )
}

function CommandInput({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Input>) {
  return (
    <div
      data-slot="command-input-wrapper"
      className="flex h-9 items-center gap-2 border-b px-3"
    >
      <SearchIcon className="size-4 shrink-0 opacity-50" />
      <CommandPrimitive.Input
        data-slot="command-input"
        className={cn(
          "placeholder:text-muted-foreground flex h-10 w-full rounded-md bg-transparent py-3 text-sm outline-hidden disabled:cursor-not-allowed disabled:opacity-50",
          className
        )}
        {...props}
      />
    </div>
  )
}

function CommandList({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.List>) {
  return (
    <CommandPrimitive.List
      data-slot="command-list"
      className={cn(
        "max-h-[300px] scroll-py-1 overflow-x-hidden overflow-y-auto",
        className
      )}
      {...props}
    />
  )
}

function CommandEmpty({
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Empty>) {
  return (
    <CommandPrimitive.Empty
      data-slot="command-empty"
      className="py-6 text-center text-sm"
      {...props}
    />
  )
}

function CommandGroup({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Group>) {
  return (
    <CommandPrimitive.Group
      data-slot="command-group"
      className={cn(
        "text-foreground [&_[cmdk-group-heading]]:text-muted-foreground overflow-hidden p-1 [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium",
        className
      )}
      {...props}
    />
  )
}

function CommandSeparator({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Separator>) {
  return (
    <CommandPrimitive.Separator
      data-slot="command-separator"
      className={cn("bg-border -mx-1 h-px", className)}
      {...props}
    />
  )
}

function CommandItem({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Item>) {
  return (
    <CommandPrimitive.Item
      data-slot="command-item"
      className={cn(
        "data-[selected=true]:bg-accent data-[selected=true]:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled=true]:pointer-events-none data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    />
  )
}

function CommandShortcut({
  className,
  ...props
}: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="command-shortcut"
      className={cn(
        "text-muted-foreground ml-auto text-xs tracking-widest",
        className
      )}
      {...props}
    />
  )
}

export {
  Command,
  CommandDialog,
  CommandInput,
  CommandList,
  CommandEmpty,
  CommandGroup,
  CommandItem,
  CommandShortcut,
  CommandSeparator,
}
</file>

<file path="frontend2/components/ui/date-picker.tsx">
"use client"

import * as React from "react"
import { CalendarIcon } from "lucide-react"
import { format } from "date-fns"
import { es } from "date-fns/locale"

import { Button } from "@/components/ui/button"
import { Calendar } from "@/components/ui/calendar"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import {
    Popover,
    PopoverContent,
    PopoverTrigger,
} from "@/components/ui/popover"

function formatDate(date: Date | undefined) {
    if (!date) {
        return ""
    }
    return format(date, "dd/MM/yyyy")
}

function isValidDate(date: Date | undefined) {
    if (!date) {
        return false
    }
    return !isNaN(date.getTime())
}

export interface DatePickerProps {
    value?: Date;
    onChange?: (date: Date | undefined) => void;
    placeholder?: string;
    className?: string;
}

export function DatePicker({ value, onChange, placeholder = "dd/mm/aaaa", className }: DatePickerProps) {
    const [open, setOpen] = React.useState(false)
    const [inputValue, setInputValue] = React.useState("")

    // Sync input value when prop value changes
    React.useEffect(() => {
        setInputValue(formatDate(value))
    }, [value])

    const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
        let val = e.target.value

        // Allow only numbers and slashes
        val = val.replace(/[^0-9/]/g, '')

        // Auto-insert slashes
        if (val.length === 2 && inputValue.length === 1) {
            val += '/'
        } else if (val.length === 5 && inputValue.length === 4) {
            val += '/'
        }

        // Logic to cap values (Native-like behavior)
        const parts = val.split('/')

        // Cap Day > 31
        if (parts[0] && parseInt(parts[0]) > 31) {
            parts[0] = "31"
        }

        // Cap Month > 12
        if (parts[1] && parseInt(parts[1]) > 12) {
            parts[1] = "12"
        }

        // Cap Year > 2050
        if (parts[2] && parts[2].length === 4 && parseInt(parts[2]) > 2050) {
            parts[2] = "2050"
        }

        // Reconstruct value
        val = parts.join('/')

        // Limit length to 10 (DD/MM/YYYY)
        if (val.length > 10) {
            val = val.slice(0, 10)
        }

        setInputValue(val)

        // Try to parse the date from dd/MM/yyyy format
        if (val.length === 10) {
            const finalParts = val.split('/')
            if (finalParts.length === 3) {
                const day = parseInt(finalParts[0], 10)
                const month = parseInt(finalParts[1], 10) - 1
                const year = parseInt(finalParts[2], 10)

                const newDate = new Date(year, month, day)

                if (isValidDate(newDate) && newDate.getDate() === day && newDate.getMonth() === month && newDate.getFullYear() === year) {
                    onChange?.(newDate)
                } else {
                    onChange?.(undefined)
                }
            }
        } else if (val === "") {
            onChange?.(undefined)
        }
    }

    return (
        <div className={className}>
            <div className="relative flex gap-2">
                <Input
                    value={inputValue}
                    placeholder={placeholder}
                    className="bg-background text-sm pr-10"
                    onChange={handleInputChange}
                    onKeyDown={(e) => {
                        if (e.key === "ArrowDown") {
                            e.preventDefault()
                            setOpen(true)
                        }
                    }}
                />
                <Popover open={open} onOpenChange={setOpen}>
                    <PopoverTrigger asChild>
                        <Button
                            variant="ghost"
                            className="absolute top-1/2 right-2 size-6 -translate-y-1/2"
                        >
                            <CalendarIcon className="size-3.5" />
                            <span className="sr-only">Seleccionar fecha</span>
                        </Button>
                    </PopoverTrigger>
                    <PopoverContent
                        className="w-auto overflow-hidden p-0"
                        align="end"
                        alignOffset={-8}
                        sideOffset={10}
                    >
                        <Calendar
                            mode="single"
                            selected={value}
                            captionLayout="dropdown"
                            // Default to today or selected date for month view
                            defaultMonth={value || new Date()}
                            onSelect={(date) => {
                                onChange?.(date)
                                setOpen(false)
                            }}
                            locale={es}
                        />
                    </PopoverContent>
                </Popover>
            </div>
        </div>
    )
}
</file>

<file path="frontend2/components/ui/dialog.tsx">
"use client"

import * as React from "react"
import * as DialogPrimitive from "@radix-ui/react-dialog"
import { XIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Dialog({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Root>) {
  return <DialogPrimitive.Root data-slot="dialog" {...props} />
}

function DialogTrigger({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Trigger>) {
  return <DialogPrimitive.Trigger data-slot="dialog-trigger" {...props} />
}

function DialogPortal({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Portal>) {
  return <DialogPrimitive.Portal data-slot="dialog-portal" {...props} />
}

function DialogClose({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Close>) {
  return <DialogPrimitive.Close data-slot="dialog-close" {...props} />
}

function DialogOverlay({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Overlay>) {
  return (
    <DialogPrimitive.Overlay
      data-slot="dialog-overlay"
      className={cn(
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50",
        className
      )}
      {...props}
    />
  )
}

function DialogContent({
  className,
  children,
  showCloseButton = true,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Content> & {
  showCloseButton?: boolean
}) {
  return (
    <DialogPortal data-slot="dialog-portal">
      <DialogOverlay />
      <DialogPrimitive.Content
        data-slot="dialog-content"
        className={cn(
          "bg-background data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200 sm:max-w-lg",
          className
        )}
        {...props}
      >
        {children}
        {showCloseButton && (
          <DialogPrimitive.Close
            data-slot="dialog-close"
            className="ring-offset-background focus:ring-ring data-[state=open]:bg-accent data-[state=open]:text-muted-foreground absolute top-4 right-4 rounded-xs opacity-70 transition-opacity hover:opacity-100 focus:ring-2 focus:ring-offset-2 focus:outline-hidden disabled:pointer-events-none [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4"
          >
            <XIcon />
            <span className="sr-only">Close</span>
          </DialogPrimitive.Close>
        )}
      </DialogPrimitive.Content>
    </DialogPortal>
  )
}

function DialogHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="dialog-header"
      className={cn("flex flex-col gap-2 text-center sm:text-left", className)}
      {...props}
    />
  )
}

function DialogFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="dialog-footer"
      className={cn(
        "flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",
        className
      )}
      {...props}
    />
  )
}

function DialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Title>) {
  return (
    <DialogPrimitive.Title
      data-slot="dialog-title"
      className={cn("text-lg leading-none font-semibold", className)}
      {...props}
    />
  )
}

function DialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Description>) {
  return (
    <DialogPrimitive.Description
      data-slot="dialog-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

export {
  Dialog,
  DialogClose,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogOverlay,
  DialogPortal,
  DialogTitle,
  DialogTrigger,
}
</file>

<file path="frontend2/components/ui/dropdown-menu.tsx">
"use client"

import * as React from "react"
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu"
import { CheckIcon, ChevronRightIcon, CircleIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function DropdownMenu({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Root>) {
  return <DropdownMenuPrimitive.Root data-slot="dropdown-menu" {...props} />
}

function DropdownMenuPortal({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Portal>) {
  return (
    <DropdownMenuPrimitive.Portal data-slot="dropdown-menu-portal" {...props} />
  )
}

function DropdownMenuTrigger({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Trigger>) {
  return (
    <DropdownMenuPrimitive.Trigger
      data-slot="dropdown-menu-trigger"
      {...props}
    />
  )
}

function DropdownMenuContent({
  className,
  sideOffset = 4,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Content>) {
  return (
    <DropdownMenuPrimitive.Portal>
      <DropdownMenuPrimitive.Content
        data-slot="dropdown-menu-content"
        sideOffset={sideOffset}
        className={cn(
          "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 max-h-(--radix-dropdown-menu-content-available-height) min-w-[8rem] origin-(--radix-dropdown-menu-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border p-1 shadow-md",
          className
        )}
        {...props}
      />
    </DropdownMenuPrimitive.Portal>
  )
}

function DropdownMenuGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Group>) {
  return (
    <DropdownMenuPrimitive.Group data-slot="dropdown-menu-group" {...props} />
  )
}

function DropdownMenuItem({
  className,
  inset,
  variant = "default",
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Item> & {
  inset?: boolean
  variant?: "default" | "destructive"
}) {
  return (
    <DropdownMenuPrimitive.Item
      data-slot="dropdown-menu-item"
      data-inset={inset}
      data-variant={variant}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    />
  )
}

function DropdownMenuCheckboxItem({
  className,
  children,
  checked,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.CheckboxItem>) {
  return (
    <DropdownMenuPrimitive.CheckboxItem
      data-slot="dropdown-menu-checkbox-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      checked={checked}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.CheckboxItem>
  )
}

function DropdownMenuRadioGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioGroup>) {
  return (
    <DropdownMenuPrimitive.RadioGroup
      data-slot="dropdown-menu-radio-group"
      {...props}
    />
  )
}

function DropdownMenuRadioItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioItem>) {
  return (
    <DropdownMenuPrimitive.RadioItem
      data-slot="dropdown-menu-radio-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CircleIcon className="size-2 fill-current" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.RadioItem>
  )
}

function DropdownMenuLabel({
  className,
  inset,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Label> & {
  inset?: boolean
}) {
  return (
    <DropdownMenuPrimitive.Label
      data-slot="dropdown-menu-label"
      data-inset={inset}
      className={cn(
        "px-2 py-1.5 text-sm font-medium data-[inset]:pl-8",
        className
      )}
      {...props}
    />
  )
}

function DropdownMenuSeparator({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Separator>) {
  return (
    <DropdownMenuPrimitive.Separator
      data-slot="dropdown-menu-separator"
      className={cn("bg-border -mx-1 my-1 h-px", className)}
      {...props}
    />
  )
}

function DropdownMenuShortcut({
  className,
  ...props
}: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="dropdown-menu-shortcut"
      className={cn(
        "text-muted-foreground ml-auto text-xs tracking-widest",
        className
      )}
      {...props}
    />
  )
}

function DropdownMenuSub({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Sub>) {
  return <DropdownMenuPrimitive.Sub data-slot="dropdown-menu-sub" {...props} />
}

function DropdownMenuSubTrigger({
  className,
  inset,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubTrigger> & {
  inset?: boolean
}) {
  return (
    <DropdownMenuPrimitive.SubTrigger
      data-slot="dropdown-menu-sub-trigger"
      data-inset={inset}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      {children}
      <ChevronRightIcon className="ml-auto size-4" />
    </DropdownMenuPrimitive.SubTrigger>
  )
}

function DropdownMenuSubContent({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubContent>) {
  return (
    <DropdownMenuPrimitive.SubContent
      data-slot="dropdown-menu-sub-content"
      className={cn(
        "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 min-w-[8rem] origin-(--radix-dropdown-menu-content-transform-origin) overflow-hidden rounded-md border p-1 shadow-lg",
        className
      )}
      {...props}
    />
  )
}

export {
  DropdownMenu,
  DropdownMenuPortal,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuGroup,
  DropdownMenuLabel,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioGroup,
  DropdownMenuRadioItem,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuSub,
  DropdownMenuSubTrigger,
  DropdownMenuSubContent,
}
</file>

<file path="frontend2/components/ui/field.tsx">
"use client"

import { useMemo } from "react"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"
import { Label } from "@/components/ui/label"
import { Separator } from "@/components/ui/separator"

function FieldSet({ className, ...props }: React.ComponentProps<"fieldset">) {
  return (
    <fieldset
      data-slot="field-set"
      className={cn(
        "flex flex-col gap-6",
        "has-[>[data-slot=checkbox-group]]:gap-3 has-[>[data-slot=radio-group]]:gap-3",
        className
      )}
      {...props}
    />
  )
}

function FieldLegend({
  className,
  variant = "legend",
  ...props
}: React.ComponentProps<"legend"> & { variant?: "legend" | "label" }) {
  return (
    <legend
      data-slot="field-legend"
      data-variant={variant}
      className={cn(
        "mb-3 font-medium",
        "data-[variant=legend]:text-base",
        "data-[variant=label]:text-sm",
        className
      )}
      {...props}
    />
  )
}

function FieldGroup({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="field-group"
      className={cn(
        "group/field-group @container/field-group flex w-full flex-col gap-7 data-[slot=checkbox-group]:gap-3 [&>[data-slot=field-group]]:gap-4",
        className
      )}
      {...props}
    />
  )
}

const fieldVariants = cva(
  "group/field flex w-full gap-3 data-[invalid=true]:text-destructive",
  {
    variants: {
      orientation: {
        vertical: ["flex-col [&>*]:w-full [&>.sr-only]:w-auto"],
        horizontal: [
          "flex-row items-center",
          "[&>[data-slot=field-label]]:flex-auto",
          "has-[>[data-slot=field-content]]:items-start has-[>[data-slot=field-content]]:[&>[role=checkbox],[role=radio]]:mt-px",
        ],
        responsive: [
          "flex-col [&>*]:w-full [&>.sr-only]:w-auto @md/field-group:flex-row @md/field-group:items-center @md/field-group:[&>*]:w-auto",
          "@md/field-group:[&>[data-slot=field-label]]:flex-auto",
          "@md/field-group:has-[>[data-slot=field-content]]:items-start @md/field-group:has-[>[data-slot=field-content]]:[&>[role=checkbox],[role=radio]]:mt-px",
        ],
      },
    },
    defaultVariants: {
      orientation: "vertical",
    },
  }
)

function Field({
  className,
  orientation = "vertical",
  ...props
}: React.ComponentProps<"div"> & VariantProps<typeof fieldVariants>) {
  return (
    <div
      role="group"
      data-slot="field"
      data-orientation={orientation}
      className={cn(fieldVariants({ orientation }), className)}
      {...props}
    />
  )
}

function FieldContent({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="field-content"
      className={cn(
        "group/field-content flex flex-1 flex-col gap-1.5 leading-snug",
        className
      )}
      {...props}
    />
  )
}

function FieldLabel({
  className,
  ...props
}: React.ComponentProps<typeof Label>) {
  return (
    <Label
      data-slot="field-label"
      className={cn(
        "group/field-label peer/field-label flex w-fit gap-2 leading-snug group-data-[disabled=true]/field:opacity-50",
        "has-[>[data-slot=field]]:w-full has-[>[data-slot=field]]:flex-col has-[>[data-slot=field]]:rounded-md has-[>[data-slot=field]]:border [&>*]:data-[slot=field]:p-4",
        "has-data-[state=checked]:bg-primary/5 has-data-[state=checked]:border-primary dark:has-data-[state=checked]:bg-primary/10",
        className
      )}
      {...props}
    />
  )
}

function FieldTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="field-label"
      className={cn(
        "flex w-fit items-center gap-2 text-sm leading-snug font-medium group-data-[disabled=true]/field:opacity-50",
        className
      )}
      {...props}
    />
  )
}

function FieldDescription({ className, ...props }: React.ComponentProps<"p">) {
  return (
    <p
      data-slot="field-description"
      className={cn(
        "text-muted-foreground text-sm leading-normal font-normal group-has-[[data-orientation=horizontal]]/field:text-balance",
        "last:mt-0 nth-last-2:-mt-1 [[data-variant=legend]+&]:-mt-1.5",
        "[&>a:hover]:text-primary [&>a]:underline [&>a]:underline-offset-4",
        className
      )}
      {...props}
    />
  )
}

function FieldSeparator({
  children,
  className,
  ...props
}: React.ComponentProps<"div"> & {
  children?: React.ReactNode
}) {
  return (
    <div
      data-slot="field-separator"
      data-content={!!children}
      className={cn(
        "relative -my-2 h-5 text-sm group-data-[variant=outline]/field-group:-mb-2",
        className
      )}
      {...props}
    >
      <Separator className="absolute inset-0 top-1/2" />
      {children && (
        <span
          className="bg-background text-muted-foreground relative mx-auto block w-fit px-2"
          data-slot="field-separator-content"
        >
          {children}
        </span>
      )}
    </div>
  )
}

function FieldError({
  className,
  children,
  errors,
  ...props
}: React.ComponentProps<"div"> & {
  errors?: Array<{ message?: string } | undefined>
}) {
  const content = useMemo(() => {
    if (children) {
      return children
    }

    if (!errors?.length) {
      return null
    }

    const uniqueErrors = [
      ...new Map(errors.map((error) => [error?.message, error])).values(),
    ]

    if (uniqueErrors?.length == 1) {
      return uniqueErrors[0]?.message
    }

    return (
      <ul className="ml-4 flex list-disc flex-col gap-1">
        {uniqueErrors.map(
          (error, index) =>
            error?.message && <li key={index}>{error.message}</li>
        )}
      </ul>
    )
  }, [children, errors])

  if (!content) {
    return null
  }

  return (
    <div
      role="alert"
      data-slot="field-error"
      className={cn("text-destructive text-sm font-normal", className)}
      {...props}
    >
      {content}
    </div>
  )
}

export {
  Field,
  FieldLabel,
  FieldDescription,
  FieldError,
  FieldGroup,
  FieldLegend,
  FieldSeparator,
  FieldSet,
  FieldContent,
  FieldTitle,
}
</file>

<file path="frontend2/components/ui/file-upload.tsx">
"use client";

import { useCallback, useState, useEffect } from "react";
import { CloudUpload, X } from "lucide-react";
import { Button } from "@/components/ui/button";
import {
    Item,
    ItemContent,
    ItemDescription,
    ItemGroup,
    ItemMedia,
    ItemTitle,
    ItemActions,
} from "@/components/ui/item";

interface FileUploadProps {
    onFileSelect: (file: File | null) => void;
    accept?: string;
    currentFile?: File | null;
    initialPreviewUrl?: string | null;
    onRemove?: () => void;
}

export function FileUpload({ onFileSelect, accept = "image/*", currentFile, initialPreviewUrl, onRemove }: FileUploadProps) {
    const [isDragging, setIsDragging] = useState(false);
    const [previewUrl, setPreviewUrl] = useState<string | null>(initialPreviewUrl || null);

    const handleDragOver = useCallback((e: React.DragEvent) => {
        e.preventDefault();
        setIsDragging(true);
    }, []);

    const handleDragLeave = useCallback((e: React.DragEvent) => {
        e.preventDefault();
        setIsDragging(false);
    }, []);

    const handleDrop = useCallback((e: React.DragEvent) => {
        e.preventDefault();
        setIsDragging(false);

        const file = e.dataTransfer.files[0];
        if (file) {
            onFileSelect(file);
        }
    }, [onFileSelect]);

    const handleFileChange = useCallback((e: React.ChangeEvent<HTMLInputElement>) => {
        const file = e.target.files?.[0];
        if (file) {
            onFileSelect(file);
        }
    }, [onFileSelect]);

    const handleRemove = useCallback(() => {
        onFileSelect(null);
        setPreviewUrl(null);
        if (onRemove) onRemove();
    }, [onFileSelect, onRemove]);

    // Generate preview URL when file changes
    useEffect(() => {
        if (currentFile && currentFile.type.startsWith("image/")) {
            const url = URL.createObjectURL(currentFile);
            setPreviewUrl(url);
            return () => URL.revokeObjectURL(url);
        } else if (!currentFile && initialPreviewUrl) {
            // If no new file selected but we have initial, revert to initial? 
            // Or if user removed it, we should respect that.
            // The handleRemove sets previewUrl to null, so we shouldn't automatically revert here unless we track "removed" state.
            // But for simplicity, if currentFile is null, we don't necessarily want to show initial if it was removed.
            // However, on mount, currentFile is null and initialPreviewUrl is set.
            // So we need to distinguish between "initial load" and "user removed file".
            // Actually, handleRemove sets previewUrl to null directly.
            // This useEffect runs when currentFile changes.
            // If currentFile becomes null (removed), we might not want to reset to initial.
            // Let's rely on state initialization for initialPreviewUrl and only update if currentFile is present.
        }
    }, [currentFile]);

    // If we have a preview URL (either from file or initial), show the item
    // We need a way to show the name/size for initial files too if possible, or just "Imagen Actual"

    const showPreview = previewUrl;
    const fileName = currentFile?.name || "Imagen Actual";
    const fileSize = currentFile ? (currentFile.size / 1024 / 1024).toFixed(2) + " MB" : "";

    if (showPreview) {
        return (
            <ItemGroup>
                <Item variant="outline">
                    <ItemMedia variant="image">
                        <img
                            src={previewUrl!}
                            alt={fileName}
                            className="object-cover"
                        />
                    </ItemMedia>
                    <ItemContent>
                        <ItemTitle className="line-clamp-1">
                            {fileName}
                        </ItemTitle>
                        {fileSize && (
                            <ItemDescription>
                                {fileSize}
                            </ItemDescription>
                        )}
                    </ItemContent>
                    <ItemActions>
                        <Button
                            type="button"
                            variant="ghost"
                            size="icon"
                            className="h-8 w-8 text-muted-foreground hover:text-destructive"
                            onClick={handleRemove}
                        >
                            <X className="h-4 w-4" />
                            <span className="sr-only">Remover archivo</span>
                        </Button>
                    </ItemActions>
                </Item>
            </ItemGroup>
        );
    }

    return (
        <div
            onDragOver={handleDragOver}
            onDragLeave={handleDragLeave}
            onDrop={handleDrop}
            className={`
                relative flex flex-col items-center justify-center
                border-2 border-dashed rounded-lg
                p-8 transition-colors
                ${isDragging ? "border-primary bg-primary/5" : "border-gray-300"}
            `}
        >
            <CloudUpload className="h-12 w-12 text-gray-400 mb-4" />

            <p className="text-lg text-center font-medium text-gray-700 mb-2">
                Arrastra archivos aquí
            </p>

            <p className="text-sm text-gray-500 mb-4">o</p>

            <input
                type="file"
                accept={accept}
                onChange={handleFileChange}
                className="hidden"
                id="file-upload-input"
            />

            <Button
                type="button"
                variant="outline"
                onClick={() => document.getElementById("file-upload-input")?.click()}
            >
                Buscar Archivos
            </Button>
        </div>
    );
}
</file>

<file path="frontend2/components/ui/form.tsx">
"use client"

import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"
import { Slot } from "@radix-ui/react-slot"
import {
  Controller,
  FormProvider,
  useFormContext,
  useFormState,
  type ControllerProps,
  type FieldPath,
  type FieldValues,
} from "react-hook-form"

import { cn } from "@/lib/utils"
import { Label } from "@/components/ui/label"

const Form = FormProvider

type FormFieldContextValue<
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>,
> = {
  name: TName
}

const FormFieldContext = React.createContext<FormFieldContextValue>(
  {} as FormFieldContextValue
)

const FormField = <
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>,
>({
  ...props
}: ControllerProps<TFieldValues, TName>) => {
  return (
    <FormFieldContext.Provider value={{ name: props.name }}>
      <Controller {...props} />
    </FormFieldContext.Provider>
  )
}

const useFormField = () => {
  const fieldContext = React.useContext(FormFieldContext)
  const itemContext = React.useContext(FormItemContext)
  const { getFieldState } = useFormContext()
  const formState = useFormState({ name: fieldContext.name })
  const fieldState = getFieldState(fieldContext.name, formState)

  if (!fieldContext) {
    throw new Error("useFormField should be used within <FormField>")
  }

  const { id } = itemContext

  return {
    id,
    name: fieldContext.name,
    formItemId: `${id}-form-item`,
    formDescriptionId: `${id}-form-item-description`,
    formMessageId: `${id}-form-item-message`,
    ...fieldState,
  }
}

type FormItemContextValue = {
  id: string
}

const FormItemContext = React.createContext<FormItemContextValue>(
  {} as FormItemContextValue
)

function FormItem({ className, ...props }: React.ComponentProps<"div">) {
  const id = React.useId()

  return (
    <FormItemContext.Provider value={{ id }}>
      <div
        data-slot="form-item"
        className={cn("grid gap-2", className)}
        {...props}
      />
    </FormItemContext.Provider>
  )
}

function FormLabel({
  className,
  ...props
}: React.ComponentProps<typeof LabelPrimitive.Root>) {
  const { error, formItemId } = useFormField()

  return (
    <Label
      data-slot="form-label"
      data-error={!!error}
      className={cn("data-[error=true]:text-destructive", className)}
      htmlFor={formItemId}
      {...props}
    />
  )
}

function FormControl({ ...props }: React.ComponentProps<typeof Slot>) {
  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()

  return (
    <Slot
      data-slot="form-control"
      id={formItemId}
      aria-describedby={
        !error
          ? `${formDescriptionId}`
          : `${formDescriptionId} ${formMessageId}`
      }
      aria-invalid={!!error}
      {...props}
    />
  )
}

function FormDescription({ className, ...props }: React.ComponentProps<"p">) {
  const { formDescriptionId } = useFormField()

  return (
    <p
      data-slot="form-description"
      id={formDescriptionId}
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

function FormMessage({ className, ...props }: React.ComponentProps<"p">) {
  const { error, formMessageId } = useFormField()
  const body = error ? String(error?.message ?? "") : props.children

  if (!body) {
    return null
  }

  return (
    <p
      data-slot="form-message"
      id={formMessageId}
      className={cn("text-destructive text-sm", className)}
      {...props}
    >
      {body}
    </p>
  )
}

export {
  useFormField,
  Form,
  FormItem,
  FormLabel,
  FormControl,
  FormDescription,
  FormMessage,
  FormField,
}
</file>

<file path="frontend2/components/ui/input.tsx">
import * as React from "react"

import { cn } from "@/lib/utils"

function Input({ className, type, ...props }: React.ComponentProps<"input">) {
  return (
    <input
      type={type}
      data-slot="input"
      className={cn(
        "file:text-foreground placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground dark:bg-input/30 border-input h-9 w-full min-w-0 rounded-md border bg-transparent px-3 py-1 text-base shadow-xs transition-[color,box-shadow] outline-none file:inline-flex file:h-7 file:border-0 file:bg-transparent file:text-sm file:font-medium disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        "focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]",
        "aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
        className
      )}
      {...props}
    />
  )
}

export { Input }
</file>

<file path="frontend2/components/ui/item.tsx">
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"
import { Separator } from "@/components/ui/separator"

function ItemGroup({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      role="list"
      data-slot="item-group"
      className={cn("group/item-group flex flex-col", className)}
      {...props}
    />
  )
}

function ItemSeparator({
  className,
  ...props
}: React.ComponentProps<typeof Separator>) {
  return (
    <Separator
      data-slot="item-separator"
      orientation="horizontal"
      className={cn("my-0", className)}
      {...props}
    />
  )
}

const itemVariants = cva(
  "group/item flex items-center border border-transparent text-sm rounded-md transition-colors [a]:hover:bg-accent/50 [a]:transition-colors duration-100 flex-wrap outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]",
  {
    variants: {
      variant: {
        default: "bg-transparent",
        outline: "border-border",
        muted: "bg-muted/50",
      },
      size: {
        default: "p-4 gap-4 ",
        sm: "py-3 px-4 gap-2.5",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

function Item({
  className,
  variant = "default",
  size = "default",
  asChild = false,
  ...props
}: React.ComponentProps<"div"> &
  VariantProps<typeof itemVariants> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : "div"
  return (
    <Comp
      data-slot="item"
      data-variant={variant}
      data-size={size}
      className={cn(itemVariants({ variant, size, className }))}
      {...props}
    />
  )
}

const itemMediaVariants = cva(
  "flex shrink-0 items-center justify-center gap-2 group-has-[[data-slot=item-description]]/item:self-start [&_svg]:pointer-events-none group-has-[[data-slot=item-description]]/item:translate-y-0.5",
  {
    variants: {
      variant: {
        default: "bg-transparent",
        icon: "size-8 border rounded-sm bg-muted [&_svg:not([class*='size-'])]:size-4",
        image:
          "size-10 rounded-sm overflow-hidden [&_img]:size-full [&_img]:object-cover",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  }
)

function ItemMedia({
  className,
  variant = "default",
  ...props
}: React.ComponentProps<"div"> & VariantProps<typeof itemMediaVariants>) {
  return (
    <div
      data-slot="item-media"
      data-variant={variant}
      className={cn(itemMediaVariants({ variant, className }))}
      {...props}
    />
  )
}

function ItemContent({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="item-content"
      className={cn(
        "flex flex-1 flex-col gap-1 [&+[data-slot=item-content]]:flex-none",
        className
      )}
      {...props}
    />
  )
}

function ItemTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="item-title"
      className={cn(
        "flex w-fit items-center gap-2 text-sm leading-snug font-medium",
        className
      )}
      {...props}
    />
  )
}

function ItemDescription({ className, ...props }: React.ComponentProps<"p">) {
  return (
    <p
      data-slot="item-description"
      className={cn(
        "text-muted-foreground line-clamp-2 text-sm leading-normal font-normal text-balance",
        "[&>a:hover]:text-primary [&>a]:underline [&>a]:underline-offset-4",
        className
      )}
      {...props}
    />
  )
}

function ItemActions({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="item-actions"
      className={cn("flex items-center gap-2", className)}
      {...props}
    />
  )
}

function ItemHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="item-header"
      className={cn(
        "flex basis-full items-center justify-between gap-2",
        className
      )}
      {...props}
    />
  )
}

function ItemFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="item-footer"
      className={cn(
        "flex basis-full items-center justify-between gap-2",
        className
      )}
      {...props}
    />
  )
}

export {
  Item,
  ItemMedia,
  ItemContent,
  ItemActions,
  ItemGroup,
  ItemSeparator,
  ItemTitle,
  ItemDescription,
  ItemHeader,
  ItemFooter,
}
</file>

<file path="frontend2/components/ui/kbd.tsx">
import { cn } from "@/lib/utils"

function Kbd({ className, ...props }: React.ComponentProps<"kbd">) {
  return (
    <kbd
      data-slot="kbd"
      className={cn(
        "bg-muted text-muted-foreground pointer-events-none inline-flex h-5 w-fit min-w-5 items-center justify-center gap-1 rounded-sm px-1 font-sans text-xs font-medium select-none",
        "[&_svg:not([class*='size-'])]:size-3",
        "[[data-slot=tooltip-content]_&]:bg-background/20 [[data-slot=tooltip-content]_&]:text-background dark:[[data-slot=tooltip-content]_&]:bg-background/10",
        className
      )}
      {...props}
    />
  )
}

function KbdGroup({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <kbd
      data-slot="kbd-group"
      className={cn("inline-flex items-center gap-1", className)}
      {...props}
    />
  )
}

export { Kbd, KbdGroup }
</file>

<file path="frontend2/components/ui/label.tsx">
"use client"

import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"

import { cn } from "@/lib/utils"

function Label({
  className,
  ...props
}: React.ComponentProps<typeof LabelPrimitive.Root>) {
  return (
    <LabelPrimitive.Root
      data-slot="label"
      className={cn(
        "flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50",
        className
      )}
      {...props}
    />
  )
}

export { Label }
</file>

<file path="frontend2/components/ui/popover.tsx">
"use client"

import * as React from "react"
import * as PopoverPrimitive from "@radix-ui/react-popover"

import { cn } from "@/lib/utils"

const Popover = PopoverPrimitive.Root

const PopoverTrigger = PopoverPrimitive.Trigger

const PopoverContent = React.forwardRef<
    React.ElementRef<typeof PopoverPrimitive.Content>,
    React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>
>(({ className, align = "center", sideOffset = 4, ...props }, ref) => (
    <PopoverPrimitive.Portal>
        <PopoverPrimitive.Content
            ref={ref}
            align={align}
            sideOffset={sideOffset}
            className={cn(
                "z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",
                className
            )}
            {...props}
        />
    </PopoverPrimitive.Portal>
))
PopoverContent.displayName = PopoverPrimitive.Content.displayName

export { Popover, PopoverTrigger, PopoverContent }
</file>

<file path="frontend2/components/ui/select.tsx">
"use client"

import * as React from "react"
import * as SelectPrimitive from "@radix-ui/react-select"
import { CheckIcon, ChevronDownIcon, ChevronUpIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Select({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Root>) {
  return <SelectPrimitive.Root data-slot="select" {...props} />
}

function SelectGroup({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Group>) {
  return <SelectPrimitive.Group data-slot="select-group" {...props} />
}

function SelectValue({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Value>) {
  return <SelectPrimitive.Value data-slot="select-value" {...props} />
}

function SelectTrigger({
  className,
  size = "default",
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Trigger> & {
  size?: "sm" | "default"
}) {
  return (
    <SelectPrimitive.Trigger
      data-slot="select-trigger"
      data-size={size}
      className={cn(
        "border-input data-[placeholder]:text-muted-foreground [&_svg:not([class*='text-'])]:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 dark:hover:bg-input/50 flex w-fit items-center justify-between gap-2 rounded-md border bg-transparent px-3 py-2 text-sm whitespace-nowrap shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 data-[size=default]:h-9 data-[size=sm]:h-8 *:data-[slot=select-value]:line-clamp-1 *:data-[slot=select-value]:flex *:data-[slot=select-value]:items-center *:data-[slot=select-value]:gap-2 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    >
      {children}
      <SelectPrimitive.Icon asChild>
        <ChevronDownIcon className="size-4 opacity-50" />
      </SelectPrimitive.Icon>
    </SelectPrimitive.Trigger>
  )
}

function SelectContent({
  className,
  children,
  position = "popper",
  align = "center",
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Content>) {
  return (
    <SelectPrimitive.Portal>
      <SelectPrimitive.Content
        data-slot="select-content"
        className={cn(
          "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 relative z-50 max-h-(--radix-select-content-available-height) min-w-[8rem] origin-(--radix-select-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border shadow-md",
          position === "popper" &&
            "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
          className
        )}
        position={position}
        align={align}
        {...props}
      >
        <SelectScrollUpButton />
        <SelectPrimitive.Viewport
          className={cn(
            "p-1",
            position === "popper" &&
              "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)] scroll-my-1"
          )}
        >
          {children}
        </SelectPrimitive.Viewport>
        <SelectScrollDownButton />
      </SelectPrimitive.Content>
    </SelectPrimitive.Portal>
  )
}

function SelectLabel({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Label>) {
  return (
    <SelectPrimitive.Label
      data-slot="select-label"
      className={cn("text-muted-foreground px-2 py-1.5 text-xs", className)}
      {...props}
    />
  )
}

function SelectItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Item>) {
  return (
    <SelectPrimitive.Item
      data-slot="select-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground relative flex w-full cursor-default items-center gap-2 rounded-sm py-1.5 pr-8 pl-2 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4 *:[span]:last:flex *:[span]:last:items-center *:[span]:last:gap-2",
        className
      )}
      {...props}
    >
      <span className="absolute right-2 flex size-3.5 items-center justify-center">
        <SelectPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </SelectPrimitive.ItemIndicator>
      </span>
      <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
    </SelectPrimitive.Item>
  )
}

function SelectSeparator({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Separator>) {
  return (
    <SelectPrimitive.Separator
      data-slot="select-separator"
      className={cn("bg-border pointer-events-none -mx-1 my-1 h-px", className)}
      {...props}
    />
  )
}

function SelectScrollUpButton({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.ScrollUpButton>) {
  return (
    <SelectPrimitive.ScrollUpButton
      data-slot="select-scroll-up-button"
      className={cn(
        "flex cursor-default items-center justify-center py-1",
        className
      )}
      {...props}
    >
      <ChevronUpIcon className="size-4" />
    </SelectPrimitive.ScrollUpButton>
  )
}

function SelectScrollDownButton({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.ScrollDownButton>) {
  return (
    <SelectPrimitive.ScrollDownButton
      data-slot="select-scroll-down-button"
      className={cn(
        "flex cursor-default items-center justify-center py-1",
        className
      )}
      {...props}
    >
      <ChevronDownIcon className="size-4" />
    </SelectPrimitive.ScrollDownButton>
  )
}

export {
  Select,
  SelectContent,
  SelectGroup,
  SelectItem,
  SelectLabel,
  SelectScrollDownButton,
  SelectScrollUpButton,
  SelectSeparator,
  SelectTrigger,
  SelectValue,
}
</file>

<file path="frontend2/components/ui/separator.tsx">
"use client"

import * as React from "react"
import * as SeparatorPrimitive from "@radix-ui/react-separator"

import { cn } from "@/lib/utils"

function Separator({
  className,
  orientation = "horizontal",
  decorative = true,
  ...props
}: React.ComponentProps<typeof SeparatorPrimitive.Root>) {
  return (
    <SeparatorPrimitive.Root
      data-slot="separator"
      decorative={decorative}
      orientation={orientation}
      className={cn(
        "bg-border shrink-0 data-[orientation=horizontal]:h-px data-[orientation=horizontal]:w-full data-[orientation=vertical]:h-full data-[orientation=vertical]:w-px",
        className
      )}
      {...props}
    />
  )
}

export { Separator }
</file>

<file path="frontend2/components/ui/sheet.tsx">
"use client"

import * as React from "react"
import * as SheetPrimitive from "@radix-ui/react-dialog"
import { XIcon } from "lucide-react"

import { cn } from "@/lib/utils"

function Sheet({ ...props }: React.ComponentProps<typeof SheetPrimitive.Root>) {
  return <SheetPrimitive.Root data-slot="sheet" {...props} />
}

function SheetTrigger({
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Trigger>) {
  return <SheetPrimitive.Trigger data-slot="sheet-trigger" {...props} />
}

function SheetClose({
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Close>) {
  return <SheetPrimitive.Close data-slot="sheet-close" {...props} />
}

function SheetPortal({
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Portal>) {
  return <SheetPrimitive.Portal data-slot="sheet-portal" {...props} />
}

function SheetOverlay({
  className,
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Overlay>) {
  return (
    <SheetPrimitive.Overlay
      data-slot="sheet-overlay"
      className={cn(
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50",
        className
      )}
      {...props}
    />
  )
}

function SheetContent({
  className,
  children,
  side = "right",
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Content> & {
  side?: "top" | "right" | "bottom" | "left"
}) {
  return (
    <SheetPortal>
      <SheetOverlay />
      <SheetPrimitive.Content
        data-slot="sheet-content"
        className={cn(
          "bg-background data-[state=open]:animate-in data-[state=closed]:animate-out fixed z-50 flex flex-col gap-4 shadow-lg transition ease-in-out data-[state=closed]:duration-300 data-[state=open]:duration-500",
          side === "right" &&
            "data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right inset-y-0 right-0 h-full w-3/4 border-l sm:max-w-sm",
          side === "left" &&
            "data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left inset-y-0 left-0 h-full w-3/4 border-r sm:max-w-sm",
          side === "top" &&
            "data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top inset-x-0 top-0 h-auto border-b",
          side === "bottom" &&
            "data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom inset-x-0 bottom-0 h-auto border-t",
          className
        )}
        {...props}
      >
        {children}
        <SheetPrimitive.Close className="ring-offset-background focus:ring-ring data-[state=open]:bg-secondary absolute top-4 right-4 rounded-xs opacity-70 transition-opacity hover:opacity-100 focus:ring-2 focus:ring-offset-2 focus:outline-hidden disabled:pointer-events-none">
          <XIcon className="size-4" />
          <span className="sr-only">Close</span>
        </SheetPrimitive.Close>
      </SheetPrimitive.Content>
    </SheetPortal>
  )
}

function SheetHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="sheet-header"
      className={cn("flex flex-col gap-1.5 p-4", className)}
      {...props}
    />
  )
}

function SheetFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="sheet-footer"
      className={cn("mt-auto flex flex-col gap-2 p-4", className)}
      {...props}
    />
  )
}

function SheetTitle({
  className,
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Title>) {
  return (
    <SheetPrimitive.Title
      data-slot="sheet-title"
      className={cn("text-foreground font-semibold", className)}
      {...props}
    />
  )
}

function SheetDescription({
  className,
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Description>) {
  return (
    <SheetPrimitive.Description
      data-slot="sheet-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

export {
  Sheet,
  SheetTrigger,
  SheetClose,
  SheetContent,
  SheetHeader,
  SheetFooter,
  SheetTitle,
  SheetDescription,
}
</file>

<file path="frontend2/components/ui/skeleton.tsx">
import { cn } from "@/lib/utils"

function Skeleton({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="skeleton"
      className={cn("bg-accent animate-pulse rounded-md", className)}
      {...props}
    />
  )
}

export { Skeleton }
</file>

<file path="frontend2/components/ui/sonner.tsx">
"use client"

import {
  CircleCheckIcon,
  InfoIcon,
  Loader2Icon,
  OctagonXIcon,
  TriangleAlertIcon,
} from "lucide-react"
import { useTheme } from "next-themes"
import { Toaster as Sonner, type ToasterProps } from "sonner"

const Toaster = ({ ...props }: ToasterProps) => {
  const { theme = "system" } = useTheme()

  return (
    <Sonner
      theme={theme as ToasterProps["theme"]}
      position="top-center"
      richColors
      className="toaster group"
      icons={{
        success: <CircleCheckIcon className="size-4" />,
        info: <InfoIcon className="size-4" />,
        warning: <TriangleAlertIcon className="size-4" />,
        error: <OctagonXIcon className="size-4" />,
        loading: <Loader2Icon className="size-4 animate-spin" />,
      }}
      style={
        {
          "--normal-bg": "var(--popover)",
          "--normal-text": "var(--popover-foreground)",
          "--normal-border": "var(--border)",
          "--border-radius": "var(--radius)",
        } as React.CSSProperties
      }
      {...props}
    />
  )
}

export { Toaster }
</file>

<file path="frontend2/components/ui/switch.tsx">
"use client"

import * as React from "react"
import * as SwitchPrimitive from "@radix-ui/react-switch"

import { cn } from "@/lib/utils"

function Switch({
  className,
  ...props
}: React.ComponentProps<typeof SwitchPrimitive.Root>) {
  return (
    <SwitchPrimitive.Root
      data-slot="switch"
      className={cn(
        "peer data-[state=checked]:bg-primary data-[state=unchecked]:bg-input focus-visible:border-ring focus-visible:ring-ring/50 dark:data-[state=unchecked]:bg-input/80 inline-flex h-[1.15rem] w-8 shrink-0 items-center rounded-full border border-transparent shadow-xs transition-all outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50",
        className
      )}
      {...props}
    >
      <SwitchPrimitive.Thumb
        data-slot="switch-thumb"
        className={cn(
          "bg-background dark:data-[state=unchecked]:bg-foreground dark:data-[state=checked]:bg-primary-foreground pointer-events-none block size-4 rounded-full ring-0 transition-transform data-[state=checked]:translate-x-[calc(100%-2px)] data-[state=unchecked]:translate-x-0"
        )}
      />
    </SwitchPrimitive.Root>
  )
}

export { Switch }
</file>

<file path="frontend2/components/ui/table.tsx">
"use client"

import * as React from "react"

import { cn } from "@/lib/utils"

function Table({ className, ...props }: React.ComponentProps<"table">) {
  return (
    <div
      data-slot="table-container"
      className="relative w-full overflow-x-auto"
    >
      <table
        data-slot="table"
        className={cn("w-full caption-bottom text-sm", className)}
        {...props}
      />
    </div>
  )
}

function TableHeader({ className, ...props }: React.ComponentProps<"thead">) {
  return (
    <thead
      data-slot="table-header"
      className={cn("[&_tr]:border-b", className)}
      {...props}
    />
  )
}

function TableBody({ className, ...props }: React.ComponentProps<"tbody">) {
  return (
    <tbody
      data-slot="table-body"
      className={cn("[&_tr:last-child]:border-0", className)}
      {...props}
    />
  )
}

function TableFooter({ className, ...props }: React.ComponentProps<"tfoot">) {
  return (
    <tfoot
      data-slot="table-footer"
      className={cn(
        "bg-muted/50 border-t font-medium [&>tr]:last:border-b-0",
        className
      )}
      {...props}
    />
  )
}

function TableRow({ className, ...props }: React.ComponentProps<"tr">) {
  return (
    <tr
      data-slot="table-row"
      className={cn(
        "hover:bg-muted/50 data-[state=selected]:bg-muted border-b transition-colors",
        className
      )}
      {...props}
    />
  )
}

function TableHead({ className, ...props }: React.ComponentProps<"th">) {
  return (
    <th
      data-slot="table-head"
      className={cn(
        "text-foreground h-10 px-2 text-left align-middle font-medium whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
        className
      )}
      {...props}
    />
  )
}

function TableCell({ className, ...props }: React.ComponentProps<"td">) {
  return (
    <td
      data-slot="table-cell"
      className={cn(
        "p-2 align-middle whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
        className
      )}
      {...props}
    />
  )
}

function TableCaption({
  className,
  ...props
}: React.ComponentProps<"caption">) {
  return (
    <caption
      data-slot="table-caption"
      className={cn("text-muted-foreground mt-4 text-sm", className)}
      {...props}
    />
  )
}

export {
  Table,
  TableHeader,
  TableBody,
  TableFooter,
  TableHead,
  TableRow,
  TableCell,
  TableCaption,
}
</file>

<file path="frontend2/components/ui/tabs.tsx">
"use client"

import * as React from "react"
import * as TabsPrimitive from "@radix-ui/react-tabs"

import { cn } from "@/lib/utils"

function Tabs({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Root>) {
  return (
    <TabsPrimitive.Root
      data-slot="tabs"
      className={cn("flex flex-col gap-2", className)}
      {...props}
    />
  )
}

function TabsList({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.List>) {
  return (
    <TabsPrimitive.List
      data-slot="tabs-list"
      className={cn(
        "bg-muted text-muted-foreground inline-flex h-9 w-fit items-center justify-center rounded-lg p-[3px]",
        className
      )}
      {...props}
    />
  )
}

function TabsTrigger({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Trigger>) {
  return (
    <TabsPrimitive.Trigger
      data-slot="tabs-trigger"
      className={cn(
        "data-[state=active]:bg-background dark:data-[state=active]:text-foreground focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:outline-ring dark:data-[state=active]:border-input dark:data-[state=active]:bg-input/30 text-foreground dark:text-muted-foreground inline-flex h-[calc(100%-1px)] flex-1 items-center justify-center gap-1.5 rounded-md border border-transparent px-2 py-1 text-sm font-medium whitespace-nowrap transition-[color,box-shadow] focus-visible:ring-[3px] focus-visible:outline-1 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:shadow-sm [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className
      )}
      {...props}
    />
  )
}

function TabsContent({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Content>) {
  return (
    <TabsPrimitive.Content
      data-slot="tabs-content"
      className={cn("flex-1 outline-none", className)}
      {...props}
    />
  )
}

export { Tabs, TabsList, TabsTrigger, TabsContent }
</file>

<file path="frontend2/components/ui/textarea.tsx">
import * as React from "react"

import { cn } from "@/lib/utils"

function Textarea({ className, ...props }: React.ComponentProps<"textarea">) {
    return (
        <textarea
            data-slot="textarea"
            className={cn(
                "border-input placeholder:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive flex field-sizing-content min-h-16 w-full rounded-md border bg-transparent px-3 py-2 text-base shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
                className
            )}
            {...props}
        />
    )
}

export { Textarea }
</file>

<file path="frontend2/components/auth-loading.tsx">
"use client";

import { useAuth } from "@/context/auth-context";
import { Skeleton } from "@/components/ui/skeleton";
import { usePathname } from "next/navigation";
import { DashboardSkeleton } from "@/components/skeletons/dashboard-skeleton";
import { GeneralCatalogSkeleton } from "@/components/skeletons/general-catalog-skeleton";
import { SpecificCatalogSkeleton } from "@/components/skeletons/specific-catalog-skeleton";

export function AuthLoading({ children }: { children: React.ReactNode }) {
    const { isLoading } = useAuth();
    const pathname = usePathname();

    // Don't show skeleton on login page
    if (pathname === "/login") {
        return <>{children}</>;
    }

    if (isLoading) {
        // Determine which skeleton to show based on the route
        let ContentSkeleton = DashboardSkeleton; // Default

        if (pathname === "/admin/dashboard") {
            ContentSkeleton = DashboardSkeleton;
        } else if (pathname === "/admin/config/general") {
            ContentSkeleton = GeneralCatalogSkeleton;
        } else if (pathname?.startsWith("/admin/config/general/")) {
            ContentSkeleton = SpecificCatalogSkeleton;
        }

        return (
            <div className="min-h-screen bg-background">
                {/* Sidebar Skeleton - Fixed */}
                <div className="hidden md:block fixed left-0 top-0 h-screen w-64 border-r bg-card z-40">
                    <div className="h-14 border-b flex items-center px-6">
                        <Skeleton className="h-8 w-32" />
                    </div>
                    <div className="p-4 space-y-4">
                        <div className="flex items-center gap-2 px-2">
                            <Skeleton className="h-10 w-10 rounded-lg" />
                            <Skeleton className="h-6 w-32" />
                        </div>
                        <div className="flex flex-col gap-2 mt-4">
                            {Array.from({ length: 8 }).map((_, i) => (
                                <Skeleton key={i} className="h-10 w-full rounded-md" />
                            ))}
                        </div>
                    </div>
                </div>

                {/* Header Skeleton - Fixed */}
                <div className="fixed top-0 right-0 left-0 md:left-64 h-14 border-b bg-background z-30 flex items-center justify-between px-6">
                    <Skeleton className="h-5 w-48" />
                    <div className="flex gap-4">
                        <Skeleton className="h-9 w-9 rounded-full" />
                        <Skeleton className="h-9 w-9 rounded-full" />
                    </div>
                </div>

                {/* Main Content Skeleton */}
                <main className="pt-14 transition-all duration-300 ml-0 md:ml-64">
                    <ContentSkeleton showBreadcrumbs={true} className="p-6" />
                </main>
            </div>
        );
    }

    return <>{children}</>;
}
</file>

<file path="frontend2/components/command-menu.tsx">
"use client"
import React, { useState } from "react";
import { Search } from "lucide-react"
import {
    CommandDialog,
    CommandEmpty,
    CommandGroup,
    CommandInput,
    CommandItem,
    CommandList,
    CommandSeparator,
} from "@/components/ui/command";
import { Kbd } from "@/components/ui/kbd"

import { commandSections } from "@/lib/command-menu-data"
import { Button } from "@/components/ui/button";

export function CommandMenu() {
    const [open, setOpen] = useState(false)
    return (
        <>
            <Button
                variant={"ghost"}
                size={"icon"}
                className="md:hidden"
                onClick={() => (setOpen(true))}
            >
                <Search className="size-4.5" />
            </Button>

            <Button
                variant="outline"
                onClick={() => (setOpen(true))}
                className="hidden w-90 justify-start text-muted-foreground md:flex border-none hover:bg-muted"
            >
                <Search className="mr-2 h-4 w-4" />
                <span className="flex-1 text-left">Buscar</span>
            </Button>


            <CommandDialog open={open} onOpenChange={setOpen}>
                <CommandInput placeholder="Buscar" />
                <CommandList>
                    <CommandEmpty>Resultados no encontrados</CommandEmpty>
                    {commandSections.map((section, index) => (
                        <React.Fragment key={section.heading}>
                            {index > 0 && <CommandSeparator />}
                            <CommandGroup heading={section.heading}>
                                {section.items.map(item => {
                                    return (
                                        <CommandItem key={item.name} onSelect={() => setOpen(!open)}>
                                            <item.icon />
                                            <span>{item.name}</span>
                                        </CommandItem>
                                    )
                                })}
                            </CommandGroup>
                        </React.Fragment>
                    ))}
                </CommandList>
            </CommandDialog>
        </>
    );
}
</file>

<file path="frontend2/components/iutirla-logo.tsx">
import Image from "next/image";
import { cn } from "@/lib/utils";

interface IutirlaLogoProps {
    collapsed?: boolean;
    className?: string;
}

export function IutirlaLogo({ collapsed, className }: IutirlaLogoProps) {
    return (
        <div className={cn("flex items-center gap-1 cursor-pointer", className)}>
            <div className={cn("flex items-center justify-center shrink-0", collapsed ? "w-16 h-14" : "ml-3 h-14")}>
                <Image
                    src="/images/logoiutirla.webp"
                    alt="Logo de IUTIRLA"
                    width={256}
                    height={351}
                    className="h-10 w-auto"
                />
            </div>
            {!collapsed && (
                <div className="relative h-10 flex items-center font-montserrat text-2xl italic font-bold animate-in fade-in duration-300 whitespace-nowrap">
                    <span>IUTIRLA</span>
                    <span className="absolute top-0 font-semibold -right-4 text-[8px]">HCM</span>
                </div>
            )}
        </div>
    )
}
</file>

<file path="frontend2/components/login-form.tsx">
"use client";

import { cn } from "@/lib/utils"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import Link from "next/link"
import { useAuth } from "@/context/auth-context"
import { useState } from "react"
import { Loader2, AlertCircle } from "lucide-react"
import { Alert, AlertDescription, AlertTitle } from "@/components/ui/alert"
import { zodResolver } from "@hookform/resolvers/zod"
import { useForm } from "react-hook-form"
import { z } from "zod"
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from "@/components/ui/form"

const formSchema = z.object({
  username: z.string().min(1, {
    message: "El usuario es requerido.",
  }),
  password: z.string().min(1, {
    message: "La contraseña es requerida.",
  }),
})

export function LoginForm({
  className,
  ...props
}: React.ComponentProps<"div">) {
  const { login } = useAuth();
  const [error, setError] = useState<string | null>(null);
  const [isLoading, setIsLoading] = useState(false);

  const form = useForm<z.infer<typeof formSchema>>({
    resolver: zodResolver(formSchema),
    defaultValues: {
      username: "",
      password: "",
    },
  })

  async function onSubmit(values: z.infer<typeof formSchema>) {
    setError(null);
    setIsLoading(true);

    try {
      await login(values.username, values.password);
    } catch (err: any) {
      // console.error("Login error:", err);
      if (err.response) {
        if (err.response.status === 400) {
          // Field validation errors
          const data = err.response.data;
          if (data.non_field_errors) {
            setError(data.non_field_errors[0]);
          } else if (data.detail) {
            setError(data.detail);
          } else {
            // Set field errors in react-hook-form
            Object.keys(data).forEach((key) => {
              if (key === "username" || key === "password") {
                form.setError(key as "username" | "password", {
                  type: "manual",
                  message: data[key][0],
                });
              }
            });
          }
        } else if (err.response.status === 401) {
          const data = err.response.data;
          setError(data.detail || "Credenciales inválidas. Por favor verifique su usuario y contraseña.");
        } else {
          setError("Ocurrió un error al iniciar sesión. Intente nuevamente.");
        }
      } else {
        setError("Error de conexión. Verifique su internet.");
      }
    } finally {
      setIsLoading(false);
    }
  }

  return (
    <div className={cn("flex flex-col gap-6", className)} {...props}>
      <div className="flex flex-col items-center gap-2 text-center">
        <h1 className="text-2xl font-bold">Iniciar sesión</h1>
        <p className="text-muted-foreground text-sm text-balance">
          Ingrese sus credenciales
        </p>
      </div>

      {error && (
        <Alert variant="destructive">
          <AlertCircle className="h-4 w-4" />
          <AlertTitle>Error</AlertTitle>
          <AlertDescription>
            {error}
          </AlertDescription>
        </Alert>
      )}

      <Form {...form}>
        <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
          <FormField
            control={form.control}
            name="username"
            render={({ field }) => (
              <FormItem>
                <FormLabel>Usuario</FormLabel>
                <FormControl>
                  <Input placeholder="" {...field} disabled={isLoading} />
                </FormControl>
                <FormMessage />
              </FormItem>
            )}
          />
          <FormField
            control={form.control}
            name="password"
            render={({ field }) => (
              <FormItem>
                <FormLabel>Contraseña</FormLabel>
                <FormControl>
                  <Input type="password" placeholder="" {...field} disabled={isLoading} />
                </FormControl>
                <FormMessage />
              </FormItem>
            )}
          />

          <div className="pt-2">
            <Button type="submit" disabled={isLoading} className="w-full bg-brand-primary hover:bg-brand-primary/90">
              {isLoading ? (
                <>
                  <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                  Iniciando...
                </>
              ) : (
                "Iniciar sesión"
              )}
            </Button>
          </div>

          <div className="flex justify-end">
            <Link href="#" className="text-sm text-end underline-offset-4 hover:underline hover:text-primary">
              ¿Olvidaste tu contraseña?
            </Link>
          </div>
        </form>
      </Form>
    </div>
  )
}
</file>

<file path="frontend2/components/notifications-sheet.tsx">
import { Button } from "@/components/ui/button";
import {
    Sheet,
    SheetContent,
    SheetDescription,
    SheetHeader,
    SheetTitle,
    SheetTrigger,
} from "@/components/ui/sheet";
import { Bell, Check, Info, AlertTriangle, XCircle, CheckCircle2 } from "lucide-react";
import { cn } from "@/lib/utils";

const notifications = [
    {
        id: 1,
        title: "Solicitud aprobada",
        description: "Tu solicitud de vacaciones ha sido aprobada por RRHH.",
        time: "Hace 5 min",
        read: false,
        type: "success"
    },
    {
        id: 2,
        title: "Recordatorio de reunión",
        description: "Reunión de equipo en 15 minutos en la sala de conferencias.",
        time: "Hace 15 min",
        read: false,
        type: "info"
    },
    {
        id: 3,
        title: "Actualización del sistema",
        description: "El sistema estará en mantenimiento este sábado a las 10 PM.",
        time: "Hace 2 horas",
        read: true,
        type: "warning"
    },
    {
        id: 4,
        title: "Error en carga de archivo",
        description: "El archivo 'reporte_mensual.pdf' no se pudo procesar.",
        time: "Ayer",
        read: true,
        type: "error"
    }
];

export function NotificationsSheet() {
    return (
        <Sheet>
            <SheetTrigger asChild>
                <Button variant="ghost" size="icon" aria-label="Notificaciones" className="text-primary-foreground hover:bg-primary-foreground/10 hover:text-primary-foreground relative">
                    <Bell className="size-5" />
                    <span className="absolute top-2 right-2 size-2 bg-destructive rounded-full border-2 border-primary" />
                </Button>
            </SheetTrigger>

            <SheetContent className="w-[400px] sm:w-[540px] flex flex-col h-full py-6 px-4">
                <SheetHeader className="pb-4 border-b border-border">
                    <div className="flex items-center justify-between">
                        <SheetTitle className="flex items-center gap-2 text-xl">
                            <Bell className="size-5 text-brand-primary" />
                            <span>Notificaciones</span>
                        </SheetTitle>
                        {/* <Button variant="ghost" size="sm" className="text-xs text-muted-foreground hover:text-brand-primary">
                            Marcar todo como leído
                        </Button> */}
                    </div>
                </SheetHeader>

                <div className="flex-1 overflow-y-auto">
                    <div className="space-y-1">
                        {notifications.map((notification) => (
                            <div
                                key={notification.id}
                                className={cn(
                                    "flex gap-4 p-4 rounded-xl transition-colors cursor-pointer",
                                    notification.read ? "hover:bg-muted/50" : "bg-brand-primary/5 hover:bg-brand-primary/10"
                                )}
                            >
                                <div className={cn(
                                    "mt-1 size-8 rounded-full flex items-center justify-center shrink-0",
                                    notification.type === "success" ? "bg-green-100 text-green-600" :
                                        notification.type === "warning" ? "bg-yellow-100 text-yellow-600" :
                                            notification.type === "error" ? "bg-red-100 text-red-600" :
                                                "bg-blue-100 text-blue-600"
                                )}>
                                    {notification.type === "success" && <CheckCircle2 className="size-4" />}
                                    {notification.type === "warning" && <AlertTriangle className="size-4" />}
                                    {notification.type === "error" && <XCircle className="size-4" />}
                                    {notification.type === "info" && <Info className="size-4" />}
                                </div>

                                <div className="flex-1 space-y-1">
                                    <div className="flex items-start --justify-between gap-2">
                                        <p className={cn("text-sm font-medium leading-none", !notification.read && "text-brand-primary")}>
                                            {notification.title}
                                        </p>
                                        <span className="text-xs text-muted-foreground shrink-0">
                                            {notification.time}
                                        </span>
                                    </div>
                                    <p className="text-sm text-muted-foreground line-clamp-2">
                                        {notification.description}
                                    </p>
                                </div>

                                {!notification.read && (
                                    <div className="mt-2 size-2 bg-brand-primary rounded-full shrink-0" />
                                )}
                            </div>
                        ))}
                    </div>
                </div>

                <div className="flex flex-col items-end">
                    <Button variant="ghost" size="sm" className="text-xs text-muted-foreground hover:text-brand-primary">
                        Marcar todo como leído
                    </Button>
                    <div className="w-full pt-4 mt-auto border-t border-border">
                        <Button variant="outline" className="w-full">
                            Ver historial completo
                        </Button>
                    </div>
                </div>
            </SheetContent>
        </Sheet>
    );
}
</file>

<file path="frontend2/components/protected-route.tsx">
"use client";

import { useAuth } from "@/context/auth-context";
import { useRouter, usePathname } from "next/navigation";
import { useEffect } from "react";
import { AuthLoading } from "./auth-loading";

interface ProtectedRouteProps {
    children: React.ReactNode;
    requireAdmin?: boolean;
}

export function ProtectedRoute({ children, requireAdmin = false }: ProtectedRouteProps) {
    const { user, isLoading } = useAuth();
    const router = useRouter();
    const pathname = usePathname();

    useEffect(() => {
        if (!isLoading) {
            let targetPath = null;

            if (!user) {
                targetPath = `/login?returnUrl=${encodeURIComponent(pathname)}`;
            } else if (requireAdmin && !user.is_staff) {
                targetPath = '/';
            }

            if (targetPath) {
                router.replace(targetPath);
            }
        }
    }, [user, isLoading, requireAdmin, router, pathname]);

    const isAuthenticated = user && (!requireAdmin || user.is_staff);

    if (isLoading || !isAuthenticated) {
        // Reuse the AuthLoading component for consistency, or just show nothing while redirecting
        // Since AuthLoading handles isLoading internally, we can use it here if we want the skeleton
        // But here we might want to block rendering until we are sure.
        // If !isAuthenticated and !isLoading, we are redirecting, so showing a loader or skeleton is fine.
        return (
            <AuthLoading>
                <div />
            </AuthLoading>
        );
    }

    return <>{children}</>;
}
</file>

<file path="frontend2/components/providers.tsx">
"use client";

import { AuthProvider } from "@/context/auth-context";
import { AuthLoading } from "@/components/auth-loading";
import { Toaster } from "@/components/ui/sonner";

export function Providers({ children }: { children: React.ReactNode }) {
    return (
        <AuthProvider>
            <AuthLoading>
                {children}
                <Toaster position="top-center" theme="light" richColors />
            </AuthLoading>
        </AuthProvider>
    );
}
</file>

<file path="frontend2/components/task-sheet.tsx">
import { Button } from "@/components/ui/button";
import {
    Sheet,
    SheetContent,
    SheetDescription,
    SheetHeader,
    SheetTitle,
    SheetTrigger,
} from "@/components/ui/sheet";
import { CheckCircle, Clock, AlertCircle, ArrowRight } from "lucide-react";
import { cn } from "@/lib/utils";

const tasks = [
    {
        id: 1,
        title: "Revisar nómina quincenal",
        status: "pending",
        priority: "high",
        dueDate: "Hoy, 5:00 PM"
    },
    {
        id: 2,
        title: "Aprobar vacaciones de J. Pérez",
        status: "in-progress",
        priority: "medium",
        dueDate: "Mañana, 10:00 AM"
    },
    {
        id: 3,
        title: "Actualizar manual de organización",
        status: "pending",
        priority: "low",
        dueDate: "Viernes, 12:00 PM"
    },
    {
        id: 4,
        title: "Entrevista con candidato Sr.",
        status: "completed",
        priority: "high",
        dueDate: "Ayer"
    }
];

export function TaskSheet() {
    return (
        <Sheet>
            <SheetTrigger asChild>
                <Button variant="ghost" size="icon" aria-label="Tareas" className="text-primary-foreground hover:bg-primary-foreground/10 hover:text-primary-foreground">
                    <CheckCircle className="size-5" />
                </Button>
            </SheetTrigger>

            <SheetContent className="w-[400px] sm:w-[540px] flex flex-col h-full py-6 px-4">
                <SheetHeader className="pb-4 border-b border-border">
                    <SheetTitle className="flex items-center gap-2 text-xl">
                        <CheckCircle className="size-5 text-brand-primary" />
                        <span>Lista de tareas</span>
                    </SheetTitle>
                </SheetHeader>

                <div className="flex-1 overflow-y-auto">
                    <div className="space-y-4">
                        {tasks.map((task) => (
                            <div
                                key={task.id}
                                className="group flex items-start gap-3 p-4 rounded-xl border border-border bg-card hover:shadow-md hover:border-brand-primary/50 transition-all duration-200"
                            >
                                <div className={cn(
                                    "mt-1 size-2 rounded-full shrink-0",
                                    task.priority === "high" ? "bg-destructive" :
                                        task.priority === "medium" ? "bg-brand-tertiary" :
                                            "bg-brand-secondary"
                                )} />

                                <div className="flex-1 min-w-0">
                                    <h4 className={cn(
                                        "text-sm font-semibold text-foreground mb-1 group-hover:text-brand-primary transition-colors",
                                        task.status === "completed" && "line-through text-muted-foreground"
                                    )}>
                                        {task.title}
                                    </h4>

                                    <div className="flex items-center gap-3 text-xs text-muted-foreground">
                                        <div className="flex items-center gap-1">
                                            <Clock className="size-3" />
                                            <span>{task.dueDate}</span>
                                        </div>

                                        <span className={cn(
                                            "px-2 py-0.5 rounded-full text-[10px] font-medium capitalize",
                                            task.status === "pending" ? "bg-brand-tertiary/10 text-brand-tertiary" :
                                                task.status === "in-progress" ? "bg-brand-primary/10 text-brand-primary" :
                                                    "bg-brand-secondary/10 text-brand-secondary"
                                        )}>
                                            {task.status === "in-progress" ? "En curso" :
                                                task.status === "pending" ? "Pendiente" : "Completada"}
                                        </span>
                                    </div>
                                </div>

                                <Button variant="ghost" size="icon" className="h-8 w-8 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <ArrowRight className="size-4 text-muted-foreground hover:text-foreground" />
                                </Button>
                            </div>
                        ))}
                    </div>
                </div>

                <div className="pt-4 mt-auto border-t border-border">
                    <Button className="w-full bg-brand-primary hover:bg-brand-primary/90 text-white">
                        Ver todas las tareas
                    </Button>
                </div>
            </SheetContent>
        </Sheet>
    );
}
</file>

<file path="frontend2/components/user-menu.tsx">
'use client';

import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import {
    DropdownMenu,
    DropdownMenuContent,
    DropdownMenuItem,
    DropdownMenuLabel,
    DropdownMenuSeparator,
    DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { Button } from "@/components/ui/button";
import Link from "next/link";
import { LogOut, User, Settings } from "lucide-react";

import { useAuth } from "@/context/auth-context";

export function UserMenu() {
    const { user, logout } = useAuth();

    const displayName = user?.person
        ? `${user.person.first_name} ${user.person.paternal_surname}`
        : user?.username || "Usuario";

    const getInitials = () => {
        if (user?.person) {
            const first = user.person.first_name[0];
            const last = user.person.paternal_surname[0];
            return `${first}${last}`.toUpperCase();
        }
        return user?.username?.slice(0, 2).toUpperCase() || "U";
    };

    return (
        <DropdownMenu>
            <DropdownMenuTrigger asChild>
                <Button variant="ghost" className="relative size-10 rounded-full ring-2 ring-primary-foreground/20 hover:ring-primary-foreground/40">
                    <Avatar>
                        <AvatarImage
                            src={user?.person?.photo || undefined}
                            alt={displayName}
                        />
                        <AvatarFallback className="bg-primary-foreground text-primary">{getInitials()}</AvatarFallback>
                    </Avatar>
                </Button>
            </DropdownMenuTrigger>

            <DropdownMenuContent align="end" className="w-56">
                <DropdownMenuLabel className="font-normal">
                    <div className="flex flex-col space-y-1">
                        <p className="text-sm font-medium leading-none">{displayName}</p>
                        <p className="text-xs leading-none text-muted-foreground">
                            @{user?.username}
                        </p>
                    </div>
                </DropdownMenuLabel>
                <DropdownMenuSeparator />

                <DropdownMenuItem asChild>
                    <Link href="/profile" className="cursor-pointer w-full flex items-center">
                        <User className="mr-2 h-4 w-4" />
                        <span>Perfil</span>
                    </Link>
                </DropdownMenuItem>

                <DropdownMenuItem asChild>
                    <Link href="/settings" className="cursor-pointer w-full flex items-center">
                        <Settings className="mr-2 h-4 w-4" />
                        <span>Ajustes</span>
                    </Link>
                </DropdownMenuItem>

                <DropdownMenuSeparator />

                <DropdownMenuItem
                    onClick={logout}
                    className="text-red-600 focus:text-red-600 cursor-pointer"
                >
                    <LogOut className="mr-2 h-4 w-4" />
                    <span>Cerrar sesión</span>
                </DropdownMenuItem>
            </DropdownMenuContent>
        </DropdownMenu>
    );
}
</file>

<file path="frontend2/context/auth-context.tsx">
'use client';

import { createContext, useState, useContext, useEffect, ReactNode } from "react";
import apiClient from "../lib/api-client";
import { useRouter } from "next/navigation";

// --- Tipos ---

// Definimos Person alineado con tu backend
export interface Person {
    id: number;
    first_name: string;
    second_name?: string | null;
    paternal_surname: string;
    maternal_surname?: string | null;
    photo?: string | null;
    birthdate?: string | null;
}

// Definimos User alineado con tu backend
export interface User {
    pk: number;
    username: string;
    is_staff: boolean;
    person: Person | null;
}

interface AuthContextType {
    user: User | null;
    isLoading: boolean;
    login: (username: string, password: string) => Promise<void>;
    logout: () => void;
}

const AuthContext = createContext<AuthContextType | null>(null);

export const AuthProvider = ({ children }: { children: ReactNode }) => {
    const [user, setUser] = useState<User | null>(null);
    const [isLoading, setIsLoading] = useState(true);
    const router = useRouter();

    // 1. Inicialización: Recuperar sesión y refrescar datos
    useEffect(() => {
        const initAuth = async () => {
            const storedToken = localStorage.getItem("access_token");

            if (storedToken) {
                try {
                    // 1. Restaurar header
                    if (apiClient.defaults.headers.common) {
                        apiClient.defaults.headers.common["Authorization"] = `Bearer ${storedToken}`;
                    }

                    // 2. Obtener datos frescos del usuario
                    const { data } = await apiClient.get("/api/auth/user/");

                    // 3. Actualizar estado y storage
                    setUser(data);
                    localStorage.setItem("user", JSON.stringify(data));

                } catch (e: any) {
                    console.error("Error validando sesión", e);
                    // Si el token es inválido (401/403), cerramos sesión
                    if (e.response && (e.response.status === 401 || e.response.status === 403)) {
                        localStorage.removeItem("user");
                        localStorage.removeItem("access_token");
                        if (apiClient.defaults.headers.common) {
                            delete apiClient.defaults.headers.common["Authorization"];
                        }
                        setUser(null);
                    } else {
                        // Si es otro error (ej. red), intentamos usar lo que hay en storage como fallback
                        const storedUser = localStorage.getItem("user");
                        if (storedUser) {
                            try {
                                setUser(JSON.parse(storedUser));
                            } catch (parseError) {
                                console.error("Error parsing stored user fallback", parseError);
                            }
                        }
                    }
                }
            }
            setIsLoading(false);
        };

        initAuth();
    }, []);

    // 2. Login
    const login = async (username: string, password: string) => {
        try {
            // Solicitud al backend
            const response = await apiClient.post("/api/auth/login/", {
                username,
                password,
            });

            const { access, user: userData } = response.data;
            const typedUser = userData as User;

            // Actualizar Estados y Storage
            setUser(typedUser);
            localStorage.setItem("user", JSON.stringify(typedUser));
            localStorage.setItem("access_token", access);

            // Configurar Axios para futuras peticiones
            if (apiClient.defaults.headers.common) {
                apiClient.defaults.headers.common["Authorization"] = `Bearer ${access}`;
            }

            // Redirección basada en rol
            if (typedUser.is_staff) {
                router.push("/admin/dashboard");
            } else {
                router.push("/");
            }

        } catch (error) {
            throw error;
        }
    };

    // 3. Logout
    const logout = async () => {
        try {
            await apiClient.post("/api/auth/logout/");
        } catch (error) {
            console.warn("Logout en servidor falló, cerrando sesión local.", error);
        } finally {
            setUser(null);
            localStorage.removeItem("user");
            localStorage.removeItem("access_token");

            if (apiClient.defaults.headers.common) {
                delete apiClient.defaults.headers.common["Authorization"];
            }

            router.push("/login");
        }
    };

    return (
        <AuthContext.Provider value={{ user, login, logout, isLoading }}>
            {children}
        </AuthContext.Provider>
    );
};

export const useAuth = () => {
    const context = useContext(AuthContext);
    if (!context) {
        throw new Error("useAuth debe usarse dentro de un AuthProvider");
    }
    return context;
};
</file>

<file path="frontend2/context/breadcrumb-context.tsx">
"use client";

import React, { createContext, useContext, useState, useCallback } from "react";

interface BreadcrumbContextType {
    labels: Record<string, string>;
    setLabel: (segment: string, label: string) => void;
}

const BreadcrumbContext = createContext<BreadcrumbContextType | undefined>(undefined);

export function BreadcrumbProvider({ children }: { children: React.ReactNode }) {
    const [labels, setLabels] = useState<Record<string, string>>({});

    const setLabel = useCallback((segment: string, label: string) => {
        setLabels((prev) => {
            if (prev[segment] === label) return prev;
            return { ...prev, [segment]: label };
        });
    }, []);

    return (
        <BreadcrumbContext.Provider value={{ labels, setLabel }}>
            {children}
        </BreadcrumbContext.Provider>
    );
}

export function useBreadcrumb() {
    const context = useContext(BreadcrumbContext);
    if (context === undefined) {
        throw new Error("useBreadcrumb must be used within a BreadcrumbProvider");
    }
    return context;
}
</file>

<file path="frontend2/lib/api-client.ts">
import axios, { AxiosError, InternalAxiosRequestConfig, AxiosResponse } from "axios";

// Definimos la estructura de los items en la cola de espera
interface QueueItem {
    resolve: (token: string) => void;
    reject: (error: unknown) => void;
}

// Usamos variable de entorno para no quemar la URL
const baseURL = process.env.NEXT_PUBLIC_API_URL || "http://127.0.0.1:8000";

const apiClient = axios.create({
    baseURL: baseURL,
    withCredentials: true,
    headers: {
        "Content-Type": "application/json",
    },
});

// --- Variables para el Bloqueo de Concurrencia ---
let isRefreshing = false;
let failedQueue: QueueItem[] = [];

// Función para procesar la cola. Recibe un error (si falló) o el nuevo token.
const processQueue = (error: AxiosError | null, token: string | null = null) => {
    failedQueue.forEach((prom) => {
        if (error) {
            prom.reject(error);
        } else if (token) {
            prom.resolve(token);
        }
    });
    failedQueue = [];
};

// --- Interceptor de Petición ---
apiClient.interceptors.request.use(
    (config: InternalAxiosRequestConfig) => {
        // No inyectar token en rutas de auth para evitar conflictos
        if (config.url && (config.url.includes("/auth/login") || config.url.includes("/auth/register"))) {
            return config;
        }

        // Validamos que estemos en el cliente
        if (typeof window !== "undefined") {
            const accessToken = localStorage.getItem("access_token");
            if (accessToken) {
                config.headers.set("Authorization", `Bearer ${accessToken}`);
            }
        }
        return config;
    },
    (error: AxiosError) => Promise.reject(error)
);

// --- Interceptor de Respuesta ---
apiClient.interceptors.response.use(
    (response: AxiosResponse) => response,
    async (error: AxiosError) => {
        const originalRequest = error.config as InternalAxiosRequestConfig & { _retry?: boolean };

        // Si no hay request original (error de red raro), rechazamos
        if (!originalRequest) {
            return Promise.reject(error);
        }

        // 1. PROTECCIÓN ANTI-BUCLE: Si el error viene del refresh endpoint, es el fin.
        if (originalRequest.url?.includes("/token/refresh/")) {
            if (typeof window !== "undefined") {
                localStorage.removeItem("access_token");
                localStorage.removeItem("user");
                window.location.href = '/login';
            }
            return Promise.reject(error);
        }

        // 2. Detección de 401 (Token vencido)
        // Ignoramos 401 si viene del login, ya que eso significa credenciales inválidas, no token vencido.
        if (error.response?.status === 401 && !originalRequest._retry && !originalRequest.url?.includes("/auth/login")) {

            // CASO A: Ya se está refrescando. A la cola.
            if (isRefreshing) {
                return new Promise<AxiosResponse>((resolve, reject) => {
                    failedQueue.push({
                        resolve: (token: string) => {
                            originalRequest.headers.set("Authorization", `Bearer ${token}`);
                            resolve(apiClient(originalRequest));
                        },
                        reject: (err: unknown) => reject(err)
                    });
                });
            }

            // CASO B: Iniciamos el refresco.
            originalRequest._retry = true;
            isRefreshing = true;

            try {
                // Petición de refresco
                const response = await apiClient.post<{ access: string }>("/api/auth/token/refresh/");
                const newAccessToken = response.data.access;

                if (typeof window !== "undefined") {
                    localStorage.setItem("access_token", newAccessToken);
                }

                // Actualizamos defaults
                apiClient.defaults.headers.common["Authorization"] = `Bearer ${newAccessToken}`;

                // Procesamos la cola
                processQueue(null, newAccessToken);

                // Reintentamos la original
                originalRequest.headers.set("Authorization", `Bearer ${newAccessToken}`);
                return apiClient(originalRequest);

            } catch (refreshError) {
                // Si falla, rechazamos toda la cola con el error correspondiente
                // Casteamos a AxiosError si es posible, o pasamos el error tal cual
                const axiosError = refreshError instanceof AxiosError ? refreshError : new AxiosError("Refresh failed");
                processQueue(axiosError, null);

                if (typeof window !== "undefined") {
                    localStorage.removeItem("access_token");
                    localStorage.removeItem("user");
                    window.location.href = '/login';
                }
                return Promise.reject(refreshError);

            } finally {
                isRefreshing = false;
            }
        }

        return Promise.reject(error);
    }
);

export default apiClient;
</file>

<file path="frontend2/lib/command-menu-data.ts">
import {
    User,
    Calendar,
    Settings,
    UserCircle,
    Users
} from "lucide-react";

export const commandSections = [
    {
        heading: 'Sugerencias',
        items: [
            {
                name: 'Calendario',
                icon: Calendar
            }
        ]
    },
    {
        heading: 'Ajustes',
        items: [
            {
                name: 'Perfil',
                icon: UserCircle
            },
            {
                name: 'Ajustes',
                icon: Settings
            }
        ]
    },
    {
        heading: 'Usuarios',
        items: [
            {
                name: 'Santiago Fermin',
                icon: User
            }
        ]
    },
    {
        heading: 'Equipos',
        items: [
            {
                name: 'Coordinacion administrativa',
                icon: Users
            }
        ]
    }
];
</file>

<file path="frontend2/lib/fonts.ts">
import { Montserrat } from 'next/font/google'

export const montserrat = Montserrat({
    weight: ['100', '200', '300', '400', '500', '600', '700', '800', '900'],
    style: ['normal', 'italic'],
    subsets: ['latin'],
    variable: '--font-montserrat'
})
</file>

<file path="frontend2/.gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts
</file>

<file path="frontend2/components.json">
{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "new-york",
  "rsc": true,
  "tsx": true,
  "tailwind": {
    "config": "",
    "css": "app/globals.css",
    "baseColor": "neutral",
    "cssVariables": true,
    "prefix": ""
  },
  "iconLibrary": "lucide",
  "aliases": {
    "components": "@/components",
    "utils": "@/lib/utils",
    "ui": "@/components/ui",
    "lib": "@/lib",
    "hooks": "@/hooks"
  },
  "registries": {}
}
</file>

<file path="frontend2/eslint.config.mjs">
import { defineConfig, globalIgnores } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";
import nextTs from "eslint-config-next/typescript";

const eslintConfig = defineConfig([
  ...nextVitals,
  ...nextTs,
  // Override default ignores of eslint-config-next.
  globalIgnores([
    // Default ignores of eslint-config-next:
    ".next/**",
    "out/**",
    "build/**",
    "next-env.d.ts",
  ]),
]);

export default eslintConfig;
</file>

<file path="frontend2/pnpm-workspace.yaml">
ignoredBuiltDependencies:
  - sharp
  - unrs-resolver
</file>

<file path="frontend2/postcss.config.mjs">
const config = {
  plugins: {
    "@tailwindcss/postcss": {},
  },
};

export default config;
</file>

<file path="frontend2/tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts"
  ],
  "exclude": ["node_modules"]
}
</file>

<file path="backend/accounts/migrations/0001_initial.py">
# Generated by Django 5.2.8 on 2025-11-24 08:15

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('auth', '0012_alter_user_first_name_max_length'),
        ('core', '0001_initial'),
    ]

    operations = [
        migrations.CreateModel(
            name='User',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('password', models.CharField(max_length=128, verbose_name='password')),
                ('last_login', models.DateTimeField(blank=True, null=True, verbose_name='last login')),
                ('is_superuser', models.BooleanField(default=False, help_text='Designates that this user has all permissions without explicitly assigning them.', verbose_name='superuser status')),
                ('username', models.CharField(error_messages={'blank': 'El nombre de usuario es obligatorio.', 'unique': 'Este nombre de usuario ya está registrado.'}, max_length=100, unique=True)),
                ('is_active', models.BooleanField(default=True)),
                ('is_staff', models.BooleanField(default=False)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('groups', models.ManyToManyField(blank=True, help_text='The groups this user belongs to. A user will get all permissions granted to each of their groups.', related_name='user_set', related_query_name='user', to='auth.group', verbose_name='groups')),
                ('person', models.OneToOneField(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='user_account', to='core.person')),
                ('user_permissions', models.ManyToManyField(blank=True, help_text='Specific permissions for this user.', related_name='user_set', related_query_name='user', to='auth.permission', verbose_name='user permissions')),
            ],
            options={
                'abstract': False,
            },
        ),
    ]
</file>

<file path="backend/ats/services.py">
from django.db import transaction
from django.db.models import F
from django.core.exceptions import ValidationError
from core.models import Person
from talent.models import PersonEducation, EducationLevel, FieldOfStudy
from employment.models import (
    Employment, 
    RoleChoices, 
    EmploymentTypeChoices, 
    EmploymentStatusChoices
)
from .models import Candidate, CandidateEducation


@transaction.atomic
def hire_candidate(candidate, hire_data):
    """
    Transacción atómica para contratar un candidato.
    
    Proceso:
    1. Validar cupos disponibles
    2. Crear Person (migrar identidad)
    3. Migrar educación a PersonEducation
    4. Crear Employment
    5. Actualizar estado del candidato
    6. Decrementar vacantes
    7. Detectar otros finalistas
    
    Args:
        candidate: Instancia de Candidate
        hire_data: Dict con {hire_date, role, employment_type, employment_status, salary, notes}
                   Ahora los valores son códigos de Choice (ej: 'EMP', 'FIJ', 'ACT')
    
    Returns:
        Dict: {person, employment, other_finalists}
    
    Raises:
        ValidationError: Si no hay cupos disponibles
    """
    
    # 1. Validar cupos disponibles con bloqueo optimista
    position = candidate.job_posting.position
    
    if not position:
        raise ValidationError("La vacante no tiene una posición asignada.")
    
    # Bloqueo de fila para evitar condiciones de carrera
    position = position.__class__.objects.select_for_update().get(pk=position.pk)
    
    if position.vacancies <= 0:
        raise ValidationError(
            f"No hay cupos disponibles para la posición '{position}'. "
            f"Vacantes actuales: {position.vacancies}"
        )
    
    # 2. Migración de identidad (Core) - Crear Person
    # Person solo tiene: first_name, second_name, paternal_surname, maternal_surname, 
    # salutation, gender, marital_status, birthdate, country_of_birth, photo
    person = Person.objects.create(
        first_name=candidate.first_name,
        paternal_surname=candidate.last_name,
        # Los campos opcionales se pueden agregar después
    )
    
    # 2.1 Crear NationalId (cédula) si existe
    if hasattr(candidate, 'national_id') and candidate.national_id:
        from core.models import NationalId
        # Parseamos el national_id del candidato (formato: V-12345678)
        national_id_str = str(candidate.national_id)
        if '-' in national_id_str:
            prefix, number = national_id_str.split('-', 1)
        else:
            prefix = 'V'  # Default
            number = national_id_str
        
        NationalId.objects.create(
            person=person,
            category='CEDULA',
            document_type=prefix,
            number=number,
            is_primary=True
        )
    
    # 2.2 Crear PersonEmail si existe
    if candidate.email:
        from core.models import PersonEmail
        PersonEmail.objects.create(
            person=person,
            email_address=candidate.email,
            is_primary=True
        )
    
    
    # 2.3 Crear PersonPhone si existe
    if hasattr(candidate, 'phone') and candidate.phone:
        from core.models import PersonPhone
        # Parsear el teléfono (asumiendo formato simple number o con código)
        phone_str = str(candidate.phone)
        PersonPhone.objects.create(
            person=person,
            subscriber_number=phone_str,
            is_primary=True
        )
    
    # 3. Migración del CV (simplificado para desarrollo local)
    # El archivo permanece en su ubicación original
    # En producción: aquí se movería a un bucket privado
    
    # 4. Migración de educación (Talent)
    for edu in candidate.education.all():
        # Intentar encontrar EducationLevel y FieldOfStudy existentes
        education_level, _ = EducationLevel.objects.get_or_create(
            name=edu.level_name
        )
        field_of_study, _ = FieldOfStudy.objects.get_or_create(
            name=edu.field_name
        )
        
        PersonEducation.objects.create(
            person=person,
            school_name=edu.school_name,
            level=education_level,
            field_of_study=field_of_study,
            start_date=edu.start_date,
            end_date=edu.end_date
        )
    
    # 5. Validar que los valores de Choice sean válidos
    role = hire_data.get('role', RoleChoices.EMPLOYEE)
    employment_type = hire_data.get('employment_type', EmploymentTypeChoices.PERMANENT)
    employment_status = hire_data.get('employment_status', EmploymentStatusChoices.ACTIVE)
    
    # Validar que sean valores válidos de Choices
    if role not in dict(RoleChoices.choices):
        raise ValidationError(f"Rol inválido: {role}")
    if employment_type not in dict(EmploymentTypeChoices.choices):
        raise ValidationError(f"Tipo de empleo inválido: {employment_type}")
    if employment_status not in dict(EmploymentStatusChoices.choices):
        raise ValidationError(f"Estatus inválido: {employment_status}")
    
    # 6. Crear contrato (Employment)
    employment = Employment.objects.create(
        person=person,
        position=position,
        role=role,
        employment_type=employment_type,
        current_status=employment_status,
        hire_date=hire_data['hire_date'],
        end_date=hire_data.get('end_date')  # Opcional para contratos temporales
    )
    
    # 7. Actualizar estado del candidato
    candidate.stage = 'HIRED'
    candidate.notes = (candidate.notes or '') + f"\n[CONTRATADO] {hire_data['hire_date']}"
    candidate.save()
    
    # 8. Decrementar vacante (de forma atómica)
    # AHORA SE MANEJA AUTOMÁTICAMENTE EN Employment.save()
    # position.refresh_from_db()
    # position.vacancies -= 1
    # position.save()
    
    # 9. Detectar otros finalistas (candidatos en etapas avanzadas)
    other_finalists = Candidate.objects.filter(
        job_posting=candidate.job_posting,
        stage__in=['OFF', 'INT']
    ).exclude(pk=candidate.pk)
    
    return {
        'person': person,
        'employment': employment,
        'other_finalists': list(other_finalists),
        'remaining_vacancies': position.vacancies
    }


def move_finalists_to_pool(candidate_ids):
    """
    Mover candidatos finalistas al banco de elegibles.
    
    Args:
        candidate_ids: Lista de IDs de candidatos
    
    Returns:
        int: Número de candidatos movidos
    """
    updated = Candidate.objects.filter(
        id__in=candidate_ids,
        stage__in=['OFF', 'INT']
    ).update(
        stage='POOL',
        notes=F('notes') + '\n[Movido a Banco de Elegibles automáticamente]'
    )
    
    return updated
</file>

<file path="backend/core/migrations/0001_initial.py">
# Generated by Django 5.2.8 on 2025-11-24 08:15

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
    ]

    operations = [
        migrations.CreateModel(
            name='AddressType',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, max_length=50, unique=True)),
            ],
        ),
        migrations.CreateModel(
            name='Bank',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, max_length=100, unique=True)),
                ('code', models.CharField(error_messages={'unique': 'Ya existe un registro con este código.'}, max_length=4, unique=True)),
            ],
        ),
        migrations.CreateModel(
            name='BankAccountType',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, max_length=50, unique=True)),
            ],
        ),
        migrations.CreateModel(
            name='Country',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, max_length=100, unique=True)),
                ('iso_2', models.CharField(error_messages={'unique': 'Ya existe un registro con este código ISO.'}, help_text='Ej: US, VE.', max_length=2, unique=True)),
                ('phone_prefix', models.CharField(error_messages={'unique': 'Ya existe un país con este prefijo.'}, help_text='Prefijo telefónico (ej: +58).', max_length=10, unique=True)),
            ],
        ),
        migrations.CreateModel(
            name='DisabilityGroup',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, max_length=100, unique=True)),
            ],
        ),
        migrations.CreateModel(
            name='DisabilityStatus',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, max_length=50, unique=True)),
            ],
        ),
        migrations.CreateModel(
            name='DisabilityType',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, max_length=100, unique=True)),
            ],
        ),
        migrations.CreateModel(
            name='EmailType',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, max_length=50, unique=True)),
            ],
        ),
        migrations.CreateModel(
            name='Gender',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, max_length=50, unique=True)),
            ],
        ),
        migrations.CreateModel(
            name='MaritalStatus',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, max_length=50, unique=True)),
            ],
        ),
        migrations.CreateModel(
            name='Person',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('first_name', models.CharField(max_length=100)),
                ('second_name', models.CharField(blank=True, max_length=100, null=True)),
                ('paternal_surname', models.CharField(max_length=100)),
                ('maternal_surname', models.CharField(blank=True, max_length=100, null=True)),
                ('birthdate', models.DateField(blank=True, null=True)),
                ('photo', models.ImageField(blank=True, null=True, upload_to='photos/person/')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('country_of_birth', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.country')),
                ('gender', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.gender')),
                ('marital_status', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.maritalstatus')),
            ],
        ),
        migrations.CreateModel(
            name='PhoneCarrier',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, max_length=50, unique=True)),
            ],
        ),
        migrations.CreateModel(
            name='PhoneType',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, max_length=50, unique=True)),
            ],
        ),
        migrations.CreateModel(
            name='RelationshipType',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, max_length=50, unique=True)),
            ],
        ),
        migrations.CreateModel(
            name='Salutation',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, max_length=50, unique=True)),
            ],
        ),
        migrations.CreateModel(
            name='PersonBankAccount',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('account_number', models.CharField(max_length=20, unique=True)),
                ('is_primary', models.BooleanField(default=False)),
                ('bank', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.bank')),
                ('bank_account_type', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.bankaccounttype')),
                ('person', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='bank_accounts', to='core.person')),
            ],
        ),
        migrations.CreateModel(
            name='PersonDocument',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('file', models.FileField(blank=True, null=True, upload_to='documents/person/')),
                ('description', models.CharField(blank=True, max_length=255, null=True)),
                ('person', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='documents', to='core.person')),
            ],
        ),
        migrations.CreateModel(
            name='PersonEmail',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('email_address', models.EmailField(error_messages={'unique': 'Este correo electrónico ya está registrado.'}, max_length=254, unique=True)),
                ('is_primary', models.BooleanField(default=False)),
                ('email_type', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.emailtype')),
                ('person', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='emails', to='core.person')),
            ],
        ),
        migrations.CreateModel(
            name='PhoneAreaCode',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('code', models.CharField(max_length=5)),
                ('type', models.CharField(max_length=20)),
                ('country', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='core.country')),
                ('carrier', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.phonecarrier')),
            ],
            options={
                'unique_together': {('country', 'code', 'carrier')},
            },
        ),
        migrations.CreateModel(
            name='EmergencyContact',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('first_name', models.CharField(max_length=100)),
                ('second_name', models.CharField(blank=True, max_length=100, null=True)),
                ('paternal_surname', models.CharField(max_length=100)),
                ('maternal_surname', models.CharField(blank=True, max_length=100, null=True)),
                ('phone_number', models.CharField(max_length=10)),
                ('is_primary', models.BooleanField(default=False)),
                ('person', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='emergency_contacts', to='core.person')),
                ('phone_area_code', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.phoneareacode')),
                ('relationship', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.relationshiptype')),
            ],
        ),
        migrations.AddField(
            model_name='person',
            name='salutation',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.salutation'),
        ),
        migrations.CreateModel(
            name='State',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=100)),
                ('country', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='core.country')),
            ],
            options={
                'unique_together': {('country', 'name')},
            },
        ),
        migrations.CreateModel(
            name='Address',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('city', models.CharField(max_length=100)),
                ('postal_code', models.CharField(blank=True, max_length=20, null=True)),
                ('street_name_and_number', models.CharField(max_length=255)),
                ('extra_address_line', models.CharField(blank=True, max_length=255, null=True)),
                ('house_number', models.CharField(blank=True, max_length=50, null=True)),
                ('apartment', models.CharField(blank=True, max_length=50, null=True)),
                ('street_2', models.CharField(blank=True, max_length=255, null=True)),
                ('address_type', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.addresstype')),
                ('country', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.country')),
                ('person', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='addresses', to='core.person')),
                ('state', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.state')),
            ],
        ),
        migrations.CreateModel(
            name='PersonDisabilityVE',
            fields=[
                ('person', models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, primary_key=True, serialize=False, to='core.person')),
                ('date_learned', models.DateField(blank=True, null=True)),
                ('disability_degree', models.CharField(blank=True, max_length=50, null=True)),
                ('issuing_authority', models.CharField(blank=True, max_length=100, null=True)),
                ('reference_number', models.CharField(blank=True, max_length=50, null=True)),
                ('date_of_determination', models.DateField(blank=True, null=True)),
                ('disability_group', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.disabilitygroup')),
                ('disability_status', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.disabilitystatus')),
                ('disability_type', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.disabilitytype')),
            ],
        ),
        migrations.CreateModel(
            name='NationalId',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('category', models.CharField(choices=[('CEDULA', 'Cédula de Identidad'), ('RIF', 'RIF'), ('PASSPORT', 'Pasaporte')], default='CEDULA', max_length=10)),
                ('document_type', models.CharField(choices=[('V', 'V - Venezolano / Persona Natural'), ('E', 'E - Extranjero / Persona Natural'), ('J', 'J - Jurídico'), ('G', 'G - Gubernamental'), ('P', 'P - Pasaporte')], default='V', max_length=1, verbose_name='Prefijo')),
                ('number', models.CharField(help_text='Solo números.', max_length=20)),
                ('is_primary', models.BooleanField(default=False)),
                ('file', models.FileField(blank=True, null=True, upload_to='documents/national_id/')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('person', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='national_ids', to='core.person')),
            ],
            options={
                'unique_together': {('document_type', 'number'), ('person', 'category')},
            },
        ),
        migrations.CreateModel(
            name='PersonNationality',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('country', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='core.country')),
                ('person', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='nationalities', to='core.person')),
            ],
            options={
                'unique_together': {('person', 'country')},
            },
        ),
        migrations.CreateModel(
            name='PersonPhone',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('subscriber_number', models.CharField(max_length=10)),
                ('is_primary', models.BooleanField(default=False)),
                ('person', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='phones', to='core.person')),
                ('area_code', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.phoneareacode')),
                ('phone_type', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.phonetype')),
            ],
            options={
                'constraints': [models.UniqueConstraint(fields=('area_code', 'subscriber_number'), name='phone_unique', violation_error_message='Este número de teléfono ya se encuentra registrado.'), models.UniqueConstraint(condition=models.Q(('is_primary', True)), fields=('person',), name='one_primary_phone_per_person', violation_error_message='La persona ya tiene un teléfono principal registrado.')],
            },
        ),
        migrations.CreateModel(
            name='Dependent',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('first_name', models.CharField(max_length=100)),
                ('second_name', models.CharField(blank=True, max_length=100, null=True)),
                ('paternal_surname', models.CharField(max_length=100)),
                ('maternal_surname', models.CharField(blank=True, max_length=100, null=True)),
                ('birthdate', models.DateField()),
                ('gender', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.gender')),
                ('person', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='dependents', to='core.person')),
                ('relationship', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='core.relationshiptype')),
            ],
            options={
                'unique_together': {('person', 'first_name', 'paternal_surname')},
            },
        ),
    ]
</file>

<file path="backend/core/apps.py">
from django.apps import AppConfig
from django.db.backends.signals import connection_created
from django.db.models import Transform
from django.db.models import CharField, TextField

class Unaccent(Transform):
    lookup_name = 'unaccent'
    function = 'unaccent'

def register_sqlite_functions(sender, connection, **kwargs):
    if connection.vendor == 'sqlite':
        from .db_utils import remove_accents
        connection.connection.create_function("unaccent", 1, remove_accents)

class CoreConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'core'

    def ready(self):
        connection_created.connect(register_sqlite_functions)
        CharField.register_lookup(Unaccent)
        TextField.register_lookup(Unaccent)
</file>

<file path="backend/core/filters.py">
from rest_framework import filters
from .db_utils import remove_accents

class UnaccentSearchFilter(filters.SearchFilter):
    def get_search_fields(self, view, request):
        """
        Search fields are obtained from the view, but the request can override them
        with a specific field using the 'search_field' query parameter.
        """
        search_field = request.query_params.get('search_field')
        allowed_fields = getattr(view, 'search_fields', [])
        
        if search_field and search_field in allowed_fields:
            return [search_field]
            
        return allowed_fields

    def get_search_terms(self, request):
        """
        Search terms are set by a ?search=... query parameter.
        We treat the entire query as a single phrase to support exact substring matching
        (respecting spaces), while ignoring accents and case.
        """
        params = request.query_params.get(self.search_param, '')
        if not params:
            return []
        
        # Apply remove_accents to the entire phrase, preserving spaces
        return [remove_accents(params)]

    def filter_queryset(self, request, queryset, view):
        search_terms = self.get_search_terms(request)

        if not search_terms:
            return queryset

        # Standard Django filtering (will work if DB supports unaccent or exact match)
        # However, since we stripped accents from terms, exact match against accented DB fails.
        # And SQLite doesn't support unaccent lookup.
        
        # Try standard filtering first (in case we move to Postgres later or have unaccent lookup)
        # But for now, we need to force a match.
        
        # If we are on SQLite (or just generally want to support this without extensions),
        # and the dataset is small (like catalogs), we can filter in Python.
        # This is inefficient for large tables but fine for Departments/JobTitles.
        
        # Check if we should use python fallback
        use_python_fallback = True # We can make this conditional on DB engine if needed

        if use_python_fallback:
            # Get all objects (this hits the DB)
            # We optimize by only fetching if search terms exist
            
            # Note: This breaks pagination if done naively on large sets, 
            # but for catalogs < 1000 items it's instantaneous.
            
            # We need to filter the queryset. 
            # Ideally we construct a Q object, but we can't do unaccent(field) in SQLite easily.
            
            # Let's try to do it in memory.
            # Warning: This evaluates the queryset!
            
            # To be safe, let's only do this for specific views or small querysets if possible.
            # But since this is a global filter, we should be careful.
            
            # Better approach for SQLite:
            # Register a custom function? No, too complex for this context.
            
            # Let's iterate and filter.
            initial_results = list(queryset.all())
            filtered_results = []
            
            search_fields = self.get_search_fields(view, request)
            
            for obj in initial_results:
                # AND logic: ALL terms must match at least one field in the object
                all_terms_match = True
                
                for term in search_terms:
                    term_unaccented = remove_accents(term).lower()
                    term_match = False
                    
                    # Check each search field for this specific term
                    for field in search_fields:
                        # Handle related fields (e.g. job_title__name)
                        field_value = self.get_field_value(obj, field)
                        
                        if field_value:
                            value_unaccented = remove_accents(str(field_value)).lower()
                            if term_unaccented in value_unaccented:
                                term_match = True
                                break
                    
                    if not term_match:
                        all_terms_match = False
                        break
                
                if all_terms_match:
                    filtered_results.append(obj.pk)
            
            return queryset.filter(pk__in=filtered_results)

        return super().filter_queryset(request, queryset, view)

    def get_field_value(self, obj, field_name):
        """Helper to get value from potentially related fields"""
        try:
            if '__' in field_name:
                parts = field_name.split('__')
                value = obj
                for part in parts:
                    value = getattr(value, part)
                    if value is None:
                        return None
                return value
            return getattr(obj, field_name)
        except AttributeError:
            return None
</file>

<file path="backend/employment/migrations/0001_initial.py">
# Generated by Django 5.2.8 on 2025-11-24 08:15

import django.db.models.deletion
import django.utils.timezone
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('core', '0001_initial'),
        ('organization', '0001_initial'),
    ]

    operations = [
        migrations.CreateModel(
            name='EmploymentStatus',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, help_text='Ej: Activo, En Reposo, Suspendido, Finalizado', max_length=50, unique=True)),
                ('is_active_relationship', models.BooleanField(default=True, help_text='Si está marcado, este estatus cuenta como que el empleado ocupa el cargo (ej: Activo, Reposo). Si no (ej: Finalizado), libera el cargo.', verbose_name='¿Es vinculación activa?')),
            ],
        ),
        migrations.CreateModel(
            name='EmploymentType',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, help_text='Ej: Período de Prueba, Tiempo Indefinido', max_length=100, unique=True)),
            ],
        ),
        migrations.CreateModel(
            name='Role',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, help_text='Manager, Supervisor, Employee', max_length=50, unique=True)),
                ('description', models.TextField(blank=True, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
            ],
        ),
        migrations.CreateModel(
            name='Employment',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('exit_reason', models.CharField(blank=True, choices=[('REN', 'Renuncia Voluntaria'), ('DES', 'Despido / Cese'), ('FIN', 'Fin de Contrato (Tiempo Cumplido)'), ('JUB', 'Jubilación'), ('FAL', 'Fallecimiento'), ('OTR', 'Otro Motivo')], max_length=3, null=True, verbose_name='Motivo de Salida')),
                ('exit_notes', models.TextField(blank=True, help_text='Detalle o carta de renuncia.', null=True, verbose_name='Observaciones')),
                ('hire_date', models.DateField(verbose_name='Fecha de Contratación')),
                ('end_date', models.DateField(blank=True, help_text="Fecha de fin de contrato (para 'Tiempo Determinado' o 'Prueba')", null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('person', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='employments', to='core.person', verbose_name='Colaborador')),
                ('position', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='employments', to='organization.position', verbose_name='Cargo / Posición')),
                ('current_status', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='active_employments', to='employment.employmentstatus', verbose_name='Estatus Actual')),
                ('employment_type', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='employments', to='employment.employmenttype', verbose_name='Tipo de Contrato')),
                ('role', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='employments', to='employment.role', verbose_name='Rol Funcional')),
            ],
            options={
                'verbose_name': 'Expediente Laboral',
                'ordering': ['-hire_date'],
            },
        ),
        migrations.CreateModel(
            name='EmploymentStatusLog',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('start_date', models.DateField(default=django.utils.timezone.now, help_text='Fecha de inicio de este estatus')),
                ('reason', models.TextField(blank=True, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('employment', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='status_logs', to='employment.employment')),
                ('status', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, to='employment.employmentstatus')),
            ],
            options={
                'verbose_name': 'Historial de Estatus',
                'ordering': ['-created_at'],
            },
        ),
    ]
</file>

<file path="backend/organization/migrations/0001_initial.py">
# Generated by Django 5.2.8 on 2025-11-23 08:49

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
    ]

    operations = [
        migrations.CreateModel(
            name='JobTitle',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, max_length=100, unique=True)),
                ('description', models.TextField(blank=True, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
            ],
        ),
        migrations.CreateModel(
            name='Department',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, max_length=100, unique=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('parent', models.ForeignKey(blank=True, help_text='Departamento superior al que reporta este departamento.', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='sub_departments', to='organization.department')),
            ],
        ),
        migrations.CreateModel(
            name='Position',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('vacancies', models.PositiveIntegerField(default=1, help_text='Número de vacantes disponibles')),
                ('name', models.CharField(blank=True, help_text="Nombre descriptivo opcional, ej: 'Gerente de Finanzas (VE)'", max_length=100, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('department', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='organization.department')),
                ('job_title', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='organization.jobtitle')),
                ('manager_position', models.ForeignKey(blank=True, help_text='Posición a la que reporta directamente (Jefe Inmediato).', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='direct_reports', to='organization.position')),
            ],
        ),
        migrations.CreateModel(
            name='PositionObjective',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('description', models.TextField(help_text='Un objetivo de la posición')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('position', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='objectives', to='organization.position')),
            ],
        ),
        migrations.CreateModel(
            name='PositionRequirement',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('description', models.TextField(help_text='Un requisito de la posición')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('position', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='requirements', to='organization.position')),
            ],
        ),
    ]
</file>

<file path="backend/talent/migrations/0001_initial.py">
# Generated by Django 5.2.8 on 2025-11-24 08:15

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('core', '0001_initial'),
    ]

    operations = [
        migrations.CreateModel(
            name='BusinessFunction',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, help_text='Ej: Human Resources, Finance, IT', max_length=100, unique=True)),
                ('description', models.TextField(blank=True, null=True)),
            ],
        ),
        migrations.CreateModel(
            name='EducationLevel',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, help_text='Ej: Ingeniería, Maestría, Bachillerato', max_length=100, unique=True)),
            ],
        ),
        migrations.CreateModel(
            name='FieldOfStudy',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, help_text='Ej: Software, Recursos Humanos, N/A', max_length=100, unique=True)),
            ],
        ),
        migrations.CreateModel(
            name='Language',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, max_length=100, unique=True)),
            ],
        ),
        migrations.CreateModel(
            name='LanguageProficiency',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(error_messages={'unique': 'Ya existe un registro con este nombre.'}, max_length=50, unique=True)),
            ],
        ),
        migrations.CreateModel(
            name='PersonAward',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=255)),
                ('description', models.TextField(blank=True, null=True)),
                ('institution', models.CharField(blank=True, max_length=255, null=True)),
                ('issue_date', models.DateField()),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('person', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='awards', to='core.person')),
            ],
        ),
        migrations.CreateModel(
            name='PersonCertification',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=255)),
                ('description', models.TextField(blank=True, null=True)),
                ('institution', models.CharField(max_length=255)),
                ('effective_date', models.DateField()),
                ('expiration_date', models.DateField(blank=True, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('person', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='certifications', to='core.person')),
            ],
        ),
        migrations.CreateModel(
            name='CertificationDocument',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('file', models.FileField(blank=True, null=True, upload_to='documents/certification/')),
                ('description', models.CharField(blank=True, max_length=255, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('certification', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='documents', to='talent.personcertification')),
            ],
        ),
        migrations.CreateModel(
            name='PersonEducation',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('school_name', models.CharField(max_length=255)),
                ('start_date', models.DateField()),
                ('end_date', models.DateField(blank=True, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('field_of_study', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='talent.fieldofstudy')),
                ('level', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='talent.educationlevel')),
                ('person', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='education_history', to='core.person')),
            ],
        ),
        migrations.CreateModel(
            name='PersonFunctionalExperience',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('start_date', models.DateField()),
                ('end_date', models.DateField(blank=True, help_text='NULL si es actual', null=True)),
                ('comments', models.TextField(blank=True, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('function', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, to='talent.businessfunction')),
                ('person', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='functional_experiences', to='core.person')),
            ],
        ),
        migrations.CreateModel(
            name='PersonLanguage',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('language', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='talent.language')),
                ('person', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='languages', to='core.person')),
                ('reading_proficiency', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='reading', to='talent.languageproficiency')),
                ('speaking_proficiency', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='speaking', to='talent.languageproficiency')),
                ('writing_proficiency', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='writing', to='talent.languageproficiency')),
            ],
        ),
        migrations.CreateModel(
            name='PersonMembership',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('organization_name', models.CharField(max_length=255)),
                ('role', models.CharField(blank=True, max_length=255, null=True)),
                ('start_date', models.DateField()),
                ('end_date', models.DateField(blank=True, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('person', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='memberships', to='core.person')),
            ],
        ),
        migrations.CreateModel(
            name='PersonSpecialAssignment',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('project_name', models.CharField(max_length=255)),
                ('description', models.TextField(blank=True, null=True)),
                ('start_date', models.DateField()),
                ('end_date', models.DateField(blank=True, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('person', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='special_assignments', to='core.person')),
            ],
        ),
        migrations.CreateModel(
            name='PersonVolunteerExperience',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('organization_name', models.CharField(max_length=255)),
                ('role', models.CharField(max_length=255)),
                ('start_date', models.DateField()),
                ('end_date', models.DateField(blank=True, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('person', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='volunteer_experiences', to='core.person')),
            ],
        ),
    ]
</file>

<file path="backend/talent/admin.py">
from django.contrib import admin
from . import models

admin.site.register(models.PersonSpecialAssignment)
admin.site.register(models.BusinessFunction)
admin.site.register(models.PersonFunctionalExperience)
admin.site.register(models.PersonCertification)
admin.site.register(models.CertificationDocument)
admin.site.register(models.EducationLevel)
admin.site.register(models.FieldOfStudy)
admin.site.register(models.PersonEducation)
admin.site.register(models.PersonVolunteerExperience)
admin.site.register(models.PersonAward)
admin.site.register(models.PersonMembership)
admin.site.register(models.Language)
admin.site.register(models.LanguageProficiency)
admin.site.register(models.PersonLanguage)
</file>

<file path="backend/talent/urls.py">
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from . import views

router = DefaultRouter()
router.register(r'special-assignments', views.PersonSpecialAssignmentViewSet, basename='specialassignment')
router.register(r'business-functions', views.BusinessFunctionViewSet, basename='businessfunction')
router.register(r'functional-experiences', views.PersonFunctionalExperienceViewSet, basename='functionalexperience')
router.register(r'certifications', views.PersonCertificationViewSet, basename='certification')
router.register(r'certification-documents', views.CertificationDocumentViewSet, basename='certificationdocument')
router.register(r'education-levels', views.EducationLevelViewSet, basename='educationlevel')
router.register(r'fields-of-study', views.FieldOfStudyViewSet, basename='fieldofstudy')
router.register(r'education', views.PersonEducationViewSet, basename='education')
router.register(r'volunteer-experiences', views.PersonVolunteerExperienceViewSet, basename='volunteerexperience')
router.register(r'awards', views.PersonAwardViewSet, basename='award')
router.register(r'memberships', views.PersonMembershipViewSet, basename='membership')
router.register(r'languages', views.LanguageViewSet, basename='language')
router.register(r'language-proficiencies', views.LanguageProficiencyViewSet, basename='languageproficiency')
router.register(r'person-languages', views.PersonLanguageViewSet, basename='personlanguage')

urlpatterns = [
    path('', include(router.urls)),
]
</file>

<file path="backend/training/admin.py">
from django.contrib import admin
from . import models
from django.db.models import Count

# --- 1. INLINES (Tablas anidadas dentro del formulario del Curso) ---

class ParticipantInline(admin.TabularInline):
    """Permite gestionar instructores y estudiantes desde la página del Curso."""
    model = models.CourseParticipant
    extra = 1
    # raw_id_fields es ideal para FKs a modelos grandes (como Person)
    raw_id_fields = ('person',) 
    
    # Campos que el usuario puede ver, pero no editar en el inline
    readonly_fields = ('get_person_name',) 
    
    # Campos a mostrar en la tabla (usamos un método para mostrar el nombre completo)
    fields = ('person', 'get_person_name', 'role', 'enrollment_status', 'academic_status', 'grade')
    
    # Método auxiliar para mostrar el nombre completo de la persona
    def get_person_name(self, obj):
        return str(obj.person)
    get_person_name.short_description = 'Nombre de la Persona'


class SessionInline(admin.TabularInline):
    """Permite gestionar el horario y temas del curso."""
    model = models.CourseSession
    extra = 1
    fields = ('topic', 'date', 'start_time', 'end_time')
    ordering = ('date', 'start_time')


class ResourceInline(admin.TabularInline):
    """Permite gestionar los materiales de apoyo."""
    model = models.CourseResource
    extra = 1
    fields = ('name', 'resource_type', 'file', 'url')


# --- 2. MODEL ADMINS PRINCIPALES ---

@admin.register(models.Course)
class CourseAdmin(admin.ModelAdmin):
    """Admin para el modelo principal Course."""
    
    # Campos a mostrar en la lista de cursos
    list_display = (
        'name', 
        'get_modality_display', 
        'status', 
        'start_date', 
        'end_date', 
        'max_participants', 
        'enrolled_count', # Propiedad calculada
        'is_full'         # Propiedad calculada
    )
    
    # Campos para filtrar la lista
    list_filter = ('status', 'modality', 'start_date')
    
    # Campos para búsqueda rápida
    search_fields = ('name', 'description')
    
    # Campos de solo lectura
    readonly_fields = ('enrolled_count', 'is_full') 

    # Agregamos las secciones inlines al formulario de edición
class AttendanceRecordAdmin(admin.ModelAdmin):
    """Admin para auditar registros de asistencia."""
    list_display = ('session', 'participant_person', 'status', 'notes')
    list_filter = ('status', 'session__course')
    search_fields = ('participant__person__first_name', 'session__topic')

    def participant_person(self, obj):
        return str(obj.participant.person)
    participant_person.short_description = 'Participante'
    
    
# --- 3. REGISTRO DE MODELOS RESTANTES ---
# (Modelos que no necesitan Inlines ni personalización compleja)

admin.site.register(models.CourseSession)
admin.site.register(models.CourseResource)
</file>

<file path="backend/training/models.py">
from django.db import models
from django.core.exceptions import ValidationError
from core.models import Person

class Course(models.Model):
    class Status(models.TextChoices):
        DRAFT = 'BOR', 'Borrador'
        SCHEDULED = 'PRO', 'Programado'
        IN_PROGRESS = 'EJE', 'En Ejecución'
        COMPLETED = 'FIN', 'Finalizado'
        CANCELLED = 'CAN', 'Cancelado'

    # NUEVO: Modalidad
    class Modality(models.TextChoices):
        PRESENTIAL = 'PRE', 'Presencial'
        VIRTUAL_SYNC = 'VIR', 'Virtual (En Vivo / Zoom)'
        VIRTUAL_ASYNC = 'ASY', 'Virtual (Autoaprendizaje)'
        HYBRID = 'MIX', 'Híbrido / Mixto'

    name = models.CharField(max_length=200, verbose_name="Nombre del Curso")
    description = models.TextField(blank=True, null=True)

    cover_image = models.ImageField(
        upload_to='courses/covers/', 
        null=True, 
        blank=True,
        verbose_name="Imagen de Portada"
    )
    
    start_date = models.DateField(verbose_name="Fecha Inicio")
    end_date = models.DateField(verbose_name="Fecha Fin")
    
    # NUEVO: Modalidad y Cupo
    modality = models.CharField(max_length=3, choices=Modality.choices, default=Modality.PRESENTIAL)
    max_participants = models.PositiveIntegerField(
        default=20, 
        verbose_name="Cupo Máximo",
        help_text="Límite de estudiantes permitidos."
    )
    
    duration_hours = models.PositiveIntegerField(default=0)
    status = models.CharField(max_length=3, choices=Status.choices, default=Status.DRAFT)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self): return self.name
    
    @property
    def enrolled_count(self):
        # Cuenta solo estudiantes (no instructores)
        return self.participants.filter(role='EST').count()

    @property
    def is_full(self):
        return self.enrolled_count >= self.max_participants


class CourseResource(models.Model):
    """Materiales de apoyo (PDFs, Videos, Links)."""
    
    class Type(models.TextChoices):
        FILE = 'FIL', 'Archivo (PDF/Doc/Img)'
        LINK = 'URL', 'Enlace Externo / Video'

    course = models.ForeignKey(Course, on_delete=models.CASCADE, related_name='resources')
    name = models.CharField(max_length=200, verbose_name="Título del Recurso")
    resource_type = models.CharField(max_length=3, choices=Type.choices, default=Type.FILE)
    
    # Puede ser uno U otro
    file = models.FileField(upload_to='training/resources/', null=True, blank=True)
    url = models.URLField(null=True, blank=True, help_text="Youtube, Drive, Zoom, etc.")
    
    created_at = models.DateTimeField(auto_now_add=True)

    def __str__(self): return self.name


class CourseSession(models.Model):
    """
    Cada una de las clases o sesiones del curso.
    Necesario para tomar asistencia por día.
    """
    course = models.ForeignKey(Course, on_delete=models.CASCADE, related_name='sessions')
    topic = models.CharField(max_length=200, verbose_name="Tema / Título de la Sesión")
    date = models.DateField(verbose_name="Fecha de la sesión")
    start_time = models.TimeField(verbose_name="Hora Inicio")
    end_time = models.TimeField(verbose_name="Hora Fin")
    
    class Meta:
        ordering = ['date', 'start_time']

    def __str__(self): return f"{self.course.name} - {self.topic} ({self.date})"


class CourseParticipant(models.Model):
    class Role(models.TextChoices):
        INSTRUCTOR = 'INS', 'Instructor'
        STUDENT = 'EST', 'Estudiante'

    class EnrollmentStatus(models.TextChoices):
        REQUESTED = 'REQ', 'Solicitud Enviada'
        ENROLLED = 'ENR', 'Inscrito / Matriculado'
        REJECTED = 'REJ', 'Solicitud Rechazada'
        DROPPED = 'DRP', 'Retirado'

    class AcademicStatus(models.TextChoices):
        NOT_EVALUATED = 'NEV', 'No Evaluado / N/A'
        PENDING = 'PEN', 'En Curso / Pendiente'
        PASSED = 'APR', 'Aprobado'
        FAILED = 'REP', 'Reprobado'

    course = models.ForeignKey(Course, on_delete=models.CASCADE, related_name='participants')
    person = models.ForeignKey(Person, on_delete=models.CASCADE, related_name='training_courses')
    role = models.CharField(max_length=3, choices=Role.choices, default=Role.STUDENT)
    
    # Nuevos campos de estado separados
    enrollment_status = models.CharField(
        max_length=3, 
        choices=EnrollmentStatus.choices, 
        default=EnrollmentStatus.REQUESTED,
        verbose_name="Estado de Inscripción"
    )
    academic_status = models.CharField(
        max_length=3, 
        choices=AcademicStatus.choices, 
        default=AcademicStatus.NOT_EVALUATED,
        verbose_name="Estado Académico"
    )
    
    grade = models.DecimalField(max_digits=5, decimal_places=2, null=True, blank=True)
    
    class Meta:
        unique_together = ('course', 'person')

    def __str__(self): return f"{self.person} en {self.course}"


class AttendanceRecord(models.Model):
    """Registro de asistencia: Cruce entre Sesión y Participante."""
    
    class Status(models.TextChoices):
        PRESENT = 'PRE', 'Presente'
        ABSENT = 'AUS', 'Ausente'
        LATE = 'TAR', 'Tardanza'
        EXCUSED = 'JUS', 'Justificado'

    session = models.ForeignKey(CourseSession, on_delete=models.CASCADE, related_name='attendance_records')
    participant = models.ForeignKey(CourseParticipant, on_delete=models.CASCADE, related_name='attendance_history')
    
    status = models.CharField(max_length=3, choices=Status.choices, default=Status.ABSENT)
    notes = models.CharField(max_length=255, blank=True, null=True)
    
    class Meta:
        unique_together = ('session', 'participant') # Solo una asistencia por persona por sesión

    def __str__(self): return f"{self.participant.person} - {self.session} : {self.get_status_display()}"
</file>

<file path="backend/training/views.py">
from rest_framework import viewsets, permissions
from rest_framework.decorators import action
from rest_framework.response import Response
from .models import Course, CourseResource, CourseSession, CourseParticipant, AttendanceRecord
from .serializers import (
    CourseSerializer, CourseResourceSerializer, CourseSessionSerializer, 
    CourseParticipantSerializer, AttendanceRecordSerializer
)
from django.db.models import Q
from .permissions import IsInstructorOrAdmin

class CourseViewSet(viewsets.ModelViewSet):
    serializer_class = CourseSerializer
    permission_classes = [permissions.IsAuthenticated, IsInstructorOrAdmin]

    def get_queryset(self):
        queryset = Course.objects.all().order_by('-start_date')
        user = self.request.user
        
        # 1. Admin ve todo
        if user.is_staff:
            return queryset
            
        # 2. Empleados (Lógica Híbrida)
        if hasattr(user, 'person'):
            return queryset.filter(
                # CONDICIÓN A: Soy participante (Instructor o Estudiante)
                Q(participants__person=user.person) |
                
                # CONDICIÓN B: El curso está abierto al público (Catálogo)
                Q(status__in=[Course.Status.SCHEDULED, Course.Status.IN_PROGRESS])
            ).distinct()
            
        return Course.objects.none()

class CourseResourceViewSet(viewsets.ModelViewSet):
    serializer_class = CourseResourceSerializer
    permission_classes = [permissions.IsAuthenticated, IsInstructorOrAdmin]

    def get_queryset(self):
        queryset = CourseResource.objects.all()
        user = self.request.user

        # Filtro de Seguridad
        if hasattr(user, 'person') and not user.is_staff:
            # SOLO si estoy INSCRITO (ENR) o soy INSTRUCTOR (INS)
            queryset = queryset.filter(
                Q(course__participants__person=user.person) &
                (
                    Q(course__participants__enrollment_status='ENR') | 
                    Q(course__participants__role='INS')
                )
            ).distinct()

        # 👇 FILTRO ESPECÍFICO (Crucial) 👇
        course_id = self.request.query_params.get('course')
        if course_id:
            queryset = queryset.filter(course_id=course_id)

        return queryset

class CourseSessionViewSet(viewsets.ModelViewSet):
    serializer_class = CourseSessionSerializer
    permission_classes = [permissions.IsAuthenticated, IsInstructorOrAdmin]

    def get_queryset(self):
        queryset = CourseSession.objects.all()
        user = self.request.user

        if user.is_staff:
            return queryset

        if hasattr(user, 'person'):
            # SOLO si estoy INSCRITO (ENR) o soy INSTRUCTOR (INS)
            return queryset.filter(
                Q(course__participants__person=user.person) &
                (
                    Q(course__participants__enrollment_status='ENR') | 
                    Q(course__participants__role='INS')
                )
            ).distinct()
        
        # Agregamos el filtro por curso específico también aquí por seguridad
        course_id = self.request.query_params.get('course')
        if course_id:
            queryset = queryset.filter(course_id=course_id)

        return CourseSession.objects.none()

    @action(detail=True, methods=['get'])
    def attendance(self, request, pk=None):
        session = self.get_object()
        records = session.attendance_records.select_related('participant__person').all()
        serializer = AttendanceRecordSerializer(records, many=True)
        return Response(serializer.data)

class CourseParticipantViewSet(viewsets.ModelViewSet):
    queryset = CourseParticipant.objects.all()
    serializer_class = CourseParticipantSerializer
    permission_classes = [permissions.IsAuthenticated, IsInstructorOrAdmin]

    def get_queryset(self):
        # OPTIMIZACIÓN: Cargar la persona junto con el participante
        queryset = CourseParticipant.objects.select_related('person')
        
        # Filtro por curso
        course_id = self.request.query_params.get('course')
        if course_id:
            queryset = queryset.filter(course_id=course_id)
            
        return queryset

class AttendanceRecordViewSet(viewsets.ModelViewSet):
    serializer_class = AttendanceRecordSerializer
    # Usamos el permiso para evitar que alumnos editen (solo instructores/admin editan)
    permission_classes = [permissions.IsAuthenticated, IsInstructorOrAdmin]

    def get_queryset(self):
        # Optimizamos para cargar Sesión y Persona de un solo golpe
        queryset = AttendanceRecord.objects.select_related(
            'session__course', 
            'participant__person'
        ).all()
        
        user = self.request.user

        # 1. Admin ve todo
        if user.is_staff:
            return queryset

        if hasattr(user, 'person'):
            # 2. Lógica Híbrida (Instructor vs Estudiante)
            return queryset.filter(
                # CASO A: Soy el INSTRUCTOR del curso al que pertenece la sesión
                Q(session__course__participants__person=user.person, 
                  session__course__participants__role='INS') |
                
                # CASO B: El registro es MÍO (Soy el estudiante evaluado)
                Q(participant__person=user.person)
            ).distinct()

        return AttendanceRecord.objects.none()
</file>

<file path="backend/pyproject.toml">
[project]
name = "backend"
version = "0.1.0"
description = "Add your description here"
readme = "README.md"
requires-python = ">=3.13"
dependencies = [
    "dj-rest-auth>=7.0.1",
    "django>=5.2.8",
    "django-allauth>=65.13.0",
    "django-cors-headers>=4.9.0",
    "django-environ>=0.12.0",
    "django-filter>=25.2",
    "django-simple-history>=3.10.1",
    "djangorestframework>=3.16.1",
    "djangorestframework-simplejwt>=5.5.1",
    "pillow>=12.0.0",
    "python-dateutil>=2.9.0.post0",
    "requests>=2.32.5",
]
</file>

<file path="frontend2/app/(main)/admin/config/general/page.tsx">
"use client";

import { CatalogCard } from "@/components/catalogs/catalog-card";
import { Input } from "@/components/ui/input";
import {
    Globe2,
    Map,
    Users,
    HeartHandshake,
    MapPin,
    Phone,
    Cpu,
    Mail,
    Landmark,
    Wallet,
    Share2,
    Search,
    Hash,
} from "lucide-react";
import { useState } from "react";

const catalogs = [
    {
        title: "Países",
        description: "Gestión de países para direcciones y nacionalidades",
        icon: Globe2,
        href: "/admin/config/general/countries",
        gradient: "from-blue-900 via-blue-700 to-blue-500",
        iconColor: "text-blue-200/90"
    },
    {
        title: "Estados",
        description: "Gestión de estados y provincias por país",
        icon: Map,
        href: "/admin/config/general/states",
        gradient: "from-emerald-900 via-emerald-700 to-emerald-500",
        iconColor: "text-emerald-200/90"
    },
    {
        title: "Géneros",
        description: "Catálogo de géneros e identidades",
        icon: Users,
        href: "/admin/config/general/genders",
        gradient: "from-purple-900 via-purple-700 to-purple-500",
        iconColor: "text-purple-200/90"
    },
    {
        title: "Estado Civil",
        description: "Tipos de estado civil",
        icon: HeartHandshake,
        href: "/admin/config/general/marital-statuses",
        gradient: "from-pink-900 via-pink-700 to-pink-500",
        iconColor: "text-pink-200/90"
    },
    {
        title: "Tipos de Dirección",
        description: "Clasificación de direcciones (Casa, Trabajo, etc.)",
        icon: MapPin,
        href: "/admin/config/general/address-types",
        gradient: "from-orange-900 via-orange-700 to-orange-500",
        iconColor: "text-orange-200/90"
    },
    {
        title: "Tipos de Teléfono",
        description: "Clasificación de teléfonos (Móvil, Fijo, etc.)",
        icon: Phone,
        href: "/admin/config/general/phone-types",
        gradient: "from-cyan-900 via-cyan-700 to-cyan-500",
        iconColor: "text-cyan-200/90"
    },
    {
        title: "Operadoras",
        description: "Operadoras de telefonía móvil y fija",
        icon: Cpu,
        href: "/admin/config/general/phone-carriers",
        gradient: "from-indigo-900 via-indigo-700 to-indigo-500",
        iconColor: "text-indigo-200/90"
    },
    {
        title: "Tipos de Email",
        description: "Clasificación de correos (Personal, Corporativo)",
        icon: Mail,
        href: "/admin/config/general/email-types",
        gradient: "from-red-900 via-red-700 to-red-500",
        iconColor: "text-red-200/90"
    },
    {
        title: "Bancos",
        description: "Instituciones bancarias y financieras",
        icon: Landmark,
        href: "/admin/config/general/banks",
        gradient: "from-green-900 via-green-700 to-green-500",
        iconColor: "text-green-200/90"
    },
    {
        title: "Tipos de Cuenta",
        description: "Tipos de cuenta bancaria (Ahorro, Corriente)",
        icon: Wallet,
        href: "/admin/config/general/bank-account-types",
        gradient: "from-yellow-900 via-yellow-700 to-yellow-500",
        iconColor: "text-yellow-200/90"
    },
    {
        title: "Tipos de Relación",
        description: "Parentescos y tipos de relación familiar",
        icon: Share2,
        href: "/admin/config/general/relationship-types",
        gradient: "from-rose-900 via-rose-700 to-rose-500",
        iconColor: "text-rose-200/90"
    },
    {
        title: "Códigos de Operadora",
        description: "Códigos de área por operadora telefónica",
        icon: Hash,
        href: "/admin/config/general/phone-carrier-codes",
        gradient: "from-blue-950 via-blue-800 to-blue-600",
        iconColor: "text-blue-200/90"
    }
];

export default function GeneralConfigPage() {
    const [searchQuery, setSearchQuery] = useState("");

    const normalizeText = (text: string) =>
        text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();

    const filteredCatalogs = catalogs.filter(catalog =>
        normalizeText(catalog.title).includes(normalizeText(searchQuery)) ||
        normalizeText(catalog.description).includes(normalizeText(searchQuery))
    );

    return (
        <div className="space-y-6">
            <div className="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                <div>
                    <h1 className="text-3xl font-bold text-foreground">Catálogos Generales</h1>
                    <p className="text-muted-foreground">
                        Configuración de catálogos base del sistema
                    </p>
                </div>
                <div className="relative w-full md:w-72">
                    <Search className="absolute left-2 top-2.5 h-4 w-4 text-muted-foreground" />
                    <Input
                        placeholder="Buscar catálogos..."
                        className="pl-8"
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                    />
                </div>
            </div>

            <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                {filteredCatalogs.map((catalog) => (
                    <CatalogCard
                        key={catalog.href}
                        {...catalog}
                    />
                ))}
            </div>
        </div>
    );
}
</file>

<file path="frontend2/app/(main)/admin/organization/positions/[id]/page.tsx">
"use client";

import { use, useEffect } from "react";
import useSWR from "swr";
import { useRouter, usePathname } from "next/navigation";
import { ArrowLeft, Briefcase, Users, UserCheck, Building2, ListChecks, ScrollText, Target } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Skeleton } from "@/components/ui/skeleton";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { CatalogCRUD, CatalogField } from "@/components/catalogs/catalog-crud";
import { ColumnDef } from "@tanstack/react-table";
import apiClient from "@/lib/api-client";
import { useBreadcrumb } from "@/context/breadcrumb-context";

// Interfaces matching backend serializer
interface PositionRequirement {
    id: number;
    description: string;
}

interface PositionFunction {
    id: number;
    description: string;
}

interface Position {
    id: number;
    department_name: string;
    job_title_name: string;
    full_name: string;
    vacancies: number;
    active_employees_count: number;
    reports_to_names_display: string;
    requirements: PositionRequirement[];
    functions: PositionFunction[];
    objective?: string;
}

const fetcher = (url: string) => apiClient.get(url).then((res) => res.data);

export default function PositionDetailPage({ params }: { params: Promise<{ id: string }> }) {
    const { id } = use(params);
    const router = useRouter();
    const pathname = usePathname();
    const { setLabel } = useBreadcrumb();
    const { data: position, error, isLoading } = useSWR<Position>(`/api/organization/positions/${id}/`, fetcher);

    useEffect(() => {
        if (position) {
            // Normalize path by removing trailing slash if present to match DynamicBreadcrumbs key generation
            const normalizedPath = pathname.endsWith('/') ? pathname.slice(0, -1) : pathname;
            setLabel(normalizedPath, position.job_title_name);
        }
    }, [position, pathname, setLabel]);

    if (isLoading) {
        return <PositionDetailSkeleton />;
    }

    if (error || !position) {
        return (
            <div className="flex flex-col items-center justify-center h-full p-8 text-center">
                <h2 className="text-2xl font-bold text-destructive mb-2">Error</h2>
                <p className="text-muted-foreground mb-4">No se pudo cargar la información del cargo.</p>
                <Button onClick={() => router.back()}>Volver</Button>
            </div>
        );
    }

    // Configuration for Functions Catalog
    const functionsFields: CatalogField[] = [
        { name: "description", label: "Descripción", type: "textarea", required: true },
    ];
    const functionsColumns: ColumnDef<PositionFunction>[] = [
        { accessorKey: "description", header: "Descripción", cell: ({ row }) => <div className="whitespace-pre-wrap">{row.getValue("description")}</div> },
    ];

    // Configuration for Requirements Catalog
    const requirementsFields: CatalogField[] = [
        { name: "description", label: "Descripción", type: "textarea", required: true },
    ];
    const requirementsColumns: ColumnDef<PositionRequirement>[] = [
        { accessorKey: "description", header: "Descripción", cell: ({ row }) => <div className="whitespace-pre-wrap">{row.getValue("description")}</div> },
    ];

    return (
        <div className="flex flex-col h-full space-y-6 p-8">
            {/* Header */}
            <div className="flex items-center justify-between border-b pb-6">
                <div>
                    <h1 className="text-2xl font-bold tracking-tight">{position.job_title_name}</h1>
                    <div className="flex items-center text-muted-foreground mt-1">
                        <Building2 className="h-4 w-4 mr-2" />
                        <span>{position.department_name}</span>
                    </div>
                </div>
                <Button variant="outline" onClick={() => router.back()}>
                    <ArrowLeft className="mr size-4" />
                </Button>
            </div>

            <Tabs defaultValue="general" className="flex-1 flex flex-col">
                <TabsList className="w-full flex flex-col md:grid md:grid-cols-3 h-auto p-1 bg-muted/50 gap-1">
                    <TabsTrigger
                        value="general"
                        className="data-[state=active]:bg-primary data-[state=active]:text-primary-foreground py-3 transition-all duration-300 w-full"
                    >
                        <Briefcase className="mr-1 size-4" />
                        <p className="truncate">
                            Información General
                        </p>
                    </TabsTrigger>
                    <TabsTrigger
                        value="functions"
                        className="data-[state=active]:bg-primary data-[state=active]:text-primary-foreground py-3 transition-all duration-300 w-full"
                    >
                        <ListChecks className="mr-1 size-4" />
                        <p className="truncate">
                            Funciones
                        </p>
                    </TabsTrigger>
                    <TabsTrigger
                        value="requirements"
                        className="data-[state=active]:bg-primary data-[state=active]:text-primary-foreground py-3 transition-all duration-300 w-full"
                    >
                        <ScrollText className="mr-1 size-4" />
                        <p className="truncate">
                            Requisitos
                        </p>
                    </TabsTrigger>
                </TabsList>

                <div className="flex-1 mt-6">
                    <TabsContent value="general" className="m-0 h-full">
                        <div className="flex flex-col gap-6 w-full">
                            <Card className="hover:shadow-md transition-shadow">
                                <CardHeader>
                                    <CardTitle className="text-lg flex items-center gap-2">
                                        <Target className="h-5 w-5 text-primary" />
                                        Objetivo del Cargo
                                    </CardTitle>
                                </CardHeader>
                                <CardContent>
                                    <p className="text-sm leading-relaxed text-muted-foreground">
                                        {position.objective || "No se ha definido un objetivo para este cargo."}
                                    </p>
                                </CardContent>
                            </Card>

                            <Card className="hover:shadow-md transition-shadow">
                                <CardHeader>
                                    <CardTitle className="text-lg flex items-center gap-2">
                                        <UserCheck className="h-5 w-5 text-primary" />
                                        Jerarquía
                                    </CardTitle>
                                </CardHeader>
                                <CardContent>
                                    <h4 className="text-sm font-medium mb-2 text-muted-foreground">Reporta a:</h4>
                                    <p className="text-sm text-muted-foreground">
                                        {position.reports_to_names_display || "Posición de mayor jerarquía"}
                                    </p>
                                </CardContent>
                            </Card>

                            <Card className="hover:shadow-md transition-shadow">
                                <CardHeader>
                                    <CardTitle className="text-lg flex items-center gap-2">
                                        <Users className="h-5 w-5 text-primary" />
                                        Ocupación
                                    </CardTitle>
                                </CardHeader>
                                <CardContent className="space-y-4">
                                    <div className="flex justify-between items-center">
                                        <span className="text-sm font-medium text-muted-foreground">Vacantes Totales</span>
                                        <span className="text-sm font-bold">{position.vacancies}</span>
                                    </div>
                                    <div className="flex justify-between items-center">
                                        <span className="text-sm font-medium text-muted-foreground">Ocupadas</span>
                                        <span className="text-sm font-bold">{position.active_employees_count}</span>
                                    </div>
                                    <div className="flex justify-between items-center">
                                        <span className="text-sm font-medium text-muted-foreground">Disponibles</span>
                                        <span className="text-sm font-bold">
                                            {Math.max(0, position.vacancies - position.active_employees_count)}
                                        </span>
                                    </div>
                                </CardContent>
                            </Card>
                        </div>
                    </TabsContent>

                    <TabsContent value="functions" className="m-0 h-full">
                        <CatalogCRUD
                            title=""
                            apiUrl={`/api/organization/positions/${id}/functions/`}
                            fields={functionsFields}
                            columns={functionsColumns}
                            searchKey="description"
                        />
                    </TabsContent>

                    <TabsContent value="requirements" className="m-0 h-full">
                        <CatalogCRUD
                            title=""
                            apiUrl={`/api/organization/positions/${id}/requirements/`}
                            fields={requirementsFields}
                            columns={requirementsColumns}
                            searchKey="description"
                        />
                    </TabsContent>
                </div>
            </Tabs>
        </div>
    );
}

function PositionDetailSkeleton() {
    return (
        <div className="space-y-6 p-6">
            <div className="flex items-center gap-4">
                <Skeleton className="h-10 w-10 rounded-md" />
                <div className="space-y-2">
                    <Skeleton className="h-8 w-64" />
                    <Skeleton className="h-4 w-48" />
                </div>
            </div>
            <div className="grid gap-6 md:grid-cols-3">
                <div className="space-y-6">
                    <Skeleton className="h-[300px] w-full" />
                </div>
                <div className="md:col-span-2 space-y-6">
                    <Skeleton className="h-[200px] w-full" />
                    <Skeleton className="h-[200px] w-full" />
                </div>
            </div>
        </div>
    );
}
</file>

<file path="frontend2/app/(main)/layout.tsx">
import { DashboardLayout } from "@/components/layout/dashboard-layout";
import { ProtectedRoute } from "@/components/protected-route";

import { BreadcrumbProvider } from "@/context/breadcrumb-context";

export default function MainLayout({
    children
}: {
    children: React.ReactNode
}) {
    return (
        <ProtectedRoute>
            <BreadcrumbProvider>
                <DashboardLayout>
                    {children}
                </DashboardLayout>
            </BreadcrumbProvider>
        </ProtectedRoute>
    );
}
</file>

<file path="frontend2/components/layout/dynamic-breadcrumbs.tsx">
"use client";

import { usePathname } from "next/navigation";
import Link from "next/link";
import {
    Breadcrumb,
    BreadcrumbItem,
    BreadcrumbLink,
    BreadcrumbList,
    BreadcrumbPage,
    BreadcrumbSeparator,
} from "@/components/ui/breadcrumb";
import { Fragment } from "react";

const routeNameMap: Record<string, string> = {
    admin: "Administración",
    dashboard: "Dashboard",
    personnel: "Personal",
    employees: "Empleados",
    people: "Personas",
    organization: "Organización",
    departments: "Departamentos",
    "job-titles": "Títulos de Cargo",
    positions: "Posiciones",
    training: "Capacitación",
    courses: "Cursos",
    ats: "Reclutamiento",
    jobs: "Vacantes",
    candidates: "Candidatos",
    performance: "Evaluación",
    periods: "Periodos",
    config: "Configuración",
    general: "General",
    employment: "Empleo",
    talent: "Talento",
    employee: "Empleado",
    "personal-data": "Datos Personales",
    "job-data": "Datos del Puesto",
    compensation: "Compensación",
    "time-management": "Gestión del Tiempo",
    benefits: "Beneficios",
    "performance-goals": "Rendimiento y Metas",
    succession: "Sucesión",
    "learning-development": "Aprendizaje y Desarrollo",
    "talent-profile": "Perfil de Talento",
    // Catalogs
    countries: "Países",
    genders: "Géneros",
    "marital-statuses": "Estados Civiles",
    "address-types": "Tipos de Dirección",
    "phone-types": "Tipos de Teléfono",
    "phone-carriers": "Operadoras Telefónicas",
    "email-types": "Tipos de Email",
    banks: "Bancos",
    "bank-account-types": "Tipos de Cuenta Bancaria",
    "relationship-types": "Tipos de Relación",
    states: "Estados",
    "phone-carrier-codes": "Códigos de Operadora",
};

import { useBreadcrumb } from "@/context/breadcrumb-context";

export function DynamicBreadcrumbs() {
    const pathname = usePathname();
    const segments = pathname.split("/").filter((segment) => segment !== "");
    const { labels } = useBreadcrumb();

    // If we are at root, don't show breadcrumbs or show Home?
    // Usually dashboard is /admin/dashboard.

    return (
        <Breadcrumb className="mb-4">
            <BreadcrumbList>
                <BreadcrumbItem>
                    <BreadcrumbLink asChild>
                        <Link href="/">Inicio</Link>
                    </BreadcrumbLink>
                </BreadcrumbItem>

                {segments.length > 0 && <BreadcrumbSeparator />}

                {segments.map((segment, index) => {
                    const isLast = index === segments.length - 1;
                    const href = `/${segments.slice(0, index + 1).join("/")}`;
                    // Check context for override (try both with and without trailing slash), then map, then fallback
                    const name = labels[href] || labels[href + "/"] || routeNameMap[segment] || segment.charAt(0).toUpperCase() + segment.slice(1);

                    return (
                        <Fragment key={href}>
                            <BreadcrumbItem>
                                {isLast ? (
                                    <BreadcrumbPage>{name}</BreadcrumbPage>
                                ) : (
                                    <BreadcrumbLink asChild>
                                        <Link href={href}>{name}</Link>
                                    </BreadcrumbLink>
                                )}
                            </BreadcrumbItem>
                            {!isLast && <BreadcrumbSeparator />}
                        </Fragment>
                    );
                })}
            </BreadcrumbList>
        </Breadcrumb>
    );
}
</file>

<file path="frontend2/components/ui/action-menu.tsx">
"use client";

import { Button } from "@/components/ui/button";
import {
    DropdownMenu,
    DropdownMenuContent,
    DropdownMenuItem,
    DropdownMenuLabel,
    DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { MoreHorizontal, Pencil, Trash2 } from "lucide-react";

interface ActionMenuProps {
    onEdit?: () => void;
    onDelete?: () => void;
    editLabel?: string;
    deleteLabel?: string;
}

export function ActionMenu({
    onEdit,
    onDelete,
    editLabel = "Editar",
    deleteLabel = "Eliminar",
    children,
}: ActionMenuProps & { children?: React.ReactNode }) {
    return (
        <DropdownMenu>
            <DropdownMenuTrigger asChild>
                <Button variant="ghost" className="h-8 w-8 p-0">
                    <span className="sr-only">Abrir menú</span>
                    <MoreHorizontal className="h-4 w-4" />
                </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="end">
                <DropdownMenuLabel>Acciones</DropdownMenuLabel>
                {children}
                {onEdit && (
                    <DropdownMenuItem onClick={onEdit}>
                        <Pencil className="mr-2 h-4 w-4" />
                        {editLabel}
                    </DropdownMenuItem>
                )}
                {onDelete && (
                    <DropdownMenuItem onClick={onDelete} className="text-red-600 focus:text-red-600">
                        <Trash2 className="mr-2 h-4 w-4" />
                        {deleteLabel}
                    </DropdownMenuItem>
                )}
            </DropdownMenuContent>
        </DropdownMenu>
    );
}
</file>

<file path="frontend2/lib/utils.ts">
import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}

export function parseBackendDate(dateString: string | null | undefined): Date | undefined {
  if (!dateString) return undefined;
  // Dividimos manualmente: "2025-11-23" -> [2025, 11, 23]
  const [year, month, day] = dateString.split('-').map(Number);
  // Creamos la fecha local: Año, Mes (0-11), Día
  return new Date(year, month - 1, day);
}
</file>

<file path="frontend2/next.config.ts">
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  trailingSlash: true,
  async rewrites() {
    return [
      {
        source: "/api/:path*",
        destination: "http://127.0.0.1:8000/api/:path*",
      },
    ];
  },
};

export default nextConfig;
</file>

<file path="backend/accounts/serializers.py">
from rest_framework import serializers
from django.db import transaction
from django.contrib.auth.password_validation import validate_password as django_validate_password
from core.models import (
    Person, Gender, MaritalStatus, Country
)
# FIX: Importamos check_uniqueness para blindar el username contra Errores 500
from core.serializers import PersonSerializer, check_uniqueness
from .models import User
from dj_rest_auth.serializers import LoginSerializer
from django.utils.translation import gettext_lazy as _

class UserReadSerializer(serializers.ModelSerializer):
    person = PersonSerializer(read_only=True)
    class Meta:
        model = User
        fields = (
                'id',
                'username', 
                'is_staff', 
                'is_active', 
                'person'
            )

class EmployeeCreationSerializer(serializers.ModelSerializer):
    # Campos de Contraseña
    password = serializers.CharField(write_only=True, style={'input_type': 'password'})
    confirm_password = serializers.CharField(write_only=True, style={'input_type': 'password'})
    
    # Vincular Persona Existente
    person_id = serializers.PrimaryKeyRelatedField(
        queryset=Person.objects.all(), 
        source='person', 
        write_only=True, 
        required=False
    )
    
    # Crear Nueva Persona (Campos planos que mapearemos manualmente)
    first_name = serializers.CharField(max_length=100, write_only=True, required=False)
    second_name = serializers.CharField(max_length=100, write_only=True, required=False)
    paternal_surname = serializers.CharField(max_length=100, write_only=True, required=False)
    maternal_surname = serializers.CharField(max_length=100, write_only=True, required=False)
    birthdate = serializers.DateField(write_only=True, required=False)
    
    # FKs para nueva persona
    gender_id = serializers.PrimaryKeyRelatedField(
        queryset=Gender.objects.all(), write_only=True, required=False, source='gender'
    )
    marital_status_id = serializers.PrimaryKeyRelatedField(
        queryset=MaritalStatus.objects.all(), write_only=True, required=False, source='marital_status'
    )
    country_of_birth_id = serializers.PrimaryKeyRelatedField(
        queryset=Country.objects.all(), write_only=True, required=False, source='country_of_birth'
    )
    photo = serializers.ImageField(write_only=True, required=False)

    # Salida
    person = PersonSerializer(read_only=True)

    class Meta:
        model = User
        fields = (
            'id', 
            'username', 
            'password', 
            'confirm_password', 
            'person',
            
            # Inputs
            'person_id',
            'first_name', 'second_name', 'paternal_surname', 'maternal_surname',
            'birthdate', 'salutation_id', 'gender_id', 
            'marital_status_id', 'country_of_birth_id', 'photo'
        )

    def validate_username(self, value):
        """Normaliza el usuario a minúsculas y verifica unicidad."""
        cleaned = value.strip().lower()
        
        # FIX: Usamos check_uniqueness para asegurar que el valor normalizado no exista ya.
        return check_uniqueness(User, 'username', cleaned, self.instance, "Este nombre de usuario ya está registrado.")

    def validate(self, data):
        # 1. Validación de Contraseñas Coincidentes
        if data.get('password') != data.get('confirm_password'):
            raise serializers.ValidationError({"confirm_password": "Las contraseñas no coinciden."})

        # 2. Validación de Complejidad de Contraseña (Django Standard)
        if 'password' in data:
            try:
                django_validate_password(data['password'])
            except Exception as e:
                raise serializers.ValidationError({"password": list(e.messages)})

        # 3. Lógica de Persona (Existente vs Nueva)
        PERSON_WRITE_FIELDS = [
            'first_name', 'second_name', 'paternal_surname', 'maternal_surname',
            'birthdate', 'salutation', 'gender', 'marital_status',
            'country_of_birth', 'photo'
        ]
        
        # Detectar qué campos de "Nueva Persona" vienen en la data
        new_person_data = {k: v for k, v in data.items() if k in PERSON_WRITE_FIELDS}
        has_new_person_data = bool(new_person_data)
        has_person_id = 'person' in data # 'person' es el source de 'person_id'

        # Regla: O vinculas o creas, no ambas.
        if has_person_id and has_new_person_data:
            raise serializers.ValidationError(
                "No puede proveer 'person_id' y datos de nueva persona a la vez."
            )

        # Regla: Debes hacer al menos una cosa.
        if not has_person_id and not has_new_person_data:
             raise serializers.ValidationError(
                 "Debe proveer 'person_id' (para vincular existente) o datos para crear una nueva persona."
             )

        # Regla: Si creas nueva, mínimos requeridos.
        if has_new_person_data:
            if not ('first_name' in data and 'paternal_surname' in data):
                raise serializers.ValidationError("Para crear una nueva persona, 'first_name' y 'paternal_surname' son obligatorios.")

            # --- BLINDAJE CORE ---
            # Validamos usando PersonSerializer para aplicar las reglas de core
            person_validator = PersonSerializer(data=new_person_data)
            if not person_validator.is_valid():
                raise serializers.ValidationError(person_validator.errors)

        # Regla: Si vinculas, que no tenga usuario ya.
        if has_person_id:
            person = data['person']
            if hasattr(person, 'user_account'): 
                 raise serializers.ValidationError(
                     f"La persona '{person}' ya tiene un usuario asignado ({person.user_account.username})."
                 )
            
        return data

    @transaction.atomic
    def create(self, validated_data):
        validated_data.pop('confirm_password')
        
        PERSON_FIELDS = [
            'first_name', 'second_name', 'paternal_surname', 'maternal_surname',
            'birthdate', 'salutation', 'gender', 'marital_status',
            'country_of_birth', 'photo'
        ]
        
        new_person = None
        
        if 'person' in validated_data:
            new_person = validated_data.pop('person')
            for field in PERSON_FIELDS:
                validated_data.pop(field, None)
        else:
            person_data = {}
            for field in PERSON_FIELDS:
                if field in validated_data:
                    person_data[field] = validated_data.pop(field)
            
            # Creamos la persona (Ya validada en validate())
            new_person = Person.objects.create(**person_data)
        
        # Crear Usuario
        password = validated_data.pop('password')
        new_user = User.objects.create_user(
            password=password,
            person=new_person,
            **validated_data
        )
        
        return new_user

class CustomUserDetailsSerializer(serializers.ModelSerializer):
    """
    Serializer para ver detalles del usuario logueado.
    """
    person = PersonSerializer(read_only=True)

    class Meta:
        model = User
        fields = ('pk', 'username', 'is_staff', 'person')

class CustomLoginSerializer(LoginSerializer):
    def validate(self, attrs):
        try:
            return super().validate(attrs)
        except serializers.ValidationError:
            # Capturamos cualquier error de validación (incluyendo credenciales inválidas)
            # y lanzamos nuestro mensaje personalizado.
            msg = _('Usuario o contraseña incorrectos. Por favor verifique sus datos e intente nuevamente.')
            raise serializers.ValidationError(msg)
</file>

<file path="backend/config/urls.py">
from django.contrib import admin
from django.urls import path, include
from django.conf import settings
from django.conf.urls.static import static

urlpatterns = [
    path('admin/', admin.site.urls),
    path('api/auth/', include('dj_rest_auth.urls')),
    path('api/accounts/', include('accounts.urls')),
    path('api/core/', include('core.urls')),
    path('api/organization/', include('organization.urls')),
    path('api/employment/', include('employment.urls')),
    path('api/talent/', include('talent.urls')),
    path('api/training/', include('training.urls')),
    path('api/performance/', include('performance.urls')),
    path('api/ats/', include('ats.urls')),  # ATS: incluye /public y admin
]

if settings.DEBUG:
    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)
</file>

<file path="backend/employment/admin.py">
from django.contrib import admin
from .models import Employment, EmploymentStatusLog, EmploymentDepartmentRole

# Registrar los modelos en el admin de Django
admin.site.register(Employment)
admin.site.register(EmploymentStatusLog)
admin.site.register(EmploymentDepartmentRole)
</file>

<file path="backend/employment/urls.py">
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .views import EmploymentViewSet, EmploymentStatusLogViewSet, EmploymentDepartmentRoleViewSet, PersonDepartmentRoleViewSet

router = DefaultRouter()
# Removemos las rutas de catálogos viejos (roles, employment-types, employment-statuses)
# Solo mantenemos employments y logs
router.register(r'employments', EmploymentViewSet, basename='employment')
router.register(r'status-logs', EmploymentStatusLogViewSet, basename='status-log')
router.register(r'department-roles', EmploymentDepartmentRoleViewSet,basename='department-role')
router.register(r'person-department-roles', PersonDepartmentRoleViewSet, basename='person-department-role')

urlpatterns = [
    path('', include(router.urls)),
]
</file>

<file path="backend/organization/management/commands/__init__.py">
# Empty __init__.py file for commands package
</file>

<file path="backend/organization/management/__init__.py">
# Empty __init__.py file for Python package
</file>

<file path="backend/organization/admin.py">
from django.contrib import admin
from . import models

admin.site.register(models.Department)
admin.site.register(models.JobTitle)
admin.site.register(models.Position)
admin.site.register(models.PositionRequirement)
admin.site.register(models.PositionFunction)
</file>

<file path="backend/talent/models.py">
from django.db import models
from core.models import Person

# Mensajes de error estándar
UNIQUE_ERR_MSG = {'unique': "Ya existe un registro con este nombre."}

class BusinessFunction(models.Model):
    name = models.CharField(
        max_length=100, 
        unique=True, 
        help_text="Ej: Human Resources, Finance, IT",
        error_messages=UNIQUE_ERR_MSG
    )
    description = models.TextField(blank=True, null=True)
    def __str__(self): return self.name

class EducationLevel(models.Model):
    name = models.CharField(
        max_length=100, 
        unique=True, 
        help_text="Ej: Ingeniería, Maestría, Bachillerato",
        error_messages=UNIQUE_ERR_MSG
    )
    def __str__(self): return self.name

class FieldOfStudy(models.Model):
    name = models.CharField(
        max_length=100, 
        unique=True, 
        help_text="Ej: Software, Recursos Humanos, N/A",
        error_messages=UNIQUE_ERR_MSG
    )
    def __str__(self): return self.name

# --- Modelos Transaccionales ---

class PersonSpecialAssignment(models.Model):
    person = models.ForeignKey(Person, on_delete=models.CASCADE, related_name='special_assignments')
    project_name = models.CharField(max_length=255)
    description = models.TextField(blank=True, null=True)
    start_date = models.DateField()
    end_date = models.DateField(null=True, blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self): return self.project_name

class PersonFunctionalExperience(models.Model):
    person = models.ForeignKey(Person, on_delete=models.CASCADE, related_name='functional_experiences')
    function = models.ForeignKey(BusinessFunction, on_delete=models.SET_NULL, null=True)
    start_date = models.DateField()
    end_date = models.DateField(null=True, blank=True, help_text="NULL si es actual")
    comments = models.TextField(blank=True, null=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self): return f"{self.person} - {self.function}"

class PersonCertification(models.Model):
    person = models.ForeignKey(Person, on_delete=models.CASCADE, related_name='certifications')
    name = models.CharField(max_length=255)
    description = models.TextField(blank=True, null=True)
    institution = models.CharField(max_length=255)
    effective_date = models.DateField()
    expiration_date = models.DateField(null=True, blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    def __str__(self): return self.name

class CertificationDocument(models.Model):
    certification = models.ForeignKey(PersonCertification, on_delete=models.CASCADE, related_name='documents')
    file = models.FileField(upload_to='documents/certification/', blank=True, null=True)
    description = models.CharField(max_length=255, blank=True, null=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    def __str__(self): return self.description or "Documento de Certificación"

class PersonEducation(models.Model):
    person = models.ForeignKey(Person, on_delete=models.CASCADE, related_name='education_history')
    school_name = models.CharField(max_length=255)
    level = models.ForeignKey(EducationLevel, on_delete=models.SET_NULL, null=True)
    field_of_study = models.ForeignKey(FieldOfStudy, on_delete=models.SET_NULL, null=True)
    start_date = models.DateField()
    end_date = models.DateField(null=True, blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self): return f"{self.school_name} - {self.level}"

class PersonVolunteerExperience(models.Model):
    person = models.ForeignKey(Person, on_delete=models.CASCADE, related_name='volunteer_experiences')
    organization_name = models.CharField(max_length=255)
    role = models.CharField(max_length=255)
    start_date = models.DateField()
    end_date = models.DateField(null=True, blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    def __str__(self): return f"{self.organization_name} ({self.role})"

class PersonAward(models.Model):
    person = models.ForeignKey(Person, on_delete=models.CASCADE, related_name='awards')
    name = models.CharField(max_length=255)
    description = models.TextField(blank=True, null=True)
    institution = models.CharField(max_length=255, blank=True, null=True)
    issue_date = models.DateField()
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self): return self.name

class PersonMembership(models.Model):
    person = models.ForeignKey(Person, on_delete=models.CASCADE, related_name='memberships')
    organization_name = models.CharField(max_length=255)
    role = models.CharField(max_length=255, blank=True, null=True)
    start_date = models.DateField()
    end_date = models.DateField(null=True, blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    def __str__(self): return self.organization_name

class Language(models.Model):
    name = models.CharField(max_length=100, unique=True, error_messages=UNIQUE_ERR_MSG)
    def __str__(self): return self.name

class LanguageProficiency(models.Model):
    name = models.CharField(max_length=50, unique=True, error_messages=UNIQUE_ERR_MSG)
    def __str__(self): return self.name

class PersonLanguage(models.Model):
    person = models.ForeignKey(Person, on_delete=models.CASCADE, related_name="languages")
    language = models.ForeignKey(Language, on_delete=models.CASCADE)
    speaking_proficiency = models.ForeignKey(LanguageProficiency, on_delete=models.SET_NULL, null=True, blank=True, related_name="speaking")
    reading_proficiency = models.ForeignKey(LanguageProficiency, on_delete=models.SET_NULL, null=True, blank=True, related_name="reading")
    writing_proficiency = models.ForeignKey(LanguageProficiency, on_delete=models.SET_NULL, null=True, blank=True, related_name="writing")

    class Meta:
        constraints = [
            models.UniqueConstraint(
                fields=['person', 'language'],
                name='unique_person_language',
                violation_error_message="Esta persona ya tiene registrado este idioma."
            )
        ]

    def __str__(self): return f"{self.person} - {self.language}"
</file>

<file path="backend/talent/views.py">
from rest_framework import viewsets, permissions
from .models import (
    PersonSpecialAssignment, BusinessFunction, PersonFunctionalExperience,
    PersonCertification, CertificationDocument, EducationLevel, FieldOfStudy,
    PersonEducation, PersonVolunteerExperience, PersonAward, PersonMembership,
    Language, LanguageProficiency,PersonLanguage
)
from .serializers import (
    PersonSpecialAssignmentSerializer, BusinessFunctionSerializer, PersonFunctionalExperienceSerializer,
    PersonCertificationSerializer, CertificationDocumentSerializer, EducationLevelSerializer, FieldOfStudySerializer,
    PersonEducationSerializer, PersonVolunteerExperienceSerializer, PersonAwardSerializer, PersonMembershipSerializer,
    LanguageSerializer, LanguageProficiencySerializer, PersonLanguageSerializer
)
from core.filters import UnaccentSearchFilter

class PersonSpecialAssignmentViewSet(viewsets.ModelViewSet):
    queryset = PersonSpecialAssignment.objects.all()
    serializer_class = PersonSpecialAssignmentSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]

class BusinessFunctionViewSet(viewsets.ModelViewSet):
    queryset = BusinessFunction.objects.all()
    serializer_class = BusinessFunctionSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['name__unaccent']

class PersonFunctionalExperienceViewSet(viewsets.ModelViewSet):
    queryset = PersonFunctionalExperience.objects.all()
    serializer_class = PersonFunctionalExperienceSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]

class PersonCertificationViewSet(viewsets.ModelViewSet):
    serializer_class = PersonCertificationSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]

    def get_queryset(self):
        queryset = PersonCertification.objects.all()
        
        # --- FILTRO CRÍTICO ---
        person_id = self.request.query_params.get('person')
        if person_id:
            queryset = queryset.filter(person_id=person_id)
            
        return queryset

class CertificationDocumentViewSet(viewsets.ModelViewSet):
    queryset = CertificationDocument.objects.all()
    serializer_class = CertificationDocumentSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]

class EducationLevelViewSet(viewsets.ModelViewSet):
    queryset = EducationLevel.objects.all()
    serializer_class = EducationLevelSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['name__unaccent']

class FieldOfStudyViewSet(viewsets.ModelViewSet):
    queryset = FieldOfStudy.objects.all()
    serializer_class = FieldOfStudySerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['name__unaccent']

class PersonEducationViewSet(viewsets.ModelViewSet):
    serializer_class = PersonEducationSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]

    def get_queryset(self):
        # Optimizamos la consulta trayendo los nombres de Nivel y Campo
        queryset = PersonEducation.objects.select_related('level', 'field_of_study')
        
        # --- FILTRO CRÍTICO ---
        # Obtenemos el ID de la persona desde la URL (?person=1)
        person_id = self.request.query_params.get('person')
        if person_id:
            queryset = queryset.filter(person_id=person_id)
            
        return queryset

class PersonVolunteerExperienceViewSet(viewsets.ModelViewSet):
    queryset = PersonVolunteerExperience.objects.all()
    serializer_class = PersonVolunteerExperienceSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]

class PersonAwardViewSet(viewsets.ModelViewSet):
    queryset = PersonAward.objects.all()
    serializer_class = PersonAwardSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]

class PersonMembershipViewSet(viewsets.ModelViewSet):
    queryset = PersonMembership.objects.all()
    serializer_class = PersonMembershipSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]

class LanguageViewSet(viewsets.ModelViewSet):
    queryset = Language.objects.all()
    serializer_class = LanguageSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['name__unaccent']

class LanguageProficiencyViewSet(viewsets.ModelViewSet):
    queryset = LanguageProficiency.objects.all()
    serializer_class = LanguageProficiencySerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['name__unaccent']

class PersonLanguageViewSet(viewsets.ModelViewSet):
    serializer_class = PersonLanguageSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]

    def get_queryset(self):
        # Optimizamos la consulta trayendo los nombres de los idiomas y niveles
        queryset = PersonLanguage.objects.select_related(
            'language', 
            'speaking_proficiency', 
            'reading_proficiency', 
            'writing_proficiency'
        )
        
        # --- FILTRO CRÍTICO ---
        person_id = self.request.query_params.get('person')
        if person_id:
            queryset = queryset.filter(person_id=person_id)
            
        return queryset
</file>

<file path="backend/training/serializers.py">
from rest_framework import serializers
from django.db import transaction
from django.core.exceptions import ValidationError
from core.models import Person
# --- IMPORTAMOS LAS UTILIDADES NECESARIAS ---
from core.serializers import ( 
    title_case_cleaner, 
    sentence_case_cleaner, 
    check_uniqueness,
    validate_text_with_spaces,
    validate_min_length
)
from .models import (
    Course, CourseResource, CourseSession, CourseParticipant, AttendanceRecord
)

# --- SERIALIZERS DE AYUDA Y AUDITORÍA ---
class AttendanceRecordSerializer(serializers.ModelSerializer):
    person_name = serializers.CharField(source='participant.person.__str__', read_only=True)
    status_display = serializers.CharField(source='get_status_display', read_only=True)
    
    class Meta: 
        model = AttendanceRecord
        fields = '__all__'

class ParticipantListSerializer(serializers.ModelSerializer):
    person_name = serializers.CharField(source='person.__str__', read_only=True)
    person_id = serializers.IntegerField(source='person.id', read_only=True)
    role_name = serializers.CharField(source='get_role_display', read_only=True)
    enrollment_status_name = serializers.CharField(source='get_enrollment_status_display', read_only=True)
    academic_status_name = serializers.CharField(source='get_academic_status_display', read_only=True)

    class Meta:
        model = CourseParticipant
        fields = ['id', 'person_id', 'person_name', 'role', 'role_name', 'enrollment_status', 'enrollment_status_name', 'academic_status', 'academic_status_name', 'grade']


# --- 1. RECURSOS (Con Limpieza y Validación) ---
class CourseResourceSerializer(serializers.ModelSerializer):
    file_url = serializers.FileField(source='file', read_only=True)
    
    class Meta: 
        model = CourseResource
        fields = '__all__'
        
    def validate_name(self, value):
        # Limpieza y validación de nombre (Título)
        cleaned_value = title_case_cleaner(validate_text_with_spaces(value, 'Nombre'))
        validate_min_length(cleaned_value, 2)
        
        # Validación de unicidad GLOBAL para Recursos (Evita dos PDF con el mismo nombre)
        return check_uniqueness(self.Meta.model, 'name', cleaned_value, self.instance, 
                                error_msg="Ya existe un recurso con este nombre en el sistema.")

    def validate(self, data):
        # Lógica para asegurar que SÓLO se sube un archivo O un link, no ambos.
        file = data.get('file')
        url = data.get('url')
        
        if data.get('resource_type') == 'FIL' and not file and not url:
            raise serializers.ValidationError({"file": "Debe subir un archivo o URL para este tipo."})
            
        if data.get('resource_type') == 'URL' and not url and not file:
            raise serializers.ValidationError({"url": "Debe proporcionar una URL."})
            
        if file and url:
             raise serializers.ValidationError("Un recurso no puede ser archivo y URL al mismo tiempo.")
             
        return data


# --- 2. SESIONES (Con Limpieza y Validación por Curso y Fecha) ---
class CourseSessionSerializer(serializers.ModelSerializer):
    course_name = serializers.CharField(source='course.name', read_only=True)
    
    class Meta: 
        model = CourseSession
        fields = '__all__'

    def validate_topic(self, value):
        # Limpieza de topic (título de sesión)
        return title_case_cleaner(value)

    def validate(self, data):
        topic = data.get('topic')
        course = data.get('course')
        date = data.get('date')
        
        # Validación de unicidad del tema DENTRO del curso y fecha
        # No pueden existir dos sesiones en el mismo curso con el mismo tema el mismo día
        qs = CourseSession.objects.filter(topic__iexact=topic, course=course, date=date)
        if self.instance:
            qs = qs.exclude(pk=self.instance.pk)
        if qs.exists():
            raise serializers.ValidationError({"topic": f"Ya existe una sesión sobre '{topic}' programada para esta fecha y curso."})
            
        return data


# --- 3. PARTICIPANTES (Lógica de Cupo y Unicidad de Persona/Curso) ---
# training/serializers.py

class CourseParticipantSerializer(serializers.ModelSerializer):
    person_name = serializers.CharField(source='person.__str__', read_only=True)
    role_name = serializers.CharField(source='get_role_display', read_only=True)
    enrollment_status_name = serializers.CharField(source='get_enrollment_status_display', read_only=True)
    academic_status_name = serializers.CharField(source='get_academic_status_display', read_only=True)
    
    class Meta:
        model = CourseParticipant
        fields = '__all__'
        
        # 🚨 IMPORTANTE: Esto apaga la validación automática de "Conjunto Único"
        # Nos permite manejar la unicidad manualmente en el método validate()
        validators = [] 

    @transaction.atomic
    def validate(self, data):
        """Lógica de validación separada para Creación vs. Edición."""
        
        # Recuperamos la instancia (si existe, es una EDICIÓN)
        instance = self.instance
        
        # Obtenemos los datos finales (ya sea del payload o de la base de datos)
        course = data.get('course', getattr(instance, 'course', None))
        person = data.get('person', getattr(instance, 'person', None))
        role = data.get('role', getattr(instance, 'role', None))

        # -----------------------------------------------------
        # CASO 1: CREACIÓN (NUEVA INSCRIPCIÓN)
        # -----------------------------------------------------
        if not instance:
            
            # A. Validación Manual de Duplicados
            # (Reemplaza el mensaje feo de "Conjunto único")
            if CourseParticipant.objects.filter(course=course, person=person).exists():
                raise serializers.ValidationError({
                    "person": f"La persona '{person}' ya está registrada en este curso."
                })

            # B. Reglas de Negocio para Estudiantes NUEVOS
            if role == CourseParticipant.Role.STUDENT:
                
                # El curso debe estar en una fase que permita inscripciones
                if course.status not in [Course.Status.SCHEDULED, Course.Status.IN_PROGRESS]:
                     raise serializers.ValidationError({
                        "course": f"No se pueden inscribir nuevos estudiantes. El curso está '{course.get_status_display()}'."
                     })

                # El curso no debe estar lleno
                if course.is_full:
                    raise serializers.ValidationError({
                        "course": f"Cupo lleno ({course.max_participants} máx). No se admiten más inscripciones."
                    })

        # -----------------------------------------------------
        # CASO 2: EDICIÓN (EVALUACIÓN / CAMBIOS)
        # -----------------------------------------------------
        if instance:
            # Aquí SOLO validamos cosas que tengan sentido al editar.
            # NO validamos cupo ni estado del curso (porque ya están dentro).
            
            grade = data.get('grade')
            if grade is not None and (grade < 0 or grade > 20):
                 raise serializers.ValidationError({"grade": "La nota debe estar entre 0 y 20."})

        return data


# --- 4. CURSO (PRINCIPAL) ---
class CourseSerializer(serializers.ModelSerializer):
    
    # 🚨 CAMBIO CRÍTICO: De IntegerField a SerializerMethodField
    enrolled_count = serializers.SerializerMethodField() 
    
    is_full = serializers.BooleanField(read_only=True)
    modality_display = serializers.CharField(source='get_modality_display', read_only=True)
    status_name = serializers.CharField(source='get_status_display', read_only=True)
    
    # Anidaciones (para la vista de detalle)
    resources = CourseResourceSerializer(many=True, read_only=True)
    sessions = CourseSessionSerializer(many=True, read_only=True)
    
    # SerializerMethodField (Instructores/Estudiantes separados)
    instructors = serializers.SerializerMethodField()
    students = serializers.SerializerMethodField()

    class Meta:
        model = Course
        fields = '__all__'
    
    # --- MÉTODO PARA CALCULAR EL CUPO OFICIAL ---
    def get_enrolled_count(self, obj):
        """
        Calcula el número de estudiantes que ocupan un cupo oficialmente (Inscrito o Aprobado).
        """
        # Aseguramos que solo contamos a los estudiantes, no a los instructores.
        # Contamos a los que están oficialmente inscritos (ENR)
        
        return obj.participants.filter(
            role=CourseParticipant.Role.STUDENT, 
            enrollment_status=CourseParticipant.EnrollmentStatus.ENROLLED
        ).count()
    
    # 🚨 INTEGRACIÓN DE LIMPIEZA Y UNICIDAD EN EL MODELO PRINCIPAL 🚨
    def validate_name(self, value):
        cleaned_value = title_case_cleaner(validate_text_with_spaces(value, 'Nombre'))
        validate_min_length(cleaned_value, 2)
        return check_uniqueness(Course, 'name', cleaned_value, self.instance, error_msg="Ya existe un curso con este nombre.")

    def validate_description(self, value):
        return sentence_case_cleaner(value)
    
    def save(self, **kwargs):
        if 'name' in self.validated_data:
            self.validated_data['name'] = title_case_cleaner(self.validated_data['name'])
        if 'description' in self.validated_data:
            self.validated_data['description'] = sentence_case_cleaner(self.validated_data['description'])
        return super().save(**kwargs)

    def get_instructors(self, obj):
        qs = obj.participants.filter(role=CourseParticipant.Role.INSTRUCTOR).select_related('person')
        return ParticipantListSerializer(qs, many=True).data

    def get_students(self, obj):
        qs = obj.participants.filter(role=CourseParticipant.Role.STUDENT).select_related('person')
        return ParticipantListSerializer(qs, many=True).data
</file>

<file path="backend/.gitignore">
# See https://help.github.com/articles/ignoring-files/ for more about ignoring files.

# dependencies
/node_modules
/.pnp
.pnp.*
.yarn/*
!.yarn/patches
!.yarn/plugins
!.yarn/releases
!.yarn/versions

# testing
/coverage

# next.js
/.next/
/out/

# production
/build

# misc
.DS_Store
*.pem

# debug
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.pnpm-debug.log*

# env files (can opt-in for committing if needed)
.env*

# vercel
.vercel

# typescript
*.tsbuildinfo
next-env.d.ts
# db.sqlite3

/media
</file>

<file path="frontend2/app/(main)/admin/config/general/[slug]/page.tsx">
"use client";

import { CatalogCRUD, CatalogField } from "@/components/catalogs/catalog-crud";
import { ColumnDef } from "@tanstack/react-table";
import { notFound } from "next/navigation";
import { use } from "react";
import { Globe, Users, Heart, MapPin, Phone, Smartphone, Mail, Building2, CreditCard, Link, Map } from "lucide-react";

interface CatalogConfig {
    title: string;
    apiUrl: string;
    fields: CatalogField[];
    columns: ColumnDef<any>[];
    searchKey?: string;
    searchOptions?: { label: string; value: string }[];
    icon?: React.ElementType;
}

const simpleNameColumns: ColumnDef<any>[] = [
    {
        accessorKey: "name",
        header: "Nombre",
        cell: ({ row }) => <div className="truncate">{row.getValue("name")}</div>
    },
];

const simpleNameFields: CatalogField[] = [
    {
        name: "name",
        label: "Nombre",
        type: "text",
        required: true,
    },
];

const catalogs: Record<string, CatalogConfig> = {
    countries: {
        title: "Países",
        icon: Globe,
        apiUrl: "/api/core/countries/",
        fields: [
            { name: "name", label: "Nombre", type: "text", required: true },
            { name: "iso_2", label: "Código ISO", type: "text", required: true },
        ],
        columns: [
            { accessorKey: "name", header: "Nombre", cell: ({ row }) => <div className="truncate">{row.getValue("name")}</div> },
            { accessorKey: "iso_2", header: "ISO", cell: ({ row }) => <div className="max-w-[50px] truncate">{row.getValue("iso_2")}</div> },
        ],
        searchKey: "name",
        searchOptions: [
            { label: "Nombre", value: "name" },
            { label: "Código ISO", value: "iso_2" }
        ]
    },
    genders: {
        title: "Géneros",
        icon: Users,
        apiUrl: "/api/core/genders/",
        fields: simpleNameFields,
        columns: simpleNameColumns,
        searchKey: "name",
    },
    "marital-statuses": {
        title: "Estados Civiles",
        icon: Heart,
        apiUrl: "/api/core/marital-statuses/",
        fields: simpleNameFields,
        columns: simpleNameColumns,
        searchKey: "name",
    },
    "address-types": {
        title: "Tipos de Dirección",
        icon: MapPin,
        apiUrl: "/api/core/address-types/",
        fields: simpleNameFields,
        columns: simpleNameColumns,
        searchKey: "name",
    },
    "phone-types": {
        title: "Tipos de Teléfono",
        icon: Phone,
        apiUrl: "/api/core/phone-types/",
        fields: simpleNameFields,
        columns: simpleNameColumns,
        searchKey: "name",
    },
    "phone-carriers": {
        title: "Operadoras Telefónicas",
        icon: Smartphone,
        apiUrl: "/api/core/phone-carriers/",
        fields: simpleNameFields,
        columns: simpleNameColumns,
        searchKey: "name",
    },
    "email-types": {
        title: "Tipos de Email",
        icon: Mail,
        apiUrl: "/api/core/email-types/",
        fields: simpleNameFields,
        columns: simpleNameColumns,
        searchKey: "name",
    },
    banks: {
        title: "Bancos",
        icon: Building2,
        apiUrl: "/api/core/banks/",
        fields: [
            { name: "name", label: "Nombre", type: "text", required: true },
            { name: "code", label: "Código", type: "text", required: true },
        ],
        columns: [
            { accessorKey: "name", header: "Nombre", cell: ({ row }) => <div className="truncate">{row.getValue("name")}</div> },
            { accessorKey: "code", header: "Código", cell: ({ row }) => <div className="max-w-[100px] truncate">{row.getValue("code")}</div> },
        ],
        searchKey: "name",
        searchOptions: [
            { label: "Nombre", value: "name" },
            { label: "Código", value: "code" }
        ]
    },
    "bank-account-types": {
        title: "Tipos de Cuenta Bancaria",
        icon: CreditCard,
        apiUrl: "/api/core/bank-account-types/",
        fields: simpleNameFields,
        columns: simpleNameColumns,
        searchKey: "name",
    },
    "relationship-types": {
        title: "Tipos de Relación",
        icon: Link,
        apiUrl: "/api/core/relationship-types/",
        fields: simpleNameFields,
        columns: simpleNameColumns,
        searchKey: "name",
    },
    states: {
        title: "Estados",
        icon: Map,
        apiUrl: "/api/core/states/",
        fields: [
            { name: "name", label: "Nombre", type: "text", required: true },
            {
                name: "country",
                label: "País",
                type: "select",
                required: true,
                optionsUrl: "/api/core/countries/",
                optionLabelKey: "name",
                optionValueKey: "id"
            },
        ],
        columns: [
            { accessorKey: "name", header: "Nombre", cell: ({ row }) => <div className="truncate">{row.getValue("name")}</div> },
            { accessorKey: "country.name", header: "País", cell: ({ row }) => <div className="truncate">{row.original.country?.name}</div> },
        ],
        searchKey: "name",
        searchOptions: [
            { label: "Nombre", value: "name" },
            { label: "País", value: "country__name" }
        ]
    },
    "phone-carrier-codes": {
        title: "Códigos de Operadora",
        icon: Smartphone,
        apiUrl: "/api/core/phone-carrier-codes/",
        fields: [
            { name: "code", label: "Código", type: "text", required: true },
            {
                name: "carrier",
                label: "Operadora",
                type: "select",
                required: true,
                optionsUrl: "/api/core/phone-carriers/",
                optionLabelKey: "name",
                optionValueKey: "id"
            },
        ],
        columns: [
            { accessorKey: "code", header: "Código", cell: ({ row }) => <div className="truncate">{row.getValue("code")}</div> },
            { accessorKey: "carrier.name", header: "Operadora", cell: ({ row }) => <div className="truncate">{row.original.carrier?.name}</div> },
        ],
        searchKey: "code",
        searchOptions: [
            { label: "Código", value: "code" },
            { label: "Operadora", value: "carrier__name" }
        ]
    },
};

export default function DynamicCatalogPage({ params }: { params: Promise<{ slug: string }> }) {
    const { slug } = use(params);
    const config = catalogs[slug];

    if (!config) {
        notFound();
    }

    return (
        <CatalogCRUD
            title={config.title}
            icon={config.icon}
            apiUrl={config.apiUrl}
            fields={config.fields}
            columns={config.columns}
            searchKey={config.searchKey}
            searchOptions={config.searchOptions}
        />
    );
}
</file>

<file path="frontend2/app/(main)/admin/organization/[slug]/page.tsx">
"use client";

import { CatalogCRUD, CatalogField } from "@/components/catalogs/catalog-crud";
import { ColumnDef } from "@tanstack/react-table";
import { notFound } from "next/navigation";
import { use } from "react";
import Link from "next/link";
import { Button } from "@/components/ui/button";
import { Eye } from "lucide-react";
import { DropdownMenuItem } from "@/components/ui/dropdown-menu";

interface CatalogConfig {
    title: string;
    apiUrl: string;
    fields: CatalogField[];
    columns: ColumnDef<any>[];
    searchKey?: string;
    searchOptions?: { label: string; value: string }[];
    extraActions?: (item: any) => React.ReactNode;
}

const simpleNameColumns: ColumnDef<any>[] = [
    {
        accessorKey: "name",
        header: "Nombre",
        cell: ({ row }) => <div className="truncate">{row.getValue("name")}</div>
    },
];

const simpleNameFields: CatalogField[] = [
    {
        name: "name",
        label: "Nombre",
        type: "text",
        required: true,
    },
];

const configs: Record<string, CatalogConfig> = {
    departments: {
        title: "Departamentos",
        apiUrl: "/api/organization/departments/",
        fields: [
            { name: "name", label: "Nombre", type: "text", required: true },
            {
                name: "parent",
                label: "Departamento Padre",
                type: "select",
                required: false,
                optionsUrl: "/api/organization/departments/",
                optionLabelKey: "name",
                optionValueKey: "id"
            },
        ],
        columns: [
            { accessorKey: "name", header: "Nombre", cell: ({ row }) => <div className="truncate">{row.getValue("name")}</div> },
            { accessorKey: "parent.name", header: "Padre", cell: ({ row }) => <div className="truncate">{row.original.parent?.name || "-"}</div> },
        ],
        searchKey: "name",
        searchOptions: [
            { label: "Nombre", value: "name" }
        ]
    },
    "job-titles": {
        title: "Títulos de Cargo",
        apiUrl: "/api/organization/job-titles/",
        fields: simpleNameFields,
        columns: simpleNameColumns,
        searchKey: "name",
        searchOptions: [
            { label: "Nombre", value: "name" }
        ]
    },
    positions: {
        title: "Posiciones",
        apiUrl: "/api/organization/positions/",
        fields: [
            { name: "job_title", label: "Cargo", type: "select", required: true, optionsUrl: "/api/organization/job-titles/", optionLabelKey: "name", optionValueKey: "id" },
            { name: "department", label: "Departamento", type: "select", required: true, optionsUrl: "/api/organization/departments/", optionLabelKey: "name", optionValueKey: "id" },
            { name: "manager_positions", label: "Jefes Inmediatos", type: "select", required: false, optionsUrl: "/api/organization/positions/?is_manager=true", optionLabelKey: "full_name", optionValueKey: "id" },
            { name: "vacancies", label: "Vacantes", type: "number", required: true },
            { name: "is_manager", label: "Es Gerencial", type: "checkbox", required: false },
        ],
        columns: [
            { accessorKey: "job_title_name", header: "Cargo", cell: ({ row }) => <div className="truncate">{row.original.job_title_name}</div> },
            { accessorKey: "department_name", header: "Departamento", cell: ({ row }) => <div className="truncate">{row.getValue("department_name")}</div> },
            { accessorKey: "active_employees_count", header: "Ocupados", cell: ({ row }) => <div className="text-center">{row.getValue("active_employees_count")}</div> },
            { accessorKey: "vacancies", header: "Vacantes", cell: ({ row }) => <div className="text-center">{row.getValue("vacancies")}</div> },
        ],
        searchKey: "job_title__name",
        searchOptions: [
            { label: "Cargo", value: "job_title__name" },
            { label: "Departamento", value: "department__name" }
        ],
        extraActions: (item) => (
            <DropdownMenuItem asChild>
                <Link href={`/admin/organization/positions/${item.id}`} className="cursor-pointer w-full flex items-center">
                    <Eye className="mr-2 h-4 w-4" />
                    Ver Detalle
                </Link>
            </DropdownMenuItem>
        )
    },
    "person-department-roles": {
        title: "Roles Jerárquicos",
        apiUrl: "/api/employment/person-department-roles/",
        fields: [
            {
                name: "person",
                label: "Persona",
                type: "select",
                required: true,
                optionsUrl: "/api/core/persons/",
                optionLabelKey: "full_name",
                optionValueKey: "id"
            },
            {
                name: "department",
                label: "Departamento",
                type: "select",
                required: true,
                optionsUrl: "/api/organization/departments/",
                optionLabelKey: "name",
                optionValueKey: "id"
            },
            {
                name: "hierarchical_role",
                label: "Rol Jerárquico",
                type: "select",
                required: true,
                options: [
                    { label: "Gerente", value: "MGR" },
                    { label: "Empleado", value: "EMP" }
                ]
            },
            {
                name: "start_date",
                label: "Fecha de Inicio",
                type: "date",
                required: true
            },
            {
                name: "end_date",
                label: "Fecha de Fin",
                type: "date",
                required: false
            },
            {
                name: "notes",
                label: "Notas",
                type: "textarea",
                required: false
            }
        ],
        columns: [
            { accessorKey: "person_name", header: "Persona", cell: ({ row }) => <div className="truncate">{row.original.person_name}</div> },
            { accessorKey: "department_name", header: "Departamento", cell: ({ row }) => <div className="truncate">{row.original.department_name}</div> },
            { accessorKey: "hierarchical_role_display", header: "Rol", cell: ({ row }) => <div className="truncate">{row.original.hierarchical_role_display}</div> },
            { accessorKey: "start_date", header: "Inicio", cell: ({ row }) => <div className="truncate">{row.getValue("start_date")}</div> },
            { accessorKey: "is_current", header: "Vigente", cell: ({ row }) => <div className="truncate">{row.original.is_current ? "Sí" : "No"}</div> },
        ],
        searchKey: "person_name",
        searchOptions: [
            { label: "Persona", value: "person__first_name" }, // Assuming person has first_name, or use full_name if supported
            { label: "Departamento", value: "department__name" }
        ]
    },
};

export default function OrganizationDynamicCatalogPage({ params }: { params: Promise<{ slug: string }> }) {
    const { slug } = use(params);
    const config = configs[slug];

    if (!config) {
        notFound();
    }

    return (
        <div className="h-full flex-1 flex-col space-y-8 p-8 md:flex">
            <CatalogCRUD
                title={config.title}
                apiUrl={config.apiUrl}
                fields={config.fields}
                columns={config.columns}
                searchKey={config.searchKey}
                searchOptions={config.searchOptions}
                extraActions={config.extraActions}
            />
        </div>
    );
}
</file>

<file path="frontend2/components/layout/sidebar.tsx">
"use client";

import { useState } from "react";
import Link from "next/link";
import { usePathname } from "next/navigation";
import {
    LayoutDashboard,
    Users,
    Network,
    GraduationCap,
    Briefcase,
    ClipboardCheck,
    Settings,
    ChevronRight,
    ChevronDown,
    Circle,
    ContactRound,
    Building2,
    Calculator,
    Clock,
    PiggyBank,
    Gauge,
    TrendingUpDown,
    BookOpenText,
    ClipboardList
} from "lucide-react";
import { cn } from "@/lib/utils";
import { IutirlaLogo } from "../iutirla-logo";

interface SidebarProps {
    collapsed: boolean;
    role?: "admin" | "employee";
}

interface MenuItem {
    label: string;
    icon: React.ElementType;
    badge?: {
        text: string;
        variant: "primary" | "secondary" | "tertiary";
    };
    children?: {
        label: string;
        href: string;
        icon: React.ElementType;
    }[];
    href?: string;
}

const employeeMenuItems: MenuItem[] = [
    {
        label: "Datos Personales",
        href: "/employee/personal-data",
        icon: ContactRound,
    },
    {
        label: "Datos del Puesto",
        href: "/employee/job-data",
        icon: Building2,
    },
    {
        label: "Compensación",
        href: "/employee/compensation",
        icon: Calculator,
    },
    {
        label: "Gestión del Tiempo",
        href: "/employee/time-management",
        icon: Clock,
    },
    {
        label: "Beneficios",
        href: "/employee/benefits",
        icon: PiggyBank,
    },
    {
        label: "Rendimiento y Metas",
        href: "/employee/performance-goals",
        icon: Gauge,
    },
    {
        label: "Sucesión",
        href: "/employee/succession",
        icon: TrendingUpDown,
    },
    {
        label: "Aprendizaje y Desarrollo",
        href: "/employee/learning-development",
        icon: BookOpenText,
    },
    {
        label: "Perfil de Talento",
        href: "/employee/talent-profile",
        icon: ClipboardList,
    },
];

const adminMenuItems: MenuItem[] = [
    {
        label: "Dashboard",
        icon: LayoutDashboard,
        href: "/admin/dashboard"
    },
    {
        label: "Gestión de Personal",
        icon: Users,
        children: [
            { label: "Empleados", href: "/admin/personnel/employees", icon: Circle },
            { label: "Todas las personas", href: "/admin/personnel/people", icon: Circle },
        ],
    },
    {
        label: "Organización",
        icon: Network,
        href: "/admin/organization"
    },
    {
        label: "Capacitación",
        icon: GraduationCap,
        children: [
            { label: "Catálogo de Cursos", href: "/admin/training/courses", icon: Circle },
        ],
    },
    {
        label: "Reclutamiento",
        icon: Briefcase,
        children: [
            { label: "Vacantes", href: "/admin/ats/jobs", icon: Circle },
            { label: "Candidatos", href: "/admin/ats/candidates", icon: Circle },
        ],
    },
    {
        label: "Evaluación",
        icon: ClipboardCheck,
        children: [
            { label: "Periodos y Procesos", href: "/admin/performance/periods", icon: Circle },
        ],
    },
    {
        label: "Configuración",
        icon: Settings,
        children: [
            { label: "Catálogos generales", href: "/admin/config/general", icon: Circle },
            { label: "Catálogos de talento", href: "/admin/config/talent", icon: Circle },
            { label: "Catálogos de desempeño", href: "/admin/config/performance", icon: Circle },
        ],
    },
    {
        label: "Mi Información",
        icon: ContactRound,
        children: employeeMenuItems.map(item => ({
            label: item.label,
            href: item.href || "#",
            icon: item.icon
        }))
    }
];

export function SidebarContent({ collapsed, role = "admin" }: { collapsed: boolean; role?: "admin" | "employee" }) {
    const [expandedItems, setExpandedItems] = useState<string[]>(["Personal"]);
    const pathname = usePathname();
    const menuItems = role === "admin" ? adminMenuItems : employeeMenuItems;

    const toggleItem = (label: string) => {
        setExpandedItems(prev =>
            prev.includes(label)
                ? prev.filter(item => item !== label)
                : [...prev, label]
        );
    };

    const getBadgeClasses = (variant: "primary" | "secondary" | "tertiary") => {
        switch (variant) {
            case "primary":
                return "bg-brand-primary text-brand-primary-foreground";
            case "secondary":
                return "bg-brand-secondary text-brand-secondary-foreground";
            case "tertiary":
                return "bg-brand-tertiary text-brand-tertiary-foreground";
        }
    };

    const isActive = (href: string) => pathname === href || pathname?.startsWith(href + "/");
    const isChildActive = (children: { href: string }[]) => children.some(child => isActive(child.href));

    return (
        <div className="flex flex-col h-full">
            {/* Sidebar Header (Brand) */}
            <div className="h-14 flex items-center border-b border-border shrink-0 overflow-hidden transition-all duration-300">
                <div className="flex items-center h-full w-full transition-all duration-300">
                    <IutirlaLogo collapsed={collapsed} />
                </div>
            </div>

            {/* Navigation */}
            <nav className={cn("overflow-y-auto overflow-x-hidden flex-1 my-2")}>
                <ul className="space-y-1">
                    {menuItems.map((item, index) => {
                        const isExpanded = expandedItems.includes(item.label);
                        const hasChildren = item.children && item.children.length > 0;
                        const isLink = !hasChildren && item.href;

                        // Determine active states
                        const isItemActive = isLink && item.href ? isActive(item.href) : false;
                        const isParentActive = hasChildren && item.children ? isChildActive(item.children) : false;

                        const ItemContent = (
                            <>
                                <div className={cn(
                                    "w-12 flex items-center justify-center shrink-0 transition-colors self-stretch",
                                    isItemActive ? "text-white" : (isParentActive ? "text-brand-primary" : "text-muted-foreground")
                                )}>
                                    <item.icon className="size-5" />
                                </div>

                                {!collapsed && (
                                    <div className="flex-1 flex items-center min-w-0 pr-3 py-2.5">
                                        <span className={cn(
                                            "flex-1 text-sm text-left font-medium truncate",
                                            isItemActive ? "text-white" : (isParentActive ? "text-brand-primary" : "text-foreground")
                                        )}>
                                            {item.label}
                                        </span>

                                        {item.badge && (
                                            <span className={cn(
                                                "px-2 py-0.5 rounded-full text-[10px] font-bold ml-2",
                                                getBadgeClasses(item.badge.variant)
                                            )}>
                                                {item.badge.text}
                                            </span>
                                        )}

                                        {hasChildren && (
                                            <div className={cn(
                                                "ml-2",
                                                isParentActive ? "text-brand-primary" : "text-muted-foreground"
                                            )}>
                                                {isExpanded ? (
                                                    <ChevronDown className="w-4 h-4" />
                                                ) : (
                                                    <ChevronRight className="w-4 h-4" />
                                                )}
                                            </div>
                                        )}
                                    </div>
                                )}

                                {/* Tooltip for collapsed state */}
                                {collapsed && (
                                    <div className="absolute left-full ml-2 px-3 py-2 bg-card border border-border rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all whitespace-nowrap z-50 top-0">
                                        <span className="text-sm text-foreground font-medium">
                                            {item.label}
                                        </span>
                                        {item.badge && (
                                            <span className={cn(
                                                "ml-2 px-2 py-0.5 rounded-full text-[10px] font-bold",
                                                getBadgeClasses(item.badge.variant)
                                            )}>
                                                {item.badge.text}
                                            </span>
                                        )}
                                    </div>
                                )}
                            </>
                        );

                        const itemClasses = cn(
                            "flex items-center transition-colors relative group min-h-[44px] mx-2 rounded-lg w-[calc(100%-16px)] cursor-pointer",
                            isItemActive
                                ? "bg-brand-primary hover:bg-brand-primary/90"
                                : (isParentActive
                                    ? "bg-brand-primary/10 hover:bg-brand-primary/20"
                                    : "hover:bg-accent"),
                            isExpanded && hasChildren && !isParentActive && "bg-muted"
                        );

                        return (
                            <li key={index}>
                                {/* Parent Item */}
                                {isLink ? (
                                    <Link href={item.href!} className={itemClasses} title={collapsed ? item.label : undefined}>
                                        {ItemContent}
                                    </Link>
                                ) : (
                                    <button
                                        onClick={() => hasChildren && toggleItem(item.label)}
                                        className={itemClasses}
                                        title={collapsed ? item.label : undefined}
                                    >
                                        {ItemContent}
                                    </button>
                                )}

                                {/* Children Items */}
                                {hasChildren && isExpanded && (
                                    <ul className="mt-1 space-y-1">
                                        {item.children?.map((child, childIndex) => {
                                            const isChildItemActive = isActive(child.href);

                                            return (
                                                <li key={childIndex}>
                                                    <Link
                                                        href={child.href}
                                                        className={cn(
                                                            "flex items-center transition-colors relative group min-h-[44px] mx-2 rounded-lg w-[calc(100%-16px)]",
                                                            isChildItemActive
                                                                ? "bg-brand-primary hover:bg-brand-primary/90"
                                                                : "hover:bg-accent"
                                                        )}
                                                    >
                                                        <div className={cn(
                                                            "w-12 flex items-center justify-center shrink-0 transition-colors self-stretch",
                                                            isChildItemActive ? "text-white" : "text-muted-foreground"
                                                        )}>
                                                            <child.icon className="size-5" />
                                                        </div>
                                                        {!collapsed && (
                                                            <div className="flex-1 flex items-center min-w-0 pr-3 py-2.5">
                                                                <span className={cn(
                                                                    "flex-1 text-sm text-left font-medium truncate",
                                                                    isChildItemActive ? "text-white" : "text-foreground"
                                                                )}>
                                                                    {child.label}
                                                                </span>
                                                            </div>
                                                        )}
                                                        {/* Tooltip for collapsed state (Child) */}
                                                        {collapsed && (
                                                            <div className="absolute left-full ml-2 px-3 py-2 bg-card border border-border rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all whitespace-nowrap z-50 top-0">
                                                                <span className="text-sm text-foreground font-medium">
                                                                    {child.label}
                                                                </span>
                                                            </div>
                                                        )}
                                                    </Link>
                                                </li>
                                            );
                                        })}
                                    </ul>
                                )}
                            </li>
                        );
                    })}
                </ul>
            </nav>
        </div>
    );
}

export function Sidebar({ collapsed, role = "admin" }: SidebarProps) {
    const [isHovered, setIsHovered] = useState(false);
    const isEffectiveCollapsed = collapsed && !isHovered;

    return (
        <aside
            className={cn(
                "fixed left-0 top-0 h-screen bg-card border-r border-border transition-all duration-300 z-40 overflow-hidden flex flex-col shadow-[6px_0_15px_-4px_rgba(0,0,0,0.15)]",
                isEffectiveCollapsed ? "w-16" : "w-64"
            )}
            onMouseEnter={() => setIsHovered(true)}
            onMouseLeave={() => setIsHovered(false)}
        >
            <SidebarContent collapsed={isEffectiveCollapsed} role={role} />
        </aside>
    );
}
</file>

<file path="backend/config/settings.py">
from pathlib import Path
from datetime import timedelta
import os
import environ

# Initialise environ
env = environ.Env()
environ.Env.read_env()

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent

# Take environment variables from .env file
environ.Env.read_env(os.path.join(BASE_DIR, '.env'))


# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/5.2/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = 'django-insecure-(lq13ma@==7x+84n_65_*7*d3=3j#%w107y@h@91*g(fpq6n$!'

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True

ALLOWED_HOSTS = []


# Application definition

DJANGO_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sites', # Requerido por dj-rest-auth
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
]

THIRD_PARTY_APPS = [
    'rest_framework',
    # 'rest_framework.authtoken',
    'dj_rest_auth',
    'rest_framework_simplejwt',
    'allauth',
    'allauth.account',
    # 'dj_rest_auth.registration',
    'corsheaders',
    'simple_history',
]

PROJECT_APPS = [
    'core',
    'accounts',
    'organization',
    'employment',
    'talent',
    'training',
    'performance',
    'ats',
]

INSTALLED_APPS = DJANGO_APPS + THIRD_PARTY_APPS + PROJECT_APPS

MIDDLEWARE = [
    "corsheaders.middleware.CorsMiddleware",
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
    "allauth.account.middleware.AccountMiddleware",
    'simple_history.middleware.HistoryRequestMiddleware',
]

ROOT_URLCONF = 'config.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'config.wsgi.application'


# Database
# https://docs.djangoproject.com/en/5.2/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}


# Password validation
# https://docs.djangoproject.com/en/5.2/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]


# Internationalization
# https://docs.djangoproject.com/en/5.2/topics/i18n/

LANGUAGE_CODE = 'es-ve'

TIME_ZONE = 'America/Caracas'

# USE_I18N = True

# USE_TZ = True


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/5.2/howto/static-files/

STATIC_URL = 'static/'

# Default primary key field type
# https://docs.djangoproject.com/en/5.2/ref/settings/#default-auto-field

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

AUTH_USER_MODEL = 'accounts.User'

AUTHENTICATION_BACKENDS = (
    'django.contrib.auth.backends.ModelBackend',
    'allauth.account.auth_backends.AuthenticationBackend',
)

SITE_ID = 1

CORS_ALLOWED_ORIGINS = [
    "http://localhost:3000",
    "http://127.0.0.1:3000",
]

CORS_ALLOW_CREDENTIALS = True

# --- CONFIGURACIÓN CRÍTICA PARA PAGINACIÓN ---
REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': (
        'rest_framework_simplejwt.authentication.JWTAuthentication',
    ),
    
    # Habilita la paginación
    'DEFAULT_PAGINATION_CLASS': 'core.pagination.CustomPagination',
    
    # Tamaño por defecto sincronizado con el Frontend
    'PAGE_SIZE': 10,
    
    # Filtros Globales
    'DEFAULT_FILTER_BACKENDS': (
        'django_filters.rest_framework.DjangoFilterBackend',
        'core.filters.UnaccentSearchFilter',
        'rest_framework.filters.OrderingFilter',
    ),
}

REST_AUTH = {
    'USE_JWT': True,
    'TOKEN_MODEL': None,
    'SESSION_LOGIN': False,
    'JWT_AUTH_COOKIE': None, 
    'JWT_AUTH_REFRESH_COOKIE': 'refresh-token', 
    'JWT_AUTH_REFRESH_COOKIE_PATH': '/api/auth/token/refresh/',
    'JWT_AUTH_HTTPONLY': True,
    'JWT_AUTH_SAMESITE': 'Lax',
    'JWT_AUTH_SECURE': False, # True en producción
    'USER_DETAILS_SERIALIZER': 'accounts.serializers.CustomUserDetailsSerializer',
    'LOGIN_SERIALIZER': 'accounts.serializers.CustomLoginSerializer',
}

SIMPLE_JWT = {
    'ACCESS_TOKEN_LIFETIME': timedelta(minutes=300),
    'REFRESH_TOKEN_LIFETIME': timedelta(days=7),
    'ROTATE_REFRESH_TOKENS': False, # Genera un nuevo refresh token cada vez que se usa
    'BLACKLIST_AFTER_ROTATION': False,
}

ACCOUNT_EMAIL_VERIFICATION = 'none'
ACCOUNT_USER_MODEL_EMAIL_FIELD = None
ACCOUNT_LOGIN_METHODS = ('username',)

MEDIA_URL = '/media/'

MEDIA_ROOT = BASE_DIR / 'media'

# Email Configuration
# Email Configuration
EMAIL_BACKEND = 'django.core.mail.backends.smtp.EmailBackend'
EMAIL_HOST = os.environ.get('EMAIL_HOST', 'smtp.gmail.com')
EMAIL_PORT = int(os.environ.get('EMAIL_PORT', 587))
EMAIL_USE_TLS = os.environ.get('EMAIL_USE_TLS', 'True') == 'True'
EMAIL_HOST_USER = os.environ.get('EMAIL_HOST_USER', '')
EMAIL_HOST_PASSWORD = os.environ.get('EMAIL_HOST_PASSWORD', '')
DEFAULT_FROM_EMAIL = os.environ.get('DEFAULT_FROM_EMAIL', 'noreply@iutirla.edu.ve')
</file>

<file path="backend/core/admin.py">
from django.contrib import admin
from . import models

# Register your models here.
# --- Catálogos ---
admin.site.register(models.Gender)
admin.site.register(models.MaritalStatus)
admin.site.register(models.Country)
admin.site.register(models.State)

# --- Discapacidad ---
admin.site.register(models.DisabilityGroup)
admin.site.register(models.DisabilityType)
admin.site.register(models.DisabilityStatus)

# --- Contacto y Bancos ---
admin.site.register(models.AddressType)
admin.site.register(models.EmailType)
admin.site.register(models.PhoneType)
admin.site.register(models.PhoneCarrier)
admin.site.register(models.PhoneCarrierCode)
admin.site.register(models.Bank)
admin.site.register(models.BankAccountType)
admin.site.register(models.RelationshipType)

# --- PERSONA Y DETALLES ---

class NationalIdInline(admin.TabularInline):
    model = models.NationalId
    extra = 0

class DependentInline(admin.TabularInline):
    model = models.Dependent
    extra = 0

class EmergencyContactInline(admin.TabularInline):
    model = models.EmergencyContact
    extra = 0

@admin.register(models.Person)
class PersonAdmin(admin.ModelAdmin):
    list_display = ('first_name', 'paternal_surname', 'birthdate', 'gender')
    search_fields = ('first_name', 'paternal_surname')
    # Agregamos inlines para ver todo junto en el admin
    inlines = [NationalIdInline, DependentInline, EmergencyContactInline]

# Registros individuales (por si se necesitan ver aparte)
admin.site.register(models.NationalId)
admin.site.register(models.Dependent)
admin.site.register(models.EmergencyContact)
admin.site.register(models.PersonDisabilityVE)
admin.site.register(models.Address)
admin.site.register(models.PersonEmail)
admin.site.register(models.PersonPhone)
admin.site.register(models.PersonBankAccount)
admin.site.register(models.PersonDocument)
admin.site.register(models.PersonNationality)
</file>

<file path="backend/core/urls.py">
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from . import views

router = DefaultRouter()
router.register(r'persons', views.PersonViewSet, basename='person')

# Catálogos
router.register(r'genders', views.GenderViewSet)
router.register(r'marital-statuses', views.MaritalStatusViewSet)
router.register(r'countries', views.CountryViewSet)
router.register(r'disability-groups', views.DisabilityGroupViewSet)
router.register(r'disability-types', views.DisabilityTypeViewSet)
router.register(r'disability-statuses', views.DisabilityStatusViewSet)
router.register(r'address-types', views.AddressTypeViewSet)
router.register(r'email-types', views.EmailTypeViewSet)
router.register(r'phone-types', views.PhoneTypeViewSet)
router.register(r'phone-carriers', views.PhoneCarrierViewSet)
router.register(r'banks', views.BankViewSet)
router.register(r'bank-account-types', views.BankAccountTypeViewSet)
router.register(r'relationship-types', views.RelationshipTypeViewSet)
router.register(r'states', views.StateViewSet)
router.register(r'phone-carrier-codes', views.PhoneCarrierCodeViewSet)

# Datos de Persona
router.register(r'person-disabilities', views.PersonDisabilityVEViewSet)
router.register(r'addresses', views.AddressViewSet)
router.register(r'national-ids', views.NationalIdViewSet, basename='national-id')
router.register(r'person-emails', views.PersonEmailViewSet)
router.register(r'person-phones', views.PersonPhoneViewSet)
router.register(r'person-bank-accounts', views.PersonBankAccountViewSet)
router.register(r'person-documents', views.PersonDocumentViewSet)
router.register(r'person-nationalities', views.PersonNationalityViewSet)

# Rutas Satélites
router.register(r'dependents', views.DependentViewSet)
router.register(r'emergency-contacts', views.EmergencyContactViewSet)

urlpatterns = [
    path('', include(router.urls)),
]
</file>

<file path="backend/employment/models.py">
from django.db import models
from django.core.exceptions import ValidationError
from django.utils import timezone
from django.utils.translation import gettext_lazy as _
from simple_history.models import HistoricalRecords

# Importaciones de otras apps
from core.models import Person
from organization.models import Position

# Configuración de mensajes de error
UNIQUE_ERR_MSG = {'unique': "Ya existe un registro con este nombre."}

# --- 1. CHOICES (Reemplazan los modelos de catálogo) ---

class RoleChoices(models.TextChoices):
    EMPLOYEE = 'EMP', 'Empleado'
    MANAGER = 'MGR', 'Manager'

class EmploymentTypeChoices(models.TextChoices):
    PERMANENT = 'FIJ', 'Fijo'
    TEMPORARY = 'TMP', 'Temporal'
    INTERNSHIP = 'PAS', 'Pasantía'

class EmploymentStatusChoices(models.TextChoices):
    ACTIVE = 'ACT', 'Activo'
    SUSPENDED = 'SUS', 'Suspendido'
    LEAVE = 'PER', 'De Permiso'
    REST = 'REP', 'Reposo'
    TERMINATED = 'FIN', 'Finalizado'
    RESIGNATION = 'REN', 'Renuncia'
    DISMISSAL = 'DES', 'Despido'
    CANCELLED = 'ANU', 'Anulado'

class HierarchicalRoleChoices(models.TextChoices):
    """Rol jerárquico dentro de un departamento"""
    MANAGER = 'MGR', 'Gerente'
    EMPLOYEE = 'EMP', 'Empleado'


def is_active_status(status_value):
    """
    Determina si un estatus representa una vinculación activa.
    Esto reemplaza el campo is_active_relationship del modelo anterior.
    """
    return status_value in [
        EmploymentStatusChoices.ACTIVE,
        EmploymentStatusChoices.SUSPENDED,
        EmploymentStatusChoices.LEAVE,
        EmploymentStatusChoices.REST,
    ]


# --- 2. MODELO PRINCIPAL (CONTRATO) ---

class Employment(models.Model):
    class ExitReason(models.TextChoices):
        RESIGNATION = 'REN', 'Renuncia Voluntaria'
        DISMISSAL = 'DES', 'Despido / Cese'
        END_CONTRACT = 'FIN', 'Fin de Contrato (Tiempo Cumplido)'
        RETIREMENT = 'JUB', 'Jubilación'
        DEATH = 'FAL', 'Fallecimiento'
        OTHER = 'OTR', 'Otro Motivo'

    # 1. EL DATO DURO (Para Estadísticas)
    exit_reason = models.CharField(
        max_length=3,
        choices=ExitReason.choices,
        null=True, blank=True,
        verbose_name="Motivo de Salida"
    )
    
    # 2. EL DATO BLANDO (Para Contexto)
    exit_notes = models.TextField(
        null=True, blank=True,
        verbose_name="Observaciones",
        help_text="Detalle o carta de renuncia."
    )

    person = models.ForeignKey(
        Person, 
        on_delete=models.CASCADE, 
        related_name='employments',
        verbose_name="Colaborador"
    )
    
    position = models.ForeignKey(
        Position, 
        on_delete=models.PROTECT, 
        related_name='employments',
        verbose_name="Cargo / Posición"
    )

    # CAMPOS CON CHOICES
    role = models.CharField(
        max_length=3,
        choices=RoleChoices.choices,
        default=RoleChoices.EMPLOYEE,
        verbose_name="Rol Funcional"
    )
    
    employment_type = models.CharField(
        max_length=3,
        choices=EmploymentTypeChoices.choices,
        default=EmploymentTypeChoices.PERMANENT,
        verbose_name="Tipo de Contrato"
    )
    
    current_status = models.CharField(
        max_length=3,
        choices=EmploymentStatusChoices.choices,
        default=EmploymentStatusChoices.ACTIVE,
        verbose_name="Estatus Actual"
    )
    
    hire_date = models.DateField(verbose_name="Fecha de Contratación")
    
    end_date = models.DateField(
        null=True, 
        blank=True, 
        help_text="Fecha de fin de contrato (para 'Tiempo Determinado' o 'Prueba')"
    )
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    # Historial de cambios
    history = HistoricalRecords()

    # Lógica interna para detectar cambios
    __original_status = None

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        # Guardamos el valor del estatus original
        self.__original_status = self.current_status

    class Meta:
        verbose_name = "Expediente Laboral"
        ordering = ['-hire_date']

    def __str__(self):
        return f"{self.person} - {self.position}"

    def clean(self):
        # 1. Validar Fechas
        if self.end_date and self.hire_date and self.end_date < self.hire_date:
            raise ValidationError({'end_date': "La fecha de egreso no puede ser anterior a la fecha de ingreso."})

        # 2. VALIDACIÓN DE INTEGRIDAD (Usando is_active_status helper)
        
        # Si el estatus que intentamos guardar se considera "Activo/Vigente"...
        if self.current_status and is_active_status(self.current_status):
            
            # Buscamos conflictos: otros contratos activos del mismo empleado en la misma posición
            duplicates = Employment.objects.filter(
                person=self.person,
                position=self.position,
            ).exclude(pk=self.pk)  # Nos excluimos a nosotros mismos si estamos editando
            
            # Filtrar solo los que tienen estatus activo
            duplicates = [e for e in duplicates if is_active_status(e.current_status)]

            if duplicates:
                conflict = duplicates[0]
                raise ValidationError({
                    'current_status': f"Conflicto: {self.person} ya tiene un contrato vigente ({conflict.get_current_status_display()}) en el cargo '{self.position}'. Debe finalizar el anterior primero."
                })

    def save(self, *args, **kwargs):
        self.full_clean()
        
        # 2. LÓGICA DE FECHA DE FIN AUTOMÁTICA (Lo nuevo)
        if self.current_status:
            # Si el estatus NO es vigente (es finalizado/renuncia)...
            if not is_active_status(self.current_status):
                # ... y el usuario no puso fecha...
                if not self.end_date:
                    self.end_date = timezone.now().date() # ¡Asignamos HOY!
            
            # (Opcional) Si reactivas al empleado, limpiamos la fecha de fin

        # 3. DETECCIÓN DE CAMBIOS (Tu código original)
        is_created = self.pk is None
        
        # Verificamos si el valor del estatus cambió respecto al original cargado en __init__
        # Como current_status ahora es CharField, comparamos valores directamente
        original_status = getattr(self, '_Employment__original_status', None) 
        status_changed = self.current_status != self.__original_status

        # 4. DECREMENTO AUTOMÁTICO DE VACANTES (NUEVO)
        # Si es un nuevo contrato y el estatus es activo (ocupa silla)
        if is_created and is_active_status(self.current_status):
            # Bloqueamos la posición para evitar condiciones de carrera
            # Nota: select_for_update() requiere estar dentro de una transacción.
            # Como save() puede llamarse fuera, usamos F() expressions o asumimos transacción externa.
            # Para mayor seguridad y simplicidad aquí, usamos lógica directa, pero lo ideal es que
            # la vista/servicio envuelva esto en transaction.atomic()
            
            if self.position.vacancies > 0:
                self.position.vacancies -= 1
                self.position.save()
            # Si es 0, técnicamente no debería haber pasado la validación del serializer/clean,
            # pero por seguridad no restamos más allá de 0.

        # 5. GUARDADO REAL EN BASE DE DATOS
        super().save(*args, **kwargs)
        
        # 6. CREACIÓN DEL LOG (Tu código original)
        # Se hace DESPUÉS del super().save() para asegurar que tenemos un ID válido
        if is_created or status_changed:
            self._create_status_log(is_created)
            # Actualizamos el estado original en memoria para futuras ediciones en esta misma instancia
            self.__original_status = self.current_status

    def delete(self, *args, **kwargs):
        # 1. RESTITUCIÓN DE VACANTES
        # Si el contrato que se borra estaba ocupando plaza (activo), devolvemos la vacante.
        if is_active_status(self.current_status):
            self.position.vacancies += 1
            self.position.save()
            
        super().delete(*args, **kwargs)

    def _create_status_log(self, is_created):
        # 1. CASO: NUEVO INGRESO
        if is_created:
            reason_text = "Ingreso inicial / Contratación"
        
        # 2. CASO: FINALIZACIÓN DE CONTRATO (Salida)
        # Verificamos si el estatus actual indica cierre (usando helper function)
        elif self.current_status and not is_active_status(self.current_status):
            # Construimos el mensaje con los datos de salida que acabamos de guardar
            parts = []
            
            # A. Agregamos la categoría (ej. "Renuncia Voluntaria")
            if self.exit_reason:
                # get_FOO_display() es un método mágico de Django para obtener el texto del Choice
                parts.append(self.get_exit_reason_display())
            
            # B. Agregamos la nota específica si existe
            if self.exit_notes:
                parts.append(f"({self.exit_notes})")
            
            # Unimos todo. Si no hay nada, ponemos un default.
            reason_text = " ".join(parts) if parts else "Finalización de contrato (Sin motivo especificado)"

        # 3. CASO: CAMBIO ADMINISTRATIVO (Ej. Activo -> Suspendido, o Prueba -> Fijo)
        else:
            reason_text = "Cambio de estatus administrativo / Actualización"

        # --- GUARDAR EL LOG ---
        EmploymentStatusLog.objects.create(
            employment=self,
            status=self.current_status,
            start_date=timezone.now().date(), # O self.end_date si prefieres la fecha del evento
            reason=reason_text # <--- Aquí guardamos el texto calculado
        )
        
class EmploymentStatusLog(models.Model):
    employment = models.ForeignKey(
        Employment, 
        on_delete=models.CASCADE, 
        related_name='status_logs'
    )
    # Ahora es CharField porque usamos Choices
    status = models.CharField(
        max_length=3,
        choices=EmploymentStatusChoices.choices,
        verbose_name="Estatus"
    )
    start_date = models.DateField(
        default=timezone.now,
        help_text="Fecha de inicio de este estatus"
    )
    reason = models.TextField(blank=True, null=True)
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        verbose_name = "Historial de Estatus"
        ordering = ['-created_at']

    def __str__(self):
        return f"{self.employment} - {self.get_status_display()} desde {self.start_date}"



# --- 4. ROL JERÁRQUICO EN DEPARTAMENTO ---

class EmploymentDepartmentRole(models.Model):
    """
    Define el rol jerárquico de un empleado en un departamento específico
    durante su contrato activo.
    
    Esto permite:
    - Que un empleado sea gerente de un departamento
    - Histórico de cambios de rol jerárquico
    - Roles temporales (con fecha de inicio y fin)
    - Roles matriciales (un empleado puede tener roles en múltiples departamentos)
    """
    employment = models.ForeignKey(
        Employment,
        on_delete=models.CASCADE,
        related_name='department_roles',
        verbose_name="Contrato",
        help_text="Contrato al que pertenece este rol jerárquico"
    )
    department = models.ForeignKey(
        'organization.Department',
        on_delete=models.CASCADE,
        related_name='employment_roles',
        verbose_name="Departamento",
        help_text="Departamento en el que ejerce este rol"
    )
    hierarchical_role = models.CharField(
        max_length=3,
        choices=HierarchicalRoleChoices.choices,
        default=HierarchicalRoleChoices.EMPLOYEE,
        verbose_name="Rol Jerárquico",
        help_text="Rol dentro del departamento (Gerente o Empleado)"
    )
    start_date = models.DateField(
        default=timezone.now,
        verbose_name="Fecha de Inicio",
        help_text="Inicio del rol jerárquico en este departamento"
    )
    end_date = models.DateField(
        null=True,
        blank=True,
        verbose_name="Fecha de Fin",
        help_text="Fin del rol jerárquico (NULL si es actual)"
    )
    notes = models.TextField(
        blank=True,
        null=True,
        verbose_name="Notas",
        help_text="Observaciones sobre la asignación del rol"
    )
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    # Historial de cambios
    history = HistoricalRecords()

    class Meta:
        verbose_name = "Rol Jerárquico en Departamento"
        verbose_name_plural = "Roles Jerárquicos en Departamentos"
        unique_together = ('employment', 'department', 'start_date')
        ordering = ['-start_date']

    def __str__(self):
        role_display = self.get_hierarchical_role_display()
        return f"{self.employment.person} - {role_display} de {self.department.name}"

    def clean(self):
        """Validaciones personalizadas"""
        super().clean()
        
        # Validar que el departamento del employment coincide con el department del rol
        # Validar que el departamento del employment coincide con el department del rol - REMOVED for Matrix Support
        # if self.employment.position and self.employment.position.department != self.department:
        #     raise ValidationError({
        #         'department': f'El departamento debe coincidir con el departamento de la posición del empleado ({self.employment.position.department.name})'
        #     })
        
        # Validar que end_date sea posterior a start_date
        if self.end_date and self.end_date < self.start_date:
            raise ValidationError({
                'end_date': 'La fecha de fin debe ser posterior a la fecha de inicio'
            })

    @property
    def is_current(self):
        """Verifica si el rol está actualmente vigente"""
        return self.end_date is None or self.end_date >= timezone.now().date()


# --- 5. ROL JERÁRQUICO POR PERSONA EN DEPARTAMENTO (MATRIZ) ---

class PersonDepartmentRole(models.Model):
    """
    Define el rol jerárquico de una persona en un departamento específico,
    independientemente de su contrato de trabajo.
    
    Este modelo permite organizaciones matriciales donde una persona puede
    tener un rol jerárquico en un departamento diferente al de su posición formal.
    
    Ventajas sobre EmploymentDepartmentRole:
    - Más flexible: Permite roles cruzados entre departamentos
    - Más simple: Vinculación directa Person→Department
    - Soporta matriz: Una persona en IT puede ser gerente de Finanzas
    """
    person = models.ForeignKey(
        'core.Person',
        on_delete=models.CASCADE,
        related_name='department_roles',
        verbose_name="Persona",
        help_text="Persona que ejerce este rol jerárquico"
    )
    department = models.ForeignKey(
        'organization.Department',
        on_delete=models.CASCADE,
        related_name='person_roles',
        verbose_name="Departamento",
        help_text="Departamento en el que ejerce este rol"
    )
    hierarchical_role = models.CharField(
        max_length=3,
        choices=HierarchicalRoleChoices.choices,
        default=HierarchicalRoleChoices.EMPLOYEE,
        verbose_name="Rol Jerárquico",
        help_text="Rol dentro del departamento (Gerente o Empleado)"
    )
    start_date = models.DateField(
        default=timezone.now,
        verbose_name="Fecha de Inicio",
        help_text="Inicio del rol jerárquico en este departamento"
    )
    end_date = models.DateField(
        null=True,
        blank=True,
        verbose_name="Fecha de Fin",
        help_text="Fin del rol jerárquico (NULL si es actual)"
    )
    notes = models.TextField(
        blank=True,
        null=True,
        verbose_name="Notas",
        help_text="Observaciones sobre la asignación del rol"
    )
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    # Historial de cambios
    history = HistoricalRecords()

    class Meta:
        verbose_name = "Rol Jerárquico por Persona"
        verbose_name_plural = "Roles Jerárquicos por Persona"
        unique_together = ('person', 'department', 'start_date')
        ordering = ['-start_date']

    def __str__(self):
        role_display = self.get_hierarchical_role_display()
        return f"{self.person.full_name} - {role_display} de {self.department.name}"

    def clean(self):
        """Validaciones personalizadas"""
        super().clean()
        
        # Validar que end_date sea posterior a start_date
        if self.end_date and self.end_date < self.start_date:
            raise ValidationError({
                'end_date': 'La fecha de fin debe ser posterior a la fecha de inicio'
            })

    @property
    def is_current(self):
        """Verifica si el rol está actualmente vigente"""
        return self.end_date is None or self.end_date >= timezone.now().date()
</file>

<file path="backend/employment/views.py">
from datetime import timedelta
from django.utils import timezone
from django.db import transaction
from django.db.models import Count
from rest_framework import viewsets, permissions, status
from rest_framework.decorators import action
from rest_framework.response import Response
from .models import (
    Employment, EmploymentStatusLog, EmploymentDepartmentRole, PersonDepartmentRole,
    is_active_status, EmploymentStatusChoices
)
from .serializers import (
    EmploymentSerializer, EmployeeListSerializer, EmploymentStatusLogSerializer,
    EmploymentDepartmentRoleSerializer, PersonDepartmentRoleSerializer
)
from core.filters import UnaccentSearchFilter

class EmploymentViewSet(viewsets.ModelViewSet):
    queryset = Employment.objects.all()
    serializer_class = EmploymentSerializer
    permission_classes = [permissions.IsAuthenticated] # Cambiado a IsAuthenticated para que my_org_chart funcione para empleados normales

    def get_queryset(self):
        """
        Optimización vital para cargar relaciones en una sola consulta.
        """
        queryset = self.queryset
        
        # Si es listado o detalle, optimizamos
        if self.action in ['list', 'retrieve', 'update', 'partial_update']:
            queryset = queryset.select_related(
                'person', 
                'position', 
                'position__department',
                'person__user_account' # Para saber si tiene usuario
            )
        
        # Si NO es admin, solo debería ver su propio contrato (excepto en my_org_chart que tiene su lógica propia)
        # Pero como el frontend de Admin Panel usa este endpoint para listar todo,
        # mantenemos el acceso total para staff, y restringido para otros si fuera necesario.
        # Por ahora, asumimos que el panel de /admin/personnel solo lo ven admins.
        
        return queryset

    def get_serializer_class(self):
        if self.action == 'list': 
            return EmployeeListSerializer
        return EmploymentSerializer

    # --- ACCIÓN 1: TERMINAR CONTRATO ---
    @action(detail=True, methods=['post'])
    def terminate(self, request, pk=None):
        # Solo admins pueden terminar contratos
        if not request.user.is_staff:
            return Response({"error": "No autorizado."}, status=status.HTTP_403_FORBIDDEN)

        employment = self.get_object()
        
        end_date = request.data.get('end_date')
        exit_reason = request.data.get('exit_reason')
        exit_notes = request.data.get('exit_notes')
        deactivate_user = request.data.get('deactivate_user', True)

        if not end_date or not exit_reason:
            return Response({"error": "Fecha y motivo obligatorios."}, status=400)

        try:
            with transaction.atomic():
                # Buscar estatus de cierre - ahora es un valor de Choice
                # Usamos 'FIN' que corresponde a 'Finalizado' en EmploymentStatusChoices
                closed_status = EmploymentStatusChoices.TERMINATED

                # Actualizar
                employment.end_date = end_date
                employment.current_status = closed_status 
                employment.exit_reason = exit_reason
                employment.exit_notes = exit_notes
                employment.save() 

                # Desactivar usuario
                if deactivate_user and hasattr(employment.person, 'user_account') and employment.person.user_account:
                    user = employment.person.user_account
                    user.is_active = False
                    user.save()

            return Response(self.get_serializer(employment).data)
        except Exception as e:
            return Response({"error": str(e)}, status=500)
        
    # --- ACCIÓN 2: DASHBOARD (KPIs) ---
    @action(detail=False, methods=['get'])
    def dashboard_stats(self, request):
        # Solo admins ven el dashboard global
        if not request.user.is_staff:
            return Response({"error": "No autorizado."}, status=status.HTTP_403_FORBIDDEN)

        today = timezone.now().date()
        start_of_month = today.replace(day=1)
        
        # Filtrar empleados activos usando helper function
        all_employments = Employment.objects.all()
        active_qs = [e for e in all_employments if is_active_status(e.current_status)]

        # KPIs
        total_active = len(active_qs)
        new_hires = len([e for e in active_qs if e.hire_date >= start_of_month])
        
        # Exits
        inactive_qs = [e for e in all_employments if not is_active_status(e.current_status)]
        exits = len([e for e in inactive_qs if e.end_date and e.end_date >= start_of_month])
        
        pending_users = len([e for e in active_qs if not hasattr(e.person, 'user_account') or not e.person.user_account])

        # Deptos (usando queryset normal porque necesitamos aggregation)
        active_ids = [e.id for e in active_qs]
        dept_stats = Employment.objects.filter(id__in=active_ids).values('position__department__name') \
            .annotate(count=Count('id')).order_by('-count')[:5]

        # Vencimientos (con cédula)
        next_month = today + timedelta(days=30)
        expiring_list = []
        for emp in active_qs:
            if emp.end_date and today <= emp.end_date <= next_month:
                doc = emp.person.national_ids.filter(is_primary=True).first()
                doc_str = f"{doc.document_type}-{doc.number}" if doc else "S/D"
                
                expiring_list.append({
                    "id": emp.id,
                    "person_name": f"{emp.person.first_name} {emp.person.paternal_surname}",
                    "person_document": doc_str,
                    "end_date": emp.end_date
                })

        return Response({
            "headcount": total_active,
            "new_hires": new_hires,
            "exits": exits,
            "pending_users": pending_users,
            "department_distribution": list(dept_stats),
            "expiring_soon": expiring_list
        })

    # --- ACCIÓN 3: MI ORGANIGRAMA (Para el empleado) ---
    @action(detail=False, methods=['get'])
    def my_org_chart(self, request):
        """
        Devuelve jefe, compañeros y subordinados del usuario logueado.
        """
        user = request.user
        if not hasattr(user, 'person'):
            return Response({"error": "Sin perfil de empleado"}, status=404)

        # Mi empleo activo
        my_jobs = Employment.objects.filter(
            person=user.person
        ).select_related('position__department', 'position__manager_position')
        
        my_job = None
        for job in my_jobs:
            if is_active_status(job.current_status):
                my_job = job
                break

        if not my_job:
            return Response({"error": "No tienes contrato activo."}, status=404)

        data = {
            "me": {
                "name": str(user.person),
                "position": my_job.position.name,
                "department": my_job.position.department.name if my_job.position.department else "Sin Depto",
                "photo": user.person.photo.url if user.person.photo else None
            },
            "boss": None,
            "peers": [],
            "subordinates": []
        }

        # Jefe
        boss_pos = my_job.position.manager_position
        if boss_pos:
            boss_employments = Employment.objects.filter(
                position=boss_pos
            ).select_related('person')
            
            boss_employment = None
            for emp in boss_employments:
                if is_active_status(emp.current_status):
                    boss_employment = emp
                    break
            
            if boss_employment:
                data["boss"] = {
                    "name": str(boss_employment.person),
                    "position": boss_pos.name,
                    "photo": boss_employment.person.photo.url if boss_employment.person.photo else None
                }
            else:
                 data["boss"] = {"name": "VACANTE", "position": boss_pos.name, "photo": None}

        # Compañeros (Mismo Depto)
        if my_job.position.department:
            all_peers = Employment.objects.filter(
                position__department=my_job.position.department
            ).exclude(id=my_job.id).select_related('person', 'position')[:20]  # Traemos más para filtrar

            peers = [p for p in all_peers if is_active_status(p.current_status)][:10]

            data["peers"] = [{
                "name": str(p.person),
                "position": p.position.name,
                "photo": p.person.photo.url if p.person.photo else None
            } for p in peers]

        # Subordinados (Si soy jefe)
        all_subordinates = Employment.objects.filter(
            position__manager_position=my_job.position
        ).select_related('person', 'position')

        subordinates = [s for s in all_subordinates if is_active_status(s.current_status)]

        data["subordinates"] = [{
            "name": str(s.person),
            "position": s.position.name,
            "photo": s.person.photo.url if s.person.photo else None
        } for s in subordinates]

        return Response(data)
    
    @action(detail=False, methods=['get'])
    def my_departments(self, request):
        user = request.user
        if not hasattr(user, 'person'):
            return Response([])

        my_employments = Employment.objects.filter(
            person=user.person
        ).select_related('position', 'position__department', 'position__job_title')
        
        # Filtrar solo activos
        active_employments = [e for e in my_employments if is_active_status(e.current_status)]

        departments_map = {}

        for emp in active_employments:
            dept = emp.position.department
            dept_id = dept.id if dept else 0
            dept_name = dept.name if dept else "Sin Departamento Asignado"
            dept_desc = getattr(dept, 'description', 'Área general.') if dept else "Posición fuera de estructura."

            # Determinamos el nombre del cargo de forma segura
            pos_name = emp.position.name
            
            # Si pos_name es None, intentamos usar el Job Title o un fallback
            if not pos_name:
                if emp.position.job_title:
                    pos_name = emp.position.job_title.name
                else:
                    pos_name = "Cargo Sin Nombre"

            if dept_id in departments_map:
                if pos_name not in departments_map[dept_id]['positions_list']:
                    departments_map[dept_id]['positions_list'].append(pos_name)
            else:
                departments_map[dept_id] = {
                    "dept_id": dept_id,
                    "dept_name": dept_name,
                    "dept_description": dept_desc,
                    "start_date": emp.hire_date,
                    "positions_list": [pos_name] 
                }

        final_data = []
        for item in departments_map.values():
            # Ahora positions_list garantiza tener solo strings
            item['my_position'] = " / ".join(item['positions_list'])
            del item['positions_list']
            final_data.append(item)

        return Response(final_data)

# Viewset para logs
class EmploymentStatusLogViewSet(viewsets.ModelViewSet):
    queryset = EmploymentStatusLog.objects.all()
    serializer_class = EmploymentStatusLogSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]


# --- VIEWSET PARA ROLES JERÁRQUICOS EN DEPARTAMENTO ---

class EmploymentDepartmentRoleViewSet(viewsets.ModelViewSet):
    """
    ViewSet para gestionar los roles jerárquicos de empleados en departamentos.
    
    Permite:
    - Crear/editar roles (Gerente/Empleado) para empleados en departamentos específicos
    - Consultar histórico de roles
    - Filtrar por empleado, departamento, rol, etc.
    """
    queryset = EmploymentDepartmentRole.objects.all()
    serializer_class = EmploymentDepartmentRoleSerializer
    permission_classes = [permissions.IsAdminUser]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['employment__person__first_name', 'employment__person__last_name', 'department__name']
    
    def get_queryset(self):
        """
        Optimiza las consultas y permite filtrar por parámetros
        """
        queryset = self.queryset.select_related(
            'employment',
            'employment__person',
            'department'
        ).order_by('-start_date')
        
        # Filtros opcionales
        employment_id = self.request.query_params.get('employment', None)
        department_id = self.request.query_params.get('department', None)
        is_current = self.request.query_params.get('is_current', None)
        hierarchical_role = self.request.query_params.get('hierarchical_role', None)
        
        if employment_id:
            queryset = queryset.filter(employment_id=employment_id)
        
        if department_id:
            queryset = queryset.filter(department_id=department_id)
        
        if is_current == 'true':
            queryset = queryset.filter(end_date__isnull=True)
        elif is_current == 'false':
            queryset = queryset.filter(end_date__isnull=False)
        
        if hierarchical_role:
            queryset = queryset.filter(hierarchical_role=hierarchical_role)
        
        return queryset
    
    @action(detail=False, methods=['get'])
    def current_managers(self, request):
        """
        Retorna todos los gerentes actuales (roles activos con hierarchical_role='MGR')
        """
        current_managers = self.get_queryset().filter(
            hierarchical_role='MGR',
            end_date__isnull=True
        )
        serializer = self.get_serializer(current_managers, many=True)
        return Response(serializer.data)


# --- VIEWSET PARA ROLES JERÁRQUICOS POR PERSONA (MATRIZ) ---

class PersonDepartmentRoleViewSet(viewsets.ModelViewSet):
    """
    ViewSet para gestionar los roles jerárquicos de personas en departamentos.
    Soporta organizaciones matriciales.
    """
    queryset = PersonDepartmentRole.objects.all()
    serializer_class = PersonDepartmentRoleSerializer
    permission_classes = [permissions.IsAdminUser]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['person__first_name', 'person__last_name', 'department__name']
    
    def get_queryset(self):
        queryset = self.queryset.select_related(
            'person',
            'department'
        ).order_by('-start_date')
        
        # Filtros opcionales
        person_id = self.request.query_params.get('person', None)
        department_id = self.request.query_params.get('department', None)
        is_current = self.request.query_params.get('is_current', None)
        hierarchical_role = self.request.query_params.get('hierarchical_role', None)
        
        if person_id:
            queryset = queryset.filter(person_id=person_id)
        
        if department_id:
            queryset = queryset.filter(department_id=department_id)
        
        if is_current == 'true':
            queryset = queryset.filter(end_date__isnull=True)
        elif is_current == 'false':
            queryset = queryset.filter(end_date__isnull=False)
        
        if hierarchical_role:
            queryset = queryset.filter(hierarchical_role=hierarchical_role)
        
        return queryset
    
    @action(detail=False, methods=['get'])
    def current_managers(self, request):
        """
        Retorna todos los gerentes actuales (roles activos con hierarchical_role='MGR')
        """
        current_managers = self.get_queryset().filter(
            hierarchical_role='MGR',
            end_date__isnull=True
        )
        serializer = self.get_serializer(current_managers, many=True)
        return Response(serializer.data)
</file>

<file path="backend/organization/management/commands/load_org_data.py">
"""
Management command to load organization data from organization-manual.md
"""
import re
from pathlib import Path
from django.core.management.base import BaseCommand
from django.db import transaction
from organization.models import (
    Department, JobTitle, Position, 
    PositionRequirement, PositionFunction
)


class Command(BaseCommand):
    help = 'Load organization structure from organization-manual.md'

    def handle(self, *args, **options):
        # Path to manual (relative to project root)
        manual_path = Path(__file__).resolve().parent.parent.parent.parent.parent / 'organization-manual.md'
        
        if not manual_path.exists():
            self.stdout.write(self.style.ERROR(f'Manual not found at {manual_path}'))
            return
        
        self.stdout.write(self.style.SUCCESS(f'Reading manual from {manual_path}'))
        
        # Read manual
        with open(manual_path, 'r', encoding='utf-8') as f:
            content = f.read()
        
        # Parse and load data
        with transaction.atomic():
            self._load_departments()
            self._load_jobtitles()
            self._load_positions_with_details(content)
        
        self.stdout.write(self.style.SUCCESS('Successfully loaded organization data!'))

    def _load_departments(self):
        """Create departments with hierarchy"""
        self.stdout.write('Creating departments...')
        
        # Clear existing (careful in production!)
        Department.objects.all().delete()
        
        # Create root departments
        direccion = Department.objects.create(id=1, name="Dirección", parent=None)
        subdirección = Department.objects.create(id=2, name="Subdirección Académica", parent=direccion)
        
        # Create coordinaciones under subdirección
        Department.objects.create(id=3, name="Coordinación de Control de Estudios y Evaluación", parent=subdirección)
        Department.objects.create(id=4, name="Coordinación Administrativa", parent=direccion)
        Department.objects.create(id=5, name="Coordinación de Pasantías", parent=subdirección)
        Department.objects.create(id=6, name="Coordinación de Informática", parent=subdirección)
        Department.objects.create(id=7, name="Coordinación de Preescolar", parent=subdirección)
        Department.objects.create(id=8, name="Coordinación de Investigación, Extensión y Postgrado", parent=subdirección)
        Department.objects.create(id=9, name="Biblioteca", parent=subdirección)
        
        self.stdout.write(self.style.SUCCESS(f'  Created {Department.objects.count()} departments'))

    def _load_jobtitles(self):
        """Create simplified job titles"""
        self.stdout.write('Creating job titles...')
        
        JobTitle.objects.all().delete()
        
        titles = [
            "Director", "Subdirector", "Coordinador", "Jefe",
            "Asesor", "Secretaria", "Recepcionista", "Asistente",
            "Personal de Mantenimiento", "Personal de Limpieza", "Auxiliar"
        ]
        
        for i, title in enumerate(titles, 1):
            JobTitle.objects.create(id=i, name=title)
        
        self.stdout.write(self.style.SUCCESS(f'  Created {JobTitle.objects.count()} job titles'))

    def _load_positions_with_details(self, content):
        """Parse manual and create positions with requirements and functions"""
        self.stdout.write('Parsing manual and creating positions...')
        
        Position.objects.all().delete()
        PositionRequirement.objects.all().delete()
        PositionFunction.objects.all().delete()
        
        # Mapping from manual section titles to (department_id, jobtitle_id, vacancies, manager_id_ref)
        # manager_id_ref is the ID of the position this position reports to (or None)
        # IDs are assigned sequentially starting from 1 based on this list order.
        positions_to_create = [
            # Dirección (ID 1)
            ("Director", 1, 1, 1, None),
            # ID 2
            ("Asesor de Prensa", 1, 5, 1, 1), # Reports to Director
            # ID 3
            ("Secretaria", 1, 6, 2, 1),  # Reports to Director. Increased vacancies to 2
            # ID 4
            ("Recepcionista", 1, 7, 1, 1), # Reports to Director
            
            # Subdirección Académica (ID 5)
            ("Subdirector Académico", 2, 2, 1, 1), # Reports to Director
            # ID 6
            ("Asistente a la Subdirección Académica", 2, 8, 1, 5), # Reports to Subdirector
            
            # Control de Estudios (ID 7)
            ("Coordinador de Control de Estudios y Evaluación", 3, 3, 1, 5), # Reports to Subdirector
            # ID 8
            ("Asistente de Control de Estudios y Evaluación", 3, 8, 2, 7), # Reports to Coord. Control Estudios. Vacancies: 2
            # ID 9
            ("Secretaria", 3, 6, 1, 7),  # Reports to Coord. Control Estudios
            
            # Coordinación Administrativa (ID 10)
            ("Coordinador Administrativo", 4, 3, 1, 1), # Reports to Director (Administrative arm)
            # ID 11
            ("Asistente de la Coordinador Administrativa", 4, 8, 1, 10), # Reports to Coord. Admin
            # ID 12
            ("Personal de Mantenimiento", 4, 9, 4, 10), # Reports to Coord. Admin. Vacancies: 4
            # ID 13
            ("Personal de Limpieza", 4, 10, 5, 10), # Reports to Coord. Admin. Vacancies: 5
            
            # Pasantías (ID 14)
            ("Coordinador de Pasantías", 5, 3, 1, 5), # Reports to Subdirector
            # ID 15
            ("Asistente de la Coordinación de Pasantías", 5, 8, 1, 14), # Reports to Coord. Pasantías
            
            # Informática (ID 16)
            ("Coordinador de Informática", 6, 3, 1, 5), # Reports to Subdirector
            # ID 17
            ("Asistente del Laboratorio de Informática", 6, 8, 2, 16), # Reports to Coord. Informática. Vacancies: 2
            
            # Preescolar (ID 18)
            ("Coordinador de Preescolar", 7, 3, 1, 5), # Reports to Subdirector
            # ID 19
            ("Asistente", 7, 8, 3, 18),  # Asistente de Preescolar. Vacancies: 3
            
            # Investigación (ID 20)
            ("Coordinador de Investigación, Extensión y Post grado", 8, 3, 1, 5), # Reports to Subdirector
            
            # Biblioteca (ID 21)
            ("Jefe de Biblioteca", 9, 4, 1, 5), # Reports to Subdirector
            # ID 22
            ("Asistente de Biblioteca", 9, 8, 1, 21), # Reports to Jefe Biblioteca
            # ID 23
            ("Auxiliar de Biblioteca", 9, 11, 2, 21), # Reports to Jefe Biblioteca. Vacancies: 2
        ]
        
        # Split content by cargo sections
        cargo_pattern = r'#### Título del Cargo:(.+?)(?=#### Título del Cargo:|###|$)'
        cargos = re.findall(cargo_pattern, content, re.DOTALL)
        
        # We'll match cargos to our positions list by title
        position_counter = 1
        used_cargos = []
        
        # Store manager assignments to apply after creation
        manager_assignments = {} # position_id -> manager_id
        
        for title, dept_id, jt_id, vac, manager_id in positions_to_create:
            # Find matching cargo in manual (not yet used)
            cargo_text = None
            for i, cargo in enumerate(cargos):
                if i in used_cargos:
                    continue
                # Extract title from cargo
                lines = cargo.strip().split('\n')
                if not lines:
                    continue
                cargo_title = lines[0].strip()
                
                # Match title
                if cargo_title == title or (title == "Asistente" and "Asistente" in cargo_title and "Preescolar" in cargo):
                    cargo_text = cargo
                    used_cargos.append(i)
                    break
            
            if not cargo_text:
                self.stdout.write(self.style.WARNING(f'  Skipping: {title} (not found in manual)'))
                # Still increment counter to keep IDs consistent with our list
                position_counter += 1
                continue
            
            # Extract objective
            objective = self._extract_section(cargo_text, "**Objetivo General:**")
            
            # Extract requirements
            requirements = self._extract_list(cargo_text, "**Requisitos:**")
            
            # Extract functions
            functions = self._extract_list(cargo_text, "**Funciones:**")
            
            # Determine if managerial
            is_manager = any(role in title for role in ["Director", "Subdirector", "Coordinador", "Jefe", "Gerente", "Presidente"])

            # Create position
            position = Position.objects.create(
                id=position_counter,
                department_id=dept_id,
                job_title_id=jt_id,
                vacancies=vac,
                objective=objective or f"Objetivo del cargo {title}",
                is_manager=is_manager
            )
            
            # Store manager assignment
            if manager_id:
                manager_assignments[position.id] = manager_id
            
            # Create requirements
            for req in requirements:
                PositionRequirement.objects.create(
                    position=position,
                    description=req
                )
            
            # Create functions
            for i, func in enumerate(functions, 1):
                PositionFunction.objects.create(
                    position=position,
                    description=func,
                    order=i
                )
            
            self.stdout.write(f'  Created: {title} (ID: {position.id}, Vacancies: {vac})')
            position_counter += 1
            
        # Apply manager assignments
        self.stdout.write('Assigning managers...')
        for pos_id, manager_id in manager_assignments.items():
            try:
                position = Position.objects.get(id=pos_id)
                manager = Position.objects.get(id=manager_id)
                position.manager_positions.add(manager)
            except Position.DoesNotExist:
                self.stdout.write(self.style.WARNING(f'  Could not assign manager {manager_id} to position {pos_id}: Position not found'))

        self.stdout.write(self.style.SUCCESS(
            f'  Created {Position.objects.count()} positions, '
            f'{PositionRequirement.objects.count()} requirements, '
            f'{PositionFunction.objects.count()} functions'
        ))

    def _extract_section(self, text, marker):
        """Extract text between marker and next **header**"""
        pattern = rf'{re.escape(marker)}\s*\n\n(.+?)(?=\n\n\*\*|$)'
        match = re.search(pattern, text, re.DOTALL)
        if match:
            return match.group(1).strip()
        return ""

    def _extract_list(self, text, marker):
        """Extract bulleted list items after marker"""
        pattern = rf'{re.escape(marker)}\s*\n\n((?:- .+\n?)+)'
        match = re.search(pattern, text)
        if match:
            items = match.group(1).strip().split('\n')
            return [item.lstrip('- ').strip() for item in items if item.strip()]
        return []
</file>

<file path="backend/organization/urls.py">
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .views import DepartmentViewSet, JobTitleViewSet, PositionViewSet, PositionRequirementViewSet, PositionFunctionViewSet

router = DefaultRouter()
router.register(r'departments', DepartmentViewSet, basename='department')
router.register(r'job-titles', JobTitleViewSet, basename='jobtitle')
router.register(r'positions', PositionViewSet, basename='position')

urlpatterns = [
    path('', include(router.urls)),
    # Rutas anidadas para requerimientos y funciones (objectives eliminado)
    path('positions/<int:position_pk>/requirements/', PositionRequirementViewSet.as_view({'get': 'list', 'post': 'create'}), name='position-requirements-list'),
    path('positions/<int:position_pk>/requirements/<int:pk>/', PositionRequirementViewSet.as_view({'get': 'retrieve', 'patch': 'partial_update', 'delete': 'destroy'}), name='position-requirements-detail'),
    path('positions/<int:position_pk>/functions/', PositionFunctionViewSet.as_view({'get': 'list', 'post': 'create'}), name='position-functions-list'),
    path('positions/<int:position_pk>/functions/<int:pk>/', PositionFunctionViewSet.as_view({'get': 'retrieve', 'patch': 'partial_update', 'delete': 'destroy'}), name='position-functions-detail'),
]
</file>

<file path="backend/talent/serializers.py">
from rest_framework import serializers
from django.utils import timezone
from datetime import date
from core.serializers import check_uniqueness, title_case_cleaner, validate_text_with_spaces, validate_min_length

from .models import (
    PersonSpecialAssignment, BusinessFunction, PersonFunctionalExperience,
    PersonCertification, CertificationDocument, EducationLevel, FieldOfStudy,
    PersonEducation, PersonVolunteerExperience, PersonAward, PersonMembership,
    Language, LanguageProficiency, PersonLanguage
)

def validate_date_range(data, start_field='start_date', end_field='end_date'):
    """Valida que la fecha de fin no sea anterior a la de inicio."""
    start = data.get(start_field)
    end = data.get(end_field)
    
    if start and end and end < start:
        raise serializers.ValidationError({
            end_field: "La fecha de finalización no puede ser anterior a la fecha de inicio."
        })
    return data

# --- Serializers de Catálogo ---

class BusinessFunctionSerializer(serializers.ModelSerializer):
    class Meta: model = BusinessFunction; fields = '__all__'
    def validate_name(self, value):
        cleaned = title_case_cleaner(validate_text_with_spaces(value, 'Nombre'))
        validate_min_length(cleaned, 2)
        return cleaned

class EducationLevelSerializer(serializers.ModelSerializer):
    class Meta: model = EducationLevel; fields = '__all__'
    def validate_name(self, value):
        cleaned = title_case_cleaner(validate_text_with_spaces(value, 'Nombre'))
        validate_min_length(cleaned, 2)
        return cleaned

class FieldOfStudySerializer(serializers.ModelSerializer):
    class Meta: model = FieldOfStudy; fields = '__all__'
    def validate_name(self, value):
        cleaned = title_case_cleaner(validate_text_with_spaces(value, 'Nombre'))
        validate_min_length(cleaned, 2)
        return cleaned

# --- Serializers Transaccionales ---

class PersonSpecialAssignmentSerializer(serializers.ModelSerializer):
    class Meta:
        model = PersonSpecialAssignment
        fields = '__all__'
    
    def validate_project_name(self, value): return title_case_cleaner(value)
    
    def validate(self, data):
        return validate_date_range(data)

class PersonFunctionalExperienceSerializer(serializers.ModelSerializer):
    class Meta:
        model = PersonFunctionalExperience
        fields = '__all__'

    def validate(self, data):
        return validate_date_range(data)

class PersonCertificationSerializer(serializers.ModelSerializer):
    class Meta:
        model = PersonCertification
        fields = '__all__'

    def validate_name(self, value): return title_case_cleaner(value)
    def validate_institution(self, value): return title_case_cleaner(value)

    def validate(self, data):
        # Validamos 'effective_date' vs 'expiration_date'
        return validate_date_range(data, start_field='effective_date', end_field='expiration_date')

class CertificationDocumentSerializer(serializers.ModelSerializer):
    class Meta:
        model = CertificationDocument
        fields = '__all__'

class PersonEducationSerializer(serializers.ModelSerializer):
    level_name = serializers.CharField(source='level.name', read_only=True)
    field_of_study_name = serializers.CharField(source='field_of_study.name', read_only=True)
    class Meta:
        model = PersonEducation
        fields = '__all__'

    def validate_school_name(self, value): return title_case_cleaner(value)

    def validate(self, data):
        return validate_date_range(data)

class PersonVolunteerExperienceSerializer(serializers.ModelSerializer):
    class Meta:
        model = PersonVolunteerExperience
        fields = '__all__'

    def validate_organization_name(self, value): return title_case_cleaner(value)
    def validate_role(self, value): return title_case_cleaner(value)

    def validate(self, data):
        return validate_date_range(data)

class PersonAwardSerializer(serializers.ModelSerializer):
    class Meta:
        model = PersonAward
        fields = '__all__'

    def validate_name(self, value): return title_case_cleaner(value)
    def validate_institution(self, value): return title_case_cleaner(value)

    def validate_issue_date(self, value):
        if value > date.today():
            raise serializers.ValidationError("La fecha de obtención del premio no puede ser futura.")
        return value

class PersonMembershipSerializer(serializers.ModelSerializer):
    class Meta:
        model = PersonMembership
        fields = '__all__'

    def validate_organization_name(self, value): return title_case_cleaner(value)
    def validate_role(self, value): return title_case_cleaner(value)

    def validate(self, data):
        return validate_date_range(data)

class LanguageProficiencySerializer(serializers.ModelSerializer):
    class Meta: model = LanguageProficiency; fields = '__all__'
    def validate_name(self, value):
        cleaned = title_case_cleaner(validate_text_with_spaces(value, 'Nombre'))
        validate_min_length(cleaned, 2)
        return check_uniqueness(LanguageProficiency, 'name', cleaned, self.instance)

class LanguageSerializer(serializers.ModelSerializer):
    class Meta: model = Language; fields = '__all__'
    def validate_name(self, value):
        cleaned = title_case_cleaner(validate_text_with_spaces(value, 'Nombre'))
        validate_min_length(cleaned, 2)
        return check_uniqueness(Language, 'name', cleaned, self.instance)

class PersonLanguageSerializer(serializers.ModelSerializer):
    language_name = serializers.CharField(source='language.name', read_only=True)
    
    speaking_proficiency_name = serializers.CharField(source='speaking_proficiency.name', read_only=True)
    reading_proficiency_name = serializers.CharField(source='reading_proficiency.name', read_only=True)
    writing_proficiency_name = serializers.CharField(source='writing_proficiency.name', read_only=True)
    class Meta:
        model = PersonLanguage
        fields = '__all__'
        validators = [
            serializers.UniqueTogetherValidator(
                queryset=PersonLanguage.objects.all(),
                fields=['person', 'language'],
                message='Esta persona ya tiene registrado este idioma.'
            )
        ]
</file>

<file path="frontend2/components/catalogs/catalog-crud.tsx">
"use client";

import { useState, useEffect, useMemo, useCallback } from "react";
import { TableSkeleton } from "@/components/skeletons/table-skeleton";
import { DataTable } from "./data-table";
import { Button } from "@/components/ui/button";
import { Plus, Pencil, Trash2, Loader2, AlertCircle } from "lucide-react";
import {
    Dialog,
    DialogContent,
    DialogDescription,
    DialogFooter,
    DialogHeader,
    DialogTitle,
    DialogTrigger,
} from "@/components/ui/dialog";
import {
    AlertDialog,
    AlertDialogAction,
    AlertDialogCancel,
    AlertDialogContent,
    AlertDialogDescription,
    AlertDialogFooter,
    AlertDialogHeader,
    AlertDialogTitle,
} from "@/components/ui/alert-dialog";
import { ActionMenu } from "@/components/ui/action-menu";
import { Combobox } from "@/components/ui/combobox";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import apiClient from "@/lib/api-client";
import { toast } from "sonner";
import { ColumnDef } from "@tanstack/react-table";
import { zodResolver } from "@hookform/resolvers/zod";
import { useForm } from "react-hook-form";
import { z } from "zod";
import {
    Form,
    FormControl,
    FormField,
    FormItem,
    FormLabel,
    FormMessage,
} from "@/components/ui/form";
import { Switch } from "@/components/ui/switch";
import { Alert, AlertDescription, AlertTitle } from "@/components/ui/alert";
import { Textarea } from "@/components/ui/textarea";
import { DatePicker } from "@/components/ui/date-picker";
import { format, parseISO } from "date-fns";

export interface CatalogField {
    name: string;
    label: string;
    type: "text" | "number" | "email" | "select" | "checkbox" | "textarea" | "date" | "hidden";
    required?: boolean;
    optionsUrl?: string; // API endpoint to fetch options
    options?: { label: string; value: string }[]; // Static options
    optionLabelKey?: string; // Key to display (default: name)
    optionValueKey?: string; // Key for value (default: id)
    defaultValue?: any; // Default value for the field
    onChange?: (value: any, form: any, options?: any[]) => void; // Callback for value change
}

interface CatalogCRUDProps {
    title: React.ReactNode | string;
    apiUrl: string;
    fields: CatalogField[];
    columns: ColumnDef<any>[];
    searchKey?: string;
    searchOptions?: { label: string; value: string }[];
    extraActions?: (item: any) => React.ReactNode;
    disableCreate?: boolean;
    disableEdit?: boolean;
    customToolbarActions?: React.ReactNode;
    disablePagination?: boolean;
    icon?: React.ElementType;
}

export function CatalogCRUD({ title, apiUrl, fields, columns, searchKey, searchOptions, extraActions, disableCreate, disableEdit, customToolbarActions, disablePagination, icon: Icon }: CatalogCRUDProps) {
    const [data, setData] = useState<any[]>([]);
    const [isLoading, setIsLoading] = useState(true);
    const [isDialogOpen, setIsDialogOpen] = useState(false);
    const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false);
    const [isEditConfirmDialogOpen, setIsEditConfirmDialogOpen] = useState(false);
    const [currentItem, setCurrentItem] = useState<any | null>(null);
    const [isSaving, setIsSaving] = useState(false);
    const [fieldOptions, setFieldOptions] = useState<Record<string, any[]>>({});
    const [serverError, setServerError] = useState<string | string[] | null>(null);
    const [pendingFormData, setPendingFormData] = useState<any>(null);

    const [pagination, setPagination] = useState({
        pageIndex: 0,
        pageSize: 10,
    });
    const [rowCount, setRowCount] = useState(0);
    const [searchTerm, setSearchTerm] = useState("");
    // Default to first option if available, otherwise empty
    const [currentSearchOption, setCurrentSearchOption] = useState(searchOptions?.[0]?.value || "");

    // Dynamic Zod Schema Generation
    const formSchema = useMemo(() => {
        const shape: Record<string, z.ZodTypeAny> = {};
        fields.forEach((field) => {
            let fieldSchema;
            if (field.type === "number") {
                fieldSchema = z.coerce.number();
                if (field.required) {
                    fieldSchema = fieldSchema.min(1, { message: `${field.label} es requerido` });
                }
            } else if (field.type === "checkbox") {
                // Handle boolean or empty string (which can happen if default is "")
                fieldSchema = z.union([z.boolean(), z.literal("")]).transform((val) => val === "" ? false : val).default(false);
            } else if (field.type === "hidden") {
                // Hidden fields can be anything, usually string or number
                fieldSchema = z.any();
            } else {
                fieldSchema = z.string();
                if (field.required) {
                    fieldSchema = fieldSchema.min(1, { message: `${field.label} es requerido` });
                }
            }

            if (!field.required && field.type !== "checkbox" && field.type !== "hidden") {
                fieldSchema = fieldSchema.optional();
            }
            shape[field.name] = fieldSchema;
        });
        return z.object(shape);
    }, [fields]);

    type FormValues = z.infer<typeof formSchema>;

    const form = useForm<FormValues>({
        resolver: zodResolver(formSchema),
        defaultValues: {},
    });

    // Fetch Data
    const fetchData = async () => {
        // setIsLoading(true); // Removed to prevent unmounting DataTable on updates
        try {
            const params: any = {
                page: pagination.pageIndex + 1,
                page_size: pagination.pageSize,
            };
            if (searchTerm) {
                params.search = searchTerm;
                if (currentSearchOption) {
                    params.search_field = currentSearchOption;
                }
            }
            const response = await apiClient.get(apiUrl, { params });

            if (response.data.results) {
                setData(response.data.results);
                setRowCount(response.data.count);
            } else {
                // Fallback for non-paginated responses
                setData(response.data);
                setRowCount(response.data.length);
            }
        } catch (error) {
            // console.error("Error fetching data:", error);
            toast.error("Error al cargar los datos.");
        } finally {
            setIsLoading(false);
        }
    };

    // Fetch Options for Select Fields
    const fetchOptions = async () => {
        const options: Record<string, any[]> = {};
        for (const field of fields) {
            if (field.type === "select" && field.optionsUrl) {
                try {
                    const response = await apiClient.get(field.optionsUrl, { params: { page_size: 1000 } });
                    options[field.name] = response.data.results || response.data;
                } catch (error) {
                    // console.error(`Error fetching options for ${field.name}:`, error);
                }
            }
        }
        setFieldOptions(options);
    };

    useEffect(() => {
        fetchData();
        fetchOptions();
    }, [apiUrl, pagination.pageIndex, pagination.pageSize, searchTerm, currentSearchOption]);

    const handleSearch = useCallback((term: string) => {
        setSearchTerm(term);
        setPagination(prev => ({ ...prev, pageIndex: 0 })); // Reset to first page on search
    }, []);

    // Open Create Dialog
    const handleCreate = () => {
        setCurrentItem(null);
        setServerError(null);
        form.reset({});
        // Reset default values based on fields
        const defaults: any = {};
        fields.forEach(f => {
            if (f.defaultValue !== undefined) {
                defaults[f.name] = f.defaultValue;
            } else if (f.type === "checkbox") {
                defaults[f.name] = false;
            } else {
                defaults[f.name] = "";
            }
        });
        form.reset(defaults);
        setIsDialogOpen(true);
    };

    // Open Edit Dialog
    const handleEdit = (item: any) => {
        setCurrentItem(item);
        setServerError(null);
        // For selects, we might need to map objects to IDs if the API returns objects
        const formattedItem = { ...item };
        fields.forEach(field => {
            const value = item[field.name];
            if (field.type === "select" && value !== null && typeof value === 'object') {
                if (Array.isArray(value)) {
                    // Si es un array (M2M), tomamos el primer elemento si existe
                    // Esto asume selección única para este campo en el frontend
                    if (value.length > 0) {
                        const firstItem = value[0];
                        if (typeof firstItem === 'object' && firstItem.id) {
                            formattedItem[field.name] = firstItem.id.toString();
                        } else if (firstItem && typeof firstItem !== 'object') {
                            formattedItem[field.name] = firstItem.toString();
                        }
                    } else {
                        formattedItem[field.name] = "";
                    }
                } else if (value.id) {
                    // Objeto único con ID
                    formattedItem[field.name] = value.id.toString();
                }
            } else if (field.type === "checkbox") {
                formattedItem[field.name] = value;
            } else if (value !== undefined && value !== null) {
                formattedItem[field.name] = value.toString();
            }
        });
        form.reset(formattedItem);
        setIsDialogOpen(true);
    };

    // Open Delete Dialog
    const handleDeleteClick = (item: any) => {
        setCurrentItem(item);
        setIsDeleteDialogOpen(true);
    };

    // Submit Form (Create/Update)
    const onSubmit = async (values: FormValues) => {
        // If editing, show confirmation dialog first
        if (currentItem) {
            setPendingFormData(values);
            setIsEditConfirmDialogOpen(true);
            return;
        }

        // Sanitize values: ensure checkboxes are booleans
        const sanitizedValues = { ...values };
        fields.forEach(f => {
            if (f.type === "checkbox") {
                sanitizedValues[f.name] = !!values[f.name];
            }
        });

        // If creating, submit directly
        await submitForm(sanitizedValues);
    };

    // Actual submission function
    const submitForm = async (values: FormValues) => {
        setIsSaving(true);
        setServerError(null);
        setIsEditConfirmDialogOpen(false);
        try {
            if (currentItem) {
                // Update
                await apiClient.patch(`${apiUrl}${currentItem.id}/`, values);
                toast.success("Registro actualizado correctamente.");
            } else {
                // Create
                await apiClient.post(apiUrl, values);
                toast.success("Registro creado correctamente.");
            }
            setIsDialogOpen(false);
            fetchData();
        } catch (error: any) {
            // console.error("Error saving data:", error);
            if (error.response) {
                const data = error.response.data;
                const generalErrors: string[] = [];

                if (error.response.status === 400) {
                    // Field validation errors
                    if (data.non_field_errors) {
                        generalErrors.push(...data.non_field_errors);
                    }
                    if (data.detail) {
                        generalErrors.push(data.detail);
                    }

                    // Handle field errors
                    Object.keys(data).forEach((key) => {
                        if (key !== 'non_field_errors' && key !== 'detail') {
                            const msg = Array.isArray(data[key]) ? data[key][0] : data[key];

                            // Check if key exists in fields
                            if (fields.some(f => f.name === key)) {
                                const lowerMsg = String(msg).toLowerCase();
                                const isUniquenessError = lowerMsg.includes("existe") || lowerMsg.includes("registrado");

                                if (isUniquenessError) {
                                    // Uniqueness error: Global alert + Red border (empty message)
                                    form.setError(key, {
                                        type: "manual",
                                        message: "",
                                    });
                                    generalErrors.push(`${msg}`);
                                } else {
                                    // Standard validation error: Text below field
                                    form.setError(key, {
                                        type: "manual",
                                        message: msg,
                                    });
                                }
                            } else {
                                // If error is for a field not in the form, show as general error
                                // Also check if it's a non_field_error disguised as a field error (e.g. unique_together on hidden fields)
                                generalErrors.push(`${key}: ${msg}`);
                            }
                        }
                    });

                    // If we have field errors, we don't need to show a general error unless there are non_field_errors
                    // But if the user wants consistency, maybe we should always show field errors below the field.
                    // The issue is likely that some backend errors are not keyed to the field name.

                    if (generalErrors.length > 0) {
                        setServerError(generalErrors);
                    }
                } else {
                    setServerError(data.detail || "Ocurrió un error al guardar el registro.");
                }
            } else {
                setServerError("Error de conexión. Verifique su internet.");
            }
            toast.error("Error al guardar el registro.");
        } finally {
            setIsSaving(false);
        }
    };

    // Confirm Delete
    const handleConfirmDelete = async () => {
        if (!currentItem) return;
        try {
            await apiClient.delete(`${apiUrl}${currentItem.id}/`);
            toast.success("Registro eliminado correctamente.");
            setIsDeleteDialogOpen(false);
            fetchData();
        } catch (error) {
            // console.error("Error deleting data:", error);
            toast.error("Error al eliminar el registro.");
        }
    };

    // Add Actions Column
    const tableColumns: ColumnDef<any>[] = [
        ...columns,
        {
            id: "actions",
            cell: ({ row }) => {
                const item = row.original;
                return (
                    <div className="text-right">
                        <ActionMenu
                            onEdit={disableEdit ? undefined : () => handleEdit(item)}
                            onDelete={() => handleDeleteClick(item)}
                        >
                            {extraActions && extraActions(item)}
                        </ActionMenu>
                    </div>
                );
            },
        },
    ];

    return (
        <div className="space-y-4">
            <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                {title ? (
                    <h2 className="text-xl font-bold tracking-tight flex items-center">
                        {Icon && <Icon className="mr-2 size-6 text-primary" />}
                        {title}
                    </h2>
                ) : <div></div>}
                <div className="flex gap-2">
                    {disableCreate ? customToolbarActions : (
                        <Button onClick={handleCreate}>
                            <Plus className="mr-2 h-4 w-4" />
                            Nuevo
                        </Button>
                    )}
                </div>
            </div>

            {isLoading ? (
                <TableSkeleton columnCount={tableColumns.length} />
            ) : (
                <DataTable
                    columns={tableColumns}
                    data={data}
                    searchKey={searchKey}
                    searchOptions={searchOptions}
                    currentSearchOption={currentSearchOption}
                    onSearchOptionChange={setCurrentSearchOption}
                    rowCount={rowCount}
                    pagination={pagination}
                    onPaginationChange={setPagination}
                    onSearch={searchKey ? setSearchTerm : undefined}
                    disablePagination={disablePagination}
                />
            )}
            <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>
                <DialogContent className="sm:max-w-[425px] max-h-[90vh] flex flex-col">
                    <DialogHeader>
                        <DialogTitle>{currentItem ? "Editar Registro" : "Nuevo Registro"}</DialogTitle>
                        <DialogDescription>
                            Complete el formulario para {currentItem ? "actualizar" : "crear"} el registro.
                        </DialogDescription>
                    </DialogHeader>

                    <div className="flex-1 overflow-y-auto px-1 py-2">
                        {serverError && (
                            <Alert variant="destructive" className="mb-4">
                                <AlertCircle className="h-4 w-4" />
                                <AlertTitle>Error</AlertTitle>
                                <AlertDescription>
                                    {Array.isArray(serverError) ? (
                                        serverError.length > 1 ? (
                                            <ul className="list-disc list-inside">
                                                {serverError.map((err, index) => (
                                                    <li key={index}>{err}</li>
                                                ))}
                                            </ul>
                                        ) : (
                                            serverError[0]
                                        )
                                    ) : (
                                        serverError
                                    )}
                                </AlertDescription>
                            </Alert>
                        )}

                        <Form {...form}>
                            <form id="catalog-form" onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
                                {fields.map((field) => (
                                    <FormField
                                        key={field.name}
                                        control={form.control}
                                        name={field.name}
                                        render={({ field: formField }) => (
                                            <FormItem className={field.type === "hidden" ? "hidden" : ""}>
                                                {field.type !== "hidden" && <FormLabel>{field.label}</FormLabel>}
                                                <FormControl>
                                                    {field.type === "select" ? (
                                                        <Combobox
                                                            options={
                                                                field.options
                                                                    ? field.options
                                                                    : (fieldOptions[field.name]?.map((option) => ({
                                                                        value: option[field.optionValueKey || "id"].toString(),
                                                                        label: option[field.optionLabelKey || "name"],
                                                                    })) || [])
                                                            }
                                                            value={formField.value?.toString() || ""}
                                                            onSelect={(value) => {
                                                                formField.onChange(value);
                                                                if (field.onChange) {
                                                                    const options = field.options || fieldOptions[field.name];
                                                                    field.onChange(value, form, options);
                                                                }
                                                            }}
                                                            placeholder="Seleccione una opción"
                                                            emptyText="No se encontraron resultados."
                                                        />
                                                    ) : field.type === "checkbox" ? (
                                                        <div className="flex items-center space-x-2">
                                                            <Switch
                                                                checked={!!formField.value}
                                                                onCheckedChange={formField.onChange}
                                                            />
                                                            <Label>{field.label}</Label>
                                                        </div>
                                                    ) : field.type === "textarea" ? (
                                                        <Textarea
                                                            placeholder={field.label}
                                                            {...formField}
                                                            value={(formField.value as string) ?? ""}
                                                        />
                                                    ) : field.type === "date" ? (
                                                        <DatePicker
                                                            value={
                                                                formField.value && typeof formField.value === 'string'
                                                                    ? parseISO(formField.value)
                                                                    : (formField.value instanceof Date ? formField.value : undefined)
                                                            }
                                                            onChange={(date) => {
                                                                formField.onChange(date ? format(date, "yyyy-MM-dd") : "");
                                                            }}
                                                            placeholder={field.label}
                                                        />
                                                    ) : field.type === "hidden" ? (
                                                        <input type="hidden" {...formField} value={(formField.value as string | number) ?? ""} />
                                                    ) : (
                                                        <Input
                                                            type={field.type}
                                                            placeholder={field.label}
                                                            {...formField}
                                                            value={(formField.value as string | number) ?? ""}
                                                        />
                                                    )}
                                                </FormControl>
                                                <FormMessage />
                                            </FormItem>
                                        )}
                                    />
                                ))}
                            </form>
                        </Form>
                    </div>
                    <DialogFooter>
                        <Button type="button" variant="outline" onClick={() => setIsDialogOpen(false)}>
                            Cancelar
                        </Button>
                        <Button type="submit" form="catalog-form" disabled={isSaving}>
                            {isSaving && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                            Guardar
                        </Button>
                    </DialogFooter>
                </DialogContent>
            </Dialog>

            {/* Edit Confirmation Dialog */}
            <AlertDialog open={isEditConfirmDialogOpen} onOpenChange={setIsEditConfirmDialogOpen}>
                <AlertDialogContent>
                    <AlertDialogHeader>
                        <AlertDialogTitle>¿Está seguro de realizar los cambios?</AlertDialogTitle>
                        <AlertDialogDescription>
                            Se actualizará el registro con los nuevos datos ingresados.
                        </AlertDialogDescription>
                    </AlertDialogHeader>
                    <AlertDialogFooter>
                        <AlertDialogCancel>Cancelar</AlertDialogCancel>
                        <AlertDialogAction
                            onClick={() => pendingFormData && submitForm(pendingFormData)}
                            disabled={isSaving}
                        >
                            {isSaving && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                            Confirmar
                        </AlertDialogAction>
                    </AlertDialogFooter>
                </AlertDialogContent>
            </AlertDialog>

            {/* Delete Confirmation Dialog */}
            <AlertDialog open={isDeleteDialogOpen} onOpenChange={setIsDeleteDialogOpen}>
                <AlertDialogContent>
                    <AlertDialogHeader>
                        <AlertDialogTitle>¿Está seguro?</AlertDialogTitle>
                        <AlertDialogDescription>
                            Esta acción no se puede deshacer. Esto eliminará permanentemente el registro.
                        </AlertDialogDescription>
                    </AlertDialogHeader>
                    <AlertDialogFooter>
                        <AlertDialogCancel>Cancelar</AlertDialogCancel>
                        <AlertDialogAction onClick={handleConfirmDelete} className="bg-destructive text-white hover:bg-destructive/90">
                            Eliminar
                        </AlertDialogAction>
                    </AlertDialogFooter>
                </AlertDialogContent>
            </AlertDialog>
        </div>
    );
}
</file>

<file path="frontend2/components/catalogs/data-table.tsx">
"use client"

import {
    ColumnDef,
    flexRender,
    getCoreRowModel,
    useReactTable,
    SortingState,
    getSortedRowModel,
    ColumnFiltersState,
    getFilteredRowModel,
    PaginationState,
    OnChangeFn,
} from "@tanstack/react-table"

import {
    Table,
    TableBody,
    TableCell,
    TableHead,
    TableHeader,
    TableRow,
} from "@/components/ui/table"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { useState, useEffect } from "react"
import { ChevronLeft, ChevronRight, ChevronsLeft, ChevronsRight } from "lucide-react"
import {
    Select,
    SelectContent,
    SelectItem,
    SelectTrigger,
    SelectValue,
} from "@/components/ui/select"

interface DataTableProps<TData, TValue> {
    columns: ColumnDef<TData, TValue>[]
    data: TData[]
    searchOptions?: { label: string; value: string }[]
    onSearchOptionChange?: (value: string) => void
    currentSearchOption?: string
    searchKey?: string
    rowCount?: number
    pagination?: PaginationState
    onPaginationChange?: OnChangeFn<PaginationState>
    onSearch?: (value: string) => void
    disablePagination?: boolean
}

export function DataTable<TData, TValue>({
    columns,
    data,
    searchKey,
    searchOptions,
    onSearchOptionChange,
    currentSearchOption,
    rowCount,
    pagination,
    onPaginationChange,
    onSearch,
    disablePagination,
}: DataTableProps<TData, TValue>) {
    const [sorting, setSorting] = useState<SortingState>([])
    const [columnFilters, setColumnFilters] = useState<ColumnFiltersState>([])
    const [searchValue, setSearchValue] = useState("")

    const table = useReactTable({
        data,
        columns,
        getCoreRowModel: getCoreRowModel(),
        manualPagination: true, // Enable server-side pagination
        pageCount: rowCount && pagination ? Math.ceil(rowCount / pagination.pageSize) : -1,
        onSortingChange: setSorting,
        getSortedRowModel: getSortedRowModel(),
        onColumnFiltersChange: setColumnFilters,
        getFilteredRowModel: getFilteredRowModel(),
        onPaginationChange: onPaginationChange,
        state: {
            sorting,
            columnFilters,
            pagination: pagination,
        },
    })

    useEffect(() => {
        const timeoutId = setTimeout(() => {
            if (onSearch) {
                onSearch(searchValue)
            }
        }, 500)
        return () => clearTimeout(timeoutId)
    }, [searchValue, onSearch])

    return (
        <div className="flex flex-col gap-6">
            <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                {searchKey && (
                    <Input
                        placeholder="Buscar..."
                        value={searchValue}
                        onChange={(event) => setSearchValue(event.target.value)}
                        className="sm:max-w-sm w-full text-sm"
                    />
                )}
                {searchOptions && searchOptions.length > 0 && (
                    <Select
                        value={currentSearchOption}
                        onValueChange={(value) => onSearchOptionChange && onSearchOptionChange(value)}
                    >
                        <SelectTrigger className="w-full sm:w-[180px]">
                            <SelectValue placeholder="Buscar por..." />
                        </SelectTrigger>
                        <SelectContent>
                            {searchOptions.map((option) => (
                                <SelectItem key={option.value} value={option.value}>
                                    {option.label}
                                </SelectItem>
                            ))}
                        </SelectContent>
                    </Select>
                )}
            </div>
            <div className="rounded-md border overflow-hidden">
                <Table>
                    <TableHeader>
                        {table.getHeaderGroups().map((headerGroup) => (
                            <TableRow key={headerGroup.id} className="bg-primary hover:bg-primary">
                                {headerGroup.headers.map((header) => {
                                    return (
                                        <TableHead key={header.id} className="text-primary-foreground font-bold">
                                            {header.isPlaceholder
                                                ? null
                                                : flexRender(
                                                    header.column.columnDef.header,
                                                    header.getContext()
                                                )}
                                        </TableHead>
                                    )
                                })}
                            </TableRow>
                        ))}
                    </TableHeader>
                    <TableBody>
                        {table.getRowModel().rows?.length ? (
                            table.getRowModel().rows.map((row) => (
                                <TableRow
                                    key={row.id}
                                    data-state={row.getIsSelected() && "selected"}
                                >
                                    {row.getVisibleCells().map((cell) => (
                                        <TableCell key={cell.id}>
                                            {flexRender(cell.column.columnDef.cell, cell.getContext())}
                                        </TableCell>
                                    ))}
                                </TableRow>
                            ))
                        ) : (
                            <TableRow>
                                <TableCell colSpan={columns.length} className="h-24 text-center">
                                    No hay resultados.
                                </TableCell>
                            </TableRow>
                        )}
                    </TableBody>
                </Table>
            </div>
            {!disablePagination && (
                <div className="flex items-center justify-between gap-2">
                    <div className="flex-1 text-sm font-medium">
                        Página {table.getState().pagination.pageIndex + 1} de{" "}
                        {table.getPageCount()}
                    </div>
                    <div className="flex items-center gap-4">
                        <div className="hidden items-center space-x-2 sm:flex">
                            <p className="text-sm font-medium">Filas por página</p>
                            <Select
                                value={`${table.getState().pagination.pageSize}`}
                                onValueChange={(value) => {
                                    table.setPageSize(Number(value))
                                }}
                            >
                                <SelectTrigger className="h-8 w-[70px]">
                                    <SelectValue placeholder={table.getState().pagination.pageSize} />
                                </SelectTrigger>
                                <SelectContent side="top">
                                    {[10, 20, 30, 40, 50].map((pageSize) => (
                                        <SelectItem key={pageSize} value={`${pageSize}`}>
                                            {pageSize}
                                        </SelectItem>
                                    ))}
                                </SelectContent>
                            </Select>
                        </div>
                        <div className="flex items-center justify-end gap-2">
                            <Button
                                variant="outline"
                                className="hidden h-8 w-8 p-0 lg:flex"
                                onClick={() => table.setPageIndex(0)}
                                disabled={!table.getCanPreviousPage()}
                            >
                                <span className="sr-only">Ir a la primera página</span>
                                <ChevronsLeft className="h-4 w-4" />
                            </Button>
                            <Button
                                variant="outline"
                                className="h-8 w-8 p-0"
                                onClick={() => table.previousPage()}
                                disabled={!table.getCanPreviousPage()}
                            >
                                <span className="sr-only">Ir a la página anterior</span>
                                <ChevronLeft className="h-4 w-4" />
                            </Button>
                            <Button
                                variant="outline"
                                className="h-8 w-8 p-0"
                                onClick={() => table.nextPage()}
                                disabled={!table.getCanNextPage()}
                            >
                                <span className="sr-only">Ir a la página siguiente</span>
                                <ChevronRight className="h-4 w-4" />
                            </Button>
                            <Button
                                variant="outline"
                                className="hidden h-8 w-8 p-0 lg:flex"
                                onClick={() => table.setPageIndex(table.getPageCount() - 1)}
                                disabled={!table.getCanNextPage()}
                            >
                                <span className="sr-only">Ir a la última página</span>
                                <ChevronsRight className="h-4 w-4" />
                            </Button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    )
}
</file>

<file path="frontend2/package.json">
{
  "name": "frontend2",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "@heroicons/react": "^2.2.0",
    "@hookform/resolvers": "^5.2.2",
    "@radix-ui/react-alert-dialog": "^1.1.15",
    "@radix-ui/react-avatar": "^1.1.11",
    "@radix-ui/react-dialog": "^1.1.15",
    "@radix-ui/react-dropdown-menu": "^2.1.16",
    "@radix-ui/react-label": "^2.1.8",
    "@radix-ui/react-popover": "^1.1.15",
    "@radix-ui/react-select": "^2.2.6",
    "@radix-ui/react-separator": "^1.1.8",
    "@radix-ui/react-slot": "^1.2.4",
    "@radix-ui/react-switch": "^1.2.6",
    "@radix-ui/react-tabs": "^1.1.13",
    "@tanstack/react-table": "^8.21.3",
    "axios": "^1.13.2",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "cmdk": "^1.1.1",
    "date-fns": "^4.1.0",
    "lucide-react": "^0.555.0",
    "next": "16.0.5",
    "next-themes": "^0.4.6",
    "react": "19.2.0",
    "react-day-picker": "^9.11.3",
    "react-dom": "19.2.0",
    "react-hook-form": "^7.67.0",
    "sonner": "^2.0.7",
    "swr": "^2.3.7",
    "tailwind-merge": "^3.4.0",
    "zod": "^4.1.13"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "eslint": "^9",
    "eslint-config-next": "16.0.5",
    "tailwindcss": "^4",
    "tw-animate-css": "^1.4.0",
    "typescript": "^5"
  }
}
</file>

<file path="backend/employment/serializers.py">
from rest_framework import serializers
from django.db.models import Q
from django.utils import timezone
from django.db import transaction
from core.serializers import check_uniqueness, title_case_cleaner, validate_text_with_spaces, validate_min_length
# Importamos utilidades y modelos necesarios de las apps correctas:
from organization.models import Position 
from .models import (
    Employment, EmploymentStatusLog, EmploymentDepartmentRole, PersonDepartmentRole,
    is_active_status, EmploymentStatusChoices, HierarchicalRoleChoices
)

# --- Serializer de Status Log ---

class EmploymentStatusLogSerializer(serializers.ModelSerializer):
    # Muestra el nombre del estatus en lugar del código
    status_name = serializers.CharField(source='get_status_display', read_only=True)
    
    class Meta:
        model = EmploymentStatusLog
        fields = '__all__'

    def validate(self, data):
        start_date = data.get('start_date')
        end_date = data.get('end_date')
        if start_date and end_date and end_date < start_date:
            raise serializers.ValidationError({
                "end_date": "La fecha de fin del estatus no puede ser anterior a la fecha de inicio."
            })
        return data

# --- SERIALIZADOR DE ESCRITURA Y LECTURA ÚNICA (Employment) ---

class EmploymentSerializer(serializers.ModelSerializer):
    person_full_name = serializers.SerializerMethodField()
    person_document = serializers.SerializerMethodField()
    user_account_details = serializers.SerializerMethodField()
    status_logs = EmploymentStatusLogSerializer(many=True, read_only=True)
    supervisor_info = serializers.SerializerMethodField()
    
    # Para mostrar el nombre del estatus en lectura
    current_status_display = serializers.CharField(source='get_current_status_display', read_only=True)
    role_display = serializers.CharField(source='get_role_display', read_only=True)
    employment_type_display = serializers.CharField(source='get_employment_type_display', read_only=True)

    class Meta:
        model = Employment
        fields = '__all__' 

    def validate(self, data):
        # 1. RECUPERACIÓN DE DATOS (Para Create y Update)
        hire_date = data.get('hire_date')
        end_date = data.get('end_date')
        
        # Recuperamos los objetos completos (DRF convierte los IDs en Objetos aquí)
        person = data.get('person') or (self.instance.person if self.instance else None)
        position = data.get('position') or (self.instance.position if self.instance else None)
        current_status = data.get('current_status') or (self.instance.current_status if self.instance else None)
        
        if self.instance:
            hire_date = hire_date or self.instance.hire_date

        # 2. VALIDACIONES DE FECHA (Mantenidas)
        if end_date and hire_date and end_date < hire_date:
            raise serializers.ValidationError({"end_date": "La fecha de finalización no puede ser anterior a la fecha de contratación."})
        
        if person and person.birthdate and hire_date:
             if hire_date < person.birthdate:
                raise serializers.ValidationError({"hire_date": "La fecha de contratación no puede ser anterior a la fecha de nacimiento."})

        # ---------------------------------------------------------------------
        # 3. NUEVA VALIDACIÓN: INTEGRIDAD DE CONTRATO (NO DUPLICAR ACTIVOS)
        # ---------------------------------------------------------------------
        # Si tenemos estatus y este estatus "ocupa silla" (es activo/vigente)...
        if person and position and current_status and is_active_status(current_status):
            
            # Buscamos si hay OTROS contratos vigentes para esta misma persona y cargo
            all_employments = Employment.objects.filter(
                person=person,
                position=position,
            )
            
            # Si estamos editando, nos excluimos a nosotros mismos de la búsqueda
            if self.instance:
                all_employments = all_employments.exclude(pk=self.instance.pk)

            # Filtrar solo los activos usando helper function
            duplicates = [e for e in all_employments if is_active_status(e.current_status)]

            if duplicates:
                # Obtenemos el estatus del conflicto para ser específicos en el mensaje
                conflict_status = duplicates[0].get_current_status_display()
                raise serializers.ValidationError({
                    "current_status": f"Esta persona ya tiene un contrato vigente ({conflict_status}) en este cargo. Debe finalizar el anterior antes de activar este."
                })

        # ---------------------------------------------------------------------
        # 4. CONTROL DE VACANTES (Optimizado con is_active_status)
        # ---------------------------------------------------------------------
        # Solo validamos si cambiamos de posición o es nuevo registro
        if position and (not self.instance or self.instance.position != position):
            
            position_obj = position # Ya es el objeto Position gracias a DRF
            
            # Contamos cuántos empleados están ocupando esa posición (usando la bandera booleana)
            all_position_employments = Employment.objects.filter(position=position_obj)
            
            # Nota: No necesitamos restar 1 manualmente si usamos exclude(pk) correctamente
            if self.instance:
                all_position_employments = all_position_employments.exclude(pk=self.instance.pk)
            
            # Contamos solo los activos
            current_occupancy = sum(1 for e in all_position_employments if is_active_status(e.current_status))
            max_vacancies = position_obj.vacancies
            
            if current_occupancy >= max_vacancies:
                raise serializers.ValidationError({
                    'position': f'La posición "{str(position_obj)}" está completa ({current_occupancy}/{max_vacancies}). No hay vacantes disponibles.'
                })
        
        return data

    def get_person_full_name(self, obj):
        return str(obj.person) if obj.person else "Desconocido"

    def get_person_document(self, obj):
        if obj.person:
            doc = obj.person.national_ids.filter(is_primary=True).first()
            if doc:
                return f"{doc.document_type}-{doc.number}"
        return "Sin Documento"

    def get_user_account_details(self, obj):
        if obj.person and hasattr(obj.person, 'user_account'):
            user = obj.person.user_account
            return {
                'id': user.id,
                'username': user.username,
                'is_active': user.is_active,
                'is_staff': user.is_staff
            }
        return None

    def get_supervisor_info(self, obj):
        if not obj.position:
            return None

        # Support for ManyToMany manager_positions
        boss_positions = obj.position.manager_positions.all()
        
        if not boss_positions.exists():
            return None

        # Iterate through all boss positions to find an active boss
        for boss_position in boss_positions:
            boss_employments = boss_position.employments.all()
            
            for emp in boss_employments:
                if is_active_status(emp.current_status):
                    return {
                        "id": emp.person.id,
                        "name": str(emp.person),
                        "position": boss_position.title
                    }
        
        # If boss positions exist but no one is active
        first_boss_pos = boss_positions.first()
        return {
            "id": None,
            "name": "VACANTE",
            "position": first_boss_pos.title if first_boss_pos else "Sin Jefe"
        }


# --- SERIALIZADOR DE ROLES JERÁRQUICOS EN DEPARTAMENTO ---

class EmploymentDepartmentRoleSerializer(serializers.ModelSerializer):
    # Campos de lectura para mostrar información detallada
    employment_person_name = serializers.CharField(source='employment.person.full_name', read_only=True)
    department_name = serializers.CharField(source='department.name', read_only=True)
    hierarchical_role_display = serializers.CharField(source='get_hierarchical_role_display', read_only=True)
    is_current = serializers.BooleanField(read_only=True)
    
    class Meta:
        model = EmploymentDepartmentRole
        fields = '__all__'
    
    def validate(self, data):
        """Validaciones personalizadas"""
        employment = data.get('employment')
        department = data.get('department')
        start_date = data.get('start_date')
        end_date = data.get('end_date')
        hierarchical_role = data.get('hierarchical_role')
        
        # 1. Validar que el departamento coincide con el del employment
        # 1. Validar que el departamento coincide con el del employment - REMOVED for Matrix Support
        # if employment and department:
        #     if employment.position and employment.position.department != department:
        #         raise serializers.ValidationError({
        #             'department': f'El departamento debe coincidir con el departamento de la posición del empleado ({employment.position.department.name})'
        #         })
        
        # 2. Validar que end_date sea posterior a start_date
        if start_date and end_date and end_date < start_date:
            raise serializers.ValidationError({
                'end_date': 'La fecha de fin debe ser posterior a la fecha de inicio'
            })
        
        # 3. Validar que no exista otro rol activo para el mismo employment y department
        if employment and department:
            # Obtener el ID de la instancia actual (en caso de UPDATE)
            instance_pk = self.instance.pk if self.instance else None
            
            # Buscar roles activos (sin end_date o con end_date futuro)
            existing_active_roles = EmploymentDepartmentRole.objects.filter(
                employment=employment,
                department=department,
                end_date__isnull=True
            ).exclude(pk=instance_pk)
            
            if existing_active_roles.exists():
                raise serializers.ValidationError({
                    'employment': 'Ya existe un rol jerárquico activo para este empleado en este departamento'
                })
        
        # 4. VALIDACIÓN DE UNICIDAD ACTIVA PARA GERENTES
        # Solo se aplica si el rol es Gerente (MGR)
        if hierarchical_role == HierarchicalRoleChoices.MANAGER and department:
            instance_pk = self.instance.pk if self.instance else None
            today = timezone.now().date()
            
            # Buscar otros gerentes activos en el mismo departamento
            # Un rol está activo si: end_date es NULL O end_date >= hoy
            existing_active_manager = EmploymentDepartmentRole.objects.filter(
                department=department,
                hierarchical_role=HierarchicalRoleChoices.MANAGER
            ).filter(
                Q(end_date__isnull=True) | Q(end_date__gte=today)
            ).exclude(pk=instance_pk).select_related('employment__person').first()
            
            if existing_active_manager:
                conflict_person_name = existing_active_manager.employment.person.full_name
                department_name = department.name
                raise serializers.ValidationError({
                    'hierarchical_role': f'El Departamento {department_name} ya tiene un Gerente activo ({conflict_person_name}). Finalice el rol anterior antes de asignar uno nuevo.'
                })
        
        return data
    

    @transaction.atomic
    def create(self, validated_data):
        # 🚨 ¡CAMBIO CLAVE! 🚨
        # No hacemos nada con el status aquí. El modelo Employment se encarga de:
        # 1. Guardar el registro.
        # 2. Llamar a su save() (que a su vez llama a full_clean()).
        # 3. Llamar a _create_status_log() automáticamente.
        
        employment = super().create(validated_data)
        
        # Nota: Si tu frontend envía el 'end_date' a NULL, el estatus por defecto 'Activo' 
        # y el log se crean.
        
        return employment
    
    def get_user_account_details(self, obj):
        """
        Retorna detalles básicos del usuario si existe.
        """
        if obj.person and hasattr(obj.person, 'user_account'):
            user = obj.person.user_account
            return {
                'id': user.id,
                'username': user.username,
                'is_active': user.is_active,
                'is_staff': user.is_staff
            }
        return None
    
    def get_person_full_name(self, obj):
        return str(obj.person) if obj.person else "Desconocido"

    def get_person_document(self, obj):
        """
        Busca el documento principal (Cédula) de la persona asociada.
        """
        if obj.person:
            # Usamos la relación inversa 'national_ids' definida en core.models
            doc = obj.person.national_ids.filter(is_primary=True).first()
            if doc:
                return f"{doc.document_type}-{doc.number}"
        return "Sin Documento"
    
    def get_supervisor_info(self, obj):
        """
        Retorna el nombre y cargo del jefe inmediato.
        Lógica: Mi Cargo -> Cargo Jefe -> Persona Activa en Cargo Jefe
        """
        # 1. Validar que tenga posición y esa posición tenga un jefe definido
        
        if not obj.position or not obj.position.manager_position:
            return None

        boss_position = obj.position.manager_position

        # 2. Buscar quién ocupa la posición del jefe HOY (Activo y Vigente)
        boss_employments = boss_position.employments.all()
        
        # Filtrar manualmente usando helper function
        active_boss = None
        for emp in boss_employments:
            if is_active_status(emp.current_status):
                active_boss = emp
                break

        if active_boss:
            return {
                "id": active_boss.person.id,
                "name": str(active_boss.person),
                "position": boss_position.name
            }
        
        # Existe el cargo de jefe (ej. Gerente), pero nadie lo ocupa (Vacante)
        return {
            "id": None,
            "name": "VACANTE",
            "position": boss_position.name
        }

# --- SERIALIZADOR DE LISTADO (Ajustado) ---

class EmployeeListSerializer(serializers.ModelSerializer):
    
    person_full_name = serializers.SerializerMethodField()
    person_document = serializers.SerializerMethodField()
    position_full_name = serializers.SerializerMethodField()
    department_name = serializers.SerializerMethodField()
    
    # Mostrar el display name en lugar del código
    current_status_display = serializers.CharField(source='get_current_status_display', read_only=True)
    role_display = serializers.CharField(source='get_role_display', read_only=True)
    employment_type_display = serializers.CharField(source='get_employment_type_display', read_only=True)

    class Meta:
        model = Employment
        fields = '__all__' 

    # --- MÉTODOS CORREGIDOS ---
    
    def get_person_full_name(self, obj):
        """Resuelve el nombre completo de core.Person."""
        # Se asegura de que si la persona existe, usa su __str__ (nombre y apellido)
        return str(obj.person) if obj.person else "Persona Desconocida"

    def get_person_document(self, obj):
        """
        Busca el documento principal (Cédula) de la persona asociada.
        """
        if obj.person:
            # Usamos la relación inversa 'national_ids' definida en core.models
            doc = obj.person.national_ids.filter(is_primary=True).first()
            if doc:
                return f"{doc.document_type}-{doc.number}"
        return "Sin Documento"

    def get_position_full_name(self, obj):
        """Resuelve el nombre del cargo (Position)."""
        # Usa solo el nombre del JobTitle como se solicitó
        if obj.position and obj.position.job_title:
            return obj.position.job_title.name
        return str(obj.position) if obj.position else "Sin Cargo Asignado"

    def get_department_name(self, obj):
        """Resuelve el nombre del Departamento a través de la Posición."""
        # Maneja la cadena de nulos: si no hay position O no hay department, retorna "N/A".
        if obj.position and obj.position.department:
            return obj.position.department.name
        return "N/A"


# --- SERIALIZADOR DE ROLES JERÁRQUICOS POR PERSONA (MATRIZ) ---

class PersonDepartmentRoleSerializer(serializers.ModelSerializer):
    """
    Serializer para roles jerárquicos por persona en departamentos.
    Soporta organizaciones matriciales.
    """
    # Campos de lectura para mostrar información detallada
    person_name = serializers.CharField(source='person.full_name', read_only=True)
    department_name = serializers.CharField(source='department.name', read_only=True)
    hierarchical_role_display = serializers.CharField(source='get_hierarchical_role_display', read_only=True)
    is_current = serializers.BooleanField(read_only=True)
    
    class Meta:
        model = PersonDepartmentRole
        fields = '__all__'
    
    def validate(self, data):
        """
        Validaciones personalizadas:
        A) Unicidad de rol activo por persona+departamento
        B) Unicidad de gerente activo por departamento
        """
        person = data.get('person')
        department = data.get('department')
        start_date = data.get('start_date')
        end_date = data.get('end_date')
        hierarchical_role = data.get('hierarchical_role')
        
        instance_pk = self.instance.pk if self.instance else None
        today = timezone.now().date()
        
        # Validación básica: end_date posterior a start_date
        if start_date and end_date and end_date < start_date:
            raise serializers.ValidationError({
                'end_date': 'La fecha de fin debe ser posterior a la fecha de inicio'
            })
        
        # VALIDACIÓN A: Unicidad de rol activo por persona+departamento
        # Una persona solo puede tener UN rol activo en un departamento a la vez
        if person and department:
            existing_active_role = PersonDepartmentRole.objects.filter(
                person=person,
                department=department
            ).filter(
                Q(end_date__isnull=True) | Q(end_date__gte=today)
            ).exclude(pk=instance_pk).first()
            
            if existing_active_role:
                # NOTA: Esta validación permite la creación porque el método create()
                # auto-finalizará el rol anterior, pero advertimos al usuario
                pass  # La validación está deshabilitada para permitir auto-finalization
        
        # VALIDACIÓN B: Unicidad de gerente activo por departamento
        # Solo puede haber UN gerente activo por departamento
        if hierarchical_role == HierarchicalRoleChoices.MANAGER and department:
            existing_active_manager = PersonDepartmentRole.objects.filter(
                department=department,
                hierarchical_role=HierarchicalRoleChoices.MANAGER
            ).filter(
                Q(end_date__isnull=True) | Q(end_date__gte=today)
            ).exclude(pk=instance_pk).select_related('person').first()
            
            if existing_active_manager:
                conflict_person_name = existing_active_manager.person.full_name
                department_name = department.name
                raise serializers.ValidationError({
                    'hierarchical_role': f'El Departamento {department_name} ya tiene un Gerente activo ({conflict_person_name}). Finalice el rol anterior antes de asignar uno nuevo.'
                })
        
        return data
    
    @transaction.atomic
    def create(self, validated_data):
        """
        Lógica de auto-finalización de roles anteriores.
        
        Antes de crear un nuevo rol, busca cualquier rol activo para la
        misma persona+departamento y lo finaliza automáticamente estableciendo
        su end_date al día anterior del start_date del nuevo rol.
        """
        person = validated_data.get('person')
        department = validated_data.get('department')
        new_start_date = validated_data.get('start_date')
        
        # Buscar rol activo anterior para la misma persona+departamento
        existing_active_role = PersonDepartmentRole.objects.filter(
            person=person,
            department=department,
            end_date__isnull=True  # Solo los roles actualmente sin fin
        ).first()
        
        if existing_active_role:
            # Auto-finalizar el rol anterior estableciendo end_date al día anterior
            from datetime import timedelta
            existing_active_role.end_date = new_start_date - timedelta(days=1)
            existing_active_role.save()
        
        # Crear el nuevo rol
        new_role = PersonDepartmentRole.objects.create(**validated_data)
        return new_role
</file>

<file path="backend/organization/models.py">
from django.db import models
from simple_history.models import HistoricalRecords

class Department(models.Model):
    name = models.CharField(max_length=100, unique=True)
    parent = models.ForeignKey('self', on_delete=models.SET_NULL, null=True, blank=True, related_name='subdepartments')
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    # Historial de cambios
    history = HistoricalRecords()

    def __str__(self):
        return self.name

class JobTitle(models.Model):
    name = models.CharField(max_length=100, unique=True)
    # description field removed
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    # Historial de cambios
    history = HistoricalRecords()

    def __str__(self):
        return self.name

class Position(models.Model):
    department = models.ForeignKey(Department, on_delete=models.SET_NULL, null=True)
    job_title = models.ForeignKey(JobTitle, on_delete=models.SET_NULL, null=True)
    vacancies = models.PositiveIntegerField(default=1, help_text="Número de vacantes disponibles")
    
    # Objetivo del cargo (antes era un modelo separado)
    objective = models.TextField(
        blank=True, 
        null=True,
        help_text="Objetivo general del cargo",
        verbose_name="Objetivo"
    )
    
    # Reportes Matriciales: Una posición puede reportar a múltiples jefes
    manager_positions = models.ManyToManyField(
        'self',
        symmetrical=False,
        blank=True,
        related_name='direct_reports',
        help_text="Posiciones a las que reporta directamente (Jefes Inmediatos)."
    )

    is_manager = models.BooleanField(
        default=False,
        verbose_name="Es Gerencial",
        help_text="Indica si esta posición tiene responsabilidades gerenciales."
    )
    
    # name field removed
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    # Historial de cambios
    history = HistoricalRecords()

    class Meta:
        unique_together = ('department', 'job_title')

    @property
    def title(self):
        """Nombre legible del cargo"""
        return f"{self.job_title.name} - {self.department.name}" if self.job_title and self.department else "Posición sin título"

    def __str__(self):
        if not self.job_title or not self.department:
            return "Posición incompleta"
        return f"{self.job_title.name} - {self.department.name}"


class PositionRequirement(models.Model):
    position = models.ForeignKey(Position, on_delete=models.CASCADE, related_name='requirements')
    description = models.TextField(help_text="Un requisito de la posición")
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    def __str__(self): return self.description[:50]

class PositionFunction(models.Model):
    """Funciones y responsabilidades de un cargo"""
    position = models.ForeignKey(
        Position, 
        on_delete=models.CASCADE, 
        related_name='functions',
        help_text="Posición a la que pertenece esta función"
    )
    description = models.TextField(help_text="Descripción de la función o responsabilidad")
    order = models.PositiveIntegerField(
        default=0, 
        help_text="Orden de visualización (menor primero)"
    )
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        ordering = ['order', 'id']
        verbose_name = "Función de Cargo"
        verbose_name_plural = "Funciones de Cargos"
        
    def __str__(self):
        return f"{self.position} - Función #{self.order + 1}"
</file>

<file path="backend/organization/serializers.py">
from rest_framework import serializers
from core.serializers import check_uniqueness, title_case_cleaner, validate_alphanumeric_with_spaces
from .models import Department, JobTitle, Position, PositionRequirement, PositionFunction

# Serializers simples para detalles
class PositionRequirementSerializer(serializers.ModelSerializer):
    class Meta: model = PositionRequirement; fields = '__all__'

class PositionFunctionSerializer(serializers.ModelSerializer):
    class Meta: 
        model = PositionFunction
        fields = '__all__'

class DepartmentSerializer(serializers.ModelSerializer):
    # Campo extra para mostrar el nombre del padre
    parent_name = serializers.CharField(source='parent.name', read_only=True)
    # Include nested parent object for display
    parent = serializers.SerializerMethodField()

    class Meta:
        model = Department
        fields = '__all__'
    
    def get_parent(self, obj):
        if obj.parent:
            return {'id': obj.parent.id, 'name': obj.parent.name}
        return None

    def validate_name(self, value): 
        cleaned = title_case_cleaner(validate_alphanumeric_with_spaces(value, 'Nombre'))
        return check_uniqueness(Department, 'name', cleaned, self.instance, "Ya existe un departamento con este nombre.")

    def validate(self, data):
        parent = data.get('parent')
        if self.instance and parent and parent.id == self.instance.id:
            raise serializers.ValidationError({
                "parent": "Un departamento no puede ser su propio departamento padre (referencia circular)."
            })
        return data

class JobTitleSerializer(serializers.ModelSerializer):
    class Meta:
        model = JobTitle
        fields = '__all__'
    
    def validate_name(self, value): 
        cleaned = title_case_cleaner(validate_alphanumeric_with_spaces(value, 'Nombre'))
        return check_uniqueness(JobTitle, 'name', cleaned, self.instance, "Ya existe un cargo con este nombre.")

class PositionSerializer(serializers.ModelSerializer):
    # --- CAMPOS DE LECTURA PARA LA TABLA ---
    # Usamos source='relation.name' porque department y job_title tienen campo 'name'
    department_name = serializers.CharField(source='department.name', read_only=True)
    job_title_name = serializers.CharField(source='job_title.name', read_only=True)
    
    # Campos para múltiples jefes (M2M)
    manager_positions_names = serializers.SerializerMethodField()
    reports_to_names_display = serializers.SerializerMethodField()
    manager_positions_data = serializers.SerializerMethodField()
    
    # Campo para el select (Combo box)
    full_name = serializers.SerializerMethodField()

    # Detalles anidados
    requirements = PositionRequirementSerializer(many=True, read_only=True)
    functions = PositionFunctionSerializer(many=True, read_only=True)
    
    # Campo calculado para empleados activos
    active_employees_count = serializers.SerializerMethodField()

    class Meta:
        model = Position
        fields = '__all__'
        # Deshabilitar validación automática de unique_together
        validators = []

    def get_full_name(self, obj):
        return str(obj)
    
    def get_active_employees_count(self, obj):
        """Devuelve el número de empleados activos en esta posición."""
        from employment.models import Employment, is_active_status
        # Actualizado para usar is_active_status
        all_emps = Employment.objects.filter(position=obj)
        return sum(1 for e in all_emps if is_active_status(e.current_status))

    def get_manager_positions_names(self, obj):
        """Devuelve una lista con los nombres de los cargos de los jefes."""
        return [
            str(manager)
            for manager in obj.manager_positions.all() 
        ]

    def get_reports_to_names_display(self, obj):
        """Devuelve un string separado por comas con los nombres de los cargos de los jefes."""
        names = self.get_manager_positions_names(obj)
        return ", ".join(names) if names else "-"

    def get_manager_positions_data(self, obj):
        """Devuelve información completa de los jefes para detección de cross-department."""
        return [
            {
                'id': manager.id,
                'job_title_name': manager.job_title.name if manager.job_title else None,
                'department_id': manager.department.id if manager.department else None,
            }
            for manager in obj.manager_positions.all()
        ]


    def to_internal_value(self, data):
        if hasattr(data, 'copy'):
            data = data.copy()
        
        # Manejar manager_positions: si viene como valor único, convertir a lista
        if 'manager_positions' in data:
            value = data['manager_positions']
            if not isinstance(value, list):
                # If value is an empty string, treat it as an empty list
                if value == "":
                    data['manager_positions'] = []
                elif value:
                    data['manager_positions'] = [value]
                else:
                    data['manager_positions'] = []
        
        return super().to_internal_value(data)

    def validate(self, data):
        # Importar aquí para evitar import circular
        from core.serializers import validate_unique_together
        
        # Usar helper genérico para unique_together
        return validate_unique_together(
            self, data, Position, ('department', 'job_title'),
            error_template='Ya existe una posición con este cargo en {department}.'
        )
</file>

<file path="backend/organization/views.py">
from rest_framework import viewsets, permissions
from .models import Department, JobTitle, Position, PositionRequirement, PositionFunction
from .serializers import DepartmentSerializer, JobTitleSerializer, PositionSerializer, PositionRequirementSerializer, PositionFunctionSerializer

from core.filters import UnaccentSearchFilter

class DepartmentViewSet(viewsets.ModelViewSet):
    queryset = Department.objects.all()
    serializer_class = DepartmentSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['name']

class JobTitleViewSet(viewsets.ModelViewSet):
    queryset = JobTitle.objects.all()
    serializer_class = JobTitleSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['name']

from django_filters.rest_framework import DjangoFilterBackend

class PositionViewSet(viewsets.ModelViewSet):
    queryset = Position.objects.all().select_related('department', 'job_title').prefetch_related('manager_positions', 'manager_positions__job_title', 'manager_positions__department')
    serializer_class = PositionSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    filter_backends = [DjangoFilterBackend, UnaccentSearchFilter]
    filterset_fields = ['department', 'is_manager']
    search_fields = ['job_title__name', 'department__name']

class PositionRequirementViewSet(viewsets.ModelViewSet):
    serializer_class = PositionRequirementSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    
    def get_queryset(self):
        position_id = self.kwargs.get('position_pk')
        if position_id:
            return PositionRequirement.objects.filter(position_id=position_id)
        return PositionRequirement.objects.all()
    
    def perform_create(self, serializer):
        position_id = self.kwargs.get('position_pk')
        serializer.save(position_id=position_id)

class PositionFunctionViewSet(viewsets.ModelViewSet):
    serializer_class = PositionFunctionSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    filter_backends = [DjangoFilterBackend]
    filterset_fields = ['position']
    
    def get_queryset(self):
        position_id = self.kwargs.get('position_pk')
        if position_id:
            return PositionFunction.objects.filter(position_id=position_id)
        return PositionFunction.objects.all()
    
    def perform_create(self, serializer):
        position_id = self.kwargs.get('position_pk')
        serializer.save(position_id=position_id)
</file>

<file path="backend/core/models.py">
from django.db import models
from simple_history.models import HistoricalRecords

# Configuración base para mensajes de error
UNIQUE_ERR_MSG = {'unique': "Ya existe un registro con este nombre."}
ISO_UNIQUE_ERR_MSG = {'unique': "Ya existe un registro con este código ISO."}
CODE_UNIQUE_ERR_MSG = {'unique': "Ya existe un registro con este código."}
EMAIL_UNIQUE_ERR_MSG = {'unique': "Este correo electrónico ya está registrado."}

# --- CATÁLOGOS BÁSICOS ---
class Gender(models.Model):
    name = models.CharField(max_length=50, unique=True, error_messages=UNIQUE_ERR_MSG)
    def __str__(self): return self.name

class MaritalStatus(models.Model):
    name = models.CharField(max_length=50, unique=True, error_messages=UNIQUE_ERR_MSG)
    def __str__(self): return self.name

class Country(models.Model):
    name = models.CharField(max_length=100, unique=True, error_messages=UNIQUE_ERR_MSG)
    iso_2 = models.CharField(max_length=2, help_text="Ej: US, VE.", unique=True, error_messages=ISO_UNIQUE_ERR_MSG)
    def __str__(self): return self.name

class DisabilityGroup(models.Model):
    name = models.CharField(max_length=100, unique=True, error_messages=UNIQUE_ERR_MSG)
    def __str__(self): return self.name

class DisabilityType(models.Model):
    name = models.CharField(max_length=100, unique=True, error_messages=UNIQUE_ERR_MSG)
    def __str__(self): return self.name

class DisabilityStatus(models.Model):
    name = models.CharField(max_length=50, unique=True, error_messages=UNIQUE_ERR_MSG)
    def __str__(self): return self.name

class AddressType(models.Model):
    name = models.CharField(max_length=50, unique=True, error_messages=UNIQUE_ERR_MSG)
    def __str__(self): return self.name

class EmailType(models.Model):
    name = models.CharField(max_length=50, unique=True, error_messages=UNIQUE_ERR_MSG)
    def __str__(self): return self.name

class PhoneType(models.Model):
    name = models.CharField(max_length=50, unique=True, error_messages=UNIQUE_ERR_MSG)
    def __str__(self): return self.name

class PhoneCarrier(models.Model):
    name = models.CharField(max_length=50, unique=True, error_messages=UNIQUE_ERR_MSG)
    def __str__(self): return self.name

class Bank(models.Model):
    name = models.CharField(max_length=100, unique=True, error_messages=UNIQUE_ERR_MSG)
    code = models.CharField(max_length=4, unique=True, error_messages=CODE_UNIQUE_ERR_MSG)
    def __str__(self): return f"{self.name} ({self.code})"

class BankAccountType(models.Model):
    name = models.CharField(max_length=50, unique=True, error_messages=UNIQUE_ERR_MSG)
    def __str__(self): return self.name

class RelationshipType(models.Model):
    name = models.CharField(max_length=50, unique=True, error_messages=UNIQUE_ERR_MSG)
    def __str__(self): return self.name

# --- MODELOS RELACIONALES ---

class State(models.Model):
    name = models.CharField(max_length=100)
    country = models.ForeignKey(Country, on_delete=models.CASCADE)
    class Meta: unique_together = ('country', 'name')
    def __str__(self): return f"{self.name}, {self.country.name}"

class PhoneCarrierCode(models.Model):
    carrier = models.ForeignKey(PhoneCarrier, on_delete=models.CASCADE)
    code = models.CharField(max_length=4)
    class Meta: unique_together = ('carrier', 'code')
    def __str__(self): return f"{self.code} ({self.carrier})"

class Person(models.Model):
    first_name = models.CharField(max_length=100)
    second_name = models.CharField(max_length=100, blank=True, null=True)
    paternal_surname = models.CharField(max_length=100)
    maternal_surname = models.CharField(max_length=100, blank=True, null=True)
    gender = models.ForeignKey(Gender, on_delete=models.PROTECT, null=False, blank=False)
    marital_status = models.ForeignKey(MaritalStatus, on_delete=models.SET_NULL, null=True, blank=True)
    birthdate = models.DateField(null=False, blank=False)
    country_of_birth = models.ForeignKey(Country, on_delete=models.SET_NULL, null=True, blank=True)
    photo = models.ImageField(upload_to='photos/person/', null=True, blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    # Historial de cambios
    history = HistoricalRecords()
    
    def __str__(self): return f"{self.first_name} {self.paternal_surname}"

# --- IDENTIFICACIÓN VENEZOLANA ROBUSTA ---
class NationalId(models.Model):
    # ... (campos igual que antes) ...
    CATEGORY_CHOICES = [
        ('CEDULA', 'Cédula de Identidad'),
        ('RIF', 'RIF'),
        ('PASSPORT', 'Pasaporte'),
    ]

    PREFIX_CHOICES = [
        ('V', 'V - Venezolano / Persona Natural'),
        ('E', 'E - Extranjero / Persona Natural'),
        ('J', 'J - Jurídico'),
        ('G', 'G - Gubernamental'),
        ('P', 'P - Pasaporte'),
    ]

    person = models.ForeignKey(Person, on_delete=models.CASCADE, related_name="national_ids")
    
    category = models.CharField(max_length=10, choices=CATEGORY_CHOICES, default='CEDULA')
    document_type = models.CharField(max_length=1, choices=PREFIX_CHOICES, default='V', verbose_name="Prefijo")
    number = models.CharField(max_length=20, help_text="Solo números.")
    
    is_primary = models.BooleanField(default=False)
    file = models.FileField(upload_to='documents/national_id/', blank=True, null=True)

    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        unique_together = [
            # REGLA 1: Nadie más puede tener este documento en el sistema
            ('document_type', 'number'),
            
            # REGLA 2: Esta persona solo puede tener UNO de cada categoría
            ('person', 'category'),
        ]

    def save(self, *args, **kwargs):
        # La cédula siempre es el documento principal
        if self.category == 'CEDULA':
            self.is_primary = True
        super().save(*args, **kwargs)

    def __str__(self):
        return f"{self.get_category_display()}: {self.document_type}-{self.number}"

# --- DETALLES DE PERSONA ---

class PersonDisabilityVE(models.Model):
    person = models.OneToOneField(Person, on_delete=models.CASCADE, primary_key=True)
    date_learned = models.DateField(null=True, blank=True)
    disability_group = models.ForeignKey(DisabilityGroup, on_delete=models.SET_NULL, null=True, blank=True)
    disability_degree = models.CharField(max_length=50, blank=True, null=True)
    disability_type = models.ForeignKey(DisabilityType, on_delete=models.SET_NULL, null=True, blank=True)
    issuing_authority = models.CharField(max_length=100, blank=True, null=True)
    reference_number = models.CharField(max_length=50, blank=True, null=True)
    disability_status = models.ForeignKey(DisabilityStatus, on_delete=models.SET_NULL, null=True, blank=True)
    date_of_determination = models.DateField(null=True, blank=True)

class Address(models.Model):
    person = models.ForeignKey(Person, on_delete=models.CASCADE, related_name="addresses")
    address_type = models.ForeignKey(AddressType, on_delete=models.SET_NULL, null=True)
    country = models.ForeignKey(Country, on_delete=models.SET_NULL, null=True)
    state = models.ForeignKey(State, on_delete=models.SET_NULL, null=True)
    city = models.CharField(max_length=100)
    postal_code = models.CharField(max_length=20, blank=True, null=True)
    street_name_and_number = models.CharField(max_length=255)
    extra_address_line = models.CharField(max_length=255, blank=True, null=True)
    house_number = models.CharField(max_length=50, blank=True, null=True)
    apartment = models.CharField(max_length=50, blank=True, null=True)
    street_2 = models.CharField(max_length=255, blank=True, null=True)

class PersonEmail(models.Model):
    person = models.ForeignKey(Person, on_delete=models.CASCADE, related_name="emails")
    email_type = models.ForeignKey(EmailType, on_delete=models.SET_NULL, null=True)
    email_address = models.EmailField(unique=True, error_messages=EMAIL_UNIQUE_ERR_MSG) 
    is_primary = models.BooleanField(default=False)
    
    def __str__(self): 
        return self.email_address

class PersonPhone(models.Model):
    person = models.ForeignKey(Person, on_delete=models.CASCADE, related_name="phones")
    phone_type = models.ForeignKey(PhoneType, on_delete=models.SET_NULL, null=True)
    carrier_code = models.ForeignKey(PhoneCarrierCode, on_delete=models.SET_NULL, null=True)
    subscriber_number = models.CharField(max_length=10)
    is_primary = models.BooleanField(default=False)
    
    def __str__(self): return f"{self.carrier_code.code}-{self.subscriber_number}"
    
    class Meta:
        constraints = [
            models.UniqueConstraint(
                fields=['carrier_code', 'subscriber_number'],
                name="phone_unique",
                violation_error_message="Este número de teléfono ya se encuentra registrado.",
            ),
            models.UniqueConstraint(
                fields=['person'],
                condition=models.Q(is_primary=True),
                name='one_primary_phone_per_person',
                violation_error_message="La persona ya tiene un teléfono principal registrado.",
            ),
        ]

class PersonBankAccount(models.Model):
    person = models.ForeignKey(Person, on_delete=models.CASCADE, related_name="bank_accounts")
    bank = models.ForeignKey(Bank, on_delete=models.SET_NULL, null=True)
    bank_account_type = models.ForeignKey(BankAccountType, on_delete=models.SET_NULL, null=True)
    account_number = models.CharField(max_length=20, unique=True, error_messages={'unique': "Este número de cuenta ya está registrado."})
    is_primary = models.BooleanField(default=False)

class PersonDocument(models.Model):
    person = models.ForeignKey(Person, on_delete=models.CASCADE, related_name="documents")
    file = models.FileField(upload_to='documents/person/', blank=True, null=True)
    description = models.CharField(max_length=255, blank=True, null=True)

class PersonNationality(models.Model):
    person = models.ForeignKey(Person, on_delete=models.CASCADE, related_name="nationalities")
    country = models.ForeignKey(Country, on_delete=models.CASCADE)
    class Meta: unique_together = ('person', 'country')

# --- SATÉLITES ---
class Dependent(models.Model):
    person = models.ForeignKey(Person, on_delete=models.CASCADE, related_name="dependents")
    first_name = models.CharField(max_length=100)
    second_name = models.CharField(max_length=100, blank=True, null=True)
    paternal_surname = models.CharField(max_length=100)
    maternal_surname = models.CharField(max_length=100, blank=True, null=True)
    relationship = models.ForeignKey(RelationshipType, on_delete=models.SET_NULL, null=True)
    birthdate = models.DateField()
    gender = models.ForeignKey(Gender, on_delete=models.SET_NULL, null=True, blank=True)
    class Meta: unique_together = ('person', 'first_name', 'paternal_surname')

class EmergencyContact(models.Model):
    person = models.ForeignKey(Person, on_delete=models.CASCADE, related_name="emergency_contacts")
    first_name = models.CharField(max_length=100)
    second_name = models.CharField(max_length=100, blank=True, null=True)
    paternal_surname = models.CharField(max_length=100)
    maternal_surname = models.CharField(max_length=100, blank=True, null=True)
    relationship = models.ForeignKey(RelationshipType, on_delete=models.SET_NULL, null=True)
    phone_carrier_code = models.ForeignKey(PhoneCarrierCode, on_delete=models.SET_NULL, null=True)
    phone_number = models.CharField(max_length=10)
    is_primary = models.BooleanField(default=False)
</file>

<file path="backend/core/views.py">
from rest_framework import status
from rest_framework.response import Response
from rest_framework.decorators import action
from rest_framework import viewsets, permissions, filters
from .models import (
    Person, Gender, MaritalStatus, Country,
    DisabilityGroup, DisabilityType, DisabilityStatus,
    PersonDisabilityVE, AddressType, State, Address, 
    NationalId, EmailType, PersonEmail, PhoneType, PhoneCarrier, 
    PhoneCarrierCode, PersonPhone, Bank, BankAccountType, PersonBankAccount, 
    PersonDocument, RelationshipType, PersonNationality, 
    Dependent, EmergencyContact
)
from .serializers import (
    PersonSerializer, PersonListSerializer, GenderSerializer, MaritalStatusSerializer, 
    CountrySerializer,
    DisabilityGroupSerializer, DisabilityTypeSerializer, DisabilityStatusSerializer,
    PersonDisabilityVESerializer, AddressTypeSerializer, StateSerializer, 
    AddressSerializer, NationalIdSerializer, 
    EmailTypeSerializer, PersonEmailSerializer, PhoneTypeSerializer, 
    PhoneCarrierSerializer, PhoneCarrierCodeSerializer, PersonPhoneSerializer, 
    BankSerializer, BankAccountTypeSerializer, PersonBankAccountSerializer, 
    PersonDocumentSerializer, RelationshipTypeSerializer, 
    PersonNationalitySerializer,
    DependentSerializer, EmergencyContactSerializer
)
from .filters import UnaccentSearchFilter

class PersonViewSet(viewsets.ModelViewSet):
    queryset = Person.objects.all().order_by('-created_at')
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['first_name__unaccent', 'paternal_surname__unaccent', 'national_ids__number']

    def get_serializer_class(self):
        if self.action == 'list': return PersonListSerializer
        return PersonSerializer

    # FIX: Sobrescribimos get_queryset para permitir filtros avanzados
    def get_queryset(self):
        queryset = Person.objects.all().order_by('-created_at')
        
        # Filtro para el modal de contratación: Solo personas CON Cédula/ID
        if self.request.query_params.get('has_id') == 'true':
            queryset = queryset.filter(national_ids__isnull=False).distinct()
            
        return queryset

    @action(detail=True, methods=['post'], url_path='create-user-account')
    def create_user_account(self, request, pk=None):
        person = self.get_object()
        
        # 1. Validar si ya tiene usuario
        if hasattr(person, 'user_account') and person.user_account:
            return Response(
                {"error": "Esta persona ya tiene un usuario asignado."},
                status=status.HTTP_400_BAD_REQUEST
            )
            
        password = request.data.get('password')
        if not password:
            return Response(
                {"error": "La contraseña es obligatoria."},
                status=status.HTTP_400_BAD_REQUEST
            )

        # 2. Generar Username: Primera Letra Nombre + Primer Apellido + Últimos 4 dígitos Cédula
        # Normalizamos para quitar acentos y caracteres especiales
        import unicodedata
        def normalize_text(text):
            return ''.join(c for c in unicodedata.normalize('NFD', text) if unicodedata.category(c) != 'Mn').lower()

        first_initial = normalize_text(person.first_name[0])
        surname = normalize_text(person.paternal_surname)
        
        # Obtener cédula (documento principal)
        primary_doc = person.national_ids.filter(is_primary=True).first()
        if not primary_doc:
             return Response(
                {"error": "La persona debe tener un documento de identidad principal (Cédula) para generar el usuario."},
                status=status.HTTP_400_BAD_REQUEST
            )
            
        # Extraer últimos 4 dígitos, rellenar con 0 si es muy corta (raro en cédulas pero por seguridad)
        doc_number = primary_doc.number.replace('.', '').replace('-', '').strip()
        last_4_digits = doc_number[-4:].zfill(4)
        
        base_username = f"{first_initial}{surname}{last_4_digits}"
        username = base_username
        
        # 3. Manejo de colisiones (aunque la fórmula es bastante única)
        from django.contrib.auth import get_user_model
        User = get_user_model()
        counter = 1
        while User.objects.filter(username=username).exists():
            username = f"{base_username}{counter}"
            counter += 1
            
        # 4. Crear Usuario
        try:
            user = User.objects.create_user(
                username=username,
                password=password,
                person=person,
                is_active=True
            )
            return Response({
                "message": "Usuario creado exitosamente.",
                "username": username,
                "user_id": user.id
            }, status=status.HTTP_201_CREATED)
        except Exception as e:
            return Response(
                {"error": f"Error al crear usuario: {str(e)}"},
                status=status.HTTP_500_INTERNAL_SERVER_ERROR
            )

    @action(detail=True, methods=['post'], url_path='reset-password')
    def reset_password(self, request, pk=None):
        person = self.get_object()
        
        if not hasattr(person, 'user_account') or not person.user_account:
            return Response(
                {"error": "Esta persona no tiene un usuario asignado."},
                status=status.HTTP_400_BAD_REQUEST
            )
            
        password = request.data.get('password')
        if not password:
            return Response(
                {"error": "La contraseña es obligatoria."},
                status=status.HTTP_400_BAD_REQUEST
            )

        try:
            user = person.user_account
            user.set_password(password)
            user.save()
            return Response({
                "message": "Contraseña actualizada exitosamente."
            }, status=status.HTTP_200_OK)
        except Exception as e:
            return Response(
                {"error": f"Error al actualizar contraseña: {str(e)}"},
                status=status.HTTP_500_INTERNAL_SERVER_ERROR
            )

    @action(detail=True, methods=['post'], url_path='deactivate-user')
    def deactivate_user(self, request, pk=None):
        person = self.get_object()
        
        if not hasattr(person, 'user_account') or not person.user_account:
            return Response(
                {"error": "Esta persona no tiene un usuario asignado."},
                status=status.HTTP_400_BAD_REQUEST
            )
            
        try:
            user = person.user_account
            user.is_active = False
            user.save()
            return Response({
                "message": "Usuario desactivado exitosamente."
            }, status=status.HTTP_200_OK)
        except Exception as e:
            return Response(
                {"error": f"Error al desactivar usuario: {str(e)}"},
                status=status.HTTP_500_INTERNAL_SERVER_ERROR
            )

class NationalIdViewSet(viewsets.ModelViewSet):
    serializer_class = NationalIdSerializer
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['number', 'person__first_name__unaccent', 'person__paternal_surname__unaccent']
    
    def get_queryset(self):
        queryset = NationalId.objects.all()
        person_id = self.request.query_params.get('person')
        if person_id:
            queryset = queryset.filter(person=person_id)
        return queryset

# ... (Resto de ViewSets de Catálogos igual) ...
class GenderViewSet(viewsets.ModelViewSet):
    queryset = Gender.objects.all()
    serializer_class = GenderSerializer
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['name']
class MaritalStatusViewSet(viewsets.ModelViewSet):
    queryset = MaritalStatus.objects.all()
    serializer_class = MaritalStatusSerializer
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['name']
class CountryViewSet(viewsets.ModelViewSet):
    queryset = Country.objects.all()
    serializer_class = CountrySerializer
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['name', 'iso_2']

class DisabilityGroupViewSet(viewsets.ModelViewSet):
    queryset = DisabilityGroup.objects.all()
    serializer_class = DisabilityGroupSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['name']
class DisabilityTypeViewSet(viewsets.ModelViewSet):
    queryset = DisabilityType.objects.all()
    serializer_class = DisabilityTypeSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['name']
class DisabilityStatusViewSet(viewsets.ModelViewSet):
    queryset = DisabilityStatus.objects.all()
    serializer_class = DisabilityStatusSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['name']
class AddressTypeViewSet(viewsets.ModelViewSet):
    queryset = AddressType.objects.all()
    serializer_class = AddressTypeSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['name']
class EmailTypeViewSet(viewsets.ModelViewSet):
    queryset = EmailType.objects.all()
    serializer_class = EmailTypeSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['name']
class PhoneTypeViewSet(viewsets.ModelViewSet):
    queryset = PhoneType.objects.all()
    serializer_class = PhoneTypeSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['name']
class PhoneCarrierViewSet(viewsets.ModelViewSet):
    queryset = PhoneCarrier.objects.all()
    serializer_class = PhoneCarrierSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['name']
class BankViewSet(viewsets.ModelViewSet):
    queryset = Bank.objects.all()
    serializer_class = BankSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['name', 'code']
class BankAccountTypeViewSet(viewsets.ModelViewSet):
    queryset = BankAccountType.objects.all()
    serializer_class = BankAccountTypeSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['name']
class RelationshipTypeViewSet(viewsets.ModelViewSet):
    queryset = RelationshipType.objects.all()
    serializer_class = RelationshipTypeSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['name']
class StateViewSet(viewsets.ModelViewSet):
    queryset = State.objects.all()
    serializer_class = StateSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['name', 'country__name']
class PhoneCarrierCodeViewSet(viewsets.ModelViewSet):
    queryset = PhoneCarrierCode.objects.all()
    serializer_class = PhoneCarrierCodeSerializer
    permission_classes = [permissions.IsAuthenticated, permissions.IsAdminUser]
    filter_backends = [UnaccentSearchFilter]
    search_fields = ['code', 'carrier__name']

# --- ViewSets de Datos de Person ---
class PersonDisabilityVEViewSet(viewsets.ModelViewSet):
    queryset = PersonDisabilityVE.objects.all()
    serializer_class = PersonDisabilityVESerializer
    permission_classes = [permissions.IsAuthenticated]
    filter_backends = [filters.SearchFilter]
    search_fields = ['person__first_name', 'person__paternal_surname', 'disability_type__name', 'disability_status__name']
class AddressViewSet(viewsets.ModelViewSet):
    queryset = Address.objects.all()
    serializer_class = AddressSerializer
    permission_classes = [permissions.IsAuthenticated]
    def get_queryset(self):
        queryset = Address.objects.all()
        person_id = self.request.query_params.get('person')
        if person_id:
            queryset = queryset.filter(person=person_id)
        return queryset
    
class PersonEmailViewSet(viewsets.ModelViewSet):
    queryset = PersonEmail.objects.all()
    serializer_class = PersonEmailSerializer
    permission_classes = [permissions.IsAuthenticated]
    def get_queryset(self):
        queryset = PersonEmail.objects.all()
        person_id = self.request.query_params.get('person')
        if person_id:
            queryset = queryset.filter(person=person_id)
        return queryset
class PersonPhoneViewSet(viewsets.ModelViewSet):
    queryset = PersonPhone.objects.all()
    serializer_class = PersonPhoneSerializer
    permission_classes = [permissions.IsAuthenticated]
    def get_queryset(self):
        queryset = PersonPhone.objects.all()
        person_id = self.request.query_params.get('person')
        if person_id:
            queryset = queryset.filter(person=person_id)
        return queryset
    
class PersonBankAccountViewSet(viewsets.ModelViewSet):
    queryset = PersonBankAccount.objects.all()
    serializer_class = PersonBankAccountSerializer
    permission_classes = [permissions.IsAuthenticated]
class PersonDocumentViewSet(viewsets.ModelViewSet):
    queryset = PersonDocument.objects.all()
    serializer_class = PersonDocumentSerializer
    permission_classes = [permissions.IsAuthenticated]
class PersonNationalityViewSet(viewsets.ModelViewSet):
    queryset = PersonNationality.objects.all()
    serializer_class = PersonNationalitySerializer
    permission_classes = [permissions.IsAuthenticated]

# --- VIEWSETS SATÉLITES ---
class DependentViewSet(viewsets.ModelViewSet):
    queryset = Dependent.objects.all()
    serializer_class = DependentSerializer
    permission_classes = [permissions.IsAuthenticated]
    def get_queryset(self):
        queryset = Dependent.objects.all()
        person_id = self.request.query_params.get('person')
        if person_id:
            queryset = queryset.filter(person=person_id)
        return queryset

class EmergencyContactViewSet(viewsets.ModelViewSet):
    queryset = EmergencyContact.objects.all()
    serializer_class = EmergencyContactSerializer
    permission_classes = [permissions.IsAuthenticated]
    def get_queryset(self):
        queryset = EmergencyContact.objects.all()
        person_id = self.request.query_params.get('person')
        if person_id:
            queryset = queryset.filter(person=person_id)
        return queryset
</file>

<file path="backend/core/serializers.py">
from rest_framework import serializers
from rest_framework.validators import UniqueTogetherValidator
from datetime import date
import re 

from .models import (
    Person, Gender, MaritalStatus, Country, 
    DisabilityGroup, DisabilityType, DisabilityStatus,
    PersonDisabilityVE, AddressType, State, Address, 
    NationalId, EmailType, PersonEmail, PhoneType, PhoneCarrier, 
    PhoneCarrierCode, PersonPhone, Bank, BankAccountType, PersonBankAccount, 
    PersonDocument, RelationshipType, PersonNationality, 
    Dependent, EmergencyContact
)

# --- FUNCIONES DE UTILIDAD ---
def title_case_cleaner(value):
    if not value: return ""
    EXCLUSIONS = {'de', 'del', 'la', 'las', 'el', 'los', 'y', 'o', 'en', 'a', 'por', 'con', 'para', 'sin', 'so', 'sobre'}
    ROMAN_NUMERALS = {'i', 'ii', 'iii', 'iv', 'v', 'vi', 'vii', 'viii', 'ix', 'x', 'xi', 'xii', 'xiii', 'xiv', 'xv'}
    
    words = value.strip().lower().split()
    if not words: return ""
    
    processed_words = []
    
    # Primera palabra siempre capitalizada (o mayúscula si es romano)
    first_word = words[0]
    if first_word in ROMAN_NUMERALS:
        processed_words.append(first_word.upper())
    else:
        processed_words.append(first_word.capitalize())

    for word in words[1:]:
        if word in ROMAN_NUMERALS:
            processed_words.append(word.upper())
        elif word in EXCLUSIONS:
            processed_words.append(word)
        else:
            processed_words.append(word.capitalize())
            
    return " ".join(processed_words)

def sentence_case_cleaner(value):
    return value.strip().capitalize()

def validate_only_letters(value, field_name):
    if not value:
        return value
    if not re.fullmatch(r"^[a-zA-ZáéíóúÁÉÍÓÚüÜñÑ]+$", value):
        raise serializers.ValidationError("Este campo solo puede contener letras.")
    return value

def validate_text_with_spaces(value, field_name):
    """
    Valida que el valor solo contenga letras, espacios y tildes (sin números ni signos especiales).
    Usado para nombres de países, estados, tipos de catálogos, etc.
    """
    if not value:
        return value
    if not re.fullmatch(r"^[a-zA-ZáéíóúÁÉÍÓÚüÜñÑ\s]+$", value):
        raise serializers.ValidationError("Este campo solo puede contener letras.")
    return value

def validate_letters_only_no_spaces(value, field_name):
    """
    Valida que el valor solo contenga letras sin espacios ni tildes (para códigos ISO).
    """
    if not value:
        return value
    if not re.fullmatch(r"^[a-zA-Z]+$", value):
        raise serializers.ValidationError("Este campo solo puede contener letras.")
    return value

def validate_numeric_only(value, field_name):
    """
    Valida que el valor solo contenga números.
    Usado para códigos de banco, etc.
    """
    if not value:
        return value
    if not re.fullmatch(r"^[0-9]+$", value):
        raise serializers.ValidationError("Este campo solo puede contener números.")
    return value

def validate_alphanumeric_with_spaces(value, field_name):
    """
    Valida que el valor solo contenga letras, números, espacios y tildes.
    Usado para nombres de catálogos organizacionales (bancos, departamentos, carriers, etc.)
    """
    if not value:
        return value
    if not re.fullmatch(r"^[a-zA-Z0-9áéíóúÁÉÍÓÚüÜñÑ\s]+$", value):
        raise serializers.ValidationError("Este campo solo puede contener letras y números.")
    return value

def validate_min_length(value, min_len):
    """
    Valida que el valor tenga al menos min_len caracteres.
    """
    if not value:
        return value
    if len(value.strip()) < min_len:
        raise serializers.ValidationError(f"Este campo debe tener al menos {min_len} caracteres.")
    return value

def validate_exact_length(value, exact_len):
    """
    Valida que el valor tenga exactamente exact_len caracteres.
    """
    if not value:
        return value
    if len(value.strip()) != exact_len:
        raise serializers.ValidationError(f"Este campo debe tener exactamente {exact_len} caracteres.")
    return value

def validate_single_primary(serializer_instance, validated_data, model, primary_field_name):
    is_primary = validated_data.get('is_primary', getattr(serializer_instance.instance, 'is_primary', False))
    person = validated_data.get('person')

    if is_primary:
        queryset = model.objects.filter(person=person, is_primary=True)
        if serializer_instance.instance:
            queryset = queryset.exclude(pk=serializer_instance.instance.pk)

        if queryset.exists():
            raise serializers.ValidationError({
                'is_primary': f"Ya existe un registro principal."
            })
    return validated_data

def validate_unique_together(serializer_instance, validated_data, model, field_names, error_template=None):
    """
    Función genérica para validar unique_together con mensajes amigables.
    Los errores se retornan como non_field_errors para mostrarse en el Alert superior.
    
    Args:
        serializer_instance: La instancia del serializer (self)
        validated_data: Los datos validados
        model: El modelo a validar
        field_names: Tupla de nombres de campos que forman el unique_together (ej: ('country', 'name'))
        error_template: Template del mensaje de error. Si no se proporciona, se genera automáticamente.
                       Puede usar {field_name} como placeholders.
    
    Ejemplo de uso:
        validate_unique_together(self, data, State, ('country', 'name'), 
                                error_template='Ya existe un estado con este nombre en {country}.')
    """
    # Obtener valores de los campos
    field_values = {}
    for field_name in field_names:
        value = validated_data.get(field_name)
        if value is not None:
            field_values[field_name] = value
    
    # Si no tenemos todos los valores, no validar
    if len(field_values) != len(field_names):
        return validated_data
    
    # Construir el queryset
    filter_kwargs = {}
    for field_name, value in field_values.items():
        # Para campos de texto, usar case-insensitive
        if isinstance(value, str):
            filter_kwargs[f'{field_name}__iexact'] = value
        else:
            filter_kwargs[field_name] = value
    
    queryset = model.objects.filter(**filter_kwargs)
    if serializer_instance.instance:
        queryset = queryset.exclude(pk=serializer_instance.instance.pk)
    
    if queryset.exists():
        # Generar el mensaje de error
        if error_template:
            # Reemplazar placeholders con valores reales
            error_msg = error_template
            for field_name, value in field_values.items():
                # Si el valor tiene un atributo name (es un objeto), usarlo
                if hasattr(value, 'name'):
                    error_msg = error_msg.replace(f'{{{field_name}}}', value.name)
                else:
                    error_msg = error_msg.replace(f'{{{field_name}}}', str(value))
        else:
            # Mensaje genérico automático
            error_msg = "Ya existe un registro con esta combinación de valores."
        
        # Retornar como non_field_errors para que aparezca en el Alert superior
        raise serializers.ValidationError({
            'non_field_errors': [error_msg]
        })
    
    return validated_data

def check_uniqueness(model, field_name, value, instance=None, error_msg="Ya existe un registro con este valor."):
    filter_kwargs = {f"{field_name}__iexact": value}
    qs = model.objects.filter(**filter_kwargs)
    if instance:
        qs = qs.exclude(pk=instance.pk)
    if qs.exists():
        raise serializers.ValidationError(error_msg)
    return value

class AddressSerializer(serializers.ModelSerializer):
    # Campos para lectura
    address_type_name = serializers.CharField(source='address_type.name', read_only=True)
    country_name = serializers.CharField(source='country.name', read_only=True)
    state_name = serializers.CharField(source='state.name', read_only=True)

    class Meta: model = Address; fields = '__all__'
    
    def validate(self, data):
        if data.get('state') and data.get('country') and data['state'].country != data['country']:
            raise serializers.ValidationError({"state": "El estado no pertenece al país."})
        return data

    def validate_city(self, value):
        return title_case_cleaner(validate_text_with_spaces(value, 'Ciudad'))

    def validate_street_name_and_number(self, value):
        return title_case_cleaner(value)
    
class EmergencyContactSerializer(serializers.ModelSerializer):
    relationship_name = serializers.SerializerMethodField()
    phone_country_code = serializers.SerializerMethodField()
    phone_carrier_code = serializers.SerializerMethodField()
    
    class Meta: 
        model = EmergencyContact
        fields = '__all__'
    
    def get_relationship_name(self, obj):
        return obj.relationship.name if obj.relationship else None
    
    def get_phone_country_code(self, obj):
        # Venezuela solamente, prefijo fijo +58
        return "+58" if obj.phone_carrier_code else None
    
    def get_phone_carrier_code(self, obj):
        return obj.phone_carrier_code.code if obj.phone_carrier_code else None
    
    def validate_phone_number(self, value):
        if not value.isdigit(): raise serializers.ValidationError("Este campo solo puede contener números.")
        return value
    def validate(self, data): return validate_single_primary(self, data, EmergencyContact, "Contacto")
    def validate_first_name(self, value): return title_case_cleaner(validate_only_letters(value, "Nombre"))
    def validate_second_name(self, value): return title_case_cleaner(validate_only_letters(value, "Segundo Nombre")) if value else value
    def validate_paternal_surname(self, value): return title_case_cleaner(validate_only_letters(value, "Apellido Paterno"))
    def validate_maternal_surname(self, value): return title_case_cleaner(validate_only_letters(value, "Apellido Materno")) if value else value

# --- Serializers de Catálogo ---
class GenderSerializer(serializers.ModelSerializer):
    class Meta: model = Gender; fields = '__all__'
    def validate_name(self, value): 
        cleaned = title_case_cleaner(validate_text_with_spaces(value, 'Nombre'))
        validate_min_length(cleaned, 2)
        return check_uniqueness(Gender, 'name', cleaned, self.instance)
class MaritalStatusSerializer(serializers.ModelSerializer):
    class Meta: model = MaritalStatus; fields = '__all__'
    def validate_name(self, value): 
        cleaned = title_case_cleaner(validate_text_with_spaces(value, 'Nombre'))
        validate_min_length(cleaned, 2)
        return check_uniqueness(MaritalStatus, 'name', cleaned, self.instance)
class CountrySerializer(serializers.ModelSerializer):
    class Meta: model = Country; fields = '__all__'
    def validate_name(self, value): 
        cleaned = title_case_cleaner(validate_text_with_spaces(value, 'Nombre'))
        validate_min_length(cleaned, 2)
        
        # Validación explícita de unicidad
        qs = Country.objects.filter(name__iexact=cleaned)
        if self.instance:
            qs = qs.exclude(pk=self.instance.pk)
        
        if qs.exists():
            raise serializers.ValidationError("Ya existe un país con este nombre.")
            
        return cleaned
    def validate_iso_2(self, value): 
        validated = validate_letters_only_no_spaces(value, 'Código ISO')
        validate_exact_length(validated, 2)
        return check_uniqueness(Country, 'iso_2', validated.strip().upper(), self.instance)

class DisabilityGroupSerializer(serializers.ModelSerializer):
    class Meta: model = DisabilityGroup; fields = '__all__'
    def validate_name(self, value): 
        cleaned = title_case_cleaner(validate_text_with_spaces(value, 'Nombre'))
        validate_min_length(cleaned, 2)
        return check_uniqueness(DisabilityGroup, 'name', cleaned, self.instance)
class DisabilityTypeSerializer(serializers.ModelSerializer):
    class Meta: model = DisabilityType; fields = '__all__'
    def validate_name(self, value): 
        cleaned = title_case_cleaner(validate_text_with_spaces(value, 'Nombre'))
        validate_min_length(cleaned, 2)
        return check_uniqueness(DisabilityType, 'name', cleaned, self.instance)
class DisabilityStatusSerializer(serializers.ModelSerializer):
    class Meta: model = DisabilityStatus; fields = '__all__'
    def validate_name(self, value): 
        cleaned = sentence_case_cleaner(validate_text_with_spaces(value, 'Nombre'))
        validate_min_length(cleaned, 2)
        return check_uniqueness(DisabilityStatus, 'name', cleaned, self.instance)
class AddressTypeSerializer(serializers.ModelSerializer):
    class Meta: model = AddressType; fields = '__all__'
    def validate_name(self, value): 
        cleaned = title_case_cleaner(validate_text_with_spaces(value, 'Nombre'))
        validate_min_length(cleaned, 2)
        return check_uniqueness(AddressType, 'name', cleaned, self.instance)
class EmailTypeSerializer(serializers.ModelSerializer):
    class Meta: model = EmailType; fields = '__all__'
    def validate_name(self, value): 
        cleaned = title_case_cleaner(validate_text_with_spaces(value, 'Nombre'))
        validate_min_length(cleaned, 2)
        return check_uniqueness(EmailType, 'name', cleaned, self.instance)
class PhoneTypeSerializer(serializers.ModelSerializer):
    class Meta: model = PhoneType; fields = '__all__'
    def validate_name(self, value): 
        cleaned = title_case_cleaner(validate_text_with_spaces(value, 'Nombre'))
        validate_min_length(cleaned, 2)
        return check_uniqueness(PhoneType, 'name', cleaned, self.instance)
class PhoneCarrierSerializer(serializers.ModelSerializer):
    class Meta: model = PhoneCarrier; fields = '__all__'
    def validate_name(self, value): 
        cleaned = title_case_cleaner(validate_alphanumeric_with_spaces(value, 'Nombre'))
        validate_min_length(cleaned, 2)
        return check_uniqueness(PhoneCarrier, 'name', cleaned, self.instance)
class BankSerializer(serializers.ModelSerializer):
    display_name = serializers.SerializerMethodField()

    class Meta: 
        model = Bank
        fields = ['id', 'name', 'code', 'display_name']

    def get_display_name(self, obj):
        return f"{obj.code} - {obj.name}"

    def validate_name(self, value): 
        cleaned = title_case_cleaner(validate_alphanumeric_with_spaces(value, 'Nombre'))
        validate_min_length(cleaned, 2)
        return check_uniqueness(Bank, 'name', cleaned, self.instance)
    def validate_code(self, value): 
        validated = validate_numeric_only(value, 'Código')
        validate_exact_length(validated, 4)
        return check_uniqueness(Bank, 'code', validated.strip(), self.instance)
class BankAccountTypeSerializer(serializers.ModelSerializer):
    class Meta: model = BankAccountType; fields = '__all__'
    def validate_name(self, value): 
        cleaned = title_case_cleaner(validate_text_with_spaces(value, 'Nombre'))
        validate_min_length(cleaned, 2)
        return check_uniqueness(BankAccountType, 'name', cleaned, self.instance)
class RelationshipTypeSerializer(serializers.ModelSerializer):
    class Meta: model = RelationshipType; fields = '__all__'
    def validate_name(self, value): 
        cleaned = title_case_cleaner(validate_text_with_spaces(value, 'Nombre'))
        validate_min_length(cleaned, 2)
        return check_uniqueness(RelationshipType, 'name', cleaned, self.instance)
class StateSerializer(serializers.ModelSerializer):
    country_name = serializers.CharField(source='country.name', read_only=True)
    
    class Meta:
        model = State
        fields = '__all__'
        # Deshabilitar validación automática de unique_together para manejarla manualmente
        validators = []
    
    def to_representation(self, instance):
        ret = super().to_representation(instance)
        if instance.country:
            ret['country'] = {'id': instance.country.id, 'name': instance.country.name}
        return ret
    
    def validate_name(self, value):
        cleaned = title_case_cleaner(validate_text_with_spaces(value, 'Nombre'))
        validate_min_length(cleaned, 2)
        return cleaned
    
    def validate(self, data):
        # Usar helper genérico para unique_together
        return validate_unique_together(
            self, data, State, ('country', 'name'),
            error_template='Ya existe un estado con este nombre en {country}.'
        )
class PhoneCarrierCodeSerializer(serializers.ModelSerializer):
    carrier_name = serializers.CharField(source='carrier.name', read_only=True)
    
    class Meta:
        model = PhoneCarrierCode
        fields = '__all__'
        # Deshabilitar validación automática de unique_together
        validators = []
    
    def to_representation(self, instance):
        ret = super().to_representation(instance)
        if instance.carrier:
            ret['carrier'] = {'id': instance.carrier.id, 'name': instance.carrier.name}
        return ret
    
    def validate_code(self, value):
        value = value.strip()
        
        # Normalización: Si tiene 3 dígitos, agregar '0' al inicio
        if len(value) == 3 and value.isdigit():
            value = '0' + value
        
        # Validar que solo contenga números
        if not value.isdigit():
            raise serializers.ValidationError("Este campo solo puede contener números.")
        
        # Validar longitud exacta de 4 caracteres
        if len(value) != 4:
            raise serializers.ValidationError("Este campo debe tener exactamente 4 dígitos.")
        
        # Validar que comience con '0'
        if not value.startswith('0'):
            raise serializers.ValidationError("El código debe comenzar con '0'.")
        
        return value
    
    def validate(self, data):
        # Validación manual de unique_together con mensaje personalizado
        return validate_unique_together(
            self, data, PhoneCarrierCode, ('carrier', 'code'),
            error_template='Ya existe este código para la operadora {carrier}.'
        )

# --- SERIALIZERS PRINCIPALES ---

class NationalIdSerializer(serializers.ModelSerializer):
    category_display = serializers.CharField(source='get_category_display', read_only=True)
    document_type_name = serializers.CharField(source='get_category_display', read_only=True) # Alias para frontend
    prefix = serializers.CharField(source='document_type', read_only=True) # V, E, J...
    full_document = serializers.SerializerMethodField()

    class Meta: 
        model = NationalId
        fields = '__all__'
        validators = []
    
    def get_full_document(self, obj): return f"{obj.document_type}-{obj.number}"
    
    def validate_number(self, value):
        if not value.strip().isdigit(): raise serializers.ValidationError("Este campo solo puede contener números.")
        return value.strip()
        
    def validate(self, data):
        # Validar UniqueTogether manualmente para asociar errores a campos específicos
        document_type = data.get('document_type', getattr(self.instance, 'document_type', None))
        number = data.get('number', getattr(self.instance, 'number', None))
        person = data.get('person', getattr(self.instance, 'person', None))
        category = data.get('category', getattr(self.instance, 'category', None))
        
        # 1. Validar documento único (tipo + número)
        if document_type and number:
            queryset = NationalId.objects.filter(document_type=document_type, number=number)
            if self.instance: queryset = queryset.exclude(pk=self.instance.pk)
            if queryset.exists():
                raise serializers.ValidationError({'number': "Este documento ya está registrado en el sistema."})

        # 2. Validar categoría única por persona (persona + categoría)
        if person and category:
            queryset = NationalId.objects.filter(person=person, category=category)
            if self.instance: queryset = queryset.exclude(pk=self.instance.pk)
            if queryset.exists():
                raise serializers.ValidationError({'category': "Esta persona ya tiene un documento de esta categoría registrado."})

        # La cédula siempre es primaria (se establece en el modelo)
        # Solo validamos is_primary para otros documentos (RIF, Pasaporte)
        
        # Si es una cédula, no validamos is_primary porque se establece automáticamente
        if category == 'CEDULA':
            return data
            
        # Para otros documentos, validamos que no exista otro documento primario
        return validate_single_primary(self, data, NationalId, "ID Nacional")


class PersonEmailSerializer(serializers.ModelSerializer):
    email_type_name = serializers.CharField(source='email_type.name', read_only=True)

    class Meta: 
        model = PersonEmail
        fields = '__all__'
        extra_kwargs = {
            'email_address': {
                'error_messages': {
                    'unique': 'Este email ya se encuentra registrado.'
                }
            }
        }
    
    def validate_email_address(self, value):
        return value.strip().lower() 
    
    def validate(self, data):
        is_primary = data.get('is_primary', getattr(self.instance, 'is_primary', False))
        person = data.get('person')
        if is_primary:
            queryset = PersonEmail.objects.filter(person=person, is_primary=True)
            if self.instance: queryset = queryset.exclude(pk=self.instance.pk)
            if queryset.exists():
                raise serializers.ValidationError({'is_primary': "Ya existe un correo principal."}) 
        return data


class PersonPhoneSerializer(serializers.ModelSerializer):
    phone_type_name = serializers.CharField(source='phone_type.name', read_only=True)
    carrier_code_val = serializers.CharField(source='carrier_code.code', read_only=True) # Ej: 0414
    full_number = serializers.SerializerMethodField()

    class Meta: 
        model = PersonPhone; 
        fields = '__all__'
        validators = [
            UniqueTogetherValidator(
                queryset=PersonPhone.objects.all(),
                fields=['carrier_code', 'subscriber_number'],
                message="Este número de teléfono ya se encuentra registrado."
            )
        ]
    
    def get_full_number(self, obj):
        # Formato solicitado: 0424-8167536
        if obj.carrier_code:
            return f"{obj.carrier_code.code}-{obj.subscriber_number}"
        return obj.subscriber_number

    def validate_subscriber_number(self, value):
        value = value.strip()
        if not value.isdigit():
            raise serializers.ValidationError("Este campo solo puede contener números.")
        if len(value) != 7:
            raise serializers.ValidationError("Este campo debe tener exactamente 7 dígitos.")
        return value

    def validate(self, data):
        is_primary = data.get('is_primary', getattr(self.instance, 'is_primary', False))
        person = data.get('person')
        if is_primary:
            queryset = PersonPhone.objects.filter(person=person, is_primary=True)
            if self.instance: queryset = queryset.exclude(pk=self.instance.pk)
            if queryset.exists():
                raise serializers.ValidationError({'is_primary': "Ya existe un teléfono principal."})
        return data
    
class PersonBankAccountSerializer(serializers.ModelSerializer):
    bank_name = serializers.CharField(source='bank.name', read_only=True)
    bank_code = serializers.CharField(source='bank.code', read_only=True)
    bank_account_type_name = serializers.CharField(source='bank_account_type.name', read_only=True)

    class Meta: model = PersonBankAccount; fields = '__all__'
    def validate_account_number(self, value):
        if not value.isdigit() or len(value) != 20: raise serializers.ValidationError("Este campo debe tener 20 dígitos.")
        return value
    def validate(self, data): 
        # 1. Validar unicidad de cuenta principal
        data = validate_single_primary(self, data, PersonBankAccount, "Cuenta Bancaria")
        
        # 2. Validar que el número de cuenta corresponda al banco seleccionado
        bank = data.get('bank')
        account_number = data.get('account_number')
        
        # Si estamos actualizando y no se enviaron estos campos, obtenerlos de la instancia
        if not bank and self.instance:
            bank = self.instance.bank
        if not account_number and self.instance:
            account_number = self.instance.account_number
            
        if bank and account_number:
            if not account_number.startswith(bank.code):
                raise serializers.ValidationError({
                    "account_number": f"El número de cuenta debe comenzar con el código del banco ({bank.code})."
                })
                
        return data



class DependentSerializer(serializers.ModelSerializer):
    relationship_name = serializers.SerializerMethodField()
    gender_name = serializers.CharField(source='gender.name', read_only=True)
    
    class Meta: 
        model = Dependent
        fields = '__all__'
    
    validators = [UniqueTogetherValidator(queryset=Dependent.objects.all(), fields=['person', 'first_name', 'paternal_surname'])]
    
    def get_relationship_name(self, obj):
        return obj.relationship.name if obj.relationship else None
    
    def validate_birthdate(self, value):
        if value > date.today(): raise serializers.ValidationError("No se permiten fechas futuras.")
        return value
    def validate_first_name(self, value): return title_case_cleaner(validate_only_letters(value, "Nombre"))
    def validate_second_name(self, value): return title_case_cleaner(validate_only_letters(value, "Segundo Nombre")) if value else value
    def validate_paternal_surname(self, value): return title_case_cleaner(validate_only_letters(value, "Apellido Paterno"))
    def validate_maternal_surname(self, value): return title_case_cleaner(validate_only_letters(value, "Apellido Materno")) if value else value


class PersonListSerializer(serializers.ModelSerializer):
    full_name = serializers.SerializerMethodField()
    primary_document = serializers.SerializerMethodField()
    primary_email = serializers.SerializerMethodField()
    primary_phone = serializers.SerializerMethodField()
    hiring_search = serializers.SerializerMethodField()

    class Meta:
        model = Person
        fields = ['id', 'photo', 'full_name', 'primary_document', 'primary_email', 'primary_phone', 'hiring_search']
    
    def get_full_name(self, obj): return f"{obj.first_name} {obj.paternal_surname}".strip()
    
    def get_primary_document(self, obj):
        doc = obj.national_ids.filter(is_primary=True).first()
        return f"{doc.document_type}-{doc.number}" if doc else "-"
    
    def get_primary_email(self, obj):
        e = obj.emails.filter(is_primary=True).first()
        return e.email_address if e else "-"
    
    def get_primary_phone(self, obj):
        p = obj.phones.filter(is_primary=True).first()
        if not p:
            return "-"
        if p.carrier_code:
            return f"{p.carrier_code.code}-{p.subscriber_number}"
        return p.subscriber_number
        
    def get_hiring_search(self, obj):
        doc = obj.national_ids.filter(is_primary=True).first()
        doc_str = f"{doc.document_type}-{doc.number}" if doc else "Sin Cédula"
        return doc_str

class PersonSerializer(serializers.ModelSerializer):
    full_name = serializers.SerializerMethodField()
    primary_document = serializers.SerializerMethodField()
    primary_email = serializers.SerializerMethodField()
    primary_phone = serializers.SerializerMethodField()
    photo = serializers.FileField(required=False, allow_null=True)
    gender_name = serializers.CharField(source='gender.name', read_only=True)
    country_of_birth_name = serializers.CharField(source='country_of_birth.name', read_only=True)
    hiring_search = serializers.SerializerMethodField()
    
    # Campos para crear cédula durante la creación de persona
    cedula_prefix = serializers.CharField(write_only=True, required=False, allow_blank=True)
    cedula_number = serializers.CharField(write_only=True, required=False, allow_blank=True)
    
    addresses = AddressSerializer(many=True, read_only=True)
    phones = PersonPhoneSerializer(many=True, read_only=True)
    emails = PersonEmailSerializer(many=True, read_only=True)
    national_ids = NationalIdSerializer(many=True, read_only=True)
    emergency_contacts = EmergencyContactSerializer(many=True, read_only=True)
    bank_accounts = PersonBankAccountSerializer(many=True, read_only=True)
    dependents = DependentSerializer(many=True, read_only=True)

    class Meta: model = Person; fields = '__all__'
    
    def to_internal_value(self, data):
        if hasattr(data, 'copy'): data = data.copy()
        if 'photo' in data and data['photo'] == 'DELETE': data['photo'] = None
        return super().to_internal_value(data)

    def validate_cedula_number(self, value):
        """Sanitize and validate cedula number"""
        if not value:
            return value
            
        # Eliminar puntos y comas (separadores de miles)
        sanitized = value.replace('.', '').replace(',', '')
        
        # Verificar que solo contenga dígitos
        if not sanitized.isdigit():
            raise serializers.ValidationError("El número de cédula solo puede contener dígitos.")
        
        # Remover ceros a la izquierda
        sanitized = sanitized.lstrip('0') or '0'
        
        # Verificar longitud (1-8 dígitos)
        if len(sanitized) > 8:
            raise serializers.ValidationError("El número de cédula no puede tener más de 8 dígitos.")
        
        return sanitized

    def validate_cedula_prefix(self, value):
        """Validate that cedula prefix is only V or E"""
        if value and value not in ['V', 'E']:
            raise serializers.ValidationError("El prefijo de cédula debe ser V (Venezolano) o E (Extranjero).")
        return value

    def validate(self, data):
        # Validar prefijo de cédula
        if 'cedula_prefix' in data and data['cedula_prefix']:
            data['cedula_prefix'] = self.validate_cedula_prefix(data['cedula_prefix'])
        
        # Sanitizar cédula si está presente
        if 'cedula_number' in data and data['cedula_number']:
            data['cedula_number'] = self.validate_cedula_number(data['cedula_number'])
        
        # Validar unicidad de cédula si se proporciona
        cedula_prefix = data.get('cedula_prefix')
        cedula_number = data.get('cedula_number')
        
        if cedula_prefix and cedula_number:
            # Verificar si ya existe un NationalId con ese prefijo y número
            qs = NationalId.objects.filter(document_type=cedula_prefix, number=cedula_number)
            
            # Si estamos editando, excluir los documentos de la persona actual
            if self.instance:
                qs = qs.exclude(person=self.instance)
                
            if qs.exists():
                raise serializers.ValidationError({
                    "cedula_number": f"Ya existe una persona con la cédula {cedula_prefix}-{cedula_number}."
                })
        
        return data

    def validate_birthdate(self, value):
        if value and value > date.today(): raise serializers.ValidationError("No se permiten fechas futuras.")
        return value
    def validate_first_name(self, value): return title_case_cleaner(validate_only_letters(value, "Primer Nombre"))
    def validate_second_name(self, value): return title_case_cleaner(validate_only_letters(value, "Segundo Nombre")) if value else value
    def validate_paternal_surname(self, value): return title_case_cleaner(validate_only_letters(value, "Apellido Paterno"))
    def validate_maternal_surname(self, value): return title_case_cleaner(validate_only_letters(value, "Apellido Materno")) if value else value

    def get_full_name(self, obj):
        """Devuelve el nombre completo usando el __str__ del modelo"""
        return str(obj)

    def get_primary_document(self, obj):
        """Busca el documento marcado como principal"""
        # Usamos el related_name='national_ids' definido en el modelo
        doc = obj.national_ids.filter(is_primary=True).first()
        return f"{doc.document_type}-{doc.number}" if doc else None

    def get_primary_email(self, obj):
        """Busca el correo marcado como principal"""
        # Usamos el related_name='emails'
        email = obj.emails.filter(is_primary=True).first()
        return email.email_address if email else None

    def get_primary_phone(self, obj):
        """Busca el teléfono marcado como principal"""
        # Usamos el related_name='phones'
        phone = obj.phones.filter(is_primary=True).first()
        if not phone:
            return None
        # El __str__ del modelo PersonPhone también accede a carrier_code.code, así que manejamos el caso
        if phone.carrier_code:
            return str(phone)
        return phone.subscriber_number

    def get_hiring_search(self, obj):
        doc = obj.national_ids.filter(is_primary=True).first()
        doc_str = f"{doc.document_type}-{doc.number}" if doc else "Sin Cédula"
        return doc_str

    def create(self, validated_data):
        """Override create to handle cedula creation"""
        # Extract cedula data
        cedula_prefix = validated_data.pop('cedula_prefix', None)
        cedula_number = validated_data.pop('cedula_number', None)
        
        # Create person
        person = Person.objects.create(**validated_data)
        
        # Create NationalId if cedula data provided
        if cedula_prefix and cedula_number:
            from .models import NationalId
            NationalId.objects.create(
                person=person,
                category='CEDULA',
                document_type=cedula_prefix,
                number=cedula_number,
                is_primary=True
            )
        
        return person

    def update(self, instance, validated_data):
        """Override update to handle cedula updates"""
        # Extract cedula data
        cedula_prefix = validated_data.pop('cedula_prefix', None)
        cedula_number = validated_data.pop('cedula_number', None)
        
        # Update person fields
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()
        
        # Update NationalId if cedula data provided
        if cedula_prefix and cedula_number:
            from .models import NationalId
            # Buscar si ya tiene una cédula (categoría CEDULA)
            cedula = NationalId.objects.filter(person=instance, category='CEDULA').first()
            
            if cedula:
                # Actualizar existente
                cedula.document_type = cedula_prefix
                cedula.number = cedula_number
                cedula.save()
            else:
                # Crear nueva si no tenía
                NationalId.objects.create(
                    person=instance,
                    category='CEDULA',
                    document_type=cedula_prefix,
                    number=cedula_number,
                    is_primary=True
                )
        
        return instance

class PersonDisabilityVESerializer(serializers.ModelSerializer):
    class Meta: model = PersonDisabilityVE; fields = '__all__'
    def validate(self, data):
        if data.get('date_learned') and data.get('date_of_determination') and data['date_learned'] > data['date_of_determination']:
            raise serializers.ValidationError({"date_learned": "Las fechas son inconsistentes."})
        return data




class PersonDocumentSerializer(serializers.ModelSerializer):
    class Meta: model = PersonDocument; fields = '__all__'

class PersonNationalitySerializer(serializers.ModelSerializer):
    class Meta: model = PersonNationality; fields = '__all__'
</file>

</files>
